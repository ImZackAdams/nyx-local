<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NyxPay ‚Äì Static Checkout Generator</title>
  <style>
    body { font-family: sans-serif; background: #0a0a0a; color: #f5f5f5; padding: 2rem; text-align: center; }
    .container { max-width: 520px; margin: 0 auto; background: #161616; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
    .btn { background: #FEB02E; color: #000; padding: 10px 16px; font-weight: 700; border-radius: 8px; display: inline-block; margin-top: 1rem; text-decoration: none; }
    .hidden { display: none; }
    label { display: block; margin-top: 1rem; text-align: left; }
    input { width: 100%; padding: 0.6rem; margin-top: 0.5rem; border-radius: 6px; border: none; }
    button { margin-top: 1.5rem; padding: 0.8rem 1.4rem; background: #FEB02E; color: #000; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; }
    small { opacity: .8; }
  </style>
</head>
<body>
  <div class="container">
    <h1>NyxPay Link Builder</h1>
    <p>Generate a simple checkout file you can send to anyone.</p>

    <form id="builderForm">
      <label for="label">Item Name or Memo</label>
      <input type="text" id="label" placeholder="Consulting Services" required />

      <label for="amount">Amount in SOL</label>
      <input type="number" id="amount" placeholder="0.25" required min="0.000000001" step="0.000000001"/>

      <label for="recipient">Recipient Wallet Address</label>
      <input type="text" id="recipient" placeholder="Your Solana wallet address" required />

      <button type="submit">Generate Checkout File</button>
    </form>

    <div id="output" class="hidden">
      <h2>‚úÖ Download Your File</h2>
      <a id="downloadLink" class="btn" download>Download Checkout</a><br />
      <small>We also auto-started the download.</small>
    </div>
  </div>

  <!-- =========================
       Inline library buckets
       ========================= -->

  <!-- 1) BN (UMD) ‚Äî must define window.BN -->
  <script id="bn-umd" type="text/plain">
/*! Paste the FULL contents of bn.js UMD/min build here so it defines window.BN */
</script>

  <!-- 2) Solana Web3 (IIFE) ‚Äî must define window.solanaWeb3 -->
  <script id="solana-web3-iife" type="text/plain">
/*! Paste the FULL contents of @solana/web3.js IIFE build here so it defines window.solanaWeb3 */
</script>

  <!-- 3) NyxPay SDK (UMD) ‚Äî your built bundle -->
  <script id="nyxpay-sdk-umd" type="text/plain">
/*! Paste the FULL contents of sdk/dist/nyxpay-pay-sdk.umd.js here */
</script>

  <script>
    (function() {
      var form = document.getElementById('builderForm');
      var outputSection = document.getElementById('output');
      var downloadLink = document.getElementById('downloadLink');

      // ---------- helpers ----------
      function escapeHtml(s) {
        return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      }
      function slugify(s) {
        return String(s).trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
      }
      function escapeForScriptTag(s) {
        // prevent prematurely closing the inlined <script>
        return String(s).replace(/<\/script>/gi, '<\\/script>');
      }
      function getInlineLib(id) {
        var el = document.getElementById(id);
        if (!el) throw new Error('Missing inline library tag: #' + id);
        return escapeForScriptTag(el.textContent || "");
      }
      function looksLikeSolanaAddress(s) {
        return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(s);
      }

      // ---------- generator ----------
      function buildCheckout(recipient, amount, label) {
        var safeLabel = escapeHtml(label);
        var safeRecipient = escapeHtml(recipient);
        var amtStr = String(amount);

        // Pull inlined libs from the builder page (BN -> web3 -> SDK)
        var bnText   = getInlineLib('bn-umd');
        var web3Text = getInlineLib('solana-web3-iife');
        var sdkText  = getInlineLib('nyxpay-sdk-umd');

        var html = "";
        html += "<!DOCTYPE html>\n";
        html += "<html lang=\"en\">\n<head>\n";
        html += "  <meta charset=\"UTF-8\" />\n";
        html += "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n";
        html += "  <title>NyxPay Checkout ‚Äì " + safeLabel + "</title>\n";
        html += "  <style>\n";
        html += "    body { font-family: sans-serif; background: #0a0a0a; color: #f5f5f5; padding: 2rem; text-align: center; }\n";
        html += "    .container { max-width: 520px; margin: 0 auto; background: #161616; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }\n";
        html += "    .btn { background: #FEB02E; color: #000; padding: 10px 16px; font-weight: 700; border-radius: 8px; display: inline-block; margin-top: 1rem; border: 0; cursor: pointer; text-decoration: none; }\n";
        html += "    .status { margin-top: 1rem; font-size: 0.95rem; opacity: 0.9; }\n";
        html += "    code { font-size: 0.9rem; word-break: break-all; }\n";
        html += "  </style>\n";
        html += "</head>\n<body>\n";
        html += "  <div class=\"container\">\n";
        html += "    <h1>üåë NyxPay Checkout</h1>\n";
        html += "    <p><strong>" + safeLabel + "</strong></p>\n";
        html += "    <p>Amount: <strong>" + amtStr + " SOL</strong></p>\n";
        html += "    <p>To: <code>" + safeRecipient + "</code></p>\n";
        html += "    <button id=\"connectWallet\" class=\"btn\">Connect Wallet</button>\n";
        html += "    <button id=\"payButton\" class=\"btn\" disabled>Pay Now</button>\n";
        html += "    <div class=\"status\" id=\"statusMessage\">Loading...</div>\n";
        html += "  </div>\n\n";

        // Inline libs (dependency order matters)
        html += "  <script>\n" + bnText   + "\n</" + "script>\n";
        html += "  <script>\n" + web3Text + "\n</" + "script>\n";
        html += "  <script>\n" + sdkText  + "\n</" + "script>\n";

        // App bootstrap (safe DOM, double-click guard)
        html += "  <script>\n";
        html += "    (function(){\n";
        html += "      var RECIPIENT = " + JSON.stringify(recipient) + ";\n";
        html += "      var AMOUNT = " + amtStr + ";\n";
        html += "      var TOKEN = \"SOL\";\n";
        html += "      var LABEL = " + JSON.stringify(label) + ";\n";
        html += "      var payBtn = document.getElementById('payButton');\n";
        html += "      var connectBtn = document.getElementById('connectWallet');\n";
        html += "      var status = document.getElementById('statusMessage');\n";
        html += "      if (!window.BN) { status.textContent = 'BN missing'; throw new Error('BN global not found'); }\n";
        html += "      if (!window.solanaWeb3) { status.textContent = 'solanaWeb3 missing'; throw new Error('solanaWeb3 global not found'); }\n";
        html += "      var SDK = window.nyxpayPaySDK || window.NyxPaySDK || window.nyxpay || window.NyxPay || null;\n";
        html += "      if (!SDK) { status.textContent = 'SDK missing'; throw new Error('NyxPay SDK global not found'); }\n";
        html += "      var PaymentProcessor = SDK.PaymentProcessor;\n";
        html += "      var PhantomAdapter = SDK.PhantomAdapter;\n";
        html += "      var sdk = new PaymentProcessor({ network: 'mainnet-beta', commitment: 'confirmed' });\n";
        html += "      sdk.setWalletAdapter(new PhantomAdapter());\n";
        html += "      (async function(){ try { await sdk.init(); status.textContent = 'Ready. Connect your wallet.'; } catch(e) { status.textContent = 'Init failed: ' + (e && e.message ? e.message : e); } })();\n";
        html += "      connectBtn.addEventListener('click', async function(){\n";
        html += "        try { await sdk.connectWallet(); payBtn.disabled = false; status.textContent = 'Wallet connected. Ready to pay.'; }\n";
        html += "        catch(err) { status.textContent = 'Failed to connect wallet: ' + (err && err.message ? err.message : err); }\n";
        html += "      });\n";
        html += "      payBtn.addEventListener('click', async function(){\n";
        html += "        if (payBtn.disabled) return;\n";
        html += "        payBtn.disabled = true;\n";
        html += "        status.textContent = 'Sending payment...';\n";
        html += "        try {\n";
        html += "          var opts = { recipient: RECIPIENT, amount: AMOUNT, tokenMint: TOKEN, memo: LABEL };\n";
        html += "          var result = await sdk.sendTokens(opts);\n";
        html += "          var url = (result && result.explorerUrl) ? result.explorerUrl : '#';\n";
        html += "          status.textContent = '‚úÖ Payment sent!';\n";
        html += "          var br = document.createElement('br');\n";
        html += "          var a  = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.textContent = 'View on Explorer';\n";
        html += "          status.appendChild(br); status.appendChild(a);\n";
        html += "        } catch (err) {\n";
        html += "          status.textContent = '‚ùå Payment failed: ' + (err && err.message ? err.message : err);\n";
        html += "          payBtn.disabled = false;\n";
        html += "        }\n";
        html += "      });\n";
        html += "    })();\n";
        html += "  </" + "script>\n";
        html += "</body>\n</html>\n";
        return html;
      }

      // ---------- submit ----------
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var label = document.getElementById('label').value.trim();
        var recipient = document.getElementById('recipient').value.trim();
        var amount = Number(document.getElementById('amount').value);

        if (!label || !recipient || isNaN(amount) || amount <= 0) {
          alert('Please enter a valid label, recipient, and amount.');
          return;
        }
        if (!looksLikeSolanaAddress(recipient)) {
          alert('That does not look like a valid Solana address.');
          return;
        }
        // clamp to 9dp to avoid float artifacts (SOL has 9 decimals)
        amount = Math.round(amount * 1e9) / 1e9;

        var html = buildCheckout(recipient, amount, label);
        var blob = new Blob([html], { type: 'text/html' });
        var url = URL.createObjectURL(blob);
        var filename = "nyxpay-checkout-" + slugify(label) + ".html";

        downloadLink.href = url;
        downloadLink.download = filename;
        downloadLink.textContent = "Download " + filename;
        outputSection.classList.remove('hidden');

        // Auto-start download and clean up
        downloadLink.click();
        setTimeout(function(){ URL.revokeObjectURL(url); }, 0);
      });
    })();
  </script>
</body>
</html>
