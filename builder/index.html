<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NyxPay Invoice</title>
<style>
  :root{--bg:#0a0a0a;--panel:#161616;--text:#f5f5f5;--muted:#bdbdbd;--accent:#FEB02E}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,sans-serif;padding:24px}
  .sheet{max-width:760px;margin:0 auto;background:var(--panel);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.45);overflow:hidden}
  header,footer{padding:20px 24px} header{display:flex;gap:16px;align-items:center;border-bottom:1px solid #222}
  .logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#FFD86F,#FEB02E)}
  h1{margin:0;font-size:18px}.muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:20px 24px;border-bottom:1px solid #222}
  .card{background:#111;border:1px solid #222;border-radius:10px;padding:14px}
  .label{font-size:12px;letter-spacing:.04em;color:var(--muted);text-transform:uppercase;margin-bottom:6px}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #222;text-align:left}
  tfoot td{border-top:2px solid #333;font-weight:700}.total{font-size:18px}
  .btn{display:inline-block;background:var(--accent);color:#000;padding:12px 16px;border-radius:9px;font-weight:800;text-decoration:none;margin-top:10px;cursor:pointer;border:0}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  code{background:#111;border:1px solid #222;padding:6px 8px;border-radius:8px;word-break:break-all}
  .actions{padding:20px 24px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .note{padding:0 24px 20px;color:var(--muted);font-size:14px}
  .warn{background:#2a1f00;border:1px solid #4d3a00;color:#ffd571;padding:10px 12px;border-radius:8px;margin:16px 24px}
</style>
</head>
<body>
<div class="sheet">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1 id="title">Invoice</h1>
      <div class="muted" id="subtitle"></div>
    </div>
  </header>

  <div id="runtimeWarn" class="warn" style="display:none"></div>

  <div class="grid">
    <div class="card"><div class="label">From</div><div id="from"></div></div>
    <div class="card"><div class="label">Bill To</div><div id="to"></div></div>
    <div class="card"><div class="label">Invoice Details</div><div id="meta"></div></div>
    <div class="card"><div class="label">Pay To (SOL)</div><div><div class="muted" style="font-size:12px">Recipient</div><code id="recipient"></code></div></div>
  </div>

  <div style="padding:12px 24px 0">
    <table id="items">
      <thead><tr><th>Description</th><th style="width:120px">Qty</th><th style="width:160px">Unit (SOL)</th><th style="width:160px">Line (SOL)</th></tr></thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="3" style="text-align:right">Subtotal</td><td id="subtotal">0</td></tr>
        <tr><td colspan="3" style="text-align:right">Fees/Adj.</td><td id="fees">0</td></tr>
        <tr><td colspan="3" class="total" style="text-align:right">Total (SOL)</td><td class="total" id="total">0</td></tr>
      </tfoot>
    </table>
  </div>

  <div class="actions">
    <button id="connectBtn" class="btn" type="button">Connect Wallet</button>
    <button id="payBtn"     class="btn" type="button" disabled>Pay Now</button>
    <a id="explorerLink" class="btn" href="#" target="_blank" rel="noopener" style="display:none">View on Explorer</a>
  </div>

  <div class="note" id="status">Waiting…</div>
  <footer class="muted" id="footer"></footer>
</div>

<!-- Load local libs (offline) -->
<script src="./solana-web3.iife.js"></script>
<script src="./nyxpay-pay-sdk.umd.js"></script>

<script>
/*** CONFIG — EDIT ME ***/
const MERCHANT = { name: "Nyx Consulting LLC", email: "billing@nyx.co", website: "https://nyx.co" };
const CUSTOMER = { name: "User B", email: "userb@example.com" };
const RECIPIENT = { wallet: "YourRecipientPublicKeyHere" }; // <- set this
const INVOICE  = {
  number: "INV-2025-0012",
  dateISO: "2025-08-13",
  dueISO: "2025-08-20",
  feeOrAdjustmentSOL: 0.00,
  memo: "Consulting Services – July",
  network: "mainnet-beta" // or "devnet"
};
const ITEMS = [
  { desc: "Consulting - Strategy Session", qty: 2, unitSOL: 0.35 },
  { desc: "Follow-up Report",              qty: 1, unitSOL: 0.10 }
];
/*** END CONFIG ***/

const esc = s => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const fmt = n => (Math.round(Number(n) * 1e9) / 1e9).toFixed(9).replace(/0+$/,'').replace(/\.$/,'');
const isAddr = s => /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(s);

// Render static bits
document.getElementById("title").textContent = `Invoice ${INVOICE.number}`;
document.getElementById("subtitle").textContent = `${MERCHANT.name} • ${INVOICE.dateISO} • Due ${INVOICE.dueISO}`;
document.getElementById("from").innerHTML = `<div>${esc(MERCHANT.name)}</div><div class="muted">${esc(MERCHANT.email)}</div><div class="muted">${esc(MERCHANT.website)}</div>`;
document.getElementById("to").innerHTML   = `<div>${esc(CUSTOMER.name)}</div><div class="muted">${esc(CUSTOMER.email)}</div>`;
document.getElementById("meta").innerHTML = `<div><strong>Number:</strong> ${esc(INVOICE.number)}</div><div><strong>Date:</strong> ${esc(INVOICE.dateISO)}</div><div><strong>Due:</strong> ${esc(INVOICE.dueISO)}</div>`;
document.getElementById("recipient").textContent = RECIPIENT.wallet;
document.getElementById("footer").textContent = `© ${new Date().getFullYear()} ${MERCHANT.name}`;

// Compute totals
const subtotal = ITEMS.reduce((s, it) => s + (Number(it.qty)||0)*(Number(it.unitSOL)||0), 0);
const total = Math.max(0, Math.round((subtotal + Number(INVOICE.feeOrAdjustmentSOL||0)) * 1e9) / 1e9);

// Render table
const tbody = document.querySelector("#items tbody");
ITEMS.forEach(it=>{
  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${esc(it.desc)}</td><td>${esc(it.qty)}</td><td>${fmt(it.unitSOL)}</td><td>${fmt((+it.qty||0)*(+it.unitSOL||0))}</td>`;
  tbody.appendChild(tr);
});
document.getElementById("subtotal").textContent = fmt(subtotal);
document.getElementById("fees").textContent     = fmt(INVOICE.feeOrAdjustmentSOL || 0);
document.getElementById("total").textContent    = fmt(total);

// Runtime environment hints
const warn = document.getElementById('runtimeWarn');
if (location.protocol === 'file:') {
  warn.style.display = '';
  warn.textContent = 'Tip: Wallet extensions may be blocked on file:// pages. Either serve this file at http://localhost/... OR enable "Allow access to file URLs" for your wallet extension in chrome://extensions.';
}

// SDK init
const status = document.getElementById('status');
const explorerLink = document.getElementById('explorerLink');
const connectBtn = document.getElementById('connectBtn');
const payBtn = document.getElementById('payBtn');

(function boot(){
  if (!window.solanaWeb3) { status.textContent = 'solanaWeb3 missing (check solana-web3.iife.js)'; return; }
  const SDK = window.nyxpayPaySDK || window.NyxPaySDK || window.nyxpay || window.NyxPay || null;
  if (!SDK) { status.textContent = 'NyxPay SDK not found (check nyxpay-pay-sdk.umd.js)'; return; }

  const { PaymentProcessor, PhantomAdapter } = SDK;
  const sdk = new PaymentProcessor({ network: INVOICE.network, commitment: 'confirmed' });
  sdk.setWalletAdapter(new PhantomAdapter());

  connectBtn.onclick = async () => {
    try {
      status.textContent = 'Connecting wallet…';
      await sdk.init();
      await sdk.connectWallet();
      payBtn.disabled = false;
      status.textContent = 'Wallet connected. Ready to pay.';
    } catch (e) {
      status.textContent = 'Failed to connect wallet: ' + (e && e.message ? e.message : e);
    }
  };

  payBtn.onclick = async () => {
    if (payBtn.disabled) return;
    if (!isAddr(RECIPIENT.wallet)) { alert('Recipient address looks invalid.'); return; }
    payBtn.disabled = true;
    status.textContent = 'Sending payment…';
    try {
      const result = await sdk.sendTokens({
        recipient: RECIPIENT.wallet,
        amount: total,
        tokenMint: 'SOL',
        memo: INVOICE.memo || INVOICE.number
      });
      const url = (result && result.explorerUrl) ? result.explorerUrl : '#';
      status.textContent = '✅ Payment sent!';
      explorerLink.href = url;
      explorerLink.style.display = 'inline-block';
    } catch (e) {
      status.textContent = '❌ Payment failed: ' + (e && e.message ? e.message : e);
      payBtn.disabled = false;
    }
  };
})();
</script>
</body>
</html>
