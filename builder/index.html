<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NyxPay ‚Äì Static Checkout Generator</title>
  <style>
    body { font-family: sans-serif; background: #0a0a0a; color: #f5f5f5; padding: 2rem; text-align: center; }
    .container { max-width: 520px; margin: 0 auto; background: #161616; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
    .btn { background: #FEB02E; color: #000; padding: 10px 16px; font-weight: 700; border-radius: 8px; display: inline-block; margin-top: 1rem; text-decoration: none; }
    .hidden { display: none; }
    label { display: block; margin-top: 1rem; text-align: left; }
    input { width: 100%; padding: 0.6rem; margin-top: 0.5rem; border-radius: 6px; border: none; }
    button { margin-top: 1.5rem; padding: 0.8rem 1.4rem; background: #FEB02E; color: #000; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; }
    small { opacity: .8; }
  </style>
</head>
<body>
  <div class="container">
    <h1>NyxPay Link Builder</h1>
    <p>Generate a simple checkout file you can send to anyone.</p>

    <form id="builderForm">
      <label for="label">Item Name or Memo</label>
      <input type="text" id="label" placeholder="Consulting Services" required />

      <label for="amount">Amount in SOL</label>
      <input type="number" id="amount" placeholder="0.25" required min="0.000001" step="0.000001"/>

      <label for="recipient">Recipient Wallet Address</label>
      <input type="text" id="recipient" placeholder="Your Solana wallet address" required />

      <button type="submit">Generate Checkout File</button>
    </form>

    <div id="output" class="hidden">
      <h2>‚úÖ Download Your File</h2>
      <a id="downloadLink" class="btn" download>Download Checkout</a><br />
      <small>We also auto-started the download.</small>
    </div>
  </div>

  <script>
    (function() {
      var form = document.getElementById('builderForm');
      var outputSection = document.getElementById('output');
      var downloadLink = document.getElementById('downloadLink');

      // Pin exact versions. Update SDK_VERSION to your published tag.
      var WEB3_URL = "https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.js";
      var SDK_URL  = "https://unpkg.com/nyxpay-pay-sdk@0.1.0/dist/nyxpay-pay-sdk.umd.js";

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function slugify(s) {
        return String(s).trim().toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9\-]/g, "");
      }

      // Build the checkout HTML using simple concatenation to avoid nested backticks issues
      function buildCheckout(recipient, amount, label) {
        var safeLabel = escapeHtml(label);
        var safeRecipient = escapeHtml(recipient);
        var amtStr = String(amount);

        var html = "";
        html += "<!DOCTYPE html>\n";
        html += "<html lang=\"en\">\n<head>\n";
        html += "  <meta charset=\"UTF-8\" />\n";
        html += "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n";
        html += "  <title>NyxPay Checkout ‚Äì " + safeLabel + "</title>\n";
        html += "  <style>\n";
        html += "    body { font-family: sans-serif; background: #0a0a0a; color: #f5f5f5; padding: 2rem; text-align: center; }\n";
        html += "    .container { max-width: 520px; margin: 0 auto; background: #161616; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }\n";
        html += "    .btn { background: #FEB02E; color: #000; padding: 10px 16px; font-weight: 700; border-radius: 8px; display: inline-block; margin-top: 1rem; border: 0; cursor: pointer; text-decoration: none; }\n";
        html += "    .status { margin-top: 1rem; font-size: 0.95rem; opacity: 0.9; }\n";
        html += "    code { font-size: 0.9rem; }\n";
        html += "  </style>\n";
        html += "</head>\n<body>\n";
        html += "  <div class=\"container\">\n";
        html += "    <h1>üåë NyxPay Checkout</h1>\n";
        html += "    <p><strong>" + safeLabel + "</strong></p>\n";
        html += "    <p>Amount: <strong>" + amtStr + " SOL</strong></p>\n";
        html += "    <p>To: <code>" + safeRecipient + "</code></p>\n";
        html += "    <button id=\"connectWallet\" class=\"btn\">Connect Wallet</button>\n";
        html += "    <button id=\"payButton\" class=\"btn\" disabled>Pay Now</button>\n";
        html += "    <div class=\"status\" id=\"statusMessage\">Waiting...</div>\n";
        html += "  </div>\n\n";
        html += "  <script src=\"" + WEB3_URL + "\"><" + "/script>\n";
        html += "  <script src=\"" + SDK_URL  + "\"><" + "/script>\n";
        html += "  <script>\n";
        html += "    (function(){\n";
        html += "      var RECIPIENT = " + JSON.stringify(recipient) + ";\n";
        html += "      var AMOUNT = " + amtStr + ";\n";
        html += "      var TOKEN = \"SOL\";\n";
        html += "      var LABEL = " + JSON.stringify(label) + ";\n";
        html += "      var payBtn = document.getElementById('payButton');\n";
        html += "      var connectBtn = document.getElementById('connectWallet');\n";
        html += "      var status = document.getElementById('statusMessage');\n";
        html += "      var SDK = window.nyxpayPaySDK || window.NyxPaySDK || window.nyxpay || null;\n";
        html += "      if (!SDK) { status.textContent = 'SDK failed to load. Check your internet connection.'; throw new Error('NyxPay SDK global not found'); }\n";
        html += "      var PaymentProcessor = SDK.PaymentProcessor;\n";
        html += "      var PhantomAdapter = SDK.PhantomAdapter;\n";
        html += "      var sdk = new PaymentProcessor({ network: 'mainnet-beta', commitment: 'confirmed' });\n";
        html += "      sdk.setWalletAdapter(new PhantomAdapter());\n";
        html += "      (async function(){ try { await sdk.init(); } catch(e) { status.textContent = 'Init failed: ' + (e && e.message ? e.message : e); } })();\n";
        html += "      connectBtn.addEventListener('click', async function(){\n";
        html += "        try { await sdk.connectWallet(); payBtn.disabled = false; status.textContent = 'Wallet connected. Ready to pay.'; }\n";
        html += "        catch(err) { status.textContent = 'Failed to connect wallet: ' + (err && err.message ? err.message : err); }\n";
        html += "      });\n";
        html += "      payBtn.addEventListener('click', async function(){\n";
        html += "        status.textContent = 'Sending payment...';\n";
        html += "        try {\n";
        html += "          var opts = { recipient: RECIPIENT, amount: AMOUNT, tokenMint: TOKEN, memo: LABEL };\n";
        html += "          var result = await sdk.sendTokens(opts);\n";
        html += "          var url = (result && result.explorerUrl) ? result.explorerUrl : '#';\n";
        html += "          status.innerHTML = '‚úÖ Payment sent!<br><a href=\"' + url + '\" target=\"_blank\" rel=\"noopener\">View on Explorer</a>';\n";
        html += "          payBtn.disabled = true;\n";
        html += "        } catch (err) {\n";
        html += "          status.textContent = '‚ùå Payment failed: ' + (err && err.message ? err.message : err);\n";
        html += "        }\n";
        html += "      });\n";
        html += "    })();\n";
        html += "  <" + "/script>\n";
        html += "</body>\n</html>\n";
        return html;
      }

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var label = document.getElementById('label').value.trim();
        var amount = parseFloat(document.getElementById('amount').value.trim());
        var recipient = document.getElementById('recipient').value.trim();

        if (!label || !recipient || isNaN(amount) || amount <= 0) {
          alert('Please enter a valid label, recipient, and amount.');
          return;
        }

        var html = buildCheckout(recipient, amount, label);
        var blob = new Blob([html], { type: 'text/html' });
        var url = URL.createObjectURL(blob);
        var filename = "nyxpay-checkout-" + slugify(label) + ".html";

        downloadLink.href = url;
        downloadLink.download = filename;
        downloadLink.textContent = "Download " + filename;
        outputSection.classList.remove('hidden');

        // Auto-start download
        downloadLink.click();
      });
    })();
  </script>
</body>
</html>
