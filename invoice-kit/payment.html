<!DOCTYPE html>
<html><head><title>nyx-local • Pay</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>nyx-local • Checkout</title><style>:root{--bg:#0a0a0a;--panel:#161616;--text:#f5f5f5;--muted:#bdbdbd;--accent:#FEB02E}*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,sans-serif;padding:24px}.sheet{max-width:560px;margin:0 auto;background:var(--panel);border-radius:12px;border:1px solid #222;overflow:hidden}header,footer{padding:16px 18px;border-bottom:1px solid #222}footer{border:0;color:var(--muted)}.row{display:flex;justify-content:space-between;gap:12px;padding:16px 18px;border-bottom:1px solid #222}.btn{display:inline-block;background:var(--accent);color:#000;padding:10px 14px;border-radius:9px;font-weight:800;border:0;cursor:pointer;margin-right:8px}.muted{color:var(--muted)}</style></head><body><div class="sheet"><header><div><strong>nyx-local • Checkout</strong></div><div class="muted" id="subtitle"></div></header><div class="row"><div>Recipient</div><code id="rcpt"></code></div><div class="row"><div>Total (SOL)</div><div id="amt"></div></div><div class="row"><div class="muted">Network</div><div id="net"></div></div><div class="row" style="display:block"><button id="connect" class="btn" type="button">Connect Wallet</button><button id="pay" class="btn" type="button" disabled="">Pay</button><a id="explorer" class="btn" href="#" target="_blank" rel="noopener" style="display:none">Explorer</a><div id="status" class="muted" style="margin-top:8px">Waiting…</div></div><footer>© 2025 nyx-local</footer></div><script src="data:text/javascript;base64,dmFyIHNvbGFuYVdlYjMgPSAoZnVuY3Rpb24gKGV4cG9ydHMpIHsKCSd1c2Ugc3RyaWN0JzsKCglmdW5jdGlvbiBnZXREZWZhdWx0RXhwb3J0RnJvbUNqcyAoeCkgewoJCXJldHVybiB4ICYmIHguX19lc01vZHVsZSAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoeCwgJ2RlZmF1bHQnKSA/IHhbJ2RlZmF1bHQnXSA6IHg7Cgl9CgoJZnVuY3Rpb24gZ2V0QXVnbWVudGVkTmFtZXNwYWNlKG4pIHsKCSAgaWYgKG4uX19lc01vZHVsZSkgcmV0dXJuIG47CgkgIHZhciBmID0gbi5kZWZhdWx0OwoJCWlmICh0eXBlb2YgZiA9PSAiZnVuY3Rpb24iKSB7CgkJCXZhciBhID0gZnVuY3Rpb24gYSAoKSB7CgkJCQlpZiAodGhpcyBpbnN0YW5jZW9mIGEpIHsKCSAgICAgICAgcmV0dXJuIFJlZmxlY3QuY29uc3RydWN0KGYsIGFyZ3VtZW50cywgdGhpcy5jb25zdHJ1Y3Rvcik7CgkJCQl9CgkJCQlyZXR1cm4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCQl9OwoJCQlhLnByb3RvdHlwZSA9IGYucHJvdG90eXBlOwoJICB9IGVsc2UgYSA9IHt9OwoJICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYSwgJ19fZXNNb2R1bGUnLCB7dmFsdWU6IHRydWV9KTsKCQlPYmplY3Qua2V5cyhuKS5mb3JFYWNoKGZ1bmN0aW9uIChrKSB7CgkJCXZhciBkID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihuLCBrKTsKCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KGEsIGssIGQuZ2V0ID8gZCA6IHsKCQkJCWVudW1lcmFibGU6IHRydWUsCgkJCQlnZXQ6IGZ1bmN0aW9uICgpIHsKCQkJCQlyZXR1cm4gbltrXTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIGE7Cgl9CgoJdmFyIGJ1ZmZlciA9IHt9OwoKCXZhciBiYXNlNjRKcyA9IHt9OwoKCXZhciBoYXNSZXF1aXJlZEJhc2U2NEpzOwoKCWZ1bmN0aW9uIHJlcXVpcmVCYXNlNjRKcyAoKSB7CgkJaWYgKGhhc1JlcXVpcmVkQmFzZTY0SnMpIHJldHVybiBiYXNlNjRKczsKCQloYXNSZXF1aXJlZEJhc2U2NEpzID0gMTsKCgkJYmFzZTY0SnMuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGg7CgkJYmFzZTY0SnMudG9CeXRlQXJyYXkgPSB0b0J5dGVBcnJheTsKCQliYXNlNjRKcy5mcm9tQnl0ZUFycmF5ID0gZnJvbUJ5dGVBcnJheTsKCgkJdmFyIGxvb2t1cCA9IFtdOwoJCXZhciByZXZMb29rdXAgPSBbXTsKCQl2YXIgQXJyID0gdHlwZW9mIFVpbnQ4QXJyYXkgIT09ICd1bmRlZmluZWQnID8gVWludDhBcnJheSA6IEFycmF5OwoKCQl2YXIgY29kZSA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvJzsKCQlmb3IgKHZhciBpID0gMCwgbGVuID0gY29kZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewoJCSAgbG9va3VwW2ldID0gY29kZVtpXTsKCQkgIHJldkxvb2t1cFtjb2RlLmNoYXJDb2RlQXQoaSldID0gaTsKCQl9CgoJCS8vIFN1cHBvcnQgZGVjb2RpbmcgVVJMLXNhZmUgYmFzZTY0IHN0cmluZ3MsIGFzIE5vZGUuanMgZG9lcy4KCQkvLyBTZWU6IGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Jhc2U2NCNVUkxfYXBwbGljYXRpb25zCgkJcmV2TG9va3VwWyctJy5jaGFyQ29kZUF0KDApXSA9IDYyOwoJCXJldkxvb2t1cFsnXycuY2hhckNvZGVBdCgwKV0gPSA2MzsKCgkJZnVuY3Rpb24gZ2V0TGVucyAoYjY0KSB7CgkJICB2YXIgbGVuID0gYjY0Lmxlbmd0aDsKCgkJICBpZiAobGVuICUgNCA+IDApIHsKCQkgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0JykKCQkgIH0KCgkJICAvLyBUcmltIG9mZiBleHRyYSBieXRlcyBhZnRlciBwbGFjZWhvbGRlciBieXRlcyBhcmUgZm91bmQKCQkgIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2JlYXRnYW1taXQvYmFzZTY0LWpzL2lzc3Vlcy80MgoJCSAgdmFyIHZhbGlkTGVuID0gYjY0LmluZGV4T2YoJz0nKTsKCQkgIGlmICh2YWxpZExlbiA9PT0gLTEpIHZhbGlkTGVuID0gbGVuOwoKCQkgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSB2YWxpZExlbiA9PT0gbGVuCgkJICAgID8gMAoJCSAgICA6IDQgLSAodmFsaWRMZW4gJSA0KTsKCgkJICByZXR1cm4gW3ZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW5dCgkJfQoKCQkvLyBiYXNlNjQgaXMgNC8zICsgdXAgdG8gdHdvIGNoYXJhY3RlcnMgb2YgdGhlIG9yaWdpbmFsIGRhdGEKCQlmdW5jdGlvbiBieXRlTGVuZ3RoIChiNjQpIHsKCQkgIHZhciBsZW5zID0gZ2V0TGVucyhiNjQpOwoJCSAgdmFyIHZhbGlkTGVuID0gbGVuc1swXTsKCQkgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSBsZW5zWzFdOwoJCSAgcmV0dXJuICgodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQpIC0gcGxhY2VIb2xkZXJzTGVuCgkJfQoKCQlmdW5jdGlvbiBfYnl0ZUxlbmd0aCAoYjY0LCB2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuKSB7CgkJICByZXR1cm4gKCh2YWxpZExlbiArIHBsYWNlSG9sZGVyc0xlbikgKiAzIC8gNCkgLSBwbGFjZUhvbGRlcnNMZW4KCQl9CgoJCWZ1bmN0aW9uIHRvQnl0ZUFycmF5IChiNjQpIHsKCQkgIHZhciB0bXA7CgkJICB2YXIgbGVucyA9IGdldExlbnMoYjY0KTsKCQkgIHZhciB2YWxpZExlbiA9IGxlbnNbMF07CgkJICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXTsKCgkJICB2YXIgYXJyID0gbmV3IEFycihfYnl0ZUxlbmd0aChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pKTsKCgkJICB2YXIgY3VyQnl0ZSA9IDA7CgoJCSAgLy8gaWYgdGhlcmUgYXJlIHBsYWNlaG9sZGVycywgb25seSBnZXQgdXAgdG8gdGhlIGxhc3QgY29tcGxldGUgNCBjaGFycwoJCSAgdmFyIGxlbiA9IHBsYWNlSG9sZGVyc0xlbiA+IDAKCQkgICAgPyB2YWxpZExlbiAtIDQKCQkgICAgOiB2YWxpZExlbjsKCgkJICB2YXIgaTsKCQkgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewoJCSAgICB0bXAgPQoJCSAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDE4KSB8CgkJICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldIDw8IDEyKSB8CgkJICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMildIDw8IDYpIHwKCQkgICAgICByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDMpXTsKCQkgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDE2KSAmIDB4RkY7CgkJICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiA4KSAmIDB4RkY7CgkJICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRjsKCQkgIH0KCgkJICBpZiAocGxhY2VIb2xkZXJzTGVuID09PSAyKSB7CgkJICAgIHRtcCA9CgkJICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMikgfAoJCSAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA+PiA0KTsKCQkgICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGOwoJCSAgfQoKCQkgIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDEpIHsKCQkgICAgdG1wID0KCQkgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAxMCkgfAoJCSAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCA0KSB8CgkJICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMildID4+IDIpOwoJCSAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gOCkgJiAweEZGOwoJCSAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkY7CgkJICB9CgoJCSAgcmV0dXJuIGFycgoJCX0KCgkJZnVuY3Rpb24gdHJpcGxldFRvQmFzZTY0IChudW0pIHsKCQkgIHJldHVybiBsb29rdXBbbnVtID4+IDE4ICYgMHgzRl0gKwoJCSAgICBsb29rdXBbbnVtID4+IDEyICYgMHgzRl0gKwoJCSAgICBsb29rdXBbbnVtID4+IDYgJiAweDNGXSArCgkJICAgIGxvb2t1cFtudW0gJiAweDNGXQoJCX0KCgkJZnVuY3Rpb24gZW5jb2RlQ2h1bmsgKHVpbnQ4LCBzdGFydCwgZW5kKSB7CgkJICB2YXIgdG1wOwoJCSAgdmFyIG91dHB1dCA9IFtdOwoJCSAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpICs9IDMpIHsKCQkgICAgdG1wID0KCQkgICAgICAoKHVpbnQ4W2ldIDw8IDE2KSAmIDB4RkYwMDAwKSArCgkJICAgICAgKCh1aW50OFtpICsgMV0gPDwgOCkgJiAweEZGMDApICsKCQkgICAgICAodWludDhbaSArIDJdICYgMHhGRik7CgkJICAgIG91dHB1dC5wdXNoKHRyaXBsZXRUb0Jhc2U2NCh0bXApKTsKCQkgIH0KCQkgIHJldHVybiBvdXRwdXQuam9pbignJykKCQl9CgoJCWZ1bmN0aW9uIGZyb21CeXRlQXJyYXkgKHVpbnQ4KSB7CgkJICB2YXIgdG1wOwoJCSAgdmFyIGxlbiA9IHVpbnQ4Lmxlbmd0aDsKCQkgIHZhciBleHRyYUJ5dGVzID0gbGVuICUgMzsgLy8gaWYgd2UgaGF2ZSAxIGJ5dGUgbGVmdCwgcGFkIDIgYnl0ZXMKCQkgIHZhciBwYXJ0cyA9IFtdOwoJCSAgdmFyIG1heENodW5rTGVuZ3RoID0gMTYzODM7IC8vIG11c3QgYmUgbXVsdGlwbGUgb2YgMwoKCQkgIC8vIGdvIHRocm91Z2ggdGhlIGFycmF5IGV2ZXJ5IHRocmVlIGJ5dGVzLCB3ZSdsbCBkZWFsIHdpdGggdHJhaWxpbmcgc3R1ZmYgbGF0ZXIKCQkgIGZvciAodmFyIGkgPSAwLCBsZW4yID0gbGVuIC0gZXh0cmFCeXRlczsgaSA8IGxlbjI7IGkgKz0gbWF4Q2h1bmtMZW5ndGgpIHsKCQkgICAgcGFydHMucHVzaChlbmNvZGVDaHVuayh1aW50OCwgaSwgKGkgKyBtYXhDaHVua0xlbmd0aCkgPiBsZW4yID8gbGVuMiA6IChpICsgbWF4Q2h1bmtMZW5ndGgpKSk7CgkJICB9CgoJCSAgLy8gcGFkIHRoZSBlbmQgd2l0aCB6ZXJvcywgYnV0IG1ha2Ugc3VyZSB0byBub3QgZm9yZ2V0IHRoZSBleHRyYSBieXRlcwoJCSAgaWYgKGV4dHJhQnl0ZXMgPT09IDEpIHsKCQkgICAgdG1wID0gdWludDhbbGVuIC0gMV07CgkJICAgIHBhcnRzLnB1c2goCgkJICAgICAgbG9va3VwW3RtcCA+PiAyXSArCgkJICAgICAgbG9va3VwWyh0bXAgPDwgNCkgJiAweDNGXSArCgkJICAgICAgJz09JwoJCSAgICApOwoJCSAgfSBlbHNlIGlmIChleHRyYUJ5dGVzID09PSAyKSB7CgkJICAgIHRtcCA9ICh1aW50OFtsZW4gLSAyXSA8PCA4KSArIHVpbnQ4W2xlbiAtIDFdOwoJCSAgICBwYXJ0cy5wdXNoKAoJCSAgICAgIGxvb2t1cFt0bXAgPj4gMTBdICsKCQkgICAgICBsb29rdXBbKHRtcCA+PiA0KSAmIDB4M0ZdICsKCQkgICAgICBsb29rdXBbKHRtcCA8PCAyKSAmIDB4M0ZdICsKCQkgICAgICAnPScKCQkgICAgKTsKCQkgIH0KCgkJICByZXR1cm4gcGFydHMuam9pbignJykKCQl9CgkJcmV0dXJuIGJhc2U2NEpzOwoJfQoKCXZhciBpZWVlNzU0ID0ge307CgoJLyohIGllZWU3NTQuIEJTRC0zLUNsYXVzZSBMaWNlbnNlLiBGZXJvc3MgQWJvdWtoYWRpamVoIDxodHRwczovL2Zlcm9zcy5vcmcvb3BlbnNvdXJjZT4gKi8KCgl2YXIgaGFzUmVxdWlyZWRJZWVlNzU0OwoKCWZ1bmN0aW9uIHJlcXVpcmVJZWVlNzU0ICgpIHsKCQlpZiAoaGFzUmVxdWlyZWRJZWVlNzU0KSByZXR1cm4gaWVlZTc1NDsKCQloYXNSZXF1aXJlZEllZWU3NTQgPSAxOwoJCWllZWU3NTQucmVhZCA9IGZ1bmN0aW9uIChidWZmZXIsIG9mZnNldCwgaXNMRSwgbUxlbiwgbkJ5dGVzKSB7CgkJICB2YXIgZSwgbTsKCQkgIHZhciBlTGVuID0gKG5CeXRlcyAqIDgpIC0gbUxlbiAtIDE7CgkJICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMTsKCQkgIHZhciBlQmlhcyA9IGVNYXggPj4gMTsKCQkgIHZhciBuQml0cyA9IC03OwoJCSAgdmFyIGkgPSBpc0xFID8gKG5CeXRlcyAtIDEpIDogMDsKCQkgIHZhciBkID0gaXNMRSA/IC0xIDogMTsKCQkgIHZhciBzID0gYnVmZmVyW29mZnNldCArIGldOwoKCQkgIGkgKz0gZDsKCgkJICBlID0gcyAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKTsKCQkgIHMgPj49ICgtbkJpdHMpOwoJCSAgbkJpdHMgKz0gZUxlbjsKCQkgIGZvciAoOyBuQml0cyA+IDA7IGUgPSAoZSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KCgkJICBtID0gZSAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKTsKCQkgIGUgPj49ICgtbkJpdHMpOwoJCSAgbkJpdHMgKz0gbUxlbjsKCQkgIGZvciAoOyBuQml0cyA+IDA7IG0gPSAobSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KCgkJICBpZiAoZSA9PT0gMCkgewoJCSAgICBlID0gMSAtIGVCaWFzOwoJCSAgfSBlbHNlIGlmIChlID09PSBlTWF4KSB7CgkJICAgIHJldHVybiBtID8gTmFOIDogKChzID8gLTEgOiAxKSAqIEluZmluaXR5KQoJCSAgfSBlbHNlIHsKCQkgICAgbSA9IG0gKyBNYXRoLnBvdygyLCBtTGVuKTsKCQkgICAgZSA9IGUgLSBlQmlhczsKCQkgIH0KCQkgIHJldHVybiAocyA/IC0xIDogMSkgKiBtICogTWF0aC5wb3coMiwgZSAtIG1MZW4pCgkJfTsKCgkJaWVlZTc1NC53cml0ZSA9IGZ1bmN0aW9uIChidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewoJCSAgdmFyIGUsIG0sIGM7CgkJICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxOwoJCSAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDE7CgkJICB2YXIgZUJpYXMgPSBlTWF4ID4+IDE7CgkJICB2YXIgcnQgPSAobUxlbiA9PT0gMjMgPyBNYXRoLnBvdygyLCAtMjQpIC0gTWF0aC5wb3coMiwgLTc3KSA6IDApOwoJCSAgdmFyIGkgPSBpc0xFID8gMCA6IChuQnl0ZXMgLSAxKTsKCQkgIHZhciBkID0gaXNMRSA/IDEgOiAtMTsKCQkgIHZhciBzID0gdmFsdWUgPCAwIHx8ICh2YWx1ZSA9PT0gMCAmJiAxIC8gdmFsdWUgPCAwKSA/IDEgOiAwOwoKCQkgIHZhbHVlID0gTWF0aC5hYnModmFsdWUpOwoKCQkgIGlmIChpc05hTih2YWx1ZSkgfHwgdmFsdWUgPT09IEluZmluaXR5KSB7CgkJICAgIG0gPSBpc05hTih2YWx1ZSkgPyAxIDogMDsKCQkgICAgZSA9IGVNYXg7CgkJICB9IGVsc2UgewoJCSAgICBlID0gTWF0aC5mbG9vcihNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMik7CgkJICAgIGlmICh2YWx1ZSAqIChjID0gTWF0aC5wb3coMiwgLWUpKSA8IDEpIHsKCQkgICAgICBlLS07CgkJICAgICAgYyAqPSAyOwoJCSAgICB9CgkJICAgIGlmIChlICsgZUJpYXMgPj0gMSkgewoJCSAgICAgIHZhbHVlICs9IHJ0IC8gYzsKCQkgICAgfSBlbHNlIHsKCQkgICAgICB2YWx1ZSArPSBydCAqIE1hdGgucG93KDIsIDEgLSBlQmlhcyk7CgkJICAgIH0KCQkgICAgaWYgKHZhbHVlICogYyA+PSAyKSB7CgkJICAgICAgZSsrOwoJCSAgICAgIGMgLz0gMjsKCQkgICAgfQoKCQkgICAgaWYgKGUgKyBlQmlhcyA+PSBlTWF4KSB7CgkJICAgICAgbSA9IDA7CgkJICAgICAgZSA9IGVNYXg7CgkJICAgIH0gZWxzZSBpZiAoZSArIGVCaWFzID49IDEpIHsKCQkgICAgICBtID0gKCh2YWx1ZSAqIGMpIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKTsKCQkgICAgICBlID0gZSArIGVCaWFzOwoJCSAgICB9IGVsc2UgewoJCSAgICAgIG0gPSB2YWx1ZSAqIE1hdGgucG93KDIsIGVCaWFzIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKTsKCQkgICAgICBlID0gMDsKCQkgICAgfQoJCSAgfQoKCQkgIGZvciAoOyBtTGVuID49IDg7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IG0gJiAweGZmLCBpICs9IGQsIG0gLz0gMjU2LCBtTGVuIC09IDgpIHt9CgoJCSAgZSA9IChlIDw8IG1MZW4pIHwgbTsKCQkgIGVMZW4gKz0gbUxlbjsKCQkgIGZvciAoOyBlTGVuID4gMDsgYnVmZmVyW29mZnNldCArIGldID0gZSAmIDB4ZmYsIGkgKz0gZCwgZSAvPSAyNTYsIGVMZW4gLT0gOCkge30KCgkJICBidWZmZXJbb2Zmc2V0ICsgaSAtIGRdIHw9IHMgKiAxMjg7CgkJfTsKCQlyZXR1cm4gaWVlZTc1NDsKCX0KCgkvKiEKCSAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgoJICoKCSAqIEBhdXRob3IgICBGZXJvc3MgQWJvdWtoYWRpamVoIDxodHRwczovL2Zlcm9zcy5vcmc+CgkgKiBAbGljZW5zZSAgTUlUCgkgKi8KCgl2YXIgaGFzUmVxdWlyZWRCdWZmZXI7CgoJZnVuY3Rpb24gcmVxdWlyZUJ1ZmZlciAoKSB7CgkJaWYgKGhhc1JlcXVpcmVkQnVmZmVyKSByZXR1cm4gYnVmZmVyOwoJCWhhc1JlcXVpcmVkQnVmZmVyID0gMTsKCQkoZnVuY3Rpb24gKGV4cG9ydHMpIHsKCgkJCWNvbnN0IGJhc2U2NCA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUJhc2U2NEpzKCk7CgkJCWNvbnN0IGllZWU3NTQgPSAvKkBfX1BVUkVfXyovIHJlcXVpcmVJZWVlNzU0KCk7CgkJCWNvbnN0IGN1c3RvbUluc3BlY3RTeW1ib2wgPQoJCQkgICh0eXBlb2YgU3ltYm9sID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBTeW1ib2xbJ2ZvciddID09PSAnZnVuY3Rpb24nKSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGRvdC1ub3RhdGlvbgoJCQkgICAgPyBTeW1ib2xbJ2ZvciddKCdub2RlanMudXRpbC5pbnNwZWN0LmN1c3RvbScpIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZG90LW5vdGF0aW9uCgkJCSAgICA6IG51bGw7CgoJCQlleHBvcnRzLkJ1ZmZlciA9IEJ1ZmZlcjsKCQkJZXhwb3J0cy5TbG93QnVmZmVyID0gU2xvd0J1ZmZlcjsKCQkJZXhwb3J0cy5JTlNQRUNUX01BWF9CWVRFUyA9IDUwOwoKCQkJY29uc3QgS19NQVhfTEVOR1RIID0gMHg3ZmZmZmZmZjsKCQkJZXhwb3J0cy5rTWF4TGVuZ3RoID0gS19NQVhfTEVOR1RIOwoKCQkJLyoqCgkJCSAqIElmIGBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVGA6CgkJCSAqICAgPT09IHRydWUgICAgVXNlIFVpbnQ4QXJyYXkgaW1wbGVtZW50YXRpb24gKGZhc3Rlc3QpCgkJCSAqICAgPT09IGZhbHNlICAgUHJpbnQgd2FybmluZyBhbmQgcmVjb21tZW5kIHVzaW5nIGBidWZmZXJgIHY0Lnggd2hpY2ggaGFzIGFuIE9iamVjdAoJCQkgKiAgICAgICAgICAgICAgIGltcGxlbWVudGF0aW9uIChtb3N0IGNvbXBhdGlibGUsIGV2ZW4gSUU2KQoJCQkgKgoJCQkgKiBCcm93c2VycyB0aGF0IHN1cHBvcnQgdHlwZWQgYXJyYXlzIGFyZSBJRSAxMCssIEZpcmVmb3ggNCssIENocm9tZSA3KywgU2FmYXJpIDUuMSssCgkJCSAqIE9wZXJhIDExLjYrLCBpT1MgNC4yKy4KCQkJICoKCQkJICogV2UgcmVwb3J0IHRoYXQgdGhlIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCB0eXBlZCBhcnJheXMgaWYgdGhlIGFyZSBub3Qgc3ViY2xhc3NhYmxlCgkJCSAqIHVzaW5nIF9fcHJvdG9fXy4gRmlyZWZveCA0LTI5IGxhY2tzIHN1cHBvcnQgZm9yIGFkZGluZyBuZXcgcHJvcGVydGllcyB0byBgVWludDhBcnJheWAKCQkJICogKFNlZTogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njk1NDM4KS4gSUUgMTAgbGFja3Mgc3VwcG9ydAoJCQkgKiBmb3IgX19wcm90b19fIGFuZCBoYXMgYSBidWdneSB0eXBlZCBhcnJheSBpbXBsZW1lbnRhdGlvbi4KCQkJICovCgkJCUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUID0gdHlwZWRBcnJheVN1cHBvcnQoKTsKCgkJCWlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmCgkJCSAgICB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gJ2Z1bmN0aW9uJykgewoJCQkgIGNvbnNvbGUuZXJyb3IoCgkJCSAgICAnVGhpcyBicm93c2VyIGxhY2tzIHR5cGVkIGFycmF5IChVaW50OEFycmF5KSBzdXBwb3J0IHdoaWNoIGlzIHJlcXVpcmVkIGJ5ICcgKwoJCQkgICAgJ2BidWZmZXJgIHY1LnguIFVzZSBgYnVmZmVyYCB2NC54IGlmIHlvdSByZXF1aXJlIG9sZCBicm93c2VyIHN1cHBvcnQuJwoJCQkgICk7CgkJCX0KCgkJCWZ1bmN0aW9uIHR5cGVkQXJyYXlTdXBwb3J0ICgpIHsKCQkJICAvLyBDYW4gdHlwZWQgYXJyYXkgaW5zdGFuY2VzIGNhbiBiZSBhdWdtZW50ZWQ/CgkJCSAgdHJ5IHsKCQkJICAgIGNvbnN0IGFyciA9IG5ldyBVaW50OEFycmF5KDEpOwoJCQkgICAgY29uc3QgcHJvdG8gPSB7IGZvbzogZnVuY3Rpb24gKCkgeyByZXR1cm4gNDIgfSB9OwoJCQkgICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHByb3RvLCBVaW50OEFycmF5LnByb3RvdHlwZSk7CgkJCSAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoYXJyLCBwcm90byk7CgkJCSAgICByZXR1cm4gYXJyLmZvbygpID09PSA0MgoJCQkgIH0gY2F0Y2ggKGUpIHsKCQkJICAgIHJldHVybiBmYWxzZQoJCQkgIH0KCQkJfQoKCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KEJ1ZmZlci5wcm90b3R5cGUsICdwYXJlbnQnLCB7CgkJCSAgZW51bWVyYWJsZTogdHJ1ZSwKCQkJICBnZXQ6IGZ1bmN0aW9uICgpIHsKCQkJICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKHRoaXMpKSByZXR1cm4gdW5kZWZpbmVkCgkJCSAgICByZXR1cm4gdGhpcy5idWZmZXIKCQkJICB9CgkJCX0pOwoKCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KEJ1ZmZlci5wcm90b3R5cGUsICdvZmZzZXQnLCB7CgkJCSAgZW51bWVyYWJsZTogdHJ1ZSwKCQkJICBnZXQ6IGZ1bmN0aW9uICgpIHsKCQkJICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKHRoaXMpKSByZXR1cm4gdW5kZWZpbmVkCgkJCSAgICByZXR1cm4gdGhpcy5ieXRlT2Zmc2V0CgkJCSAgfQoJCQl9KTsKCgkJCWZ1bmN0aW9uIGNyZWF0ZUJ1ZmZlciAobGVuZ3RoKSB7CgkJCSAgaWYgKGxlbmd0aCA+IEtfTUFYX0xFTkdUSCkgewoJCQkgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RoZSB2YWx1ZSAiJyArIGxlbmd0aCArICciIGlzIGludmFsaWQgZm9yIG9wdGlvbiAic2l6ZSInKQoJCQkgIH0KCQkJICAvLyBSZXR1cm4gYW4gYXVnbWVudGVkIGBVaW50OEFycmF5YCBpbnN0YW5jZQoJCQkgIGNvbnN0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCk7CgkJCSAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGJ1ZiwgQnVmZmVyLnByb3RvdHlwZSk7CgkJCSAgcmV0dXJuIGJ1ZgoJCQl9CgoJCQkvKioKCQkJICogVGhlIEJ1ZmZlciBjb25zdHJ1Y3RvciByZXR1cm5zIGluc3RhbmNlcyBvZiBgVWludDhBcnJheWAgdGhhdCBoYXZlIHRoZWlyCgkJCSAqIHByb3RvdHlwZSBjaGFuZ2VkIHRvIGBCdWZmZXIucHJvdG90eXBlYC4gRnVydGhlcm1vcmUsIGBCdWZmZXJgIGlzIGEgc3ViY2xhc3Mgb2YKCQkJICogYFVpbnQ4QXJyYXlgLCBzbyB0aGUgcmV0dXJuZWQgaW5zdGFuY2VzIHdpbGwgaGF2ZSBhbGwgdGhlIG5vZGUgYEJ1ZmZlcmAgbWV0aG9kcwoJCQkgKiBhbmQgdGhlIGBVaW50OEFycmF5YCBtZXRob2RzLiBTcXVhcmUgYnJhY2tldCBub3RhdGlvbiB3b3JrcyBhcyBleHBlY3RlZCAtLSBpdAoJCQkgKiByZXR1cm5zIGEgc2luZ2xlIG9jdGV0LgoJCQkgKgoJCQkgKiBUaGUgYFVpbnQ4QXJyYXlgIHByb3RvdHlwZSByZW1haW5zIHVubW9kaWZpZWQuCgkJCSAqLwoKCQkJZnVuY3Rpb24gQnVmZmVyIChhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewoJCQkgIC8vIENvbW1vbiBjYXNlLgoJCQkgIGlmICh0eXBlb2YgYXJnID09PSAnbnVtYmVyJykgewoJCQkgICAgaWYgKHR5cGVvZiBlbmNvZGluZ09yT2Zmc2V0ID09PSAnc3RyaW5nJykgewoJCQkgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKAoJCQkgICAgICAgICdUaGUgInN0cmluZyIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIHN0cmluZy4gUmVjZWl2ZWQgdHlwZSBudW1iZXInCgkJCSAgICAgICkKCQkJICAgIH0KCQkJICAgIHJldHVybiBhbGxvY1Vuc2FmZShhcmcpCgkJCSAgfQoJCQkgIHJldHVybiBmcm9tKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQoJCQl9CgoJCQlCdWZmZXIucG9vbFNpemUgPSA4MTkyOyAvLyBub3QgdXNlZCBieSB0aGlzIGltcGxlbWVudGF0aW9uCgoJCQlmdW5jdGlvbiBmcm9tICh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CgkJCSAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKCQkJICAgIHJldHVybiBmcm9tU3RyaW5nKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0KQoJCQkgIH0KCgkJCSAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyh2YWx1ZSkpIHsKCQkJICAgIHJldHVybiBmcm9tQXJyYXlWaWV3KHZhbHVlKQoJCQkgIH0KCgkJCSAgaWYgKHZhbHVlID09IG51bGwpIHsKCQkJICAgIHRocm93IG5ldyBUeXBlRXJyb3IoCgkJCSAgICAgICdUaGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBvbmUgb2YgdHlwZSBzdHJpbmcsIEJ1ZmZlciwgQXJyYXlCdWZmZXIsIEFycmF5LCAnICsKCQkJICAgICAgJ29yIEFycmF5LWxpa2UgT2JqZWN0LiBSZWNlaXZlZCB0eXBlICcgKyAodHlwZW9mIHZhbHVlKQoJCQkgICAgKQoJCQkgIH0KCgkJCSAgaWYgKGlzSW5zdGFuY2UodmFsdWUsIEFycmF5QnVmZmVyKSB8fAoJCQkgICAgICAodmFsdWUgJiYgaXNJbnN0YW5jZSh2YWx1ZS5idWZmZXIsIEFycmF5QnVmZmVyKSkpIHsKCQkJICAgIHJldHVybiBmcm9tQXJyYXlCdWZmZXIodmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKCQkJICB9CgoJCQkgIGlmICh0eXBlb2YgU2hhcmVkQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCgkJCSAgICAgIChpc0luc3RhbmNlKHZhbHVlLCBTaGFyZWRBcnJheUJ1ZmZlcikgfHwKCQkJICAgICAgKHZhbHVlICYmIGlzSW5zdGFuY2UodmFsdWUuYnVmZmVyLCBTaGFyZWRBcnJheUJ1ZmZlcikpKSkgewoJCQkgICAgcmV0dXJuIGZyb21BcnJheUJ1ZmZlcih2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQoJCQkgIH0KCgkJCSAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHsKCQkJICAgIHRocm93IG5ldyBUeXBlRXJyb3IoCgkJCSAgICAgICdUaGUgInZhbHVlIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBvZiB0eXBlIG51bWJlci4gUmVjZWl2ZWQgdHlwZSBudW1iZXInCgkJCSAgICApCgkJCSAgfQoKCQkJICBjb25zdCB2YWx1ZU9mID0gdmFsdWUudmFsdWVPZiAmJiB2YWx1ZS52YWx1ZU9mKCk7CgkJCSAgaWYgKHZhbHVlT2YgIT0gbnVsbCAmJiB2YWx1ZU9mICE9PSB2YWx1ZSkgewoJCQkgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHZhbHVlT2YsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKCQkJICB9CgoJCQkgIGNvbnN0IGIgPSBmcm9tT2JqZWN0KHZhbHVlKTsKCQkJICBpZiAoYikgcmV0dXJuIGIKCgkJCSAgaWYgKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIFN5bWJvbC50b1ByaW1pdGl2ZSAhPSBudWxsICYmCgkJCSAgICAgIHR5cGVvZiB2YWx1ZVtTeW1ib2wudG9QcmltaXRpdmVdID09PSAnZnVuY3Rpb24nKSB7CgkJCSAgICByZXR1cm4gQnVmZmVyLmZyb20odmFsdWVbU3ltYm9sLnRvUHJpbWl0aXZlXSgnc3RyaW5nJyksIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKCQkJICB9CgoJCQkgIHRocm93IG5ldyBUeXBlRXJyb3IoCgkJCSAgICAnVGhlIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgb25lIG9mIHR5cGUgc3RyaW5nLCBCdWZmZXIsIEFycmF5QnVmZmVyLCBBcnJheSwgJyArCgkJCSAgICAnb3IgQXJyYXktbGlrZSBPYmplY3QuIFJlY2VpdmVkIHR5cGUgJyArICh0eXBlb2YgdmFsdWUpCgkJCSAgKQoJCQl9CgoJCQkvKioKCQkJICogRnVuY3Rpb25hbGx5IGVxdWl2YWxlbnQgdG8gQnVmZmVyKGFyZywgZW5jb2RpbmcpIGJ1dCB0aHJvd3MgYSBUeXBlRXJyb3IKCQkJICogaWYgdmFsdWUgaXMgYSBudW1iZXIuCgkJCSAqIEJ1ZmZlci5mcm9tKHN0clssIGVuY29kaW5nXSkKCQkJICogQnVmZmVyLmZyb20oYXJyYXkpCgkJCSAqIEJ1ZmZlci5mcm9tKGJ1ZmZlcikKCQkJICogQnVmZmVyLmZyb20oYXJyYXlCdWZmZXJbLCBieXRlT2Zmc2V0WywgbGVuZ3RoXV0pCgkJCSAqKi8KCQkJQnVmZmVyLmZyb20gPSBmdW5jdGlvbiAodmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewoJCQkgIHJldHVybiBmcm9tKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCgkJCX07CgoJCQkvLyBOb3RlOiBDaGFuZ2UgcHJvdG90eXBlICphZnRlciogQnVmZmVyLmZyb20gaXMgZGVmaW5lZCB0byB3b3JrYXJvdW5kIENocm9tZSBidWc6CgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9mZXJvc3MvYnVmZmVyL3B1bGwvMTQ4CgkJCU9iamVjdC5zZXRQcm90b3R5cGVPZihCdWZmZXIucHJvdG90eXBlLCBVaW50OEFycmF5LnByb3RvdHlwZSk7CgkJCU9iamVjdC5zZXRQcm90b3R5cGVPZihCdWZmZXIsIFVpbnQ4QXJyYXkpOwoKCQkJZnVuY3Rpb24gYXNzZXJ0U2l6ZSAoc2l6ZSkgewoJCQkgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKCQkJICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJzaXplIiBhcmd1bWVudCBtdXN0IGJlIG9mIHR5cGUgbnVtYmVyJykKCQkJICB9IGVsc2UgaWYgKHNpemUgPCAwKSB7CgkJCSAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignVGhlIHZhbHVlICInICsgc2l6ZSArICciIGlzIGludmFsaWQgZm9yIG9wdGlvbiAic2l6ZSInKQoJCQkgIH0KCQkJfQoKCQkJZnVuY3Rpb24gYWxsb2MgKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CgkJCSAgYXNzZXJ0U2l6ZShzaXplKTsKCQkJICBpZiAoc2l6ZSA8PSAwKSB7CgkJCSAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHNpemUpCgkJCSAgfQoJCQkgIGlmIChmaWxsICE9PSB1bmRlZmluZWQpIHsKCQkJICAgIC8vIE9ubHkgcGF5IGF0dGVudGlvbiB0byBlbmNvZGluZyBpZiBpdCdzIGEgc3RyaW5nLiBUaGlzCgkJCSAgICAvLyBwcmV2ZW50cyBhY2NpZGVudGFsbHkgc2VuZGluZyBpbiBhIG51bWJlciB0aGF0IHdvdWxkCgkJCSAgICAvLyBiZSBpbnRlcnByZXRlZCBhcyBhIHN0YXJ0IG9mZnNldC4KCQkJICAgIHJldHVybiB0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnCgkJCSAgICAgID8gY3JlYXRlQnVmZmVyKHNpemUpLmZpbGwoZmlsbCwgZW5jb2RpbmcpCgkJCSAgICAgIDogY3JlYXRlQnVmZmVyKHNpemUpLmZpbGwoZmlsbCkKCQkJICB9CgkJCSAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcihzaXplKQoJCQl9CgoJCQkvKioKCQkJICogQ3JlYXRlcyBhIG5ldyBmaWxsZWQgQnVmZmVyIGluc3RhbmNlLgoJCQkgKiBhbGxvYyhzaXplWywgZmlsbFssIGVuY29kaW5nXV0pCgkJCSAqKi8KCQkJQnVmZmVyLmFsbG9jID0gZnVuY3Rpb24gKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CgkJCSAgcmV0dXJuIGFsbG9jKHNpemUsIGZpbGwsIGVuY29kaW5nKQoJCQl9OwoKCQkJZnVuY3Rpb24gYWxsb2NVbnNhZmUgKHNpemUpIHsKCQkJICBhc3NlcnRTaXplKHNpemUpOwoJCQkgIHJldHVybiBjcmVhdGVCdWZmZXIoc2l6ZSA8IDAgPyAwIDogY2hlY2tlZChzaXplKSB8IDApCgkJCX0KCgkJCS8qKgoJCQkgKiBFcXVpdmFsZW50IHRvIEJ1ZmZlcihudW0pLCBieSBkZWZhdWx0IGNyZWF0ZXMgYSBub24temVyby1maWxsZWQgQnVmZmVyIGluc3RhbmNlLgoJCQkgKiAqLwoJCQlCdWZmZXIuYWxsb2NVbnNhZmUgPSBmdW5jdGlvbiAoc2l6ZSkgewoJCQkgIHJldHVybiBhbGxvY1Vuc2FmZShzaXplKQoJCQl9OwoJCQkvKioKCQkJICogRXF1aXZhbGVudCB0byBTbG93QnVmZmVyKG51bSksIGJ5IGRlZmF1bHQgY3JlYXRlcyBhIG5vbi16ZXJvLWZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCgkJCSAqLwoJCQlCdWZmZXIuYWxsb2NVbnNhZmVTbG93ID0gZnVuY3Rpb24gKHNpemUpIHsKCQkJICByZXR1cm4gYWxsb2NVbnNhZmUoc2l6ZSkKCQkJfTsKCgkJCWZ1bmN0aW9uIGZyb21TdHJpbmcgKHN0cmluZywgZW5jb2RpbmcpIHsKCQkJICBpZiAodHlwZW9mIGVuY29kaW5nICE9PSAnc3RyaW5nJyB8fCBlbmNvZGluZyA9PT0gJycpIHsKCQkJICAgIGVuY29kaW5nID0gJ3V0ZjgnOwoJCQkgIH0KCgkJCSAgaWYgKCFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHsKCQkJICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKCQkJICB9CgoJCQkgIGNvbnN0IGxlbmd0aCA9IGJ5dGVMZW5ndGgoc3RyaW5nLCBlbmNvZGluZykgfCAwOwoJCQkgIGxldCBidWYgPSBjcmVhdGVCdWZmZXIobGVuZ3RoKTsKCgkJCSAgY29uc3QgYWN0dWFsID0gYnVmLndyaXRlKHN0cmluZywgZW5jb2RpbmcpOwoKCQkJICBpZiAoYWN0dWFsICE9PSBsZW5ndGgpIHsKCQkJICAgIC8vIFdyaXRpbmcgYSBoZXggc3RyaW5nLCBmb3IgZXhhbXBsZSwgdGhhdCBjb250YWlucyBpbnZhbGlkIGNoYXJhY3RlcnMgd2lsbAoJCQkgICAgLy8gY2F1c2UgZXZlcnl0aGluZyBhZnRlciB0aGUgZmlyc3QgaW52YWxpZCBjaGFyYWN0ZXIgdG8gYmUgaWdub3JlZC4gKGUuZy4KCQkJICAgIC8vICdhYnh4Y2QnIHdpbGwgYmUgdHJlYXRlZCBhcyAnYWInKQoJCQkgICAgYnVmID0gYnVmLnNsaWNlKDAsIGFjdHVhbCk7CgkJCSAgfQoKCQkJICByZXR1cm4gYnVmCgkJCX0KCgkJCWZ1bmN0aW9uIGZyb21BcnJheUxpa2UgKGFycmF5KSB7CgkJCSAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoIDwgMCA/IDAgOiBjaGVja2VkKGFycmF5Lmxlbmd0aCkgfCAwOwoJCQkgIGNvbnN0IGJ1ZiA9IGNyZWF0ZUJ1ZmZlcihsZW5ndGgpOwoJCQkgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKCQkJICAgIGJ1ZltpXSA9IGFycmF5W2ldICYgMjU1OwoJCQkgIH0KCQkJICByZXR1cm4gYnVmCgkJCX0KCgkJCWZ1bmN0aW9uIGZyb21BcnJheVZpZXcgKGFycmF5VmlldykgewoJCQkgIGlmIChpc0luc3RhbmNlKGFycmF5VmlldywgVWludDhBcnJheSkpIHsKCQkJICAgIGNvbnN0IGNvcHkgPSBuZXcgVWludDhBcnJheShhcnJheVZpZXcpOwoJCQkgICAgcmV0dXJuIGZyb21BcnJheUJ1ZmZlcihjb3B5LmJ1ZmZlciwgY29weS5ieXRlT2Zmc2V0LCBjb3B5LmJ5dGVMZW5ndGgpCgkJCSAgfQoJCQkgIHJldHVybiBmcm9tQXJyYXlMaWtlKGFycmF5VmlldykKCQkJfQoKCQkJZnVuY3Rpb24gZnJvbUFycmF5QnVmZmVyIChhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CgkJCSAgaWYgKGJ5dGVPZmZzZXQgPCAwIHx8IGFycmF5LmJ5dGVMZW5ndGggPCBieXRlT2Zmc2V0KSB7CgkJCSAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignIm9mZnNldCIgaXMgb3V0c2lkZSBvZiBidWZmZXIgYm91bmRzJykKCQkJICB9CgoJCQkgIGlmIChhcnJheS5ieXRlTGVuZ3RoIDwgYnl0ZU9mZnNldCArIChsZW5ndGggfHwgMCkpIHsKCQkJICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCcibGVuZ3RoIiBpcyBvdXRzaWRlIG9mIGJ1ZmZlciBib3VuZHMnKQoJCQkgIH0KCgkJCSAgbGV0IGJ1ZjsKCQkJICBpZiAoYnl0ZU9mZnNldCA9PT0gdW5kZWZpbmVkICYmIGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CgkJCSAgICBidWYgPSBuZXcgVWludDhBcnJheShhcnJheSk7CgkJCSAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewoJCQkgICAgYnVmID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXksIGJ5dGVPZmZzZXQpOwoJCQkgIH0gZWxzZSB7CgkJCSAgICBidWYgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKCQkJICB9CgoJCQkgIC8vIFJldHVybiBhbiBhdWdtZW50ZWQgYFVpbnQ4QXJyYXlgIGluc3RhbmNlCgkJCSAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGJ1ZiwgQnVmZmVyLnByb3RvdHlwZSk7CgoJCQkgIHJldHVybiBidWYKCQkJfQoKCQkJZnVuY3Rpb24gZnJvbU9iamVjdCAob2JqKSB7CgkJCSAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihvYmopKSB7CgkJCSAgICBjb25zdCBsZW4gPSBjaGVja2VkKG9iai5sZW5ndGgpIHwgMDsKCQkJICAgIGNvbnN0IGJ1ZiA9IGNyZWF0ZUJ1ZmZlcihsZW4pOwoKCQkJICAgIGlmIChidWYubGVuZ3RoID09PSAwKSB7CgkJCSAgICAgIHJldHVybiBidWYKCQkJICAgIH0KCgkJCSAgICBvYmouY29weShidWYsIDAsIDAsIGxlbik7CgkJCSAgICByZXR1cm4gYnVmCgkJCSAgfQoKCQkJICBpZiAob2JqLmxlbmd0aCAhPT0gdW5kZWZpbmVkKSB7CgkJCSAgICBpZiAodHlwZW9mIG9iai5sZW5ndGggIT09ICdudW1iZXInIHx8IG51bWJlcklzTmFOKG9iai5sZW5ndGgpKSB7CgkJCSAgICAgIHJldHVybiBjcmVhdGVCdWZmZXIoMCkKCQkJICAgIH0KCQkJICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKG9iaikKCQkJICB9CgoJCQkgIGlmIChvYmoudHlwZSA9PT0gJ0J1ZmZlcicgJiYgQXJyYXkuaXNBcnJheShvYmouZGF0YSkpIHsKCQkJICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKG9iai5kYXRhKQoJCQkgIH0KCQkJfQoKCQkJZnVuY3Rpb24gY2hlY2tlZCAobGVuZ3RoKSB7CgkJCSAgLy8gTm90ZTogY2Fubm90IHVzZSBgbGVuZ3RoIDwgS19NQVhfTEVOR1RIYCBoZXJlIGJlY2F1c2UgdGhhdCBmYWlscyB3aGVuCgkJCSAgLy8gbGVuZ3RoIGlzIE5hTiAod2hpY2ggaXMgb3RoZXJ3aXNlIGNvZXJjZWQgdG8gemVyby4pCgkJCSAgaWYgKGxlbmd0aCA+PSBLX01BWF9MRU5HVEgpIHsKCQkJICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtICcgKwoJCQkgICAgICAgICAgICAgICAgICAgICAgICAgJ3NpemU6IDB4JyArIEtfTUFYX0xFTkdUSC50b1N0cmluZygxNikgKyAnIGJ5dGVzJykKCQkJICB9CgkJCSAgcmV0dXJuIGxlbmd0aCB8IDAKCQkJfQoKCQkJZnVuY3Rpb24gU2xvd0J1ZmZlciAobGVuZ3RoKSB7CgkJCSAgaWYgKCtsZW5ndGggIT0gbGVuZ3RoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZXFlcWVxCgkJCSAgICBsZW5ndGggPSAwOwoJCQkgIH0KCQkJICByZXR1cm4gQnVmZmVyLmFsbG9jKCtsZW5ndGgpCgkJCX0KCgkJCUJ1ZmZlci5pc0J1ZmZlciA9IGZ1bmN0aW9uIGlzQnVmZmVyIChiKSB7CgkJCSAgcmV0dXJuIGIgIT0gbnVsbCAmJiBiLl9pc0J1ZmZlciA9PT0gdHJ1ZSAmJgoJCQkgICAgYiAhPT0gQnVmZmVyLnByb3RvdHlwZSAvLyBzbyBCdWZmZXIuaXNCdWZmZXIoQnVmZmVyLnByb3RvdHlwZSkgd2lsbCBiZSBmYWxzZQoJCQl9OwoKCQkJQnVmZmVyLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlIChhLCBiKSB7CgkJCSAgaWYgKGlzSW5zdGFuY2UoYSwgVWludDhBcnJheSkpIGEgPSBCdWZmZXIuZnJvbShhLCBhLm9mZnNldCwgYS5ieXRlTGVuZ3RoKTsKCQkJICBpZiAoaXNJbnN0YW5jZShiLCBVaW50OEFycmF5KSkgYiA9IEJ1ZmZlci5mcm9tKGIsIGIub2Zmc2V0LCBiLmJ5dGVMZW5ndGgpOwoJCQkgIGlmICghQnVmZmVyLmlzQnVmZmVyKGEpIHx8ICFCdWZmZXIuaXNCdWZmZXIoYikpIHsKCQkJICAgIHRocm93IG5ldyBUeXBlRXJyb3IoCgkJCSAgICAgICdUaGUgImJ1ZjEiLCAiYnVmMiIgYXJndW1lbnRzIG11c3QgYmUgb25lIG9mIHR5cGUgQnVmZmVyIG9yIFVpbnQ4QXJyYXknCgkJCSAgICApCgkJCSAgfQoKCQkJICBpZiAoYSA9PT0gYikgcmV0dXJuIDAKCgkJCSAgbGV0IHggPSBhLmxlbmd0aDsKCQkJICBsZXQgeSA9IGIubGVuZ3RoOwoKCQkJICBmb3IgKGxldCBpID0gMCwgbGVuID0gTWF0aC5taW4oeCwgeSk7IGkgPCBsZW47ICsraSkgewoJCQkgICAgaWYgKGFbaV0gIT09IGJbaV0pIHsKCQkJICAgICAgeCA9IGFbaV07CgkJCSAgICAgIHkgPSBiW2ldOwoJCQkgICAgICBicmVhawoJCQkgICAgfQoJCQkgIH0KCgkJCSAgaWYgKHggPCB5KSByZXR1cm4gLTEKCQkJICBpZiAoeSA8IHgpIHJldHVybiAxCgkJCSAgcmV0dXJuIDAKCQkJfTsKCgkJCUJ1ZmZlci5pc0VuY29kaW5nID0gZnVuY3Rpb24gaXNFbmNvZGluZyAoZW5jb2RpbmcpIHsKCQkJICBzd2l0Y2ggKFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKSkgewoJCQkgICAgY2FzZSAnaGV4JzoKCQkJICAgIGNhc2UgJ3V0ZjgnOgoJCQkgICAgY2FzZSAndXRmLTgnOgoJCQkgICAgY2FzZSAnYXNjaWknOgoJCQkgICAgY2FzZSAnbGF0aW4xJzoKCQkJICAgIGNhc2UgJ2JpbmFyeSc6CgkJCSAgICBjYXNlICdiYXNlNjQnOgoJCQkgICAgY2FzZSAndWNzMic6CgkJCSAgICBjYXNlICd1Y3MtMic6CgkJCSAgICBjYXNlICd1dGYxNmxlJzoKCQkJICAgIGNhc2UgJ3V0Zi0xNmxlJzoKCQkJICAgICAgcmV0dXJuIHRydWUKCQkJICAgIGRlZmF1bHQ6CgkJCSAgICAgIHJldHVybiBmYWxzZQoJCQkgIH0KCQkJfTsKCgkJCUJ1ZmZlci5jb25jYXQgPSBmdW5jdGlvbiBjb25jYXQgKGxpc3QsIGxlbmd0aCkgewoJCQkgIGlmICghQXJyYXkuaXNBcnJheShsaXN0KSkgewoJCQkgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpCgkJCSAgfQoKCQkJICBpZiAobGlzdC5sZW5ndGggPT09IDApIHsKCQkJICAgIHJldHVybiBCdWZmZXIuYWxsb2MoMCkKCQkJICB9CgoJCQkgIGxldCBpOwoJCQkgIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewoJCQkgICAgbGVuZ3RoID0gMDsKCQkJICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CgkJCSAgICAgIGxlbmd0aCArPSBsaXN0W2ldLmxlbmd0aDsKCQkJICAgIH0KCQkJICB9CgoJCQkgIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShsZW5ndGgpOwoJCQkgIGxldCBwb3MgPSAwOwoJCQkgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CgkJCSAgICBsZXQgYnVmID0gbGlzdFtpXTsKCQkJICAgIGlmIChpc0luc3RhbmNlKGJ1ZiwgVWludDhBcnJheSkpIHsKCQkJICAgICAgaWYgKHBvcyArIGJ1Zi5sZW5ndGggPiBidWZmZXIubGVuZ3RoKSB7CgkJCSAgICAgICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgYnVmID0gQnVmZmVyLmZyb20oYnVmKTsKCQkJICAgICAgICBidWYuY29weShidWZmZXIsIHBvcyk7CgkJCSAgICAgIH0gZWxzZSB7CgkJCSAgICAgICAgVWludDhBcnJheS5wcm90b3R5cGUuc2V0LmNhbGwoCgkJCSAgICAgICAgICBidWZmZXIsCgkJCSAgICAgICAgICBidWYsCgkJCSAgICAgICAgICBwb3MKCQkJICAgICAgICApOwoJCQkgICAgICB9CgkJCSAgICB9IGVsc2UgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgewoJCQkgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcibGlzdCIgYXJndW1lbnQgbXVzdCBiZSBhbiBBcnJheSBvZiBCdWZmZXJzJykKCQkJICAgIH0gZWxzZSB7CgkJCSAgICAgIGJ1Zi5jb3B5KGJ1ZmZlciwgcG9zKTsKCQkJICAgIH0KCQkJICAgIHBvcyArPSBidWYubGVuZ3RoOwoJCQkgIH0KCQkJICByZXR1cm4gYnVmZmVyCgkJCX07CgoJCQlmdW5jdGlvbiBieXRlTGVuZ3RoIChzdHJpbmcsIGVuY29kaW5nKSB7CgkJCSAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihzdHJpbmcpKSB7CgkJCSAgICByZXR1cm4gc3RyaW5nLmxlbmd0aAoJCQkgIH0KCQkJICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHN0cmluZykgfHwgaXNJbnN0YW5jZShzdHJpbmcsIEFycmF5QnVmZmVyKSkgewoJCQkgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoCgkJCSAgfQoJCQkgIGlmICh0eXBlb2Ygc3RyaW5nICE9PSAnc3RyaW5nJykgewoJCQkgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigKCQkJICAgICAgJ1RoZSAic3RyaW5nIiBhcmd1bWVudCBtdXN0IGJlIG9uZSBvZiB0eXBlIHN0cmluZywgQnVmZmVyLCBvciBBcnJheUJ1ZmZlci4gJyArCgkJCSAgICAgICdSZWNlaXZlZCB0eXBlICcgKyB0eXBlb2Ygc3RyaW5nCgkJCSAgICApCgkJCSAgfQoKCQkJICBjb25zdCBsZW4gPSBzdHJpbmcubGVuZ3RoOwoJCQkgIGNvbnN0IG11c3RNYXRjaCA9IChhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gPT09IHRydWUpOwoJCQkgIGlmICghbXVzdE1hdGNoICYmIGxlbiA9PT0gMCkgcmV0dXJuIDAKCgkJCSAgLy8gVXNlIGEgZm9yIGxvb3AgdG8gYXZvaWQgcmVjdXJzaW9uCgkJCSAgbGV0IGxvd2VyZWRDYXNlID0gZmFsc2U7CgkJCSAgZm9yICg7OykgewoJCQkgICAgc3dpdGNoIChlbmNvZGluZykgewoJCQkgICAgICBjYXNlICdhc2NpaSc6CgkJCSAgICAgIGNhc2UgJ2xhdGluMSc6CgkJCSAgICAgIGNhc2UgJ2JpbmFyeSc6CgkJCSAgICAgICAgcmV0dXJuIGxlbgoJCQkgICAgICBjYXNlICd1dGY4JzoKCQkJICAgICAgY2FzZSAndXRmLTgnOgoJCQkgICAgICAgIHJldHVybiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aAoJCQkgICAgICBjYXNlICd1Y3MyJzoKCQkJICAgICAgY2FzZSAndWNzLTInOgoJCQkgICAgICBjYXNlICd1dGYxNmxlJzoKCQkJICAgICAgY2FzZSAndXRmLTE2bGUnOgoJCQkgICAgICAgIHJldHVybiBsZW4gKiAyCgkJCSAgICAgIGNhc2UgJ2hleCc6CgkJCSAgICAgICAgcmV0dXJuIGxlbiA+Pj4gMQoJCQkgICAgICBjYXNlICdiYXNlNjQnOgoJCQkgICAgICAgIHJldHVybiBiYXNlNjRUb0J5dGVzKHN0cmluZykubGVuZ3RoCgkJCSAgICAgIGRlZmF1bHQ6CgkJCSAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB7CgkJCSAgICAgICAgICByZXR1cm4gbXVzdE1hdGNoID8gLTEgOiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aCAvLyBhc3N1bWUgdXRmOAoJCQkgICAgICAgIH0KCQkJICAgICAgICBlbmNvZGluZyA9ICgnJyArIGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpOwoJCQkgICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZTsKCQkJICAgIH0KCQkJICB9CgkJCX0KCQkJQnVmZmVyLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoOwoKCQkJZnVuY3Rpb24gc2xvd1RvU3RyaW5nIChlbmNvZGluZywgc3RhcnQsIGVuZCkgewoJCQkgIGxldCBsb3dlcmVkQ2FzZSA9IGZhbHNlOwoKCQkJICAvLyBObyBuZWVkIHRvIHZlcmlmeSB0aGF0ICJ0aGlzLmxlbmd0aCA8PSBNQVhfVUlOVDMyIiBzaW5jZSBpdCdzIGEgcmVhZC1vbmx5CgkJCSAgLy8gcHJvcGVydHkgb2YgYSB0eXBlZCBhcnJheS4KCgkJCSAgLy8gVGhpcyBiZWhhdmVzIG5laXRoZXIgbGlrZSBTdHJpbmcgbm9yIFVpbnQ4QXJyYXkgaW4gdGhhdCB3ZSBzZXQgc3RhcnQvZW5kCgkJCSAgLy8gdG8gdGhlaXIgdXBwZXIvbG93ZXIgYm91bmRzIGlmIHRoZSB2YWx1ZSBwYXNzZWQgaXMgb3V0IG9mIHJhbmdlLgoJCQkgIC8vIHVuZGVmaW5lZCBpcyBoYW5kbGVkIHNwZWNpYWxseSBhcyBwZXIgRUNNQS0yNjIgNnRoIEVkaXRpb24sCgkJCSAgLy8gU2VjdGlvbiAxMy4zLjMuNyBSdW50aW1lIFNlbWFudGljczogS2V5ZWRCaW5kaW5nSW5pdGlhbGl6YXRpb24uCgkJCSAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQgfHwgc3RhcnQgPCAwKSB7CgkJCSAgICBzdGFydCA9IDA7CgkJCSAgfQoJCQkgIC8vIFJldHVybiBlYXJseSBpZiBzdGFydCA+IHRoaXMubGVuZ3RoLiBEb25lIGhlcmUgdG8gcHJldmVudCBwb3RlbnRpYWwgdWludDMyCgkJCSAgLy8gY29lcmNpb24gZmFpbCBiZWxvdy4KCQkJICBpZiAoc3RhcnQgPiB0aGlzLmxlbmd0aCkgewoJCQkgICAgcmV0dXJuICcnCgkJCSAgfQoKCQkJICBpZiAoZW5kID09PSB1bmRlZmluZWQgfHwgZW5kID4gdGhpcy5sZW5ndGgpIHsKCQkJICAgIGVuZCA9IHRoaXMubGVuZ3RoOwoJCQkgIH0KCgkJCSAgaWYgKGVuZCA8PSAwKSB7CgkJCSAgICByZXR1cm4gJycKCQkJICB9CgoJCQkgIC8vIEZvcmNlIGNvZXJjaW9uIHRvIHVpbnQzMi4gVGhpcyB3aWxsIGFsc28gY29lcmNlIGZhbHNleS9OYU4gdmFsdWVzIHRvIDAuCgkJCSAgZW5kID4+Pj0gMDsKCQkJICBzdGFydCA+Pj49IDA7CgoJCQkgIGlmIChlbmQgPD0gc3RhcnQpIHsKCQkJICAgIHJldHVybiAnJwoJCQkgIH0KCgkJCSAgaWYgKCFlbmNvZGluZykgZW5jb2RpbmcgPSAndXRmOCc7CgoJCQkgIHdoaWxlICh0cnVlKSB7CgkJCSAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CgkJCSAgICAgIGNhc2UgJ2hleCc6CgkJCSAgICAgICAgcmV0dXJuIGhleFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgoJCQkgICAgICBjYXNlICd1dGY4JzoKCQkJICAgICAgY2FzZSAndXRmLTgnOgoJCQkgICAgICAgIHJldHVybiB1dGY4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCgkJCSAgICAgIGNhc2UgJ2FzY2lpJzoKCQkJICAgICAgICByZXR1cm4gYXNjaWlTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKCQkJICAgICAgY2FzZSAnbGF0aW4xJzoKCQkJICAgICAgY2FzZSAnYmluYXJ5JzoKCQkJICAgICAgICByZXR1cm4gbGF0aW4xU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCgkJCSAgICAgIGNhc2UgJ2Jhc2U2NCc6CgkJCSAgICAgICAgcmV0dXJuIGJhc2U2NFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgoJCQkgICAgICBjYXNlICd1Y3MyJzoKCQkJICAgICAgY2FzZSAndWNzLTInOgoJCQkgICAgICBjYXNlICd1dGYxNmxlJzoKCQkJICAgICAgY2FzZSAndXRmLTE2bGUnOgoJCQkgICAgICAgIHJldHVybiB1dGYxNmxlU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCgkJCSAgICAgIGRlZmF1bHQ6CgkJCSAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCgkJCSAgICAgICAgZW5jb2RpbmcgPSAoZW5jb2RpbmcgKyAnJykudG9Mb3dlckNhc2UoKTsKCQkJICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWU7CgkJCSAgICB9CgkJCSAgfQoJCQl9CgoJCQkvLyBUaGlzIHByb3BlcnR5IGlzIHVzZWQgYnkgYEJ1ZmZlci5pc0J1ZmZlcmAgKGFuZCB0aGUgYGlzLWJ1ZmZlcmAgbnBtIHBhY2thZ2UpCgkJCS8vIHRvIGRldGVjdCBhIEJ1ZmZlciBpbnN0YW5jZS4gSXQncyBub3QgcG9zc2libGUgdG8gdXNlIGBpbnN0YW5jZW9mIEJ1ZmZlcmAKCQkJLy8gcmVsaWFibHkgaW4gYSBicm93c2VyaWZ5IGNvbnRleHQgYmVjYXVzZSB0aGVyZSBjb3VsZCBiZSBtdWx0aXBsZSBkaWZmZXJlbnQKCQkJLy8gY29waWVzIG9mIHRoZSAnYnVmZmVyJyBwYWNrYWdlIGluIHVzZS4gVGhpcyBtZXRob2Qgd29ya3MgZXZlbiBmb3IgQnVmZmVyCgkJCS8vIGluc3RhbmNlcyB0aGF0IHdlcmUgY3JlYXRlZCBmcm9tIGFub3RoZXIgY29weSBvZiB0aGUgYGJ1ZmZlcmAgcGFja2FnZS4KCQkJLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vZmVyb3NzL2J1ZmZlci9pc3N1ZXMvMTU0CgkJCUJ1ZmZlci5wcm90b3R5cGUuX2lzQnVmZmVyID0gdHJ1ZTsKCgkJCWZ1bmN0aW9uIHN3YXAgKGIsIG4sIG0pIHsKCQkJICBjb25zdCBpID0gYltuXTsKCQkJICBiW25dID0gYlttXTsKCQkJICBiW21dID0gaTsKCQkJfQoKCQkJQnVmZmVyLnByb3RvdHlwZS5zd2FwMTYgPSBmdW5jdGlvbiBzd2FwMTYgKCkgewoJCQkgIGNvbnN0IGxlbiA9IHRoaXMubGVuZ3RoOwoJCQkgIGlmIChsZW4gJSAyICE9PSAwKSB7CgkJCSAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMnKQoJCQkgIH0KCQkJICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSArPSAyKSB7CgkJCSAgICBzd2FwKHRoaXMsIGksIGkgKyAxKTsKCQkJICB9CgkJCSAgcmV0dXJuIHRoaXMKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUuc3dhcDMyID0gZnVuY3Rpb24gc3dhcDMyICgpIHsKCQkJICBjb25zdCBsZW4gPSB0aGlzLmxlbmd0aDsKCQkJICBpZiAobGVuICUgNCAhPT0gMCkgewoJCQkgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzMi1iaXRzJykKCQkJICB9CgkJCSAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewoJCQkgICAgc3dhcCh0aGlzLCBpLCBpICsgMyk7CgkJCSAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgMik7CgkJCSAgfQoJCQkgIHJldHVybiB0aGlzCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLnN3YXA2NCA9IGZ1bmN0aW9uIHN3YXA2NCAoKSB7CgkJCSAgY29uc3QgbGVuID0gdGhpcy5sZW5ndGg7CgkJCSAgaWYgKGxlbiAlIDggIT09IDApIHsKCQkJICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNjQtYml0cycpCgkJCSAgfQoJCQkgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpICs9IDgpIHsKCQkJICAgIHN3YXAodGhpcywgaSwgaSArIDcpOwoJCQkgICAgc3dhcCh0aGlzLCBpICsgMSwgaSArIDYpOwoJCQkgICAgc3dhcCh0aGlzLCBpICsgMiwgaSArIDUpOwoJCQkgICAgc3dhcCh0aGlzLCBpICsgMywgaSArIDQpOwoJCQkgIH0KCQkJICByZXR1cm4gdGhpcwoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nICgpIHsKCQkJICBjb25zdCBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCQkJICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4gJycKCQkJICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCAwLCBsZW5ndGgpCgkJCSAgcmV0dXJuIHNsb3dUb1N0cmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLnRvTG9jYWxlU3RyaW5nID0gQnVmZmVyLnByb3RvdHlwZS50b1N0cmluZzsKCgkJCUJ1ZmZlci5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24gZXF1YWxzIChiKSB7CgkJCSAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQoJCQkgIGlmICh0aGlzID09PSBiKSByZXR1cm4gdHJ1ZQoJCQkgIHJldHVybiBCdWZmZXIuY29tcGFyZSh0aGlzLCBiKSA9PT0gMAoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS5pbnNwZWN0ID0gZnVuY3Rpb24gaW5zcGVjdCAoKSB7CgkJCSAgbGV0IHN0ciA9ICcnOwoJCQkgIGNvbnN0IG1heCA9IGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVM7CgkJCSAgc3RyID0gdGhpcy50b1N0cmluZygnaGV4JywgMCwgbWF4KS5yZXBsYWNlKC8oLnsyfSkvZywgJyQxICcpLnRyaW0oKTsKCQkJICBpZiAodGhpcy5sZW5ndGggPiBtYXgpIHN0ciArPSAnIC4uLiAnOwoJCQkgIHJldHVybiAnPEJ1ZmZlciAnICsgc3RyICsgJz4nCgkJCX07CgkJCWlmIChjdXN0b21JbnNwZWN0U3ltYm9sKSB7CgkJCSAgQnVmZmVyLnByb3RvdHlwZVtjdXN0b21JbnNwZWN0U3ltYm9sXSA9IEJ1ZmZlci5wcm90b3R5cGUuaW5zcGVjdDsKCQkJfQoKCQkJQnVmZmVyLnByb3RvdHlwZS5jb21wYXJlID0gZnVuY3Rpb24gY29tcGFyZSAodGFyZ2V0LCBzdGFydCwgZW5kLCB0aGlzU3RhcnQsIHRoaXNFbmQpIHsKCQkJICBpZiAoaXNJbnN0YW5jZSh0YXJnZXQsIFVpbnQ4QXJyYXkpKSB7CgkJCSAgICB0YXJnZXQgPSBCdWZmZXIuZnJvbSh0YXJnZXQsIHRhcmdldC5vZmZzZXQsIHRhcmdldC5ieXRlTGVuZ3RoKTsKCQkJICB9CgkJCSAgaWYgKCFCdWZmZXIuaXNCdWZmZXIodGFyZ2V0KSkgewoJCQkgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigKCQkJICAgICAgJ1RoZSAidGFyZ2V0IiBhcmd1bWVudCBtdXN0IGJlIG9uZSBvZiB0eXBlIEJ1ZmZlciBvciBVaW50OEFycmF5LiAnICsKCQkJICAgICAgJ1JlY2VpdmVkIHR5cGUgJyArICh0eXBlb2YgdGFyZ2V0KQoJCQkgICAgKQoJCQkgIH0KCgkJCSAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQpIHsKCQkJICAgIHN0YXJ0ID0gMDsKCQkJICB9CgkJCSAgaWYgKGVuZCA9PT0gdW5kZWZpbmVkKSB7CgkJCSAgICBlbmQgPSB0YXJnZXQgPyB0YXJnZXQubGVuZ3RoIDogMDsKCQkJICB9CgkJCSAgaWYgKHRoaXNTdGFydCA9PT0gdW5kZWZpbmVkKSB7CgkJCSAgICB0aGlzU3RhcnQgPSAwOwoJCQkgIH0KCQkJICBpZiAodGhpc0VuZCA9PT0gdW5kZWZpbmVkKSB7CgkJCSAgICB0aGlzRW5kID0gdGhpcy5sZW5ndGg7CgkJCSAgfQoKCQkJICBpZiAoc3RhcnQgPCAwIHx8IGVuZCA+IHRhcmdldC5sZW5ndGggfHwgdGhpc1N0YXJ0IDwgMCB8fCB0aGlzRW5kID4gdGhpcy5sZW5ndGgpIHsKCQkJICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdvdXQgb2YgcmFuZ2UgaW5kZXgnKQoJCQkgIH0KCgkJCSAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kICYmIHN0YXJ0ID49IGVuZCkgewoJCQkgICAgcmV0dXJuIDAKCQkJICB9CgkJCSAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kKSB7CgkJCSAgICByZXR1cm4gLTEKCQkJICB9CgkJCSAgaWYgKHN0YXJ0ID49IGVuZCkgewoJCQkgICAgcmV0dXJuIDEKCQkJICB9CgoJCQkgIHN0YXJ0ID4+Pj0gMDsKCQkJICBlbmQgPj4+PSAwOwoJCQkgIHRoaXNTdGFydCA+Pj49IDA7CgkJCSAgdGhpc0VuZCA+Pj49IDA7CgoJCQkgIGlmICh0aGlzID09PSB0YXJnZXQpIHJldHVybiAwCgoJCQkgIGxldCB4ID0gdGhpc0VuZCAtIHRoaXNTdGFydDsKCQkJICBsZXQgeSA9IGVuZCAtIHN0YXJ0OwoJCQkgIGNvbnN0IGxlbiA9IE1hdGgubWluKHgsIHkpOwoKCQkJICBjb25zdCB0aGlzQ29weSA9IHRoaXMuc2xpY2UodGhpc1N0YXJ0LCB0aGlzRW5kKTsKCQkJICBjb25zdCB0YXJnZXRDb3B5ID0gdGFyZ2V0LnNsaWNlKHN0YXJ0LCBlbmQpOwoKCQkJICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgKytpKSB7CgkJCSAgICBpZiAodGhpc0NvcHlbaV0gIT09IHRhcmdldENvcHlbaV0pIHsKCQkJICAgICAgeCA9IHRoaXNDb3B5W2ldOwoJCQkgICAgICB5ID0gdGFyZ2V0Q29weVtpXTsKCQkJICAgICAgYnJlYWsKCQkJICAgIH0KCQkJICB9CgoJCQkgIGlmICh4IDwgeSkgcmV0dXJuIC0xCgkJCSAgaWYgKHkgPCB4KSByZXR1cm4gMQoJCQkgIHJldHVybiAwCgkJCX07CgoJCQkvLyBGaW5kcyBlaXRoZXIgdGhlIGZpcnN0IGluZGV4IG9mIGB2YWxgIGluIGBidWZmZXJgIGF0IG9mZnNldCA+PSBgYnl0ZU9mZnNldGAsCgkJCS8vIE9SIHRoZSBsYXN0IGluZGV4IG9mIGB2YWxgIGluIGBidWZmZXJgIGF0IG9mZnNldCA8PSBgYnl0ZU9mZnNldGAuCgkJCS8vCgkJCS8vIEFyZ3VtZW50czoKCQkJLy8gLSBidWZmZXIgLSBhIEJ1ZmZlciB0byBzZWFyY2gKCQkJLy8gLSB2YWwgLSBhIHN0cmluZywgQnVmZmVyLCBvciBudW1iZXIKCQkJLy8gLSBieXRlT2Zmc2V0IC0gYW4gaW5kZXggaW50byBgYnVmZmVyYDsgd2lsbCBiZSBjbGFtcGVkIHRvIGFuIGludDMyCgkJCS8vIC0gZW5jb2RpbmcgLSBhbiBvcHRpb25hbCBlbmNvZGluZywgcmVsZXZhbnQgaXMgdmFsIGlzIGEgc3RyaW5nCgkJCS8vIC0gZGlyIC0gdHJ1ZSBmb3IgaW5kZXhPZiwgZmFsc2UgZm9yIGxhc3RJbmRleE9mCgkJCWZ1bmN0aW9uIGJpZGlyZWN0aW9uYWxJbmRleE9mIChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikgewoJCQkgIC8vIEVtcHR5IGJ1ZmZlciBtZWFucyBubyBtYXRjaAoJCQkgIGlmIChidWZmZXIubGVuZ3RoID09PSAwKSByZXR1cm4gLTEKCgkJCSAgLy8gTm9ybWFsaXplIGJ5dGVPZmZzZXQKCQkJICBpZiAodHlwZW9mIGJ5dGVPZmZzZXQgPT09ICdzdHJpbmcnKSB7CgkJCSAgICBlbmNvZGluZyA9IGJ5dGVPZmZzZXQ7CgkJCSAgICBieXRlT2Zmc2V0ID0gMDsKCQkJICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPiAweDdmZmZmZmZmKSB7CgkJCSAgICBieXRlT2Zmc2V0ID0gMHg3ZmZmZmZmZjsKCQkJICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPCAtMHg4MDAwMDAwMCkgewoJCQkgICAgYnl0ZU9mZnNldCA9IC0weDgwMDAwMDAwOwoJCQkgIH0KCQkJICBieXRlT2Zmc2V0ID0gK2J5dGVPZmZzZXQ7IC8vIENvZXJjZSB0byBOdW1iZXIuCgkJCSAgaWYgKG51bWJlcklzTmFOKGJ5dGVPZmZzZXQpKSB7CgkJCSAgICAvLyBieXRlT2Zmc2V0OiBpdCBpdCdzIHVuZGVmaW5lZCwgbnVsbCwgTmFOLCAiZm9vIiwgZXRjLCBzZWFyY2ggd2hvbGUgYnVmZmVyCgkJCSAgICBieXRlT2Zmc2V0ID0gZGlyID8gMCA6IChidWZmZXIubGVuZ3RoIC0gMSk7CgkJCSAgfQoKCQkJICAvLyBOb3JtYWxpemUgYnl0ZU9mZnNldDogbmVnYXRpdmUgb2Zmc2V0cyBzdGFydCBmcm9tIHRoZSBlbmQgb2YgdGhlIGJ1ZmZlcgoJCQkgIGlmIChieXRlT2Zmc2V0IDwgMCkgYnl0ZU9mZnNldCA9IGJ1ZmZlci5sZW5ndGggKyBieXRlT2Zmc2V0OwoJCQkgIGlmIChieXRlT2Zmc2V0ID49IGJ1ZmZlci5sZW5ndGgpIHsKCQkJICAgIGlmIChkaXIpIHJldHVybiAtMQoJCQkgICAgZWxzZSBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCAtIDE7CgkJCSAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgMCkgewoJCQkgICAgaWYgKGRpcikgYnl0ZU9mZnNldCA9IDA7CgkJCSAgICBlbHNlIHJldHVybiAtMQoJCQkgIH0KCgkJCSAgLy8gTm9ybWFsaXplIHZhbAoJCQkgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewoJCQkgICAgdmFsID0gQnVmZmVyLmZyb20odmFsLCBlbmNvZGluZyk7CgkJCSAgfQoKCQkJICAvLyBGaW5hbGx5LCBzZWFyY2ggZWl0aGVyIGluZGV4T2YgKGlmIGRpciBpcyB0cnVlKSBvciBsYXN0SW5kZXhPZgoJCQkgIGlmIChCdWZmZXIuaXNCdWZmZXIodmFsKSkgewoJCQkgICAgLy8gU3BlY2lhbCBjYXNlOiBsb29raW5nIGZvciBlbXB0eSBzdHJpbmcvYnVmZmVyIGFsd2F5cyBmYWlscwoJCQkgICAgaWYgKHZhbC5sZW5ndGggPT09IDApIHsKCQkJICAgICAgcmV0dXJuIC0xCgkJCSAgICB9CgkJCSAgICByZXR1cm4gYXJyYXlJbmRleE9mKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKQoJCQkgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKCQkJICAgIHZhbCA9IHZhbCAmIDB4RkY7IC8vIFNlYXJjaCBmb3IgYSBieXRlIHZhbHVlIFswLTI1NV0KCQkJICAgIGlmICh0eXBlb2YgVWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZiA9PT0gJ2Z1bmN0aW9uJykgewoJCQkgICAgICBpZiAoZGlyKSB7CgkJCSAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKCQkJICAgICAgfSBlbHNlIHsKCQkJICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUubGFzdEluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKCQkJICAgICAgfQoJCQkgICAgfQoJCQkgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIFt2YWxdLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKQoJCQkgIH0KCgkJCSAgdGhyb3cgbmV3IFR5cGVFcnJvcigndmFsIG11c3QgYmUgc3RyaW5nLCBudW1iZXIgb3IgQnVmZmVyJykKCQkJfQoKCQkJZnVuY3Rpb24gYXJyYXlJbmRleE9mIChhcnIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikgewoJCQkgIGxldCBpbmRleFNpemUgPSAxOwoJCQkgIGxldCBhcnJMZW5ndGggPSBhcnIubGVuZ3RoOwoJCQkgIGxldCB2YWxMZW5ndGggPSB2YWwubGVuZ3RoOwoKCQkJICBpZiAoZW5jb2RpbmcgIT09IHVuZGVmaW5lZCkgewoJCQkgICAgZW5jb2RpbmcgPSBTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCk7CgkJCSAgICBpZiAoZW5jb2RpbmcgPT09ICd1Y3MyJyB8fCBlbmNvZGluZyA9PT0gJ3Vjcy0yJyB8fAoJCQkgICAgICAgIGVuY29kaW5nID09PSAndXRmMTZsZScgfHwgZW5jb2RpbmcgPT09ICd1dGYtMTZsZScpIHsKCQkJICAgICAgaWYgKGFyci5sZW5ndGggPCAyIHx8IHZhbC5sZW5ndGggPCAyKSB7CgkJCSAgICAgICAgcmV0dXJuIC0xCgkJCSAgICAgIH0KCQkJICAgICAgaW5kZXhTaXplID0gMjsKCQkJICAgICAgYXJyTGVuZ3RoIC89IDI7CgkJCSAgICAgIHZhbExlbmd0aCAvPSAyOwoJCQkgICAgICBieXRlT2Zmc2V0IC89IDI7CgkJCSAgICB9CgkJCSAgfQoKCQkJICBmdW5jdGlvbiByZWFkIChidWYsIGkpIHsKCQkJICAgIGlmIChpbmRleFNpemUgPT09IDEpIHsKCQkJICAgICAgcmV0dXJuIGJ1ZltpXQoJCQkgICAgfSBlbHNlIHsKCQkJICAgICAgcmV0dXJuIGJ1Zi5yZWFkVUludDE2QkUoaSAqIGluZGV4U2l6ZSkKCQkJICAgIH0KCQkJICB9CgoJCQkgIGxldCBpOwoJCQkgIGlmIChkaXIpIHsKCQkJICAgIGxldCBmb3VuZEluZGV4ID0gLTE7CgkJCSAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpIDwgYXJyTGVuZ3RoOyBpKyspIHsKCQkJICAgICAgaWYgKHJlYWQoYXJyLCBpKSA9PT0gcmVhZCh2YWwsIGZvdW5kSW5kZXggPT09IC0xID8gMCA6IGkgLSBmb3VuZEluZGV4KSkgewoJCQkgICAgICAgIGlmIChmb3VuZEluZGV4ID09PSAtMSkgZm91bmRJbmRleCA9IGk7CgkJCSAgICAgICAgaWYgKGkgLSBmb3VuZEluZGV4ICsgMSA9PT0gdmFsTGVuZ3RoKSByZXR1cm4gZm91bmRJbmRleCAqIGluZGV4U2l6ZQoJCQkgICAgICB9IGVsc2UgewoJCQkgICAgICAgIGlmIChmb3VuZEluZGV4ICE9PSAtMSkgaSAtPSBpIC0gZm91bmRJbmRleDsKCQkJICAgICAgICBmb3VuZEluZGV4ID0gLTE7CgkJCSAgICAgIH0KCQkJICAgIH0KCQkJICB9IGVsc2UgewoJCQkgICAgaWYgKGJ5dGVPZmZzZXQgKyB2YWxMZW5ndGggPiBhcnJMZW5ndGgpIGJ5dGVPZmZzZXQgPSBhcnJMZW5ndGggLSB2YWxMZW5ndGg7CgkJCSAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpID49IDA7IGktLSkgewoJCQkgICAgICBsZXQgZm91bmQgPSB0cnVlOwoJCQkgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHZhbExlbmd0aDsgaisrKSB7CgkJCSAgICAgICAgaWYgKHJlYWQoYXJyLCBpICsgaikgIT09IHJlYWQodmFsLCBqKSkgewoJCQkgICAgICAgICAgZm91bmQgPSBmYWxzZTsKCQkJICAgICAgICAgIGJyZWFrCgkJCSAgICAgICAgfQoJCQkgICAgICB9CgkJCSAgICAgIGlmIChmb3VuZCkgcmV0dXJuIGkKCQkJICAgIH0KCQkJICB9CgoJCQkgIHJldHVybiAtMQoJCQl9CgoJCQlCdWZmZXIucHJvdG90eXBlLmluY2x1ZGVzID0gZnVuY3Rpb24gaW5jbHVkZXMgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKCQkJICByZXR1cm4gdGhpcy5pbmRleE9mKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpICE9PSAtMQoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24gaW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewoJCQkgIHJldHVybiBiaWRpcmVjdGlvbmFsSW5kZXhPZih0aGlzLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCB0cnVlKQoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uIGxhc3RJbmRleE9mICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CgkJCSAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGZhbHNlKQoJCQl9OwoKCQkJZnVuY3Rpb24gaGV4V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewoJCQkgIG9mZnNldCA9IE51bWJlcihvZmZzZXQpIHx8IDA7CgkJCSAgY29uc3QgcmVtYWluaW5nID0gYnVmLmxlbmd0aCAtIG9mZnNldDsKCQkJICBpZiAoIWxlbmd0aCkgewoJCQkgICAgbGVuZ3RoID0gcmVtYWluaW5nOwoJCQkgIH0gZWxzZSB7CgkJCSAgICBsZW5ndGggPSBOdW1iZXIobGVuZ3RoKTsKCQkJICAgIGlmIChsZW5ndGggPiByZW1haW5pbmcpIHsKCQkJICAgICAgbGVuZ3RoID0gcmVtYWluaW5nOwoJCQkgICAgfQoJCQkgIH0KCgkJCSAgY29uc3Qgc3RyTGVuID0gc3RyaW5nLmxlbmd0aDsKCgkJCSAgaWYgKGxlbmd0aCA+IHN0ckxlbiAvIDIpIHsKCQkJICAgIGxlbmd0aCA9IHN0ckxlbiAvIDI7CgkJCSAgfQoJCQkgIGxldCBpOwoJCQkgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewoJCQkgICAgY29uc3QgcGFyc2VkID0gcGFyc2VJbnQoc3RyaW5nLnN1YnN0cihpICogMiwgMiksIDE2KTsKCQkJICAgIGlmIChudW1iZXJJc05hTihwYXJzZWQpKSByZXR1cm4gaQoJCQkgICAgYnVmW29mZnNldCArIGldID0gcGFyc2VkOwoJCQkgIH0KCQkJICByZXR1cm4gaQoJCQl9CgoJCQlmdW5jdGlvbiB1dGY4V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewoJCQkgIHJldHVybiBibGl0QnVmZmVyKHV0ZjhUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCgkJCX0KCgkJCWZ1bmN0aW9uIGFzY2lpV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewoJCQkgIHJldHVybiBibGl0QnVmZmVyKGFzY2lpVG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQoJCQl9CgoJCQlmdW5jdGlvbiBiYXNlNjRXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CgkJCSAgcmV0dXJuIGJsaXRCdWZmZXIoYmFzZTY0VG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQoJCQl9CgoJCQlmdW5jdGlvbiB1Y3MyV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewoJCQkgIHJldHVybiBibGl0QnVmZmVyKHV0ZjE2bGVUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCgkJCX0KCgkJCUJ1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiB3cml0ZSAoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpIHsKCQkJICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nKQoJCQkgIGlmIChvZmZzZXQgPT09IHVuZGVmaW5lZCkgewoJCQkgICAgZW5jb2RpbmcgPSAndXRmOCc7CgkJCSAgICBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCQkJICAgIG9mZnNldCA9IDA7CgkJCSAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgZW5jb2RpbmcpCgkJCSAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2Zmc2V0ID09PSAnc3RyaW5nJykgewoJCQkgICAgZW5jb2RpbmcgPSBvZmZzZXQ7CgkJCSAgICBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCQkJICAgIG9mZnNldCA9IDA7CgkJCSAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgb2Zmc2V0WywgbGVuZ3RoXVssIGVuY29kaW5nXSkKCQkJICB9IGVsc2UgaWYgKGlzRmluaXRlKG9mZnNldCkpIHsKCQkJICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICAgIGlmIChpc0Zpbml0ZShsZW5ndGgpKSB7CgkJCSAgICAgIGxlbmd0aCA9IGxlbmd0aCA+Pj4gMDsKCQkJICAgICAgaWYgKGVuY29kaW5nID09PSB1bmRlZmluZWQpIGVuY29kaW5nID0gJ3V0ZjgnOwoJCQkgICAgfSBlbHNlIHsKCQkJICAgICAgZW5jb2RpbmcgPSBsZW5ndGg7CgkJCSAgICAgIGxlbmd0aCA9IHVuZGVmaW5lZDsKCQkJICAgIH0KCQkJICB9IGVsc2UgewoJCQkgICAgdGhyb3cgbmV3IEVycm9yKAoJCQkgICAgICAnQnVmZmVyLndyaXRlKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldFssIGxlbmd0aF0pIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQnCgkJCSAgICApCgkJCSAgfQoKCQkJICBjb25zdCByZW1haW5pbmcgPSB0aGlzLmxlbmd0aCAtIG9mZnNldDsKCQkJICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgfHwgbGVuZ3RoID4gcmVtYWluaW5nKSBsZW5ndGggPSByZW1haW5pbmc7CgoJCQkgIGlmICgoc3RyaW5nLmxlbmd0aCA+IDAgJiYgKGxlbmd0aCA8IDAgfHwgb2Zmc2V0IDwgMCkpIHx8IG9mZnNldCA+IHRoaXMubGVuZ3RoKSB7CgkJCSAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMnKQoJCQkgIH0KCgkJCSAgaWYgKCFlbmNvZGluZykgZW5jb2RpbmcgPSAndXRmOCc7CgoJCQkgIGxldCBsb3dlcmVkQ2FzZSA9IGZhbHNlOwoJCQkgIGZvciAoOzspIHsKCQkJICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKCQkJICAgICAgY2FzZSAnaGV4JzoKCQkJICAgICAgICByZXR1cm4gaGV4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKCgkJCSAgICAgIGNhc2UgJ3V0ZjgnOgoJCQkgICAgICBjYXNlICd1dGYtOCc6CgkJCSAgICAgICAgcmV0dXJuIHV0ZjhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQoKCQkJICAgICAgY2FzZSAnYXNjaWknOgoJCQkgICAgICBjYXNlICdsYXRpbjEnOgoJCQkgICAgICBjYXNlICdiaW5hcnknOgoJCQkgICAgICAgIHJldHVybiBhc2NpaVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCgoJCQkgICAgICBjYXNlICdiYXNlNjQnOgoJCQkgICAgICAgIC8vIFdhcm5pbmc6IG1heExlbmd0aCBub3QgdGFrZW4gaW50byBhY2NvdW50IGluIGJhc2U2NFdyaXRlCgkJCSAgICAgICAgcmV0dXJuIGJhc2U2NFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCgoJCQkgICAgICBjYXNlICd1Y3MyJzoKCQkJICAgICAgY2FzZSAndWNzLTInOgoJCQkgICAgICBjYXNlICd1dGYxNmxlJzoKCQkJICAgICAgY2FzZSAndXRmLTE2bGUnOgoJCQkgICAgICAgIHJldHVybiB1Y3MyV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKCgkJCSAgICAgIGRlZmF1bHQ6CgkJCSAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCgkJCSAgICAgICAgZW5jb2RpbmcgPSAoJycgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKTsKCQkJICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWU7CgkJCSAgICB9CgkJCSAgfQoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04gKCkgewoJCQkgIHJldHVybiB7CgkJCSAgICB0eXBlOiAnQnVmZmVyJywKCQkJICAgIGRhdGE6IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMuX2FyciB8fCB0aGlzLCAwKQoJCQkgIH0KCQkJfTsKCgkJCWZ1bmN0aW9uIGJhc2U2NFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKCQkJICBpZiAoc3RhcnQgPT09IDAgJiYgZW5kID09PSBidWYubGVuZ3RoKSB7CgkJCSAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmKQoJCQkgIH0gZWxzZSB7CgkJCSAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmLnNsaWNlKHN0YXJ0LCBlbmQpKQoJCQkgIH0KCQkJfQoKCQkJZnVuY3Rpb24gdXRmOFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKCQkJICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpOwoJCQkgIGNvbnN0IHJlcyA9IFtdOwoKCQkJICBsZXQgaSA9IHN0YXJ0OwoJCQkgIHdoaWxlIChpIDwgZW5kKSB7CgkJCSAgICBjb25zdCBmaXJzdEJ5dGUgPSBidWZbaV07CgkJCSAgICBsZXQgY29kZVBvaW50ID0gbnVsbDsKCQkJICAgIGxldCBieXRlc1BlclNlcXVlbmNlID0gKGZpcnN0Qnl0ZSA+IDB4RUYpCgkJCSAgICAgID8gNAoJCQkgICAgICA6IChmaXJzdEJ5dGUgPiAweERGKQoJCQkgICAgICAgICAgPyAzCgkJCSAgICAgICAgICA6IChmaXJzdEJ5dGUgPiAweEJGKQoJCQkgICAgICAgICAgICAgID8gMgoJCQkgICAgICAgICAgICAgIDogMTsKCgkJCSAgICBpZiAoaSArIGJ5dGVzUGVyU2VxdWVuY2UgPD0gZW5kKSB7CgkJCSAgICAgIGxldCBzZWNvbmRCeXRlLCB0aGlyZEJ5dGUsIGZvdXJ0aEJ5dGUsIHRlbXBDb2RlUG9pbnQ7CgoJCQkgICAgICBzd2l0Y2ggKGJ5dGVzUGVyU2VxdWVuY2UpIHsKCQkJICAgICAgICBjYXNlIDE6CgkJCSAgICAgICAgICBpZiAoZmlyc3RCeXRlIDwgMHg4MCkgewoJCQkgICAgICAgICAgICBjb2RlUG9pbnQgPSBmaXJzdEJ5dGU7CgkJCSAgICAgICAgICB9CgkJCSAgICAgICAgICBicmVhawoJCQkgICAgICAgIGNhc2UgMjoKCQkJICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdOwoJCQkgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKCQkJICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweDFGKSA8PCAweDYgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpOwoJCQkgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0YpIHsKCQkJICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50OwoJCQkgICAgICAgICAgICB9CgkJCSAgICAgICAgICB9CgkJCSAgICAgICAgICBicmVhawoJCQkgICAgICAgIGNhc2UgMzoKCQkJICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdOwoJCQkgICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXTsKCQkJICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwICYmICh0aGlyZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewoJCQkgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHhDIHwgKHNlY29uZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAodGhpcmRCeXRlICYgMHgzRik7CgkJCSAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHg3RkYgJiYgKHRlbXBDb2RlUG9pbnQgPCAweEQ4MDAgfHwgdGVtcENvZGVQb2ludCA+IDB4REZGRikpIHsKCQkJICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50OwoJCQkgICAgICAgICAgICB9CgkJCSAgICAgICAgICB9CgkJCSAgICAgICAgICBicmVhawoJCQkgICAgICAgIGNhc2UgNDoKCQkJICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdOwoJCQkgICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXTsKCQkJICAgICAgICAgIGZvdXJ0aEJ5dGUgPSBidWZbaSArIDNdOwoJCQkgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKHRoaXJkQnl0ZSAmIDB4QzApID09PSAweDgwICYmIChmb3VydGhCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKCQkJICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweEYpIDw8IDB4MTIgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpIDw8IDB4QyB8ICh0aGlyZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAoZm91cnRoQnl0ZSAmIDB4M0YpOwoJCQkgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4RkZGRiAmJiB0ZW1wQ29kZVBvaW50IDwgMHgxMTAwMDApIHsKCQkJICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50OwoJCQkgICAgICAgICAgICB9CgkJCSAgICAgICAgICB9CgkJCSAgICAgIH0KCQkJICAgIH0KCgkJCSAgICBpZiAoY29kZVBvaW50ID09PSBudWxsKSB7CgkJCSAgICAgIC8vIHdlIGRpZCBub3QgZ2VuZXJhdGUgYSB2YWxpZCBjb2RlUG9pbnQgc28gaW5zZXJ0IGEKCQkJICAgICAgLy8gcmVwbGFjZW1lbnQgY2hhciAoVStGRkZEKSBhbmQgYWR2YW5jZSBvbmx5IDEgYnl0ZQoJCQkgICAgICBjb2RlUG9pbnQgPSAweEZGRkQ7CgkJCSAgICAgIGJ5dGVzUGVyU2VxdWVuY2UgPSAxOwoJCQkgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPiAweEZGRkYpIHsKCQkJICAgICAgLy8gZW5jb2RlIHRvIHV0ZjE2IChzdXJyb2dhdGUgcGFpciBkYW5jZSkKCQkJICAgICAgY29kZVBvaW50IC09IDB4MTAwMDA7CgkJCSAgICAgIHJlcy5wdXNoKGNvZGVQb2ludCA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCk7CgkJCSAgICAgIGNvZGVQb2ludCA9IDB4REMwMCB8IGNvZGVQb2ludCAmIDB4M0ZGOwoJCQkgICAgfQoKCQkJICAgIHJlcy5wdXNoKGNvZGVQb2ludCk7CgkJCSAgICBpICs9IGJ5dGVzUGVyU2VxdWVuY2U7CgkJCSAgfQoKCQkJICByZXR1cm4gZGVjb2RlQ29kZVBvaW50c0FycmF5KHJlcykKCQkJfQoKCQkJLy8gQmFzZWQgb24gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMjI3NDcyNzIvNjgwNzQyLCB0aGUgYnJvd3NlciB3aXRoCgkJCS8vIHRoZSBsb3dlc3QgbGltaXQgaXMgQ2hyb21lLCB3aXRoIDB4MTAwMDAgYXJncy4KCQkJLy8gV2UgZ28gMSBtYWduaXR1ZGUgbGVzcywgZm9yIHNhZmV0eQoJCQljb25zdCBNQVhfQVJHVU1FTlRTX0xFTkdUSCA9IDB4MTAwMDsKCgkJCWZ1bmN0aW9uIGRlY29kZUNvZGVQb2ludHNBcnJheSAoY29kZVBvaW50cykgewoJCQkgIGNvbnN0IGxlbiA9IGNvZGVQb2ludHMubGVuZ3RoOwoJCQkgIGlmIChsZW4gPD0gTUFYX0FSR1VNRU5UU19MRU5HVEgpIHsKCQkJICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY29kZVBvaW50cykgLy8gYXZvaWQgZXh0cmEgc2xpY2UoKQoJCQkgIH0KCgkJCSAgLy8gRGVjb2RlIGluIGNodW5rcyB0byBhdm9pZCAiY2FsbCBzdGFjayBzaXplIGV4Y2VlZGVkIi4KCQkJICBsZXQgcmVzID0gJyc7CgkJCSAgbGV0IGkgPSAwOwoJCQkgIHdoaWxlIChpIDwgbGVuKSB7CgkJCSAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseSgKCQkJICAgICAgU3RyaW5nLAoJCQkgICAgICBjb2RlUG9pbnRzLnNsaWNlKGksIGkgKz0gTUFYX0FSR1VNRU5UU19MRU5HVEgpCgkJCSAgICApOwoJCQkgIH0KCQkJICByZXR1cm4gcmVzCgkJCX0KCgkJCWZ1bmN0aW9uIGFzY2lpU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewoJCQkgIGxldCByZXQgPSAnJzsKCQkJICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpOwoKCQkJICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewoJCQkgICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldICYgMHg3Rik7CgkJCSAgfQoJCQkgIHJldHVybiByZXQKCQkJfQoKCQkJZnVuY3Rpb24gbGF0aW4xU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewoJCQkgIGxldCByZXQgPSAnJzsKCQkJICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpOwoKCQkJICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewoJCQkgICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldKTsKCQkJICB9CgkJCSAgcmV0dXJuIHJldAoJCQl9CgoJCQlmdW5jdGlvbiBoZXhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CgkJCSAgY29uc3QgbGVuID0gYnVmLmxlbmd0aDsKCgkJCSAgaWYgKCFzdGFydCB8fCBzdGFydCA8IDApIHN0YXJ0ID0gMDsKCQkJICBpZiAoIWVuZCB8fCBlbmQgPCAwIHx8IGVuZCA+IGxlbikgZW5kID0gbGVuOwoKCQkJICBsZXQgb3V0ID0gJyc7CgkJCSAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKCQkJICAgIG91dCArPSBoZXhTbGljZUxvb2t1cFRhYmxlW2J1ZltpXV07CgkJCSAgfQoJCQkgIHJldHVybiBvdXQKCQkJfQoKCQkJZnVuY3Rpb24gdXRmMTZsZVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKCQkJICBjb25zdCBieXRlcyA9IGJ1Zi5zbGljZShzdGFydCwgZW5kKTsKCQkJICBsZXQgcmVzID0gJyc7CgkJCSAgLy8gSWYgYnl0ZXMubGVuZ3RoIGlzIG9kZCwgdGhlIGxhc3QgOCBiaXRzIG11c3QgYmUgaWdub3JlZCAoc2FtZSBhcyBub2RlLmpzKQoJCQkgIGZvciAobGV0IGkgPSAwOyBpIDwgYnl0ZXMubGVuZ3RoIC0gMTsgaSArPSAyKSB7CgkJCSAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlc1tpXSArIChieXRlc1tpICsgMV0gKiAyNTYpKTsKCQkJICB9CgkJCSAgcmV0dXJuIHJlcwoJCQl9CgoJCQlCdWZmZXIucHJvdG90eXBlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2UgKHN0YXJ0LCBlbmQpIHsKCQkJICBjb25zdCBsZW4gPSB0aGlzLmxlbmd0aDsKCQkJICBzdGFydCA9IH5+c3RhcnQ7CgkJCSAgZW5kID0gZW5kID09PSB1bmRlZmluZWQgPyBsZW4gOiB+fmVuZDsKCgkJCSAgaWYgKHN0YXJ0IDwgMCkgewoJCQkgICAgc3RhcnQgKz0gbGVuOwoJCQkgICAgaWYgKHN0YXJ0IDwgMCkgc3RhcnQgPSAwOwoJCQkgIH0gZWxzZSBpZiAoc3RhcnQgPiBsZW4pIHsKCQkJICAgIHN0YXJ0ID0gbGVuOwoJCQkgIH0KCgkJCSAgaWYgKGVuZCA8IDApIHsKCQkJICAgIGVuZCArPSBsZW47CgkJCSAgICBpZiAoZW5kIDwgMCkgZW5kID0gMDsKCQkJICB9IGVsc2UgaWYgKGVuZCA+IGxlbikgewoJCQkgICAgZW5kID0gbGVuOwoJCQkgIH0KCgkJCSAgaWYgKGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydDsKCgkJCSAgY29uc3QgbmV3QnVmID0gdGhpcy5zdWJhcnJheShzdGFydCwgZW5kKTsKCQkJICAvLyBSZXR1cm4gYW4gYXVnbWVudGVkIGBVaW50OEFycmF5YCBpbnN0YW5jZQoJCQkgIE9iamVjdC5zZXRQcm90b3R5cGVPZihuZXdCdWYsIEJ1ZmZlci5wcm90b3R5cGUpOwoKCQkJICByZXR1cm4gbmV3QnVmCgkJCX07CgoJCQkvKgoJCQkgKiBOZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IGJ1ZmZlciBpc24ndCB0cnlpbmcgdG8gd3JpdGUgb3V0IG9mIGJvdW5kcy4KCQkJICovCgkJCWZ1bmN0aW9uIGNoZWNrT2Zmc2V0IChvZmZzZXQsIGV4dCwgbGVuZ3RoKSB7CgkJCSAgaWYgKChvZmZzZXQgJSAxKSAhPT0gMCB8fCBvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0IGlzIG5vdCB1aW50JykKCQkJICBpZiAob2Zmc2V0ICsgZXh0ID4gbGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignVHJ5aW5nIHRvIGFjY2VzcyBiZXlvbmQgYnVmZmVyIGxlbmd0aCcpCgkJCX0KCgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZFVpbnRMRSA9CgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnRMRSA9IGZ1bmN0aW9uIHJlYWRVSW50TEUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCk7CgoJCQkgIGxldCB2YWwgPSB0aGlzW29mZnNldF07CgkJCSAgbGV0IG11bCA9IDE7CgkJCSAgbGV0IGkgPSAwOwoJCQkgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CgkJCSAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bDsKCQkJICB9CgoJCQkgIHJldHVybiB2YWwKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZFVpbnRCRSA9CgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnRCRSA9IGZ1bmN0aW9uIHJlYWRVSW50QkUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgewoJCQkgICAgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCk7CgkJCSAgfQoKCQkJICBsZXQgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWJ5dGVMZW5ndGhdOwoJCQkgIGxldCBtdWwgPSAxOwoJCQkgIHdoaWxlIChieXRlTGVuZ3RoID4gMCAmJiAobXVsICo9IDB4MTAwKSkgewoJCQkgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgLS1ieXRlTGVuZ3RoXSAqIG11bDsKCQkJICB9CgoJCQkgIHJldHVybiB2YWwKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZFVpbnQ4ID0KCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDggPSBmdW5jdGlvbiByZWFkVUludDggKG9mZnNldCwgbm9Bc3NlcnQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAxLCB0aGlzLmxlbmd0aCk7CgkJCSAgcmV0dXJuIHRoaXNbb2Zmc2V0XQoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkVWludDE2TEUgPQoJCQlCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZMRSA9IGZ1bmN0aW9uIHJlYWRVSW50MTZMRSAob2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKTsKCQkJICByZXR1cm4gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZFVpbnQxNkJFID0KCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDE2QkUgPSBmdW5jdGlvbiByZWFkVUludDE2QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCk7CgkJCSAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgOCkgfCB0aGlzW29mZnNldCArIDFdCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLnJlYWRVaW50MzJMRSA9CgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkxFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpOwoKCQkJICByZXR1cm4gKCh0aGlzW29mZnNldF0pIHwKCQkJICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAoJCQkgICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikpICsKCQkJICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gKiAweDEwMDAwMDApCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLnJlYWRVaW50MzJCRSA9CgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkJFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpOwoKCQkJICByZXR1cm4gKHRoaXNbb2Zmc2V0XSAqIDB4MTAwMDAwMCkgKwoJCQkgICAgKCh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CgkJCSAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CgkJCSAgICB0aGlzW29mZnNldCArIDNdKQoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkQmlnVUludDY0TEUgPSBkZWZpbmVCaWdJbnRNZXRob2QoZnVuY3Rpb24gcmVhZEJpZ1VJbnQ2NExFIChvZmZzZXQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgdmFsaWRhdGVOdW1iZXIob2Zmc2V0LCAnb2Zmc2V0Jyk7CgkJCSAgY29uc3QgZmlyc3QgPSB0aGlzW29mZnNldF07CgkJCSAgY29uc3QgbGFzdCA9IHRoaXNbb2Zmc2V0ICsgN107CgkJCSAgaWYgKGZpcnN0ID09PSB1bmRlZmluZWQgfHwgbGFzdCA9PT0gdW5kZWZpbmVkKSB7CgkJCSAgICBib3VuZHNFcnJvcihvZmZzZXQsIHRoaXMubGVuZ3RoIC0gOCk7CgkJCSAgfQoKCQkJICBjb25zdCBsbyA9IGZpcnN0ICsKCQkJICAgIHRoaXNbKytvZmZzZXRdICogMiAqKiA4ICsKCQkJICAgIHRoaXNbKytvZmZzZXRdICogMiAqKiAxNiArCgkJCSAgICB0aGlzWysrb2Zmc2V0XSAqIDIgKiogMjQ7CgoJCQkgIGNvbnN0IGhpID0gdGhpc1srK29mZnNldF0gKwoJCQkgICAgdGhpc1srK29mZnNldF0gKiAyICoqIDggKwoJCQkgICAgdGhpc1srK29mZnNldF0gKiAyICoqIDE2ICsKCQkJICAgIGxhc3QgKiAyICoqIDI0OwoKCQkJICByZXR1cm4gQmlnSW50KGxvKSArIChCaWdJbnQoaGkpIDw8IEJpZ0ludCgzMikpCgkJCX0pOwoKCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkQmlnVUludDY0QkUgPSBkZWZpbmVCaWdJbnRNZXRob2QoZnVuY3Rpb24gcmVhZEJpZ1VJbnQ2NEJFIChvZmZzZXQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgdmFsaWRhdGVOdW1iZXIob2Zmc2V0LCAnb2Zmc2V0Jyk7CgkJCSAgY29uc3QgZmlyc3QgPSB0aGlzW29mZnNldF07CgkJCSAgY29uc3QgbGFzdCA9IHRoaXNbb2Zmc2V0ICsgN107CgkJCSAgaWYgKGZpcnN0ID09PSB1bmRlZmluZWQgfHwgbGFzdCA9PT0gdW5kZWZpbmVkKSB7CgkJCSAgICBib3VuZHNFcnJvcihvZmZzZXQsIHRoaXMubGVuZ3RoIC0gOCk7CgkJCSAgfQoKCQkJICBjb25zdCBoaSA9IGZpcnN0ICogMiAqKiAyNCArCgkJCSAgICB0aGlzWysrb2Zmc2V0XSAqIDIgKiogMTYgKwoJCQkgICAgdGhpc1srK29mZnNldF0gKiAyICoqIDggKwoJCQkgICAgdGhpc1srK29mZnNldF07CgoJCQkgIGNvbnN0IGxvID0gdGhpc1srK29mZnNldF0gKiAyICoqIDI0ICsKCQkJICAgIHRoaXNbKytvZmZzZXRdICogMiAqKiAxNiArCgkJCSAgICB0aGlzWysrb2Zmc2V0XSAqIDIgKiogOCArCgkJCSAgICBsYXN0OwoKCQkJICByZXR1cm4gKEJpZ0ludChoaSkgPDwgQmlnSW50KDMyKSkgKyBCaWdJbnQobG8pCgkJCX0pOwoKCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50TEUgPSBmdW5jdGlvbiByZWFkSW50TEUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCk7CgoJCQkgIGxldCB2YWwgPSB0aGlzW29mZnNldF07CgkJCSAgbGV0IG11bCA9IDE7CgkJCSAgbGV0IGkgPSAwOwoJCQkgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CgkJCSAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bDsKCQkJICB9CgkJCSAgbXVsICo9IDB4ODA7CgoJCQkgIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpOwoKCQkJICByZXR1cm4gdmFsCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLnJlYWRJbnRCRSA9IGZ1bmN0aW9uIHJlYWRJbnRCRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKTsKCgkJCSAgbGV0IGkgPSBieXRlTGVuZ3RoOwoJCQkgIGxldCBtdWwgPSAxOwoJCQkgIGxldCB2YWwgPSB0aGlzW29mZnNldCArIC0taV07CgkJCSAgd2hpbGUgKGkgPiAwICYmIChtdWwgKj0gMHgxMDApKSB7CgkJCSAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyAtLWldICogbXVsOwoJCQkgIH0KCQkJICBtdWwgKj0gMHg4MDsKCgkJCSAgaWYgKHZhbCA+PSBtdWwpIHZhbCAtPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCk7CgoJCQkgIHJldHVybiB2YWwKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZEludDggPSBmdW5jdGlvbiByZWFkSW50OCAob2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDEsIHRoaXMubGVuZ3RoKTsKCQkJICBpZiAoISh0aGlzW29mZnNldF0gJiAweDgwKSkgcmV0dXJuICh0aGlzW29mZnNldF0pCgkJCSAgcmV0dXJuICgoMHhmZiAtIHRoaXNbb2Zmc2V0XSArIDEpICogLTEpCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkxFID0gZnVuY3Rpb24gcmVhZEludDE2TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCk7CgkJCSAgY29uc3QgdmFsID0gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCk7CgkJCSAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZCRSA9IGZ1bmN0aW9uIHJlYWRJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpOwoJCQkgIGNvbnN0IHZhbCA9IHRoaXNbb2Zmc2V0ICsgMV0gfCAodGhpc1tvZmZzZXRdIDw8IDgpOwoJCQkgIHJldHVybiAodmFsICYgMHg4MDAwKSA/IHZhbCB8IDB4RkZGRjAwMDAgOiB2YWwKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyTEUgPSBmdW5jdGlvbiByZWFkSW50MzJMRSAob2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKTsKCgkJCSAgcmV0dXJuICh0aGlzW29mZnNldF0pIHwKCQkJICAgICh0aGlzW29mZnNldCArIDFdIDw8IDgpIHwKCQkJICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSB8CgkJCSAgICAodGhpc1tvZmZzZXQgKyAzXSA8PCAyNCkKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyQkUgPSBmdW5jdGlvbiByZWFkSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKTsKCgkJCSAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgMjQpIHwKCQkJICAgICh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CgkJCSAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CgkJCSAgICAodGhpc1tvZmZzZXQgKyAzXSkKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUucmVhZEJpZ0ludDY0TEUgPSBkZWZpbmVCaWdJbnRNZXRob2QoZnVuY3Rpb24gcmVhZEJpZ0ludDY0TEUgKG9mZnNldCkgewoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICB2YWxpZGF0ZU51bWJlcihvZmZzZXQsICdvZmZzZXQnKTsKCQkJICBjb25zdCBmaXJzdCA9IHRoaXNbb2Zmc2V0XTsKCQkJICBjb25zdCBsYXN0ID0gdGhpc1tvZmZzZXQgKyA3XTsKCQkJICBpZiAoZmlyc3QgPT09IHVuZGVmaW5lZCB8fCBsYXN0ID09PSB1bmRlZmluZWQpIHsKCQkJICAgIGJvdW5kc0Vycm9yKG9mZnNldCwgdGhpcy5sZW5ndGggLSA4KTsKCQkJICB9CgoJCQkgIGNvbnN0IHZhbCA9IHRoaXNbb2Zmc2V0ICsgNF0gKwoJCQkgICAgdGhpc1tvZmZzZXQgKyA1XSAqIDIgKiogOCArCgkJCSAgICB0aGlzW29mZnNldCArIDZdICogMiAqKiAxNiArCgkJCSAgICAobGFzdCA8PCAyNCk7IC8vIE92ZXJmbG93CgoJCQkgIHJldHVybiAoQmlnSW50KHZhbCkgPDwgQmlnSW50KDMyKSkgKwoJCQkgICAgQmlnSW50KGZpcnN0ICsKCQkJICAgIHRoaXNbKytvZmZzZXRdICogMiAqKiA4ICsKCQkJICAgIHRoaXNbKytvZmZzZXRdICogMiAqKiAxNiArCgkJCSAgICB0aGlzWysrb2Zmc2V0XSAqIDIgKiogMjQpCgkJCX0pOwoKCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkQmlnSW50NjRCRSA9IGRlZmluZUJpZ0ludE1ldGhvZChmdW5jdGlvbiByZWFkQmlnSW50NjRCRSAob2Zmc2V0KSB7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIHZhbGlkYXRlTnVtYmVyKG9mZnNldCwgJ29mZnNldCcpOwoJCQkgIGNvbnN0IGZpcnN0ID0gdGhpc1tvZmZzZXRdOwoJCQkgIGNvbnN0IGxhc3QgPSB0aGlzW29mZnNldCArIDddOwoJCQkgIGlmIChmaXJzdCA9PT0gdW5kZWZpbmVkIHx8IGxhc3QgPT09IHVuZGVmaW5lZCkgewoJCQkgICAgYm91bmRzRXJyb3Iob2Zmc2V0LCB0aGlzLmxlbmd0aCAtIDgpOwoJCQkgIH0KCgkJCSAgY29uc3QgdmFsID0gKGZpcnN0IDw8IDI0KSArIC8vIE92ZXJmbG93CgkJCSAgICB0aGlzWysrb2Zmc2V0XSAqIDIgKiogMTYgKwoJCQkgICAgdGhpc1srK29mZnNldF0gKiAyICoqIDggKwoJCQkgICAgdGhpc1srK29mZnNldF07CgoJCQkgIHJldHVybiAoQmlnSW50KHZhbCkgPDwgQmlnSW50KDMyKSkgKwoJCQkgICAgQmlnSW50KHRoaXNbKytvZmZzZXRdICogMiAqKiAyNCArCgkJCSAgICB0aGlzWysrb2Zmc2V0XSAqIDIgKiogMTYgKwoJCQkgICAgdGhpc1srK29mZnNldF0gKiAyICoqIDggKwoJCQkgICAgbGFzdCkKCQkJfSk7CgoJCQlCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdExFID0gZnVuY3Rpb24gcmVhZEZsb2F0TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCk7CgkJCSAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDIzLCA0KQoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRCRSA9IGZ1bmN0aW9uIHJlYWRGbG9hdEJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpOwoJCQkgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgMjMsIDQpCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVMRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVMRSAob2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKTsKCQkJICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgNTIsIDgpCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVCRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVCRSAob2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKTsKCQkJICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDUyLCA4KQoJCQl9OwoKCQkJZnVuY3Rpb24gY2hlY2tJbnQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewoJCQkgIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHRocm93IG5ldyBUeXBlRXJyb3IoJyJidWZmZXIiIGFyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXIgaW5zdGFuY2UnKQoJCQkgIGlmICh2YWx1ZSA+IG1heCB8fCB2YWx1ZSA8IG1pbikgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJ2YWx1ZSIgYXJndW1lbnQgaXMgb3V0IG9mIGJvdW5kcycpCgkJCSAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQoJCQl9CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVWludExFID0KCQkJQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlVUludExFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewoJCQkgIHZhbHVlID0gK3ZhbHVlOwoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSB7CgkJCSAgICBjb25zdCBtYXhCeXRlcyA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKSAtIDE7CgkJCSAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBtYXhCeXRlcywgMCk7CgkJCSAgfQoKCQkJICBsZXQgbXVsID0gMTsKCQkJICBsZXQgaSA9IDA7CgkJCSAgdGhpc1tvZmZzZXRdID0gdmFsdWUgJiAweEZGOwoJCQkgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CgkJCSAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsKSAmIDB4RkY7CgkJCSAgfQoKCQkJICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS53cml0ZVVpbnRCRSA9CgkJCUJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50QkUgPSBmdW5jdGlvbiB3cml0ZVVJbnRCRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKCQkJICB2YWx1ZSA9ICt2YWx1ZTsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgewoJCQkgICAgY29uc3QgbWF4Qnl0ZXMgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkgLSAxOwoJCQkgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbWF4Qnl0ZXMsIDApOwoJCQkgIH0KCgkJCSAgbGV0IGkgPSBieXRlTGVuZ3RoIC0gMTsKCQkJICBsZXQgbXVsID0gMTsKCQkJICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgJiAweEZGOwoJCQkgIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewoJCQkgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICh2YWx1ZSAvIG11bCkgJiAweEZGOwoJCQkgIH0KCgkJCSAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUud3JpdGVVaW50OCA9CgkJCUJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50OCA9IGZ1bmN0aW9uIHdyaXRlVUludDggKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CgkJCSAgdmFsdWUgPSArdmFsdWU7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4ZmYsIDApOwoJCQkgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpOwoJCQkgIHJldHVybiBvZmZzZXQgKyAxCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVWludDE2TEUgPQoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2TEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQxNkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIHZhbHVlID0gK3ZhbHVlOwoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApOwoJCQkgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpOwoJCQkgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpOwoJCQkgIHJldHVybiBvZmZzZXQgKyAyCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVWludDE2QkUgPQoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2QkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQxNkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIHZhbHVlID0gK3ZhbHVlOwoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApOwoJCQkgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gOCk7CgkJCSAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSAmIDB4ZmYpOwoJCQkgIHJldHVybiBvZmZzZXQgKyAyCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVWludDMyTEUgPQoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIHZhbHVlID0gK3ZhbHVlOwoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKTsKCQkJICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCk7CgkJCSAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpOwoJCQkgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpOwoJCQkgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpOwoJCQkgIHJldHVybiBvZmZzZXQgKyA0CgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVWludDMyQkUgPQoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIHZhbHVlID0gK3ZhbHVlOwoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKTsKCQkJICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KTsKCQkJICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNik7CgkJCSAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCk7CgkJCSAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpOwoJCQkgIHJldHVybiBvZmZzZXQgKyA0CgkJCX07CgoJCQlmdW5jdGlvbiB3cnRCaWdVSW50NjRMRSAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBtaW4sIG1heCkgewoJCQkgIGNoZWNrSW50QkkodmFsdWUsIG1pbiwgbWF4LCBidWYsIG9mZnNldCwgNyk7CgoJCQkgIGxldCBsbyA9IE51bWJlcih2YWx1ZSAmIEJpZ0ludCgweGZmZmZmZmZmKSk7CgkJCSAgYnVmW29mZnNldCsrXSA9IGxvOwoJCQkgIGxvID0gbG8gPj4gODsKCQkJICBidWZbb2Zmc2V0KytdID0gbG87CgkJCSAgbG8gPSBsbyA+PiA4OwoJCQkgIGJ1ZltvZmZzZXQrK10gPSBsbzsKCQkJICBsbyA9IGxvID4+IDg7CgkJCSAgYnVmW29mZnNldCsrXSA9IGxvOwoJCQkgIGxldCBoaSA9IE51bWJlcih2YWx1ZSA+PiBCaWdJbnQoMzIpICYgQmlnSW50KDB4ZmZmZmZmZmYpKTsKCQkJICBidWZbb2Zmc2V0KytdID0gaGk7CgkJCSAgaGkgPSBoaSA+PiA4OwoJCQkgIGJ1ZltvZmZzZXQrK10gPSBoaTsKCQkJICBoaSA9IGhpID4+IDg7CgkJCSAgYnVmW29mZnNldCsrXSA9IGhpOwoJCQkgIGhpID0gaGkgPj4gODsKCQkJICBidWZbb2Zmc2V0KytdID0gaGk7CgkJCSAgcmV0dXJuIG9mZnNldAoJCQl9CgoJCQlmdW5jdGlvbiB3cnRCaWdVSW50NjRCRSAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBtaW4sIG1heCkgewoJCQkgIGNoZWNrSW50QkkodmFsdWUsIG1pbiwgbWF4LCBidWYsIG9mZnNldCwgNyk7CgoJCQkgIGxldCBsbyA9IE51bWJlcih2YWx1ZSAmIEJpZ0ludCgweGZmZmZmZmZmKSk7CgkJCSAgYnVmW29mZnNldCArIDddID0gbG87CgkJCSAgbG8gPSBsbyA+PiA4OwoJCQkgIGJ1ZltvZmZzZXQgKyA2XSA9IGxvOwoJCQkgIGxvID0gbG8gPj4gODsKCQkJICBidWZbb2Zmc2V0ICsgNV0gPSBsbzsKCQkJICBsbyA9IGxvID4+IDg7CgkJCSAgYnVmW29mZnNldCArIDRdID0gbG87CgkJCSAgbGV0IGhpID0gTnVtYmVyKHZhbHVlID4+IEJpZ0ludCgzMikgJiBCaWdJbnQoMHhmZmZmZmZmZikpOwoJCQkgIGJ1ZltvZmZzZXQgKyAzXSA9IGhpOwoJCQkgIGhpID0gaGkgPj4gODsKCQkJICBidWZbb2Zmc2V0ICsgMl0gPSBoaTsKCQkJICBoaSA9IGhpID4+IDg7CgkJCSAgYnVmW29mZnNldCArIDFdID0gaGk7CgkJCSAgaGkgPSBoaSA+PiA4OwoJCQkgIGJ1ZltvZmZzZXRdID0gaGk7CgkJCSAgcmV0dXJuIG9mZnNldCArIDgKCQkJfQoKCQkJQnVmZmVyLnByb3RvdHlwZS53cml0ZUJpZ1VJbnQ2NExFID0gZGVmaW5lQmlnSW50TWV0aG9kKGZ1bmN0aW9uIHdyaXRlQmlnVUludDY0TEUgKHZhbHVlLCBvZmZzZXQgPSAwKSB7CgkJCSAgcmV0dXJuIHdydEJpZ1VJbnQ2NExFKHRoaXMsIHZhbHVlLCBvZmZzZXQsIEJpZ0ludCgwKSwgQmlnSW50KCcweGZmZmZmZmZmZmZmZmZmZmYnKSkKCQkJfSk7CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlQmlnVUludDY0QkUgPSBkZWZpbmVCaWdJbnRNZXRob2QoZnVuY3Rpb24gd3JpdGVCaWdVSW50NjRCRSAodmFsdWUsIG9mZnNldCA9IDApIHsKCQkJICByZXR1cm4gd3J0QmlnVUludDY0QkUodGhpcywgdmFsdWUsIG9mZnNldCwgQmlnSW50KDApLCBCaWdJbnQoJzB4ZmZmZmZmZmZmZmZmZmZmZicpKQoJCQl9KTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CgkJCSAgdmFsdWUgPSArdmFsdWU7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIHsKCQkJICAgIGNvbnN0IGxpbWl0ID0gTWF0aC5wb3coMiwgKDggKiBieXRlTGVuZ3RoKSAtIDEpOwoKCQkJICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KTsKCQkJICB9CgoJCQkgIGxldCBpID0gMDsKCQkJICBsZXQgbXVsID0gMTsKCQkJICBsZXQgc3ViID0gMDsKCQkJICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDB4RkY7CgkJCSAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKCQkJICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSAtIDFdICE9PSAwKSB7CgkJCSAgICAgIHN1YiA9IDE7CgkJCSAgICB9CgkJCSAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGOwoJCQkgIH0KCgkJCSAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRCRSA9IGZ1bmN0aW9uIHdyaXRlSW50QkUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CgkJCSAgdmFsdWUgPSArdmFsdWU7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIHsKCQkJICAgIGNvbnN0IGxpbWl0ID0gTWF0aC5wb3coMiwgKDggKiBieXRlTGVuZ3RoKSAtIDEpOwoKCQkJICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KTsKCQkJICB9CgoJCQkgIGxldCBpID0gYnl0ZUxlbmd0aCAtIDE7CgkJCSAgbGV0IG11bCA9IDE7CgkJCSAgbGV0IHN1YiA9IDA7CgkJCSAgdGhpc1tvZmZzZXQgKyBpXSA9IHZhbHVlICYgMHhGRjsKCQkJICB3aGlsZSAoLS1pID49IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKCQkJICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSArIDFdICE9PSAwKSB7CgkJCSAgICAgIHN1YiA9IDE7CgkJCSAgICB9CgkJCSAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGOwoJCQkgIH0KCgkJCSAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQ4ID0gZnVuY3Rpb24gd3JpdGVJbnQ4ICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIHZhbHVlID0gK3ZhbHVlOwoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweDdmLCAtMHg4MCk7CgkJCSAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmICsgdmFsdWUgKyAxOwoJCQkgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpOwoJCQkgIHJldHVybiBvZmZzZXQgKyAxCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MTZMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKCQkJICB2YWx1ZSA9ICt2YWx1ZTsKCQkJICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CgkJCSAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKTsKCQkJICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKTsKCQkJICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KTsKCQkJICByZXR1cm4gb2Zmc2V0ICsgMgoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2QkUgPSBmdW5jdGlvbiB3cml0ZUludDE2QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CgkJCSAgdmFsdWUgPSArdmFsdWU7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCk7CgkJCSAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiA4KTsKCQkJICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlICYgMHhmZik7CgkJCSAgcmV0dXJuIG9mZnNldCArIDIKCQkJfTsKCgkJCUJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkxFID0gZnVuY3Rpb24gd3JpdGVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIHZhbHVlID0gK3ZhbHVlOwoJCQkgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKCQkJICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCk7CgkJCSAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZik7CgkJCSAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCk7CgkJCSAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpOwoJCQkgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KTsKCQkJICByZXR1cm4gb2Zmc2V0ICsgNAoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CgkJCSAgdmFsdWUgPSArdmFsdWU7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKTsKCQkJICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDE7CgkJCSAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCk7CgkJCSAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gMTYpOwoJCQkgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDgpOwoJCQkgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgJiAweGZmKTsKCQkJICByZXR1cm4gb2Zmc2V0ICsgNAoJCQl9OwoKCQkJQnVmZmVyLnByb3RvdHlwZS53cml0ZUJpZ0ludDY0TEUgPSBkZWZpbmVCaWdJbnRNZXRob2QoZnVuY3Rpb24gd3JpdGVCaWdJbnQ2NExFICh2YWx1ZSwgb2Zmc2V0ID0gMCkgewoJCQkgIHJldHVybiB3cnRCaWdVSW50NjRMRSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAtQmlnSW50KCcweDgwMDAwMDAwMDAwMDAwMDAnKSwgQmlnSW50KCcweDdmZmZmZmZmZmZmZmZmZmYnKSkKCQkJfSk7CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlQmlnSW50NjRCRSA9IGRlZmluZUJpZ0ludE1ldGhvZChmdW5jdGlvbiB3cml0ZUJpZ0ludDY0QkUgKHZhbHVlLCBvZmZzZXQgPSAwKSB7CgkJCSAgcmV0dXJuIHdydEJpZ1VJbnQ2NEJFKHRoaXMsIHZhbHVlLCBvZmZzZXQsIC1CaWdJbnQoJzB4ODAwMDAwMDAwMDAwMDAwMCcpLCBCaWdJbnQoJzB4N2ZmZmZmZmZmZmZmZmZmZicpKQoJCQl9KTsKCgkJCWZ1bmN0aW9uIGNoZWNrSUVFRTc1NCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CgkJCSAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQoJCQkgIGlmIChvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKCQkJfQoKCQkJZnVuY3Rpb24gd3JpdGVGbG9hdCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CgkJCSAgdmFsdWUgPSArdmFsdWU7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIHsKCQkJICAgIGNoZWNrSUVFRTc1NChidWYsIHZhbHVlLCBvZmZzZXQsIDQpOwoJCQkgIH0KCQkJICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCAyMywgNCk7CgkJCSAgcmV0dXJuIG9mZnNldCArIDQKCQkJfQoKCQkJQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0TEUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CgkJCSAgcmV0dXJuIHdyaXRlRmxvYXQodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRCRSA9IGZ1bmN0aW9uIHdyaXRlRmxvYXRCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKCQkJICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCgkJCX07CgoJCQlmdW5jdGlvbiB3cml0ZURvdWJsZSAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CgkJCSAgdmFsdWUgPSArdmFsdWU7CgkJCSAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwoJCQkgIGlmICghbm9Bc3NlcnQpIHsKCQkJICAgIGNoZWNrSUVFRTc1NChidWYsIHZhbHVlLCBvZmZzZXQsIDgpOwoJCQkgIH0KCQkJICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCA1MiwgOCk7CgkJCSAgcmV0dXJuIG9mZnNldCArIDgKCQkJfQoKCQkJQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUxFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKCQkJICByZXR1cm4gd3JpdGVEb3VibGUodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpCgkJCX07CgoJCQlCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlQkUgPSBmdW5jdGlvbiB3cml0ZURvdWJsZUJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewoJCQkgIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCgkJCX07CgoJCQkvLyBjb3B5KHRhcmdldEJ1ZmZlciwgdGFyZ2V0U3RhcnQ9MCwgc291cmNlU3RhcnQ9MCwgc291cmNlRW5kPWJ1ZmZlci5sZW5ndGgpCgkJCUJ1ZmZlci5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkgKHRhcmdldCwgdGFyZ2V0U3RhcnQsIHN0YXJ0LCBlbmQpIHsKCQkJICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcih0YXJnZXQpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdhcmd1bWVudCBzaG91bGQgYmUgYSBCdWZmZXInKQoJCQkgIGlmICghc3RhcnQpIHN0YXJ0ID0gMDsKCQkJICBpZiAoIWVuZCAmJiBlbmQgIT09IDApIGVuZCA9IHRoaXMubGVuZ3RoOwoJCQkgIGlmICh0YXJnZXRTdGFydCA+PSB0YXJnZXQubGVuZ3RoKSB0YXJnZXRTdGFydCA9IHRhcmdldC5sZW5ndGg7CgkJCSAgaWYgKCF0YXJnZXRTdGFydCkgdGFyZ2V0U3RhcnQgPSAwOwoJCQkgIGlmIChlbmQgPiAwICYmIGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydDsKCgkJCSAgLy8gQ29weSAwIGJ5dGVzOyB3ZSdyZSBkb25lCgkJCSAgaWYgKGVuZCA9PT0gc3RhcnQpIHJldHVybiAwCgkJCSAgaWYgKHRhcmdldC5sZW5ndGggPT09IDAgfHwgdGhpcy5sZW5ndGggPT09IDApIHJldHVybiAwCgoJCQkgIC8vIEZhdGFsIGVycm9yIGNvbmRpdGlvbnMKCQkJICBpZiAodGFyZ2V0U3RhcnQgPCAwKSB7CgkJCSAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigndGFyZ2V0U3RhcnQgb3V0IG9mIGJvdW5kcycpCgkJCSAgfQoJCQkgIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gdGhpcy5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQoJCQkgIGlmIChlbmQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc291cmNlRW5kIG91dCBvZiBib3VuZHMnKQoKCQkJICAvLyBBcmUgd2Ugb29iPwoJCQkgIGlmIChlbmQgPiB0aGlzLmxlbmd0aCkgZW5kID0gdGhpcy5sZW5ndGg7CgkJCSAgaWYgKHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCA8IGVuZCAtIHN0YXJ0KSB7CgkJCSAgICBlbmQgPSB0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgKyBzdGFydDsKCQkJICB9CgoJCQkgIGNvbnN0IGxlbiA9IGVuZCAtIHN0YXJ0OwoKCQkJICBpZiAodGhpcyA9PT0gdGFyZ2V0ICYmIHR5cGVvZiBVaW50OEFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluID09PSAnZnVuY3Rpb24nKSB7CgkJCSAgICAvLyBVc2UgYnVpbHQtaW4gd2hlbiBhdmFpbGFibGUsIG1pc3NpbmcgZnJvbSBJRTExCgkJCSAgICB0aGlzLmNvcHlXaXRoaW4odGFyZ2V0U3RhcnQsIHN0YXJ0LCBlbmQpOwoJCQkgIH0gZWxzZSB7CgkJCSAgICBVaW50OEFycmF5LnByb3RvdHlwZS5zZXQuY2FsbCgKCQkJICAgICAgdGFyZ2V0LAoJCQkgICAgICB0aGlzLnN1YmFycmF5KHN0YXJ0LCBlbmQpLAoJCQkgICAgICB0YXJnZXRTdGFydAoJCQkgICAgKTsKCQkJICB9CgoJCQkgIHJldHVybiBsZW4KCQkJfTsKCgkJCS8vIFVzYWdlOgoJCQkvLyAgICBidWZmZXIuZmlsbChudW1iZXJbLCBvZmZzZXRbLCBlbmRdXSkKCQkJLy8gICAgYnVmZmVyLmZpbGwoYnVmZmVyWywgb2Zmc2V0WywgZW5kXV0pCgkJCS8vICAgIGJ1ZmZlci5maWxsKHN0cmluZ1ssIG9mZnNldFssIGVuZF1dWywgZW5jb2RpbmddKQoJCQlCdWZmZXIucHJvdG90eXBlLmZpbGwgPSBmdW5jdGlvbiBmaWxsICh2YWwsIHN0YXJ0LCBlbmQsIGVuY29kaW5nKSB7CgkJCSAgLy8gSGFuZGxlIHN0cmluZyBjYXNlczoKCQkJICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKCQkJICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICdzdHJpbmcnKSB7CgkJCSAgICAgIGVuY29kaW5nID0gc3RhcnQ7CgkJCSAgICAgIHN0YXJ0ID0gMDsKCQkJICAgICAgZW5kID0gdGhpcy5sZW5ndGg7CgkJCSAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmQgPT09ICdzdHJpbmcnKSB7CgkJCSAgICAgIGVuY29kaW5nID0gZW5kOwoJCQkgICAgICBlbmQgPSB0aGlzLmxlbmd0aDsKCQkJICAgIH0KCQkJICAgIGlmIChlbmNvZGluZyAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBlbmNvZGluZyAhPT0gJ3N0cmluZycpIHsKCQkJICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignZW5jb2RpbmcgbXVzdCBiZSBhIHN0cmluZycpCgkJCSAgICB9CgkJCSAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnc3RyaW5nJyAmJiAhQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpKSB7CgkJCSAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKCQkJICAgIH0KCQkJICAgIGlmICh2YWwubGVuZ3RoID09PSAxKSB7CgkJCSAgICAgIGNvbnN0IGNvZGUgPSB2YWwuY2hhckNvZGVBdCgwKTsKCQkJICAgICAgaWYgKChlbmNvZGluZyA9PT0gJ3V0ZjgnICYmIGNvZGUgPCAxMjgpIHx8CgkJCSAgICAgICAgICBlbmNvZGluZyA9PT0gJ2xhdGluMScpIHsKCQkJICAgICAgICAvLyBGYXN0IHBhdGg6IElmIGB2YWxgIGZpdHMgaW50byBhIHNpbmdsZSBieXRlLCB1c2UgdGhhdCBudW1lcmljIHZhbHVlLgoJCQkgICAgICAgIHZhbCA9IGNvZGU7CgkJCSAgICAgIH0KCQkJICAgIH0KCQkJICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CgkJCSAgICB2YWwgPSB2YWwgJiAyNTU7CgkJCSAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnYm9vbGVhbicpIHsKCQkJICAgIHZhbCA9IE51bWJlcih2YWwpOwoJCQkgIH0KCgkJCSAgLy8gSW52YWxpZCByYW5nZXMgYXJlIG5vdCBzZXQgdG8gYSBkZWZhdWx0LCBzbyBjYW4gcmFuZ2UgY2hlY2sgZWFybHkuCgkJCSAgaWYgKHN0YXJ0IDwgMCB8fCB0aGlzLmxlbmd0aCA8IHN0YXJ0IHx8IHRoaXMubGVuZ3RoIDwgZW5kKSB7CgkJCSAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignT3V0IG9mIHJhbmdlIGluZGV4JykKCQkJICB9CgoJCQkgIGlmIChlbmQgPD0gc3RhcnQpIHsKCQkJICAgIHJldHVybiB0aGlzCgkJCSAgfQoKCQkJICBzdGFydCA9IHN0YXJ0ID4+PiAwOwoJCQkgIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gdGhpcy5sZW5ndGggOiBlbmQgPj4+IDA7CgoJCQkgIGlmICghdmFsKSB2YWwgPSAwOwoKCQkJICBsZXQgaTsKCQkJICBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKCQkJICAgIGZvciAoaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKCQkJICAgICAgdGhpc1tpXSA9IHZhbDsKCQkJICAgIH0KCQkJICB9IGVsc2UgewoJCQkgICAgY29uc3QgYnl0ZXMgPSBCdWZmZXIuaXNCdWZmZXIodmFsKQoJCQkgICAgICA/IHZhbAoJCQkgICAgICA6IEJ1ZmZlci5mcm9tKHZhbCwgZW5jb2RpbmcpOwoJCQkgICAgY29uc3QgbGVuID0gYnl0ZXMubGVuZ3RoOwoJCQkgICAgaWYgKGxlbiA9PT0gMCkgewoJCQkgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgdmFsdWUgIicgKyB2YWwgKwoJCQkgICAgICAgICciIGlzIGludmFsaWQgZm9yIGFyZ3VtZW50ICJ2YWx1ZSInKQoJCQkgICAgfQoJCQkgICAgZm9yIChpID0gMDsgaSA8IGVuZCAtIHN0YXJ0OyArK2kpIHsKCQkJICAgICAgdGhpc1tpICsgc3RhcnRdID0gYnl0ZXNbaSAlIGxlbl07CgkJCSAgICB9CgkJCSAgfQoKCQkJICByZXR1cm4gdGhpcwoJCQl9OwoKCQkJLy8gQ1VTVE9NIEVSUk9SUwoJCQkvLyA9PT09PT09PT09PT09CgoJCQkvLyBTaW1wbGlmaWVkIHZlcnNpb25zIGZyb20gTm9kZSwgY2hhbmdlZCBmb3IgQnVmZmVyLW9ubHkgdXNhZ2UKCQkJY29uc3QgZXJyb3JzID0ge307CgkJCWZ1bmN0aW9uIEUgKHN5bSwgZ2V0TWVzc2FnZSwgQmFzZSkgewoJCQkgIGVycm9yc1tzeW1dID0gY2xhc3MgTm9kZUVycm9yIGV4dGVuZHMgQmFzZSB7CgkJCSAgICBjb25zdHJ1Y3RvciAoKSB7CgkJCSAgICAgIHN1cGVyKCk7CgoJCQkgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ21lc3NhZ2UnLCB7CgkJCSAgICAgICAgdmFsdWU6IGdldE1lc3NhZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSwKCQkJICAgICAgICB3cml0YWJsZTogdHJ1ZSwKCQkJICAgICAgICBjb25maWd1cmFibGU6IHRydWUKCQkJICAgICAgfSk7CgoJCQkgICAgICAvLyBBZGQgdGhlIGVycm9yIGNvZGUgdG8gdGhlIG5hbWUgdG8gaW5jbHVkZSBpdCBpbiB0aGUgc3RhY2sgdHJhY2UuCgkJCSAgICAgIHRoaXMubmFtZSA9IGAke3RoaXMubmFtZX0gWyR7c3ltfV1gOwoJCQkgICAgICAvLyBBY2Nlc3MgdGhlIHN0YWNrIHRvIGdlbmVyYXRlIHRoZSBlcnJvciBtZXNzYWdlIGluY2x1ZGluZyB0aGUgZXJyb3IgY29kZQoJCQkgICAgICAvLyBmcm9tIHRoZSBuYW1lLgoJCQkgICAgICB0aGlzLnN0YWNrOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC1leHByZXNzaW9ucwoJCQkgICAgICAvLyBSZXNldCB0aGUgbmFtZSB0byB0aGUgYWN0dWFsIG5hbWUuCgkJCSAgICAgIGRlbGV0ZSB0aGlzLm5hbWU7CgkJCSAgICB9CgoJCQkgICAgZ2V0IGNvZGUgKCkgewoJCQkgICAgICByZXR1cm4gc3ltCgkJCSAgICB9CgoJCQkgICAgc2V0IGNvZGUgKHZhbHVlKSB7CgkJCSAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnY29kZScsIHsKCQkJICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCgkJCSAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKCQkJICAgICAgICB2YWx1ZSwKCQkJICAgICAgICB3cml0YWJsZTogdHJ1ZQoJCQkgICAgICB9KTsKCQkJICAgIH0KCgkJCSAgICB0b1N0cmluZyAoKSB7CgkJCSAgICAgIHJldHVybiBgJHt0aGlzLm5hbWV9IFske3N5bX1dOiAke3RoaXMubWVzc2FnZX1gCgkJCSAgICB9CgkJCSAgfTsKCQkJfQoKCQkJRSgnRVJSX0JVRkZFUl9PVVRfT0ZfQk9VTkRTJywKCQkJICBmdW5jdGlvbiAobmFtZSkgewoJCQkgICAgaWYgKG5hbWUpIHsKCQkJICAgICAgcmV0dXJuIGAke25hbWV9IGlzIG91dHNpZGUgb2YgYnVmZmVyIGJvdW5kc2AKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gJ0F0dGVtcHQgdG8gYWNjZXNzIG1lbW9yeSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMnCgkJCSAgfSwgUmFuZ2VFcnJvcik7CgkJCUUoJ0VSUl9JTlZBTElEX0FSR19UWVBFJywKCQkJICBmdW5jdGlvbiAobmFtZSwgYWN0dWFsKSB7CgkJCSAgICByZXR1cm4gYFRoZSAiJHtuYW1lfSIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIG51bWJlci4gUmVjZWl2ZWQgdHlwZSAke3R5cGVvZiBhY3R1YWx9YAoJCQkgIH0sIFR5cGVFcnJvcik7CgkJCUUoJ0VSUl9PVVRfT0ZfUkFOR0UnLAoJCQkgIGZ1bmN0aW9uIChzdHIsIHJhbmdlLCBpbnB1dCkgewoJCQkgICAgbGV0IG1zZyA9IGBUaGUgdmFsdWUgb2YgIiR7c3RyfSIgaXMgb3V0IG9mIHJhbmdlLmA7CgkJCSAgICBsZXQgcmVjZWl2ZWQgPSBpbnB1dDsKCQkJICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKGlucHV0KSAmJiBNYXRoLmFicyhpbnB1dCkgPiAyICoqIDMyKSB7CgkJCSAgICAgIHJlY2VpdmVkID0gYWRkTnVtZXJpY2FsU2VwYXJhdG9yKFN0cmluZyhpbnB1dCkpOwoJCQkgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09ICdiaWdpbnQnKSB7CgkJCSAgICAgIHJlY2VpdmVkID0gU3RyaW5nKGlucHV0KTsKCQkJICAgICAgaWYgKGlucHV0ID4gQmlnSW50KDIpICoqIEJpZ0ludCgzMikgfHwgaW5wdXQgPCAtKEJpZ0ludCgyKSAqKiBCaWdJbnQoMzIpKSkgewoJCQkgICAgICAgIHJlY2VpdmVkID0gYWRkTnVtZXJpY2FsU2VwYXJhdG9yKHJlY2VpdmVkKTsKCQkJICAgICAgfQoJCQkgICAgICByZWNlaXZlZCArPSAnbic7CgkJCSAgICB9CgkJCSAgICBtc2cgKz0gYCBJdCBtdXN0IGJlICR7cmFuZ2V9LiBSZWNlaXZlZCAke3JlY2VpdmVkfWA7CgkJCSAgICByZXR1cm4gbXNnCgkJCSAgfSwgUmFuZ2VFcnJvcik7CgoJCQlmdW5jdGlvbiBhZGROdW1lcmljYWxTZXBhcmF0b3IgKHZhbCkgewoJCQkgIGxldCByZXMgPSAnJzsKCQkJICBsZXQgaSA9IHZhbC5sZW5ndGg7CgkJCSAgY29uc3Qgc3RhcnQgPSB2YWxbMF0gPT09ICctJyA/IDEgOiAwOwoJCQkgIGZvciAoOyBpID49IHN0YXJ0ICsgNDsgaSAtPSAzKSB7CgkJCSAgICByZXMgPSBgXyR7dmFsLnNsaWNlKGkgLSAzLCBpKX0ke3Jlc31gOwoJCQkgIH0KCQkJICByZXR1cm4gYCR7dmFsLnNsaWNlKDAsIGkpfSR7cmVzfWAKCQkJfQoKCQkJLy8gQ0hFQ0sgRlVOQ1RJT05TCgkJCS8vID09PT09PT09PT09PT09PQoKCQkJZnVuY3Rpb24gY2hlY2tCb3VuZHMgKGJ1Ziwgb2Zmc2V0LCBieXRlTGVuZ3RoKSB7CgkJCSAgdmFsaWRhdGVOdW1iZXIob2Zmc2V0LCAnb2Zmc2V0Jyk7CgkJCSAgaWYgKGJ1ZltvZmZzZXRdID09PSB1bmRlZmluZWQgfHwgYnVmW29mZnNldCArIGJ5dGVMZW5ndGhdID09PSB1bmRlZmluZWQpIHsKCQkJICAgIGJvdW5kc0Vycm9yKG9mZnNldCwgYnVmLmxlbmd0aCAtIChieXRlTGVuZ3RoICsgMSkpOwoJCQkgIH0KCQkJfQoKCQkJZnVuY3Rpb24gY2hlY2tJbnRCSSAodmFsdWUsIG1pbiwgbWF4LCBidWYsIG9mZnNldCwgYnl0ZUxlbmd0aCkgewoJCQkgIGlmICh2YWx1ZSA+IG1heCB8fCB2YWx1ZSA8IG1pbikgewoJCQkgICAgY29uc3QgbiA9IHR5cGVvZiBtaW4gPT09ICdiaWdpbnQnID8gJ24nIDogJyc7CgkJCSAgICBsZXQgcmFuZ2U7CgkJCSAgICB7CgkJCSAgICAgIGlmIChtaW4gPT09IDAgfHwgbWluID09PSBCaWdJbnQoMCkpIHsKCQkJICAgICAgICByYW5nZSA9IGA+PSAwJHtufSBhbmQgPCAyJHtufSAqKiAkeyhieXRlTGVuZ3RoICsgMSkgKiA4fSR7bn1gOwoJCQkgICAgICB9IGVsc2UgewoJCQkgICAgICAgIHJhbmdlID0gYD49IC0oMiR7bn0gKiogJHsoYnl0ZUxlbmd0aCArIDEpICogOCAtIDF9JHtufSkgYW5kIDwgMiAqKiBgICsKCQkJICAgICAgICAgICAgICAgIGAkeyhieXRlTGVuZ3RoICsgMSkgKiA4IC0gMX0ke259YDsKCQkJICAgICAgfQoJCQkgICAgfQoJCQkgICAgdGhyb3cgbmV3IGVycm9ycy5FUlJfT1VUX09GX1JBTkdFKCd2YWx1ZScsIHJhbmdlLCB2YWx1ZSkKCQkJICB9CgkJCSAgY2hlY2tCb3VuZHMoYnVmLCBvZmZzZXQsIGJ5dGVMZW5ndGgpOwoJCQl9CgoJCQlmdW5jdGlvbiB2YWxpZGF0ZU51bWJlciAodmFsdWUsIG5hbWUpIHsKCQkJICBpZiAodHlwZW9mIHZhbHVlICE9PSAnbnVtYmVyJykgewoJCQkgICAgdGhyb3cgbmV3IGVycm9ycy5FUlJfSU5WQUxJRF9BUkdfVFlQRShuYW1lLCAnbnVtYmVyJywgdmFsdWUpCgkJCSAgfQoJCQl9CgoJCQlmdW5jdGlvbiBib3VuZHNFcnJvciAodmFsdWUsIGxlbmd0aCwgdHlwZSkgewoJCQkgIGlmIChNYXRoLmZsb29yKHZhbHVlKSAhPT0gdmFsdWUpIHsKCQkJICAgIHZhbGlkYXRlTnVtYmVyKHZhbHVlLCB0eXBlKTsKCQkJICAgIHRocm93IG5ldyBlcnJvcnMuRVJSX09VVF9PRl9SQU5HRSgnb2Zmc2V0JywgJ2FuIGludGVnZXInLCB2YWx1ZSkKCQkJICB9CgoJCQkgIGlmIChsZW5ndGggPCAwKSB7CgkJCSAgICB0aHJvdyBuZXcgZXJyb3JzLkVSUl9CVUZGRVJfT1VUX09GX0JPVU5EUygpCgkJCSAgfQoKCQkJICB0aHJvdyBuZXcgZXJyb3JzLkVSUl9PVVRfT0ZfUkFOR0UoJ29mZnNldCcsCgkJCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGA+PSAkezB9IGFuZCA8PSAke2xlbmd0aH1gLAoJCQkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSkKCQkJfQoKCQkJLy8gSEVMUEVSIEZVTkNUSU9OUwoJCQkvLyA9PT09PT09PT09PT09PT09CgoJCQljb25zdCBJTlZBTElEX0JBU0U2NF9SRSA9IC9bXisvMC05QS1aYS16LV9dL2c7CgoJCQlmdW5jdGlvbiBiYXNlNjRjbGVhbiAoc3RyKSB7CgkJCSAgLy8gTm9kZSB0YWtlcyBlcXVhbCBzaWducyBhcyBlbmQgb2YgdGhlIEJhc2U2NCBlbmNvZGluZwoJCQkgIHN0ciA9IHN0ci5zcGxpdCgnPScpWzBdOwoJCQkgIC8vIE5vZGUgc3RyaXBzIG91dCBpbnZhbGlkIGNoYXJhY3RlcnMgbGlrZSBcbiBhbmQgXHQgZnJvbSB0aGUgc3RyaW5nLCBiYXNlNjQtanMgZG9lcyBub3QKCQkJICBzdHIgPSBzdHIudHJpbSgpLnJlcGxhY2UoSU5WQUxJRF9CQVNFNjRfUkUsICcnKTsKCQkJICAvLyBOb2RlIGNvbnZlcnRzIHN0cmluZ3Mgd2l0aCBsZW5ndGggPCAyIHRvICcnCgkJCSAgaWYgKHN0ci5sZW5ndGggPCAyKSByZXR1cm4gJycKCQkJICAvLyBOb2RlIGFsbG93cyBmb3Igbm9uLXBhZGRlZCBiYXNlNjQgc3RyaW5ncyAobWlzc2luZyB0cmFpbGluZyA9PT0pLCBiYXNlNjQtanMgZG9lcyBub3QKCQkJICB3aGlsZSAoc3RyLmxlbmd0aCAlIDQgIT09IDApIHsKCQkJICAgIHN0ciA9IHN0ciArICc9JzsKCQkJICB9CgkJCSAgcmV0dXJuIHN0cgoJCQl9CgoJCQlmdW5jdGlvbiB1dGY4VG9CeXRlcyAoc3RyaW5nLCB1bml0cykgewoJCQkgIHVuaXRzID0gdW5pdHMgfHwgSW5maW5pdHk7CgkJCSAgbGV0IGNvZGVQb2ludDsKCQkJICBjb25zdCBsZW5ndGggPSBzdHJpbmcubGVuZ3RoOwoJCQkgIGxldCBsZWFkU3Vycm9nYXRlID0gbnVsbDsKCQkJICBjb25zdCBieXRlcyA9IFtdOwoKCQkJICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CgkJCSAgICBjb2RlUG9pbnQgPSBzdHJpbmcuY2hhckNvZGVBdChpKTsKCgkJCSAgICAvLyBpcyBzdXJyb2dhdGUgY29tcG9uZW50CgkJCSAgICBpZiAoY29kZVBvaW50ID4gMHhEN0ZGICYmIGNvZGVQb2ludCA8IDB4RTAwMCkgewoJCQkgICAgICAvLyBsYXN0IGNoYXIgd2FzIGEgbGVhZAoJCQkgICAgICBpZiAoIWxlYWRTdXJyb2dhdGUpIHsKCQkJICAgICAgICAvLyBubyBsZWFkIHlldAoJCQkgICAgICAgIGlmIChjb2RlUG9pbnQgPiAweERCRkYpIHsKCQkJICAgICAgICAgIC8vIHVuZXhwZWN0ZWQgdHJhaWwKCQkJICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKTsKCQkJICAgICAgICAgIGNvbnRpbnVlCgkJCSAgICAgICAgfSBlbHNlIGlmIChpICsgMSA9PT0gbGVuZ3RoKSB7CgkJCSAgICAgICAgICAvLyB1bnBhaXJlZCBsZWFkCgkJCSAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCk7CgkJCSAgICAgICAgICBjb250aW51ZQoJCQkgICAgICAgIH0KCgkJCSAgICAgICAgLy8gdmFsaWQgbGVhZAoJCQkgICAgICAgIGxlYWRTdXJyb2dhdGUgPSBjb2RlUG9pbnQ7CgoJCQkgICAgICAgIGNvbnRpbnVlCgkJCSAgICAgIH0KCgkJCSAgICAgIC8vIDIgbGVhZHMgaW4gYSByb3cKCQkJICAgICAgaWYgKGNvZGVQb2ludCA8IDB4REMwMCkgewoJCQkgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKTsKCQkJICAgICAgICBsZWFkU3Vycm9nYXRlID0gY29kZVBvaW50OwoJCQkgICAgICAgIGNvbnRpbnVlCgkJCSAgICAgIH0KCgkJCSAgICAgIC8vIHZhbGlkIHN1cnJvZ2F0ZSBwYWlyCgkJCSAgICAgIGNvZGVQb2ludCA9IChsZWFkU3Vycm9nYXRlIC0gMHhEODAwIDw8IDEwIHwgY29kZVBvaW50IC0gMHhEQzAwKSArIDB4MTAwMDA7CgkJCSAgICB9IGVsc2UgaWYgKGxlYWRTdXJyb2dhdGUpIHsKCQkJICAgICAgLy8gdmFsaWQgYm1wIGNoYXIsIGJ1dCBsYXN0IGNoYXIgd2FzIGEgbGVhZAoJCQkgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCk7CgkJCSAgICB9CgoJCQkgICAgbGVhZFN1cnJvZ2F0ZSA9IG51bGw7CgoJCQkgICAgLy8gZW5jb2RlIHV0ZjgKCQkJICAgIGlmIChjb2RlUG9pbnQgPCAweDgwKSB7CgkJCSAgICAgIGlmICgodW5pdHMgLT0gMSkgPCAwKSBicmVhawoJCQkgICAgICBieXRlcy5wdXNoKGNvZGVQb2ludCk7CgkJCSAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4ODAwKSB7CgkJCSAgICAgIGlmICgodW5pdHMgLT0gMikgPCAwKSBicmVhawoJCQkgICAgICBieXRlcy5wdXNoKAoJCQkgICAgICAgIGNvZGVQb2ludCA+PiAweDYgfCAweEMwLAoJCQkgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCgkJCSAgICAgICk7CgkJCSAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTAwMDApIHsKCQkJICAgICAgaWYgKCh1bml0cyAtPSAzKSA8IDApIGJyZWFrCgkJCSAgICAgIGJ5dGVzLnB1c2goCgkJCSAgICAgICAgY29kZVBvaW50ID4+IDB4QyB8IDB4RTAsCgkJCSAgICAgICAgY29kZVBvaW50ID4+IDB4NiAmIDB4M0YgfCAweDgwLAoJCQkgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCgkJCSAgICAgICk7CgkJCSAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTEwMDAwKSB7CgkJCSAgICAgIGlmICgodW5pdHMgLT0gNCkgPCAwKSBicmVhawoJCQkgICAgICBieXRlcy5wdXNoKAoJCQkgICAgICAgIGNvZGVQb2ludCA+PiAweDEyIHwgMHhGMCwKCQkJICAgICAgICBjb2RlUG9pbnQgPj4gMHhDICYgMHgzRiB8IDB4ODAsCgkJCSAgICAgICAgY29kZVBvaW50ID4+IDB4NiAmIDB4M0YgfCAweDgwLAoJCQkgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCgkJCSAgICAgICk7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29kZSBwb2ludCcpCgkJCSAgICB9CgkJCSAgfQoKCQkJICByZXR1cm4gYnl0ZXMKCQkJfQoKCQkJZnVuY3Rpb24gYXNjaWlUb0J5dGVzIChzdHIpIHsKCQkJICBjb25zdCBieXRlQXJyYXkgPSBbXTsKCQkJICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewoJCQkgICAgLy8gTm9kZSdzIGNvZGUgc2VlbXMgdG8gYmUgZG9pbmcgdGhpcyBhbmQgbm90ICYgMHg3Ri4uCgkJCSAgICBieXRlQXJyYXkucHVzaChzdHIuY2hhckNvZGVBdChpKSAmIDB4RkYpOwoJCQkgIH0KCQkJICByZXR1cm4gYnl0ZUFycmF5CgkJCX0KCgkJCWZ1bmN0aW9uIHV0ZjE2bGVUb0J5dGVzIChzdHIsIHVuaXRzKSB7CgkJCSAgbGV0IGMsIGhpLCBsbzsKCQkJICBjb25zdCBieXRlQXJyYXkgPSBbXTsKCQkJICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewoJCQkgICAgaWYgKCh1bml0cyAtPSAyKSA8IDApIGJyZWFrCgoJCQkgICAgYyA9IHN0ci5jaGFyQ29kZUF0KGkpOwoJCQkgICAgaGkgPSBjID4+IDg7CgkJCSAgICBsbyA9IGMgJSAyNTY7CgkJCSAgICBieXRlQXJyYXkucHVzaChsbyk7CgkJCSAgICBieXRlQXJyYXkucHVzaChoaSk7CgkJCSAgfQoKCQkJICByZXR1cm4gYnl0ZUFycmF5CgkJCX0KCgkJCWZ1bmN0aW9uIGJhc2U2NFRvQnl0ZXMgKHN0cikgewoJCQkgIHJldHVybiBiYXNlNjQudG9CeXRlQXJyYXkoYmFzZTY0Y2xlYW4oc3RyKSkKCQkJfQoKCQkJZnVuY3Rpb24gYmxpdEJ1ZmZlciAoc3JjLCBkc3QsIG9mZnNldCwgbGVuZ3RoKSB7CgkJCSAgbGV0IGk7CgkJCSAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CgkJCSAgICBpZiAoKGkgKyBvZmZzZXQgPj0gZHN0Lmxlbmd0aCkgfHwgKGkgPj0gc3JjLmxlbmd0aCkpIGJyZWFrCgkJCSAgICBkc3RbaSArIG9mZnNldF0gPSBzcmNbaV07CgkJCSAgfQoJCQkgIHJldHVybiBpCgkJCX0KCgkJCS8vIEFycmF5QnVmZmVyIG9yIFVpbnQ4QXJyYXkgb2JqZWN0cyBmcm9tIG90aGVyIGNvbnRleHRzIChpLmUuIGlmcmFtZXMpIGRvIG5vdCBwYXNzCgkJCS8vIHRoZSBgaW5zdGFuY2VvZmAgY2hlY2sgYnV0IHRoZXkgc2hvdWxkIGJlIHRyZWF0ZWQgYXMgb2YgdGhhdCB0eXBlLgoJCQkvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9mZXJvc3MvYnVmZmVyL2lzc3Vlcy8xNjYKCQkJZnVuY3Rpb24gaXNJbnN0YW5jZSAob2JqLCB0eXBlKSB7CgkJCSAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIHR5cGUgfHwKCQkJICAgIChvYmogIT0gbnVsbCAmJiBvYmouY29uc3RydWN0b3IgIT0gbnVsbCAmJiBvYmouY29uc3RydWN0b3IubmFtZSAhPSBudWxsICYmCgkJCSAgICAgIG9iai5jb25zdHJ1Y3Rvci5uYW1lID09PSB0eXBlLm5hbWUpCgkJCX0KCQkJZnVuY3Rpb24gbnVtYmVySXNOYU4gKG9iaikgewoJCQkgIC8vIEZvciBJRTExIHN1cHBvcnQKCQkJICByZXR1cm4gb2JqICE9PSBvYmogLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1zZWxmLWNvbXBhcmUKCQkJfQoKCQkJLy8gQ3JlYXRlIGxvb2t1cCB0YWJsZSBmb3IgYHRvU3RyaW5nKCdoZXgnKWAKCQkJLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vZmVyb3NzL2J1ZmZlci9pc3N1ZXMvMjE5CgkJCWNvbnN0IGhleFNsaWNlTG9va3VwVGFibGUgPSAoZnVuY3Rpb24gKCkgewoJCQkgIGNvbnN0IGFscGhhYmV0ID0gJzAxMjM0NTY3ODlhYmNkZWYnOwoJCQkgIGNvbnN0IHRhYmxlID0gbmV3IEFycmF5KDI1Nik7CgkJCSAgZm9yIChsZXQgaSA9IDA7IGkgPCAxNjsgKytpKSB7CgkJCSAgICBjb25zdCBpMTYgPSBpICogMTY7CgkJCSAgICBmb3IgKGxldCBqID0gMDsgaiA8IDE2OyArK2opIHsKCQkJICAgICAgdGFibGVbaTE2ICsgal0gPSBhbHBoYWJldFtpXSArIGFscGhhYmV0W2pdOwoJCQkgICAgfQoJCQkgIH0KCQkJICByZXR1cm4gdGFibGUKCQkJfSkoKTsKCgkJCS8vIFJldHVybiBub3QgZnVuY3Rpb24gd2l0aCBFcnJvciBpZiBCaWdJbnQgbm90IHN1cHBvcnRlZAoJCQlmdW5jdGlvbiBkZWZpbmVCaWdJbnRNZXRob2QgKGZuKSB7CgkJCSAgcmV0dXJuIHR5cGVvZiBCaWdJbnQgPT09ICd1bmRlZmluZWQnID8gQnVmZmVyQmlnSW50Tm90RGVmaW5lZCA6IGZuCgkJCX0KCgkJCWZ1bmN0aW9uIEJ1ZmZlckJpZ0ludE5vdERlZmluZWQgKCkgewoJCQkgIHRocm93IG5ldyBFcnJvcignQmlnSW50IG5vdCBzdXBwb3J0ZWQnKQoJCQl9IAoJCX0gKGJ1ZmZlcikpOwoJCXJldHVybiBidWZmZXI7Cgl9CgoJdmFyIGJ1ZmZlckV4cG9ydHMgPSAvKkBfX1BVUkVfXyovIHJlcXVpcmVCdWZmZXIoKTsKCglmdW5jdGlvbiBhbnVtYmVyJDEobikgewoJICAgIGlmICghTnVtYmVyLmlzU2FmZUludGVnZXIobikgfHwgbiA8IDApCgkgICAgICAgIHRocm93IG5ldyBFcnJvcigncG9zaXRpdmUgaW50ZWdlciBleHBlY3RlZCwgZ290ICcgKyBuKTsKCX0KCS8vIGNvcGllZCBmcm9tIHV0aWxzCglmdW5jdGlvbiBpc0J5dGVzJDIoYSkgewoJICAgIHJldHVybiBhIGluc3RhbmNlb2YgVWludDhBcnJheSB8fCAoQXJyYXlCdWZmZXIuaXNWaWV3KGEpICYmIGEuY29uc3RydWN0b3IubmFtZSA9PT0gJ1VpbnQ4QXJyYXknKTsKCX0KCWZ1bmN0aW9uIGFieXRlcyQyKGIsIC4uLmxlbmd0aHMpIHsKCSAgICBpZiAoIWlzQnl0ZXMkMihiKSkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVaW50OEFycmF5IGV4cGVjdGVkJyk7CgkgICAgaWYgKGxlbmd0aHMubGVuZ3RoID4gMCAmJiAhbGVuZ3Rocy5pbmNsdWRlcyhiLmxlbmd0aCkpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcignVWludDhBcnJheSBleHBlY3RlZCBvZiBsZW5ndGggJyArIGxlbmd0aHMgKyAnLCBnb3QgbGVuZ3RoPScgKyBiLmxlbmd0aCk7Cgl9CglmdW5jdGlvbiBhaGFzaChoKSB7CgkgICAgaWYgKHR5cGVvZiBoICE9PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBoLmNyZWF0ZSAhPT0gJ2Z1bmN0aW9uJykKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdIYXNoIHNob3VsZCBiZSB3cmFwcGVkIGJ5IHV0aWxzLndyYXBDb25zdHJ1Y3RvcicpOwoJICAgIGFudW1iZXIkMShoLm91dHB1dExlbik7CgkgICAgYW51bWJlciQxKGguYmxvY2tMZW4pOwoJfQoJZnVuY3Rpb24gYWV4aXN0cyQxKGluc3RhbmNlLCBjaGVja0ZpbmlzaGVkID0gdHJ1ZSkgewoJICAgIGlmIChpbnN0YW5jZS5kZXN0cm95ZWQpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcignSGFzaCBpbnN0YW5jZSBoYXMgYmVlbiBkZXN0cm95ZWQnKTsKCSAgICBpZiAoY2hlY2tGaW5pc2hlZCAmJiBpbnN0YW5jZS5maW5pc2hlZCkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdIYXNoI2RpZ2VzdCgpIGhhcyBhbHJlYWR5IGJlZW4gY2FsbGVkJyk7Cgl9CglmdW5jdGlvbiBhb3V0cHV0JDEob3V0LCBpbnN0YW5jZSkgewoJICAgIGFieXRlcyQyKG91dCk7CgkgICAgY29uc3QgbWluID0gaW5zdGFuY2Uub3V0cHV0TGVuOwoJICAgIGlmIChvdXQubGVuZ3RoIDwgbWluKSB7CgkgICAgICAgIHRocm93IG5ldyBFcnJvcignZGlnZXN0SW50bygpIGV4cGVjdHMgb3V0cHV0IGJ1ZmZlciBvZiBsZW5ndGggYXQgbGVhc3QgJyArIG1pbik7CgkgICAgfQoJfQoKCWNvbnN0IGNyeXB0byQxID0gdHlwZW9mIGdsb2JhbFRoaXMgPT09ICdvYmplY3QnICYmICdjcnlwdG8nIGluIGdsb2JhbFRoaXMgPyBnbG9iYWxUaGlzLmNyeXB0byA6IHVuZGVmaW5lZDsKCgkvKiEgbm9ibGUtaGFzaGVzIC0gTUlUIExpY2Vuc2UgKGMpIDIwMjIgUGF1bCBNaWxsZXIgKHBhdWxtaWxsci5jb20pICovCgkvLyBXZSB1c2UgV2ViQ3J5cHRvIGFrYSBnbG9iYWxUaGlzLmNyeXB0bywgd2hpY2ggZXhpc3RzIGluIGJyb3dzZXJzIGFuZCBub2RlLmpzIDE2Ky4KCS8vIG5vZGUuanMgdmVyc2lvbnMgZWFybGllciB0aGFuIHYxOSBkb24ndCBkZWNsYXJlIGl0IGluIGdsb2JhbCBzY29wZS4KCS8vIEZvciBub2RlLmpzLCBwYWNrYWdlLmpzb24jZXhwb3J0cyBmaWVsZCBtYXBwaW5nIHJld3JpdGVzIGltcG9ydAoJLy8gZnJvbSBgY3J5cHRvYCB0byBgY3J5cHRvTm9kZWAsIHdoaWNoIGltcG9ydHMgbmF0aXZlIG1vZHVsZS4KCS8vIE1ha2VzIHRoZSB1dGlscyB1bi1pbXBvcnRhYmxlIGluIGJyb3dzZXJzIHdpdGhvdXQgYSBidW5kbGVyLgoJLy8gT25jZSBub2RlLmpzIDE4IGlzIGRlcHJlY2F0ZWQgKDIwMjUtMDQtMzApLCB3ZSBjYW4ganVzdCBkcm9wIHRoZSBpbXBvcnQuCgkvLyBDYXN0IGFycmF5IHRvIHZpZXcKCWNvbnN0IGNyZWF0ZVZpZXckMSA9IChhcnIpID0+IG5ldyBEYXRhVmlldyhhcnIuYnVmZmVyLCBhcnIuYnl0ZU9mZnNldCwgYXJyLmJ5dGVMZW5ndGgpOwoJLy8gVGhlIHJvdGF0ZSByaWdodCAoY2lyY3VsYXIgcmlnaHQgc2hpZnQpIG9wZXJhdGlvbiBmb3IgdWludDMyCgljb25zdCByb3RyJDEgPSAod29yZCwgc2hpZnQpID0+ICh3b3JkIDw8ICgzMiAtIHNoaWZ0KSkgfCAod29yZCA+Pj4gc2hpZnQpOwoJLyoqCgkgKiBAZXhhbXBsZSB1dGY4VG9CeXRlcygnYWJjJykgLy8gbmV3IFVpbnQ4QXJyYXkoWzk3LCA5OCwgOTldKQoJICovCglmdW5jdGlvbiB1dGY4VG9CeXRlcyQyKHN0cikgewoJICAgIGlmICh0eXBlb2Ygc3RyICE9PSAnc3RyaW5nJykKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd1dGY4VG9CeXRlcyBleHBlY3RlZCBzdHJpbmcsIGdvdCAnICsgdHlwZW9mIHN0cik7CgkgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShzdHIpKTsgLy8gaHR0cHM6Ly9idWd6aWwubGEvMTY4MTgwOQoJfQoJLyoqCgkgKiBOb3JtYWxpemVzIChub24taGV4KSBzdHJpbmcgb3IgVWludDhBcnJheSB0byBVaW50OEFycmF5LgoJICogV2FybmluZzogd2hlbiBVaW50OEFycmF5IGlzIHBhc3NlZCwgaXQgd291bGQgTk9UIGdldCBjb3BpZWQuCgkgKiBLZWVwIGluIG1pbmQgZm9yIGZ1dHVyZSBtdXRhYmxlIG9wZXJhdGlvbnMuCgkgKi8KCWZ1bmN0aW9uIHRvQnl0ZXMkMShkYXRhKSB7CgkgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykKCSAgICAgICAgZGF0YSA9IHV0ZjhUb0J5dGVzJDIoZGF0YSk7CgkgICAgYWJ5dGVzJDIoZGF0YSk7CgkgICAgcmV0dXJuIGRhdGE7Cgl9CgkvKioKCSAqIENvcGllcyBzZXZlcmFsIFVpbnQ4QXJyYXlzIGludG8gb25lLgoJICovCglmdW5jdGlvbiBjb25jYXRCeXRlcyQxKC4uLmFycmF5cykgewoJICAgIGxldCBzdW0gPSAwOwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXlzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGNvbnN0IGEgPSBhcnJheXNbaV07CgkgICAgICAgIGFieXRlcyQyKGEpOwoJICAgICAgICBzdW0gKz0gYS5sZW5ndGg7CgkgICAgfQoJICAgIGNvbnN0IHJlcyA9IG5ldyBVaW50OEFycmF5KHN1bSk7CgkgICAgZm9yIChsZXQgaSA9IDAsIHBhZCA9IDA7IGkgPCBhcnJheXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgY29uc3QgYSA9IGFycmF5c1tpXTsKCSAgICAgICAgcmVzLnNldChhLCBwYWQpOwoJICAgICAgICBwYWQgKz0gYS5sZW5ndGg7CgkgICAgfQoJICAgIHJldHVybiByZXM7Cgl9CgkvLyBGb3IgcnVudGltZSBjaGVjayBpZiBjbGFzcyBpbXBsZW1lbnRzIGludGVyZmFjZQoJbGV0IEhhc2gkMSA9IGNsYXNzIEhhc2ggewoJICAgIC8vIFNhZmUgdmVyc2lvbiB0aGF0IGNsb25lcyBpbnRlcm5hbCBzdGF0ZQoJICAgIGNsb25lKCkgewoJICAgICAgICByZXR1cm4gdGhpcy5fY2xvbmVJbnRvKCk7CgkgICAgfQoJfTsKCWZ1bmN0aW9uIHdyYXBDb25zdHJ1Y3RvciQxKGhhc2hDb25zKSB7CgkgICAgY29uc3QgaGFzaEMgPSAobXNnKSA9PiBoYXNoQ29ucygpLnVwZGF0ZSh0b0J5dGVzJDEobXNnKSkuZGlnZXN0KCk7CgkgICAgY29uc3QgdG1wID0gaGFzaENvbnMoKTsKCSAgICBoYXNoQy5vdXRwdXRMZW4gPSB0bXAub3V0cHV0TGVuOwoJICAgIGhhc2hDLmJsb2NrTGVuID0gdG1wLmJsb2NrTGVuOwoJICAgIGhhc2hDLmNyZWF0ZSA9ICgpID0+IGhhc2hDb25zKCk7CgkgICAgcmV0dXJuIGhhc2hDOwoJfQoJLyoqCgkgKiBTZWN1cmUgUFJORy4gVXNlcyBgY3J5cHRvLmdldFJhbmRvbVZhbHVlc2AsIHdoaWNoIGRlZmVycyB0byBPUy4KCSAqLwoJZnVuY3Rpb24gcmFuZG9tQnl0ZXMoYnl0ZXNMZW5ndGggPSAzMikgewoJICAgIGlmIChjcnlwdG8kMSAmJiB0eXBlb2YgY3J5cHRvJDEuZ2V0UmFuZG9tVmFsdWVzID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIHJldHVybiBjcnlwdG8kMS5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQ4QXJyYXkoYnl0ZXNMZW5ndGgpKTsKCSAgICB9CgkgICAgLy8gTGVnYWN5IE5vZGUuanMgY29tcGF0aWJpbGl0eQoJICAgIGlmIChjcnlwdG8kMSAmJiB0eXBlb2YgY3J5cHRvJDEucmFuZG9tQnl0ZXMgPT09ICdmdW5jdGlvbicpIHsKCSAgICAgICAgcmV0dXJuIGNyeXB0byQxLnJhbmRvbUJ5dGVzKGJ5dGVzTGVuZ3RoKTsKCSAgICB9CgkgICAgdGhyb3cgbmV3IEVycm9yKCdjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzIG11c3QgYmUgZGVmaW5lZCcpOwoJfQoKCS8qKgoJICogUG9seWZpbGwgZm9yIFNhZmFyaSAxNAoJICovCglmdW5jdGlvbiBzZXRCaWdVaW50NjQkMSh2aWV3LCBieXRlT2Zmc2V0LCB2YWx1ZSwgaXNMRSkgewoJICAgIGlmICh0eXBlb2Ygdmlldy5zZXRCaWdVaW50NjQgPT09ICdmdW5jdGlvbicpCgkgICAgICAgIHJldHVybiB2aWV3LnNldEJpZ1VpbnQ2NChieXRlT2Zmc2V0LCB2YWx1ZSwgaXNMRSk7CgkgICAgY29uc3QgXzMybiA9IEJpZ0ludCgzMik7CgkgICAgY29uc3QgX3UzMl9tYXggPSBCaWdJbnQoMHhmZmZmZmZmZik7CgkgICAgY29uc3Qgd2ggPSBOdW1iZXIoKHZhbHVlID4+IF8zMm4pICYgX3UzMl9tYXgpOwoJICAgIGNvbnN0IHdsID0gTnVtYmVyKHZhbHVlICYgX3UzMl9tYXgpOwoJICAgIGNvbnN0IGggPSBpc0xFID8gNCA6IDA7CgkgICAgY29uc3QgbCA9IGlzTEUgPyAwIDogNDsKCSAgICB2aWV3LnNldFVpbnQzMihieXRlT2Zmc2V0ICsgaCwgd2gsIGlzTEUpOwoJICAgIHZpZXcuc2V0VWludDMyKGJ5dGVPZmZzZXQgKyBsLCB3bCwgaXNMRSk7Cgl9CgkvKioKCSAqIENob2ljZTogYSA/IGIgOiBjCgkgKi8KCWNvbnN0IENoaSQxID0gKGEsIGIsIGMpID0+IChhICYgYikgXiAofmEgJiBjKTsKCS8qKgoJICogTWFqb3JpdHkgZnVuY3Rpb24sIHRydWUgaWYgYW55IHR3byBpbnB1dHMgaXMgdHJ1ZQoJICovCgljb25zdCBNYWokMSA9IChhLCBiLCBjKSA9PiAoYSAmIGIpIF4gKGEgJiBjKSBeIChiICYgYyk7CgkvKioKCSAqIE1lcmtsZS1EYW1nYXJkIGhhc2ggY29uc3RydWN0aW9uIGJhc2UgY2xhc3MuCgkgKiBDb3VsZCBiZSB1c2VkIHRvIGNyZWF0ZSBNRDUsIFJJUEVNRCwgU0hBMSwgU0hBMi4KCSAqLwoJbGV0IEhhc2hNRCQxID0gY2xhc3MgSGFzaE1EIGV4dGVuZHMgSGFzaCQxIHsKCSAgICBjb25zdHJ1Y3RvcihibG9ja0xlbiwgb3V0cHV0TGVuLCBwYWRPZmZzZXQsIGlzTEUpIHsKCSAgICAgICAgc3VwZXIoKTsKCSAgICAgICAgdGhpcy5ibG9ja0xlbiA9IGJsb2NrTGVuOwoJICAgICAgICB0aGlzLm91dHB1dExlbiA9IG91dHB1dExlbjsKCSAgICAgICAgdGhpcy5wYWRPZmZzZXQgPSBwYWRPZmZzZXQ7CgkgICAgICAgIHRoaXMuaXNMRSA9IGlzTEU7CgkgICAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKCSAgICAgICAgdGhpcy5sZW5ndGggPSAwOwoJICAgICAgICB0aGlzLnBvcyA9IDA7CgkgICAgICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2U7CgkgICAgICAgIHRoaXMuYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoYmxvY2tMZW4pOwoJICAgICAgICB0aGlzLnZpZXcgPSBjcmVhdGVWaWV3JDEodGhpcy5idWZmZXIpOwoJICAgIH0KCSAgICB1cGRhdGUoZGF0YSkgewoJICAgICAgICBhZXhpc3RzJDEodGhpcyk7CgkgICAgICAgIGNvbnN0IHsgdmlldywgYnVmZmVyLCBibG9ja0xlbiB9ID0gdGhpczsKCSAgICAgICAgZGF0YSA9IHRvQnl0ZXMkMShkYXRhKTsKCSAgICAgICAgY29uc3QgbGVuID0gZGF0YS5sZW5ndGg7CgkgICAgICAgIGZvciAobGV0IHBvcyA9IDA7IHBvcyA8IGxlbjspIHsKCSAgICAgICAgICAgIGNvbnN0IHRha2UgPSBNYXRoLm1pbihibG9ja0xlbiAtIHRoaXMucG9zLCBsZW4gLSBwb3MpOwoJICAgICAgICAgICAgLy8gRmFzdCBwYXRoOiB3ZSBoYXZlIGF0IGxlYXN0IG9uZSBibG9jayBpbiBpbnB1dCwgY2FzdCBpdCB0byB2aWV3IGFuZCBwcm9jZXNzCgkgICAgICAgICAgICBpZiAodGFrZSA9PT0gYmxvY2tMZW4pIHsKCSAgICAgICAgICAgICAgICBjb25zdCBkYXRhVmlldyA9IGNyZWF0ZVZpZXckMShkYXRhKTsKCSAgICAgICAgICAgICAgICBmb3IgKDsgYmxvY2tMZW4gPD0gbGVuIC0gcG9zOyBwb3MgKz0gYmxvY2tMZW4pCgkgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2VzcyhkYXRhVmlldywgcG9zKTsKCSAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGJ1ZmZlci5zZXQoZGF0YS5zdWJhcnJheShwb3MsIHBvcyArIHRha2UpLCB0aGlzLnBvcyk7CgkgICAgICAgICAgICB0aGlzLnBvcyArPSB0YWtlOwoJICAgICAgICAgICAgcG9zICs9IHRha2U7CgkgICAgICAgICAgICBpZiAodGhpcy5wb3MgPT09IGJsb2NrTGVuKSB7CgkgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzKHZpZXcsIDApOwoJICAgICAgICAgICAgICAgIHRoaXMucG9zID0gMDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICB0aGlzLmxlbmd0aCArPSBkYXRhLmxlbmd0aDsKCSAgICAgICAgdGhpcy5yb3VuZENsZWFuKCk7CgkgICAgICAgIHJldHVybiB0aGlzOwoJICAgIH0KCSAgICBkaWdlc3RJbnRvKG91dCkgewoJICAgICAgICBhZXhpc3RzJDEodGhpcyk7CgkgICAgICAgIGFvdXRwdXQkMShvdXQsIHRoaXMpOwoJICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKCSAgICAgICAgLy8gUGFkZGluZwoJICAgICAgICAvLyBXZSBjYW4gYXZvaWQgYWxsb2NhdGlvbiBvZiBidWZmZXIgZm9yIHBhZGRpbmcgY29tcGxldGVseSBpZiBpdAoJICAgICAgICAvLyB3YXMgcHJldmlvdXNseSBub3QgYWxsb2NhdGVkIGhlcmUuIEJ1dCBpdCB3b24ndCBjaGFuZ2UgcGVyZm9ybWFuY2UuCgkgICAgICAgIGNvbnN0IHsgYnVmZmVyLCB2aWV3LCBibG9ja0xlbiwgaXNMRSB9ID0gdGhpczsKCSAgICAgICAgbGV0IHsgcG9zIH0gPSB0aGlzOwoJICAgICAgICAvLyBhcHBlbmQgdGhlIGJpdCAnMScgdG8gdGhlIG1lc3NhZ2UKCSAgICAgICAgYnVmZmVyW3BvcysrXSA9IDBiMTAwMDAwMDA7CgkgICAgICAgIHRoaXMuYnVmZmVyLnN1YmFycmF5KHBvcykuZmlsbCgwKTsKCSAgICAgICAgLy8gd2UgaGF2ZSBsZXNzIHRoYW4gcGFkT2Zmc2V0IGxlZnQgaW4gYnVmZmVyLCBzbyB3ZSBjYW5ub3QgcHV0IGxlbmd0aCBpbgoJICAgICAgICAvLyBjdXJyZW50IGJsb2NrLCBuZWVkIHByb2Nlc3MgaXQgYW5kIHBhZCBhZ2FpbgoJICAgICAgICBpZiAodGhpcy5wYWRPZmZzZXQgPiBibG9ja0xlbiAtIHBvcykgewoJICAgICAgICAgICAgdGhpcy5wcm9jZXNzKHZpZXcsIDApOwoJICAgICAgICAgICAgcG9zID0gMDsKCSAgICAgICAgfQoJICAgICAgICAvLyBQYWQgdW50aWwgZnVsbCBibG9jayBieXRlIHdpdGggemVyb3MKCSAgICAgICAgZm9yIChsZXQgaSA9IHBvczsgaSA8IGJsb2NrTGVuOyBpKyspCgkgICAgICAgICAgICBidWZmZXJbaV0gPSAwOwoJICAgICAgICAvLyBOb3RlOiBzaGE1MTIgcmVxdWlyZXMgbGVuZ3RoIHRvIGJlIDEyOGJpdCBpbnRlZ2VyLCBidXQgbGVuZ3RoIGluIEpTIHdpbGwgb3ZlcmZsb3cgYmVmb3JlIHRoYXQKCSAgICAgICAgLy8gWW91IG5lZWQgdG8gd3JpdGUgYXJvdW5kIDIgZXhhYnl0ZXMgKHU2NF9tYXggLyA4IC8gKDEwMjQqKjYpKSBmb3IgdGhpcyB0byBoYXBwZW4uCgkgICAgICAgIC8vIFNvIHdlIGp1c3Qgd3JpdGUgbG93ZXN0IDY0IGJpdHMgb2YgdGhhdCB2YWx1ZS4KCSAgICAgICAgc2V0QmlnVWludDY0JDEodmlldywgYmxvY2tMZW4gLSA4LCBCaWdJbnQodGhpcy5sZW5ndGggKiA4KSwgaXNMRSk7CgkgICAgICAgIHRoaXMucHJvY2Vzcyh2aWV3LCAwKTsKCSAgICAgICAgY29uc3Qgb3ZpZXcgPSBjcmVhdGVWaWV3JDEob3V0KTsKCSAgICAgICAgY29uc3QgbGVuID0gdGhpcy5vdXRwdXRMZW47CgkgICAgICAgIC8vIE5PVEU6IHdlIGRvIGRpdmlzaW9uIGJ5IDQgbGF0ZXIsIHdoaWNoIHNob3VsZCBiZSBmdXNlZCBpbiBzaW5nbGUgb3Agd2l0aCBtb2R1bG8gYnkgSklUCgkgICAgICAgIGlmIChsZW4gJSA0KQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdfc2hhMjogb3V0cHV0TGVuIHNob3VsZCBiZSBhbGlnbmVkIHRvIDMyYml0Jyk7CgkgICAgICAgIGNvbnN0IG91dExlbiA9IGxlbiAvIDQ7CgkgICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5nZXQoKTsKCSAgICAgICAgaWYgKG91dExlbiA+IHN0YXRlLmxlbmd0aCkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignX3NoYTI6IG91dHB1dExlbiBiaWdnZXIgdGhhbiBzdGF0ZScpOwoJICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG91dExlbjsgaSsrKQoJICAgICAgICAgICAgb3ZpZXcuc2V0VWludDMyKDQgKiBpLCBzdGF0ZVtpXSwgaXNMRSk7CgkgICAgfQoJICAgIGRpZ2VzdCgpIHsKCSAgICAgICAgY29uc3QgeyBidWZmZXIsIG91dHB1dExlbiB9ID0gdGhpczsKCSAgICAgICAgdGhpcy5kaWdlc3RJbnRvKGJ1ZmZlcik7CgkgICAgICAgIGNvbnN0IHJlcyA9IGJ1ZmZlci5zbGljZSgwLCBvdXRwdXRMZW4pOwoJICAgICAgICB0aGlzLmRlc3Ryb3koKTsKCSAgICAgICAgcmV0dXJuIHJlczsKCSAgICB9CgkgICAgX2Nsb25lSW50byh0bykgewoJICAgICAgICB0byB8fCAodG8gPSBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpKTsKCSAgICAgICAgdG8uc2V0KC4uLnRoaXMuZ2V0KCkpOwoJICAgICAgICBjb25zdCB7IGJsb2NrTGVuLCBidWZmZXIsIGxlbmd0aCwgZmluaXNoZWQsIGRlc3Ryb3llZCwgcG9zIH0gPSB0aGlzOwoJICAgICAgICB0by5sZW5ndGggPSBsZW5ndGg7CgkgICAgICAgIHRvLnBvcyA9IHBvczsKCSAgICAgICAgdG8uZmluaXNoZWQgPSBmaW5pc2hlZDsKCSAgICAgICAgdG8uZGVzdHJveWVkID0gZGVzdHJveWVkOwoJICAgICAgICBpZiAobGVuZ3RoICUgYmxvY2tMZW4pCgkgICAgICAgICAgICB0by5idWZmZXIuc2V0KGJ1ZmZlcik7CgkgICAgICAgIHJldHVybiB0bzsKCSAgICB9Cgl9OwoKCWNvbnN0IFUzMl9NQVNLNjQkMSA9IC8qIEBfX1BVUkVfXyAqLyBCaWdJbnQoMiAqKiAzMiAtIDEpOwoJY29uc3QgXzMybiQxID0gLyogQF9fUFVSRV9fICovIEJpZ0ludCgzMik7CgkvLyBCaWdVaW50NjRBcnJheSBpcyB0b28gc2xvdyBhcyBwZXIgMjAyNCwgc28gd2UgaW1wbGVtZW50IGl0IHVzaW5nIFVpbnQzMkFycmF5LgoJLy8gVE9ETzogcmUtY2hlY2sgaHR0cHM6Ly9pc3N1ZXMuY2hyb21pdW0ub3JnL2lzc3Vlcy80MjIxMjU4OAoJZnVuY3Rpb24gZnJvbUJpZyQxKG4sIGxlID0gZmFsc2UpIHsKCSAgICBpZiAobGUpCgkgICAgICAgIHJldHVybiB7IGg6IE51bWJlcihuICYgVTMyX01BU0s2NCQxKSwgbDogTnVtYmVyKChuID4+IF8zMm4kMSkgJiBVMzJfTUFTSzY0JDEpIH07CgkgICAgcmV0dXJuIHsgaDogTnVtYmVyKChuID4+IF8zMm4kMSkgJiBVMzJfTUFTSzY0JDEpIHwgMCwgbDogTnVtYmVyKG4gJiBVMzJfTUFTSzY0JDEpIHwgMCB9OwoJfQoJZnVuY3Rpb24gc3BsaXQkMShsc3QsIGxlID0gZmFsc2UpIHsKCSAgICBsZXQgQWggPSBuZXcgVWludDMyQXJyYXkobHN0Lmxlbmd0aCk7CgkgICAgbGV0IEFsID0gbmV3IFVpbnQzMkFycmF5KGxzdC5sZW5ndGgpOwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbHN0Lmxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGNvbnN0IHsgaCwgbCB9ID0gZnJvbUJpZyQxKGxzdFtpXSwgbGUpOwoJICAgICAgICBbQWhbaV0sIEFsW2ldXSA9IFtoLCBsXTsKCSAgICB9CgkgICAgcmV0dXJuIFtBaCwgQWxdOwoJfQoJY29uc3QgdG9CaWcgPSAoaCwgbCkgPT4gKEJpZ0ludChoID4+PiAwKSA8PCBfMzJuJDEpIHwgQmlnSW50KGwgPj4+IDApOwoJLy8gZm9yIFNoaWZ0IGluIFswLCAzMikKCWNvbnN0IHNoclNIID0gKGgsIF9sLCBzKSA9PiBoID4+PiBzOwoJY29uc3Qgc2hyU0wgPSAoaCwgbCwgcykgPT4gKGggPDwgKDMyIC0gcykpIHwgKGwgPj4+IHMpOwoJLy8gUmlnaHQgcm90YXRlIGZvciBTaGlmdCBpbiBbMSwgMzIpCgljb25zdCByb3RyU0ggPSAoaCwgbCwgcykgPT4gKGggPj4+IHMpIHwgKGwgPDwgKDMyIC0gcykpOwoJY29uc3Qgcm90clNMID0gKGgsIGwsIHMpID0+IChoIDw8ICgzMiAtIHMpKSB8IChsID4+PiBzKTsKCS8vIFJpZ2h0IHJvdGF0ZSBmb3IgU2hpZnQgaW4gKDMyLCA2NCksIE5PVEU6IDMyIGlzIHNwZWNpYWwgY2FzZS4KCWNvbnN0IHJvdHJCSCA9IChoLCBsLCBzKSA9PiAoaCA8PCAoNjQgLSBzKSkgfCAobCA+Pj4gKHMgLSAzMikpOwoJY29uc3Qgcm90ckJMID0gKGgsIGwsIHMpID0+IChoID4+PiAocyAtIDMyKSkgfCAobCA8PCAoNjQgLSBzKSk7CgkvLyBSaWdodCByb3RhdGUgZm9yIHNoaWZ0PT09MzIgKGp1c3Qgc3dhcHMgbCZoKQoJY29uc3Qgcm90cjMySCA9IChfaCwgbCkgPT4gbDsKCWNvbnN0IHJvdHIzMkwgPSAoaCwgX2wpID0+IGg7CgkvLyBMZWZ0IHJvdGF0ZSBmb3IgU2hpZnQgaW4gWzEsIDMyKQoJY29uc3Qgcm90bFNIJDEgPSAoaCwgbCwgcykgPT4gKGggPDwgcykgfCAobCA+Pj4gKDMyIC0gcykpOwoJY29uc3Qgcm90bFNMJDEgPSAoaCwgbCwgcykgPT4gKGwgPDwgcykgfCAoaCA+Pj4gKDMyIC0gcykpOwoJLy8gTGVmdCByb3RhdGUgZm9yIFNoaWZ0IGluICgzMiwgNjQpLCBOT1RFOiAzMiBpcyBzcGVjaWFsIGNhc2UuCgljb25zdCByb3RsQkgkMSA9IChoLCBsLCBzKSA9PiAobCA8PCAocyAtIDMyKSkgfCAoaCA+Pj4gKDY0IC0gcykpOwoJY29uc3Qgcm90bEJMJDEgPSAoaCwgbCwgcykgPT4gKGggPDwgKHMgLSAzMikpIHwgKGwgPj4+ICg2NCAtIHMpKTsKCS8vIEpTIHVzZXMgMzItYml0IHNpZ25lZCBpbnRlZ2VycyBmb3IgYml0d2lzZSBvcGVyYXRpb25zIHdoaWNoIG1lYW5zIHdlIGNhbm5vdAoJLy8gc2ltcGxlIHRha2UgY2Fycnkgb3V0IG9mIGxvdyBiaXQgc3VtIGJ5IHNoaWZ0LCB3ZSBuZWVkIHRvIHVzZSBkaXZpc2lvbi4KCWZ1bmN0aW9uIGFkZChBaCwgQWwsIEJoLCBCbCkgewoJICAgIGNvbnN0IGwgPSAoQWwgPj4+IDApICsgKEJsID4+PiAwKTsKCSAgICByZXR1cm4geyBoOiAoQWggKyBCaCArICgobCAvIDIgKiogMzIpIHwgMCkpIHwgMCwgbDogbCB8IDAgfTsKCX0KCS8vIEFkZGl0aW9uIHdpdGggbW9yZSB0aGFuIDIgZWxlbWVudHMKCWNvbnN0IGFkZDNMID0gKEFsLCBCbCwgQ2wpID0+IChBbCA+Pj4gMCkgKyAoQmwgPj4+IDApICsgKENsID4+PiAwKTsKCWNvbnN0IGFkZDNIID0gKGxvdywgQWgsIEJoLCBDaCkgPT4gKEFoICsgQmggKyBDaCArICgobG93IC8gMiAqKiAzMikgfCAwKSkgfCAwOwoJY29uc3QgYWRkNEwgPSAoQWwsIEJsLCBDbCwgRGwpID0+IChBbCA+Pj4gMCkgKyAoQmwgPj4+IDApICsgKENsID4+PiAwKSArIChEbCA+Pj4gMCk7Cgljb25zdCBhZGQ0SCA9IChsb3csIEFoLCBCaCwgQ2gsIERoKSA9PiAoQWggKyBCaCArIENoICsgRGggKyAoKGxvdyAvIDIgKiogMzIpIHwgMCkpIHwgMDsKCWNvbnN0IGFkZDVMID0gKEFsLCBCbCwgQ2wsIERsLCBFbCkgPT4gKEFsID4+PiAwKSArIChCbCA+Pj4gMCkgKyAoQ2wgPj4+IDApICsgKERsID4+PiAwKSArIChFbCA+Pj4gMCk7Cgljb25zdCBhZGQ1SCA9IChsb3csIEFoLCBCaCwgQ2gsIERoLCBFaCkgPT4gKEFoICsgQmggKyBDaCArIERoICsgRWggKyAoKGxvdyAvIDIgKiogMzIpIHwgMCkpIHwgMDsKCS8vIHByZXR0aWVyLWlnbm9yZQoJY29uc3QgdTY0JDEgPSB7CgkgICAgZnJvbUJpZzogZnJvbUJpZyQxLCBzcGxpdDogc3BsaXQkMSwgdG9CaWcsCgkgICAgc2hyU0gsIHNoclNMLAoJICAgIHJvdHJTSCwgcm90clNMLCByb3RyQkgsIHJvdHJCTCwKCSAgICByb3RyMzJILCByb3RyMzJMLAoJICAgIHJvdGxTSDogcm90bFNIJDEsIHJvdGxTTDogcm90bFNMJDEsIHJvdGxCSDogcm90bEJIJDEsIHJvdGxCTDogcm90bEJMJDEsCgkgICAgYWRkLCBhZGQzTCwgYWRkM0gsIGFkZDRMLCBhZGQ0SCwgYWRkNUgsIGFkZDVMLAoJfTsKCgkvLyBSb3VuZCBjb250YW50cyAoZmlyc3QgMzIgYml0cyBvZiB0aGUgZnJhY3Rpb25hbCBwYXJ0cyBvZiB0aGUgY3ViZSByb290cyBvZiB0aGUgZmlyc3QgODAgcHJpbWVzIDIuLjQwOSk6CgkvLyBwcmV0dGllci1pZ25vcmUKCWNvbnN0IFtTSEE1MTJfS2gsIFNIQTUxMl9LbF0gPSAvKiBAX19QVVJFX18gKi8gKCgpID0+IHU2NCQxLnNwbGl0KFsKCSAgICAnMHg0MjhhMmY5OGQ3MjhhZTIyJywgJzB4NzEzNzQ0OTEyM2VmNjVjZCcsICcweGI1YzBmYmNmZWM0ZDNiMmYnLCAnMHhlOWI1ZGJhNTgxODlkYmJjJywKCSAgICAnMHgzOTU2YzI1YmYzNDhiNTM4JywgJzB4NTlmMTExZjFiNjA1ZDAxOScsICcweDkyM2Y4MmE0YWYxOTRmOWInLCAnMHhhYjFjNWVkNWRhNmQ4MTE4JywKCSAgICAnMHhkODA3YWE5OGEzMDMwMjQyJywgJzB4MTI4MzViMDE0NTcwNmZiZScsICcweDI0MzE4NWJlNGVlNGIyOGMnLCAnMHg1NTBjN2RjM2Q1ZmZiNGUyJywKCSAgICAnMHg3MmJlNWQ3NGYyN2I4OTZmJywgJzB4ODBkZWIxZmUzYjE2OTZiMScsICcweDliZGMwNmE3MjVjNzEyMzUnLCAnMHhjMTliZjE3NGNmNjkyNjk0JywKCSAgICAnMHhlNDliNjljMTllZjE0YWQyJywgJzB4ZWZiZTQ3ODYzODRmMjVlMycsICcweDBmYzE5ZGM2OGI4Y2Q1YjUnLCAnMHgyNDBjYTFjYzc3YWM5YzY1JywKCSAgICAnMHgyZGU5MmM2ZjU5MmIwMjc1JywgJzB4NGE3NDg0YWE2ZWE2ZTQ4MycsICcweDVjYjBhOWRjYmQ0MWZiZDQnLCAnMHg3NmY5ODhkYTgzMTE1M2I1JywKCSAgICAnMHg5ODNlNTE1MmVlNjZkZmFiJywgJzB4YTgzMWM2NmQyZGI0MzIxMCcsICcweGIwMDMyN2M4OThmYjIxM2YnLCAnMHhiZjU5N2ZjN2JlZWYwZWU0JywKCSAgICAnMHhjNmUwMGJmMzNkYTg4ZmMyJywgJzB4ZDVhNzkxNDc5MzBhYTcyNScsICcweDA2Y2E2MzUxZTAwMzgyNmYnLCAnMHgxNDI5Mjk2NzBhMGU2ZTcwJywKCSAgICAnMHgyN2I3MGE4NTQ2ZDIyZmZjJywgJzB4MmUxYjIxMzg1YzI2YzkyNicsICcweDRkMmM2ZGZjNWFjNDJhZWQnLCAnMHg1MzM4MGQxMzlkOTViM2RmJywKCSAgICAnMHg2NTBhNzM1NDhiYWY2M2RlJywgJzB4NzY2YTBhYmIzYzc3YjJhOCcsICcweDgxYzJjOTJlNDdlZGFlZTYnLCAnMHg5MjcyMmM4NTE0ODIzNTNiJywKCSAgICAnMHhhMmJmZThhMTRjZjEwMzY0JywgJzB4YTgxYTY2NGJiYzQyMzAwMScsICcweGMyNGI4YjcwZDBmODk3OTEnLCAnMHhjNzZjNTFhMzA2NTRiZTMwJywKCSAgICAnMHhkMTkyZTgxOWQ2ZWY1MjE4JywgJzB4ZDY5OTA2MjQ1NTY1YTkxMCcsICcweGY0MGUzNTg1NTc3MTIwMmEnLCAnMHgxMDZhYTA3MDMyYmJkMWI4JywKCSAgICAnMHgxOWE0YzExNmI4ZDJkMGM4JywgJzB4MWUzNzZjMDg1MTQxYWI1MycsICcweDI3NDg3NzRjZGY4ZWViOTknLCAnMHgzNGIwYmNiNWUxOWI0OGE4JywKCSAgICAnMHgzOTFjMGNiM2M1Yzk1YTYzJywgJzB4NGVkOGFhNGFlMzQxOGFjYicsICcweDViOWNjYTRmNzc2M2UzNzMnLCAnMHg2ODJlNmZmM2Q2YjJiOGEzJywKCSAgICAnMHg3NDhmODJlZTVkZWZiMmZjJywgJzB4NzhhNTYzNmY0MzE3MmY2MCcsICcweDg0Yzg3ODE0YTFmMGFiNzInLCAnMHg4Y2M3MDIwODFhNjQzOWVjJywKCSAgICAnMHg5MGJlZmZmYTIzNjMxZTI4JywgJzB4YTQ1MDZjZWJkZTgyYmRlOScsICcweGJlZjlhM2Y3YjJjNjc5MTUnLCAnMHhjNjcxNzhmMmUzNzI1MzJiJywKCSAgICAnMHhjYTI3M2VjZWVhMjY2MTljJywgJzB4ZDE4NmI4YzcyMWMwYzIwNycsICcweGVhZGE3ZGQ2Y2RlMGViMWUnLCAnMHhmNTdkNGY3ZmVlNmVkMTc4JywKCSAgICAnMHgwNmYwNjdhYTcyMTc2ZmJhJywgJzB4MGE2MzdkYzVhMmM4OThhNicsICcweDExM2Y5ODA0YmVmOTBkYWUnLCAnMHgxYjcxMGIzNTEzMWM0NzFiJywKCSAgICAnMHgyOGRiNzdmNTIzMDQ3ZDg0JywgJzB4MzJjYWFiN2I0MGM3MjQ5MycsICcweDNjOWViZTBhMTVjOWJlYmMnLCAnMHg0MzFkNjdjNDljMTAwZDRjJywKCSAgICAnMHg0Y2M1ZDRiZWNiM2U0MmI2JywgJzB4NTk3ZjI5OWNmYzY1N2UyYScsICcweDVmY2I2ZmFiM2FkNmZhZWMnLCAnMHg2YzQ0MTk4YzRhNDc1ODE3JwoJXS5tYXAobiA9PiBCaWdJbnQobikpKSkoKTsKCS8vIFRlbXBvcmFyeSBidWZmZXIsIG5vdCB1c2VkIHRvIHN0b3JlIGFueXRoaW5nIGJldHdlZW4gcnVucwoJY29uc3QgU0hBNTEyX1dfSCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVWludDMyQXJyYXkoODApOwoJY29uc3QgU0hBNTEyX1dfTCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVWludDMyQXJyYXkoODApOwoJY2xhc3MgU0hBNTEyIGV4dGVuZHMgSGFzaE1EJDEgewoJICAgIGNvbnN0cnVjdG9yKCkgewoJICAgICAgICBzdXBlcigxMjgsIDY0LCAxNiwgZmFsc2UpOwoJICAgICAgICAvLyBXZSBjYW5ub3QgdXNlIGFycmF5IGhlcmUgc2luY2UgYXJyYXkgYWxsb3dzIGluZGV4aW5nIGJ5IHZhcmlhYmxlIHdoaWNoIG1lYW5zIG9wdGltaXplci9jb21waWxlciBjYW5ub3QgdXNlIHJlZ2lzdGVycy4KCSAgICAgICAgLy8gQWxzbyBsb29rcyBjbGVhbmVyIGFuZCBlYXNpZXIgdG8gdmVyaWZ5IHdpdGggc3BlYy4KCSAgICAgICAgLy8gSW5pdGlhbCBzdGF0ZSAoZmlyc3QgMzIgYml0cyBvZiB0aGUgZnJhY3Rpb25hbCBwYXJ0cyBvZiB0aGUgc3F1YXJlIHJvb3RzIG9mIHRoZSBmaXJzdCA4IHByaW1lcyAyLi4xOSk6CgkgICAgICAgIC8vIGggLS0gaGlnaCAzMiBiaXRzLCBsIC0tIGxvdyAzMiBiaXRzCgkgICAgICAgIHRoaXMuQWggPSAweDZhMDllNjY3IHwgMDsKCSAgICAgICAgdGhpcy5BbCA9IDB4ZjNiY2M5MDggfCAwOwoJICAgICAgICB0aGlzLkJoID0gMHhiYjY3YWU4NSB8IDA7CgkgICAgICAgIHRoaXMuQmwgPSAweDg0Y2FhNzNiIHwgMDsKCSAgICAgICAgdGhpcy5DaCA9IDB4M2M2ZWYzNzIgfCAwOwoJICAgICAgICB0aGlzLkNsID0gMHhmZTk0ZjgyYiB8IDA7CgkgICAgICAgIHRoaXMuRGggPSAweGE1NGZmNTNhIHwgMDsKCSAgICAgICAgdGhpcy5EbCA9IDB4NWYxZDM2ZjEgfCAwOwoJICAgICAgICB0aGlzLkVoID0gMHg1MTBlNTI3ZiB8IDA7CgkgICAgICAgIHRoaXMuRWwgPSAweGFkZTY4MmQxIHwgMDsKCSAgICAgICAgdGhpcy5GaCA9IDB4OWIwNTY4OGMgfCAwOwoJICAgICAgICB0aGlzLkZsID0gMHgyYjNlNmMxZiB8IDA7CgkgICAgICAgIHRoaXMuR2ggPSAweDFmODNkOWFiIHwgMDsKCSAgICAgICAgdGhpcy5HbCA9IDB4ZmI0MWJkNmIgfCAwOwoJICAgICAgICB0aGlzLkhoID0gMHg1YmUwY2QxOSB8IDA7CgkgICAgICAgIHRoaXMuSGwgPSAweDEzN2UyMTc5IHwgMDsKCSAgICB9CgkgICAgLy8gcHJldHRpZXItaWdub3JlCgkgICAgZ2V0KCkgewoJICAgICAgICBjb25zdCB7IEFoLCBBbCwgQmgsIEJsLCBDaCwgQ2wsIERoLCBEbCwgRWgsIEVsLCBGaCwgRmwsIEdoLCBHbCwgSGgsIEhsIH0gPSB0aGlzOwoJICAgICAgICByZXR1cm4gW0FoLCBBbCwgQmgsIEJsLCBDaCwgQ2wsIERoLCBEbCwgRWgsIEVsLCBGaCwgRmwsIEdoLCBHbCwgSGgsIEhsXTsKCSAgICB9CgkgICAgLy8gcHJldHRpZXItaWdub3JlCgkgICAgc2V0KEFoLCBBbCwgQmgsIEJsLCBDaCwgQ2wsIERoLCBEbCwgRWgsIEVsLCBGaCwgRmwsIEdoLCBHbCwgSGgsIEhsKSB7CgkgICAgICAgIHRoaXMuQWggPSBBaCB8IDA7CgkgICAgICAgIHRoaXMuQWwgPSBBbCB8IDA7CgkgICAgICAgIHRoaXMuQmggPSBCaCB8IDA7CgkgICAgICAgIHRoaXMuQmwgPSBCbCB8IDA7CgkgICAgICAgIHRoaXMuQ2ggPSBDaCB8IDA7CgkgICAgICAgIHRoaXMuQ2wgPSBDbCB8IDA7CgkgICAgICAgIHRoaXMuRGggPSBEaCB8IDA7CgkgICAgICAgIHRoaXMuRGwgPSBEbCB8IDA7CgkgICAgICAgIHRoaXMuRWggPSBFaCB8IDA7CgkgICAgICAgIHRoaXMuRWwgPSBFbCB8IDA7CgkgICAgICAgIHRoaXMuRmggPSBGaCB8IDA7CgkgICAgICAgIHRoaXMuRmwgPSBGbCB8IDA7CgkgICAgICAgIHRoaXMuR2ggPSBHaCB8IDA7CgkgICAgICAgIHRoaXMuR2wgPSBHbCB8IDA7CgkgICAgICAgIHRoaXMuSGggPSBIaCB8IDA7CgkgICAgICAgIHRoaXMuSGwgPSBIbCB8IDA7CgkgICAgfQoJICAgIHByb2Nlc3Modmlldywgb2Zmc2V0KSB7CgkgICAgICAgIC8vIEV4dGVuZCB0aGUgZmlyc3QgMTYgd29yZHMgaW50byB0aGUgcmVtYWluaW5nIDY0IHdvcmRzIHdbMTYuLjc5XSBvZiB0aGUgbWVzc2FnZSBzY2hlZHVsZSBhcnJheQoJICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyssIG9mZnNldCArPSA0KSB7CgkgICAgICAgICAgICBTSEE1MTJfV19IW2ldID0gdmlldy5nZXRVaW50MzIob2Zmc2V0KTsKCSAgICAgICAgICAgIFNIQTUxMl9XX0xbaV0gPSB2aWV3LmdldFVpbnQzMigob2Zmc2V0ICs9IDQpKTsKCSAgICAgICAgfQoJICAgICAgICBmb3IgKGxldCBpID0gMTY7IGkgPCA4MDsgaSsrKSB7CgkgICAgICAgICAgICAvLyBzMCA6PSAod1tpLTE1XSByaWdodHJvdGF0ZSAxKSB4b3IgKHdbaS0xNV0gcmlnaHRyb3RhdGUgOCkgeG9yICh3W2ktMTVdIHJpZ2h0c2hpZnQgNykKCSAgICAgICAgICAgIGNvbnN0IFcxNWggPSBTSEE1MTJfV19IW2kgLSAxNV0gfCAwOwoJICAgICAgICAgICAgY29uc3QgVzE1bCA9IFNIQTUxMl9XX0xbaSAtIDE1XSB8IDA7CgkgICAgICAgICAgICBjb25zdCBzMGggPSB1NjQkMS5yb3RyU0goVzE1aCwgVzE1bCwgMSkgXiB1NjQkMS5yb3RyU0goVzE1aCwgVzE1bCwgOCkgXiB1NjQkMS5zaHJTSChXMTVoLCBXMTVsLCA3KTsKCSAgICAgICAgICAgIGNvbnN0IHMwbCA9IHU2NCQxLnJvdHJTTChXMTVoLCBXMTVsLCAxKSBeIHU2NCQxLnJvdHJTTChXMTVoLCBXMTVsLCA4KSBeIHU2NCQxLnNoclNMKFcxNWgsIFcxNWwsIDcpOwoJICAgICAgICAgICAgLy8gczEgOj0gKHdbaS0yXSByaWdodHJvdGF0ZSAxOSkgeG9yICh3W2ktMl0gcmlnaHRyb3RhdGUgNjEpIHhvciAod1tpLTJdIHJpZ2h0c2hpZnQgNikKCSAgICAgICAgICAgIGNvbnN0IFcyaCA9IFNIQTUxMl9XX0hbaSAtIDJdIHwgMDsKCSAgICAgICAgICAgIGNvbnN0IFcybCA9IFNIQTUxMl9XX0xbaSAtIDJdIHwgMDsKCSAgICAgICAgICAgIGNvbnN0IHMxaCA9IHU2NCQxLnJvdHJTSChXMmgsIFcybCwgMTkpIF4gdTY0JDEucm90ckJIKFcyaCwgVzJsLCA2MSkgXiB1NjQkMS5zaHJTSChXMmgsIFcybCwgNik7CgkgICAgICAgICAgICBjb25zdCBzMWwgPSB1NjQkMS5yb3RyU0woVzJoLCBXMmwsIDE5KSBeIHU2NCQxLnJvdHJCTChXMmgsIFcybCwgNjEpIF4gdTY0JDEuc2hyU0woVzJoLCBXMmwsIDYpOwoJICAgICAgICAgICAgLy8gU0hBMjU2X1dbaV0gPSBzMCArIHMxICsgU0hBMjU2X1dbaSAtIDddICsgU0hBMjU2X1dbaSAtIDE2XTsKCSAgICAgICAgICAgIGNvbnN0IFNVTWwgPSB1NjQkMS5hZGQ0TChzMGwsIHMxbCwgU0hBNTEyX1dfTFtpIC0gN10sIFNIQTUxMl9XX0xbaSAtIDE2XSk7CgkgICAgICAgICAgICBjb25zdCBTVU1oID0gdTY0JDEuYWRkNEgoU1VNbCwgczBoLCBzMWgsIFNIQTUxMl9XX0hbaSAtIDddLCBTSEE1MTJfV19IW2kgLSAxNl0pOwoJICAgICAgICAgICAgU0hBNTEyX1dfSFtpXSA9IFNVTWggfCAwOwoJICAgICAgICAgICAgU0hBNTEyX1dfTFtpXSA9IFNVTWwgfCAwOwoJICAgICAgICB9CgkgICAgICAgIGxldCB7IEFoLCBBbCwgQmgsIEJsLCBDaCwgQ2wsIERoLCBEbCwgRWgsIEVsLCBGaCwgRmwsIEdoLCBHbCwgSGgsIEhsIH0gPSB0aGlzOwoJICAgICAgICAvLyBDb21wcmVzc2lvbiBmdW5jdGlvbiBtYWluIGxvb3AsIDgwIHJvdW5kcwoJICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDgwOyBpKyspIHsKCSAgICAgICAgICAgIC8vIFMxIDo9IChlIHJpZ2h0cm90YXRlIDE0KSB4b3IgKGUgcmlnaHRyb3RhdGUgMTgpIHhvciAoZSByaWdodHJvdGF0ZSA0MSkKCSAgICAgICAgICAgIGNvbnN0IHNpZ21hMWggPSB1NjQkMS5yb3RyU0goRWgsIEVsLCAxNCkgXiB1NjQkMS5yb3RyU0goRWgsIEVsLCAxOCkgXiB1NjQkMS5yb3RyQkgoRWgsIEVsLCA0MSk7CgkgICAgICAgICAgICBjb25zdCBzaWdtYTFsID0gdTY0JDEucm90clNMKEVoLCBFbCwgMTQpIF4gdTY0JDEucm90clNMKEVoLCBFbCwgMTgpIF4gdTY0JDEucm90ckJMKEVoLCBFbCwgNDEpOwoJICAgICAgICAgICAgLy9jb25zdCBUMSA9IChIICsgc2lnbWExICsgQ2hpKEUsIEYsIEcpICsgU0hBMjU2X0tbaV0gKyBTSEEyNTZfV1tpXSkgfCAwOwoJICAgICAgICAgICAgY29uc3QgQ0hJaCA9IChFaCAmIEZoKSBeICh+RWggJiBHaCk7CgkgICAgICAgICAgICBjb25zdCBDSElsID0gKEVsICYgRmwpIF4gKH5FbCAmIEdsKTsKCSAgICAgICAgICAgIC8vIFQxID0gSCArIHNpZ21hMSArIENoaShFLCBGLCBHKSArIFNIQTUxMl9LW2ldICsgU0hBNTEyX1dbaV0KCSAgICAgICAgICAgIC8vIHByZXR0aWVyLWlnbm9yZQoJICAgICAgICAgICAgY29uc3QgVDFsbCA9IHU2NCQxLmFkZDVMKEhsLCBzaWdtYTFsLCBDSElsLCBTSEE1MTJfS2xbaV0sIFNIQTUxMl9XX0xbaV0pOwoJICAgICAgICAgICAgY29uc3QgVDFoID0gdTY0JDEuYWRkNUgoVDFsbCwgSGgsIHNpZ21hMWgsIENISWgsIFNIQTUxMl9LaFtpXSwgU0hBNTEyX1dfSFtpXSk7CgkgICAgICAgICAgICBjb25zdCBUMWwgPSBUMWxsIHwgMDsKCSAgICAgICAgICAgIC8vIFMwIDo9IChhIHJpZ2h0cm90YXRlIDI4KSB4b3IgKGEgcmlnaHRyb3RhdGUgMzQpIHhvciAoYSByaWdodHJvdGF0ZSAzOSkKCSAgICAgICAgICAgIGNvbnN0IHNpZ21hMGggPSB1NjQkMS5yb3RyU0goQWgsIEFsLCAyOCkgXiB1NjQkMS5yb3RyQkgoQWgsIEFsLCAzNCkgXiB1NjQkMS5yb3RyQkgoQWgsIEFsLCAzOSk7CgkgICAgICAgICAgICBjb25zdCBzaWdtYTBsID0gdTY0JDEucm90clNMKEFoLCBBbCwgMjgpIF4gdTY0JDEucm90ckJMKEFoLCBBbCwgMzQpIF4gdTY0JDEucm90ckJMKEFoLCBBbCwgMzkpOwoJICAgICAgICAgICAgY29uc3QgTUFKaCA9IChBaCAmIEJoKSBeIChBaCAmIENoKSBeIChCaCAmIENoKTsKCSAgICAgICAgICAgIGNvbnN0IE1BSmwgPSAoQWwgJiBCbCkgXiAoQWwgJiBDbCkgXiAoQmwgJiBDbCk7CgkgICAgICAgICAgICBIaCA9IEdoIHwgMDsKCSAgICAgICAgICAgIEhsID0gR2wgfCAwOwoJICAgICAgICAgICAgR2ggPSBGaCB8IDA7CgkgICAgICAgICAgICBHbCA9IEZsIHwgMDsKCSAgICAgICAgICAgIEZoID0gRWggfCAwOwoJICAgICAgICAgICAgRmwgPSBFbCB8IDA7CgkgICAgICAgICAgICAoeyBoOiBFaCwgbDogRWwgfSA9IHU2NCQxLmFkZChEaCB8IDAsIERsIHwgMCwgVDFoIHwgMCwgVDFsIHwgMCkpOwoJICAgICAgICAgICAgRGggPSBDaCB8IDA7CgkgICAgICAgICAgICBEbCA9IENsIHwgMDsKCSAgICAgICAgICAgIENoID0gQmggfCAwOwoJICAgICAgICAgICAgQ2wgPSBCbCB8IDA7CgkgICAgICAgICAgICBCaCA9IEFoIHwgMDsKCSAgICAgICAgICAgIEJsID0gQWwgfCAwOwoJICAgICAgICAgICAgY29uc3QgQWxsID0gdTY0JDEuYWRkM0woVDFsLCBzaWdtYTBsLCBNQUpsKTsKCSAgICAgICAgICAgIEFoID0gdTY0JDEuYWRkM0goQWxsLCBUMWgsIHNpZ21hMGgsIE1BSmgpOwoJICAgICAgICAgICAgQWwgPSBBbGwgfCAwOwoJICAgICAgICB9CgkgICAgICAgIC8vIEFkZCB0aGUgY29tcHJlc3NlZCBjaHVuayB0byB0aGUgY3VycmVudCBoYXNoIHZhbHVlCgkgICAgICAgICh7IGg6IEFoLCBsOiBBbCB9ID0gdTY0JDEuYWRkKHRoaXMuQWggfCAwLCB0aGlzLkFsIHwgMCwgQWggfCAwLCBBbCB8IDApKTsKCSAgICAgICAgKHsgaDogQmgsIGw6IEJsIH0gPSB1NjQkMS5hZGQodGhpcy5CaCB8IDAsIHRoaXMuQmwgfCAwLCBCaCB8IDAsIEJsIHwgMCkpOwoJICAgICAgICAoeyBoOiBDaCwgbDogQ2wgfSA9IHU2NCQxLmFkZCh0aGlzLkNoIHwgMCwgdGhpcy5DbCB8IDAsIENoIHwgMCwgQ2wgfCAwKSk7CgkgICAgICAgICh7IGg6IERoLCBsOiBEbCB9ID0gdTY0JDEuYWRkKHRoaXMuRGggfCAwLCB0aGlzLkRsIHwgMCwgRGggfCAwLCBEbCB8IDApKTsKCSAgICAgICAgKHsgaDogRWgsIGw6IEVsIH0gPSB1NjQkMS5hZGQodGhpcy5FaCB8IDAsIHRoaXMuRWwgfCAwLCBFaCB8IDAsIEVsIHwgMCkpOwoJICAgICAgICAoeyBoOiBGaCwgbDogRmwgfSA9IHU2NCQxLmFkZCh0aGlzLkZoIHwgMCwgdGhpcy5GbCB8IDAsIEZoIHwgMCwgRmwgfCAwKSk7CgkgICAgICAgICh7IGg6IEdoLCBsOiBHbCB9ID0gdTY0JDEuYWRkKHRoaXMuR2ggfCAwLCB0aGlzLkdsIHwgMCwgR2ggfCAwLCBHbCB8IDApKTsKCSAgICAgICAgKHsgaDogSGgsIGw6IEhsIH0gPSB1NjQkMS5hZGQodGhpcy5IaCB8IDAsIHRoaXMuSGwgfCAwLCBIaCB8IDAsIEhsIHwgMCkpOwoJICAgICAgICB0aGlzLnNldChBaCwgQWwsIEJoLCBCbCwgQ2gsIENsLCBEaCwgRGwsIEVoLCBFbCwgRmgsIEZsLCBHaCwgR2wsIEhoLCBIbCk7CgkgICAgfQoJICAgIHJvdW5kQ2xlYW4oKSB7CgkgICAgICAgIFNIQTUxMl9XX0guZmlsbCgwKTsKCSAgICAgICAgU0hBNTEyX1dfTC5maWxsKDApOwoJICAgIH0KCSAgICBkZXN0cm95KCkgewoJICAgICAgICB0aGlzLmJ1ZmZlci5maWxsKDApOwoJICAgICAgICB0aGlzLnNldCgwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwKTsKCSAgICB9Cgl9Cgljb25zdCBzaGE1MTIgPSAvKiBAX19QVVJFX18gKi8gd3JhcENvbnN0cnVjdG9yJDEoKCkgPT4gbmV3IFNIQTUxMigpKTsKCgkvKiEgbm9ibGUtY3VydmVzIC0gTUlUIExpY2Vuc2UgKGMpIDIwMjIgUGF1bCBNaWxsZXIgKHBhdWxtaWxsci5jb20pICovCgkvLyAxMDAgbGluZXMgb2YgY29kZSBpbiB0aGUgZmlsZSBhcmUgZHVwbGljYXRlZCBmcm9tIG5vYmxlLWhhc2hlcyAodXRpbHMpLgoJLy8gVGhpcyBpcyBPSzogYGFic3RyYWN0YCBkaXJlY3RvcnkgZG9lcyBub3QgdXNlIG5vYmxlLWhhc2hlcy4KCS8vIFVzZXIgbWF5IG9wdC1pbiBpbnRvIHVzaW5nIGRpZmZlcmVudCBoYXNoaW5nIGxpYnJhcnkuIFRoaXMgd2F5LCBub2JsZS1oYXNoZXMKCS8vIHdvbid0IGJlIGluY2x1ZGVkIGludG8gdGhlaXIgYnVuZGxlLgoJY29uc3QgXzBuJDUgPSAvKiBAX19QVVJFX18gKi8gQmlnSW50KDApOwoJY29uc3QgXzFuJDcgPSAvKiBAX19QVVJFX18gKi8gQmlnSW50KDEpOwoJY29uc3QgXzJuJDUgPSAvKiBAX19QVVJFX18gKi8gQmlnSW50KDIpOwoJZnVuY3Rpb24gaXNCeXRlcyQxKGEpIHsKCSAgICByZXR1cm4gYSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgfHwgKEFycmF5QnVmZmVyLmlzVmlldyhhKSAmJiBhLmNvbnN0cnVjdG9yLm5hbWUgPT09ICdVaW50OEFycmF5Jyk7Cgl9CglmdW5jdGlvbiBhYnl0ZXMkMShpdGVtKSB7CgkgICAgaWYgKCFpc0J5dGVzJDEoaXRlbSkpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcignVWludDhBcnJheSBleHBlY3RlZCcpOwoJfQoJZnVuY3Rpb24gYWJvb2wodGl0bGUsIHZhbHVlKSB7CgkgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ2Jvb2xlYW4nKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGl0bGUgKyAnIGJvb2xlYW4gZXhwZWN0ZWQsIGdvdCAnICsgdmFsdWUpOwoJfQoJLy8gQXJyYXkgd2hlcmUgaW5kZXggMHhmMCAoMjQwKSBpcyBtYXBwZWQgdG8gc3RyaW5nICdmMCcKCWNvbnN0IGhleGVzID0gLyogQF9fUFVSRV9fICovIEFycmF5LmZyb20oeyBsZW5ndGg6IDI1NiB9LCAoXywgaSkgPT4gaS50b1N0cmluZygxNikucGFkU3RhcnQoMiwgJzAnKSk7CgkvKioKCSAqIEBleGFtcGxlIGJ5dGVzVG9IZXgoVWludDhBcnJheS5mcm9tKFsweGNhLCAweGZlLCAweDAxLCAweDIzXSkpIC8vICdjYWZlMDEyMycKCSAqLwoJZnVuY3Rpb24gYnl0ZXNUb0hleChieXRlcykgewoJICAgIGFieXRlcyQxKGJ5dGVzKTsKCSAgICAvLyBwcmUtY2FjaGluZyBpbXByb3ZlcyB0aGUgc3BlZWQgNngKCSAgICBsZXQgaGV4ID0gJyc7CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlcy5sZW5ndGg7IGkrKykgewoJICAgICAgICBoZXggKz0gaGV4ZXNbYnl0ZXNbaV1dOwoJICAgIH0KCSAgICByZXR1cm4gaGV4OwoJfQoJZnVuY3Rpb24gbnVtYmVyVG9IZXhVbnBhZGRlZChudW0pIHsKCSAgICBjb25zdCBoZXggPSBudW0udG9TdHJpbmcoMTYpOwoJICAgIHJldHVybiBoZXgubGVuZ3RoICYgMSA/ICcwJyArIGhleCA6IGhleDsKCX0KCWZ1bmN0aW9uIGhleFRvTnVtYmVyKGhleCkgewoJICAgIGlmICh0eXBlb2YgaGV4ICE9PSAnc3RyaW5nJykKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdoZXggc3RyaW5nIGV4cGVjdGVkLCBnb3QgJyArIHR5cGVvZiBoZXgpOwoJICAgIHJldHVybiBoZXggPT09ICcnID8gXzBuJDUgOiBCaWdJbnQoJzB4JyArIGhleCk7IC8vIEJpZyBFbmRpYW4KCX0KCS8vIFdlIHVzZSBvcHRpbWl6ZWQgdGVjaG5pcXVlIHRvIGNvbnZlcnQgaGV4IHN0cmluZyB0byBieXRlIGFycmF5Cgljb25zdCBhc2NpaXMgPSB7IF8wOiA0OCwgXzk6IDU3LCBBOiA2NSwgRjogNzAsIGE6IDk3LCBmOiAxMDIgfTsKCWZ1bmN0aW9uIGFzY2lpVG9CYXNlMTYoY2gpIHsKCSAgICBpZiAoY2ggPj0gYXNjaWlzLl8wICYmIGNoIDw9IGFzY2lpcy5fOSkKCSAgICAgICAgcmV0dXJuIGNoIC0gYXNjaWlzLl8wOyAvLyAnMicgPT4gNTAtNDgKCSAgICBpZiAoY2ggPj0gYXNjaWlzLkEgJiYgY2ggPD0gYXNjaWlzLkYpCgkgICAgICAgIHJldHVybiBjaCAtIChhc2NpaXMuQSAtIDEwKTsgLy8gJ0InID0+IDY2LSg2NS0xMCkKCSAgICBpZiAoY2ggPj0gYXNjaWlzLmEgJiYgY2ggPD0gYXNjaWlzLmYpCgkgICAgICAgIHJldHVybiBjaCAtIChhc2NpaXMuYSAtIDEwKTsgLy8gJ2InID0+IDk4LSg5Ny0xMCkKCSAgICByZXR1cm47Cgl9CgkvKioKCSAqIEBleGFtcGxlIGhleFRvQnl0ZXMoJ2NhZmUwMTIzJykgLy8gVWludDhBcnJheS5mcm9tKFsweGNhLCAweGZlLCAweDAxLCAweDIzXSkKCSAqLwoJZnVuY3Rpb24gaGV4VG9CeXRlcyhoZXgpIHsKCSAgICBpZiAodHlwZW9mIGhleCAhPT0gJ3N0cmluZycpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcignaGV4IHN0cmluZyBleHBlY3RlZCwgZ290ICcgKyB0eXBlb2YgaGV4KTsKCSAgICBjb25zdCBobCA9IGhleC5sZW5ndGg7CgkgICAgY29uc3QgYWwgPSBobCAvIDI7CgkgICAgaWYgKGhsICUgMikKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdoZXggc3RyaW5nIGV4cGVjdGVkLCBnb3QgdW5wYWRkZWQgaGV4IG9mIGxlbmd0aCAnICsgaGwpOwoJICAgIGNvbnN0IGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYWwpOwoJICAgIGZvciAobGV0IGFpID0gMCwgaGkgPSAwOyBhaSA8IGFsOyBhaSsrLCBoaSArPSAyKSB7CgkgICAgICAgIGNvbnN0IG4xID0gYXNjaWlUb0Jhc2UxNihoZXguY2hhckNvZGVBdChoaSkpOwoJICAgICAgICBjb25zdCBuMiA9IGFzY2lpVG9CYXNlMTYoaGV4LmNoYXJDb2RlQXQoaGkgKyAxKSk7CgkgICAgICAgIGlmIChuMSA9PT0gdW5kZWZpbmVkIHx8IG4yID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgIGNvbnN0IGNoYXIgPSBoZXhbaGldICsgaGV4W2hpICsgMV07CgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hleCBzdHJpbmcgZXhwZWN0ZWQsIGdvdCBub24taGV4IGNoYXJhY3RlciAiJyArIGNoYXIgKyAnIiBhdCBpbmRleCAnICsgaGkpOwoJICAgICAgICB9CgkgICAgICAgIGFycmF5W2FpXSA9IG4xICogMTYgKyBuMjsgLy8gbXVsdGlwbHkgZmlyc3Qgb2N0ZXQsIGUuZy4gJ2EzJyA9PiAxMCoxNiszID0+IDE2MCArIDMgPT4gMTYzCgkgICAgfQoJICAgIHJldHVybiBhcnJheTsKCX0KCS8vIEJFOiBCaWcgRW5kaWFuLCBMRTogTGl0dGxlIEVuZGlhbgoJZnVuY3Rpb24gYnl0ZXNUb051bWJlckJFKGJ5dGVzKSB7CgkgICAgcmV0dXJuIGhleFRvTnVtYmVyKGJ5dGVzVG9IZXgoYnl0ZXMpKTsKCX0KCWZ1bmN0aW9uIGJ5dGVzVG9OdW1iZXJMRShieXRlcykgewoJICAgIGFieXRlcyQxKGJ5dGVzKTsKCSAgICByZXR1cm4gaGV4VG9OdW1iZXIoYnl0ZXNUb0hleChVaW50OEFycmF5LmZyb20oYnl0ZXMpLnJldmVyc2UoKSkpOwoJfQoJZnVuY3Rpb24gbnVtYmVyVG9CeXRlc0JFKG4sIGxlbikgewoJICAgIHJldHVybiBoZXhUb0J5dGVzKG4udG9TdHJpbmcoMTYpLnBhZFN0YXJ0KGxlbiAqIDIsICcwJykpOwoJfQoJZnVuY3Rpb24gbnVtYmVyVG9CeXRlc0xFKG4sIGxlbikgewoJICAgIHJldHVybiBudW1iZXJUb0J5dGVzQkUobiwgbGVuKS5yZXZlcnNlKCk7Cgl9CgkvLyBVbnBhZGRlZCwgcmFyZWx5IHVzZWQKCWZ1bmN0aW9uIG51bWJlclRvVmFyQnl0ZXNCRShuKSB7CgkgICAgcmV0dXJuIGhleFRvQnl0ZXMobnVtYmVyVG9IZXhVbnBhZGRlZChuKSk7Cgl9CgkvKioKCSAqIFRha2VzIGhleCBzdHJpbmcgb3IgVWludDhBcnJheSwgY29udmVydHMgdG8gVWludDhBcnJheS4KCSAqIFZhbGlkYXRlcyBvdXRwdXQgbGVuZ3RoLgoJICogV2lsbCB0aHJvdyBlcnJvciBmb3Igb3RoZXIgdHlwZXMuCgkgKiBAcGFyYW0gdGl0bGUgZGVzY3JpcHRpdmUgdGl0bGUgZm9yIGFuIGVycm9yIGUuZy4gJ3ByaXZhdGUga2V5JwoJICogQHBhcmFtIGhleCBoZXggc3RyaW5nIG9yIFVpbnQ4QXJyYXkKCSAqIEBwYXJhbSBleHBlY3RlZExlbmd0aCBvcHRpb25hbCwgd2lsbCBjb21wYXJlIHRvIHJlc3VsdCBhcnJheSdzIGxlbmd0aAoJICogQHJldHVybnMKCSAqLwoJZnVuY3Rpb24gZW5zdXJlQnl0ZXModGl0bGUsIGhleCwgZXhwZWN0ZWRMZW5ndGgpIHsKCSAgICBsZXQgcmVzOwoJICAgIGlmICh0eXBlb2YgaGV4ID09PSAnc3RyaW5nJykgewoJICAgICAgICB0cnkgewoJICAgICAgICAgICAgcmVzID0gaGV4VG9CeXRlcyhoZXgpOwoJICAgICAgICB9CgkgICAgICAgIGNhdGNoIChlKSB7CgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGl0bGUgKyAnIG11c3QgYmUgaGV4IHN0cmluZyBvciBVaW50OEFycmF5LCBjYXVzZTogJyArIGUpOwoJICAgICAgICB9CgkgICAgfQoJICAgIGVsc2UgaWYgKGlzQnl0ZXMkMShoZXgpKSB7CgkgICAgICAgIC8vIFVpbnQ4QXJyYXkuZnJvbSgpIGluc3RlYWQgb2YgaGFzaC5zbGljZSgpIGJlY2F1c2Ugbm9kZS5qcyBCdWZmZXIKCSAgICAgICAgLy8gaXMgaW5zdGFuY2Ugb2YgVWludDhBcnJheSwgYW5kIGl0cyBzbGljZSgpIGNyZWF0ZXMgKiptdXRhYmxlKiogY29weQoJICAgICAgICByZXMgPSBVaW50OEFycmF5LmZyb20oaGV4KTsKCSAgICB9CgkgICAgZWxzZSB7CgkgICAgICAgIHRocm93IG5ldyBFcnJvcih0aXRsZSArICcgbXVzdCBiZSBoZXggc3RyaW5nIG9yIFVpbnQ4QXJyYXknKTsKCSAgICB9CgkgICAgY29uc3QgbGVuID0gcmVzLmxlbmd0aDsKCSAgICBpZiAodHlwZW9mIGV4cGVjdGVkTGVuZ3RoID09PSAnbnVtYmVyJyAmJiBsZW4gIT09IGV4cGVjdGVkTGVuZ3RoKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGl0bGUgKyAnIG9mIGxlbmd0aCAnICsgZXhwZWN0ZWRMZW5ndGggKyAnIGV4cGVjdGVkLCBnb3QgJyArIGxlbik7CgkgICAgcmV0dXJuIHJlczsKCX0KCS8qKgoJICogQ29waWVzIHNldmVyYWwgVWludDhBcnJheXMgaW50byBvbmUuCgkgKi8KCWZ1bmN0aW9uIGNvbmNhdEJ5dGVzKC4uLmFycmF5cykgewoJICAgIGxldCBzdW0gPSAwOwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXlzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGNvbnN0IGEgPSBhcnJheXNbaV07CgkgICAgICAgIGFieXRlcyQxKGEpOwoJICAgICAgICBzdW0gKz0gYS5sZW5ndGg7CgkgICAgfQoJICAgIGNvbnN0IHJlcyA9IG5ldyBVaW50OEFycmF5KHN1bSk7CgkgICAgZm9yIChsZXQgaSA9IDAsIHBhZCA9IDA7IGkgPCBhcnJheXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgY29uc3QgYSA9IGFycmF5c1tpXTsKCSAgICAgICAgcmVzLnNldChhLCBwYWQpOwoJICAgICAgICBwYWQgKz0gYS5sZW5ndGg7CgkgICAgfQoJICAgIHJldHVybiByZXM7Cgl9CgkvLyBDb21wYXJlcyAyIHU4YS1zIGluIGtpbmRhIGNvbnN0YW50IHRpbWUKCWZ1bmN0aW9uIGVxdWFsQnl0ZXMoYSwgYikgewoJICAgIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpCgkgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICBsZXQgZGlmZiA9IDA7CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKQoJICAgICAgICBkaWZmIHw9IGFbaV0gXiBiW2ldOwoJICAgIHJldHVybiBkaWZmID09PSAwOwoJfQoJLyoqCgkgKiBAZXhhbXBsZSB1dGY4VG9CeXRlcygnYWJjJykgLy8gbmV3IFVpbnQ4QXJyYXkoWzk3LCA5OCwgOTldKQoJICovCglmdW5jdGlvbiB1dGY4VG9CeXRlcyQxKHN0cikgewoJICAgIGlmICh0eXBlb2Ygc3RyICE9PSAnc3RyaW5nJykKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzdHJpbmcgZXhwZWN0ZWQnKTsKCSAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkobmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cikpOyAvLyBodHRwczovL2J1Z3ppbC5sYS8xNjgxODA5Cgl9CgkvLyBJcyBwb3NpdGl2ZSBiaWdpbnQKCWNvbnN0IGlzUG9zQmlnID0gKG4pID0+IHR5cGVvZiBuID09PSAnYmlnaW50JyAmJiBfMG4kNSA8PSBuOwoJZnVuY3Rpb24gaW5SYW5nZShuLCBtaW4sIG1heCkgewoJICAgIHJldHVybiBpc1Bvc0JpZyhuKSAmJiBpc1Bvc0JpZyhtaW4pICYmIGlzUG9zQmlnKG1heCkgJiYgbWluIDw9IG4gJiYgbiA8IG1heDsKCX0KCS8qKgoJICogQXNzZXJ0cyBtaW4gPD0gbiA8IG1heC4gTk9URTogSXQncyA8IG1heCBhbmQgbm90IDw9IG1heC4KCSAqIEBleGFtcGxlCgkgKiBhSW5SYW5nZSgneCcsIHgsIDFuLCAyNTZuKTsgLy8gd291bGQgYXNzdW1lIHggaXMgaW4gKDFuLi4yNTVuKQoJICovCglmdW5jdGlvbiBhSW5SYW5nZSh0aXRsZSwgbiwgbWluLCBtYXgpIHsKCSAgICAvLyBXaHkgbWluIDw9IG4gPCBtYXggYW5kIG5vdCBhIChtaW4gPCBuIDwgbWF4KSBPUiBiIChtaW4gPD0gbiA8PSBtYXgpPwoJICAgIC8vIGNvbnNpZGVyIFA9MjU2biwgbWluPTBuLCBtYXg9UAoJICAgIC8vIC0gYSBmb3IgbWluPTAgd291bGQgcmVxdWlyZSAtMTogICAgICAgICAgYGluUmFuZ2UoJ3gnLCB4LCAtMW4sIFApYAoJICAgIC8vIC0gYiB3b3VsZCBjb21tb25seSByZXF1aXJlIHN1YnRyYWN0aW9uOiAgYGluUmFuZ2UoJ3gnLCB4LCAwbiwgUCAtIDFuKWAKCSAgICAvLyAtIG91ciB3YXkgaXMgdGhlIGNsZWFuZXN0OiAgICAgICAgICAgICAgIGBpblJhbmdlKCd4JywgeCwgMG4sIFApCgkgICAgaWYgKCFpblJhbmdlKG4sIG1pbiwgbWF4KSkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdleHBlY3RlZCB2YWxpZCAnICsgdGl0bGUgKyAnOiAnICsgbWluICsgJyA8PSBuIDwgJyArIG1heCArICcsIGdvdCAnICsgbik7Cgl9CgkvLyBCaXQgb3BlcmF0aW9ucwoJLyoqCgkgKiBDYWxjdWxhdGVzIGFtb3VudCBvZiBiaXRzIGluIGEgYmlnaW50LgoJICogU2FtZSBhcyBgbi50b1N0cmluZygyKS5sZW5ndGhgCgkgKi8KCWZ1bmN0aW9uIGJpdExlbihuKSB7CgkgICAgbGV0IGxlbjsKCSAgICBmb3IgKGxlbiA9IDA7IG4gPiBfMG4kNTsgbiA+Pj0gXzFuJDcsIGxlbiArPSAxKQoJICAgICAgICA7CgkgICAgcmV0dXJuIGxlbjsKCX0KCS8qKgoJICogR2V0cyBzaW5nbGUgYml0IGF0IHBvc2l0aW9uLgoJICogTk9URTogZmlyc3QgYml0IHBvc2l0aW9uIGlzIDAgKHNhbWUgYXMgYXJyYXlzKQoJICogU2FtZSBhcyBgISErQXJyYXkuZnJvbShuLnRvU3RyaW5nKDIpKS5yZXZlcnNlKClbcG9zXWAKCSAqLwoJZnVuY3Rpb24gYml0R2V0KG4sIHBvcykgewoJICAgIHJldHVybiAobiA+PiBCaWdJbnQocG9zKSkgJiBfMW4kNzsKCX0KCS8qKgoJICogU2V0cyBzaW5nbGUgYml0IGF0IHBvc2l0aW9uLgoJICovCglmdW5jdGlvbiBiaXRTZXQobiwgcG9zLCB2YWx1ZSkgewoJICAgIHJldHVybiBuIHwgKCh2YWx1ZSA/IF8xbiQ3IDogXzBuJDUpIDw8IEJpZ0ludChwb3MpKTsKCX0KCS8qKgoJICogQ2FsY3VsYXRlIG1hc2sgZm9yIE4gYml0cy4gTm90IHVzaW5nICoqIG9wZXJhdG9yIHdpdGggYmlnaW50cyBiZWNhdXNlIG9mIG9sZCBlbmdpbmVzLgoJICogU2FtZSBhcyBCaWdJbnQoYDBiJHtBcnJheShpKS5maWxsKCcxJykuam9pbignJyl9YCkKCSAqLwoJY29uc3QgYml0TWFzayA9IChuKSA9PiAoXzJuJDUgPDwgQmlnSW50KG4gLSAxKSkgLSBfMW4kNzsKCS8vIERSQkcKCWNvbnN0IHU4biA9IChkYXRhKSA9PiBuZXcgVWludDhBcnJheShkYXRhKTsgLy8gY3JlYXRlcyBVaW50OEFycmF5Cgljb25zdCB1OGZyID0gKGFycikgPT4gVWludDhBcnJheS5mcm9tKGFycik7IC8vIGFub3RoZXIgc2hvcnRjdXQKCS8qKgoJICogTWluaW1hbCBITUFDLURSQkcgZnJvbSBOSVNUIDgwMC05MCBmb3IgUkZDNjk3OSBzaWdzLgoJICogQHJldHVybnMgZnVuY3Rpb24gdGhhdCB3aWxsIGNhbGwgRFJCRyB1bnRpbCAybmQgYXJnIHJldHVybnMgc29tZXRoaW5nIG1lYW5pbmdmdWwKCSAqIEBleGFtcGxlCgkgKiAgIGNvbnN0IGRyYmcgPSBjcmVhdGVIbWFjRFJCRzxLZXk+KDMyLCAzMiwgaG1hYyk7CgkgKiAgIGRyYmcoc2VlZCwgYnl0ZXNUb0tleSk7IC8vIGJ5dGVzVG9LZXkgbXVzdCByZXR1cm4gS2V5IG9yIHVuZGVmaW5lZAoJICovCglmdW5jdGlvbiBjcmVhdGVIbWFjRHJiZyhoYXNoTGVuLCBxQnl0ZUxlbiwgaG1hY0ZuKSB7CgkgICAgaWYgKHR5cGVvZiBoYXNoTGVuICE9PSAnbnVtYmVyJyB8fCBoYXNoTGVuIDwgMikKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdoYXNoTGVuIG11c3QgYmUgYSBudW1iZXInKTsKCSAgICBpZiAodHlwZW9mIHFCeXRlTGVuICE9PSAnbnVtYmVyJyB8fCBxQnl0ZUxlbiA8IDIpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcigncUJ5dGVMZW4gbXVzdCBiZSBhIG51bWJlcicpOwoJICAgIGlmICh0eXBlb2YgaG1hY0ZuICE9PSAnZnVuY3Rpb24nKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2htYWNGbiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCSAgICAvLyBTdGVwIEIsIFN0ZXAgQzogc2V0IGhhc2hMZW4gdG8gOCpjZWlsKGhsZW4vOCkKCSAgICBsZXQgdiA9IHU4bihoYXNoTGVuKTsgLy8gTWluaW1hbCBub24tZnVsbC1zcGVjIEhNQUMtRFJCRyBmcm9tIE5JU1QgODAwLTkwIGZvciBSRkM2OTc5IHNpZ3MuCgkgICAgbGV0IGsgPSB1OG4oaGFzaExlbik7IC8vIFN0ZXBzIEIgYW5kIEMgb2YgUkZDNjk3OSAzLjI6IHNldCBoYXNoTGVuLCBpbiBvdXIgY2FzZSBhbHdheXMgc2FtZQoJICAgIGxldCBpID0gMDsgLy8gSXRlcmF0aW9ucyBjb3VudGVyLCB3aWxsIHRocm93IHdoZW4gb3ZlciAxMDAwCgkgICAgY29uc3QgcmVzZXQgPSAoKSA9PiB7CgkgICAgICAgIHYuZmlsbCgxKTsKCSAgICAgICAgay5maWxsKDApOwoJICAgICAgICBpID0gMDsKCSAgICB9OwoJICAgIGNvbnN0IGggPSAoLi4uYikgPT4gaG1hY0ZuKGssIHYsIC4uLmIpOyAvLyBobWFjKGspKHYsIC4uLnZhbHVlcykKCSAgICBjb25zdCByZXNlZWQgPSAoc2VlZCA9IHU4bigpKSA9PiB7CgkgICAgICAgIC8vIEhNQUMtRFJCRyByZXNlZWQoKSBmdW5jdGlvbi4gU3RlcHMgRC1HCgkgICAgICAgIGsgPSBoKHU4ZnIoWzB4MDBdKSwgc2VlZCk7IC8vIGsgPSBobWFjKGsgfHwgdiB8fCAweDAwIHx8IHNlZWQpCgkgICAgICAgIHYgPSBoKCk7IC8vIHYgPSBobWFjKGsgfHwgdikKCSAgICAgICAgaWYgKHNlZWQubGVuZ3RoID09PSAwKQoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICBrID0gaCh1OGZyKFsweDAxXSksIHNlZWQpOyAvLyBrID0gaG1hYyhrIHx8IHYgfHwgMHgwMSB8fCBzZWVkKQoJICAgICAgICB2ID0gaCgpOyAvLyB2ID0gaG1hYyhrIHx8IHYpCgkgICAgfTsKCSAgICBjb25zdCBnZW4gPSAoKSA9PiB7CgkgICAgICAgIC8vIEhNQUMtRFJCRyBnZW5lcmF0ZSgpIGZ1bmN0aW9uCgkgICAgICAgIGlmIChpKysgPj0gMTAwMCkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZHJiZzogdHJpZWQgMTAwMCB2YWx1ZXMnKTsKCSAgICAgICAgbGV0IGxlbiA9IDA7CgkgICAgICAgIGNvbnN0IG91dCA9IFtdOwoJICAgICAgICB3aGlsZSAobGVuIDwgcUJ5dGVMZW4pIHsKCSAgICAgICAgICAgIHYgPSBoKCk7CgkgICAgICAgICAgICBjb25zdCBzbCA9IHYuc2xpY2UoKTsKCSAgICAgICAgICAgIG91dC5wdXNoKHNsKTsKCSAgICAgICAgICAgIGxlbiArPSB2Lmxlbmd0aDsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gY29uY2F0Qnl0ZXMoLi4ub3V0KTsKCSAgICB9OwoJICAgIGNvbnN0IGdlblVudGlsID0gKHNlZWQsIHByZWQpID0+IHsKCSAgICAgICAgcmVzZXQoKTsKCSAgICAgICAgcmVzZWVkKHNlZWQpOyAvLyBTdGVwcyBELUcKCSAgICAgICAgbGV0IHJlcyA9IHVuZGVmaW5lZDsgLy8gU3RlcCBIOiBncmluZCB1bnRpbCBrIGlzIGluIFsxLi5uLTFdCgkgICAgICAgIHdoaWxlICghKHJlcyA9IHByZWQoZ2VuKCkpKSkKCSAgICAgICAgICAgIHJlc2VlZCgpOwoJICAgICAgICByZXNldCgpOwoJICAgICAgICByZXR1cm4gcmVzOwoJICAgIH07CgkgICAgcmV0dXJuIGdlblVudGlsOwoJfQoJLy8gVmFsaWRhdGluZyBjdXJ2ZXMgYW5kIGZpZWxkcwoJY29uc3QgdmFsaWRhdG9yRm5zID0gewoJICAgIGJpZ2ludDogKHZhbCkgPT4gdHlwZW9mIHZhbCA9PT0gJ2JpZ2ludCcsCgkgICAgZnVuY3Rpb246ICh2YWwpID0+IHR5cGVvZiB2YWwgPT09ICdmdW5jdGlvbicsCgkgICAgYm9vbGVhbjogKHZhbCkgPT4gdHlwZW9mIHZhbCA9PT0gJ2Jvb2xlYW4nLAoJICAgIHN0cmluZzogKHZhbCkgPT4gdHlwZW9mIHZhbCA9PT0gJ3N0cmluZycsCgkgICAgc3RyaW5nT3JVaW50OEFycmF5OiAodmFsKSA9PiB0eXBlb2YgdmFsID09PSAnc3RyaW5nJyB8fCBpc0J5dGVzJDEodmFsKSwKCSAgICBpc1NhZmVJbnRlZ2VyOiAodmFsKSA9PiBOdW1iZXIuaXNTYWZlSW50ZWdlcih2YWwpLAoJICAgIGFycmF5OiAodmFsKSA9PiBBcnJheS5pc0FycmF5KHZhbCksCgkgICAgZmllbGQ6ICh2YWwsIG9iamVjdCkgPT4gb2JqZWN0LkZwLmlzVmFsaWQodmFsKSwKCSAgICBoYXNoOiAodmFsKSA9PiB0eXBlb2YgdmFsID09PSAnZnVuY3Rpb24nICYmIE51bWJlci5pc1NhZmVJbnRlZ2VyKHZhbC5vdXRwdXRMZW4pLAoJfTsKCS8vIHR5cGUgUmVjb3JkPEsgZXh0ZW5kcyBzdHJpbmcgfCBudW1iZXIgfCBzeW1ib2wsIFQ+ID0geyBbUCBpbiBLXTogVDsgfQoJZnVuY3Rpb24gdmFsaWRhdGVPYmplY3Qob2JqZWN0LCB2YWxpZGF0b3JzLCBvcHRWYWxpZGF0b3JzID0ge30pIHsKCSAgICBjb25zdCBjaGVja0ZpZWxkID0gKGZpZWxkTmFtZSwgdHlwZSwgaXNPcHRpb25hbCkgPT4gewoJICAgICAgICBjb25zdCBjaGVja1ZhbCA9IHZhbGlkYXRvckZuc1t0eXBlXTsKCSAgICAgICAgaWYgKHR5cGVvZiBjaGVja1ZhbCAhPT0gJ2Z1bmN0aW9uJykKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCB2YWxpZGF0b3IgZnVuY3Rpb24nKTsKCSAgICAgICAgY29uc3QgdmFsID0gb2JqZWN0W2ZpZWxkTmFtZV07CgkgICAgICAgIGlmIChpc09wdGlvbmFsICYmIHZhbCA9PT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICBpZiAoIWNoZWNrVmFsKHZhbCwgb2JqZWN0KSkgewoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwYXJhbSAnICsgU3RyaW5nKGZpZWxkTmFtZSkgKyAnIGlzIGludmFsaWQuIEV4cGVjdGVkICcgKyB0eXBlICsgJywgZ290ICcgKyB2YWwpOwoJICAgICAgICB9CgkgICAgfTsKCSAgICBmb3IgKGNvbnN0IFtmaWVsZE5hbWUsIHR5cGVdIG9mIE9iamVjdC5lbnRyaWVzKHZhbGlkYXRvcnMpKQoJICAgICAgICBjaGVja0ZpZWxkKGZpZWxkTmFtZSwgdHlwZSwgZmFsc2UpOwoJICAgIGZvciAoY29uc3QgW2ZpZWxkTmFtZSwgdHlwZV0gb2YgT2JqZWN0LmVudHJpZXMob3B0VmFsaWRhdG9ycykpCgkgICAgICAgIGNoZWNrRmllbGQoZmllbGROYW1lLCB0eXBlLCB0cnVlKTsKCSAgICByZXR1cm4gb2JqZWN0OwoJfQoJLy8gdmFsaWRhdGUgdHlwZSB0ZXN0cwoJLy8gY29uc3QgbzogeyBhOiBudW1iZXI7IGI6IG51bWJlcjsgYzogbnVtYmVyIH0gPSB7IGE6IDEsIGI6IDUsIGM6IDYgfTsKCS8vIGNvbnN0IHowID0gdmFsaWRhdGVPYmplY3QobywgeyBhOiAnaXNTYWZlSW50ZWdlcicgfSwgeyBjOiAnYmlnaW50JyB9KTsgLy8gT2shCgkvLyAvLyBTaG91bGQgZmFpbCB0eXBlLWNoZWNrCgkvLyBjb25zdCB6MSA9IHZhbGlkYXRlT2JqZWN0KG8sIHsgYTogJ3RtcCcgfSwgeyBjOiAnenonIH0pOwoJLy8gY29uc3QgejIgPSB2YWxpZGF0ZU9iamVjdChvLCB7IGE6ICdpc1NhZmVJbnRlZ2VyJyB9LCB7IGM6ICd6eicgfSk7CgkvLyBjb25zdCB6MyA9IHZhbGlkYXRlT2JqZWN0KG8sIHsgdGVzdDogJ2Jvb2xlYW4nLCB6OiAnYnVnJyB9KTsKCS8vIGNvbnN0IHo0ID0gdmFsaWRhdGVPYmplY3QobywgeyBhOiAnYm9vbGVhbicsIHo6ICdidWcnIH0pOwoJLyoqCgkgKiB0aHJvd3Mgbm90IGltcGxlbWVudGVkIGVycm9yCgkgKi8KCWNvbnN0IG5vdEltcGxlbWVudGVkID0gKCkgPT4gewoJICAgIHRocm93IG5ldyBFcnJvcignbm90IGltcGxlbWVudGVkJyk7Cgl9OwoJLyoqCgkgKiBNZW1vaXplcyAoY2FjaGVzKSBjb21wdXRhdGlvbiByZXN1bHQuCgkgKiBVc2VzIFdlYWtNYXA6IHRoZSB2YWx1ZSBpcyBnb2luZyBhdXRvLWNsZWFuZWQgYnkgR0MgYWZ0ZXIgbGFzdCByZWZlcmVuY2UgaXMgcmVtb3ZlZC4KCSAqLwoJZnVuY3Rpb24gbWVtb2l6ZWQoZm4pIHsKCSAgICBjb25zdCBtYXAgPSBuZXcgV2Vha01hcCgpOwoJICAgIHJldHVybiAoYXJnLCAuLi5hcmdzKSA9PiB7CgkgICAgICAgIGNvbnN0IHZhbCA9IG1hcC5nZXQoYXJnKTsKCSAgICAgICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgcmV0dXJuIHZhbDsKCSAgICAgICAgY29uc3QgY29tcHV0ZWQgPSBmbihhcmcsIC4uLmFyZ3MpOwoJICAgICAgICBtYXAuc2V0KGFyZywgY29tcHV0ZWQpOwoJICAgICAgICByZXR1cm4gY29tcHV0ZWQ7CgkgICAgfTsKCX0KCgl2YXIgdXQgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CgkJX19wcm90b19fOiBudWxsLAoJCWFJblJhbmdlOiBhSW5SYW5nZSwKCQlhYm9vbDogYWJvb2wsCgkJYWJ5dGVzOiBhYnl0ZXMkMSwKCQliaXRHZXQ6IGJpdEdldCwKCQliaXRMZW46IGJpdExlbiwKCQliaXRNYXNrOiBiaXRNYXNrLAoJCWJpdFNldDogYml0U2V0LAoJCWJ5dGVzVG9IZXg6IGJ5dGVzVG9IZXgsCgkJYnl0ZXNUb051bWJlckJFOiBieXRlc1RvTnVtYmVyQkUsCgkJYnl0ZXNUb051bWJlckxFOiBieXRlc1RvTnVtYmVyTEUsCgkJY29uY2F0Qnl0ZXM6IGNvbmNhdEJ5dGVzLAoJCWNyZWF0ZUhtYWNEcmJnOiBjcmVhdGVIbWFjRHJiZywKCQllbnN1cmVCeXRlczogZW5zdXJlQnl0ZXMsCgkJZXF1YWxCeXRlczogZXF1YWxCeXRlcywKCQloZXhUb0J5dGVzOiBoZXhUb0J5dGVzLAoJCWhleFRvTnVtYmVyOiBoZXhUb051bWJlciwKCQlpblJhbmdlOiBpblJhbmdlLAoJCWlzQnl0ZXM6IGlzQnl0ZXMkMSwKCQltZW1vaXplZDogbWVtb2l6ZWQsCgkJbm90SW1wbGVtZW50ZWQ6IG5vdEltcGxlbWVudGVkLAoJCW51bWJlclRvQnl0ZXNCRTogbnVtYmVyVG9CeXRlc0JFLAoJCW51bWJlclRvQnl0ZXNMRTogbnVtYmVyVG9CeXRlc0xFLAoJCW51bWJlclRvSGV4VW5wYWRkZWQ6IG51bWJlclRvSGV4VW5wYWRkZWQsCgkJbnVtYmVyVG9WYXJCeXRlc0JFOiBudW1iZXJUb1ZhckJ5dGVzQkUsCgkJdXRmOFRvQnl0ZXM6IHV0ZjhUb0J5dGVzJDEsCgkJdmFsaWRhdGVPYmplY3Q6IHZhbGlkYXRlT2JqZWN0Cgl9KTsKCgkvKiEgbm9ibGUtY3VydmVzIC0gTUlUIExpY2Vuc2UgKGMpIDIwMjIgUGF1bCBNaWxsZXIgKHBhdWxtaWxsci5jb20pICovCgkvLyBVdGlsaXRpZXMgZm9yIG1vZHVsYXIgYXJpdGhtZXRpY3MgYW5kIGZpbml0ZSBmaWVsZHMKCS8vIHByZXR0aWVyLWlnbm9yZQoJY29uc3QgXzBuJDQgPSBCaWdJbnQoMCksIF8xbiQ2ID0gQmlnSW50KDEpLCBfMm4kNCA9IC8qIEBfX1BVUkVfXyAqLyBCaWdJbnQoMiksIF8zbiQxID0gLyogQF9fUFVSRV9fICovIEJpZ0ludCgzKTsKCS8vIHByZXR0aWVyLWlnbm9yZQoJY29uc3QgXzRuID0gLyogQF9fUFVSRV9fICovIEJpZ0ludCg0KSwgXzVuJDEgPSAvKiBAX19QVVJFX18gKi8gQmlnSW50KDUpLCBfOG4kMiA9IC8qIEBfX1BVUkVfXyAqLyBCaWdJbnQoOCk7CgkvLyBDYWxjdWxhdGVzIGEgbW9kdWxvIGIKCWZ1bmN0aW9uIG1vZChhLCBiKSB7CgkgICAgY29uc3QgcmVzdWx0ID0gYSAlIGI7CgkgICAgcmV0dXJuIHJlc3VsdCA+PSBfMG4kNCA/IHJlc3VsdCA6IGIgKyByZXN1bHQ7Cgl9CgkvKioKCSAqIEVmZmljaWVudGx5IHJhaXNlIG51bSB0byBwb3dlciBhbmQgZG8gbW9kdWxhciBkaXZpc2lvbi4KCSAqIFVuc2FmZSBpbiBzb21lIGNvbnRleHRzOiB1c2VzIGxhZGRlciwgc28gY2FuIGV4cG9zZSBiaWdpbnQgYml0cy4KCSAqIEBleGFtcGxlCgkgKiBwb3coMm4sIDZuLCAxMW4pIC8vIDY0biAlIDExbiA9PSA5bgoJICovCgkvLyBUT0RPOiB1c2UgZmllbGQgdmVyc2lvbiAmJiByZW1vdmUKCWZ1bmN0aW9uIHBvdyhudW0sIHBvd2VyLCBtb2R1bG8pIHsKCSAgICBpZiAocG93ZXIgPCBfMG4kNCkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGV4cG9uZW50LCBuZWdhdGl2ZXMgdW5zdXBwb3J0ZWQnKTsKCSAgICBpZiAobW9kdWxvIDw9IF8wbiQ0KQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgbW9kdWx1cycpOwoJICAgIGlmIChtb2R1bG8gPT09IF8xbiQ2KQoJICAgICAgICByZXR1cm4gXzBuJDQ7CgkgICAgbGV0IHJlcyA9IF8xbiQ2OwoJICAgIHdoaWxlIChwb3dlciA+IF8wbiQ0KSB7CgkgICAgICAgIGlmIChwb3dlciAmIF8xbiQ2KQoJICAgICAgICAgICAgcmVzID0gKHJlcyAqIG51bSkgJSBtb2R1bG87CgkgICAgICAgIG51bSA9IChudW0gKiBudW0pICUgbW9kdWxvOwoJICAgICAgICBwb3dlciA+Pj0gXzFuJDY7CgkgICAgfQoJICAgIHJldHVybiByZXM7Cgl9CgkvLyBEb2VzIHggXiAoMiBeIHBvd2VyKSBtb2QgcC4gcG93MigzMCwgNCkgPT0gMzAgXiAoMiBeIDQpCglmdW5jdGlvbiBwb3cyKHgsIHBvd2VyLCBtb2R1bG8pIHsKCSAgICBsZXQgcmVzID0geDsKCSAgICB3aGlsZSAocG93ZXItLSA+IF8wbiQ0KSB7CgkgICAgICAgIHJlcyAqPSByZXM7CgkgICAgICAgIHJlcyAlPSBtb2R1bG87CgkgICAgfQoJICAgIHJldHVybiByZXM7Cgl9CgkvLyBJbnZlcnNlcyBudW1iZXIgb3ZlciBtb2R1bG8KCWZ1bmN0aW9uIGludmVydChudW1iZXIsIG1vZHVsbykgewoJICAgIGlmIChudW1iZXIgPT09IF8wbiQ0KQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmVydDogZXhwZWN0ZWQgbm9uLXplcm8gbnVtYmVyJyk7CgkgICAgaWYgKG1vZHVsbyA8PSBfMG4kNCkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZlcnQ6IGV4cGVjdGVkIHBvc2l0aXZlIG1vZHVsdXMsIGdvdCAnICsgbW9kdWxvKTsKCSAgICAvLyBFdWNsaWRlYW4gR0NEIGh0dHBzOi8vYnJpbGxpYW50Lm9yZy93aWtpL2V4dGVuZGVkLWV1Y2xpZGVhbi1hbGdvcml0aG0vCgkgICAgLy8gRmVybWF0J3MgbGl0dGxlIHRoZW9yZW0gIkNULWxpa2UiIHZlcnNpb24gaW52KG4pID0gbl4obS0yKSBtb2QgbSBpcyAzMHggc2xvd2VyLgoJICAgIGxldCBhID0gbW9kKG51bWJlciwgbW9kdWxvKTsKCSAgICBsZXQgYiA9IG1vZHVsbzsKCSAgICAvLyBwcmV0dGllci1pZ25vcmUKCSAgICBsZXQgeCA9IF8wbiQ0LCB1ID0gXzFuJDY7CgkgICAgd2hpbGUgKGEgIT09IF8wbiQ0KSB7CgkgICAgICAgIC8vIEpJVCBhcHBsaWVzIG9wdGltaXphdGlvbiBpZiB0aG9zZSB0d28gbGluZXMgZm9sbG93IGVhY2ggb3RoZXIKCSAgICAgICAgY29uc3QgcSA9IGIgLyBhOwoJICAgICAgICBjb25zdCByID0gYiAlIGE7CgkgICAgICAgIGNvbnN0IG0gPSB4IC0gdSAqIHE7CgkgICAgICAgIC8vIHByZXR0aWVyLWlnbm9yZQoJICAgICAgICBiID0gYSwgYSA9IHIsIHggPSB1LCB1ID0gbTsKCSAgICB9CgkgICAgY29uc3QgZ2NkID0gYjsKCSAgICBpZiAoZ2NkICE9PSBfMW4kNikKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZlcnQ6IGRvZXMgbm90IGV4aXN0Jyk7CgkgICAgcmV0dXJuIG1vZCh4LCBtb2R1bG8pOwoJfQoJLyoqCgkgKiBUb25lbGxpLVNoYW5rcyBzcXVhcmUgcm9vdCBzZWFyY2ggYWxnb3JpdGhtLgoJICogMS4gaHR0cHM6Ly9lcHJpbnQuaWFjci5vcmcvMjAxMi82ODUucGRmIChwYWdlIDEyKQoJICogMi4gU3F1YXJlIFJvb3RzIGZyb20gMTsgMjQsIDUxLCAxMCB0byBEYW4gU2hhbmtzCgkgKiBXaWxsIHN0YXJ0IGFuIGluZmluaXRlIGxvb3AgaWYgZmllbGQgb3JkZXIgUCBpcyBub3QgcHJpbWUuCgkgKiBAcGFyYW0gUCBmaWVsZCBvcmRlcgoJICogQHJldHVybnMgZnVuY3Rpb24gdGhhdCB0YWtlcyBmaWVsZCBGcCAoY3JlYXRlZCBmcm9tIFApIGFuZCBudW1iZXIgbgoJICovCglmdW5jdGlvbiB0b25lbGxpU2hhbmtzKFApIHsKCSAgICAvLyBMZWdlbmRyZSBjb25zdGFudDogdXNlZCB0byBjYWxjdWxhdGUgTGVnZW5kcmUgc3ltYm9sIChhIHwgcCksCgkgICAgLy8gd2hpY2ggZGVub3RlcyB0aGUgdmFsdWUgb2YgYV4oKHAtMSkvMikgKG1vZCBwKS4KCSAgICAvLyAoYSB8IHApIOKJoSAxICAgIGlmIGEgaXMgYSBzcXVhcmUgKG1vZCBwKQoJICAgIC8vIChhIHwgcCkg4omhIC0xICAgaWYgYSBpcyBub3QgYSBzcXVhcmUgKG1vZCBwKQoJICAgIC8vIChhIHwgcCkg4omhIDAgICAgaWYgYSDiiaEgMCAobW9kIHApCgkgICAgY29uc3QgbGVnZW5kcmVDID0gKFAgLSBfMW4kNikgLyBfMm4kNDsKCSAgICBsZXQgUSwgUywgWjsKCSAgICAvLyBTdGVwIDE6IEJ5IGZhY3RvcmluZyBvdXQgcG93ZXJzIG9mIDIgZnJvbSBwIC0gMSwKCSAgICAvLyBmaW5kIHEgYW5kIHMgc3VjaCB0aGF0IHAgLSAxID0gcSooMl5zKSB3aXRoIHEgb2RkCgkgICAgZm9yIChRID0gUCAtIF8xbiQ2LCBTID0gMDsgUSAlIF8ybiQ0ID09PSBfMG4kNDsgUSAvPSBfMm4kNCwgUysrKQoJICAgICAgICA7CgkgICAgLy8gU3RlcCAyOiBTZWxlY3QgYSBub24tc3F1YXJlIHogc3VjaCB0aGF0ICh6IHwgcCkg4omhIC0xIGFuZCBzZXQgYyDiiaEgenEKCSAgICBmb3IgKFogPSBfMm4kNDsgWiA8IFAgJiYgcG93KFosIGxlZ2VuZHJlQywgUCkgIT09IFAgLSBfMW4kNjsgWisrKSB7CgkgICAgICAgIC8vIENyYXNoIGluc3RlYWQgb2YgaW5maW5pdHkgbG9vcCwgd2UgY2Fubm90IHJlYXNvbmFibGUgY291bnQgdW50aWwgUC4KCSAgICAgICAgaWYgKFogPiAxMDAwKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzcXVhcmUgcm9vdDogbGlrZWx5IG5vbi1wcmltZSBQJyk7CgkgICAgfQoJICAgIC8vIEZhc3QtcGF0aAoJICAgIGlmIChTID09PSAxKSB7CgkgICAgICAgIGNvbnN0IHAxZGl2NCA9IChQICsgXzFuJDYpIC8gXzRuOwoJICAgICAgICByZXR1cm4gZnVuY3Rpb24gdG9uZWxsaUZhc3QoRnAsIG4pIHsKCSAgICAgICAgICAgIGNvbnN0IHJvb3QgPSBGcC5wb3cobiwgcDFkaXY0KTsKCSAgICAgICAgICAgIGlmICghRnAuZXFsKEZwLnNxcihyb290KSwgbikpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzcXVhcmUgcm9vdCcpOwoJICAgICAgICAgICAgcmV0dXJuIHJvb3Q7CgkgICAgICAgIH07CgkgICAgfQoJICAgIC8vIFNsb3ctcGF0aAoJICAgIGNvbnN0IFExZGl2MiA9IChRICsgXzFuJDYpIC8gXzJuJDQ7CgkgICAgcmV0dXJuIGZ1bmN0aW9uIHRvbmVsbGlTbG93KEZwLCBuKSB7CgkgICAgICAgIC8vIFN0ZXAgMDogQ2hlY2sgdGhhdCBuIGlzIGluZGVlZCBhIHNxdWFyZTogKG4gfCBwKSBzaG91bGQgbm90IGJlIOKJoSAtMQoJICAgICAgICBpZiAoRnAucG93KG4sIGxlZ2VuZHJlQykgPT09IEZwLm5lZyhGcC5PTkUpKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzcXVhcmUgcm9vdCcpOwoJICAgICAgICBsZXQgciA9IFM7CgkgICAgICAgIC8vIFRPRE86IHdpbGwgZmFpbCBhdCBGcDIvZXRjCgkgICAgICAgIGxldCBnID0gRnAucG93KEZwLm11bChGcC5PTkUsIFopLCBRKTsgLy8gd2lsbCB1cGRhdGUgYm90aCB4IGFuZCBiCgkgICAgICAgIGxldCB4ID0gRnAucG93KG4sIFExZGl2Mik7IC8vIGZpcnN0IGd1ZXNzIGF0IHRoZSBzcXVhcmUgcm9vdAoJICAgICAgICBsZXQgYiA9IEZwLnBvdyhuLCBRKTsgLy8gZmlyc3QgZ3Vlc3MgYXQgdGhlIGZ1ZGdlIGZhY3RvcgoJICAgICAgICB3aGlsZSAoIUZwLmVxbChiLCBGcC5PTkUpKSB7CgkgICAgICAgICAgICBpZiAoRnAuZXFsKGIsIEZwLlpFUk8pKQoJICAgICAgICAgICAgICAgIHJldHVybiBGcC5aRVJPOyAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Ub25lbGxpJUUyJTgwJTkzU2hhbmtzX2FsZ29yaXRobSAoNC4gSWYgdCA9IDAsIHJldHVybiByID0gMCkKCSAgICAgICAgICAgIC8vIEZpbmQgbSBzdWNoIGJeKDJebSk9PTEKCSAgICAgICAgICAgIGxldCBtID0gMTsKCSAgICAgICAgICAgIGZvciAobGV0IHQyID0gRnAuc3FyKGIpOyBtIDwgcjsgbSsrKSB7CgkgICAgICAgICAgICAgICAgaWYgKEZwLmVxbCh0MiwgRnAuT05FKSkKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgdDIgPSBGcC5zcXIodDIpOyAvLyB0MiAqPSB0MgoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLy8gTk9URTogci1tLTEgY2FuIGJlIGJpZ2dlciB0aGFuIDMyLCBuZWVkIHRvIGNvbnZlcnQgdG8gYmlnaW50IGJlZm9yZSBzaGlmdCwgb3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgb3ZlcmZsb3cKCSAgICAgICAgICAgIGNvbnN0IGdlID0gRnAucG93KGcsIF8xbiQ2IDw8IEJpZ0ludChyIC0gbSAtIDEpKTsgLy8gZ2UgPSAyXihyLW0tMSkKCSAgICAgICAgICAgIGcgPSBGcC5zcXIoZ2UpOyAvLyBnID0gZ2UgKiBnZQoJICAgICAgICAgICAgeCA9IEZwLm11bCh4LCBnZSk7IC8vIHggKj0gZ2UKCSAgICAgICAgICAgIGIgPSBGcC5tdWwoYiwgZyk7IC8vIGIgKj0gZwoJICAgICAgICAgICAgciA9IG07CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHg7CgkgICAgfTsKCX0KCWZ1bmN0aW9uIEZwU3FydChQKSB7CgkgICAgLy8gTk9URTogZGlmZmVyZW50IGFsZ29yaXRobXMgY2FuIGdpdmUgZGlmZmVyZW50IHJvb3RzLCBpdCBpcyB1cCB0byB1c2VyIHRvIGRlY2lkZSB3aGljaCBvbmUgdGhleSB3YW50LgoJICAgIC8vIEZvciBleGFtcGxlIHRoZXJlIGlzIEZwU3FydE9kZC9GcFNxcnRFdmVuIHRvIGNob2ljZSByb290IGJhc2VkIG9uIG9kZG5lc3MgKHVzZWQgZm9yIGhhc2gtdG8tY3VydmUpLgoJICAgIC8vIFAg4omhIDMgKG1vZCA0KQoJICAgIC8vIOKImm4gPSBuXigoUCsxKS80KQoJICAgIGlmIChQICUgXzRuID09PSBfM24kMSkgewoJICAgICAgICAvLyBOb3QgYWxsIHJvb3RzIHBvc3NpYmxlIQoJICAgICAgICAvLyBjb25zdCBPUkRFUiA9CgkgICAgICAgIC8vICAgMHgxYTAxMTFlYTM5N2ZlNjlhNGIxYmE3YjY0MzRiYWNkNzY0Nzc0Yjg0ZjM4NTEyYmY2NzMwZDJhMGY2YjBmNjI0MWVhYmZmZmViMTUzZmZmZmI5ZmVmZmZmZmZmZmFhYWJuOwoJICAgICAgICAvLyBjb25zdCBOVU0gPSA3MjA1NzU5NDAzNzkyNzgxNm47CgkgICAgICAgIGNvbnN0IHAxZGl2NCA9IChQICsgXzFuJDYpIC8gXzRuOwoJICAgICAgICByZXR1cm4gZnVuY3Rpb24gc3FydDNtb2Q0KEZwLCBuKSB7CgkgICAgICAgICAgICBjb25zdCByb290ID0gRnAucG93KG4sIHAxZGl2NCk7CgkgICAgICAgICAgICAvLyBUaHJvdyBpZiByb290KioyICE9IG4KCSAgICAgICAgICAgIGlmICghRnAuZXFsKEZwLnNxcihyb290KSwgbikpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzcXVhcmUgcm9vdCcpOwoJICAgICAgICAgICAgcmV0dXJuIHJvb3Q7CgkgICAgICAgIH07CgkgICAgfQoJICAgIC8vIEF0a2luIGFsZ29yaXRobSBmb3IgcSDiiaEgNSAobW9kIDgpLCBodHRwczovL2VwcmludC5pYWNyLm9yZy8yMDEyLzY4NS5wZGYgKHBhZ2UgMTApCgkgICAgaWYgKFAgJSBfOG4kMiA9PT0gXzVuJDEpIHsKCSAgICAgICAgY29uc3QgYzEgPSAoUCAtIF81biQxKSAvIF84biQyOwoJICAgICAgICByZXR1cm4gZnVuY3Rpb24gc3FydDVtb2Q4KEZwLCBuKSB7CgkgICAgICAgICAgICBjb25zdCBuMiA9IEZwLm11bChuLCBfMm4kNCk7CgkgICAgICAgICAgICBjb25zdCB2ID0gRnAucG93KG4yLCBjMSk7CgkgICAgICAgICAgICBjb25zdCBudiA9IEZwLm11bChuLCB2KTsKCSAgICAgICAgICAgIGNvbnN0IGkgPSBGcC5tdWwoRnAubXVsKG52LCBfMm4kNCksIHYpOwoJICAgICAgICAgICAgY29uc3Qgcm9vdCA9IEZwLm11bChudiwgRnAuc3ViKGksIEZwLk9ORSkpOwoJICAgICAgICAgICAgaWYgKCFGcC5lcWwoRnAuc3FyKHJvb3QpLCBuKSkKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHNxdWFyZSByb290Jyk7CgkgICAgICAgICAgICByZXR1cm4gcm9vdDsKCSAgICAgICAgfTsKCSAgICB9CgkgICAgLy8gT3RoZXIgY2FzZXM6IFRvbmVsbGktU2hhbmtzIGFsZ29yaXRobQoJICAgIHJldHVybiB0b25lbGxpU2hhbmtzKFApOwoJfQoJLy8gTGl0dGxlLWVuZGlhbiBjaGVjayBmb3IgZmlyc3QgTEUgYml0IChsYXN0IEJFIGJpdCk7Cgljb25zdCBpc05lZ2F0aXZlTEUgPSAobnVtLCBtb2R1bG8pID0+IChtb2QobnVtLCBtb2R1bG8pICYgXzFuJDYpID09PSBfMW4kNjsKCS8vIHByZXR0aWVyLWlnbm9yZQoJY29uc3QgRklFTERfRklFTERTID0gWwoJICAgICdjcmVhdGUnLCAnaXNWYWxpZCcsICdpczAnLCAnbmVnJywgJ2ludicsICdzcXJ0JywgJ3NxcicsCgkgICAgJ2VxbCcsICdhZGQnLCAnc3ViJywgJ211bCcsICdwb3cnLCAnZGl2JywKCSAgICAnYWRkTicsICdzdWJOJywgJ211bE4nLCAnc3FyTicKCV07CglmdW5jdGlvbiB2YWxpZGF0ZUZpZWxkKGZpZWxkKSB7CgkgICAgY29uc3QgaW5pdGlhbCA9IHsKCSAgICAgICAgT1JERVI6ICdiaWdpbnQnLAoJICAgICAgICBNQVNLOiAnYmlnaW50JywKCSAgICAgICAgQllURVM6ICdpc1NhZmVJbnRlZ2VyJywKCSAgICAgICAgQklUUzogJ2lzU2FmZUludGVnZXInLAoJICAgIH07CgkgICAgY29uc3Qgb3B0cyA9IEZJRUxEX0ZJRUxEUy5yZWR1Y2UoKG1hcCwgdmFsKSA9PiB7CgkgICAgICAgIG1hcFt2YWxdID0gJ2Z1bmN0aW9uJzsKCSAgICAgICAgcmV0dXJuIG1hcDsKCSAgICB9LCBpbml0aWFsKTsKCSAgICByZXR1cm4gdmFsaWRhdGVPYmplY3QoZmllbGQsIG9wdHMpOwoJfQoJLy8gR2VuZXJpYyBmaWVsZCBmdW5jdGlvbnMKCS8qKgoJICogU2FtZSBhcyBgcG93YCBidXQgZm9yIEZwOiBub24tY29uc3RhbnQtdGltZS4KCSAqIFVuc2FmZSBpbiBzb21lIGNvbnRleHRzOiB1c2VzIGxhZGRlciwgc28gY2FuIGV4cG9zZSBiaWdpbnQgYml0cy4KCSAqLwoJZnVuY3Rpb24gRnBQb3coZiwgbnVtLCBwb3dlcikgewoJICAgIC8vIFNob3VsZCBoYXZlIHNhbWUgc3BlZWQgYXMgcG93IGZvciBiaWdpbnRzCgkgICAgLy8gVE9ETzogYmVuY2htYXJrIQoJICAgIGlmIChwb3dlciA8IF8wbiQ0KQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgZXhwb25lbnQsIG5lZ2F0aXZlcyB1bnN1cHBvcnRlZCcpOwoJICAgIGlmIChwb3dlciA9PT0gXzBuJDQpCgkgICAgICAgIHJldHVybiBmLk9ORTsKCSAgICBpZiAocG93ZXIgPT09IF8xbiQ2KQoJICAgICAgICByZXR1cm4gbnVtOwoJICAgIGxldCBwID0gZi5PTkU7CgkgICAgbGV0IGQgPSBudW07CgkgICAgd2hpbGUgKHBvd2VyID4gXzBuJDQpIHsKCSAgICAgICAgaWYgKHBvd2VyICYgXzFuJDYpCgkgICAgICAgICAgICBwID0gZi5tdWwocCwgZCk7CgkgICAgICAgIGQgPSBmLnNxcihkKTsKCSAgICAgICAgcG93ZXIgPj49IF8xbiQ2OwoJICAgIH0KCSAgICByZXR1cm4gcDsKCX0KCS8qKgoJICogRWZmaWNpZW50bHkgaW52ZXJ0IGFuIGFycmF5IG9mIEZpZWxkIGVsZW1lbnRzLgoJICogYGludigwKWAgd2lsbCByZXR1cm4gYHVuZGVmaW5lZGAgaGVyZTogbWFrZSBzdXJlIHRvIHRocm93IGFuIGVycm9yLgoJICovCglmdW5jdGlvbiBGcEludmVydEJhdGNoKGYsIG51bXMpIHsKCSAgICBjb25zdCB0bXAgPSBuZXcgQXJyYXkobnVtcy5sZW5ndGgpOwoJICAgIC8vIFdhbGsgZnJvbSBmaXJzdCB0byBsYXN0LCBtdWx0aXBseSB0aGVtIGJ5IGVhY2ggb3RoZXIgTU9EIHAKCSAgICBjb25zdCBsYXN0TXVsdGlwbGllZCA9IG51bXMucmVkdWNlKChhY2MsIG51bSwgaSkgPT4gewoJICAgICAgICBpZiAoZi5pczAobnVtKSkKCSAgICAgICAgICAgIHJldHVybiBhY2M7CgkgICAgICAgIHRtcFtpXSA9IGFjYzsKCSAgICAgICAgcmV0dXJuIGYubXVsKGFjYywgbnVtKTsKCSAgICB9LCBmLk9ORSk7CgkgICAgLy8gSW52ZXJ0IGxhc3QgZWxlbWVudAoJICAgIGNvbnN0IGludmVydGVkID0gZi5pbnYobGFzdE11bHRpcGxpZWQpOwoJICAgIC8vIFdhbGsgZnJvbSBsYXN0IHRvIGZpcnN0LCBtdWx0aXBseSB0aGVtIGJ5IGludmVydGVkIGVhY2ggb3RoZXIgTU9EIHAKCSAgICBudW1zLnJlZHVjZVJpZ2h0KChhY2MsIG51bSwgaSkgPT4gewoJICAgICAgICBpZiAoZi5pczAobnVtKSkKCSAgICAgICAgICAgIHJldHVybiBhY2M7CgkgICAgICAgIHRtcFtpXSA9IGYubXVsKGFjYywgdG1wW2ldKTsKCSAgICAgICAgcmV0dXJuIGYubXVsKGFjYywgbnVtKTsKCSAgICB9LCBpbnZlcnRlZCk7CgkgICAgcmV0dXJuIHRtcDsKCX0KCS8vIENVUlZFLm4gbGVuZ3RocwoJZnVuY3Rpb24gbkxlbmd0aChuLCBuQml0TGVuZ3RoKSB7CgkgICAgLy8gQml0IHNpemUsIGJ5dGUgc2l6ZSBvZiBDVVJWRS5uCgkgICAgY29uc3QgX25CaXRMZW5ndGggPSBuQml0TGVuZ3RoICE9PSB1bmRlZmluZWQgPyBuQml0TGVuZ3RoIDogbi50b1N0cmluZygyKS5sZW5ndGg7CgkgICAgY29uc3QgbkJ5dGVMZW5ndGggPSBNYXRoLmNlaWwoX25CaXRMZW5ndGggLyA4KTsKCSAgICByZXR1cm4geyBuQml0TGVuZ3RoOiBfbkJpdExlbmd0aCwgbkJ5dGVMZW5ndGggfTsKCX0KCS8qKgoJICogSW5pdGlhbGl6ZXMgYSBmaW5pdGUgZmllbGQgb3ZlciBwcmltZS4gKipOb24tcHJpbWVzIGFyZSBub3Qgc3VwcG9ydGVkLioqCgkgKiBEbyBub3QgaW5pdCBpbiBsb29wOiBzbG93LiBWZXJ5IGZyYWdpbGU6IGFsd2F5cyBydW4gYSBiZW5jaG1hcmsgb24gYSBjaGFuZ2UuCgkgKiBNYWpvciBwZXJmb3JtYW5jZSBvcHRpbWl6YXRpb25zOgoJICogKiBhKSBkZW5vcm1hbGl6ZWQgb3BlcmF0aW9ucyBsaWtlIG11bE4gaW5zdGVhZCBvZiBtdWwKCSAqICogYikgc2FtZSBvYmplY3Qgc2hhcGU6IG5ldmVyIGFkZCBvciByZW1vdmUga2V5cwoJICogKiBjKSBPYmplY3QuZnJlZXplCgkgKiBOT1RFOiBvcGVyYXRpb25zIGRvbid0IGNoZWNrICdpc1ZhbGlkJyBmb3IgYWxsIGVsZW1lbnRzIGZvciBwZXJmb3JtYW5jZSByZWFzb25zLAoJICogaXQgaXMgY2FsbGVyIHJlc3BvbnNpYmlsaXR5IHRvIGNoZWNrIHRoaXMuCgkgKiBUaGlzIGlzIGxvdy1sZXZlbCBjb2RlLCBwbGVhc2UgbWFrZSBzdXJlIHlvdSBrbm93IHdoYXQgeW91IGRvaW5nLgoJICogQHBhcmFtIE9SREVSIHByaW1lIHBvc2l0aXZlIGJpZ2ludAoJICogQHBhcmFtIGJpdExlbiBob3cgbWFueSBiaXRzIHRoZSBmaWVsZCBjb25zdW1lcwoJICogQHBhcmFtIGlzTEUgKGRlZjogZmFsc2UpIGlmIGVuY29kaW5nIC8gZGVjb2Rpbmcgc2hvdWxkIGJlIGluIGxpdHRsZS1lbmRpYW4KCSAqIEBwYXJhbSByZWRlZiBvcHRpb25hbCBmYXN0ZXIgcmVkZWZpbml0aW9ucyBvZiBzcXJ0IGFuZCBvdGhlciBtZXRob2RzCgkgKi8KCWZ1bmN0aW9uIEZpZWxkKE9SREVSLCBiaXRMZW4sIGlzTEUgPSBmYWxzZSwgcmVkZWYgPSB7fSkgewoJICAgIGlmIChPUkRFUiA8PSBfMG4kNCkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGZpZWxkOiBleHBlY3RlZCBPUkRFUiA+IDAsIGdvdCAnICsgT1JERVIpOwoJICAgIGNvbnN0IHsgbkJpdExlbmd0aDogQklUUywgbkJ5dGVMZW5ndGg6IEJZVEVTIH0gPSBuTGVuZ3RoKE9SREVSLCBiaXRMZW4pOwoJICAgIGlmIChCWVRFUyA+IDIwNDgpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBmaWVsZDogZXhwZWN0ZWQgT1JERVIgb2YgPD0gMjA0OCBieXRlcycpOwoJICAgIGxldCBzcXJ0UDsgLy8gY2FjaGVkIHNxcnRQCgkgICAgY29uc3QgZiA9IE9iamVjdC5mcmVlemUoewoJICAgICAgICBPUkRFUiwKCSAgICAgICAgQklUUywKCSAgICAgICAgQllURVMsCgkgICAgICAgIE1BU0s6IGJpdE1hc2soQklUUyksCgkgICAgICAgIFpFUk86IF8wbiQ0LAoJICAgICAgICBPTkU6IF8xbiQ2LAoJICAgICAgICBjcmVhdGU6IChudW0pID0+IG1vZChudW0sIE9SREVSKSwKCSAgICAgICAgaXNWYWxpZDogKG51bSkgPT4gewoJICAgICAgICAgICAgaWYgKHR5cGVvZiBudW0gIT09ICdiaWdpbnQnKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBmaWVsZCBlbGVtZW50OiBleHBlY3RlZCBiaWdpbnQsIGdvdCAnICsgdHlwZW9mIG51bSk7CgkgICAgICAgICAgICByZXR1cm4gXzBuJDQgPD0gbnVtICYmIG51bSA8IE9SREVSOyAvLyAwIGlzIHZhbGlkIGVsZW1lbnQsIGJ1dCBpdCdzIG5vdCBpbnZlcnRpYmxlCgkgICAgICAgIH0sCgkgICAgICAgIGlzMDogKG51bSkgPT4gbnVtID09PSBfMG4kNCwKCSAgICAgICAgaXNPZGQ6IChudW0pID0+IChudW0gJiBfMW4kNikgPT09IF8xbiQ2LAoJICAgICAgICBuZWc6IChudW0pID0+IG1vZCgtbnVtLCBPUkRFUiksCgkgICAgICAgIGVxbDogKGxocywgcmhzKSA9PiBsaHMgPT09IHJocywKCSAgICAgICAgc3FyOiAobnVtKSA9PiBtb2QobnVtICogbnVtLCBPUkRFUiksCgkgICAgICAgIGFkZDogKGxocywgcmhzKSA9PiBtb2QobGhzICsgcmhzLCBPUkRFUiksCgkgICAgICAgIHN1YjogKGxocywgcmhzKSA9PiBtb2QobGhzIC0gcmhzLCBPUkRFUiksCgkgICAgICAgIG11bDogKGxocywgcmhzKSA9PiBtb2QobGhzICogcmhzLCBPUkRFUiksCgkgICAgICAgIHBvdzogKG51bSwgcG93ZXIpID0+IEZwUG93KGYsIG51bSwgcG93ZXIpLAoJICAgICAgICBkaXY6IChsaHMsIHJocykgPT4gbW9kKGxocyAqIGludmVydChyaHMsIE9SREVSKSwgT1JERVIpLAoJICAgICAgICAvLyBTYW1lIGFzIGFib3ZlLCBidXQgZG9lc24ndCBub3JtYWxpemUKCSAgICAgICAgc3FyTjogKG51bSkgPT4gbnVtICogbnVtLAoJICAgICAgICBhZGROOiAobGhzLCByaHMpID0+IGxocyArIHJocywKCSAgICAgICAgc3ViTjogKGxocywgcmhzKSA9PiBsaHMgLSByaHMsCgkgICAgICAgIG11bE46IChsaHMsIHJocykgPT4gbGhzICogcmhzLAoJICAgICAgICBpbnY6IChudW0pID0+IGludmVydChudW0sIE9SREVSKSwKCSAgICAgICAgc3FydDogcmVkZWYuc3FydCB8fAoJICAgICAgICAgICAgKChuKSA9PiB7CgkgICAgICAgICAgICAgICAgaWYgKCFzcXJ0UCkKCSAgICAgICAgICAgICAgICAgICAgc3FydFAgPSBGcFNxcnQoT1JERVIpOwoJICAgICAgICAgICAgICAgIHJldHVybiBzcXJ0UChmLCBuKTsKCSAgICAgICAgICAgIH0pLAoJICAgICAgICBpbnZlcnRCYXRjaDogKGxzdCkgPT4gRnBJbnZlcnRCYXRjaChmLCBsc3QpLAoJICAgICAgICAvLyBUT0RPOiBkbyB3ZSByZWFsbHkgbmVlZCBjb25zdGFudCBjbW92PwoJICAgICAgICAvLyBXZSBkb24ndCBoYXZlIGNvbnN0LXRpbWUgYmlnaW50cyBhbnl3YXksIHNvIHByb2JhYmx5IHdpbGwgYmUgbm90IHZlcnkgdXNlZnVsCgkgICAgICAgIGNtb3Y6IChhLCBiLCBjKSA9PiAoYyA/IGIgOiBhKSwKCSAgICAgICAgdG9CeXRlczogKG51bSkgPT4gKGlzTEUgPyBudW1iZXJUb0J5dGVzTEUobnVtLCBCWVRFUykgOiBudW1iZXJUb0J5dGVzQkUobnVtLCBCWVRFUykpLAoJICAgICAgICBmcm9tQnl0ZXM6IChieXRlcykgPT4gewoJICAgICAgICAgICAgaWYgKGJ5dGVzLmxlbmd0aCAhPT0gQllURVMpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGaWVsZC5mcm9tQnl0ZXM6IGV4cGVjdGVkICcgKyBCWVRFUyArICcgYnl0ZXMsIGdvdCAnICsgYnl0ZXMubGVuZ3RoKTsKCSAgICAgICAgICAgIHJldHVybiBpc0xFID8gYnl0ZXNUb051bWJlckxFKGJ5dGVzKSA6IGJ5dGVzVG9OdW1iZXJCRShieXRlcyk7CgkgICAgICAgIH0sCgkgICAgfSk7CgkgICAgcmV0dXJuIE9iamVjdC5mcmVlemUoZik7Cgl9CgkvKioKCSAqIFJldHVybnMgdG90YWwgbnVtYmVyIG9mIGJ5dGVzIGNvbnN1bWVkIGJ5IHRoZSBmaWVsZCBlbGVtZW50LgoJICogRm9yIGV4YW1wbGUsIDMyIGJ5dGVzIGZvciB1c3VhbCAyNTYtYml0IHdlaWVyc3RyYXNzIGN1cnZlLgoJICogQHBhcmFtIGZpZWxkT3JkZXIgbnVtYmVyIG9mIGZpZWxkIGVsZW1lbnRzLCB1c3VhbGx5IENVUlZFLm4KCSAqIEByZXR1cm5zIGJ5dGUgbGVuZ3RoIG9mIGZpZWxkCgkgKi8KCWZ1bmN0aW9uIGdldEZpZWxkQnl0ZXNMZW5ndGgoZmllbGRPcmRlcikgewoJICAgIGlmICh0eXBlb2YgZmllbGRPcmRlciAhPT0gJ2JpZ2ludCcpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcignZmllbGQgb3JkZXIgbXVzdCBiZSBiaWdpbnQnKTsKCSAgICBjb25zdCBiaXRMZW5ndGggPSBmaWVsZE9yZGVyLnRvU3RyaW5nKDIpLmxlbmd0aDsKCSAgICByZXR1cm4gTWF0aC5jZWlsKGJpdExlbmd0aCAvIDgpOwoJfQoJLyoqCgkgKiBSZXR1cm5zIG1pbmltYWwgYW1vdW50IG9mIGJ5dGVzIHRoYXQgY2FuIGJlIHNhZmVseSByZWR1Y2VkCgkgKiBieSBmaWVsZCBvcmRlci4KCSAqIFNob3VsZCBiZSAyXi0xMjggZm9yIDEyOC1iaXQgY3VydmUgc3VjaCBhcyBQMjU2LgoJICogQHBhcmFtIGZpZWxkT3JkZXIgbnVtYmVyIG9mIGZpZWxkIGVsZW1lbnRzLCB1c3VhbGx5IENVUlZFLm4KCSAqIEByZXR1cm5zIGJ5dGUgbGVuZ3RoIG9mIHRhcmdldCBoYXNoCgkgKi8KCWZ1bmN0aW9uIGdldE1pbkhhc2hMZW5ndGgoZmllbGRPcmRlcikgewoJICAgIGNvbnN0IGxlbmd0aCA9IGdldEZpZWxkQnl0ZXNMZW5ndGgoZmllbGRPcmRlcik7CgkgICAgcmV0dXJuIGxlbmd0aCArIE1hdGguY2VpbChsZW5ndGggLyAyKTsKCX0KCS8qKgoJICogIkNvbnN0YW50LXRpbWUiIHByaXZhdGUga2V5IGdlbmVyYXRpb24gdXRpbGl0eS4KCSAqIENhbiB0YWtlIChuICsgbi8yKSBvciBtb3JlIGJ5dGVzIG9mIHVuaWZvcm0gaW5wdXQgZS5nLiBmcm9tIENTUFJORyBvciBLREYKCSAqIGFuZCBjb252ZXJ0IHRoZW0gaW50byBwcml2YXRlIHNjYWxhciwgd2l0aCB0aGUgbW9kdWxvIGJpYXMgYmVpbmcgbmVnbGlnaWJsZS4KCSAqIE5lZWRzIGF0IGxlYXN0IDQ4IGJ5dGVzIG9mIGlucHV0IGZvciAzMi1ieXRlIHByaXZhdGUga2V5LgoJICogaHR0cHM6Ly9yZXNlYXJjaC5rdWRlbHNraXNlY3VyaXR5LmNvbS8yMDIwLzA3LzI4L3RoZS1kZWZpbml0aXZlLWd1aWRlLXRvLW1vZHVsby1iaWFzLWFuZC1ob3ctdG8tYXZvaWQtaXQvCgkgKiBGSVBTIDE4Ni01LCBBLjIgaHR0cHM6Ly9jc3JjLm5pc3QuZ292L3B1YmxpY2F0aW9ucy9kZXRhaWwvZmlwcy8xODYvNS9maW5hbAoJICogUkZDIDkzODAsIGh0dHBzOi8vd3d3LnJmYy1lZGl0b3Iub3JnL3JmYy9yZmM5MzgwI3NlY3Rpb24tNQoJICogQHBhcmFtIGhhc2ggaGFzaCBvdXRwdXQgZnJvbSBTSEEzIG9yIGEgc2ltaWxhciBmdW5jdGlvbgoJICogQHBhcmFtIGdyb3VwT3JkZXIgc2l6ZSBvZiBzdWJncm91cCAtIChlLmcuIHNlY3AyNTZrMS5DVVJWRS5uKQoJICogQHBhcmFtIGlzTEUgaW50ZXJwcmV0IGhhc2ggYnl0ZXMgYXMgTEUgbnVtCgkgKiBAcmV0dXJucyB2YWxpZCBwcml2YXRlIHNjYWxhcgoJICovCglmdW5jdGlvbiBtYXBIYXNoVG9GaWVsZChrZXksIGZpZWxkT3JkZXIsIGlzTEUgPSBmYWxzZSkgewoJICAgIGNvbnN0IGxlbiA9IGtleS5sZW5ndGg7CgkgICAgY29uc3QgZmllbGRMZW4gPSBnZXRGaWVsZEJ5dGVzTGVuZ3RoKGZpZWxkT3JkZXIpOwoJICAgIGNvbnN0IG1pbkxlbiA9IGdldE1pbkhhc2hMZW5ndGgoZmllbGRPcmRlcik7CgkgICAgLy8gTm8gc21hbGwgbnVtYmVyczogbmVlZCB0byB1bmRlcnN0YW5kIGJpYXMgc3RvcnkuIE5vIGh1Z2UgbnVtYmVyczogZWFzaWVyIHRvIGRldGVjdCBKUyB0aW1pbmdzLgoJICAgIGlmIChsZW4gPCAxNiB8fCBsZW4gPCBtaW5MZW4gfHwgbGVuID4gMTAyNCkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdleHBlY3RlZCAnICsgbWluTGVuICsgJy0xMDI0IGJ5dGVzIG9mIGlucHV0LCBnb3QgJyArIGxlbik7CgkgICAgY29uc3QgbnVtID0gaXNMRSA/IGJ5dGVzVG9OdW1iZXJCRShrZXkpIDogYnl0ZXNUb051bWJlckxFKGtleSk7CgkgICAgLy8gYG1vZCh4LCAxMSlgIGNhbiBzb21ldGltZXMgcHJvZHVjZSAwLiBgbW9kKHgsIDEwKSArIDFgIGlzIHRoZSBzYW1lLCBidXQgbm8gMAoJICAgIGNvbnN0IHJlZHVjZWQgPSBtb2QobnVtLCBmaWVsZE9yZGVyIC0gXzFuJDYpICsgXzFuJDY7CgkgICAgcmV0dXJuIGlzTEUgPyBudW1iZXJUb0J5dGVzTEUocmVkdWNlZCwgZmllbGRMZW4pIDogbnVtYmVyVG9CeXRlc0JFKHJlZHVjZWQsIGZpZWxkTGVuKTsKCX0KCgkvKiEgbm9ibGUtY3VydmVzIC0gTUlUIExpY2Vuc2UgKGMpIDIwMjIgUGF1bCBNaWxsZXIgKHBhdWxtaWxsci5jb20pICovCgkvLyBBYmVsaWFuIGdyb3VwIHV0aWxpdGllcwoJY29uc3QgXzBuJDMgPSBCaWdJbnQoMCk7Cgljb25zdCBfMW4kNSA9IEJpZ0ludCgxKTsKCWZ1bmN0aW9uIGNvbnN0VGltZU5lZ2F0ZShjb25kaXRpb24sIGl0ZW0pIHsKCSAgICBjb25zdCBuZWcgPSBpdGVtLm5lZ2F0ZSgpOwoJICAgIHJldHVybiBjb25kaXRpb24gPyBuZWcgOiBpdGVtOwoJfQoJZnVuY3Rpb24gdmFsaWRhdGVXKFcsIGJpdHMpIHsKCSAgICBpZiAoIU51bWJlci5pc1NhZmVJbnRlZ2VyKFcpIHx8IFcgPD0gMCB8fCBXID4gYml0cykKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHdpbmRvdyBzaXplLCBleHBlY3RlZCBbMS4uJyArIGJpdHMgKyAnXSwgZ290IFc9JyArIFcpOwoJfQoJZnVuY3Rpb24gY2FsY1dPcHRzKFcsIGJpdHMpIHsKCSAgICB2YWxpZGF0ZVcoVywgYml0cyk7CgkgICAgY29uc3Qgd2luZG93cyA9IE1hdGguY2VpbChiaXRzIC8gVykgKyAxOyAvLyArMSwgYmVjYXVzZQoJICAgIGNvbnN0IHdpbmRvd1NpemUgPSAyICoqIChXIC0gMSk7IC8vIC0xIGJlY2F1c2Ugd2Ugc2tpcCB6ZXJvCgkgICAgcmV0dXJuIHsgd2luZG93cywgd2luZG93U2l6ZSB9OwoJfQoJZnVuY3Rpb24gdmFsaWRhdGVNU01Qb2ludHMocG9pbnRzLCBjKSB7CgkgICAgaWYgKCFBcnJheS5pc0FycmF5KHBvaW50cykpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcignYXJyYXkgZXhwZWN0ZWQnKTsKCSAgICBwb2ludHMuZm9yRWFjaCgocCwgaSkgPT4gewoJICAgICAgICBpZiAoIShwIGluc3RhbmNlb2YgYykpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgcG9pbnQgYXQgaW5kZXggJyArIGkpOwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gdmFsaWRhdGVNU01TY2FsYXJzKHNjYWxhcnMsIGZpZWxkKSB7CgkgICAgaWYgKCFBcnJheS5pc0FycmF5KHNjYWxhcnMpKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FycmF5IG9mIHNjYWxhcnMgZXhwZWN0ZWQnKTsKCSAgICBzY2FsYXJzLmZvckVhY2goKHMsIGkpID0+IHsKCSAgICAgICAgaWYgKCFmaWVsZC5pc1ZhbGlkKHMpKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHNjYWxhciBhdCBpbmRleCAnICsgaSk7CgkgICAgfSk7Cgl9CgkvLyBTaW5jZSBwb2ludHMgaW4gZGlmZmVyZW50IGdyb3VwcyBjYW5ub3QgYmUgZXF1YWwgKGRpZmZlcmVudCBvYmplY3QgY29uc3RydWN0b3IpLAoJLy8gd2UgY2FuIGhhdmUgc2luZ2xlIHBsYWNlIHRvIHN0b3JlIHByZWNvbXB1dGVzCgljb25zdCBwb2ludFByZWNvbXB1dGVzID0gbmV3IFdlYWtNYXAoKTsKCWNvbnN0IHBvaW50V2luZG93U2l6ZXMgPSBuZXcgV2Vha01hcCgpOyAvLyBUaGlzIGFsbG93cyB1c2UgbWFrZSBwb2ludHMgaW1tdXRhYmxlIChub3RoaW5nIGNoYW5nZXMgaW5zaWRlKQoJZnVuY3Rpb24gZ2V0VyhQKSB7CgkgICAgcmV0dXJuIHBvaW50V2luZG93U2l6ZXMuZ2V0KFApIHx8IDE7Cgl9CgkvLyBFbGxpcHRpYyBjdXJ2ZSBtdWx0aXBsaWNhdGlvbiBvZiBQb2ludCBieSBzY2FsYXIuIEZyYWdpbGUuCgkvLyBTY2FsYXJzIHNob3VsZCBhbHdheXMgYmUgbGVzcyB0aGFuIGN1cnZlIG9yZGVyOiB0aGlzIHNob3VsZCBiZSBjaGVja2VkIGluc2lkZSBvZiBhIGN1cnZlIGl0c2VsZi4KCS8vIENyZWF0ZXMgcHJlY29tcHV0YXRpb24gdGFibGVzIGZvciBmYXN0IG11bHRpcGxpY2F0aW9uOgoJLy8gLSBwcml2YXRlIHNjYWxhciBpcyBzcGxpdCBieSBmaXhlZCBzaXplIHdpbmRvd3Mgb2YgVyBiaXRzCgkvLyAtIGV2ZXJ5IHdpbmRvdyBwb2ludCBpcyBjb2xsZWN0ZWQgZnJvbSB3aW5kb3cncyB0YWJsZSAmIGFkZGVkIHRvIGFjY3VtdWxhdG9yCgkvLyAtIHNpbmNlIHdpbmRvd3MgYXJlIGRpZmZlcmVudCwgc2FtZSBwb2ludCBpbnNpZGUgdGFibGVzIHdvbid0IGJlIGFjY2Vzc2VkIG1vcmUgdGhhbiBvbmNlIHBlciBjYWxjCgkvLyAtIGVhY2ggbXVsdGlwbGljYXRpb24gaXMgJ01hdGguY2VpbChDVVJWRV9PUkRFUiAvIPCdkYopICsgMScgcG9pbnQgYWRkaXRpb25zIChmaXhlZCBmb3IgYW55IHNjYWxhcikKCS8vIC0gKzEgd2luZG93IGlzIG5lY2Nlc3NhcnkgZm9yIHdOQUYKCS8vIC0gd05BRiByZWR1Y2VzIHRhYmxlIHNpemU6IDJ4IGxlc3MgbWVtb3J5ICsgMnggZmFzdGVyIGdlbmVyYXRpb24sIGJ1dCAxMCUgc2xvd2VyIG11bHRpcGxpY2F0aW9uCgkvLyBUT0RPOiBSZXNlYXJjaCByZXR1cm5pbmcgMmQgSlMgYXJyYXkgb2Ygd2luZG93cywgaW5zdGVhZCBvZiBhIHNpbmdsZSB3aW5kb3cuIFRoaXMgd291bGQgYWxsb3cKCS8vIHdpbmRvd3MgdG8gYmUgaW4gZGlmZmVyZW50IG1lbW9yeSBsb2NhdGlvbnMKCWZ1bmN0aW9uIHdOQUYoYywgYml0cykgewoJICAgIHJldHVybiB7CgkgICAgICAgIGNvbnN0VGltZU5lZ2F0ZSwKCSAgICAgICAgaGFzUHJlY29tcHV0ZXMoZWxtKSB7CgkgICAgICAgICAgICByZXR1cm4gZ2V0VyhlbG0pICE9PSAxOwoJICAgICAgICB9LAoJICAgICAgICAvLyBub24tY29uc3QgdGltZSBtdWx0aXBsaWNhdGlvbiBsYWRkZXIKCSAgICAgICAgdW5zYWZlTGFkZGVyKGVsbSwgbiwgcCA9IGMuWkVSTykgewoJICAgICAgICAgICAgbGV0IGQgPSBlbG07CgkgICAgICAgICAgICB3aGlsZSAobiA+IF8wbiQzKSB7CgkgICAgICAgICAgICAgICAgaWYgKG4gJiBfMW4kNSkKCSAgICAgICAgICAgICAgICAgICAgcCA9IHAuYWRkKGQpOwoJICAgICAgICAgICAgICAgIGQgPSBkLmRvdWJsZSgpOwoJICAgICAgICAgICAgICAgIG4gPj49IF8xbiQ1OwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHA7CgkgICAgICAgIH0sCgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgd05BRiBwcmVjb21wdXRhdGlvbiB3aW5kb3cuIFVzZWQgZm9yIGNhY2hpbmcuCgkgICAgICAgICAqIERlZmF1bHQgd2luZG93IHNpemUgaXMgc2V0IGJ5IGB1dGlscy5wcmVjb21wdXRlKClgIGFuZCBpcyBlcXVhbCB0byA4LgoJICAgICAgICAgKiBOdW1iZXIgb2YgcHJlY29tcHV0ZWQgcG9pbnRzIGRlcGVuZHMgb24gdGhlIGN1cnZlIHNpemU6CgkgICAgICAgICAqIDJeKPCdkYriiJIxKSAqIChNYXRoLmNlaWwo8J2RmyAvIPCdkYopICsgMSksIHdoZXJlOgoJICAgICAgICAgKiAtIPCdkYogaXMgdGhlIHdpbmRvdyBzaXplCgkgICAgICAgICAqIC0g8J2RmyBpcyB0aGUgYml0bGVuZ3RoIG9mIHRoZSBjdXJ2ZSBvcmRlci4KCSAgICAgICAgICogRm9yIGEgMjU2LWJpdCBjdXJ2ZSBhbmQgd2luZG93IHNpemUgOCwgdGhlIG51bWJlciBvZiBwcmVjb21wdXRlZCBwb2ludHMgaXMgMTI4ICogMzMgPSA0MjI0LgoJICAgICAgICAgKiBAcGFyYW0gZWxtIFBvaW50IGluc3RhbmNlCgkgICAgICAgICAqIEBwYXJhbSBXIHdpbmRvdyBzaXplCgkgICAgICAgICAqIEByZXR1cm5zIHByZWNvbXB1dGVkIHBvaW50IHRhYmxlcyBmbGF0dGVuZWQgdG8gYSBzaW5nbGUgYXJyYXkKCSAgICAgICAgICovCgkgICAgICAgIHByZWNvbXB1dGVXaW5kb3coZWxtLCBXKSB7CgkgICAgICAgICAgICBjb25zdCB7IHdpbmRvd3MsIHdpbmRvd1NpemUgfSA9IGNhbGNXT3B0cyhXLCBiaXRzKTsKCSAgICAgICAgICAgIGNvbnN0IHBvaW50cyA9IFtdOwoJICAgICAgICAgICAgbGV0IHAgPSBlbG07CgkgICAgICAgICAgICBsZXQgYmFzZSA9IHA7CgkgICAgICAgICAgICBmb3IgKGxldCB3aW5kb3cgPSAwOyB3aW5kb3cgPCB3aW5kb3dzOyB3aW5kb3crKykgewoJICAgICAgICAgICAgICAgIGJhc2UgPSBwOwoJICAgICAgICAgICAgICAgIHBvaW50cy5wdXNoKGJhc2UpOwoJICAgICAgICAgICAgICAgIC8vID0xLCBiZWNhdXNlIHdlIHNraXAgemVybwoJICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgd2luZG93U2l6ZTsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgIGJhc2UgPSBiYXNlLmFkZChwKTsKCSAgICAgICAgICAgICAgICAgICAgcG9pbnRzLnB1c2goYmFzZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIHAgPSBiYXNlLmRvdWJsZSgpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHBvaW50czsKCSAgICAgICAgfSwKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEltcGxlbWVudHMgZWMgbXVsdGlwbGljYXRpb24gdXNpbmcgcHJlY29tcHV0ZWQgdGFibGVzIGFuZCB3LWFyeSBub24tYWRqYWNlbnQgZm9ybS4KCSAgICAgICAgICogQHBhcmFtIFcgd2luZG93IHNpemUKCSAgICAgICAgICogQHBhcmFtIHByZWNvbXB1dGVzIHByZWNvbXB1dGVkIHRhYmxlcwoJICAgICAgICAgKiBAcGFyYW0gbiBzY2FsYXIgKHdlIGRvbid0IGNoZWNrIGhlcmUsIGJ1dCBzaG91bGQgYmUgbGVzcyB0aGFuIGN1cnZlIG9yZGVyKQoJICAgICAgICAgKiBAcmV0dXJucyByZWFsIGFuZCBmYWtlIChmb3IgY29uc3QtdGltZSkgcG9pbnRzCgkgICAgICAgICAqLwoJICAgICAgICB3TkFGKFcsIHByZWNvbXB1dGVzLCBuKSB7CgkgICAgICAgICAgICAvLyBUT0RPOiBtYXliZSBjaGVjayB0aGF0IHNjYWxhciBpcyBsZXNzIHRoYW4gZ3JvdXAgb3JkZXI/IHdOQUYgYmVoYXZpb3VzIGlzIHVuZGVmaW5lZCBvdGhlcndpc2UKCSAgICAgICAgICAgIC8vIEJ1dCBuZWVkIHRvIGNhcmVmdWxseSByZW1vdmUgb3RoZXIgY2hlY2tzIGJlZm9yZSB3TkFGLiBPUkRFUiA9PSBiaXRzIGhlcmUKCSAgICAgICAgICAgIGNvbnN0IHsgd2luZG93cywgd2luZG93U2l6ZSB9ID0gY2FsY1dPcHRzKFcsIGJpdHMpOwoJICAgICAgICAgICAgbGV0IHAgPSBjLlpFUk87CgkgICAgICAgICAgICBsZXQgZiA9IGMuQkFTRTsKCSAgICAgICAgICAgIGNvbnN0IG1hc2sgPSBCaWdJbnQoMiAqKiBXIC0gMSk7IC8vIENyZWF0ZSBtYXNrIHdpdGggVyBvbmVzOiAwYjExMTEgZm9yIFc9NCBldGMuCgkgICAgICAgICAgICBjb25zdCBtYXhOdW1iZXIgPSAyICoqIFc7CgkgICAgICAgICAgICBjb25zdCBzaGlmdEJ5ID0gQmlnSW50KFcpOwoJICAgICAgICAgICAgZm9yIChsZXQgd2luZG93ID0gMDsgd2luZG93IDwgd2luZG93czsgd2luZG93KyspIHsKCSAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSB3aW5kb3cgKiB3aW5kb3dTaXplOwoJICAgICAgICAgICAgICAgIC8vIEV4dHJhY3QgVyBiaXRzLgoJICAgICAgICAgICAgICAgIGxldCB3Yml0cyA9IE51bWJlcihuICYgbWFzayk7CgkgICAgICAgICAgICAgICAgLy8gU2hpZnQgbnVtYmVyIGJ5IFcgYml0cy4KCSAgICAgICAgICAgICAgICBuID4+PSBzaGlmdEJ5OwoJICAgICAgICAgICAgICAgIC8vIElmIHRoZSBiaXRzIGFyZSBiaWdnZXIgdGhhbiBtYXggc2l6ZSwgd2UnbGwgc3BsaXQgdGhvc2UuCgkgICAgICAgICAgICAgICAgLy8gKzIyNCA9PiAyNTYgLSAzMgoJICAgICAgICAgICAgICAgIGlmICh3Yml0cyA+IHdpbmRvd1NpemUpIHsKCSAgICAgICAgICAgICAgICAgICAgd2JpdHMgLT0gbWF4TnVtYmVyOwoJICAgICAgICAgICAgICAgICAgICBuICs9IF8xbiQ1OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAvLyBUaGlzIGNvZGUgd2FzIGZpcnN0IHdyaXR0ZW4gd2l0aCBhc3N1bXB0aW9uIHRoYXQgJ2YnIGFuZCAncCcgd2lsbCBuZXZlciBiZSBpbmZpbml0eSBwb2ludDoKCSAgICAgICAgICAgICAgICAvLyBzaW5jZSBlYWNoIGFkZGl0aW9uIGlzIG11bHRpcGxpZWQgYnkgMiAqKiBXLCBpdCBjYW5ub3QgY2FuY2VsIGVhY2ggb3RoZXIuIEhvd2V2ZXIsCgkgICAgICAgICAgICAgICAgLy8gdGhlcmUgaXMgbmVnYXRlIG5vdzogaXQgaXMgcG9zc2libGUgdGhhdCBuZWdhdGVkIGVsZW1lbnQgZnJvbSBsb3cgdmFsdWUKCSAgICAgICAgICAgICAgICAvLyB3b3VsZCBiZSB0aGUgc2FtZSBhcyBoaWdoIGVsZW1lbnQsIHdoaWNoIHdpbGwgY3JlYXRlIGNhcnJ5IGludG8gbmV4dCB3aW5kb3cuCgkgICAgICAgICAgICAgICAgLy8gSXQncyBub3Qgb2J2aW91cyBob3cgdGhpcyBjYW4gZmFpbCwgYnV0IHN0aWxsIHdvcnRoIGludmVzdGlnYXRpbmcgbGF0ZXIuCgkgICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgb250byBaZXJvIHBvaW50LgoJICAgICAgICAgICAgICAgIC8vIEFkZCByYW5kb20gcG9pbnQgaW5zaWRlIGN1cnJlbnQgd2luZG93IHRvIGYuCgkgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0MSA9IG9mZnNldDsKCSAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQyID0gb2Zmc2V0ICsgTWF0aC5hYnMod2JpdHMpIC0gMTsgLy8gLTEgYmVjYXVzZSB3ZSBza2lwIHplcm8KCSAgICAgICAgICAgICAgICBjb25zdCBjb25kMSA9IHdpbmRvdyAlIDIgIT09IDA7CgkgICAgICAgICAgICAgICAgY29uc3QgY29uZDIgPSB3Yml0cyA8IDA7CgkgICAgICAgICAgICAgICAgaWYgKHdiaXRzID09PSAwKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBtb3N0IGltcG9ydGFudCBwYXJ0IGZvciBjb25zdC10aW1lIGdldFB1YmxpY0tleQoJICAgICAgICAgICAgICAgICAgICBmID0gZi5hZGQoY29uc3RUaW1lTmVnYXRlKGNvbmQxLCBwcmVjb21wdXRlc1tvZmZzZXQxXSkpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgcCA9IHAuYWRkKGNvbnN0VGltZU5lZ2F0ZShjb25kMiwgcHJlY29tcHV0ZXNbb2Zmc2V0Ml0pKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICAvLyBKSVQtY29tcGlsZXIgc2hvdWxkIG5vdCBlbGltaW5hdGUgZiBoZXJlLCBzaW5jZSBpdCB3aWxsIGxhdGVyIGJlIHVzZWQgaW4gbm9ybWFsaXplWigpCgkgICAgICAgICAgICAvLyBFdmVuIGlmIHRoZSB2YXJpYWJsZSBpcyBzdGlsbCB1bnVzZWQsIHRoZXJlIGFyZSBzb21lIGNoZWNrcyB3aGljaCB3aWxsCgkgICAgICAgICAgICAvLyB0aHJvdyBhbiBleGNlcHRpb24sIHNvIGNvbXBpbGVyIG5lZWRzIHRvIHByb3ZlIHRoZXkgd29uJ3QgaGFwcGVuLCB3aGljaCBpcyBoYXJkLgoJICAgICAgICAgICAgLy8gQXQgdGhpcyBwb2ludCB0aGVyZSBpcyBhIHdheSB0byBGIGJlIGluZmluaXR5LXBvaW50IGV2ZW4gaWYgcCBpcyBub3QsCgkgICAgICAgICAgICAvLyB3aGljaCBtYWtlcyBpdCBsZXNzIGNvbnN0LXRpbWU6IGFyb3VuZCAxIGJpZ2ludCBtdWx0aXBseS4KCSAgICAgICAgICAgIHJldHVybiB7IHAsIGYgfTsKCSAgICAgICAgfSwKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEltcGxlbWVudHMgZWMgdW5zYWZlIChub24gY29uc3QtdGltZSkgbXVsdGlwbGljYXRpb24gdXNpbmcgcHJlY29tcHV0ZWQgdGFibGVzIGFuZCB3LWFyeSBub24tYWRqYWNlbnQgZm9ybS4KCSAgICAgICAgICogQHBhcmFtIFcgd2luZG93IHNpemUKCSAgICAgICAgICogQHBhcmFtIHByZWNvbXB1dGVzIHByZWNvbXB1dGVkIHRhYmxlcwoJICAgICAgICAgKiBAcGFyYW0gbiBzY2FsYXIgKHdlIGRvbid0IGNoZWNrIGhlcmUsIGJ1dCBzaG91bGQgYmUgbGVzcyB0aGFuIGN1cnZlIG9yZGVyKQoJICAgICAgICAgKiBAcGFyYW0gYWNjIGFjY3VtdWxhdG9yIHBvaW50IHRvIGFkZCByZXN1bHQgb2YgbXVsdGlwbGljYXRpb24KCSAgICAgICAgICogQHJldHVybnMgcG9pbnQKCSAgICAgICAgICovCgkgICAgICAgIHdOQUZVbnNhZmUoVywgcHJlY29tcHV0ZXMsIG4sIGFjYyA9IGMuWkVSTykgewoJICAgICAgICAgICAgY29uc3QgeyB3aW5kb3dzLCB3aW5kb3dTaXplIH0gPSBjYWxjV09wdHMoVywgYml0cyk7CgkgICAgICAgICAgICBjb25zdCBtYXNrID0gQmlnSW50KDIgKiogVyAtIDEpOyAvLyBDcmVhdGUgbWFzayB3aXRoIFcgb25lczogMGIxMTExIGZvciBXPTQgZXRjLgoJICAgICAgICAgICAgY29uc3QgbWF4TnVtYmVyID0gMiAqKiBXOwoJICAgICAgICAgICAgY29uc3Qgc2hpZnRCeSA9IEJpZ0ludChXKTsKCSAgICAgICAgICAgIGZvciAobGV0IHdpbmRvdyA9IDA7IHdpbmRvdyA8IHdpbmRvd3M7IHdpbmRvdysrKSB7CgkgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gd2luZG93ICogd2luZG93U2l6ZTsKCSAgICAgICAgICAgICAgICBpZiAobiA9PT0gXzBuJDMpCgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOyAvLyBObyBuZWVkIHRvIGdvIG92ZXIgZW1wdHkgc2NhbGFyCgkgICAgICAgICAgICAgICAgLy8gRXh0cmFjdCBXIGJpdHMuCgkgICAgICAgICAgICAgICAgbGV0IHdiaXRzID0gTnVtYmVyKG4gJiBtYXNrKTsKCSAgICAgICAgICAgICAgICAvLyBTaGlmdCBudW1iZXIgYnkgVyBiaXRzLgoJICAgICAgICAgICAgICAgIG4gPj49IHNoaWZ0Qnk7CgkgICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJpdHMgYXJlIGJpZ2dlciB0aGFuIG1heCBzaXplLCB3ZSdsbCBzcGxpdCB0aG9zZS4KCSAgICAgICAgICAgICAgICAvLyArMjI0ID0+IDI1NiAtIDMyCgkgICAgICAgICAgICAgICAgaWYgKHdiaXRzID4gd2luZG93U2l6ZSkgewoJICAgICAgICAgICAgICAgICAgICB3Yml0cyAtPSBtYXhOdW1iZXI7CgkgICAgICAgICAgICAgICAgICAgIG4gKz0gXzFuJDU7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlmICh3Yml0cyA9PT0gMCkKCSAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgICAgbGV0IGN1cnIgPSBwcmVjb21wdXRlc1tvZmZzZXQgKyBNYXRoLmFicyh3Yml0cykgLSAxXTsgLy8gLTEgYmVjYXVzZSB3ZSBza2lwIHplcm8KCSAgICAgICAgICAgICAgICBpZiAod2JpdHMgPCAwKQoJICAgICAgICAgICAgICAgICAgICBjdXJyID0gY3Vyci5uZWdhdGUoKTsKCSAgICAgICAgICAgICAgICAvLyBOT1RFOiBieSByZS11c2luZyBhY2MsIHdlIGNhbiBzYXZlIGEgbG90IG9mIGFkZGl0aW9ucyBpbiBjYXNlIG9mIE1TTQoJICAgICAgICAgICAgICAgIGFjYyA9IGFjYy5hZGQoY3Vycik7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gYWNjOwoJICAgICAgICB9LAoJICAgICAgICBnZXRQcmVjb21wdXRlcyhXLCBQLCB0cmFuc2Zvcm0pIHsKCSAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBwcmVjb21wdXRlcyBvbiBhIGZpcnN0IHJ1biwgcmV1c2UgdGhlbSBhZnRlcgoJICAgICAgICAgICAgbGV0IGNvbXAgPSBwb2ludFByZWNvbXB1dGVzLmdldChQKTsKCSAgICAgICAgICAgIGlmICghY29tcCkgewoJICAgICAgICAgICAgICAgIGNvbXAgPSB0aGlzLnByZWNvbXB1dGVXaW5kb3coUCwgVyk7CgkgICAgICAgICAgICAgICAgaWYgKFcgIT09IDEpCgkgICAgICAgICAgICAgICAgICAgIHBvaW50UHJlY29tcHV0ZXMuc2V0KFAsIHRyYW5zZm9ybShjb21wKSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gY29tcDsKCSAgICAgICAgfSwKCSAgICAgICAgd05BRkNhY2hlZChQLCBuLCB0cmFuc2Zvcm0pIHsKCSAgICAgICAgICAgIGNvbnN0IFcgPSBnZXRXKFApOwoJICAgICAgICAgICAgcmV0dXJuIHRoaXMud05BRihXLCB0aGlzLmdldFByZWNvbXB1dGVzKFcsIFAsIHRyYW5zZm9ybSksIG4pOwoJICAgICAgICB9LAoJICAgICAgICB3TkFGQ2FjaGVkVW5zYWZlKFAsIG4sIHRyYW5zZm9ybSwgcHJldikgewoJICAgICAgICAgICAgY29uc3QgVyA9IGdldFcoUCk7CgkgICAgICAgICAgICBpZiAoVyA9PT0gMSkKCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51bnNhZmVMYWRkZXIoUCwgbiwgcHJldik7IC8vIEZvciBXPTEgbGFkZGVyIGlzIH54MiBmYXN0ZXIKCSAgICAgICAgICAgIHJldHVybiB0aGlzLndOQUZVbnNhZmUoVywgdGhpcy5nZXRQcmVjb21wdXRlcyhXLCBQLCB0cmFuc2Zvcm0pLCBuLCBwcmV2KTsKCSAgICAgICAgfSwKCSAgICAgICAgLy8gV2UgY2FsY3VsYXRlIHByZWNvbXB1dGVzIGZvciBlbGxpcHRpYyBjdXJ2ZSBwb2ludCBtdWx0aXBsaWNhdGlvbgoJICAgICAgICAvLyB1c2luZyB3aW5kb3dlZCBtZXRob2QuIFRoaXMgc3BlY2lmaWVzIHdpbmRvdyBzaXplIGFuZAoJICAgICAgICAvLyBzdG9yZXMgcHJlY29tcHV0ZWQgdmFsdWVzLiBVc3VhbGx5IG9ubHkgYmFzZSBwb2ludCB3b3VsZCBiZSBwcmVjb21wdXRlZC4KCSAgICAgICAgc2V0V2luZG93U2l6ZShQLCBXKSB7CgkgICAgICAgICAgICB2YWxpZGF0ZVcoVywgYml0cyk7CgkgICAgICAgICAgICBwb2ludFdpbmRvd1NpemVzLnNldChQLCBXKTsKCSAgICAgICAgICAgIHBvaW50UHJlY29tcHV0ZXMuZGVsZXRlKFApOwoJICAgICAgICB9LAoJICAgIH07Cgl9CgkvKioKCSAqIFBpcHBlbmdlciBhbGdvcml0aG0gZm9yIG11bHRpLXNjYWxhciBtdWx0aXBsaWNhdGlvbiAoTVNNLCBQYSArIFFiICsgUmMgKyAuLi4pLgoJICogMzB4IGZhc3RlciB2cyBuYWl2ZSBhZGRpdGlvbiBvbiBMPTQwOTYsIDEweCBmYXN0ZXIgd2l0aCBwcmVjb21wdXRlcy4KCSAqIEZvciBOPTI1NGJpdCwgTD0xLCBpdCBkb2VzOiAxMDI0IEFERCArIDI1NCBEQkwuIEZvciBMPTU6IDE1MzYgQUREICsgMjU0IERCTC4KCSAqIEFsZ29yaXRobWljYWxseSBjb25zdGFudC10aW1lIChmb3Igc2FtZSBMKSwgZXZlbiB3aGVuIDEgcG9pbnQgKyBzY2FsYXIsIG9yIHdoZW4gc2NhbGFyID0gMC4KCSAqIEBwYXJhbSBjIEN1cnZlIFBvaW50IGNvbnN0cnVjdG9yCgkgKiBAcGFyYW0gZmllbGROIGZpZWxkIG92ZXIgQ1VSVkUuTiAtIGltcG9ydGFudCB0aGF0IGl0J3Mgbm90IG92ZXIgQ1VSVkUuUAoJICogQHBhcmFtIHBvaW50cyBhcnJheSBvZiBMIGN1cnZlIHBvaW50cwoJICogQHBhcmFtIHNjYWxhcnMgYXJyYXkgb2YgTCBzY2FsYXJzIChha2EgcHJpdmF0ZSBrZXlzIC8gYmlnaW50cykKCSAqLwoJZnVuY3Rpb24gcGlwcGVuZ2VyKGMsIGZpZWxkTiwgcG9pbnRzLCBzY2FsYXJzKSB7CgkgICAgLy8gSWYgd2Ugc3BsaXQgc2NhbGFycyBieSBzb21lIHdpbmRvdyAobGV0J3Mgc2F5IDggYml0cyksIGV2ZXJ5IGNodW5rIHdpbGwgb25seQoJICAgIC8vIHRha2UgMjU2IGJ1Y2tldHMgZXZlbiBpZiB0aGVyZSBhcmUgNDA5NiBzY2FsYXJzLCBhbHNvIHJlLXVzZXMgZG91YmxlLgoJICAgIC8vIFRPRE86CgkgICAgLy8gLSBodHRwczovL2VwcmludC5pYWNyLm9yZy8yMDI0Lzc1MC5wZGYKCSAgICAvLyAtIGh0dHBzOi8vdGNoZXMuaWFjci5vcmcvaW5kZXgucGhwL1RDSEVTL2FydGljbGUvdmlldy8xMDI4NwoJICAgIC8vIDAgaXMgYWNjZXB0ZWQgaW4gc2NhbGFycwoJICAgIHZhbGlkYXRlTVNNUG9pbnRzKHBvaW50cywgYyk7CgkgICAgdmFsaWRhdGVNU01TY2FsYXJzKHNjYWxhcnMsIGZpZWxkTik7CgkgICAgaWYgKHBvaW50cy5sZW5ndGggIT09IHNjYWxhcnMubGVuZ3RoKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FycmF5cyBvZiBwb2ludHMgYW5kIHNjYWxhcnMgbXVzdCBoYXZlIGVxdWFsIGxlbmd0aCcpOwoJICAgIGNvbnN0IHplcm8gPSBjLlpFUk87CgkgICAgY29uc3Qgd2JpdHMgPSBiaXRMZW4oQmlnSW50KHBvaW50cy5sZW5ndGgpKTsKCSAgICBjb25zdCB3aW5kb3dTaXplID0gd2JpdHMgPiAxMiA/IHdiaXRzIC0gMyA6IHdiaXRzID4gNCA/IHdiaXRzIC0gMiA6IHdiaXRzID8gMiA6IDE7IC8vIGluIGJpdHMKCSAgICBjb25zdCBNQVNLID0gKDEgPDwgd2luZG93U2l6ZSkgLSAxOwoJICAgIGNvbnN0IGJ1Y2tldHMgPSBuZXcgQXJyYXkoTUFTSyArIDEpLmZpbGwoemVybyk7IC8vICsxIGZvciB6ZXJvIGFycmF5CgkgICAgY29uc3QgbGFzdEJpdHMgPSBNYXRoLmZsb29yKChmaWVsZE4uQklUUyAtIDEpIC8gd2luZG93U2l6ZSkgKiB3aW5kb3dTaXplOwoJICAgIGxldCBzdW0gPSB6ZXJvOwoJICAgIGZvciAobGV0IGkgPSBsYXN0Qml0czsgaSA+PSAwOyBpIC09IHdpbmRvd1NpemUpIHsKCSAgICAgICAgYnVja2V0cy5maWxsKHplcm8pOwoJICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHNjYWxhcnMubGVuZ3RoOyBqKyspIHsKCSAgICAgICAgICAgIGNvbnN0IHNjYWxhciA9IHNjYWxhcnNbal07CgkgICAgICAgICAgICBjb25zdCB3Yml0cyA9IE51bWJlcigoc2NhbGFyID4+IEJpZ0ludChpKSkgJiBCaWdJbnQoTUFTSykpOwoJICAgICAgICAgICAgYnVja2V0c1t3Yml0c10gPSBidWNrZXRzW3diaXRzXS5hZGQocG9pbnRzW2pdKTsKCSAgICAgICAgfQoJICAgICAgICBsZXQgcmVzSSA9IHplcm87IC8vIG5vdCB1c2luZyB0aGlzIHdpbGwgZG8gc21hbGwgc3BlZWQtdXAsIGJ1dCB3aWxsIGxvc2UgY3QKCSAgICAgICAgLy8gU2tpcCBmaXJzdCBidWNrZXQsIGJlY2F1c2UgaXQgaXMgemVybwoJICAgICAgICBmb3IgKGxldCBqID0gYnVja2V0cy5sZW5ndGggLSAxLCBzdW1JID0gemVybzsgaiA+IDA7IGotLSkgewoJICAgICAgICAgICAgc3VtSSA9IHN1bUkuYWRkKGJ1Y2tldHNbal0pOwoJICAgICAgICAgICAgcmVzSSA9IHJlc0kuYWRkKHN1bUkpOwoJICAgICAgICB9CgkgICAgICAgIHN1bSA9IHN1bS5hZGQocmVzSSk7CgkgICAgICAgIGlmIChpICE9PSAwKQoJICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB3aW5kb3dTaXplOyBqKyspCgkgICAgICAgICAgICAgICAgc3VtID0gc3VtLmRvdWJsZSgpOwoJICAgIH0KCSAgICByZXR1cm4gc3VtOwoJfQoJZnVuY3Rpb24gdmFsaWRhdGVCYXNpYyhjdXJ2ZSkgewoJICAgIHZhbGlkYXRlRmllbGQoY3VydmUuRnApOwoJICAgIHZhbGlkYXRlT2JqZWN0KGN1cnZlLCB7CgkgICAgICAgIG46ICdiaWdpbnQnLAoJICAgICAgICBoOiAnYmlnaW50JywKCSAgICAgICAgR3g6ICdmaWVsZCcsCgkgICAgICAgIEd5OiAnZmllbGQnLAoJICAgIH0sIHsKCSAgICAgICAgbkJpdExlbmd0aDogJ2lzU2FmZUludGVnZXInLAoJICAgICAgICBuQnl0ZUxlbmd0aDogJ2lzU2FmZUludGVnZXInLAoJICAgIH0pOwoJICAgIC8vIFNldCBkZWZhdWx0cwoJICAgIHJldHVybiBPYmplY3QuZnJlZXplKHsKCSAgICAgICAgLi4ubkxlbmd0aChjdXJ2ZS5uLCBjdXJ2ZS5uQml0TGVuZ3RoKSwKCSAgICAgICAgLi4uY3VydmUsCgkgICAgICAgIC4uLnsgcDogY3VydmUuRnAuT1JERVIgfSwKCSAgICB9KTsKCX0KCgkvKiEgbm9ibGUtY3VydmVzIC0gTUlUIExpY2Vuc2UgKGMpIDIwMjIgUGF1bCBNaWxsZXIgKHBhdWxtaWxsci5jb20pICovCgkvLyBUd2lzdGVkIEVkd2FyZHMgY3VydmUuIFRoZSBmb3JtdWxhIGlzOiBheMKyICsgecKyID0gMSArIGR4wrJ5wrIKCS8vIEJlIGZyaWVuZGx5IHRvIGJhZCBFQ01BU2NyaXB0IHBhcnNlcnMgYnkgbm90IHVzaW5nIGJpZ2ludCBsaXRlcmFscwoJLy8gcHJldHRpZXItaWdub3JlCgljb25zdCBfMG4kMiA9IEJpZ0ludCgwKSwgXzFuJDQgPSBCaWdJbnQoMSksIF8ybiQzID0gQmlnSW50KDIpLCBfOG4kMSA9IEJpZ0ludCg4KTsKCS8vIHZlcmlmaWNhdGlvbiBydWxlIGlzIGVpdGhlciB6aXAyMTUgb3IgcmZjODAzMiAvIG5pc3QxODYtNS4gQ29uc3VsdCBmcm9tSGV4OgoJY29uc3QgVkVSSUZZX0RFRkFVTFQgPSB7IHppcDIxNTogdHJ1ZSB9OwoJZnVuY3Rpb24gdmFsaWRhdGVPcHRzJDEoY3VydmUpIHsKCSAgICBjb25zdCBvcHRzID0gdmFsaWRhdGVCYXNpYyhjdXJ2ZSk7CgkgICAgdmFsaWRhdGVPYmplY3QoY3VydmUsIHsKCSAgICAgICAgaGFzaDogJ2Z1bmN0aW9uJywKCSAgICAgICAgYTogJ2JpZ2ludCcsCgkgICAgICAgIGQ6ICdiaWdpbnQnLAoJICAgICAgICByYW5kb21CeXRlczogJ2Z1bmN0aW9uJywKCSAgICB9LCB7CgkgICAgICAgIGFkanVzdFNjYWxhckJ5dGVzOiAnZnVuY3Rpb24nLAoJICAgICAgICBkb21haW46ICdmdW5jdGlvbicsCgkgICAgICAgIHV2UmF0aW86ICdmdW5jdGlvbicsCgkgICAgICAgIG1hcFRvQ3VydmU6ICdmdW5jdGlvbicsCgkgICAgfSk7CgkgICAgLy8gU2V0IGRlZmF1bHRzCgkgICAgcmV0dXJuIE9iamVjdC5mcmVlemUoeyAuLi5vcHRzIH0pOwoJfQoJLyoqCgkgKiBDcmVhdGVzIFR3aXN0ZWQgRWR3YXJkcyBjdXJ2ZSB3aXRoIEVkRFNBIHNpZ25hdHVyZXMuCgkgKiBAZXhhbXBsZQoJICogaW1wb3J0IHsgRmllbGQgfSBmcm9tICdAbm9ibGUvY3VydmVzL2Fic3RyYWN0L21vZHVsYXInOwoJICogLy8gQmVmb3JlIHRoYXQsIGRlZmluZSBCaWdJbnQtczogYSwgZCwgcCwgbiwgR3gsIEd5LCBoCgkgKiBjb25zdCBjdXJ2ZSA9IHR3aXN0ZWRFZHdhcmRzKHsgYSwgZCwgRnA6IEZpZWxkKHApLCBuLCBHeCwgR3ksIGggfSkKCSAqLwoJZnVuY3Rpb24gdHdpc3RlZEVkd2FyZHMoY3VydmVEZWYpIHsKCSAgICBjb25zdCBDVVJWRSA9IHZhbGlkYXRlT3B0cyQxKGN1cnZlRGVmKTsKCSAgICBjb25zdCB7IEZwLCBuOiBDVVJWRV9PUkRFUiwgcHJlaGFzaDogcHJlaGFzaCwgaGFzaDogY0hhc2gsIHJhbmRvbUJ5dGVzLCBuQnl0ZUxlbmd0aCwgaDogY29mYWN0b3IsIH0gPSBDVVJWRTsKCSAgICAvLyBJbXBvcnRhbnQ6CgkgICAgLy8gVGhlcmUgYXJlIHNvbWUgcGxhY2VzIHdoZXJlIEZwLkJZVEVTIGlzIHVzZWQgaW5zdGVhZCBvZiBuQnl0ZUxlbmd0aC4KCSAgICAvLyBTbyBmYXIsIGV2ZXJ5dGhpbmcgaGFzIGJlZW4gdGVzdGVkIHdpdGggY3VydmVzIG9mIEZwLkJZVEVTID09IG5CeXRlTGVuZ3RoLgoJICAgIC8vIFRPRE86IHRlc3QgYW5kIGZpbmQgY3VydmVzIHdoaWNoIGJlaGF2ZSBvdGhlcndpc2UuCgkgICAgY29uc3QgTUFTSyA9IF8ybiQzIDw8IChCaWdJbnQobkJ5dGVMZW5ndGggKiA4KSAtIF8xbiQ0KTsKCSAgICBjb25zdCBtb2RQID0gRnAuY3JlYXRlOyAvLyBGdW5jdGlvbiBvdmVycmlkZXMKCSAgICBjb25zdCBGbiA9IEZpZWxkKENVUlZFLm4sIENVUlZFLm5CaXRMZW5ndGgpOwoJICAgIC8vIHNxcnQodS92KQoJICAgIGNvbnN0IHV2UmF0aW8gPSBDVVJWRS51dlJhdGlvIHx8CgkgICAgICAgICgodSwgdikgPT4gewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICByZXR1cm4geyBpc1ZhbGlkOiB0cnVlLCB2YWx1ZTogRnAuc3FydCh1ICogRnAuaW52KHYpKSB9OwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgY2F0Y2ggKGUpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4geyBpc1ZhbGlkOiBmYWxzZSwgdmFsdWU6IF8wbiQyIH07CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIGNvbnN0IGFkanVzdFNjYWxhckJ5dGVzID0gQ1VSVkUuYWRqdXN0U2NhbGFyQnl0ZXMgfHwgKChieXRlcykgPT4gYnl0ZXMpOyAvLyBOT09QCgkgICAgY29uc3QgZG9tYWluID0gQ1VSVkUuZG9tYWluIHx8CgkgICAgICAgICgoZGF0YSwgY3R4LCBwaGZsYWcpID0+IHsKCSAgICAgICAgICAgIGFib29sKCdwaGZsYWcnLCBwaGZsYWcpOwoJICAgICAgICAgICAgaWYgKGN0eC5sZW5ndGggfHwgcGhmbGFnKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29udGV4dHMvcHJlLWhhc2ggYXJlIG5vdCBzdXBwb3J0ZWQnKTsKCSAgICAgICAgICAgIHJldHVybiBkYXRhOwoJICAgICAgICB9KTsgLy8gTk9PUAoJICAgIC8vIDAgPD0gbiA8IE1BU0sKCSAgICAvLyBDb29yZGluYXRlcyBsYXJnZXIgdGhhbiBGcC5PUkRFUiBhcmUgYWxsb3dlZCBmb3IgemlwMjE1CgkgICAgZnVuY3Rpb24gYUNvb3JkaW5hdGUodGl0bGUsIG4pIHsKCSAgICAgICAgYUluUmFuZ2UoJ2Nvb3JkaW5hdGUgJyArIHRpdGxlLCBuLCBfMG4kMiwgTUFTSyk7CgkgICAgfQoJICAgIGZ1bmN0aW9uIGFzc2VydFBvaW50KG90aGVyKSB7CgkgICAgICAgIGlmICghKG90aGVyIGluc3RhbmNlb2YgUG9pbnQpKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFeHRlbmRlZFBvaW50IGV4cGVjdGVkJyk7CgkgICAgfQoJICAgIC8vIENvbnZlcnRzIEV4dGVuZGVkIHBvaW50IHRvIGRlZmF1bHQgKHgsIHkpIGNvb3JkaW5hdGVzLgoJICAgIC8vIENhbiBhY2NlcHQgcHJlY29tcHV0ZWQgWl4tMSAtIGZvciBleGFtcGxlLCBmcm9tIGludmVydEJhdGNoLgoJICAgIGNvbnN0IHRvQWZmaW5lTWVtbyA9IG1lbW9pemVkKChwLCBpeikgPT4gewoJICAgICAgICBjb25zdCB7IGV4OiB4LCBleTogeSwgZXo6IHogfSA9IHA7CgkgICAgICAgIGNvbnN0IGlzMCA9IHAuaXMwKCk7CgkgICAgICAgIGlmIChpeiA9PSBudWxsKQoJICAgICAgICAgICAgaXogPSBpczAgPyBfOG4kMSA6IEZwLmludih6KTsgLy8gOCB3YXMgY2hvc2VuIGFyYml0cmFyaWx5CgkgICAgICAgIGNvbnN0IGF4ID0gbW9kUCh4ICogaXopOwoJICAgICAgICBjb25zdCBheSA9IG1vZFAoeSAqIGl6KTsKCSAgICAgICAgY29uc3QgenogPSBtb2RQKHogKiBpeik7CgkgICAgICAgIGlmIChpczApCgkgICAgICAgICAgICByZXR1cm4geyB4OiBfMG4kMiwgeTogXzFuJDQgfTsKCSAgICAgICAgaWYgKHp6ICE9PSBfMW4kNCkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW52WiB3YXMgaW52YWxpZCcpOwoJICAgICAgICByZXR1cm4geyB4OiBheCwgeTogYXkgfTsKCSAgICB9KTsKCSAgICBjb25zdCBhc3NlcnRWYWxpZE1lbW8gPSBtZW1vaXplZCgocCkgPT4gewoJICAgICAgICBjb25zdCB7IGEsIGQgfSA9IENVUlZFOwoJICAgICAgICBpZiAocC5pczAoKSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYmFkIHBvaW50OiBaRVJPJyk7IC8vIFRPRE86IG9wdGltaXplLCB3aXRoIHZhcnMgYmVsb3c/CgkgICAgICAgIC8vIEVxdWF0aW9uIGluIGFmZmluZSBjb29yZGluYXRlczogYXjCsiArIHnCsiA9IDEgKyBkeMKyecKyCgkgICAgICAgIC8vIEVxdWF0aW9uIGluIHByb2plY3RpdmUgY29vcmRpbmF0ZXMgKFgvWiwgWS9aLCBaKTogIChhWMKyICsgWcKyKVrCsiA9IFrigbQgKyBkWMKyWcKyCgkgICAgICAgIGNvbnN0IHsgZXg6IFgsIGV5OiBZLCBlejogWiwgZXQ6IFQgfSA9IHA7CgkgICAgICAgIGNvbnN0IFgyID0gbW9kUChYICogWCk7IC8vIFjCsgoJICAgICAgICBjb25zdCBZMiA9IG1vZFAoWSAqIFkpOyAvLyBZwrIKCSAgICAgICAgY29uc3QgWjIgPSBtb2RQKFogKiBaKTsgLy8gWsKyCgkgICAgICAgIGNvbnN0IFo0ID0gbW9kUChaMiAqIFoyKTsgLy8gWuKBtAoJICAgICAgICBjb25zdCBhWDIgPSBtb2RQKFgyICogYSk7IC8vIGFYwrIKCSAgICAgICAgY29uc3QgbGVmdCA9IG1vZFAoWjIgKiBtb2RQKGFYMiArIFkyKSk7IC8vIChhWMKyICsgWcKyKVrCsgoJICAgICAgICBjb25zdCByaWdodCA9IG1vZFAoWjQgKyBtb2RQKGQgKiBtb2RQKFgyICogWTIpKSk7IC8vIFrigbQgKyBkWMKyWcKyCgkgICAgICAgIGlmIChsZWZ0ICE9PSByaWdodCkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYmFkIHBvaW50OiBlcXVhdGlvbiBsZWZ0ICE9IHJpZ2h0ICgxKScpOwoJICAgICAgICAvLyBJbiBFeHRlbmRlZCBjb29yZGluYXRlcyB3ZSBhbHNvIGhhdmUgVCwgd2hpY2ggaXMgeCp5PVQvWjogY2hlY2sgWCpZID09IFoqVAoJICAgICAgICBjb25zdCBYWSA9IG1vZFAoWCAqIFkpOwoJICAgICAgICBjb25zdCBaVCA9IG1vZFAoWiAqIFQpOwoJICAgICAgICBpZiAoWFkgIT09IFpUKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdiYWQgcG9pbnQ6IGVxdWF0aW9uIGxlZnQgIT0gcmlnaHQgKDIpJyk7CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIH0pOwoJICAgIC8vIEV4dGVuZGVkIFBvaW50IHdvcmtzIGluIGV4dGVuZGVkIGNvb3JkaW5hdGVzOiAoeCwgeSwgeiwgdCkg4oiLICh4PXgveiwgeT15L3osIHQ9eHkpLgoJICAgIC8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1R3aXN0ZWRfRWR3YXJkc19jdXJ2ZSNFeHRlbmRlZF9jb29yZGluYXRlcwoJICAgIGNsYXNzIFBvaW50IHsKCSAgICAgICAgY29uc3RydWN0b3IoZXgsIGV5LCBleiwgZXQpIHsKCSAgICAgICAgICAgIHRoaXMuZXggPSBleDsKCSAgICAgICAgICAgIHRoaXMuZXkgPSBleTsKCSAgICAgICAgICAgIHRoaXMuZXogPSBlejsKCSAgICAgICAgICAgIHRoaXMuZXQgPSBldDsKCSAgICAgICAgICAgIGFDb29yZGluYXRlKCd4JywgZXgpOwoJICAgICAgICAgICAgYUNvb3JkaW5hdGUoJ3knLCBleSk7CgkgICAgICAgICAgICBhQ29vcmRpbmF0ZSgneicsIGV6KTsKCSAgICAgICAgICAgIGFDb29yZGluYXRlKCd0JywgZXQpOwoJICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZSh0aGlzKTsKCSAgICAgICAgfQoJICAgICAgICBnZXQgeCgpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLnRvQWZmaW5lKCkueDsKCSAgICAgICAgfQoJICAgICAgICBnZXQgeSgpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLnRvQWZmaW5lKCkueTsKCSAgICAgICAgfQoJICAgICAgICBzdGF0aWMgZnJvbUFmZmluZShwKSB7CgkgICAgICAgICAgICBpZiAocCBpbnN0YW5jZW9mIFBvaW50KQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZXh0ZW5kZWQgcG9pbnQgbm90IGFsbG93ZWQnKTsKCSAgICAgICAgICAgIGNvbnN0IHsgeCwgeSB9ID0gcCB8fCB7fTsKCSAgICAgICAgICAgIGFDb29yZGluYXRlKCd4JywgeCk7CgkgICAgICAgICAgICBhQ29vcmRpbmF0ZSgneScsIHkpOwoJICAgICAgICAgICAgcmV0dXJuIG5ldyBQb2ludCh4LCB5LCBfMW4kNCwgbW9kUCh4ICogeSkpOwoJICAgICAgICB9CgkgICAgICAgIHN0YXRpYyBub3JtYWxpemVaKHBvaW50cykgewoJICAgICAgICAgICAgY29uc3QgdG9JbnYgPSBGcC5pbnZlcnRCYXRjaChwb2ludHMubWFwKChwKSA9PiBwLmV6KSk7CgkgICAgICAgICAgICByZXR1cm4gcG9pbnRzLm1hcCgocCwgaSkgPT4gcC50b0FmZmluZSh0b0ludltpXSkpLm1hcChQb2ludC5mcm9tQWZmaW5lKTsKCSAgICAgICAgfQoJICAgICAgICAvLyBNdWx0aXNjYWxhciBNdWx0aXBsaWNhdGlvbgoJICAgICAgICBzdGF0aWMgbXNtKHBvaW50cywgc2NhbGFycykgewoJICAgICAgICAgICAgcmV0dXJuIHBpcHBlbmdlcihQb2ludCwgRm4sIHBvaW50cywgc2NhbGFycyk7CgkgICAgICAgIH0KCSAgICAgICAgLy8gIlByaXZhdGUgbWV0aG9kIiwgZG9uJ3QgdXNlIGl0IGRpcmVjdGx5CgkgICAgICAgIF9zZXRXaW5kb3dTaXplKHdpbmRvd1NpemUpIHsKCSAgICAgICAgICAgIHduYWYuc2V0V2luZG93U2l6ZSh0aGlzLCB3aW5kb3dTaXplKTsKCSAgICAgICAgfQoJICAgICAgICAvLyBOb3QgcmVxdWlyZWQgZm9yIGZyb21IZXgoKSwgd2hpY2ggYWx3YXlzIGNyZWF0ZXMgdmFsaWQgcG9pbnRzLgoJICAgICAgICAvLyBDb3VsZCBiZSB1c2VmdWwgZm9yIGZyb21BZmZpbmUoKS4KCSAgICAgICAgYXNzZXJ0VmFsaWRpdHkoKSB7CgkgICAgICAgICAgICBhc3NlcnRWYWxpZE1lbW8odGhpcyk7CgkgICAgICAgIH0KCSAgICAgICAgLy8gQ29tcGFyZSBvbmUgcG9pbnQgdG8gYW5vdGhlci4KCSAgICAgICAgZXF1YWxzKG90aGVyKSB7CgkgICAgICAgICAgICBhc3NlcnRQb2ludChvdGhlcik7CgkgICAgICAgICAgICBjb25zdCB7IGV4OiBYMSwgZXk6IFkxLCBlejogWjEgfSA9IHRoaXM7CgkgICAgICAgICAgICBjb25zdCB7IGV4OiBYMiwgZXk6IFkyLCBlejogWjIgfSA9IG90aGVyOwoJICAgICAgICAgICAgY29uc3QgWDFaMiA9IG1vZFAoWDEgKiBaMik7CgkgICAgICAgICAgICBjb25zdCBYMloxID0gbW9kUChYMiAqIFoxKTsKCSAgICAgICAgICAgIGNvbnN0IFkxWjIgPSBtb2RQKFkxICogWjIpOwoJICAgICAgICAgICAgY29uc3QgWTJaMSA9IG1vZFAoWTIgKiBaMSk7CgkgICAgICAgICAgICByZXR1cm4gWDFaMiA9PT0gWDJaMSAmJiBZMVoyID09PSBZMloxOwoJICAgICAgICB9CgkgICAgICAgIGlzMCgpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmVxdWFscyhQb2ludC5aRVJPKTsKCSAgICAgICAgfQoJICAgICAgICBuZWdhdGUoKSB7CgkgICAgICAgICAgICAvLyBGbGlwcyBwb2ludCBzaWduIHRvIGEgbmVnYXRpdmUgb25lICgteCwgeSBpbiBhZmZpbmUgY29vcmRzKQoJICAgICAgICAgICAgcmV0dXJuIG5ldyBQb2ludChtb2RQKC10aGlzLmV4KSwgdGhpcy5leSwgdGhpcy5leiwgbW9kUCgtdGhpcy5ldCkpOwoJICAgICAgICB9CgkgICAgICAgIC8vIEZhc3QgYWxnbyBmb3IgZG91YmxpbmcgRXh0ZW5kZWQgUG9pbnQuCgkgICAgICAgIC8vIGh0dHBzOi8vaHlwZXJlbGxpcHRpYy5vcmcvRUZEL2cxcC9hdXRvLXR3aXN0ZWQtZXh0ZW5kZWQuaHRtbCNkb3VibGluZy1kYmwtMjAwOC1od2NkCgkgICAgICAgIC8vIENvc3Q6IDRNICsgNFMgKyAxKmEgKyA2YWRkICsgMSoyLgoJICAgICAgICBkb3VibGUoKSB7CgkgICAgICAgICAgICBjb25zdCB7IGEgfSA9IENVUlZFOwoJICAgICAgICAgICAgY29uc3QgeyBleDogWDEsIGV5OiBZMSwgZXo6IFoxIH0gPSB0aGlzOwoJICAgICAgICAgICAgY29uc3QgQSA9IG1vZFAoWDEgKiBYMSk7IC8vIEEgPSBYMTIKCSAgICAgICAgICAgIGNvbnN0IEIgPSBtb2RQKFkxICogWTEpOyAvLyBCID0gWTEyCgkgICAgICAgICAgICBjb25zdCBDID0gbW9kUChfMm4kMyAqIG1vZFAoWjEgKiBaMSkpOyAvLyBDID0gMipaMTIKCSAgICAgICAgICAgIGNvbnN0IEQgPSBtb2RQKGEgKiBBKTsgLy8gRCA9IGEqQQoJICAgICAgICAgICAgY29uc3QgeDF5MSA9IFgxICsgWTE7CgkgICAgICAgICAgICBjb25zdCBFID0gbW9kUChtb2RQKHgxeTEgKiB4MXkxKSAtIEEgLSBCKTsgLy8gRSA9IChYMStZMSkyLUEtQgoJICAgICAgICAgICAgY29uc3QgRyA9IEQgKyBCOyAvLyBHID0gRCtCCgkgICAgICAgICAgICBjb25zdCBGID0gRyAtIEM7IC8vIEYgPSBHLUMKCSAgICAgICAgICAgIGNvbnN0IEggPSBEIC0gQjsgLy8gSCA9IEQtQgoJICAgICAgICAgICAgY29uc3QgWDMgPSBtb2RQKEUgKiBGKTsgLy8gWDMgPSBFKkYKCSAgICAgICAgICAgIGNvbnN0IFkzID0gbW9kUChHICogSCk7IC8vIFkzID0gRypICgkgICAgICAgICAgICBjb25zdCBUMyA9IG1vZFAoRSAqIEgpOyAvLyBUMyA9IEUqSAoJICAgICAgICAgICAgY29uc3QgWjMgPSBtb2RQKEYgKiBHKTsgLy8gWjMgPSBGKkcKCSAgICAgICAgICAgIHJldHVybiBuZXcgUG9pbnQoWDMsIFkzLCBaMywgVDMpOwoJICAgICAgICB9CgkgICAgICAgIC8vIEZhc3QgYWxnbyBmb3IgYWRkaW5nIDIgRXh0ZW5kZWQgUG9pbnRzLgoJICAgICAgICAvLyBodHRwczovL2h5cGVyZWxsaXB0aWMub3JnL0VGRC9nMXAvYXV0by10d2lzdGVkLWV4dGVuZGVkLmh0bWwjYWRkaXRpb24tYWRkLTIwMDgtaHdjZAoJICAgICAgICAvLyBDb3N0OiA5TSArIDEqYSArIDEqZCArIDdhZGQuCgkgICAgICAgIGFkZChvdGhlcikgewoJICAgICAgICAgICAgYXNzZXJ0UG9pbnQob3RoZXIpOwoJICAgICAgICAgICAgY29uc3QgeyBhLCBkIH0gPSBDVVJWRTsKCSAgICAgICAgICAgIGNvbnN0IHsgZXg6IFgxLCBleTogWTEsIGV6OiBaMSwgZXQ6IFQxIH0gPSB0aGlzOwoJICAgICAgICAgICAgY29uc3QgeyBleDogWDIsIGV5OiBZMiwgZXo6IFoyLCBldDogVDIgfSA9IG90aGVyOwoJICAgICAgICAgICAgLy8gRmFzdGVyIGFsZ28gZm9yIGFkZGluZyAyIEV4dGVuZGVkIFBvaW50cyB3aGVuIGN1cnZlJ3MgYT0tMS4KCSAgICAgICAgICAgIC8vIGh0dHA6Ly9oeXBlcmVsbGlwdGljLm9yZy9FRkQvZzFwL2F1dG8tdHdpc3RlZC1leHRlbmRlZC0xLmh0bWwjYWRkaXRpb24tYWRkLTIwMDgtaHdjZC00CgkgICAgICAgICAgICAvLyBDb3N0OiA4TSArIDhhZGQgKyAyKjIuCgkgICAgICAgICAgICAvLyBOb3RlOiBJdCBkb2VzIG5vdCBjaGVjayB3aGV0aGVyIHRoZSBgb3RoZXJgIHBvaW50IGlzIHZhbGlkLgoJICAgICAgICAgICAgaWYgKGEgPT09IEJpZ0ludCgtMSkpIHsKCSAgICAgICAgICAgICAgICBjb25zdCBBID0gbW9kUCgoWTEgLSBYMSkgKiAoWTIgKyBYMikpOwoJICAgICAgICAgICAgICAgIGNvbnN0IEIgPSBtb2RQKChZMSArIFgxKSAqIChZMiAtIFgyKSk7CgkgICAgICAgICAgICAgICAgY29uc3QgRiA9IG1vZFAoQiAtIEEpOwoJICAgICAgICAgICAgICAgIGlmIChGID09PSBfMG4kMikKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG91YmxlKCk7IC8vIFNhbWUgcG9pbnQuIFRlc3RzIHNheSBpdCBkb2Vzbid0IGFmZmVjdCB0aW1pbmcKCSAgICAgICAgICAgICAgICBjb25zdCBDID0gbW9kUChaMSAqIF8ybiQzICogVDIpOwoJICAgICAgICAgICAgICAgIGNvbnN0IEQgPSBtb2RQKFQxICogXzJuJDMgKiBaMik7CgkgICAgICAgICAgICAgICAgY29uc3QgRSA9IEQgKyBDOwoJICAgICAgICAgICAgICAgIGNvbnN0IEcgPSBCICsgQTsKCSAgICAgICAgICAgICAgICBjb25zdCBIID0gRCAtIEM7CgkgICAgICAgICAgICAgICAgY29uc3QgWDMgPSBtb2RQKEUgKiBGKTsKCSAgICAgICAgICAgICAgICBjb25zdCBZMyA9IG1vZFAoRyAqIEgpOwoJICAgICAgICAgICAgICAgIGNvbnN0IFQzID0gbW9kUChFICogSCk7CgkgICAgICAgICAgICAgICAgY29uc3QgWjMgPSBtb2RQKEYgKiBHKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFBvaW50KFgzLCBZMywgWjMsIFQzKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGNvbnN0IEEgPSBtb2RQKFgxICogWDIpOyAvLyBBID0gWDEqWDIKCSAgICAgICAgICAgIGNvbnN0IEIgPSBtb2RQKFkxICogWTIpOyAvLyBCID0gWTEqWTIKCSAgICAgICAgICAgIGNvbnN0IEMgPSBtb2RQKFQxICogZCAqIFQyKTsgLy8gQyA9IFQxKmQqVDIKCSAgICAgICAgICAgIGNvbnN0IEQgPSBtb2RQKFoxICogWjIpOyAvLyBEID0gWjEqWjIKCSAgICAgICAgICAgIGNvbnN0IEUgPSBtb2RQKChYMSArIFkxKSAqIChYMiArIFkyKSAtIEEgLSBCKTsgLy8gRSA9IChYMStZMSkqKFgyK1kyKS1BLUIKCSAgICAgICAgICAgIGNvbnN0IEYgPSBEIC0gQzsgLy8gRiA9IEQtQwoJICAgICAgICAgICAgY29uc3QgRyA9IEQgKyBDOyAvLyBHID0gRCtDCgkgICAgICAgICAgICBjb25zdCBIID0gbW9kUChCIC0gYSAqIEEpOyAvLyBIID0gQi1hKkEKCSAgICAgICAgICAgIGNvbnN0IFgzID0gbW9kUChFICogRik7IC8vIFgzID0gRSpGCgkgICAgICAgICAgICBjb25zdCBZMyA9IG1vZFAoRyAqIEgpOyAvLyBZMyA9IEcqSAoJICAgICAgICAgICAgY29uc3QgVDMgPSBtb2RQKEUgKiBIKTsgLy8gVDMgPSBFKkgKCSAgICAgICAgICAgIGNvbnN0IFozID0gbW9kUChGICogRyk7IC8vIFozID0gRipHCgkgICAgICAgICAgICByZXR1cm4gbmV3IFBvaW50KFgzLCBZMywgWjMsIFQzKTsKCSAgICAgICAgfQoJICAgICAgICBzdWJ0cmFjdChvdGhlcikgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkKG90aGVyLm5lZ2F0ZSgpKTsKCSAgICAgICAgfQoJICAgICAgICB3TkFGKG4pIHsKCSAgICAgICAgICAgIHJldHVybiB3bmFmLndOQUZDYWNoZWQodGhpcywgbiwgUG9pbnQubm9ybWFsaXplWik7CgkgICAgICAgIH0KCSAgICAgICAgLy8gQ29uc3RhbnQtdGltZSBtdWx0aXBsaWNhdGlvbi4KCSAgICAgICAgbXVsdGlwbHkoc2NhbGFyKSB7CgkgICAgICAgICAgICBjb25zdCBuID0gc2NhbGFyOwoJICAgICAgICAgICAgYUluUmFuZ2UoJ3NjYWxhcicsIG4sIF8xbiQ0LCBDVVJWRV9PUkRFUik7IC8vIDEgPD0gc2NhbGFyIDwgTAoJICAgICAgICAgICAgY29uc3QgeyBwLCBmIH0gPSB0aGlzLndOQUYobik7CgkgICAgICAgICAgICByZXR1cm4gUG9pbnQubm9ybWFsaXplWihbcCwgZl0pWzBdOwoJICAgICAgICB9CgkgICAgICAgIC8vIE5vbi1jb25zdGFudC10aW1lIG11bHRpcGxpY2F0aW9uLiBVc2VzIGRvdWJsZS1hbmQtYWRkIGFsZ29yaXRobS4KCSAgICAgICAgLy8gSXQncyBmYXN0ZXIsIGJ1dCBzaG91bGQgb25seSBiZSB1c2VkIHdoZW4geW91IGRvbid0IGNhcmUgYWJvdXQKCSAgICAgICAgLy8gYW4gZXhwb3NlZCBwcml2YXRlIGtleSBlLmcuIHNpZyB2ZXJpZmljYXRpb24uCgkgICAgICAgIC8vIERvZXMgTk9UIGFsbG93IHNjYWxhcnMgaGlnaGVyIHRoYW4gQ1VSVkUubi4KCSAgICAgICAgLy8gQWNjZXB0cyBvcHRpb25hbCBhY2N1bXVsYXRvciB0byBtZXJnZSB3aXRoIG11bHRpcGx5IChpbXBvcnRhbnQgZm9yIHNwYXJzZSBzY2FsYXJzKQoJICAgICAgICBtdWx0aXBseVVuc2FmZShzY2FsYXIsIGFjYyA9IFBvaW50LlpFUk8pIHsKCSAgICAgICAgICAgIGNvbnN0IG4gPSBzY2FsYXI7CgkgICAgICAgICAgICBhSW5SYW5nZSgnc2NhbGFyJywgbiwgXzBuJDIsIENVUlZFX09SREVSKTsgLy8gMCA8PSBzY2FsYXIgPCBMCgkgICAgICAgICAgICBpZiAobiA9PT0gXzBuJDIpCgkgICAgICAgICAgICAgICAgcmV0dXJuIEk7CgkgICAgICAgICAgICBpZiAodGhpcy5pczAoKSB8fCBuID09PSBfMW4kNCkKCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKCSAgICAgICAgICAgIHJldHVybiB3bmFmLndOQUZDYWNoZWRVbnNhZmUodGhpcywgbiwgUG9pbnQubm9ybWFsaXplWiwgYWNjKTsKCSAgICAgICAgfQoJICAgICAgICAvLyBDaGVja3MgaWYgcG9pbnQgaXMgb2Ygc21hbGwgb3JkZXIuCgkgICAgICAgIC8vIElmIHlvdSBhZGQgc29tZXRoaW5nIHRvIHNtYWxsIG9yZGVyIHBvaW50LCB5b3Ugd2lsbCBoYXZlICJkaXJ0eSIKCSAgICAgICAgLy8gcG9pbnQgd2l0aCB0b3JzaW9uIGNvbXBvbmVudC4KCSAgICAgICAgLy8gTXVsdGlwbGllcyBwb2ludCBieSBjb2ZhY3RvciBhbmQgY2hlY2tzIGlmIHRoZSByZXN1bHQgaXMgMC4KCSAgICAgICAgaXNTbWFsbE9yZGVyKCkgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMubXVsdGlwbHlVbnNhZmUoY29mYWN0b3IpLmlzMCgpOwoJICAgICAgICB9CgkgICAgICAgIC8vIE11bHRpcGxpZXMgcG9pbnQgYnkgY3VydmUgb3JkZXIgYW5kIGNoZWNrcyBpZiB0aGUgcmVzdWx0IGlzIDAuCgkgICAgICAgIC8vIFJldHVybnMgYGZhbHNlYCBpcyB0aGUgcG9pbnQgaXMgZGlydHkuCgkgICAgICAgIGlzVG9yc2lvbkZyZWUoKSB7CgkgICAgICAgICAgICByZXR1cm4gd25hZi51bnNhZmVMYWRkZXIodGhpcywgQ1VSVkVfT1JERVIpLmlzMCgpOwoJICAgICAgICB9CgkgICAgICAgIC8vIENvbnZlcnRzIEV4dGVuZGVkIHBvaW50IHRvIGRlZmF1bHQgKHgsIHkpIGNvb3JkaW5hdGVzLgoJICAgICAgICAvLyBDYW4gYWNjZXB0IHByZWNvbXB1dGVkIFpeLTEgLSBmb3IgZXhhbXBsZSwgZnJvbSBpbnZlcnRCYXRjaC4KCSAgICAgICAgdG9BZmZpbmUoaXopIHsKCSAgICAgICAgICAgIHJldHVybiB0b0FmZmluZU1lbW8odGhpcywgaXopOwoJICAgICAgICB9CgkgICAgICAgIGNsZWFyQ29mYWN0b3IoKSB7CgkgICAgICAgICAgICBjb25zdCB7IGg6IGNvZmFjdG9yIH0gPSBDVVJWRTsKCSAgICAgICAgICAgIGlmIChjb2ZhY3RvciA9PT0gXzFuJDQpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5tdWx0aXBseVVuc2FmZShjb2ZhY3Rvcik7CgkgICAgICAgIH0KCSAgICAgICAgLy8gQ29udmVydHMgaGFzaCBzdHJpbmcgb3IgVWludDhBcnJheSB0byBQb2ludC4KCSAgICAgICAgLy8gVXNlcyBhbGdvIGZyb20gUkZDODAzMiA1LjEuMy4KCSAgICAgICAgc3RhdGljIGZyb21IZXgoaGV4LCB6aXAyMTUgPSBmYWxzZSkgewoJICAgICAgICAgICAgY29uc3QgeyBkLCBhIH0gPSBDVVJWRTsKCSAgICAgICAgICAgIGNvbnN0IGxlbiA9IEZwLkJZVEVTOwoJICAgICAgICAgICAgaGV4ID0gZW5zdXJlQnl0ZXMoJ3BvaW50SGV4JywgaGV4LCBsZW4pOyAvLyBjb3B5IGhleCB0byBhIG5ldyBhcnJheQoJICAgICAgICAgICAgYWJvb2woJ3ppcDIxNScsIHppcDIxNSk7CgkgICAgICAgICAgICBjb25zdCBub3JtZWQgPSBoZXguc2xpY2UoKTsgLy8gY29weSBhZ2Fpbiwgd2UnbGwgbWFuaXB1bGF0ZSBpdAoJICAgICAgICAgICAgY29uc3QgbGFzdEJ5dGUgPSBoZXhbbGVuIC0gMV07IC8vIHNlbGVjdCBsYXN0IGJ5dGUKCSAgICAgICAgICAgIG5vcm1lZFtsZW4gLSAxXSA9IGxhc3RCeXRlICYgfjB4ODA7IC8vIGNsZWFyIGxhc3QgYml0CgkgICAgICAgICAgICBjb25zdCB5ID0gYnl0ZXNUb051bWJlckxFKG5vcm1lZCk7CgkgICAgICAgICAgICAvLyB6aXAyMTU9dHJ1ZSBpcyBnb29kIGZvciBjb25zZW5zdXMtY3JpdGljYWwgYXBwcy4gPWZhbHNlIGZvbGxvd3MgUkZDODAzMiAvIE5JU1QxODYtNS4KCSAgICAgICAgICAgIC8vIFJGQzgwMzIgcHJvaGliaXRzID49IHAsIGJ1dCBaSVAyMTUgZG9lc24ndAoJICAgICAgICAgICAgLy8gemlwMjE1PXRydWU6ICAwIDw9IHkgPCBNQVNLICgyXjI1NiBmb3IgZWQyNTUxOSkKCSAgICAgICAgICAgIC8vIHppcDIxNT1mYWxzZTogMCA8PSB5IDwgUCAoMl4yNTUtMTkgZm9yIGVkMjU1MTkpCgkgICAgICAgICAgICBjb25zdCBtYXggPSB6aXAyMTUgPyBNQVNLIDogRnAuT1JERVI7CgkgICAgICAgICAgICBhSW5SYW5nZSgncG9pbnRIZXgueScsIHksIF8wbiQyLCBtYXgpOwoJICAgICAgICAgICAgLy8gRWQyNTUxOTogeMKyID0gKHnCsi0xKS8oZHnCsisxKSBtb2QgcC4gRWQ0NDg6IHjCsiA9ICh5wrItMSkvKGR5wrItMSkgbW9kIHAuIEdlbmVyaWMgY2FzZToKCSAgICAgICAgICAgIC8vIGF4wrIrecKyPTErZHjCsnnCsiA9PiB5wrItMT1keMKyecKyLWF4wrIgPT4gecKyLTE9eMKyKGR5wrItYSkgPT4geMKyPSh5wrItMSkvKGR5wrItYSkKCSAgICAgICAgICAgIGNvbnN0IHkyID0gbW9kUCh5ICogeSk7IC8vIGRlbm9taW5hdG9yIGlzIGFsd2F5cyBub24tMCBtb2QgcC4KCSAgICAgICAgICAgIGNvbnN0IHUgPSBtb2RQKHkyIC0gXzFuJDQpOyAvLyB1ID0gecKyIC0gMQoJICAgICAgICAgICAgY29uc3QgdiA9IG1vZFAoZCAqIHkyIC0gYSk7IC8vIHYgPSBkIHnCsiArIDEuCgkgICAgICAgICAgICBsZXQgeyBpc1ZhbGlkLCB2YWx1ZTogeCB9ID0gdXZSYXRpbyh1LCB2KTsgLy8g4oiaKHUvdikKCSAgICAgICAgICAgIGlmICghaXNWYWxpZCkKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BvaW50LmZyb21IZXg6IGludmFsaWQgeSBjb29yZGluYXRlJyk7CgkgICAgICAgICAgICBjb25zdCBpc1hPZGQgPSAoeCAmIF8xbiQ0KSA9PT0gXzFuJDQ7IC8vIFRoZXJlIGFyZSAyIHNxdWFyZSByb290cy4gVXNlIHhfMCBiaXQgdG8gc2VsZWN0IHByb3BlcgoJICAgICAgICAgICAgY29uc3QgaXNMYXN0Qnl0ZU9kZCA9IChsYXN0Qnl0ZSAmIDB4ODApICE9PSAwOyAvLyB4XzAsIGxhc3QgYml0CgkgICAgICAgICAgICBpZiAoIXppcDIxNSAmJiB4ID09PSBfMG4kMiAmJiBpc0xhc3RCeXRlT2RkKQoJICAgICAgICAgICAgICAgIC8vIGlmIHg9MCBhbmQgeF8wID0gMSwgZmFpbAoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUG9pbnQuZnJvbUhleDogeD0wIGFuZCB4XzA9MScpOwoJICAgICAgICAgICAgaWYgKGlzTGFzdEJ5dGVPZGQgIT09IGlzWE9kZCkKCSAgICAgICAgICAgICAgICB4ID0gbW9kUCgteCk7IC8vIGlmIHhfMCAhPSB4IG1vZCAyLCBzZXQgeCA9IHAteAoJICAgICAgICAgICAgcmV0dXJuIFBvaW50LmZyb21BZmZpbmUoeyB4LCB5IH0pOwoJICAgICAgICB9CgkgICAgICAgIHN0YXRpYyBmcm9tUHJpdmF0ZUtleShwcml2S2V5KSB7CgkgICAgICAgICAgICByZXR1cm4gZ2V0RXh0ZW5kZWRQdWJsaWNLZXkocHJpdktleSkucG9pbnQ7CgkgICAgICAgIH0KCSAgICAgICAgdG9SYXdCeXRlcygpIHsKCSAgICAgICAgICAgIGNvbnN0IHsgeCwgeSB9ID0gdGhpcy50b0FmZmluZSgpOwoJICAgICAgICAgICAgY29uc3QgYnl0ZXMgPSBudW1iZXJUb0J5dGVzTEUoeSwgRnAuQllURVMpOyAvLyBlYWNoIHkgaGFzIDIgeCB2YWx1ZXMgKHgsIC15KQoJICAgICAgICAgICAgYnl0ZXNbYnl0ZXMubGVuZ3RoIC0gMV0gfD0geCAmIF8xbiQ0ID8gMHg4MCA6IDA7IC8vIHdoZW4gY29tcHJlc3NpbmcsIGl0J3MgZW5vdWdoIHRvIHN0b3JlIHkKCSAgICAgICAgICAgIHJldHVybiBieXRlczsgLy8gYW5kIHVzZSB0aGUgbGFzdCBieXRlIHRvIGVuY29kZSBzaWduIG9mIHgKCSAgICAgICAgfQoJICAgICAgICB0b0hleCgpIHsKCSAgICAgICAgICAgIHJldHVybiBieXRlc1RvSGV4KHRoaXMudG9SYXdCeXRlcygpKTsgLy8gU2FtZSBhcyB0b1Jhd0J5dGVzLCBidXQgcmV0dXJucyBzdHJpbmcuCgkgICAgICAgIH0KCSAgICB9CgkgICAgUG9pbnQuQkFTRSA9IG5ldyBQb2ludChDVVJWRS5HeCwgQ1VSVkUuR3ksIF8xbiQ0LCBtb2RQKENVUlZFLkd4ICogQ1VSVkUuR3kpKTsKCSAgICBQb2ludC5aRVJPID0gbmV3IFBvaW50KF8wbiQyLCBfMW4kNCwgXzFuJDQsIF8wbiQyKTsgLy8gMCwgMSwgMSwgMAoJICAgIGNvbnN0IHsgQkFTRTogRywgWkVSTzogSSB9ID0gUG9pbnQ7CgkgICAgY29uc3Qgd25hZiA9IHdOQUYoUG9pbnQsIG5CeXRlTGVuZ3RoICogOCk7CgkgICAgZnVuY3Rpb24gbW9kTihhKSB7CgkgICAgICAgIHJldHVybiBtb2QoYSwgQ1VSVkVfT1JERVIpOwoJICAgIH0KCSAgICAvLyBMaXR0bGUtZW5kaWFuIFNIQTUxMiB3aXRoIG1vZHVsbyBuCgkgICAgZnVuY3Rpb24gbW9kTl9MRShoYXNoKSB7CgkgICAgICAgIHJldHVybiBtb2ROKGJ5dGVzVG9OdW1iZXJMRShoYXNoKSk7CgkgICAgfQoJICAgIC8qKiBDb252ZW5pZW5jZSBtZXRob2QgdGhhdCBjcmVhdGVzIHB1YmxpYyBrZXkgYW5kIG90aGVyIHN0dWZmLiBSRkM4MDMyIDUuMS41ICovCgkgICAgZnVuY3Rpb24gZ2V0RXh0ZW5kZWRQdWJsaWNLZXkoa2V5KSB7CgkgICAgICAgIGNvbnN0IGxlbiA9IEZwLkJZVEVTOwoJICAgICAgICBrZXkgPSBlbnN1cmVCeXRlcygncHJpdmF0ZSBrZXknLCBrZXksIGxlbik7CgkgICAgICAgIC8vIEhhc2ggcHJpdmF0ZSBrZXkgd2l0aCBjdXJ2ZSdzIGhhc2ggZnVuY3Rpb24gdG8gcHJvZHVjZSB1bmlmb3JtaW5nbHkgcmFuZG9tIGlucHV0CgkgICAgICAgIC8vIENoZWNrIGJ5dGUgbGVuZ3RoczogZW5zdXJlKDY0LCBoKGVuc3VyZSgzMiwga2V5KSkpCgkgICAgICAgIGNvbnN0IGhhc2hlZCA9IGVuc3VyZUJ5dGVzKCdoYXNoZWQgcHJpdmF0ZSBrZXknLCBjSGFzaChrZXkpLCAyICogbGVuKTsKCSAgICAgICAgY29uc3QgaGVhZCA9IGFkanVzdFNjYWxhckJ5dGVzKGhhc2hlZC5zbGljZSgwLCBsZW4pKTsgLy8gY2xlYXIgZmlyc3QgaGFsZiBiaXRzLCBwcm9kdWNlIEZFCgkgICAgICAgIGNvbnN0IHByZWZpeCA9IGhhc2hlZC5zbGljZShsZW4sIDIgKiBsZW4pOyAvLyBzZWNvbmQgaGFsZiBpcyBjYWxsZWQga2V5IHByZWZpeCAoNS4xLjYpCgkgICAgICAgIGNvbnN0IHNjYWxhciA9IG1vZE5fTEUoaGVhZCk7IC8vIFRoZSBhY3R1YWwgcHJpdmF0ZSBzY2FsYXIKCSAgICAgICAgY29uc3QgcG9pbnQgPSBHLm11bHRpcGx5KHNjYWxhcik7IC8vIFBvaW50IG9uIEVkd2FyZHMgY3VydmUgYWthIHB1YmxpYyBrZXkKCSAgICAgICAgY29uc3QgcG9pbnRCeXRlcyA9IHBvaW50LnRvUmF3Qnl0ZXMoKTsgLy8gVWludDhBcnJheSByZXByZXNlbnRhdGlvbgoJICAgICAgICByZXR1cm4geyBoZWFkLCBwcmVmaXgsIHNjYWxhciwgcG9pbnQsIHBvaW50Qnl0ZXMgfTsKCSAgICB9CgkgICAgLy8gQ2FsY3VsYXRlcyBFZERTQSBwdWIga2V5LiBSRkM4MDMyIDUuMS41LiBQcml2a2V5IGlzIGhhc2hlZC4gVXNlIGZpcnN0IGhhbGYgd2l0aCAzIGJpdHMgY2xlYXJlZAoJICAgIGZ1bmN0aW9uIGdldFB1YmxpY0tleShwcml2S2V5KSB7CgkgICAgICAgIHJldHVybiBnZXRFeHRlbmRlZFB1YmxpY0tleShwcml2S2V5KS5wb2ludEJ5dGVzOwoJICAgIH0KCSAgICAvLyBpbnQoJ0xFJywgU0hBNTEyKGRvbTIoRiwgQykgfHwgbXNncykpIG1vZCBOCgkgICAgZnVuY3Rpb24gaGFzaERvbWFpblRvU2NhbGFyKGNvbnRleHQgPSBuZXcgVWludDhBcnJheSgpLCAuLi5tc2dzKSB7CgkgICAgICAgIGNvbnN0IG1zZyA9IGNvbmNhdEJ5dGVzKC4uLm1zZ3MpOwoJICAgICAgICByZXR1cm4gbW9kTl9MRShjSGFzaChkb21haW4obXNnLCBlbnN1cmVCeXRlcygnY29udGV4dCcsIGNvbnRleHQpLCAhIXByZWhhc2gpKSk7CgkgICAgfQoJICAgIC8qKiBTaWducyBtZXNzYWdlIHdpdGggcHJpdmF0ZUtleS4gUkZDODAzMiA1LjEuNiAqLwoJICAgIGZ1bmN0aW9uIHNpZ24obXNnLCBwcml2S2V5LCBvcHRpb25zID0ge30pIHsKCSAgICAgICAgbXNnID0gZW5zdXJlQnl0ZXMoJ21lc3NhZ2UnLCBtc2cpOwoJICAgICAgICBpZiAocHJlaGFzaCkKCSAgICAgICAgICAgIG1zZyA9IHByZWhhc2gobXNnKTsgLy8gZm9yIGVkMjU1MTlwaCBldGMuCgkgICAgICAgIGNvbnN0IHsgcHJlZml4LCBzY2FsYXIsIHBvaW50Qnl0ZXMgfSA9IGdldEV4dGVuZGVkUHVibGljS2V5KHByaXZLZXkpOwoJICAgICAgICBjb25zdCByID0gaGFzaERvbWFpblRvU2NhbGFyKG9wdGlvbnMuY29udGV4dCwgcHJlZml4LCBtc2cpOyAvLyByID0gZG9tMihGLCBDKSB8fCBwcmVmaXggfHwgUEgoTSkKCSAgICAgICAgY29uc3QgUiA9IEcubXVsdGlwbHkocikudG9SYXdCeXRlcygpOyAvLyBSID0gckcKCSAgICAgICAgY29uc3QgayA9IGhhc2hEb21haW5Ub1NjYWxhcihvcHRpb25zLmNvbnRleHQsIFIsIHBvaW50Qnl0ZXMsIG1zZyk7IC8vIFIgfHwgQSB8fCBQSChNKQoJICAgICAgICBjb25zdCBzID0gbW9kTihyICsgayAqIHNjYWxhcik7IC8vIFMgPSAociArIGsgKiBzKSBtb2QgTAoJICAgICAgICBhSW5SYW5nZSgnc2lnbmF0dXJlLnMnLCBzLCBfMG4kMiwgQ1VSVkVfT1JERVIpOyAvLyAwIDw9IHMgPCBsCgkgICAgICAgIGNvbnN0IHJlcyA9IGNvbmNhdEJ5dGVzKFIsIG51bWJlclRvQnl0ZXNMRShzLCBGcC5CWVRFUykpOwoJICAgICAgICByZXR1cm4gZW5zdXJlQnl0ZXMoJ3Jlc3VsdCcsIHJlcywgRnAuQllURVMgKiAyKTsgLy8gNjQtYnl0ZSBzaWduYXR1cmUKCSAgICB9CgkgICAgY29uc3QgdmVyaWZ5T3B0cyA9IFZFUklGWV9ERUZBVUxUOwoJICAgIC8qKgoJICAgICAqIFZlcmlmaWVzIEVkRFNBIHNpZ25hdHVyZSBhZ2FpbnN0IG1lc3NhZ2UgYW5kIHB1YmxpYyBrZXkuIFJGQzgwMzIgNS4xLjcuCgkgICAgICogQW4gZXh0ZW5kZWQgZ3JvdXAgZXF1YXRpb24gaXMgY2hlY2tlZC4KCSAgICAgKi8KCSAgICBmdW5jdGlvbiB2ZXJpZnkoc2lnLCBtc2csIHB1YmxpY0tleSwgb3B0aW9ucyA9IHZlcmlmeU9wdHMpIHsKCSAgICAgICAgY29uc3QgeyBjb250ZXh0LCB6aXAyMTUgfSA9IG9wdGlvbnM7CgkgICAgICAgIGNvbnN0IGxlbiA9IEZwLkJZVEVTOyAvLyBWZXJpZmllcyBFZERTQSBzaWduYXR1cmUgYWdhaW5zdCBtZXNzYWdlIGFuZCBwdWJsaWMga2V5LiBSRkM4MDMyIDUuMS43LgoJICAgICAgICBzaWcgPSBlbnN1cmVCeXRlcygnc2lnbmF0dXJlJywgc2lnLCAyICogbGVuKTsgLy8gQW4gZXh0ZW5kZWQgZ3JvdXAgZXF1YXRpb24gaXMgY2hlY2tlZC4KCSAgICAgICAgbXNnID0gZW5zdXJlQnl0ZXMoJ21lc3NhZ2UnLCBtc2cpOwoJICAgICAgICBwdWJsaWNLZXkgPSBlbnN1cmVCeXRlcygncHVibGljS2V5JywgcHVibGljS2V5LCBsZW4pOwoJICAgICAgICBpZiAoemlwMjE1ICE9PSB1bmRlZmluZWQpCgkgICAgICAgICAgICBhYm9vbCgnemlwMjE1JywgemlwMjE1KTsKCSAgICAgICAgaWYgKHByZWhhc2gpCgkgICAgICAgICAgICBtc2cgPSBwcmVoYXNoKG1zZyk7IC8vIGZvciBlZDI1NTE5cGgsIGV0YwoJICAgICAgICBjb25zdCBzID0gYnl0ZXNUb051bWJlckxFKHNpZy5zbGljZShsZW4sIDIgKiBsZW4pKTsKCSAgICAgICAgbGV0IEEsIFIsIFNCOwoJICAgICAgICB0cnkgewoJICAgICAgICAgICAgLy8gemlwMjE1PXRydWUgaXMgZ29vZCBmb3IgY29uc2Vuc3VzLWNyaXRpY2FsIGFwcHMuID1mYWxzZSBmb2xsb3dzIFJGQzgwMzIgLyBOSVNUMTg2LTUuCgkgICAgICAgICAgICAvLyB6aXAyMTU9dHJ1ZTogIDAgPD0geSA8IE1BU0sgKDJeMjU2IGZvciBlZDI1NTE5KQoJICAgICAgICAgICAgLy8gemlwMjE1PWZhbHNlOiAwIDw9IHkgPCBQICgyXjI1NS0xOSBmb3IgZWQyNTUxOSkKCSAgICAgICAgICAgIEEgPSBQb2ludC5mcm9tSGV4KHB1YmxpY0tleSwgemlwMjE1KTsKCSAgICAgICAgICAgIFIgPSBQb2ludC5mcm9tSGV4KHNpZy5zbGljZSgwLCBsZW4pLCB6aXAyMTUpOwoJICAgICAgICAgICAgU0IgPSBHLm11bHRpcGx5VW5zYWZlKHMpOyAvLyAwIDw9IHMgPCBsIGlzIGRvbmUgaW5zaWRlCgkgICAgICAgIH0KCSAgICAgICAgY2F0Y2ggKGVycm9yKSB7CgkgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKCF6aXAyMTUgJiYgQS5pc1NtYWxsT3JkZXIoKSkKCSAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgY29uc3QgayA9IGhhc2hEb21haW5Ub1NjYWxhcihjb250ZXh0LCBSLnRvUmF3Qnl0ZXMoKSwgQS50b1Jhd0J5dGVzKCksIG1zZyk7CgkgICAgICAgIGNvbnN0IFJrQSA9IFIuYWRkKEEubXVsdGlwbHlVbnNhZmUoaykpOwoJICAgICAgICAvLyBFeHRlbmRlZCBncm91cCBlcXVhdGlvbgoJICAgICAgICAvLyBbOF1bU11CID0gWzhdUiArIFs4XVtrXUEnCgkgICAgICAgIHJldHVybiBSa0Euc3VidHJhY3QoU0IpLmNsZWFyQ29mYWN0b3IoKS5lcXVhbHMoUG9pbnQuWkVSTyk7CgkgICAgfQoJICAgIEcuX3NldFdpbmRvd1NpemUoOCk7IC8vIEVuYWJsZSBwcmVjb21wdXRlcy4gU2xvd3MgZG93biBmaXJzdCBwdWJsaWNLZXkgY29tcHV0YXRpb24gYnkgMjBtcy4KCSAgICBjb25zdCB1dGlscyA9IHsKCSAgICAgICAgZ2V0RXh0ZW5kZWRQdWJsaWNLZXksCgkgICAgICAgIC8vIGVkMjU1MTkgcHJpdmF0ZSBrZXlzIGFyZSB1bmlmb3JtIDMyYi4gTm8gbmVlZCB0byBjaGVjayBmb3IgbW9kdWxvIGJpYXMsIGxpa2UgaW4gc2VjcDI1NmsxLgoJICAgICAgICByYW5kb21Qcml2YXRlS2V5OiAoKSA9PiByYW5kb21CeXRlcyhGcC5CWVRFUyksCgkgICAgICAgIC8qKgoJICAgICAgICAgKiBXZSdyZSBkb2luZyBzY2FsYXIgbXVsdGlwbGljYXRpb24gKHVzZWQgaW4gZ2V0UHVibGljS2V5IGV0Yykgd2l0aCBwcmVjb21wdXRlZCBCQVNFX1BPSU5UCgkgICAgICAgICAqIHZhbHVlcy4gVGhpcyBzbG93cyBkb3duIGZpcnN0IGdldFB1YmxpY0tleSgpIGJ5IG1pbGxpc2Vjb25kcyAoc2VlIFNwZWVkIHNlY3Rpb24pLAoJICAgICAgICAgKiBidXQgYWxsb3dzIHRvIHNwZWVkLXVwIHN1YnNlcXVlbnQgZ2V0UHVibGljS2V5KCkgY2FsbHMgdXAgdG8gMjB4LgoJICAgICAgICAgKiBAcGFyYW0gd2luZG93U2l6ZSAyLCA0LCA4LCAxNgoJICAgICAgICAgKi8KCSAgICAgICAgcHJlY29tcHV0ZSh3aW5kb3dTaXplID0gOCwgcG9pbnQgPSBQb2ludC5CQVNFKSB7CgkgICAgICAgICAgICBwb2ludC5fc2V0V2luZG93U2l6ZSh3aW5kb3dTaXplKTsKCSAgICAgICAgICAgIHBvaW50Lm11bHRpcGx5KEJpZ0ludCgzKSk7CgkgICAgICAgICAgICByZXR1cm4gcG9pbnQ7CgkgICAgICAgIH0sCgkgICAgfTsKCSAgICByZXR1cm4gewoJICAgICAgICBDVVJWRSwKCSAgICAgICAgZ2V0UHVibGljS2V5LAoJICAgICAgICBzaWduLAoJICAgICAgICB2ZXJpZnksCgkgICAgICAgIEV4dGVuZGVkUG9pbnQ6IFBvaW50LAoJICAgICAgICB1dGlscywKCSAgICB9OwoJfQoKCS8qISBub2JsZS1jdXJ2ZXMgLSBNSVQgTGljZW5zZSAoYykgMjAyMiBQYXVsIE1pbGxlciAocGF1bG1pbGxyLmNvbSkgKi8KCS8qKgoJICogZWQyNTUxOSBUd2lzdGVkIEVkd2FyZHMgY3VydmUgd2l0aCBmb2xsb3dpbmcgYWRkb25zOgoJICogLSBYMjU1MTkgRUNESAoJICogLSBSaXN0cmV0dG8gY29mYWN0b3IgZWxpbWluYXRpb24KCSAqIC0gRWxsaWdhdG9yIGhhc2gtdG8tZ3JvdXAgLyBwb2ludCBpbmRpc3Rpbmd1aXNoYWJpbGl0eQoJICovCgljb25zdCBFRDI1NTE5X1AgPSBCaWdJbnQoJzU3ODk2MDQ0NjE4NjU4MDk3NzExNzg1NDkyNTA0MzQzOTUzOTI2NjM0OTkyMzMyODIwMjgyMDE5NzI4NzkyMDAzOTU2NTY0ODE5OTQ5Jyk7CgkvLyDiiJooLTEpIGFrYSDiiJooYSkgYWthIDJeKChwLTEpLzQpCgljb25zdCBFRDI1NTE5X1NRUlRfTTEgPSAvKiBAX19QVVJFX18gKi8gQmlnSW50KCcxOTY4MTE2MTM3NjcwNzUwNTk1NjgwNzA3OTMwNDk4ODU0MjAxNTQ0NjA2NjUxNTkyMzg5MDE2Mjc0NDAyMTA3MzEyMzgyOTc4NDc1MicpOwoJLy8gcHJldHRpZXItaWdub3JlCglCaWdJbnQoMCk7IGNvbnN0IF8xbiQzID0gQmlnSW50KDEpLCBfMm4kMiA9IEJpZ0ludCgyKTsgQmlnSW50KDMpOwoJLy8gcHJldHRpZXItaWdub3JlCgljb25zdCBfNW4gPSBCaWdJbnQoNSksIF84biA9IEJpZ0ludCg4KTsKCWZ1bmN0aW9uIGVkMjU1MTlfcG93XzJfMjUyXzMoeCkgewoJICAgIC8vIHByZXR0aWVyLWlnbm9yZQoJICAgIGNvbnN0IF8xMG4gPSBCaWdJbnQoMTApLCBfMjBuID0gQmlnSW50KDIwKSwgXzQwbiA9IEJpZ0ludCg0MCksIF84MG4gPSBCaWdJbnQoODApOwoJICAgIGNvbnN0IFAgPSBFRDI1NTE5X1A7CgkgICAgY29uc3QgeDIgPSAoeCAqIHgpICUgUDsKCSAgICBjb25zdCBiMiA9ICh4MiAqIHgpICUgUDsgLy8geF4zLCAxMQoJICAgIGNvbnN0IGI0ID0gKHBvdzIoYjIsIF8ybiQyLCBQKSAqIGIyKSAlIFA7IC8vIHheMTUsIDExMTEKCSAgICBjb25zdCBiNSA9IChwb3cyKGI0LCBfMW4kMywgUCkgKiB4KSAlIFA7IC8vIHheMzEKCSAgICBjb25zdCBiMTAgPSAocG93MihiNSwgXzVuLCBQKSAqIGI1KSAlIFA7CgkgICAgY29uc3QgYjIwID0gKHBvdzIoYjEwLCBfMTBuLCBQKSAqIGIxMCkgJSBQOwoJICAgIGNvbnN0IGI0MCA9IChwb3cyKGIyMCwgXzIwbiwgUCkgKiBiMjApICUgUDsKCSAgICBjb25zdCBiODAgPSAocG93MihiNDAsIF80MG4sIFApICogYjQwKSAlIFA7CgkgICAgY29uc3QgYjE2MCA9IChwb3cyKGI4MCwgXzgwbiwgUCkgKiBiODApICUgUDsKCSAgICBjb25zdCBiMjQwID0gKHBvdzIoYjE2MCwgXzgwbiwgUCkgKiBiODApICUgUDsKCSAgICBjb25zdCBiMjUwID0gKHBvdzIoYjI0MCwgXzEwbiwgUCkgKiBiMTApICUgUDsKCSAgICBjb25zdCBwb3dfcF81XzggPSAocG93MihiMjUwLCBfMm4kMiwgUCkgKiB4KSAlIFA7CgkgICAgLy8gXiBUbyBwb3cgdG8gKHArMykvOCwgbXVsdGlwbHkgaXQgYnkgeC4KCSAgICByZXR1cm4geyBwb3dfcF81XzgsIGIyIH07Cgl9CglmdW5jdGlvbiBhZGp1c3RTY2FsYXJCeXRlcyhieXRlcykgewoJICAgIC8vIFNlY3Rpb24gNTogRm9yIFgyNTUxOSwgaW4gb3JkZXIgdG8gZGVjb2RlIDMyIHJhbmRvbSBieXRlcyBhcyBhbiBpbnRlZ2VyIHNjYWxhciwKCSAgICAvLyBzZXQgdGhlIHRocmVlIGxlYXN0IHNpZ25pZmljYW50IGJpdHMgb2YgdGhlIGZpcnN0IGJ5dGUKCSAgICBieXRlc1swXSAmPSAyNDg7IC8vIDBiMTExMV8xMDAwCgkgICAgLy8gYW5kIHRoZSBtb3N0IHNpZ25pZmljYW50IGJpdCBvZiB0aGUgbGFzdCB0byB6ZXJvLAoJICAgIGJ5dGVzWzMxXSAmPSAxMjc7IC8vIDBiMDExMV8xMTExCgkgICAgLy8gc2V0IHRoZSBzZWNvbmQgbW9zdCBzaWduaWZpY2FudCBiaXQgb2YgdGhlIGxhc3QgYnl0ZSB0byAxCgkgICAgYnl0ZXNbMzFdIHw9IDY0OyAvLyAwYjAxMDBfMDAwMAoJICAgIHJldHVybiBieXRlczsKCX0KCS8vIHNxcnQodS92KQoJZnVuY3Rpb24gdXZSYXRpbyh1LCB2KSB7CgkgICAgY29uc3QgUCA9IEVEMjU1MTlfUDsKCSAgICBjb25zdCB2MyA9IG1vZCh2ICogdiAqIHYsIFApOyAvLyB2wrMKCSAgICBjb25zdCB2NyA9IG1vZCh2MyAqIHYzICogdiwgUCk7IC8vIHbigbcKCSAgICAvLyAocCszKS84IGFuZCAocC01KS84CgkgICAgY29uc3QgcG93ID0gZWQyNTUxOV9wb3dfMl8yNTJfMyh1ICogdjcpLnBvd19wXzVfODsKCSAgICBsZXQgeCA9IG1vZCh1ICogdjMgKiBwb3csIFApOyAvLyAodXbCsykodXbigbcpXihwLTUpLzgKCSAgICBjb25zdCB2eDIgPSBtb2QodiAqIHggKiB4LCBQKTsgLy8gdnjCsgoJICAgIGNvbnN0IHJvb3QxID0geDsgLy8gRmlyc3Qgcm9vdCBjYW5kaWRhdGUKCSAgICBjb25zdCByb290MiA9IG1vZCh4ICogRUQyNTUxOV9TUVJUX00xLCBQKTsgLy8gU2Vjb25kIHJvb3QgY2FuZGlkYXRlCgkgICAgY29uc3QgdXNlUm9vdDEgPSB2eDIgPT09IHU7IC8vIElmIHZ4wrIgPSB1IChtb2QgcCksIHggaXMgYSBzcXVhcmUgcm9vdAoJICAgIGNvbnN0IHVzZVJvb3QyID0gdngyID09PSBtb2QoLXUsIFApOyAvLyBJZiB2eMKyID0gLXUsIHNldCB4IDwtLSB4ICogMl4oKHAtMSkvNCkKCSAgICBjb25zdCBub1Jvb3QgPSB2eDIgPT09IG1vZCgtdSAqIEVEMjU1MTlfU1FSVF9NMSwgUCk7IC8vIFRoZXJlIGlzIG5vIHZhbGlkIHJvb3QsIHZ4wrIgPSAtdeKImigtMSkKCSAgICBpZiAodXNlUm9vdDEpCgkgICAgICAgIHggPSByb290MTsKCSAgICBpZiAodXNlUm9vdDIgfHwgbm9Sb290KQoJICAgICAgICB4ID0gcm9vdDI7IC8vIFdlIHJldHVybiByb290MiBhbnl3YXksIGZvciBjb25zdC10aW1lCgkgICAgaWYgKGlzTmVnYXRpdmVMRSh4LCBQKSkKCSAgICAgICAgeCA9IG1vZCgteCwgUCk7CgkgICAgcmV0dXJuIHsgaXNWYWxpZDogdXNlUm9vdDEgfHwgdXNlUm9vdDIsIHZhbHVlOiB4IH07Cgl9Cgljb25zdCBGcCA9IC8qIEBfX1BVUkVfXyAqLyAoKCkgPT4gRmllbGQoRUQyNTUxOV9QLCB1bmRlZmluZWQsIHRydWUpKSgpOwoJY29uc3QgZWQyNTUxOURlZmF1bHRzID0gLyogQF9fUFVSRV9fICovICgoKSA9PiAoewoJICAgIC8vIFBhcmFtOiBhCgkgICAgYTogQmlnSW50KC0xKSwgLy8gRnAuY3JlYXRlKC0xKSBpcyBwcm9wZXI7IG91ciB3YXkgc3RpbGwgd29ya3MgYW5kIGlzIGZhc3RlcgoJICAgIC8vIGQgaXMgZXF1YWwgdG8gLTEyMTY2NS8xMjE2NjYgb3ZlciBmaW5pdGUgZmllbGQuCgkgICAgLy8gTmVnYXRpdmUgbnVtYmVyIGlzIFAgLSBudW1iZXIsIGFuZCBkaXZpc2lvbiBpcyBpbnZlcnQobnVtYmVyLCBQKQoJICAgIGQ6IEJpZ0ludCgnMzcwOTU3MDU5MzQ2Njk0MzkzNDMxMzgwODM1MDg3NTQ1NjUxODk1NDIxMTM4Nzk4NDMyMTkwMTYzODg3ODU1MzMwODU5NDAyODM1NTUnKSwKCSAgICAvLyBGaW5pdGUgZmllbGQg8J2UvXAgb3ZlciB3aGljaCB3ZSdsbCBkbyBjYWxjdWxhdGlvbnM7IDJuKioyNTVuIC0gMTluCgkgICAgRnAsCgkgICAgLy8gU3ViZ3JvdXAgb3JkZXI6IGhvdyBtYW55IHBvaW50cyBjdXJ2ZSBoYXMKCSAgICAvLyAybioqMjUybiArIDI3NzQyMzE3Nzc3MzcyMzUzNTM1ODUxOTM3NzkwODgzNjQ4NDkzbjsKCSAgICBuOiBCaWdJbnQoJzcyMzcwMDU1NzczMzIyNjIyMTM5NzMxODY1NjMwNDI5OTQyNDA4NTcxMTYzNTkzNzk5MDc2MDYwMDE5NTA5MzgyODU0NTQyNTA5ODknKSwKCSAgICAvLyBDb2ZhY3RvcgoJICAgIGg6IF84biwKCSAgICAvLyBCYXNlIHBvaW50ICh4LCB5KSBha2EgZ2VuZXJhdG9yIHBvaW50CgkgICAgR3g6IEJpZ0ludCgnMTUxMTIyMjEzNDk1MzU0MDA3NzI1MDExNTE0MDk1ODg1MzE1MTE0NTQwMTI2OTMwNDE4NTcyMDYwNDYxMTMyODM5NDk4NDc3NjIyMDInKSwKCSAgICBHeTogQmlnSW50KCc0NjMxNjgzNTY5NDkyNjQ3ODE2OTQyODM5NDAwMzQ3NTE2MzE0MTMwNzk5Mzg2NjI1NjIyNTYxNTc4MzAzMzYwMzE2NTI1MTg1NTk2MCcpLAoJICAgIGhhc2g6IHNoYTUxMiwKCSAgICByYW5kb21CeXRlcywKCSAgICBhZGp1c3RTY2FsYXJCeXRlcywKCSAgICAvLyBkb20yCgkgICAgLy8gUmF0aW8gb2YgdSB0byB2LiBBbGxvd3MgdXMgdG8gY29tYmluZSBpbnZlcnNpb24gYW5kIHNxdWFyZSByb290LiBVc2VzIGFsZ28gZnJvbSBSRkM4MDMyIDUuMS4zLgoJICAgIC8vIENvbnN0YW50LXRpbWUsIHUv4oiadgoJICAgIHV2UmF0aW8sCgl9KSkoKTsKCS8qKgoJICogZWQyNTUxOSBjdXJ2ZSB3aXRoIEVkRFNBIHNpZ25hdHVyZXMuCgkgKi8KCWNvbnN0IGVkMjU1MTkgPSAvKiBAX19QVVJFX18gKi8gKCgpID0+IHR3aXN0ZWRFZHdhcmRzKGVkMjU1MTlEZWZhdWx0cykpKCk7CgoJLyoqCgkgKiBBIDY0IGJ5dGUgc2VjcmV0IGtleSwgdGhlIGZpcnN0IDMyIGJ5dGVzIG9mIHdoaWNoIGlzIHRoZQoJICogcHJpdmF0ZSBzY2FsYXIgYW5kIHRoZSBsYXN0IDMyIGJ5dGVzIGlzIHRoZSBwdWJsaWMga2V5LgoJICogUmVhZCBtb3JlOiBodHRwczovL2Jsb2cubW96aWxsYS5vcmcvd2FybmVyLzIwMTEvMTEvMjkvZWQyNTUxOS1rZXlzLwoJICovCgoJLyoqCgkgKiBFZDI1NTE5IEtleXBhaXIKCSAqLwoKCWNvbnN0IGdlbmVyYXRlUHJpdmF0ZUtleSA9IGVkMjU1MTkudXRpbHMucmFuZG9tUHJpdmF0ZUtleTsKCWNvbnN0IGdlbmVyYXRlS2V5cGFpciA9ICgpID0+IHsKCSAgY29uc3QgcHJpdmF0ZVNjYWxhciA9IGVkMjU1MTkudXRpbHMucmFuZG9tUHJpdmF0ZUtleSgpOwoJICBjb25zdCBwdWJsaWNLZXkgPSBnZXRQdWJsaWNLZXkocHJpdmF0ZVNjYWxhcik7CgkgIGNvbnN0IHNlY3JldEtleSA9IG5ldyBVaW50OEFycmF5KDY0KTsKCSAgc2VjcmV0S2V5LnNldChwcml2YXRlU2NhbGFyKTsKCSAgc2VjcmV0S2V5LnNldChwdWJsaWNLZXksIDMyKTsKCSAgcmV0dXJuIHsKCSAgICBwdWJsaWNLZXksCgkgICAgc2VjcmV0S2V5CgkgIH07Cgl9OwoJY29uc3QgZ2V0UHVibGljS2V5ID0gZWQyNTUxOS5nZXRQdWJsaWNLZXk7CglmdW5jdGlvbiBpc09uQ3VydmUocHVibGljS2V5KSB7CgkgIHRyeSB7CgkgICAgZWQyNTUxOS5FeHRlbmRlZFBvaW50LmZyb21IZXgocHVibGljS2V5KTsKCSAgICByZXR1cm4gdHJ1ZTsKCSAgfSBjYXRjaCB7CgkgICAgcmV0dXJuIGZhbHNlOwoJICB9Cgl9Cgljb25zdCBzaWduID0gKG1lc3NhZ2UsIHNlY3JldEtleSkgPT4gZWQyNTUxOS5zaWduKG1lc3NhZ2UsIHNlY3JldEtleS5zbGljZSgwLCAzMikpOwoJY29uc3QgdmVyaWZ5ID0gZWQyNTUxOS52ZXJpZnk7CgoJY29uc3QgdG9CdWZmZXIgPSBhcnIgPT4gewoJICBpZiAoYnVmZmVyRXhwb3J0cy5CdWZmZXIuaXNCdWZmZXIoYXJyKSkgewoJICAgIHJldHVybiBhcnI7CgkgIH0gZWxzZSBpZiAoYXJyIGluc3RhbmNlb2YgVWludDhBcnJheSkgewoJICAgIHJldHVybiBidWZmZXJFeHBvcnRzLkJ1ZmZlci5mcm9tKGFyci5idWZmZXIsIGFyci5ieXRlT2Zmc2V0LCBhcnIuYnl0ZUxlbmd0aCk7CgkgIH0gZWxzZSB7CgkgICAgcmV0dXJuIGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oYXJyKTsKCSAgfQoJfTsKCgl2YXIgYm4kMSA9IHtleHBvcnRzOiB7fX07CgoJdmFyIF9ub2RlUmVzb2x2ZV9lbXB0eSA9IHt9OwoKCXZhciBfbm9kZVJlc29sdmVfZW1wdHkkMSA9IC8qI19fUFVSRV9fKi9PYmplY3QuZnJlZXplKHsKCQlfX3Byb3RvX186IG51bGwsCgkJZGVmYXVsdDogX25vZGVSZXNvbHZlX2VtcHR5Cgl9KTsKCgl2YXIgcmVxdWlyZSQkMCQxID0gLypAX19QVVJFX18qL2dldEF1Z21lbnRlZE5hbWVzcGFjZShfbm9kZVJlc29sdmVfZW1wdHkkMSk7CgoJdmFyIGJuID0gYm4kMS5leHBvcnRzOwoKCXZhciBoYXNSZXF1aXJlZEJuOwoKCWZ1bmN0aW9uIHJlcXVpcmVCbiAoKSB7CgkJaWYgKGhhc1JlcXVpcmVkQm4pIHJldHVybiBibiQxLmV4cG9ydHM7CgkJaGFzUmVxdWlyZWRCbiA9IDE7CgkJKGZ1bmN0aW9uIChtb2R1bGUpIHsKCQkJKGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKCgkJCSAgLy8gVXRpbHMKCQkJICBmdW5jdGlvbiBhc3NlcnQgKHZhbCwgbXNnKSB7CgkJCSAgICBpZiAoIXZhbCkgdGhyb3cgbmV3IEVycm9yKG1zZyB8fCAnQXNzZXJ0aW9uIGZhaWxlZCcpOwoJCQkgIH0KCgkJCSAgLy8gQ291bGQgdXNlIGBpbmhlcml0c2AgbW9kdWxlLCBidXQgZG9uJ3Qgd2FudCB0byBtb3ZlIGZyb20gc2luZ2xlIGZpbGUKCQkJICAvLyBhcmNoaXRlY3R1cmUgeWV0LgoJCQkgIGZ1bmN0aW9uIGluaGVyaXRzIChjdG9yLCBzdXBlckN0b3IpIHsKCQkJICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yOwoJCQkgICAgdmFyIFRlbXBDdG9yID0gZnVuY3Rpb24gKCkge307CgkJCSAgICBUZW1wQ3Rvci5wcm90b3R5cGUgPSBzdXBlckN0b3IucHJvdG90eXBlOwoJCQkgICAgY3Rvci5wcm90b3R5cGUgPSBuZXcgVGVtcEN0b3IoKTsKCQkJICAgIGN0b3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY3RvcjsKCQkJICB9CgoJCQkgIC8vIEJOCgoJCQkgIGZ1bmN0aW9uIEJOIChudW1iZXIsIGJhc2UsIGVuZGlhbikgewoJCQkgICAgaWYgKEJOLmlzQk4obnVtYmVyKSkgewoJCQkgICAgICByZXR1cm4gbnVtYmVyOwoJCQkgICAgfQoKCQkJICAgIHRoaXMubmVnYXRpdmUgPSAwOwoJCQkgICAgdGhpcy53b3JkcyA9IG51bGw7CgkJCSAgICB0aGlzLmxlbmd0aCA9IDA7CgoJCQkgICAgLy8gUmVkdWN0aW9uIGNvbnRleHQKCQkJICAgIHRoaXMucmVkID0gbnVsbDsKCgkJCSAgICBpZiAobnVtYmVyICE9PSBudWxsKSB7CgkJCSAgICAgIGlmIChiYXNlID09PSAnbGUnIHx8IGJhc2UgPT09ICdiZScpIHsKCQkJICAgICAgICBlbmRpYW4gPSBiYXNlOwoJCQkgICAgICAgIGJhc2UgPSAxMDsKCQkJICAgICAgfQoKCQkJICAgICAgdGhpcy5faW5pdChudW1iZXIgfHwgMCwgYmFzZSB8fCAxMCwgZW5kaWFuIHx8ICdiZScpOwoJCQkgICAgfQoJCQkgIH0KCQkJICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpIHsKCQkJICAgIG1vZHVsZS5leHBvcnRzID0gQk47CgkJCSAgfSBlbHNlIHsKCQkJICAgIGV4cG9ydHMuQk4gPSBCTjsKCQkJICB9CgoJCQkgIEJOLkJOID0gQk47CgkJCSAgQk4ud29yZFNpemUgPSAyNjsKCgkJCSAgdmFyIEJ1ZmZlcjsKCQkJICB0cnkgewoJCQkgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiB3aW5kb3cuQnVmZmVyICE9PSAndW5kZWZpbmVkJykgewoJCQkgICAgICBCdWZmZXIgPSB3aW5kb3cuQnVmZmVyOwoJCQkgICAgfSBlbHNlIHsKCQkJICAgICAgQnVmZmVyID0gcmVxdWlyZSQkMCQxLkJ1ZmZlcjsKCQkJICAgIH0KCQkJICB9IGNhdGNoIChlKSB7CgkJCSAgfQoKCQkJICBCTi5pc0JOID0gZnVuY3Rpb24gaXNCTiAobnVtKSB7CgkJCSAgICBpZiAobnVtIGluc3RhbmNlb2YgQk4pIHsKCQkJICAgICAgcmV0dXJuIHRydWU7CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIG51bSAhPT0gbnVsbCAmJiB0eXBlb2YgbnVtID09PSAnb2JqZWN0JyAmJgoJCQkgICAgICBudW0uY29uc3RydWN0b3Iud29yZFNpemUgPT09IEJOLndvcmRTaXplICYmIEFycmF5LmlzQXJyYXkobnVtLndvcmRzKTsKCQkJICB9OwoKCQkJICBCTi5tYXggPSBmdW5jdGlvbiBtYXggKGxlZnQsIHJpZ2h0KSB7CgkJCSAgICBpZiAobGVmdC5jbXAocmlnaHQpID4gMCkgcmV0dXJuIGxlZnQ7CgkJCSAgICByZXR1cm4gcmlnaHQ7CgkJCSAgfTsKCgkJCSAgQk4ubWluID0gZnVuY3Rpb24gbWluIChsZWZ0LCByaWdodCkgewoJCQkgICAgaWYgKGxlZnQuY21wKHJpZ2h0KSA8IDApIHJldHVybiBsZWZ0OwoJCQkgICAgcmV0dXJuIHJpZ2h0OwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5faW5pdCA9IGZ1bmN0aW9uIGluaXQgKG51bWJlciwgYmFzZSwgZW5kaWFuKSB7CgkJCSAgICBpZiAodHlwZW9mIG51bWJlciA9PT0gJ251bWJlcicpIHsKCQkJICAgICAgcmV0dXJuIHRoaXMuX2luaXROdW1iZXIobnVtYmVyLCBiYXNlLCBlbmRpYW4pOwoJCQkgICAgfQoKCQkJICAgIGlmICh0eXBlb2YgbnVtYmVyID09PSAnb2JqZWN0JykgewoJCQkgICAgICByZXR1cm4gdGhpcy5faW5pdEFycmF5KG51bWJlciwgYmFzZSwgZW5kaWFuKTsKCQkJICAgIH0KCgkJCSAgICBpZiAoYmFzZSA9PT0gJ2hleCcpIHsKCQkJICAgICAgYmFzZSA9IDE2OwoJCQkgICAgfQoJCQkgICAgYXNzZXJ0KGJhc2UgPT09IChiYXNlIHwgMCkgJiYgYmFzZSA+PSAyICYmIGJhc2UgPD0gMzYpOwoKCQkJICAgIG51bWJlciA9IG51bWJlci50b1N0cmluZygpLnJlcGxhY2UoL1xzKy9nLCAnJyk7CgkJCSAgICB2YXIgc3RhcnQgPSAwOwoJCQkgICAgaWYgKG51bWJlclswXSA9PT0gJy0nKSB7CgkJCSAgICAgIHN0YXJ0Kys7CgkJCSAgICAgIHRoaXMubmVnYXRpdmUgPSAxOwoJCQkgICAgfQoKCQkJICAgIGlmIChzdGFydCA8IG51bWJlci5sZW5ndGgpIHsKCQkJICAgICAgaWYgKGJhc2UgPT09IDE2KSB7CgkJCSAgICAgICAgdGhpcy5fcGFyc2VIZXgobnVtYmVyLCBzdGFydCwgZW5kaWFuKTsKCQkJICAgICAgfSBlbHNlIHsKCQkJICAgICAgICB0aGlzLl9wYXJzZUJhc2UobnVtYmVyLCBiYXNlLCBzdGFydCk7CgkJCSAgICAgICAgaWYgKGVuZGlhbiA9PT0gJ2xlJykgewoJCQkgICAgICAgICAgdGhpcy5faW5pdEFycmF5KHRoaXMudG9BcnJheSgpLCBiYXNlLCBlbmRpYW4pOwoJCQkgICAgICAgIH0KCQkJICAgICAgfQoJCQkgICAgfQoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5faW5pdE51bWJlciA9IGZ1bmN0aW9uIF9pbml0TnVtYmVyIChudW1iZXIsIGJhc2UsIGVuZGlhbikgewoJCQkgICAgaWYgKG51bWJlciA8IDApIHsKCQkJICAgICAgdGhpcy5uZWdhdGl2ZSA9IDE7CgkJCSAgICAgIG51bWJlciA9IC1udW1iZXI7CgkJCSAgICB9CgkJCSAgICBpZiAobnVtYmVyIDwgMHg0MDAwMDAwKSB7CgkJCSAgICAgIHRoaXMud29yZHMgPSBbbnVtYmVyICYgMHgzZmZmZmZmXTsKCQkJICAgICAgdGhpcy5sZW5ndGggPSAxOwoJCQkgICAgfSBlbHNlIGlmIChudW1iZXIgPCAweDEwMDAwMDAwMDAwMDAwKSB7CgkJCSAgICAgIHRoaXMud29yZHMgPSBbCgkJCSAgICAgICAgbnVtYmVyICYgMHgzZmZmZmZmLAoJCQkgICAgICAgIChudW1iZXIgLyAweDQwMDAwMDApICYgMHgzZmZmZmZmCgkJCSAgICAgIF07CgkJCSAgICAgIHRoaXMubGVuZ3RoID0gMjsKCQkJICAgIH0gZWxzZSB7CgkJCSAgICAgIGFzc2VydChudW1iZXIgPCAweDIwMDAwMDAwMDAwMDAwKTsgLy8gMiBeIDUzICh1bnNhZmUpCgkJCSAgICAgIHRoaXMud29yZHMgPSBbCgkJCSAgICAgICAgbnVtYmVyICYgMHgzZmZmZmZmLAoJCQkgICAgICAgIChudW1iZXIgLyAweDQwMDAwMDApICYgMHgzZmZmZmZmLAoJCQkgICAgICAgIDEKCQkJICAgICAgXTsKCQkJICAgICAgdGhpcy5sZW5ndGggPSAzOwoJCQkgICAgfQoKCQkJICAgIGlmIChlbmRpYW4gIT09ICdsZScpIHJldHVybjsKCgkJCSAgICAvLyBSZXZlcnNlIHRoZSBieXRlcwoJCQkgICAgdGhpcy5faW5pdEFycmF5KHRoaXMudG9BcnJheSgpLCBiYXNlLCBlbmRpYW4pOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5faW5pdEFycmF5ID0gZnVuY3Rpb24gX2luaXRBcnJheSAobnVtYmVyLCBiYXNlLCBlbmRpYW4pIHsKCQkJICAgIC8vIFBlcmhhcHMgYSBVaW50OEFycmF5CgkJCSAgICBhc3NlcnQodHlwZW9mIG51bWJlci5sZW5ndGggPT09ICdudW1iZXInKTsKCQkJICAgIGlmIChudW1iZXIubGVuZ3RoIDw9IDApIHsKCQkJICAgICAgdGhpcy53b3JkcyA9IFswXTsKCQkJICAgICAgdGhpcy5sZW5ndGggPSAxOwoJCQkgICAgICByZXR1cm4gdGhpczsKCQkJICAgIH0KCgkJCSAgICB0aGlzLmxlbmd0aCA9IE1hdGguY2VpbChudW1iZXIubGVuZ3RoIC8gMyk7CgkJCSAgICB0aGlzLndvcmRzID0gbmV3IEFycmF5KHRoaXMubGVuZ3RoKTsKCQkJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewoJCQkgICAgICB0aGlzLndvcmRzW2ldID0gMDsKCQkJICAgIH0KCgkJCSAgICB2YXIgaiwgdzsKCQkJICAgIHZhciBvZmYgPSAwOwoJCQkgICAgaWYgKGVuZGlhbiA9PT0gJ2JlJykgewoJCQkgICAgICBmb3IgKGkgPSBudW1iZXIubGVuZ3RoIC0gMSwgaiA9IDA7IGkgPj0gMDsgaSAtPSAzKSB7CgkJCSAgICAgICAgdyA9IG51bWJlcltpXSB8IChudW1iZXJbaSAtIDFdIDw8IDgpIHwgKG51bWJlcltpIC0gMl0gPDwgMTYpOwoJCQkgICAgICAgIHRoaXMud29yZHNbal0gfD0gKHcgPDwgb2ZmKSAmIDB4M2ZmZmZmZjsKCQkJICAgICAgICB0aGlzLndvcmRzW2ogKyAxXSA9ICh3ID4+PiAoMjYgLSBvZmYpKSAmIDB4M2ZmZmZmZjsKCQkJICAgICAgICBvZmYgKz0gMjQ7CgkJCSAgICAgICAgaWYgKG9mZiA+PSAyNikgewoJCQkgICAgICAgICAgb2ZmIC09IDI2OwoJCQkgICAgICAgICAgaisrOwoJCQkgICAgICAgIH0KCQkJICAgICAgfQoJCQkgICAgfSBlbHNlIGlmIChlbmRpYW4gPT09ICdsZScpIHsKCQkJICAgICAgZm9yIChpID0gMCwgaiA9IDA7IGkgPCBudW1iZXIubGVuZ3RoOyBpICs9IDMpIHsKCQkJICAgICAgICB3ID0gbnVtYmVyW2ldIHwgKG51bWJlcltpICsgMV0gPDwgOCkgfCAobnVtYmVyW2kgKyAyXSA8PCAxNik7CgkJCSAgICAgICAgdGhpcy53b3Jkc1tqXSB8PSAodyA8PCBvZmYpICYgMHgzZmZmZmZmOwoJCQkgICAgICAgIHRoaXMud29yZHNbaiArIDFdID0gKHcgPj4+ICgyNiAtIG9mZikpICYgMHgzZmZmZmZmOwoJCQkgICAgICAgIG9mZiArPSAyNDsKCQkJICAgICAgICBpZiAob2ZmID49IDI2KSB7CgkJCSAgICAgICAgICBvZmYgLT0gMjY7CgkJCSAgICAgICAgICBqKys7CgkJCSAgICAgICAgfQoJCQkgICAgICB9CgkJCSAgICB9CgkJCSAgICByZXR1cm4gdGhpcy5fc3RyaXAoKTsKCQkJICB9OwoKCQkJICBmdW5jdGlvbiBwYXJzZUhleDRCaXRzIChzdHJpbmcsIGluZGV4KSB7CgkJCSAgICB2YXIgYyA9IHN0cmluZy5jaGFyQ29kZUF0KGluZGV4KTsKCQkJICAgIC8vICcwJyAtICc5JwoJCQkgICAgaWYgKGMgPj0gNDggJiYgYyA8PSA1NykgewoJCQkgICAgICByZXR1cm4gYyAtIDQ4OwoJCQkgICAgLy8gJ0EnIC0gJ0YnCgkJCSAgICB9IGVsc2UgaWYgKGMgPj0gNjUgJiYgYyA8PSA3MCkgewoJCQkgICAgICByZXR1cm4gYyAtIDU1OwoJCQkgICAgLy8gJ2EnIC0gJ2YnCgkJCSAgICB9IGVsc2UgaWYgKGMgPj0gOTcgJiYgYyA8PSAxMDIpIHsKCQkJICAgICAgcmV0dXJuIGMgLSA4NzsKCQkJICAgIH0gZWxzZSB7CgkJCSAgICAgIGFzc2VydChmYWxzZSwgJ0ludmFsaWQgY2hhcmFjdGVyIGluICcgKyBzdHJpbmcpOwoJCQkgICAgfQoJCQkgIH0KCgkJCSAgZnVuY3Rpb24gcGFyc2VIZXhCeXRlIChzdHJpbmcsIGxvd2VyQm91bmQsIGluZGV4KSB7CgkJCSAgICB2YXIgciA9IHBhcnNlSGV4NEJpdHMoc3RyaW5nLCBpbmRleCk7CgkJCSAgICBpZiAoaW5kZXggLSAxID49IGxvd2VyQm91bmQpIHsKCQkJICAgICAgciB8PSBwYXJzZUhleDRCaXRzKHN0cmluZywgaW5kZXggLSAxKSA8PCA0OwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHI7CgkJCSAgfQoKCQkJICBCTi5wcm90b3R5cGUuX3BhcnNlSGV4ID0gZnVuY3Rpb24gX3BhcnNlSGV4IChudW1iZXIsIHN0YXJ0LCBlbmRpYW4pIHsKCQkJICAgIC8vIENyZWF0ZSBwb3NzaWJseSBiaWdnZXIgYXJyYXkgdG8gZW5zdXJlIHRoYXQgaXQgZml0cyB0aGUgbnVtYmVyCgkJCSAgICB0aGlzLmxlbmd0aCA9IE1hdGguY2VpbCgobnVtYmVyLmxlbmd0aCAtIHN0YXJ0KSAvIDYpOwoJCQkgICAgdGhpcy53b3JkcyA9IG5ldyBBcnJheSh0aGlzLmxlbmd0aCk7CgkJCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IDA7CgkJCSAgICB9CgoJCQkgICAgLy8gMjQtYml0cyBjaHVua3MKCQkJICAgIHZhciBvZmYgPSAwOwoJCQkgICAgdmFyIGogPSAwOwoKCQkJICAgIHZhciB3OwoJCQkgICAgaWYgKGVuZGlhbiA9PT0gJ2JlJykgewoJCQkgICAgICBmb3IgKGkgPSBudW1iZXIubGVuZ3RoIC0gMTsgaSA+PSBzdGFydDsgaSAtPSAyKSB7CgkJCSAgICAgICAgdyA9IHBhcnNlSGV4Qnl0ZShudW1iZXIsIHN0YXJ0LCBpKSA8PCBvZmY7CgkJCSAgICAgICAgdGhpcy53b3Jkc1tqXSB8PSB3ICYgMHgzZmZmZmZmOwoJCQkgICAgICAgIGlmIChvZmYgPj0gMTgpIHsKCQkJICAgICAgICAgIG9mZiAtPSAxODsKCQkJICAgICAgICAgIGogKz0gMTsKCQkJICAgICAgICAgIHRoaXMud29yZHNbal0gfD0gdyA+Pj4gMjY7CgkJCSAgICAgICAgfSBlbHNlIHsKCQkJICAgICAgICAgIG9mZiArPSA4OwoJCQkgICAgICAgIH0KCQkJICAgICAgfQoJCQkgICAgfSBlbHNlIHsKCQkJICAgICAgdmFyIHBhcnNlTGVuZ3RoID0gbnVtYmVyLmxlbmd0aCAtIHN0YXJ0OwoJCQkgICAgICBmb3IgKGkgPSBwYXJzZUxlbmd0aCAlIDIgPT09IDAgPyBzdGFydCArIDEgOiBzdGFydDsgaSA8IG51bWJlci5sZW5ndGg7IGkgKz0gMikgewoJCQkgICAgICAgIHcgPSBwYXJzZUhleEJ5dGUobnVtYmVyLCBzdGFydCwgaSkgPDwgb2ZmOwoJCQkgICAgICAgIHRoaXMud29yZHNbal0gfD0gdyAmIDB4M2ZmZmZmZjsKCQkJICAgICAgICBpZiAob2ZmID49IDE4KSB7CgkJCSAgICAgICAgICBvZmYgLT0gMTg7CgkJCSAgICAgICAgICBqICs9IDE7CgkJCSAgICAgICAgICB0aGlzLndvcmRzW2pdIHw9IHcgPj4+IDI2OwoJCQkgICAgICAgIH0gZWxzZSB7CgkJCSAgICAgICAgICBvZmYgKz0gODsKCQkJICAgICAgICB9CgkJCSAgICAgIH0KCQkJICAgIH0KCgkJCSAgICB0aGlzLl9zdHJpcCgpOwoJCQkgIH07CgoJCQkgIGZ1bmN0aW9uIHBhcnNlQmFzZSAoc3RyLCBzdGFydCwgZW5kLCBtdWwpIHsKCQkJICAgIHZhciByID0gMDsKCQkJICAgIHZhciBiID0gMDsKCQkJICAgIHZhciBsZW4gPSBNYXRoLm1pbihzdHIubGVuZ3RoLCBlbmQpOwoJCQkgICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgbGVuOyBpKyspIHsKCQkJICAgICAgdmFyIGMgPSBzdHIuY2hhckNvZGVBdChpKSAtIDQ4OwoKCQkJICAgICAgciAqPSBtdWw7CgoJCQkgICAgICAvLyAnYScKCQkJICAgICAgaWYgKGMgPj0gNDkpIHsKCQkJICAgICAgICBiID0gYyAtIDQ5ICsgMHhhOwoKCQkJICAgICAgLy8gJ0EnCgkJCSAgICAgIH0gZWxzZSBpZiAoYyA+PSAxNykgewoJCQkgICAgICAgIGIgPSBjIC0gMTcgKyAweGE7CgoJCQkgICAgICAvLyAnMCcgLSAnOScKCQkJICAgICAgfSBlbHNlIHsKCQkJICAgICAgICBiID0gYzsKCQkJICAgICAgfQoJCQkgICAgICBhc3NlcnQoYyA+PSAwICYmIGIgPCBtdWwsICdJbnZhbGlkIGNoYXJhY3RlcicpOwoJCQkgICAgICByICs9IGI7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcjsKCQkJICB9CgoJCQkgIEJOLnByb3RvdHlwZS5fcGFyc2VCYXNlID0gZnVuY3Rpb24gX3BhcnNlQmFzZSAobnVtYmVyLCBiYXNlLCBzdGFydCkgewoJCQkgICAgLy8gSW5pdGlhbGl6ZSBhcyB6ZXJvCgkJCSAgICB0aGlzLndvcmRzID0gWzBdOwoJCQkgICAgdGhpcy5sZW5ndGggPSAxOwoKCQkJICAgIC8vIEZpbmQgbGVuZ3RoIG9mIGxpbWIgaW4gYmFzZQoJCQkgICAgZm9yICh2YXIgbGltYkxlbiA9IDAsIGxpbWJQb3cgPSAxOyBsaW1iUG93IDw9IDB4M2ZmZmZmZjsgbGltYlBvdyAqPSBiYXNlKSB7CgkJCSAgICAgIGxpbWJMZW4rKzsKCQkJICAgIH0KCQkJICAgIGxpbWJMZW4tLTsKCQkJICAgIGxpbWJQb3cgPSAobGltYlBvdyAvIGJhc2UpIHwgMDsKCgkJCSAgICB2YXIgdG90YWwgPSBudW1iZXIubGVuZ3RoIC0gc3RhcnQ7CgkJCSAgICB2YXIgbW9kID0gdG90YWwgJSBsaW1iTGVuOwoJCQkgICAgdmFyIGVuZCA9IE1hdGgubWluKHRvdGFsLCB0b3RhbCAtIG1vZCkgKyBzdGFydDsKCgkJCSAgICB2YXIgd29yZCA9IDA7CgkJCSAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkgKz0gbGltYkxlbikgewoJCQkgICAgICB3b3JkID0gcGFyc2VCYXNlKG51bWJlciwgaSwgaSArIGxpbWJMZW4sIGJhc2UpOwoKCQkJICAgICAgdGhpcy5pbXVsbihsaW1iUG93KTsKCQkJICAgICAgaWYgKHRoaXMud29yZHNbMF0gKyB3b3JkIDwgMHg0MDAwMDAwKSB7CgkJCSAgICAgICAgdGhpcy53b3Jkc1swXSArPSB3b3JkOwoJCQkgICAgICB9IGVsc2UgewoJCQkgICAgICAgIHRoaXMuX2lhZGRuKHdvcmQpOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgaWYgKG1vZCAhPT0gMCkgewoJCQkgICAgICB2YXIgcG93ID0gMTsKCQkJICAgICAgd29yZCA9IHBhcnNlQmFzZShudW1iZXIsIGksIG51bWJlci5sZW5ndGgsIGJhc2UpOwoKCQkJICAgICAgZm9yIChpID0gMDsgaSA8IG1vZDsgaSsrKSB7CgkJCSAgICAgICAgcG93ICo9IGJhc2U7CgkJCSAgICAgIH0KCgkJCSAgICAgIHRoaXMuaW11bG4ocG93KTsKCQkJICAgICAgaWYgKHRoaXMud29yZHNbMF0gKyB3b3JkIDwgMHg0MDAwMDAwKSB7CgkJCSAgICAgICAgdGhpcy53b3Jkc1swXSArPSB3b3JkOwoJCQkgICAgICB9IGVsc2UgewoJCQkgICAgICAgIHRoaXMuX2lhZGRuKHdvcmQpOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgdGhpcy5fc3RyaXAoKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkgKGRlc3QpIHsKCQkJICAgIGRlc3Qud29yZHMgPSBuZXcgQXJyYXkodGhpcy5sZW5ndGgpOwoJCQkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CgkJCSAgICAgIGRlc3Qud29yZHNbaV0gPSB0aGlzLndvcmRzW2ldOwoJCQkgICAgfQoJCQkgICAgZGVzdC5sZW5ndGggPSB0aGlzLmxlbmd0aDsKCQkJICAgIGRlc3QubmVnYXRpdmUgPSB0aGlzLm5lZ2F0aXZlOwoJCQkgICAgZGVzdC5yZWQgPSB0aGlzLnJlZDsKCQkJICB9OwoKCQkJICBmdW5jdGlvbiBtb3ZlIChkZXN0LCBzcmMpIHsKCQkJICAgIGRlc3Qud29yZHMgPSBzcmMud29yZHM7CgkJCSAgICBkZXN0Lmxlbmd0aCA9IHNyYy5sZW5ndGg7CgkJCSAgICBkZXN0Lm5lZ2F0aXZlID0gc3JjLm5lZ2F0aXZlOwoJCQkgICAgZGVzdC5yZWQgPSBzcmMucmVkOwoJCQkgIH0KCgkJCSAgQk4ucHJvdG90eXBlLl9tb3ZlID0gZnVuY3Rpb24gX21vdmUgKGRlc3QpIHsKCQkJICAgIG1vdmUoZGVzdCwgdGhpcyk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24gY2xvbmUgKCkgewoJCQkgICAgdmFyIHIgPSBuZXcgQk4obnVsbCk7CgkJCSAgICB0aGlzLmNvcHkocik7CgkJCSAgICByZXR1cm4gcjsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuX2V4cGFuZCA9IGZ1bmN0aW9uIF9leHBhbmQgKHNpemUpIHsKCQkJICAgIHdoaWxlICh0aGlzLmxlbmd0aCA8IHNpemUpIHsKCQkJICAgICAgdGhpcy53b3Jkc1t0aGlzLmxlbmd0aCsrXSA9IDA7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gdGhpczsKCQkJICB9OwoKCQkJICAvLyBSZW1vdmUgbGVhZGluZyBgMGAgZnJvbSBgdGhpc2AKCQkJICBCTi5wcm90b3R5cGUuX3N0cmlwID0gZnVuY3Rpb24gc3RyaXAgKCkgewoJCQkgICAgd2hpbGUgKHRoaXMubGVuZ3RoID4gMSAmJiB0aGlzLndvcmRzW3RoaXMubGVuZ3RoIC0gMV0gPT09IDApIHsKCQkJICAgICAgdGhpcy5sZW5ndGgtLTsKCQkJICAgIH0KCQkJICAgIHJldHVybiB0aGlzLl9ub3JtU2lnbigpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5fbm9ybVNpZ24gPSBmdW5jdGlvbiBfbm9ybVNpZ24gKCkgewoJCQkgICAgLy8gLTAgPSAwCgkJCSAgICBpZiAodGhpcy5sZW5ndGggPT09IDEgJiYgdGhpcy53b3Jkc1swXSA9PT0gMCkgewoJCQkgICAgICB0aGlzLm5lZ2F0aXZlID0gMDsKCQkJICAgIH0KCQkJICAgIHJldHVybiB0aGlzOwoJCQkgIH07CgoJCQkgIC8vIENoZWNrIFN5bWJvbC5mb3IgYmVjYXVzZSBub3QgZXZlcnl3aGVyZSB3aGVyZSBTeW1ib2wgZGVmaW5lZAoJCQkgIC8vIFNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9TeW1ib2wjQnJvd3Nlcl9jb21wYXRpYmlsaXR5CgkJCSAgaWYgKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBTeW1ib2wuZm9yID09PSAnZnVuY3Rpb24nKSB7CgkJCSAgICB0cnkgewoJCQkgICAgICBCTi5wcm90b3R5cGVbU3ltYm9sLmZvcignbm9kZWpzLnV0aWwuaW5zcGVjdC5jdXN0b20nKV0gPSBpbnNwZWN0OwoJCQkgICAgfSBjYXRjaCAoZSkgewoJCQkgICAgICBCTi5wcm90b3R5cGUuaW5zcGVjdCA9IGluc3BlY3Q7CgkJCSAgICB9CgkJCSAgfSBlbHNlIHsKCQkJICAgIEJOLnByb3RvdHlwZS5pbnNwZWN0ID0gaW5zcGVjdDsKCQkJICB9CgoJCQkgIGZ1bmN0aW9uIGluc3BlY3QgKCkgewoJCQkgICAgcmV0dXJuICh0aGlzLnJlZCA/ICc8Qk4tUjogJyA6ICc8Qk46ICcpICsgdGhpcy50b1N0cmluZygxNikgKyAnPic7CgkJCSAgfQoKCQkJICAvKgoKCQkJICB2YXIgemVyb3MgPSBbXTsKCQkJICB2YXIgZ3JvdXBTaXplcyA9IFtdOwoJCQkgIHZhciBncm91cEJhc2VzID0gW107CgoJCQkgIHZhciBzID0gJyc7CgkJCSAgdmFyIGkgPSAtMTsKCQkJICB3aGlsZSAoKytpIDwgQk4ud29yZFNpemUpIHsKCQkJICAgIHplcm9zW2ldID0gczsKCQkJICAgIHMgKz0gJzAnOwoJCQkgIH0KCQkJICBncm91cFNpemVzWzBdID0gMDsKCQkJICBncm91cFNpemVzWzFdID0gMDsKCQkJICBncm91cEJhc2VzWzBdID0gMDsKCQkJICBncm91cEJhc2VzWzFdID0gMDsKCQkJICB2YXIgYmFzZSA9IDIgLSAxOwoJCQkgIHdoaWxlICgrK2Jhc2UgPCAzNiArIDEpIHsKCQkJICAgIHZhciBncm91cFNpemUgPSAwOwoJCQkgICAgdmFyIGdyb3VwQmFzZSA9IDE7CgkJCSAgICB3aGlsZSAoZ3JvdXBCYXNlIDwgKDEgPDwgQk4ud29yZFNpemUpIC8gYmFzZSkgewoJCQkgICAgICBncm91cEJhc2UgKj0gYmFzZTsKCQkJICAgICAgZ3JvdXBTaXplICs9IDE7CgkJCSAgICB9CgkJCSAgICBncm91cFNpemVzW2Jhc2VdID0gZ3JvdXBTaXplOwoJCQkgICAgZ3JvdXBCYXNlc1tiYXNlXSA9IGdyb3VwQmFzZTsKCQkJICB9CgoJCQkgICovCgoJCQkgIHZhciB6ZXJvcyA9IFsKCQkJICAgICcnLAoJCQkgICAgJzAnLAoJCQkgICAgJzAwJywKCQkJICAgICcwMDAnLAoJCQkgICAgJzAwMDAnLAoJCQkgICAgJzAwMDAwJywKCQkJICAgICcwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwJywKCQkJICAgICcwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwJywKCQkJICAgICcwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAwJywKCQkJICAgICcwMDAwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAwMDAwJywKCQkJICAgICcwMDAwMDAwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAwMDAwMDAwJywKCQkJICAgICcwMDAwMDAwMDAwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwJywKCQkJICAgICcwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAnLAoJCQkgICAgJzAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAnCgkJCSAgXTsKCgkJCSAgdmFyIGdyb3VwU2l6ZXMgPSBbCgkJCSAgICAwLCAwLAoJCQkgICAgMjUsIDE2LCAxMiwgMTEsIDEwLCA5LCA4LAoJCQkgICAgOCwgNywgNywgNywgNywgNiwgNiwKCQkJICAgIDYsIDYsIDYsIDYsIDYsIDUsIDUsCgkJCSAgICA1LCA1LCA1LCA1LCA1LCA1LCA1LAoJCQkgICAgNSwgNSwgNSwgNSwgNSwgNSwgNQoJCQkgIF07CgoJCQkgIHZhciBncm91cEJhc2VzID0gWwoJCQkgICAgMCwgMCwKCQkJICAgIDMzNTU0NDMyLCA0MzA0NjcyMSwgMTY3NzcyMTYsIDQ4ODI4MTI1LCA2MDQ2NjE3NiwgNDAzNTM2MDcsIDE2Nzc3MjE2LAoJCQkgICAgNDMwNDY3MjEsIDEwMDAwMDAwLCAxOTQ4NzE3MSwgMzU4MzE4MDgsIDYyNzQ4NTE3LCA3NTI5NTM2LCAxMTM5MDYyNSwKCQkJICAgIDE2Nzc3MjE2LCAyNDEzNzU2OSwgMzQwMTIyMjQsIDQ3MDQ1ODgxLCA2NDAwMDAwMCwgNDA4NDEwMSwgNTE1MzYzMiwKCQkJICAgIDY0MzYzNDMsIDc5NjI2MjQsIDk3NjU2MjUsIDExODgxMzc2LCAxNDM0ODkwNywgMTcyMTAzNjgsIDIwNTExMTQ5LAoJCQkgICAgMjQzMDAwMDAsIDI4NjI5MTUxLCAzMzU1NDQzMiwgMzkxMzUzOTMsIDQ1NDM1NDI0LCA1MjUyMTg3NSwgNjA0NjYxNzYKCQkJICBdOwoKCQkJICBCTi5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZyAoYmFzZSwgcGFkZGluZykgewoJCQkgICAgYmFzZSA9IGJhc2UgfHwgMTA7CgkJCSAgICBwYWRkaW5nID0gcGFkZGluZyB8IDAgfHwgMTsKCgkJCSAgICB2YXIgb3V0OwoJCQkgICAgaWYgKGJhc2UgPT09IDE2IHx8IGJhc2UgPT09ICdoZXgnKSB7CgkJCSAgICAgIG91dCA9ICcnOwoJCQkgICAgICB2YXIgb2ZmID0gMDsKCQkJICAgICAgdmFyIGNhcnJ5ID0gMDsKCQkJICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CgkJCSAgICAgICAgdmFyIHcgPSB0aGlzLndvcmRzW2ldOwoJCQkgICAgICAgIHZhciB3b3JkID0gKCgodyA8PCBvZmYpIHwgY2FycnkpICYgMHhmZmZmZmYpLnRvU3RyaW5nKDE2KTsKCQkJICAgICAgICBjYXJyeSA9ICh3ID4+PiAoMjQgLSBvZmYpKSAmIDB4ZmZmZmZmOwoJCQkgICAgICAgIG9mZiArPSAyOwoJCQkgICAgICAgIGlmIChvZmYgPj0gMjYpIHsKCQkJICAgICAgICAgIG9mZiAtPSAyNjsKCQkJICAgICAgICAgIGktLTsKCQkJICAgICAgICB9CgkJCSAgICAgICAgaWYgKGNhcnJ5ICE9PSAwIHx8IGkgIT09IHRoaXMubGVuZ3RoIC0gMSkgewoJCQkgICAgICAgICAgb3V0ID0gemVyb3NbNiAtIHdvcmQubGVuZ3RoXSArIHdvcmQgKyBvdXQ7CgkJCSAgICAgICAgfSBlbHNlIHsKCQkJICAgICAgICAgIG91dCA9IHdvcmQgKyBvdXQ7CgkJCSAgICAgICAgfQoJCQkgICAgICB9CgkJCSAgICAgIGlmIChjYXJyeSAhPT0gMCkgewoJCQkgICAgICAgIG91dCA9IGNhcnJ5LnRvU3RyaW5nKDE2KSArIG91dDsKCQkJICAgICAgfQoJCQkgICAgICB3aGlsZSAob3V0Lmxlbmd0aCAlIHBhZGRpbmcgIT09IDApIHsKCQkJICAgICAgICBvdXQgPSAnMCcgKyBvdXQ7CgkJCSAgICAgIH0KCQkJICAgICAgaWYgKHRoaXMubmVnYXRpdmUgIT09IDApIHsKCQkJICAgICAgICBvdXQgPSAnLScgKyBvdXQ7CgkJCSAgICAgIH0KCQkJICAgICAgcmV0dXJuIG91dDsKCQkJICAgIH0KCgkJCSAgICBpZiAoYmFzZSA9PT0gKGJhc2UgfCAwKSAmJiBiYXNlID49IDIgJiYgYmFzZSA8PSAzNikgewoJCQkgICAgICAvLyB2YXIgZ3JvdXBTaXplID0gTWF0aC5mbG9vcihCTi53b3JkU2l6ZSAqIE1hdGguTE4yIC8gTWF0aC5sb2coYmFzZSkpOwoJCQkgICAgICB2YXIgZ3JvdXBTaXplID0gZ3JvdXBTaXplc1tiYXNlXTsKCQkJICAgICAgLy8gdmFyIGdyb3VwQmFzZSA9IE1hdGgucG93KGJhc2UsIGdyb3VwU2l6ZSk7CgkJCSAgICAgIHZhciBncm91cEJhc2UgPSBncm91cEJhc2VzW2Jhc2VdOwoJCQkgICAgICBvdXQgPSAnJzsKCQkJICAgICAgdmFyIGMgPSB0aGlzLmNsb25lKCk7CgkJCSAgICAgIGMubmVnYXRpdmUgPSAwOwoJCQkgICAgICB3aGlsZSAoIWMuaXNaZXJvKCkpIHsKCQkJICAgICAgICB2YXIgciA9IGMubW9kcm4oZ3JvdXBCYXNlKS50b1N0cmluZyhiYXNlKTsKCQkJICAgICAgICBjID0gYy5pZGl2bihncm91cEJhc2UpOwoKCQkJICAgICAgICBpZiAoIWMuaXNaZXJvKCkpIHsKCQkJICAgICAgICAgIG91dCA9IHplcm9zW2dyb3VwU2l6ZSAtIHIubGVuZ3RoXSArIHIgKyBvdXQ7CgkJCSAgICAgICAgfSBlbHNlIHsKCQkJICAgICAgICAgIG91dCA9IHIgKyBvdXQ7CgkJCSAgICAgICAgfQoJCQkgICAgICB9CgkJCSAgICAgIGlmICh0aGlzLmlzWmVybygpKSB7CgkJCSAgICAgICAgb3V0ID0gJzAnICsgb3V0OwoJCQkgICAgICB9CgkJCSAgICAgIHdoaWxlIChvdXQubGVuZ3RoICUgcGFkZGluZyAhPT0gMCkgewoJCQkgICAgICAgIG91dCA9ICcwJyArIG91dDsKCQkJICAgICAgfQoJCQkgICAgICBpZiAodGhpcy5uZWdhdGl2ZSAhPT0gMCkgewoJCQkgICAgICAgIG91dCA9ICctJyArIG91dDsKCQkJICAgICAgfQoJCQkgICAgICByZXR1cm4gb3V0OwoJCQkgICAgfQoKCQkJICAgIGFzc2VydChmYWxzZSwgJ0Jhc2Ugc2hvdWxkIGJlIGJldHdlZW4gMiBhbmQgMzYnKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUudG9OdW1iZXIgPSBmdW5jdGlvbiB0b051bWJlciAoKSB7CgkJCSAgICB2YXIgcmV0ID0gdGhpcy53b3Jkc1swXTsKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMikgewoJCQkgICAgICByZXQgKz0gdGhpcy53b3Jkc1sxXSAqIDB4NDAwMDAwMDsKCQkJICAgIH0gZWxzZSBpZiAodGhpcy5sZW5ndGggPT09IDMgJiYgdGhpcy53b3Jkc1syXSA9PT0gMHgwMSkgewoJCQkgICAgICAvLyBOT1RFOiBhdCB0aGlzIHN0YWdlIGl0IGlzIGtub3duIHRoYXQgdGhlIHRvcCBiaXQgaXMgc2V0CgkJCSAgICAgIHJldCArPSAweDEwMDAwMDAwMDAwMDAwICsgKHRoaXMud29yZHNbMV0gKiAweDQwMDAwMDApOwoJCQkgICAgfSBlbHNlIGlmICh0aGlzLmxlbmd0aCA+IDIpIHsKCQkJICAgICAgYXNzZXJ0KGZhbHNlLCAnTnVtYmVyIGNhbiBvbmx5IHNhZmVseSBzdG9yZSB1cCB0byA1MyBiaXRzJyk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gKHRoaXMubmVnYXRpdmUgIT09IDApID8gLXJldCA6IHJldDsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OICgpIHsKCQkJICAgIHJldHVybiB0aGlzLnRvU3RyaW5nKDE2LCAyKTsKCQkJICB9OwoKCQkJICBpZiAoQnVmZmVyKSB7CgkJCSAgICBCTi5wcm90b3R5cGUudG9CdWZmZXIgPSBmdW5jdGlvbiB0b0J1ZmZlciAoZW5kaWFuLCBsZW5ndGgpIHsKCQkJICAgICAgcmV0dXJuIHRoaXMudG9BcnJheUxpa2UoQnVmZmVyLCBlbmRpYW4sIGxlbmd0aCk7CgkJCSAgICB9OwoJCQkgIH0KCgkJCSAgQk4ucHJvdG90eXBlLnRvQXJyYXkgPSBmdW5jdGlvbiB0b0FycmF5IChlbmRpYW4sIGxlbmd0aCkgewoJCQkgICAgcmV0dXJuIHRoaXMudG9BcnJheUxpa2UoQXJyYXksIGVuZGlhbiwgbGVuZ3RoKTsKCQkJICB9OwoKCQkJICB2YXIgYWxsb2NhdGUgPSBmdW5jdGlvbiBhbGxvY2F0ZSAoQXJyYXlUeXBlLCBzaXplKSB7CgkJCSAgICBpZiAoQXJyYXlUeXBlLmFsbG9jVW5zYWZlKSB7CgkJCSAgICAgIHJldHVybiBBcnJheVR5cGUuYWxsb2NVbnNhZmUoc2l6ZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gbmV3IEFycmF5VHlwZShzaXplKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUudG9BcnJheUxpa2UgPSBmdW5jdGlvbiB0b0FycmF5TGlrZSAoQXJyYXlUeXBlLCBlbmRpYW4sIGxlbmd0aCkgewoJCQkgICAgdGhpcy5fc3RyaXAoKTsKCgkJCSAgICB2YXIgYnl0ZUxlbmd0aCA9IHRoaXMuYnl0ZUxlbmd0aCgpOwoJCQkgICAgdmFyIHJlcUxlbmd0aCA9IGxlbmd0aCB8fCBNYXRoLm1heCgxLCBieXRlTGVuZ3RoKTsKCQkJICAgIGFzc2VydChieXRlTGVuZ3RoIDw9IHJlcUxlbmd0aCwgJ2J5dGUgYXJyYXkgbG9uZ2VyIHRoYW4gZGVzaXJlZCBsZW5ndGgnKTsKCQkJICAgIGFzc2VydChyZXFMZW5ndGggPiAwLCAnUmVxdWVzdGVkIGFycmF5IGxlbmd0aCA8PSAwJyk7CgoJCQkgICAgdmFyIHJlcyA9IGFsbG9jYXRlKEFycmF5VHlwZSwgcmVxTGVuZ3RoKTsKCQkJICAgIHZhciBwb3N0Zml4ID0gZW5kaWFuID09PSAnbGUnID8gJ0xFJyA6ICdCRSc7CgkJCSAgICB0aGlzWydfdG9BcnJheUxpa2UnICsgcG9zdGZpeF0ocmVzLCBieXRlTGVuZ3RoKTsKCQkJICAgIHJldHVybiByZXM7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLl90b0FycmF5TGlrZUxFID0gZnVuY3Rpb24gX3RvQXJyYXlMaWtlTEUgKHJlcywgYnl0ZUxlbmd0aCkgewoJCQkgICAgdmFyIHBvc2l0aW9uID0gMDsKCQkJICAgIHZhciBjYXJyeSA9IDA7CgoJCQkgICAgZm9yICh2YXIgaSA9IDAsIHNoaWZ0ID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdmFyIHdvcmQgPSAodGhpcy53b3Jkc1tpXSA8PCBzaGlmdCkgfCBjYXJyeTsKCgkJCSAgICAgIHJlc1twb3NpdGlvbisrXSA9IHdvcmQgJiAweGZmOwoJCQkgICAgICBpZiAocG9zaXRpb24gPCByZXMubGVuZ3RoKSB7CgkJCSAgICAgICAgcmVzW3Bvc2l0aW9uKytdID0gKHdvcmQgPj4gOCkgJiAweGZmOwoJCQkgICAgICB9CgkJCSAgICAgIGlmIChwb3NpdGlvbiA8IHJlcy5sZW5ndGgpIHsKCQkJICAgICAgICByZXNbcG9zaXRpb24rK10gPSAod29yZCA+PiAxNikgJiAweGZmOwoJCQkgICAgICB9CgoJCQkgICAgICBpZiAoc2hpZnQgPT09IDYpIHsKCQkJICAgICAgICBpZiAocG9zaXRpb24gPCByZXMubGVuZ3RoKSB7CgkJCSAgICAgICAgICByZXNbcG9zaXRpb24rK10gPSAod29yZCA+PiAyNCkgJiAweGZmOwoJCQkgICAgICAgIH0KCQkJICAgICAgICBjYXJyeSA9IDA7CgkJCSAgICAgICAgc2hpZnQgPSAwOwoJCQkgICAgICB9IGVsc2UgewoJCQkgICAgICAgIGNhcnJ5ID0gd29yZCA+Pj4gMjQ7CgkJCSAgICAgICAgc2hpZnQgKz0gMjsKCQkJICAgICAgfQoJCQkgICAgfQoKCQkJICAgIGlmIChwb3NpdGlvbiA8IHJlcy5sZW5ndGgpIHsKCQkJICAgICAgcmVzW3Bvc2l0aW9uKytdID0gY2Fycnk7CgoJCQkgICAgICB3aGlsZSAocG9zaXRpb24gPCByZXMubGVuZ3RoKSB7CgkJCSAgICAgICAgcmVzW3Bvc2l0aW9uKytdID0gMDsKCQkJICAgICAgfQoJCQkgICAgfQoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5fdG9BcnJheUxpa2VCRSA9IGZ1bmN0aW9uIF90b0FycmF5TGlrZUJFIChyZXMsIGJ5dGVMZW5ndGgpIHsKCQkJICAgIHZhciBwb3NpdGlvbiA9IHJlcy5sZW5ndGggLSAxOwoJCQkgICAgdmFyIGNhcnJ5ID0gMDsKCgkJCSAgICBmb3IgKHZhciBpID0gMCwgc2hpZnQgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewoJCQkgICAgICB2YXIgd29yZCA9ICh0aGlzLndvcmRzW2ldIDw8IHNoaWZ0KSB8IGNhcnJ5OwoKCQkJICAgICAgcmVzW3Bvc2l0aW9uLS1dID0gd29yZCAmIDB4ZmY7CgkJCSAgICAgIGlmIChwb3NpdGlvbiA+PSAwKSB7CgkJCSAgICAgICAgcmVzW3Bvc2l0aW9uLS1dID0gKHdvcmQgPj4gOCkgJiAweGZmOwoJCQkgICAgICB9CgkJCSAgICAgIGlmIChwb3NpdGlvbiA+PSAwKSB7CgkJCSAgICAgICAgcmVzW3Bvc2l0aW9uLS1dID0gKHdvcmQgPj4gMTYpICYgMHhmZjsKCQkJICAgICAgfQoKCQkJICAgICAgaWYgKHNoaWZ0ID09PSA2KSB7CgkJCSAgICAgICAgaWYgKHBvc2l0aW9uID49IDApIHsKCQkJICAgICAgICAgIHJlc1twb3NpdGlvbi0tXSA9ICh3b3JkID4+IDI0KSAmIDB4ZmY7CgkJCSAgICAgICAgfQoJCQkgICAgICAgIGNhcnJ5ID0gMDsKCQkJICAgICAgICBzaGlmdCA9IDA7CgkJCSAgICAgIH0gZWxzZSB7CgkJCSAgICAgICAgY2FycnkgPSB3b3JkID4+PiAyNDsKCQkJICAgICAgICBzaGlmdCArPSAyOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgaWYgKHBvc2l0aW9uID49IDApIHsKCQkJICAgICAgcmVzW3Bvc2l0aW9uLS1dID0gY2Fycnk7CgoJCQkgICAgICB3aGlsZSAocG9zaXRpb24gPj0gMCkgewoJCQkgICAgICAgIHJlc1twb3NpdGlvbi0tXSA9IDA7CgkJCSAgICAgIH0KCQkJICAgIH0KCQkJICB9OwoKCQkJICBpZiAoTWF0aC5jbHozMikgewoJCQkgICAgQk4ucHJvdG90eXBlLl9jb3VudEJpdHMgPSBmdW5jdGlvbiBfY291bnRCaXRzICh3KSB7CgkJCSAgICAgIHJldHVybiAzMiAtIE1hdGguY2x6MzIodyk7CgkJCSAgICB9OwoJCQkgIH0gZWxzZSB7CgkJCSAgICBCTi5wcm90b3R5cGUuX2NvdW50Qml0cyA9IGZ1bmN0aW9uIF9jb3VudEJpdHMgKHcpIHsKCQkJICAgICAgdmFyIHQgPSB3OwoJCQkgICAgICB2YXIgciA9IDA7CgkJCSAgICAgIGlmICh0ID49IDB4MTAwMCkgewoJCQkgICAgICAgIHIgKz0gMTM7CgkJCSAgICAgICAgdCA+Pj49IDEzOwoJCQkgICAgICB9CgkJCSAgICAgIGlmICh0ID49IDB4NDApIHsKCQkJICAgICAgICByICs9IDc7CgkJCSAgICAgICAgdCA+Pj49IDc7CgkJCSAgICAgIH0KCQkJICAgICAgaWYgKHQgPj0gMHg4KSB7CgkJCSAgICAgICAgciArPSA0OwoJCQkgICAgICAgIHQgPj4+PSA0OwoJCQkgICAgICB9CgkJCSAgICAgIGlmICh0ID49IDB4MDIpIHsKCQkJICAgICAgICByICs9IDI7CgkJCSAgICAgICAgdCA+Pj49IDI7CgkJCSAgICAgIH0KCQkJICAgICAgcmV0dXJuIHIgKyB0OwoJCQkgICAgfTsKCQkJICB9CgoJCQkgIEJOLnByb3RvdHlwZS5femVyb0JpdHMgPSBmdW5jdGlvbiBfemVyb0JpdHMgKHcpIHsKCQkJICAgIC8vIFNob3J0LWN1dAoJCQkgICAgaWYgKHcgPT09IDApIHJldHVybiAyNjsKCgkJCSAgICB2YXIgdCA9IHc7CgkJCSAgICB2YXIgciA9IDA7CgkJCSAgICBpZiAoKHQgJiAweDFmZmYpID09PSAwKSB7CgkJCSAgICAgIHIgKz0gMTM7CgkJCSAgICAgIHQgPj4+PSAxMzsKCQkJICAgIH0KCQkJICAgIGlmICgodCAmIDB4N2YpID09PSAwKSB7CgkJCSAgICAgIHIgKz0gNzsKCQkJICAgICAgdCA+Pj49IDc7CgkJCSAgICB9CgkJCSAgICBpZiAoKHQgJiAweGYpID09PSAwKSB7CgkJCSAgICAgIHIgKz0gNDsKCQkJICAgICAgdCA+Pj49IDQ7CgkJCSAgICB9CgkJCSAgICBpZiAoKHQgJiAweDMpID09PSAwKSB7CgkJCSAgICAgIHIgKz0gMjsKCQkJICAgICAgdCA+Pj49IDI7CgkJCSAgICB9CgkJCSAgICBpZiAoKHQgJiAweDEpID09PSAwKSB7CgkJCSAgICAgIHIrKzsKCQkJICAgIH0KCQkJICAgIHJldHVybiByOwoJCQkgIH07CgoJCQkgIC8vIFJldHVybiBudW1iZXIgb2YgdXNlZCBiaXRzIGluIGEgQk4KCQkJICBCTi5wcm90b3R5cGUuYml0TGVuZ3RoID0gZnVuY3Rpb24gYml0TGVuZ3RoICgpIHsKCQkJICAgIHZhciB3ID0gdGhpcy53b3Jkc1t0aGlzLmxlbmd0aCAtIDFdOwoJCQkgICAgdmFyIGhpID0gdGhpcy5fY291bnRCaXRzKHcpOwoJCQkgICAgcmV0dXJuICh0aGlzLmxlbmd0aCAtIDEpICogMjYgKyBoaTsKCQkJICB9OwoKCQkJICBmdW5jdGlvbiB0b0JpdEFycmF5IChudW0pIHsKCQkJICAgIHZhciB3ID0gbmV3IEFycmF5KG51bS5iaXRMZW5ndGgoKSk7CgoJCQkgICAgZm9yICh2YXIgYml0ID0gMDsgYml0IDwgdy5sZW5ndGg7IGJpdCsrKSB7CgkJCSAgICAgIHZhciBvZmYgPSAoYml0IC8gMjYpIHwgMDsKCQkJICAgICAgdmFyIHdiaXQgPSBiaXQgJSAyNjsKCgkJCSAgICAgIHdbYml0XSA9IChudW0ud29yZHNbb2ZmXSA+Pj4gd2JpdCkgJiAweDAxOwoJCQkgICAgfQoKCQkJICAgIHJldHVybiB3OwoJCQkgIH0KCgkJCSAgLy8gTnVtYmVyIG9mIHRyYWlsaW5nIHplcm8gYml0cwoJCQkgIEJOLnByb3RvdHlwZS56ZXJvQml0cyA9IGZ1bmN0aW9uIHplcm9CaXRzICgpIHsKCQkJICAgIGlmICh0aGlzLmlzWmVybygpKSByZXR1cm4gMDsKCgkJCSAgICB2YXIgciA9IDA7CgkJCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdmFyIGIgPSB0aGlzLl96ZXJvQml0cyh0aGlzLndvcmRzW2ldKTsKCQkJICAgICAgciArPSBiOwoJCQkgICAgICBpZiAoYiAhPT0gMjYpIGJyZWFrOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHI7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmJ5dGVMZW5ndGggPSBmdW5jdGlvbiBieXRlTGVuZ3RoICgpIHsKCQkJICAgIHJldHVybiBNYXRoLmNlaWwodGhpcy5iaXRMZW5ndGgoKSAvIDgpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS50b1R3b3MgPSBmdW5jdGlvbiB0b1R3b3MgKHdpZHRoKSB7CgkJCSAgICBpZiAodGhpcy5uZWdhdGl2ZSAhPT0gMCkgewoJCQkgICAgICByZXR1cm4gdGhpcy5hYnMoKS5pbm90bih3aWR0aCkuaWFkZG4oMSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gdGhpcy5jbG9uZSgpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5mcm9tVHdvcyA9IGZ1bmN0aW9uIGZyb21Ud29zICh3aWR0aCkgewoJCQkgICAgaWYgKHRoaXMudGVzdG4od2lkdGggLSAxKSkgewoJCQkgICAgICByZXR1cm4gdGhpcy5ub3RuKHdpZHRoKS5pYWRkbigxKS5pbmVnKCk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gdGhpcy5jbG9uZSgpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5pc05lZyA9IGZ1bmN0aW9uIGlzTmVnICgpIHsKCQkJICAgIHJldHVybiB0aGlzLm5lZ2F0aXZlICE9PSAwOwoJCQkgIH07CgoJCQkgIC8vIFJldHVybiBuZWdhdGl2ZSBjbG9uZSBvZiBgdGhpc2AKCQkJICBCTi5wcm90b3R5cGUubmVnID0gZnVuY3Rpb24gbmVnICgpIHsKCQkJICAgIHJldHVybiB0aGlzLmNsb25lKCkuaW5lZygpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5pbmVnID0gZnVuY3Rpb24gaW5lZyAoKSB7CgkJCSAgICBpZiAoIXRoaXMuaXNaZXJvKCkpIHsKCQkJICAgICAgdGhpcy5uZWdhdGl2ZSBePSAxOwoJCQkgICAgfQoKCQkJICAgIHJldHVybiB0aGlzOwoJCQkgIH07CgoJCQkgIC8vIE9yIGBudW1gIHdpdGggYHRoaXNgIGluLXBsYWNlCgkJCSAgQk4ucHJvdG90eXBlLml1b3IgPSBmdW5jdGlvbiBpdW9yIChudW0pIHsKCQkJICAgIHdoaWxlICh0aGlzLmxlbmd0aCA8IG51bS5sZW5ndGgpIHsKCQkJICAgICAgdGhpcy53b3Jkc1t0aGlzLmxlbmd0aCsrXSA9IDA7CgkJCSAgICB9CgoJCQkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW0ubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IHRoaXMud29yZHNbaV0gfCBudW0ud29yZHNbaV07CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHRoaXMuX3N0cmlwKCk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmlvciA9IGZ1bmN0aW9uIGlvciAobnVtKSB7CgkJCSAgICBhc3NlcnQoKHRoaXMubmVnYXRpdmUgfCBudW0ubmVnYXRpdmUpID09PSAwKTsKCQkJICAgIHJldHVybiB0aGlzLml1b3IobnVtKTsKCQkJICB9OwoKCQkJICAvLyBPciBgbnVtYCB3aXRoIGB0aGlzYAoJCQkgIEJOLnByb3RvdHlwZS5vciA9IGZ1bmN0aW9uIG9yIChudW0pIHsKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA+IG51bS5sZW5ndGgpIHJldHVybiB0aGlzLmNsb25lKCkuaW9yKG51bSk7CgkJCSAgICByZXR1cm4gbnVtLmNsb25lKCkuaW9yKHRoaXMpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS51b3IgPSBmdW5jdGlvbiB1b3IgKG51bSkgewoJCQkgICAgaWYgKHRoaXMubGVuZ3RoID4gbnVtLmxlbmd0aCkgcmV0dXJuIHRoaXMuY2xvbmUoKS5pdW9yKG51bSk7CgkJCSAgICByZXR1cm4gbnVtLmNsb25lKCkuaXVvcih0aGlzKTsKCQkJICB9OwoKCQkJICAvLyBBbmQgYG51bWAgd2l0aCBgdGhpc2AgaW4tcGxhY2UKCQkJICBCTi5wcm90b3R5cGUuaXVhbmQgPSBmdW5jdGlvbiBpdWFuZCAobnVtKSB7CgkJCSAgICAvLyBiID0gbWluLWxlbmd0aChudW0sIHRoaXMpCgkJCSAgICB2YXIgYjsKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA+IG51bS5sZW5ndGgpIHsKCQkJICAgICAgYiA9IG51bTsKCQkJICAgIH0gZWxzZSB7CgkJCSAgICAgIGIgPSB0aGlzOwoJCQkgICAgfQoKCQkJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYi5sZW5ndGg7IGkrKykgewoJCQkgICAgICB0aGlzLndvcmRzW2ldID0gdGhpcy53b3Jkc1tpXSAmIG51bS53b3Jkc1tpXTsKCQkJICAgIH0KCgkJCSAgICB0aGlzLmxlbmd0aCA9IGIubGVuZ3RoOwoKCQkJICAgIHJldHVybiB0aGlzLl9zdHJpcCgpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5pYW5kID0gZnVuY3Rpb24gaWFuZCAobnVtKSB7CgkJCSAgICBhc3NlcnQoKHRoaXMubmVnYXRpdmUgfCBudW0ubmVnYXRpdmUpID09PSAwKTsKCQkJICAgIHJldHVybiB0aGlzLml1YW5kKG51bSk7CgkJCSAgfTsKCgkJCSAgLy8gQW5kIGBudW1gIHdpdGggYHRoaXNgCgkJCSAgQk4ucHJvdG90eXBlLmFuZCA9IGZ1bmN0aW9uIGFuZCAobnVtKSB7CgkJCSAgICBpZiAodGhpcy5sZW5ndGggPiBudW0ubGVuZ3RoKSByZXR1cm4gdGhpcy5jbG9uZSgpLmlhbmQobnVtKTsKCQkJICAgIHJldHVybiBudW0uY2xvbmUoKS5pYW5kKHRoaXMpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS51YW5kID0gZnVuY3Rpb24gdWFuZCAobnVtKSB7CgkJCSAgICBpZiAodGhpcy5sZW5ndGggPiBudW0ubGVuZ3RoKSByZXR1cm4gdGhpcy5jbG9uZSgpLml1YW5kKG51bSk7CgkJCSAgICByZXR1cm4gbnVtLmNsb25lKCkuaXVhbmQodGhpcyk7CgkJCSAgfTsKCgkJCSAgLy8gWG9yIGBudW1gIHdpdGggYHRoaXNgIGluLXBsYWNlCgkJCSAgQk4ucHJvdG90eXBlLml1eG9yID0gZnVuY3Rpb24gaXV4b3IgKG51bSkgewoJCQkgICAgLy8gYS5sZW5ndGggPiBiLmxlbmd0aAoJCQkgICAgdmFyIGE7CgkJCSAgICB2YXIgYjsKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA+IG51bS5sZW5ndGgpIHsKCQkJICAgICAgYSA9IHRoaXM7CgkJCSAgICAgIGIgPSBudW07CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBhID0gbnVtOwoJCQkgICAgICBiID0gdGhpczsKCQkJICAgIH0KCgkJCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGIubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IGEud29yZHNbaV0gXiBiLndvcmRzW2ldOwoJCQkgICAgfQoKCQkJICAgIGlmICh0aGlzICE9PSBhKSB7CgkJCSAgICAgIGZvciAoOyBpIDwgYS5sZW5ndGg7IGkrKykgewoJCQkgICAgICAgIHRoaXMud29yZHNbaV0gPSBhLndvcmRzW2ldOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgdGhpcy5sZW5ndGggPSBhLmxlbmd0aDsKCgkJCSAgICByZXR1cm4gdGhpcy5fc3RyaXAoKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuaXhvciA9IGZ1bmN0aW9uIGl4b3IgKG51bSkgewoJCQkgICAgYXNzZXJ0KCh0aGlzLm5lZ2F0aXZlIHwgbnVtLm5lZ2F0aXZlKSA9PT0gMCk7CgkJCSAgICByZXR1cm4gdGhpcy5pdXhvcihudW0pOwoJCQkgIH07CgoJCQkgIC8vIFhvciBgbnVtYCB3aXRoIGB0aGlzYAoJCQkgIEJOLnByb3RvdHlwZS54b3IgPSBmdW5jdGlvbiB4b3IgKG51bSkgewoJCQkgICAgaWYgKHRoaXMubGVuZ3RoID4gbnVtLmxlbmd0aCkgcmV0dXJuIHRoaXMuY2xvbmUoKS5peG9yKG51bSk7CgkJCSAgICByZXR1cm4gbnVtLmNsb25lKCkuaXhvcih0aGlzKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUudXhvciA9IGZ1bmN0aW9uIHV4b3IgKG51bSkgewoJCQkgICAgaWYgKHRoaXMubGVuZ3RoID4gbnVtLmxlbmd0aCkgcmV0dXJuIHRoaXMuY2xvbmUoKS5pdXhvcihudW0pOwoJCQkgICAgcmV0dXJuIG51bS5jbG9uZSgpLml1eG9yKHRoaXMpOwoJCQkgIH07CgoJCQkgIC8vIE5vdCBgYHRoaXNgYCB3aXRoIGBgd2lkdGhgYCBiaXR3aWR0aAoJCQkgIEJOLnByb3RvdHlwZS5pbm90biA9IGZ1bmN0aW9uIGlub3RuICh3aWR0aCkgewoJCQkgICAgYXNzZXJ0KHR5cGVvZiB3aWR0aCA9PT0gJ251bWJlcicgJiYgd2lkdGggPj0gMCk7CgoJCQkgICAgdmFyIGJ5dGVzTmVlZGVkID0gTWF0aC5jZWlsKHdpZHRoIC8gMjYpIHwgMDsKCQkJICAgIHZhciBiaXRzTGVmdCA9IHdpZHRoICUgMjY7CgoJCQkgICAgLy8gRXh0ZW5kIHRoZSBidWZmZXIgd2l0aCBsZWFkaW5nIHplcm9lcwoJCQkgICAgdGhpcy5fZXhwYW5kKGJ5dGVzTmVlZGVkKTsKCgkJCSAgICBpZiAoYml0c0xlZnQgPiAwKSB7CgkJCSAgICAgIGJ5dGVzTmVlZGVkLS07CgkJCSAgICB9CgoJCQkgICAgLy8gSGFuZGxlIGNvbXBsZXRlIHdvcmRzCgkJCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ5dGVzTmVlZGVkOyBpKyspIHsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IH50aGlzLndvcmRzW2ldICYgMHgzZmZmZmZmOwoJCQkgICAgfQoKCQkJICAgIC8vIEhhbmRsZSB0aGUgcmVzaWR1ZQoJCQkgICAgaWYgKGJpdHNMZWZ0ID4gMCkgewoJCQkgICAgICB0aGlzLndvcmRzW2ldID0gfnRoaXMud29yZHNbaV0gJiAoMHgzZmZmZmZmID4+ICgyNiAtIGJpdHNMZWZ0KSk7CgkJCSAgICB9CgoJCQkgICAgLy8gQW5kIHJlbW92ZSBsZWFkaW5nIHplcm9lcwoJCQkgICAgcmV0dXJuIHRoaXMuX3N0cmlwKCk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLm5vdG4gPSBmdW5jdGlvbiBub3RuICh3aWR0aCkgewoJCQkgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5pbm90bih3aWR0aCk7CgkJCSAgfTsKCgkJCSAgLy8gU2V0IGBiaXRgIG9mIGB0aGlzYAoJCQkgIEJOLnByb3RvdHlwZS5zZXRuID0gZnVuY3Rpb24gc2V0biAoYml0LCB2YWwpIHsKCQkJICAgIGFzc2VydCh0eXBlb2YgYml0ID09PSAnbnVtYmVyJyAmJiBiaXQgPj0gMCk7CgoJCQkgICAgdmFyIG9mZiA9IChiaXQgLyAyNikgfCAwOwoJCQkgICAgdmFyIHdiaXQgPSBiaXQgJSAyNjsKCgkJCSAgICB0aGlzLl9leHBhbmQob2ZmICsgMSk7CgoJCQkgICAgaWYgKHZhbCkgewoJCQkgICAgICB0aGlzLndvcmRzW29mZl0gPSB0aGlzLndvcmRzW29mZl0gfCAoMSA8PCB3Yml0KTsKCQkJICAgIH0gZWxzZSB7CgkJCSAgICAgIHRoaXMud29yZHNbb2ZmXSA9IHRoaXMud29yZHNbb2ZmXSAmIH4oMSA8PCB3Yml0KTsKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gdGhpcy5fc3RyaXAoKTsKCQkJICB9OwoKCQkJICAvLyBBZGQgYG51bWAgdG8gYHRoaXNgIGluLXBsYWNlCgkJCSAgQk4ucHJvdG90eXBlLmlhZGQgPSBmdW5jdGlvbiBpYWRkIChudW0pIHsKCQkJICAgIHZhciByOwoKCQkJICAgIC8vIG5lZ2F0aXZlICsgcG9zaXRpdmUKCQkJICAgIGlmICh0aGlzLm5lZ2F0aXZlICE9PSAwICYmIG51bS5uZWdhdGl2ZSA9PT0gMCkgewoJCQkgICAgICB0aGlzLm5lZ2F0aXZlID0gMDsKCQkJICAgICAgciA9IHRoaXMuaXN1YihudW0pOwoJCQkgICAgICB0aGlzLm5lZ2F0aXZlIF49IDE7CgkJCSAgICAgIHJldHVybiB0aGlzLl9ub3JtU2lnbigpOwoKCQkJICAgIC8vIHBvc2l0aXZlICsgbmVnYXRpdmUKCQkJICAgIH0gZWxzZSBpZiAodGhpcy5uZWdhdGl2ZSA9PT0gMCAmJiBudW0ubmVnYXRpdmUgIT09IDApIHsKCQkJICAgICAgbnVtLm5lZ2F0aXZlID0gMDsKCQkJICAgICAgciA9IHRoaXMuaXN1YihudW0pOwoJCQkgICAgICBudW0ubmVnYXRpdmUgPSAxOwoJCQkgICAgICByZXR1cm4gci5fbm9ybVNpZ24oKTsKCQkJICAgIH0KCgkJCSAgICAvLyBhLmxlbmd0aCA+IGIubGVuZ3RoCgkJCSAgICB2YXIgYSwgYjsKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA+IG51bS5sZW5ndGgpIHsKCQkJICAgICAgYSA9IHRoaXM7CgkJCSAgICAgIGIgPSBudW07CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBhID0gbnVtOwoJCQkgICAgICBiID0gdGhpczsKCQkJICAgIH0KCgkJCSAgICB2YXIgY2FycnkgPSAwOwoJCQkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBiLmxlbmd0aDsgaSsrKSB7CgkJCSAgICAgIHIgPSAoYS53b3Jkc1tpXSB8IDApICsgKGIud29yZHNbaV0gfCAwKSArIGNhcnJ5OwoJCQkgICAgICB0aGlzLndvcmRzW2ldID0gciAmIDB4M2ZmZmZmZjsKCQkJICAgICAgY2FycnkgPSByID4+PiAyNjsKCQkJICAgIH0KCQkJICAgIGZvciAoOyBjYXJyeSAhPT0gMCAmJiBpIDwgYS5sZW5ndGg7IGkrKykgewoJCQkgICAgICByID0gKGEud29yZHNbaV0gfCAwKSArIGNhcnJ5OwoJCQkgICAgICB0aGlzLndvcmRzW2ldID0gciAmIDB4M2ZmZmZmZjsKCQkJICAgICAgY2FycnkgPSByID4+PiAyNjsKCQkJICAgIH0KCgkJCSAgICB0aGlzLmxlbmd0aCA9IGEubGVuZ3RoOwoJCQkgICAgaWYgKGNhcnJ5ICE9PSAwKSB7CgkJCSAgICAgIHRoaXMud29yZHNbdGhpcy5sZW5ndGhdID0gY2Fycnk7CgkJCSAgICAgIHRoaXMubGVuZ3RoKys7CgkJCSAgICAvLyBDb3B5IHRoZSByZXN0IG9mIHRoZSB3b3JkcwoJCQkgICAgfSBlbHNlIGlmIChhICE9PSB0aGlzKSB7CgkJCSAgICAgIGZvciAoOyBpIDwgYS5sZW5ndGg7IGkrKykgewoJCQkgICAgICAgIHRoaXMud29yZHNbaV0gPSBhLndvcmRzW2ldOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHRoaXM7CgkJCSAgfTsKCgkJCSAgLy8gQWRkIGBudW1gIHRvIGB0aGlzYAoJCQkgIEJOLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQgKG51bSkgewoJCQkgICAgdmFyIHJlczsKCQkJICAgIGlmIChudW0ubmVnYXRpdmUgIT09IDAgJiYgdGhpcy5uZWdhdGl2ZSA9PT0gMCkgewoJCQkgICAgICBudW0ubmVnYXRpdmUgPSAwOwoJCQkgICAgICByZXMgPSB0aGlzLnN1YihudW0pOwoJCQkgICAgICBudW0ubmVnYXRpdmUgXj0gMTsKCQkJICAgICAgcmV0dXJuIHJlczsKCQkJICAgIH0gZWxzZSBpZiAobnVtLm5lZ2F0aXZlID09PSAwICYmIHRoaXMubmVnYXRpdmUgIT09IDApIHsKCQkJICAgICAgdGhpcy5uZWdhdGl2ZSA9IDA7CgkJCSAgICAgIHJlcyA9IG51bS5zdWIodGhpcyk7CgkJCSAgICAgIHRoaXMubmVnYXRpdmUgPSAxOwoJCQkgICAgICByZXR1cm4gcmVzOwoJCQkgICAgfQoKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA+IG51bS5sZW5ndGgpIHJldHVybiB0aGlzLmNsb25lKCkuaWFkZChudW0pOwoKCQkJICAgIHJldHVybiBudW0uY2xvbmUoKS5pYWRkKHRoaXMpOwoJCQkgIH07CgoJCQkgIC8vIFN1YnRyYWN0IGBudW1gIGZyb20gYHRoaXNgIGluLXBsYWNlCgkJCSAgQk4ucHJvdG90eXBlLmlzdWIgPSBmdW5jdGlvbiBpc3ViIChudW0pIHsKCQkJICAgIC8vIHRoaXMgLSAoLW51bSkgPSB0aGlzICsgbnVtCgkJCSAgICBpZiAobnVtLm5lZ2F0aXZlICE9PSAwKSB7CgkJCSAgICAgIG51bS5uZWdhdGl2ZSA9IDA7CgkJCSAgICAgIHZhciByID0gdGhpcy5pYWRkKG51bSk7CgkJCSAgICAgIG51bS5uZWdhdGl2ZSA9IDE7CgkJCSAgICAgIHJldHVybiByLl9ub3JtU2lnbigpOwoKCQkJICAgIC8vIC10aGlzIC0gbnVtID0gLSh0aGlzICsgbnVtKQoJCQkgICAgfSBlbHNlIGlmICh0aGlzLm5lZ2F0aXZlICE9PSAwKSB7CgkJCSAgICAgIHRoaXMubmVnYXRpdmUgPSAwOwoJCQkgICAgICB0aGlzLmlhZGQobnVtKTsKCQkJICAgICAgdGhpcy5uZWdhdGl2ZSA9IDE7CgkJCSAgICAgIHJldHVybiB0aGlzLl9ub3JtU2lnbigpOwoJCQkgICAgfQoKCQkJICAgIC8vIEF0IHRoaXMgcG9pbnQgYm90aCBudW1iZXJzIGFyZSBwb3NpdGl2ZQoJCQkgICAgdmFyIGNtcCA9IHRoaXMuY21wKG51bSk7CgoJCQkgICAgLy8gT3B0aW1pemF0aW9uIC0gemVyb2lmeQoJCQkgICAgaWYgKGNtcCA9PT0gMCkgewoJCQkgICAgICB0aGlzLm5lZ2F0aXZlID0gMDsKCQkJICAgICAgdGhpcy5sZW5ndGggPSAxOwoJCQkgICAgICB0aGlzLndvcmRzWzBdID0gMDsKCQkJICAgICAgcmV0dXJuIHRoaXM7CgkJCSAgICB9CgoJCQkgICAgLy8gYSA+IGIKCQkJICAgIHZhciBhLCBiOwoJCQkgICAgaWYgKGNtcCA+IDApIHsKCQkJICAgICAgYSA9IHRoaXM7CgkJCSAgICAgIGIgPSBudW07CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBhID0gbnVtOwoJCQkgICAgICBiID0gdGhpczsKCQkJICAgIH0KCgkJCSAgICB2YXIgY2FycnkgPSAwOwoJCQkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBiLmxlbmd0aDsgaSsrKSB7CgkJCSAgICAgIHIgPSAoYS53b3Jkc1tpXSB8IDApIC0gKGIud29yZHNbaV0gfCAwKSArIGNhcnJ5OwoJCQkgICAgICBjYXJyeSA9IHIgPj4gMjY7CgkJCSAgICAgIHRoaXMud29yZHNbaV0gPSByICYgMHgzZmZmZmZmOwoJCQkgICAgfQoJCQkgICAgZm9yICg7IGNhcnJ5ICE9PSAwICYmIGkgPCBhLmxlbmd0aDsgaSsrKSB7CgkJCSAgICAgIHIgPSAoYS53b3Jkc1tpXSB8IDApICsgY2Fycnk7CgkJCSAgICAgIGNhcnJ5ID0gciA+PiAyNjsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IHIgJiAweDNmZmZmZmY7CgkJCSAgICB9CgoJCQkgICAgLy8gQ29weSByZXN0IG9mIHRoZSB3b3JkcwoJCQkgICAgaWYgKGNhcnJ5ID09PSAwICYmIGkgPCBhLmxlbmd0aCAmJiBhICE9PSB0aGlzKSB7CgkJCSAgICAgIGZvciAoOyBpIDwgYS5sZW5ndGg7IGkrKykgewoJCQkgICAgICAgIHRoaXMud29yZHNbaV0gPSBhLndvcmRzW2ldOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgdGhpcy5sZW5ndGggPSBNYXRoLm1heCh0aGlzLmxlbmd0aCwgaSk7CgoJCQkgICAgaWYgKGEgIT09IHRoaXMpIHsKCQkJICAgICAgdGhpcy5uZWdhdGl2ZSA9IDE7CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHRoaXMuX3N0cmlwKCk7CgkJCSAgfTsKCgkJCSAgLy8gU3VidHJhY3QgYG51bWAgZnJvbSBgdGhpc2AKCQkJICBCTi5wcm90b3R5cGUuc3ViID0gZnVuY3Rpb24gc3ViIChudW0pIHsKCQkJICAgIHJldHVybiB0aGlzLmNsb25lKCkuaXN1YihudW0pOwoJCQkgIH07CgoJCQkgIGZ1bmN0aW9uIHNtYWxsTXVsVG8gKHNlbGYsIG51bSwgb3V0KSB7CgkJCSAgICBvdXQubmVnYXRpdmUgPSBudW0ubmVnYXRpdmUgXiBzZWxmLm5lZ2F0aXZlOwoJCQkgICAgdmFyIGxlbiA9IChzZWxmLmxlbmd0aCArIG51bS5sZW5ndGgpIHwgMDsKCQkJICAgIG91dC5sZW5ndGggPSBsZW47CgkJCSAgICBsZW4gPSAobGVuIC0gMSkgfCAwOwoKCQkJICAgIC8vIFBlZWwgb25lIGl0ZXJhdGlvbiAoY29tcGlsZXIgY2FuJ3QgZG8gaXQsIGJlY2F1c2Ugb2YgY29kZSBjb21wbGV4aXR5KQoJCQkgICAgdmFyIGEgPSBzZWxmLndvcmRzWzBdIHwgMDsKCQkJICAgIHZhciBiID0gbnVtLndvcmRzWzBdIHwgMDsKCQkJICAgIHZhciByID0gYSAqIGI7CgoJCQkgICAgdmFyIGxvID0gciAmIDB4M2ZmZmZmZjsKCQkJICAgIHZhciBjYXJyeSA9IChyIC8gMHg0MDAwMDAwKSB8IDA7CgkJCSAgICBvdXQud29yZHNbMF0gPSBsbzsKCgkJCSAgICBmb3IgKHZhciBrID0gMTsgayA8IGxlbjsgaysrKSB7CgkJCSAgICAgIC8vIFN1bSBhbGwgd29yZHMgd2l0aCB0aGUgc2FtZSBgaSArIGogPSBrYCBhbmQgYWNjdW11bGF0ZSBgbmNhcnJ5YCwKCQkJICAgICAgLy8gbm90ZSB0aGF0IG5jYXJyeSBjb3VsZCBiZSA+PSAweDNmZmZmZmYKCQkJICAgICAgdmFyIG5jYXJyeSA9IGNhcnJ5ID4+PiAyNjsKCQkJICAgICAgdmFyIHJ3b3JkID0gY2FycnkgJiAweDNmZmZmZmY7CgkJCSAgICAgIHZhciBtYXhKID0gTWF0aC5taW4oaywgbnVtLmxlbmd0aCAtIDEpOwoJCQkgICAgICBmb3IgKHZhciBqID0gTWF0aC5tYXgoMCwgayAtIHNlbGYubGVuZ3RoICsgMSk7IGogPD0gbWF4SjsgaisrKSB7CgkJCSAgICAgICAgdmFyIGkgPSAoayAtIGopIHwgMDsKCQkJICAgICAgICBhID0gc2VsZi53b3Jkc1tpXSB8IDA7CgkJCSAgICAgICAgYiA9IG51bS53b3Jkc1tqXSB8IDA7CgkJCSAgICAgICAgciA9IGEgKiBiICsgcndvcmQ7CgkJCSAgICAgICAgbmNhcnJ5ICs9IChyIC8gMHg0MDAwMDAwKSB8IDA7CgkJCSAgICAgICAgcndvcmQgPSByICYgMHgzZmZmZmZmOwoJCQkgICAgICB9CgkJCSAgICAgIG91dC53b3Jkc1trXSA9IHJ3b3JkIHwgMDsKCQkJICAgICAgY2FycnkgPSBuY2FycnkgfCAwOwoJCQkgICAgfQoJCQkgICAgaWYgKGNhcnJ5ICE9PSAwKSB7CgkJCSAgICAgIG91dC53b3Jkc1trXSA9IGNhcnJ5IHwgMDsKCQkJICAgIH0gZWxzZSB7CgkJCSAgICAgIG91dC5sZW5ndGgtLTsKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gb3V0Ll9zdHJpcCgpOwoJCQkgIH0KCgkJCSAgLy8gVE9ETyhpbmR1dG55KTogaXQgbWF5IGJlIHJlYXNvbmFibGUgdG8gb21pdCBpdCBmb3IgdXNlcnMgd2hvIGRvbid0IG5lZWQKCQkJICAvLyB0byB3b3JrIHdpdGggMjU2LWJpdCBudW1iZXJzLCBvdGhlcndpc2UgaXQgZ2l2ZXMgMjAlIGltcHJvdmVtZW50IGZvciAyNTYtYml0CgkJCSAgLy8gbXVsdGlwbGljYXRpb24gKGxpa2UgZWxsaXB0aWMgc2VjcDI1NmsxKS4KCQkJICB2YXIgY29tYjEwTXVsVG8gPSBmdW5jdGlvbiBjb21iMTBNdWxUbyAoc2VsZiwgbnVtLCBvdXQpIHsKCQkJICAgIHZhciBhID0gc2VsZi53b3JkczsKCQkJICAgIHZhciBiID0gbnVtLndvcmRzOwoJCQkgICAgdmFyIG8gPSBvdXQud29yZHM7CgkJCSAgICB2YXIgYyA9IDA7CgkJCSAgICB2YXIgbG87CgkJCSAgICB2YXIgbWlkOwoJCQkgICAgdmFyIGhpOwoJCQkgICAgdmFyIGEwID0gYVswXSB8IDA7CgkJCSAgICB2YXIgYWwwID0gYTAgJiAweDFmZmY7CgkJCSAgICB2YXIgYWgwID0gYTAgPj4+IDEzOwoJCQkgICAgdmFyIGExID0gYVsxXSB8IDA7CgkJCSAgICB2YXIgYWwxID0gYTEgJiAweDFmZmY7CgkJCSAgICB2YXIgYWgxID0gYTEgPj4+IDEzOwoJCQkgICAgdmFyIGEyID0gYVsyXSB8IDA7CgkJCSAgICB2YXIgYWwyID0gYTIgJiAweDFmZmY7CgkJCSAgICB2YXIgYWgyID0gYTIgPj4+IDEzOwoJCQkgICAgdmFyIGEzID0gYVszXSB8IDA7CgkJCSAgICB2YXIgYWwzID0gYTMgJiAweDFmZmY7CgkJCSAgICB2YXIgYWgzID0gYTMgPj4+IDEzOwoJCQkgICAgdmFyIGE0ID0gYVs0XSB8IDA7CgkJCSAgICB2YXIgYWw0ID0gYTQgJiAweDFmZmY7CgkJCSAgICB2YXIgYWg0ID0gYTQgPj4+IDEzOwoJCQkgICAgdmFyIGE1ID0gYVs1XSB8IDA7CgkJCSAgICB2YXIgYWw1ID0gYTUgJiAweDFmZmY7CgkJCSAgICB2YXIgYWg1ID0gYTUgPj4+IDEzOwoJCQkgICAgdmFyIGE2ID0gYVs2XSB8IDA7CgkJCSAgICB2YXIgYWw2ID0gYTYgJiAweDFmZmY7CgkJCSAgICB2YXIgYWg2ID0gYTYgPj4+IDEzOwoJCQkgICAgdmFyIGE3ID0gYVs3XSB8IDA7CgkJCSAgICB2YXIgYWw3ID0gYTcgJiAweDFmZmY7CgkJCSAgICB2YXIgYWg3ID0gYTcgPj4+IDEzOwoJCQkgICAgdmFyIGE4ID0gYVs4XSB8IDA7CgkJCSAgICB2YXIgYWw4ID0gYTggJiAweDFmZmY7CgkJCSAgICB2YXIgYWg4ID0gYTggPj4+IDEzOwoJCQkgICAgdmFyIGE5ID0gYVs5XSB8IDA7CgkJCSAgICB2YXIgYWw5ID0gYTkgJiAweDFmZmY7CgkJCSAgICB2YXIgYWg5ID0gYTkgPj4+IDEzOwoJCQkgICAgdmFyIGIwID0gYlswXSB8IDA7CgkJCSAgICB2YXIgYmwwID0gYjAgJiAweDFmZmY7CgkJCSAgICB2YXIgYmgwID0gYjAgPj4+IDEzOwoJCQkgICAgdmFyIGIxID0gYlsxXSB8IDA7CgkJCSAgICB2YXIgYmwxID0gYjEgJiAweDFmZmY7CgkJCSAgICB2YXIgYmgxID0gYjEgPj4+IDEzOwoJCQkgICAgdmFyIGIyID0gYlsyXSB8IDA7CgkJCSAgICB2YXIgYmwyID0gYjIgJiAweDFmZmY7CgkJCSAgICB2YXIgYmgyID0gYjIgPj4+IDEzOwoJCQkgICAgdmFyIGIzID0gYlszXSB8IDA7CgkJCSAgICB2YXIgYmwzID0gYjMgJiAweDFmZmY7CgkJCSAgICB2YXIgYmgzID0gYjMgPj4+IDEzOwoJCQkgICAgdmFyIGI0ID0gYls0XSB8IDA7CgkJCSAgICB2YXIgYmw0ID0gYjQgJiAweDFmZmY7CgkJCSAgICB2YXIgYmg0ID0gYjQgPj4+IDEzOwoJCQkgICAgdmFyIGI1ID0gYls1XSB8IDA7CgkJCSAgICB2YXIgYmw1ID0gYjUgJiAweDFmZmY7CgkJCSAgICB2YXIgYmg1ID0gYjUgPj4+IDEzOwoJCQkgICAgdmFyIGI2ID0gYls2XSB8IDA7CgkJCSAgICB2YXIgYmw2ID0gYjYgJiAweDFmZmY7CgkJCSAgICB2YXIgYmg2ID0gYjYgPj4+IDEzOwoJCQkgICAgdmFyIGI3ID0gYls3XSB8IDA7CgkJCSAgICB2YXIgYmw3ID0gYjcgJiAweDFmZmY7CgkJCSAgICB2YXIgYmg3ID0gYjcgPj4+IDEzOwoJCQkgICAgdmFyIGI4ID0gYls4XSB8IDA7CgkJCSAgICB2YXIgYmw4ID0gYjggJiAweDFmZmY7CgkJCSAgICB2YXIgYmg4ID0gYjggPj4+IDEzOwoJCQkgICAgdmFyIGI5ID0gYls5XSB8IDA7CgkJCSAgICB2YXIgYmw5ID0gYjkgJiAweDFmZmY7CgkJCSAgICB2YXIgYmg5ID0gYjkgPj4+IDEzOwoKCQkJICAgIG91dC5uZWdhdGl2ZSA9IHNlbGYubmVnYXRpdmUgXiBudW0ubmVnYXRpdmU7CgkJCSAgICBvdXQubGVuZ3RoID0gMTk7CgkJCSAgICAvKiBrID0gMCAqLwoJCQkgICAgbG8gPSBNYXRoLmltdWwoYWwwLCBibDApOwoJCQkgICAgbWlkID0gTWF0aC5pbXVsKGFsMCwgYmgwKTsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgwLCBibDApKSB8IDA7CgkJCSAgICBoaSA9IE1hdGguaW11bChhaDAsIGJoMCk7CgkJCSAgICB2YXIgdzAgPSAoKChjICsgbG8pIHwgMCkgKyAoKG1pZCAmIDB4MWZmZikgPDwgMTMpKSB8IDA7CgkJCSAgICBjID0gKCgoaGkgKyAobWlkID4+PiAxMykpIHwgMCkgKyAodzAgPj4+IDI2KSkgfCAwOwoJCQkgICAgdzAgJj0gMHgzZmZmZmZmOwoJCQkgICAgLyogayA9IDEgKi8KCQkJICAgIGxvID0gTWF0aC5pbXVsKGFsMSwgYmwwKTsKCQkJICAgIG1pZCA9IE1hdGguaW11bChhbDEsIGJoMCk7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMSwgYmwwKSkgfCAwOwoJCQkgICAgaGkgPSBNYXRoLmltdWwoYWgxLCBiaDApOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwwLCBibDEpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMCwgYmgxKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDAsIGJsMSkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMCwgYmgxKSkgfCAwOwoJCQkgICAgdmFyIHcxID0gKCgoYyArIGxvKSB8IDApICsgKChtaWQgJiAweDFmZmYpIDw8IDEzKSkgfCAwOwoJCQkgICAgYyA9ICgoKGhpICsgKG1pZCA+Pj4gMTMpKSB8IDApICsgKHcxID4+PiAyNikpIHwgMDsKCQkJICAgIHcxICY9IDB4M2ZmZmZmZjsKCQkJICAgIC8qIGsgPSAyICovCgkJCSAgICBsbyA9IE1hdGguaW11bChhbDIsIGJsMCk7CgkJCSAgICBtaWQgPSBNYXRoLmltdWwoYWwyLCBiaDApOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDIsIGJsMCkpIHwgMDsKCQkJICAgIGhpID0gTWF0aC5pbXVsKGFoMiwgYmgwKTsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMSwgYmwxKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDEsIGJoMSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgxLCBibDEpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDEsIGJoMSkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMCwgYmwyKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDAsIGJoMikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgwLCBibDIpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDAsIGJoMikpIHwgMDsKCQkJICAgIHZhciB3MiA9ICgoKGMgKyBsbykgfCAwKSArICgobWlkICYgMHgxZmZmKSA8PCAxMykpIHwgMDsKCQkJICAgIGMgPSAoKChoaSArIChtaWQgPj4+IDEzKSkgfCAwKSArICh3MiA+Pj4gMjYpKSB8IDA7CgkJCSAgICB3MiAmPSAweDNmZmZmZmY7CgkJCSAgICAvKiBrID0gMyAqLwoJCQkgICAgbG8gPSBNYXRoLmltdWwoYWwzLCBibDApOwoJCQkgICAgbWlkID0gTWF0aC5pbXVsKGFsMywgYmgwKTsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgzLCBibDApKSB8IDA7CgkJCSAgICBoaSA9IE1hdGguaW11bChhaDMsIGJoMCk7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDIsIGJsMSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwyLCBiaDEpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMiwgYmwxKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgyLCBiaDEpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDEsIGJsMikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwxLCBiaDIpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMSwgYmwyKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgxLCBiaDIpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDAsIGJsMykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwwLCBiaDMpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMCwgYmwzKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgwLCBiaDMpKSB8IDA7CgkJCSAgICB2YXIgdzMgPSAoKChjICsgbG8pIHwgMCkgKyAoKG1pZCAmIDB4MWZmZikgPDwgMTMpKSB8IDA7CgkJCSAgICBjID0gKCgoaGkgKyAobWlkID4+PiAxMykpIHwgMCkgKyAodzMgPj4+IDI2KSkgfCAwOwoJCQkgICAgdzMgJj0gMHgzZmZmZmZmOwoJCQkgICAgLyogayA9IDQgKi8KCQkJICAgIGxvID0gTWF0aC5pbXVsKGFsNCwgYmwwKTsKCQkJICAgIG1pZCA9IE1hdGguaW11bChhbDQsIGJoMCk7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNCwgYmwwKSkgfCAwOwoJCQkgICAgaGkgPSBNYXRoLmltdWwoYWg0LCBiaDApOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwzLCBibDEpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMywgYmgxKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDMsIGJsMSkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMywgYmgxKSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwyLCBibDIpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMiwgYmgyKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDIsIGJsMikpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMiwgYmgyKSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwxLCBibDMpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMSwgYmgzKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDEsIGJsMykpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMSwgYmgzKSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwwLCBibDQpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMCwgYmg0KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDAsIGJsNCkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMCwgYmg0KSkgfCAwOwoJCQkgICAgdmFyIHc0ID0gKCgoYyArIGxvKSB8IDApICsgKChtaWQgJiAweDFmZmYpIDw8IDEzKSkgfCAwOwoJCQkgICAgYyA9ICgoKGhpICsgKG1pZCA+Pj4gMTMpKSB8IDApICsgKHc0ID4+PiAyNikpIHwgMDsKCQkJICAgIHc0ICY9IDB4M2ZmZmZmZjsKCQkJICAgIC8qIGsgPSA1ICovCgkJCSAgICBsbyA9IE1hdGguaW11bChhbDUsIGJsMCk7CgkJCSAgICBtaWQgPSBNYXRoLmltdWwoYWw1LCBiaDApOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDUsIGJsMCkpIHwgMDsKCQkJICAgIGhpID0gTWF0aC5pbXVsKGFoNSwgYmgwKTsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNCwgYmwxKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDQsIGJoMSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg0LCBibDEpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDQsIGJoMSkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMywgYmwyKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDMsIGJoMikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgzLCBibDIpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDMsIGJoMikpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMiwgYmwzKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDIsIGJoMykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgyLCBibDMpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDIsIGJoMykpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMSwgYmw0KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDEsIGJoNCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgxLCBibDQpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDEsIGJoNCkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMCwgYmw1KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDAsIGJoNSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgwLCBibDUpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDAsIGJoNSkpIHwgMDsKCQkJICAgIHZhciB3NSA9ICgoKGMgKyBsbykgfCAwKSArICgobWlkICYgMHgxZmZmKSA8PCAxMykpIHwgMDsKCQkJICAgIGMgPSAoKChoaSArIChtaWQgPj4+IDEzKSkgfCAwKSArICh3NSA+Pj4gMjYpKSB8IDA7CgkJCSAgICB3NSAmPSAweDNmZmZmZmY7CgkJCSAgICAvKiBrID0gNiAqLwoJCQkgICAgbG8gPSBNYXRoLmltdWwoYWw2LCBibDApOwoJCQkgICAgbWlkID0gTWF0aC5pbXVsKGFsNiwgYmgwKTsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg2LCBibDApKSB8IDA7CgkJCSAgICBoaSA9IE1hdGguaW11bChhaDYsIGJoMCk7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDUsIGJsMSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw1LCBiaDEpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNSwgYmwxKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg1LCBiaDEpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDQsIGJsMikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw0LCBiaDIpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNCwgYmwyKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg0LCBiaDIpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDMsIGJsMykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwzLCBiaDMpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMywgYmwzKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgzLCBiaDMpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDIsIGJsNCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwyLCBiaDQpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMiwgYmw0KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgyLCBiaDQpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDEsIGJsNSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwxLCBiaDUpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMSwgYmw1KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgxLCBiaDUpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDAsIGJsNikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwwLCBiaDYpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMCwgYmw2KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgwLCBiaDYpKSB8IDA7CgkJCSAgICB2YXIgdzYgPSAoKChjICsgbG8pIHwgMCkgKyAoKG1pZCAmIDB4MWZmZikgPDwgMTMpKSB8IDA7CgkJCSAgICBjID0gKCgoaGkgKyAobWlkID4+PiAxMykpIHwgMCkgKyAodzYgPj4+IDI2KSkgfCAwOwoJCQkgICAgdzYgJj0gMHgzZmZmZmZmOwoJCQkgICAgLyogayA9IDcgKi8KCQkJICAgIGxvID0gTWF0aC5pbXVsKGFsNywgYmwwKTsKCQkJICAgIG1pZCA9IE1hdGguaW11bChhbDcsIGJoMCk7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNywgYmwwKSkgfCAwOwoJCQkgICAgaGkgPSBNYXRoLmltdWwoYWg3LCBiaDApOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw2LCBibDEpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNiwgYmgxKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDYsIGJsMSkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNiwgYmgxKSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw1LCBibDIpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNSwgYmgyKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDUsIGJsMikpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNSwgYmgyKSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw0LCBibDMpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNCwgYmgzKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDQsIGJsMykpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNCwgYmgzKSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwzLCBibDQpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMywgYmg0KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDMsIGJsNCkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMywgYmg0KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwyLCBibDUpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMiwgYmg1KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDIsIGJsNSkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMiwgYmg1KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwxLCBibDYpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMSwgYmg2KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDEsIGJsNikpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMSwgYmg2KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwwLCBibDcpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMCwgYmg3KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDAsIGJsNykpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMCwgYmg3KSkgfCAwOwoJCQkgICAgdmFyIHc3ID0gKCgoYyArIGxvKSB8IDApICsgKChtaWQgJiAweDFmZmYpIDw8IDEzKSkgfCAwOwoJCQkgICAgYyA9ICgoKGhpICsgKG1pZCA+Pj4gMTMpKSB8IDApICsgKHc3ID4+PiAyNikpIHwgMDsKCQkJICAgIHc3ICY9IDB4M2ZmZmZmZjsKCQkJICAgIC8qIGsgPSA4ICovCgkJCSAgICBsbyA9IE1hdGguaW11bChhbDgsIGJsMCk7CgkJCSAgICBtaWQgPSBNYXRoLmltdWwoYWw4LCBiaDApOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDgsIGJsMCkpIHwgMDsKCQkJICAgIGhpID0gTWF0aC5pbXVsKGFoOCwgYmgwKTsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNywgYmwxKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDcsIGJoMSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg3LCBibDEpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDcsIGJoMSkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNiwgYmwyKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDYsIGJoMikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg2LCBibDIpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDYsIGJoMikpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNSwgYmwzKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDUsIGJoMykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg1LCBibDMpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDUsIGJoMykpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNCwgYmw0KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDQsIGJoNCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg0LCBibDQpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDQsIGJoNCkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMywgYmw1KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDMsIGJoNSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgzLCBibDUpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDMsIGJoNSkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMiwgYmw2KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDIsIGJoNikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgyLCBibDYpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDIsIGJoNikpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMSwgYmw3KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDEsIGJoNykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgxLCBibDcpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDEsIGJoNykpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMCwgYmw4KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDAsIGJoOCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgwLCBibDgpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDAsIGJoOCkpIHwgMDsKCQkJICAgIHZhciB3OCA9ICgoKGMgKyBsbykgfCAwKSArICgobWlkICYgMHgxZmZmKSA8PCAxMykpIHwgMDsKCQkJICAgIGMgPSAoKChoaSArIChtaWQgPj4+IDEzKSkgfCAwKSArICh3OCA+Pj4gMjYpKSB8IDA7CgkJCSAgICB3OCAmPSAweDNmZmZmZmY7CgkJCSAgICAvKiBrID0gOSAqLwoJCQkgICAgbG8gPSBNYXRoLmltdWwoYWw5LCBibDApOwoJCQkgICAgbWlkID0gTWF0aC5pbXVsKGFsOSwgYmgwKTsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg5LCBibDApKSB8IDA7CgkJCSAgICBoaSA9IE1hdGguaW11bChhaDksIGJoMCk7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDgsIGJsMSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw4LCBiaDEpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoOCwgYmwxKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg4LCBiaDEpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDcsIGJsMikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw3LCBiaDIpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNywgYmwyKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg3LCBiaDIpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDYsIGJsMykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw2LCBiaDMpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNiwgYmwzKSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg2LCBiaDMpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDUsIGJsNCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw1LCBiaDQpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNSwgYmw0KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg1LCBiaDQpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDQsIGJsNSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw0LCBiaDUpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNCwgYmw1KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg0LCBiaDUpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDMsIGJsNikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwzLCBiaDYpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMywgYmw2KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgzLCBiaDYpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDIsIGJsNykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwyLCBiaDcpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMiwgYmw3KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgyLCBiaDcpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDEsIGJsOCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwxLCBiaDgpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMSwgYmw4KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgxLCBiaDgpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDAsIGJsOSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwwLCBiaDkpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMCwgYmw5KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgwLCBiaDkpKSB8IDA7CgkJCSAgICB2YXIgdzkgPSAoKChjICsgbG8pIHwgMCkgKyAoKG1pZCAmIDB4MWZmZikgPDwgMTMpKSB8IDA7CgkJCSAgICBjID0gKCgoaGkgKyAobWlkID4+PiAxMykpIHwgMCkgKyAodzkgPj4+IDI2KSkgfCAwOwoJCQkgICAgdzkgJj0gMHgzZmZmZmZmOwoJCQkgICAgLyogayA9IDEwICovCgkJCSAgICBsbyA9IE1hdGguaW11bChhbDksIGJsMSk7CgkJCSAgICBtaWQgPSBNYXRoLmltdWwoYWw5LCBiaDEpOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDksIGJsMSkpIHwgMDsKCQkJICAgIGhpID0gTWF0aC5pbXVsKGFoOSwgYmgxKTsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsOCwgYmwyKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDgsIGJoMikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg4LCBibDIpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDgsIGJoMikpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNywgYmwzKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDcsIGJoMykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg3LCBibDMpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDcsIGJoMykpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNiwgYmw0KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDYsIGJoNCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg2LCBibDQpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDYsIGJoNCkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNSwgYmw1KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDUsIGJoNSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg1LCBibDUpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDUsIGJoNSkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNCwgYmw2KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDQsIGJoNikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg0LCBibDYpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDQsIGJoNikpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMywgYmw3KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDMsIGJoNykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgzLCBibDcpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDMsIGJoNykpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMiwgYmw4KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDIsIGJoOCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgyLCBibDgpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDIsIGJoOCkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsMSwgYmw5KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDEsIGJoOSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWgxLCBibDkpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDEsIGJoOSkpIHwgMDsKCQkJICAgIHZhciB3MTAgPSAoKChjICsgbG8pIHwgMCkgKyAoKG1pZCAmIDB4MWZmZikgPDwgMTMpKSB8IDA7CgkJCSAgICBjID0gKCgoaGkgKyAobWlkID4+PiAxMykpIHwgMCkgKyAodzEwID4+PiAyNikpIHwgMDsKCQkJICAgIHcxMCAmPSAweDNmZmZmZmY7CgkJCSAgICAvKiBrID0gMTEgKi8KCQkJICAgIGxvID0gTWF0aC5pbXVsKGFsOSwgYmwyKTsKCQkJICAgIG1pZCA9IE1hdGguaW11bChhbDksIGJoMik7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoOSwgYmwyKSkgfCAwOwoJCQkgICAgaGkgPSBNYXRoLmltdWwoYWg5LCBiaDIpOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw4LCBibDMpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsOCwgYmgzKSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDgsIGJsMykpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoOCwgYmgzKSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw3LCBibDQpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNywgYmg0KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDcsIGJsNCkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNywgYmg0KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw2LCBibDUpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNiwgYmg1KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDYsIGJsNSkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNiwgYmg1KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw1LCBibDYpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNSwgYmg2KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDUsIGJsNikpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNSwgYmg2KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw0LCBibDcpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNCwgYmg3KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDQsIGJsNykpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNCwgYmg3KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwzLCBibDgpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMywgYmg4KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDMsIGJsOCkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMywgYmg4KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWwyLCBibDkpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsMiwgYmg5KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDIsIGJsOSkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoMiwgYmg5KSkgfCAwOwoJCQkgICAgdmFyIHcxMSA9ICgoKGMgKyBsbykgfCAwKSArICgobWlkICYgMHgxZmZmKSA8PCAxMykpIHwgMDsKCQkJICAgIGMgPSAoKChoaSArIChtaWQgPj4+IDEzKSkgfCAwKSArICh3MTEgPj4+IDI2KSkgfCAwOwoJCQkgICAgdzExICY9IDB4M2ZmZmZmZjsKCQkJICAgIC8qIGsgPSAxMiAqLwoJCQkgICAgbG8gPSBNYXRoLmltdWwoYWw5LCBibDMpOwoJCQkgICAgbWlkID0gTWF0aC5pbXVsKGFsOSwgYmgzKTsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg5LCBibDMpKSB8IDA7CgkJCSAgICBoaSA9IE1hdGguaW11bChhaDksIGJoMyk7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDgsIGJsNCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw4LCBiaDQpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoOCwgYmw0KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg4LCBiaDQpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDcsIGJsNSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw3LCBiaDUpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNywgYmw1KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg3LCBiaDUpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDYsIGJsNikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw2LCBiaDYpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNiwgYmw2KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg2LCBiaDYpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDUsIGJsNykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw1LCBiaDcpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNSwgYmw3KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg1LCBiaDcpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDQsIGJsOCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw0LCBiaDgpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNCwgYmw4KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg0LCBiaDgpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDMsIGJsOSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWwzLCBiaDkpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoMywgYmw5KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWgzLCBiaDkpKSB8IDA7CgkJCSAgICB2YXIgdzEyID0gKCgoYyArIGxvKSB8IDApICsgKChtaWQgJiAweDFmZmYpIDw8IDEzKSkgfCAwOwoJCQkgICAgYyA9ICgoKGhpICsgKG1pZCA+Pj4gMTMpKSB8IDApICsgKHcxMiA+Pj4gMjYpKSB8IDA7CgkJCSAgICB3MTIgJj0gMHgzZmZmZmZmOwoJCQkgICAgLyogayA9IDEzICovCgkJCSAgICBsbyA9IE1hdGguaW11bChhbDksIGJsNCk7CgkJCSAgICBtaWQgPSBNYXRoLmltdWwoYWw5LCBiaDQpOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDksIGJsNCkpIHwgMDsKCQkJICAgIGhpID0gTWF0aC5pbXVsKGFoOSwgYmg0KTsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsOCwgYmw1KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDgsIGJoNSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg4LCBibDUpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDgsIGJoNSkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNywgYmw2KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDcsIGJoNikpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg3LCBibDYpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDcsIGJoNikpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNiwgYmw3KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDYsIGJoNykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg2LCBibDcpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDYsIGJoNykpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNSwgYmw4KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDUsIGJoOCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg1LCBibDgpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDUsIGJoOCkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNCwgYmw5KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDQsIGJoOSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg0LCBibDkpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDQsIGJoOSkpIHwgMDsKCQkJICAgIHZhciB3MTMgPSAoKChjICsgbG8pIHwgMCkgKyAoKG1pZCAmIDB4MWZmZikgPDwgMTMpKSB8IDA7CgkJCSAgICBjID0gKCgoaGkgKyAobWlkID4+PiAxMykpIHwgMCkgKyAodzEzID4+PiAyNikpIHwgMDsKCQkJICAgIHcxMyAmPSAweDNmZmZmZmY7CgkJCSAgICAvKiBrID0gMTQgKi8KCQkJICAgIGxvID0gTWF0aC5pbXVsKGFsOSwgYmw1KTsKCQkJICAgIG1pZCA9IE1hdGguaW11bChhbDksIGJoNSk7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoOSwgYmw1KSkgfCAwOwoJCQkgICAgaGkgPSBNYXRoLmltdWwoYWg5LCBiaDUpOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw4LCBibDYpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsOCwgYmg2KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDgsIGJsNikpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoOCwgYmg2KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw3LCBibDcpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNywgYmg3KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDcsIGJsNykpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNywgYmg3KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw2LCBibDgpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNiwgYmg4KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDYsIGJsOCkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNiwgYmg4KSkgfCAwOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw1LCBibDkpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsNSwgYmg5KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDUsIGJsOSkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoNSwgYmg5KSkgfCAwOwoJCQkgICAgdmFyIHcxNCA9ICgoKGMgKyBsbykgfCAwKSArICgobWlkICYgMHgxZmZmKSA8PCAxMykpIHwgMDsKCQkJICAgIGMgPSAoKChoaSArIChtaWQgPj4+IDEzKSkgfCAwKSArICh3MTQgPj4+IDI2KSkgfCAwOwoJCQkgICAgdzE0ICY9IDB4M2ZmZmZmZjsKCQkJICAgIC8qIGsgPSAxNSAqLwoJCQkgICAgbG8gPSBNYXRoLmltdWwoYWw5LCBibDYpOwoJCQkgICAgbWlkID0gTWF0aC5pbXVsKGFsOSwgYmg2KTsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg5LCBibDYpKSB8IDA7CgkJCSAgICBoaSA9IE1hdGguaW11bChhaDksIGJoNik7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDgsIGJsNykpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw4LCBiaDcpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoOCwgYmw3KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg4LCBiaDcpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDcsIGJsOCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw3LCBiaDgpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNywgYmw4KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg3LCBiaDgpKSB8IDA7CgkJCSAgICBsbyA9IChsbyArIE1hdGguaW11bChhbDYsIGJsOSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWw2LCBiaDkpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoNiwgYmw5KSkgfCAwOwoJCQkgICAgaGkgPSAoaGkgKyBNYXRoLmltdWwoYWg2LCBiaDkpKSB8IDA7CgkJCSAgICB2YXIgdzE1ID0gKCgoYyArIGxvKSB8IDApICsgKChtaWQgJiAweDFmZmYpIDw8IDEzKSkgfCAwOwoJCQkgICAgYyA9ICgoKGhpICsgKG1pZCA+Pj4gMTMpKSB8IDApICsgKHcxNSA+Pj4gMjYpKSB8IDA7CgkJCSAgICB3MTUgJj0gMHgzZmZmZmZmOwoJCQkgICAgLyogayA9IDE2ICovCgkJCSAgICBsbyA9IE1hdGguaW11bChhbDksIGJsNyk7CgkJCSAgICBtaWQgPSBNYXRoLmltdWwoYWw5LCBiaDcpOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDksIGJsNykpIHwgMDsKCQkJICAgIGhpID0gTWF0aC5pbXVsKGFoOSwgYmg3KTsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsOCwgYmw4KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDgsIGJoOCkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg4LCBibDgpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDgsIGJoOCkpIHwgMDsKCQkJICAgIGxvID0gKGxvICsgTWF0aC5pbXVsKGFsNywgYmw5KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhbDcsIGJoOSkpIHwgMDsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg3LCBibDkpKSB8IDA7CgkJCSAgICBoaSA9IChoaSArIE1hdGguaW11bChhaDcsIGJoOSkpIHwgMDsKCQkJICAgIHZhciB3MTYgPSAoKChjICsgbG8pIHwgMCkgKyAoKG1pZCAmIDB4MWZmZikgPDwgMTMpKSB8IDA7CgkJCSAgICBjID0gKCgoaGkgKyAobWlkID4+PiAxMykpIHwgMCkgKyAodzE2ID4+PiAyNikpIHwgMDsKCQkJICAgIHcxNiAmPSAweDNmZmZmZmY7CgkJCSAgICAvKiBrID0gMTcgKi8KCQkJICAgIGxvID0gTWF0aC5pbXVsKGFsOSwgYmw4KTsKCQkJICAgIG1pZCA9IE1hdGguaW11bChhbDksIGJoOCk7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFoOSwgYmw4KSkgfCAwOwoJCQkgICAgaGkgPSBNYXRoLmltdWwoYWg5LCBiaDgpOwoJCQkgICAgbG8gPSAobG8gKyBNYXRoLmltdWwoYWw4LCBibDkpKSB8IDA7CgkJCSAgICBtaWQgPSAobWlkICsgTWF0aC5pbXVsKGFsOCwgYmg5KSkgfCAwOwoJCQkgICAgbWlkID0gKG1pZCArIE1hdGguaW11bChhaDgsIGJsOSkpIHwgMDsKCQkJICAgIGhpID0gKGhpICsgTWF0aC5pbXVsKGFoOCwgYmg5KSkgfCAwOwoJCQkgICAgdmFyIHcxNyA9ICgoKGMgKyBsbykgfCAwKSArICgobWlkICYgMHgxZmZmKSA8PCAxMykpIHwgMDsKCQkJICAgIGMgPSAoKChoaSArIChtaWQgPj4+IDEzKSkgfCAwKSArICh3MTcgPj4+IDI2KSkgfCAwOwoJCQkgICAgdzE3ICY9IDB4M2ZmZmZmZjsKCQkJICAgIC8qIGsgPSAxOCAqLwoJCQkgICAgbG8gPSBNYXRoLmltdWwoYWw5LCBibDkpOwoJCQkgICAgbWlkID0gTWF0aC5pbXVsKGFsOSwgYmg5KTsKCQkJICAgIG1pZCA9IChtaWQgKyBNYXRoLmltdWwoYWg5LCBibDkpKSB8IDA7CgkJCSAgICBoaSA9IE1hdGguaW11bChhaDksIGJoOSk7CgkJCSAgICB2YXIgdzE4ID0gKCgoYyArIGxvKSB8IDApICsgKChtaWQgJiAweDFmZmYpIDw8IDEzKSkgfCAwOwoJCQkgICAgYyA9ICgoKGhpICsgKG1pZCA+Pj4gMTMpKSB8IDApICsgKHcxOCA+Pj4gMjYpKSB8IDA7CgkJCSAgICB3MTggJj0gMHgzZmZmZmZmOwoJCQkgICAgb1swXSA9IHcwOwoJCQkgICAgb1sxXSA9IHcxOwoJCQkgICAgb1syXSA9IHcyOwoJCQkgICAgb1szXSA9IHczOwoJCQkgICAgb1s0XSA9IHc0OwoJCQkgICAgb1s1XSA9IHc1OwoJCQkgICAgb1s2XSA9IHc2OwoJCQkgICAgb1s3XSA9IHc3OwoJCQkgICAgb1s4XSA9IHc4OwoJCQkgICAgb1s5XSA9IHc5OwoJCQkgICAgb1sxMF0gPSB3MTA7CgkJCSAgICBvWzExXSA9IHcxMTsKCQkJICAgIG9bMTJdID0gdzEyOwoJCQkgICAgb1sxM10gPSB3MTM7CgkJCSAgICBvWzE0XSA9IHcxNDsKCQkJICAgIG9bMTVdID0gdzE1OwoJCQkgICAgb1sxNl0gPSB3MTY7CgkJCSAgICBvWzE3XSA9IHcxNzsKCQkJICAgIG9bMThdID0gdzE4OwoJCQkgICAgaWYgKGMgIT09IDApIHsKCQkJICAgICAgb1sxOV0gPSBjOwoJCQkgICAgICBvdXQubGVuZ3RoKys7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gb3V0OwoJCQkgIH07CgoJCQkgIC8vIFBvbHlmaWxsIGNvbWIKCQkJICBpZiAoIU1hdGguaW11bCkgewoJCQkgICAgY29tYjEwTXVsVG8gPSBzbWFsbE11bFRvOwoJCQkgIH0KCgkJCSAgZnVuY3Rpb24gYmlnTXVsVG8gKHNlbGYsIG51bSwgb3V0KSB7CgkJCSAgICBvdXQubmVnYXRpdmUgPSBudW0ubmVnYXRpdmUgXiBzZWxmLm5lZ2F0aXZlOwoJCQkgICAgb3V0Lmxlbmd0aCA9IHNlbGYubGVuZ3RoICsgbnVtLmxlbmd0aDsKCgkJCSAgICB2YXIgY2FycnkgPSAwOwoJCQkgICAgdmFyIGhuY2FycnkgPSAwOwoJCQkgICAgZm9yICh2YXIgayA9IDA7IGsgPCBvdXQubGVuZ3RoIC0gMTsgaysrKSB7CgkJCSAgICAgIC8vIFN1bSBhbGwgd29yZHMgd2l0aCB0aGUgc2FtZSBgaSArIGogPSBrYCBhbmQgYWNjdW11bGF0ZSBgbmNhcnJ5YCwKCQkJICAgICAgLy8gbm90ZSB0aGF0IG5jYXJyeSBjb3VsZCBiZSA+PSAweDNmZmZmZmYKCQkJICAgICAgdmFyIG5jYXJyeSA9IGhuY2Fycnk7CgkJCSAgICAgIGhuY2FycnkgPSAwOwoJCQkgICAgICB2YXIgcndvcmQgPSBjYXJyeSAmIDB4M2ZmZmZmZjsKCQkJICAgICAgdmFyIG1heEogPSBNYXRoLm1pbihrLCBudW0ubGVuZ3RoIC0gMSk7CgkJCSAgICAgIGZvciAodmFyIGogPSBNYXRoLm1heCgwLCBrIC0gc2VsZi5sZW5ndGggKyAxKTsgaiA8PSBtYXhKOyBqKyspIHsKCQkJICAgICAgICB2YXIgaSA9IGsgLSBqOwoJCQkgICAgICAgIHZhciBhID0gc2VsZi53b3Jkc1tpXSB8IDA7CgkJCSAgICAgICAgdmFyIGIgPSBudW0ud29yZHNbal0gfCAwOwoJCQkgICAgICAgIHZhciByID0gYSAqIGI7CgoJCQkgICAgICAgIHZhciBsbyA9IHIgJiAweDNmZmZmZmY7CgkJCSAgICAgICAgbmNhcnJ5ID0gKG5jYXJyeSArICgociAvIDB4NDAwMDAwMCkgfCAwKSkgfCAwOwoJCQkgICAgICAgIGxvID0gKGxvICsgcndvcmQpIHwgMDsKCQkJICAgICAgICByd29yZCA9IGxvICYgMHgzZmZmZmZmOwoJCQkgICAgICAgIG5jYXJyeSA9IChuY2FycnkgKyAobG8gPj4+IDI2KSkgfCAwOwoKCQkJICAgICAgICBobmNhcnJ5ICs9IG5jYXJyeSA+Pj4gMjY7CgkJCSAgICAgICAgbmNhcnJ5ICY9IDB4M2ZmZmZmZjsKCQkJICAgICAgfQoJCQkgICAgICBvdXQud29yZHNba10gPSByd29yZDsKCQkJICAgICAgY2FycnkgPSBuY2Fycnk7CgkJCSAgICAgIG5jYXJyeSA9IGhuY2Fycnk7CgkJCSAgICB9CgkJCSAgICBpZiAoY2FycnkgIT09IDApIHsKCQkJICAgICAgb3V0LndvcmRzW2tdID0gY2Fycnk7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBvdXQubGVuZ3RoLS07CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIG91dC5fc3RyaXAoKTsKCQkJICB9CgoJCQkgIGZ1bmN0aW9uIGp1bWJvTXVsVG8gKHNlbGYsIG51bSwgb3V0KSB7CgkJCSAgICAvLyBUZW1wb3JhcnkgZGlzYWJsZSwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9pbmR1dG55L2JuLmpzL2lzc3Vlcy8yMTEKCQkJICAgIC8vIHZhciBmZnRtID0gbmV3IEZGVE0oKTsKCQkJICAgIC8vIHJldHVybiBmZnRtLm11bHAoc2VsZiwgbnVtLCBvdXQpOwoJCQkgICAgcmV0dXJuIGJpZ011bFRvKHNlbGYsIG51bSwgb3V0KTsKCQkJICB9CgoJCQkgIEJOLnByb3RvdHlwZS5tdWxUbyA9IGZ1bmN0aW9uIG11bFRvIChudW0sIG91dCkgewoJCQkgICAgdmFyIHJlczsKCQkJICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aCArIG51bS5sZW5ndGg7CgkJCSAgICBpZiAodGhpcy5sZW5ndGggPT09IDEwICYmIG51bS5sZW5ndGggPT09IDEwKSB7CgkJCSAgICAgIHJlcyA9IGNvbWIxME11bFRvKHRoaXMsIG51bSwgb3V0KTsKCQkJICAgIH0gZWxzZSBpZiAobGVuIDwgNjMpIHsKCQkJICAgICAgcmVzID0gc21hbGxNdWxUbyh0aGlzLCBudW0sIG91dCk7CgkJCSAgICB9IGVsc2UgaWYgKGxlbiA8IDEwMjQpIHsKCQkJICAgICAgcmVzID0gYmlnTXVsVG8odGhpcywgbnVtLCBvdXQpOwoJCQkgICAgfSBlbHNlIHsKCQkJICAgICAgcmVzID0ganVtYm9NdWxUbyh0aGlzLCBudW0sIG91dCk7CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHJlczsKCQkJICB9OwoKCQkJICAvLyBNdWx0aXBseSBgdGhpc2AgYnkgYG51bWAKCQkJICBCTi5wcm90b3R5cGUubXVsID0gZnVuY3Rpb24gbXVsIChudW0pIHsKCQkJICAgIHZhciBvdXQgPSBuZXcgQk4obnVsbCk7CgkJCSAgICBvdXQud29yZHMgPSBuZXcgQXJyYXkodGhpcy5sZW5ndGggKyBudW0ubGVuZ3RoKTsKCQkJICAgIHJldHVybiB0aGlzLm11bFRvKG51bSwgb3V0KTsKCQkJICB9OwoKCQkJICAvLyBNdWx0aXBseSBlbXBsb3lpbmcgRkZUCgkJCSAgQk4ucHJvdG90eXBlLm11bGYgPSBmdW5jdGlvbiBtdWxmIChudW0pIHsKCQkJICAgIHZhciBvdXQgPSBuZXcgQk4obnVsbCk7CgkJCSAgICBvdXQud29yZHMgPSBuZXcgQXJyYXkodGhpcy5sZW5ndGggKyBudW0ubGVuZ3RoKTsKCQkJICAgIHJldHVybiBqdW1ib011bFRvKHRoaXMsIG51bSwgb3V0KTsKCQkJICB9OwoKCQkJICAvLyBJbi1wbGFjZSBNdWx0aXBsaWNhdGlvbgoJCQkgIEJOLnByb3RvdHlwZS5pbXVsID0gZnVuY3Rpb24gaW11bCAobnVtKSB7CgkJCSAgICByZXR1cm4gdGhpcy5jbG9uZSgpLm11bFRvKG51bSwgdGhpcyk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmltdWxuID0gZnVuY3Rpb24gaW11bG4gKG51bSkgewoJCQkgICAgdmFyIGlzTmVnTnVtID0gbnVtIDwgMDsKCQkJICAgIGlmIChpc05lZ051bSkgbnVtID0gLW51bTsKCgkJCSAgICBhc3NlcnQodHlwZW9mIG51bSA9PT0gJ251bWJlcicpOwoJCQkgICAgYXNzZXJ0KG51bSA8IDB4NDAwMDAwMCk7CgoJCQkgICAgLy8gQ2FycnkKCQkJICAgIHZhciBjYXJyeSA9IDA7CgkJCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdmFyIHcgPSAodGhpcy53b3Jkc1tpXSB8IDApICogbnVtOwoJCQkgICAgICB2YXIgbG8gPSAodyAmIDB4M2ZmZmZmZikgKyAoY2FycnkgJiAweDNmZmZmZmYpOwoJCQkgICAgICBjYXJyeSA+Pj0gMjY7CgkJCSAgICAgIGNhcnJ5ICs9ICh3IC8gMHg0MDAwMDAwKSB8IDA7CgkJCSAgICAgIC8vIE5PVEU6IGxvIGlzIDI3Yml0IG1heGltdW0KCQkJICAgICAgY2FycnkgKz0gbG8gPj4+IDI2OwoJCQkgICAgICB0aGlzLndvcmRzW2ldID0gbG8gJiAweDNmZmZmZmY7CgkJCSAgICB9CgoJCQkgICAgaWYgKGNhcnJ5ICE9PSAwKSB7CgkJCSAgICAgIHRoaXMud29yZHNbaV0gPSBjYXJyeTsKCQkJICAgICAgdGhpcy5sZW5ndGgrKzsKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gaXNOZWdOdW0gPyB0aGlzLmluZWcoKSA6IHRoaXM7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLm11bG4gPSBmdW5jdGlvbiBtdWxuIChudW0pIHsKCQkJICAgIHJldHVybiB0aGlzLmNsb25lKCkuaW11bG4obnVtKTsKCQkJICB9OwoKCQkJICAvLyBgdGhpc2AgKiBgdGhpc2AKCQkJICBCTi5wcm90b3R5cGUuc3FyID0gZnVuY3Rpb24gc3FyICgpIHsKCQkJICAgIHJldHVybiB0aGlzLm11bCh0aGlzKTsKCQkJICB9OwoKCQkJICAvLyBgdGhpc2AgKiBgdGhpc2AgaW4tcGxhY2UKCQkJICBCTi5wcm90b3R5cGUuaXNxciA9IGZ1bmN0aW9uIGlzcXIgKCkgewoJCQkgICAgcmV0dXJuIHRoaXMuaW11bCh0aGlzLmNsb25lKCkpOwoJCQkgIH07CgoJCQkgIC8vIE1hdGgucG93KGB0aGlzYCwgYG51bWApCgkJCSAgQk4ucHJvdG90eXBlLnBvdyA9IGZ1bmN0aW9uIHBvdyAobnVtKSB7CgkJCSAgICB2YXIgdyA9IHRvQml0QXJyYXkobnVtKTsKCQkJICAgIGlmICh3Lmxlbmd0aCA9PT0gMCkgcmV0dXJuIG5ldyBCTigxKTsKCgkJCSAgICAvLyBTa2lwIGxlYWRpbmcgemVyb2VzCgkJCSAgICB2YXIgcmVzID0gdGhpczsKCQkJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdy5sZW5ndGg7IGkrKywgcmVzID0gcmVzLnNxcigpKSB7CgkJCSAgICAgIGlmICh3W2ldICE9PSAwKSBicmVhazsKCQkJICAgIH0KCgkJCSAgICBpZiAoKytpIDwgdy5sZW5ndGgpIHsKCQkJICAgICAgZm9yICh2YXIgcSA9IHJlcy5zcXIoKTsgaSA8IHcubGVuZ3RoOyBpKyssIHEgPSBxLnNxcigpKSB7CgkJCSAgICAgICAgaWYgKHdbaV0gPT09IDApIGNvbnRpbnVlOwoKCQkJICAgICAgICByZXMgPSByZXMubXVsKHEpOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHJlczsKCQkJICB9OwoKCQkJICAvLyBTaGlmdC1sZWZ0IGluLXBsYWNlCgkJCSAgQk4ucHJvdG90eXBlLml1c2hsbiA9IGZ1bmN0aW9uIGl1c2hsbiAoYml0cykgewoJCQkgICAgYXNzZXJ0KHR5cGVvZiBiaXRzID09PSAnbnVtYmVyJyAmJiBiaXRzID49IDApOwoJCQkgICAgdmFyIHIgPSBiaXRzICUgMjY7CgkJCSAgICB2YXIgcyA9IChiaXRzIC0gcikgLyAyNjsKCQkJICAgIHZhciBjYXJyeU1hc2sgPSAoMHgzZmZmZmZmID4+PiAoMjYgLSByKSkgPDwgKDI2IC0gcik7CgkJCSAgICB2YXIgaTsKCgkJCSAgICBpZiAociAhPT0gMCkgewoJCQkgICAgICB2YXIgY2FycnkgPSAwOwoKCQkJICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgICB2YXIgbmV3Q2FycnkgPSB0aGlzLndvcmRzW2ldICYgY2FycnlNYXNrOwoJCQkgICAgICAgIHZhciBjID0gKCh0aGlzLndvcmRzW2ldIHwgMCkgLSBuZXdDYXJyeSkgPDwgcjsKCQkJICAgICAgICB0aGlzLndvcmRzW2ldID0gYyB8IGNhcnJ5OwoJCQkgICAgICAgIGNhcnJ5ID0gbmV3Q2FycnkgPj4+ICgyNiAtIHIpOwoJCQkgICAgICB9CgoJCQkgICAgICBpZiAoY2FycnkpIHsKCQkJICAgICAgICB0aGlzLndvcmRzW2ldID0gY2Fycnk7CgkJCSAgICAgICAgdGhpcy5sZW5ndGgrKzsKCQkJICAgICAgfQoJCQkgICAgfQoKCQkJICAgIGlmIChzICE9PSAwKSB7CgkJCSAgICAgIGZvciAoaSA9IHRoaXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJICAgICAgICB0aGlzLndvcmRzW2kgKyBzXSA9IHRoaXMud29yZHNbaV07CgkJCSAgICAgIH0KCgkJCSAgICAgIGZvciAoaSA9IDA7IGkgPCBzOyBpKyspIHsKCQkJICAgICAgICB0aGlzLndvcmRzW2ldID0gMDsKCQkJICAgICAgfQoKCQkJICAgICAgdGhpcy5sZW5ndGggKz0gczsKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gdGhpcy5fc3RyaXAoKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuaXNobG4gPSBmdW5jdGlvbiBpc2hsbiAoYml0cykgewoJCQkgICAgLy8gVE9ETyhpbmR1dG55KTogaW1wbGVtZW50IG1lCgkJCSAgICBhc3NlcnQodGhpcy5uZWdhdGl2ZSA9PT0gMCk7CgkJCSAgICByZXR1cm4gdGhpcy5pdXNobG4oYml0cyk7CgkJCSAgfTsKCgkJCSAgLy8gU2hpZnQtcmlnaHQgaW4tcGxhY2UKCQkJICAvLyBOT1RFOiBgaGludGAgaXMgYSBsb3dlc3QgYml0IGJlZm9yZSB0cmFpbGluZyB6ZXJvZXMKCQkJICAvLyBOT1RFOiBpZiBgZXh0ZW5kZWRgIGlzIHByZXNlbnQgLSBpdCB3aWxsIGJlIGZpbGxlZCB3aXRoIGRlc3Ryb3llZCBiaXRzCgkJCSAgQk4ucHJvdG90eXBlLml1c2hybiA9IGZ1bmN0aW9uIGl1c2hybiAoYml0cywgaGludCwgZXh0ZW5kZWQpIHsKCQkJICAgIGFzc2VydCh0eXBlb2YgYml0cyA9PT0gJ251bWJlcicgJiYgYml0cyA+PSAwKTsKCQkJICAgIHZhciBoOwoJCQkgICAgaWYgKGhpbnQpIHsKCQkJICAgICAgaCA9IChoaW50IC0gKGhpbnQgJSAyNikpIC8gMjY7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBoID0gMDsKCQkJICAgIH0KCgkJCSAgICB2YXIgciA9IGJpdHMgJSAyNjsKCQkJICAgIHZhciBzID0gTWF0aC5taW4oKGJpdHMgLSByKSAvIDI2LCB0aGlzLmxlbmd0aCk7CgkJCSAgICB2YXIgbWFzayA9IDB4M2ZmZmZmZiBeICgoMHgzZmZmZmZmID4+PiByKSA8PCByKTsKCQkJICAgIHZhciBtYXNrZWRXb3JkcyA9IGV4dGVuZGVkOwoKCQkJICAgIGggLT0gczsKCQkJICAgIGggPSBNYXRoLm1heCgwLCBoKTsKCgkJCSAgICAvLyBFeHRlbmRlZCBtb2RlLCBjb3B5IG1hc2tlZCBwYXJ0CgkJCSAgICBpZiAobWFza2VkV29yZHMpIHsKCQkJICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzOyBpKyspIHsKCQkJICAgICAgICBtYXNrZWRXb3Jkcy53b3Jkc1tpXSA9IHRoaXMud29yZHNbaV07CgkJCSAgICAgIH0KCQkJICAgICAgbWFza2VkV29yZHMubGVuZ3RoID0gczsKCQkJICAgIH0KCgkJCSAgICBpZiAocyA9PT0gMCkgOyBlbHNlIGlmICh0aGlzLmxlbmd0aCA+IHMpIHsKCQkJICAgICAgdGhpcy5sZW5ndGggLT0gczsKCQkJICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgICB0aGlzLndvcmRzW2ldID0gdGhpcy53b3Jkc1tpICsgc107CgkJCSAgICAgIH0KCQkJICAgIH0gZWxzZSB7CgkJCSAgICAgIHRoaXMud29yZHNbMF0gPSAwOwoJCQkgICAgICB0aGlzLmxlbmd0aCA9IDE7CgkJCSAgICB9CgoJCQkgICAgdmFyIGNhcnJ5ID0gMDsKCQkJICAgIGZvciAoaSA9IHRoaXMubGVuZ3RoIC0gMTsgaSA+PSAwICYmIChjYXJyeSAhPT0gMCB8fCBpID49IGgpOyBpLS0pIHsKCQkJICAgICAgdmFyIHdvcmQgPSB0aGlzLndvcmRzW2ldIHwgMDsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IChjYXJyeSA8PCAoMjYgLSByKSkgfCAod29yZCA+Pj4gcik7CgkJCSAgICAgIGNhcnJ5ID0gd29yZCAmIG1hc2s7CgkJCSAgICB9CgoJCQkgICAgLy8gUHVzaCBjYXJyaWVkIGJpdHMgYXMgYSBtYXNrCgkJCSAgICBpZiAobWFza2VkV29yZHMgJiYgY2FycnkgIT09IDApIHsKCQkJICAgICAgbWFza2VkV29yZHMud29yZHNbbWFza2VkV29yZHMubGVuZ3RoKytdID0gY2Fycnk7CgkJCSAgICB9CgoJCQkgICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSB7CgkJCSAgICAgIHRoaXMud29yZHNbMF0gPSAwOwoJCQkgICAgICB0aGlzLmxlbmd0aCA9IDE7CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHRoaXMuX3N0cmlwKCk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmlzaHJuID0gZnVuY3Rpb24gaXNocm4gKGJpdHMsIGhpbnQsIGV4dGVuZGVkKSB7CgkJCSAgICAvLyBUT0RPKGluZHV0bnkpOiBpbXBsZW1lbnQgbWUKCQkJICAgIGFzc2VydCh0aGlzLm5lZ2F0aXZlID09PSAwKTsKCQkJICAgIHJldHVybiB0aGlzLml1c2hybihiaXRzLCBoaW50LCBleHRlbmRlZCk7CgkJCSAgfTsKCgkJCSAgLy8gU2hpZnQtbGVmdAoJCQkgIEJOLnByb3RvdHlwZS5zaGxuID0gZnVuY3Rpb24gc2hsbiAoYml0cykgewoJCQkgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5pc2hsbihiaXRzKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUudXNobG4gPSBmdW5jdGlvbiB1c2hsbiAoYml0cykgewoJCQkgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5pdXNobG4oYml0cyk7CgkJCSAgfTsKCgkJCSAgLy8gU2hpZnQtcmlnaHQKCQkJICBCTi5wcm90b3R5cGUuc2hybiA9IGZ1bmN0aW9uIHNocm4gKGJpdHMpIHsKCQkJICAgIHJldHVybiB0aGlzLmNsb25lKCkuaXNocm4oYml0cyk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLnVzaHJuID0gZnVuY3Rpb24gdXNocm4gKGJpdHMpIHsKCQkJICAgIHJldHVybiB0aGlzLmNsb25lKCkuaXVzaHJuKGJpdHMpOwoJCQkgIH07CgoJCQkgIC8vIFRlc3QgaWYgbiBiaXQgaXMgc2V0CgkJCSAgQk4ucHJvdG90eXBlLnRlc3RuID0gZnVuY3Rpb24gdGVzdG4gKGJpdCkgewoJCQkgICAgYXNzZXJ0KHR5cGVvZiBiaXQgPT09ICdudW1iZXInICYmIGJpdCA+PSAwKTsKCQkJICAgIHZhciByID0gYml0ICUgMjY7CgkJCSAgICB2YXIgcyA9IChiaXQgLSByKSAvIDI2OwoJCQkgICAgdmFyIHEgPSAxIDw8IHI7CgoJCQkgICAgLy8gRmFzdCBjYXNlOiBiaXQgaXMgbXVjaCBoaWdoZXIgdGhhbiBhbGwgZXhpc3Rpbmcgd29yZHMKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA8PSBzKSByZXR1cm4gZmFsc2U7CgoJCQkgICAgLy8gQ2hlY2sgYml0IGFuZCByZXR1cm4KCQkJICAgIHZhciB3ID0gdGhpcy53b3Jkc1tzXTsKCgkJCSAgICByZXR1cm4gISEodyAmIHEpOwoJCQkgIH07CgoJCQkgIC8vIFJldHVybiBvbmx5IGxvd2VycyBiaXRzIG9mIG51bWJlciAoaW4tcGxhY2UpCgkJCSAgQk4ucHJvdG90eXBlLmltYXNrbiA9IGZ1bmN0aW9uIGltYXNrbiAoYml0cykgewoJCQkgICAgYXNzZXJ0KHR5cGVvZiBiaXRzID09PSAnbnVtYmVyJyAmJiBiaXRzID49IDApOwoJCQkgICAgdmFyIHIgPSBiaXRzICUgMjY7CgkJCSAgICB2YXIgcyA9IChiaXRzIC0gcikgLyAyNjsKCgkJCSAgICBhc3NlcnQodGhpcy5uZWdhdGl2ZSA9PT0gMCwgJ2ltYXNrbiB3b3JrcyBvbmx5IHdpdGggcG9zaXRpdmUgbnVtYmVycycpOwoKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA8PSBzKSB7CgkJCSAgICAgIHJldHVybiB0aGlzOwoJCQkgICAgfQoKCQkJICAgIGlmIChyICE9PSAwKSB7CgkJCSAgICAgIHMrKzsKCQkJICAgIH0KCQkJICAgIHRoaXMubGVuZ3RoID0gTWF0aC5taW4ocywgdGhpcy5sZW5ndGgpOwoKCQkJICAgIGlmIChyICE9PSAwKSB7CgkJCSAgICAgIHZhciBtYXNrID0gMHgzZmZmZmZmIF4gKCgweDNmZmZmZmYgPj4+IHIpIDw8IHIpOwoJCQkgICAgICB0aGlzLndvcmRzW3RoaXMubGVuZ3RoIC0gMV0gJj0gbWFzazsKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gdGhpcy5fc3RyaXAoKTsKCQkJICB9OwoKCQkJICAvLyBSZXR1cm4gb25seSBsb3dlcnMgYml0cyBvZiBudW1iZXIKCQkJICBCTi5wcm90b3R5cGUubWFza24gPSBmdW5jdGlvbiBtYXNrbiAoYml0cykgewoJCQkgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5pbWFza24oYml0cyk7CgkJCSAgfTsKCgkJCSAgLy8gQWRkIHBsYWluIG51bWJlciBgbnVtYCB0byBgdGhpc2AKCQkJICBCTi5wcm90b3R5cGUuaWFkZG4gPSBmdW5jdGlvbiBpYWRkbiAobnVtKSB7CgkJCSAgICBhc3NlcnQodHlwZW9mIG51bSA9PT0gJ251bWJlcicpOwoJCQkgICAgYXNzZXJ0KG51bSA8IDB4NDAwMDAwMCk7CgkJCSAgICBpZiAobnVtIDwgMCkgcmV0dXJuIHRoaXMuaXN1Ym4oLW51bSk7CgoJCQkgICAgLy8gUG9zc2libGUgc2lnbiBjaGFuZ2UKCQkJICAgIGlmICh0aGlzLm5lZ2F0aXZlICE9PSAwKSB7CgkJCSAgICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMSAmJiAodGhpcy53b3Jkc1swXSB8IDApIDw9IG51bSkgewoJCQkgICAgICAgIHRoaXMud29yZHNbMF0gPSBudW0gLSAodGhpcy53b3Jkc1swXSB8IDApOwoJCQkgICAgICAgIHRoaXMubmVnYXRpdmUgPSAwOwoJCQkgICAgICAgIHJldHVybiB0aGlzOwoJCQkgICAgICB9CgoJCQkgICAgICB0aGlzLm5lZ2F0aXZlID0gMDsKCQkJICAgICAgdGhpcy5pc3VibihudW0pOwoJCQkgICAgICB0aGlzLm5lZ2F0aXZlID0gMTsKCQkJICAgICAgcmV0dXJuIHRoaXM7CgkJCSAgICB9CgoJCQkgICAgLy8gQWRkIHdpdGhvdXQgY2hlY2tzCgkJCSAgICByZXR1cm4gdGhpcy5faWFkZG4obnVtKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuX2lhZGRuID0gZnVuY3Rpb24gX2lhZGRuIChudW0pIHsKCQkJICAgIHRoaXMud29yZHNbMF0gKz0gbnVtOwoKCQkJICAgIC8vIENhcnJ5CgkJCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoICYmIHRoaXMud29yZHNbaV0gPj0gMHg0MDAwMDAwOyBpKyspIHsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSAtPSAweDQwMDAwMDA7CgkJCSAgICAgIGlmIChpID09PSB0aGlzLmxlbmd0aCAtIDEpIHsKCQkJICAgICAgICB0aGlzLndvcmRzW2kgKyAxXSA9IDE7CgkJCSAgICAgIH0gZWxzZSB7CgkJCSAgICAgICAgdGhpcy53b3Jkc1tpICsgMV0rKzsKCQkJICAgICAgfQoJCQkgICAgfQoJCQkgICAgdGhpcy5sZW5ndGggPSBNYXRoLm1heCh0aGlzLmxlbmd0aCwgaSArIDEpOwoKCQkJICAgIHJldHVybiB0aGlzOwoJCQkgIH07CgoJCQkgIC8vIFN1YnRyYWN0IHBsYWluIG51bWJlciBgbnVtYCBmcm9tIGB0aGlzYAoJCQkgIEJOLnByb3RvdHlwZS5pc3VibiA9IGZ1bmN0aW9uIGlzdWJuIChudW0pIHsKCQkJICAgIGFzc2VydCh0eXBlb2YgbnVtID09PSAnbnVtYmVyJyk7CgkJCSAgICBhc3NlcnQobnVtIDwgMHg0MDAwMDAwKTsKCQkJICAgIGlmIChudW0gPCAwKSByZXR1cm4gdGhpcy5pYWRkbigtbnVtKTsKCgkJCSAgICBpZiAodGhpcy5uZWdhdGl2ZSAhPT0gMCkgewoJCQkgICAgICB0aGlzLm5lZ2F0aXZlID0gMDsKCQkJICAgICAgdGhpcy5pYWRkbihudW0pOwoJCQkgICAgICB0aGlzLm5lZ2F0aXZlID0gMTsKCQkJICAgICAgcmV0dXJuIHRoaXM7CgkJCSAgICB9CgoJCQkgICAgdGhpcy53b3Jkc1swXSAtPSBudW07CgoJCQkgICAgaWYgKHRoaXMubGVuZ3RoID09PSAxICYmIHRoaXMud29yZHNbMF0gPCAwKSB7CgkJCSAgICAgIHRoaXMud29yZHNbMF0gPSAtdGhpcy53b3Jkc1swXTsKCQkJICAgICAgdGhpcy5uZWdhdGl2ZSA9IDE7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICAvLyBDYXJyeQoJCQkgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoICYmIHRoaXMud29yZHNbaV0gPCAwOyBpKyspIHsKCQkJICAgICAgICB0aGlzLndvcmRzW2ldICs9IDB4NDAwMDAwMDsKCQkJICAgICAgICB0aGlzLndvcmRzW2kgKyAxXSAtPSAxOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHRoaXMuX3N0cmlwKCk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmFkZG4gPSBmdW5jdGlvbiBhZGRuIChudW0pIHsKCQkJICAgIHJldHVybiB0aGlzLmNsb25lKCkuaWFkZG4obnVtKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuc3VibiA9IGZ1bmN0aW9uIHN1Ym4gKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5pc3VibihudW0pOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5pYWJzID0gZnVuY3Rpb24gaWFicyAoKSB7CgkJCSAgICB0aGlzLm5lZ2F0aXZlID0gMDsKCgkJCSAgICByZXR1cm4gdGhpczsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuYWJzID0gZnVuY3Rpb24gYWJzICgpIHsKCQkJICAgIHJldHVybiB0aGlzLmNsb25lKCkuaWFicygpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5faXNobG5zdWJtdWwgPSBmdW5jdGlvbiBfaXNobG5zdWJtdWwgKG51bSwgbXVsLCBzaGlmdCkgewoJCQkgICAgdmFyIGxlbiA9IG51bS5sZW5ndGggKyBzaGlmdDsKCQkJICAgIHZhciBpOwoKCQkJICAgIHRoaXMuX2V4cGFuZChsZW4pOwoKCQkJICAgIHZhciB3OwoJCQkgICAgdmFyIGNhcnJ5ID0gMDsKCQkJICAgIGZvciAoaSA9IDA7IGkgPCBudW0ubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdyA9ICh0aGlzLndvcmRzW2kgKyBzaGlmdF0gfCAwKSArIGNhcnJ5OwoJCQkgICAgICB2YXIgcmlnaHQgPSAobnVtLndvcmRzW2ldIHwgMCkgKiBtdWw7CgkJCSAgICAgIHcgLT0gcmlnaHQgJiAweDNmZmZmZmY7CgkJCSAgICAgIGNhcnJ5ID0gKHcgPj4gMjYpIC0gKChyaWdodCAvIDB4NDAwMDAwMCkgfCAwKTsKCQkJICAgICAgdGhpcy53b3Jkc1tpICsgc2hpZnRdID0gdyAmIDB4M2ZmZmZmZjsKCQkJICAgIH0KCQkJICAgIGZvciAoOyBpIDwgdGhpcy5sZW5ndGggLSBzaGlmdDsgaSsrKSB7CgkJCSAgICAgIHcgPSAodGhpcy53b3Jkc1tpICsgc2hpZnRdIHwgMCkgKyBjYXJyeTsKCQkJICAgICAgY2FycnkgPSB3ID4+IDI2OwoJCQkgICAgICB0aGlzLndvcmRzW2kgKyBzaGlmdF0gPSB3ICYgMHgzZmZmZmZmOwoJCQkgICAgfQoKCQkJICAgIGlmIChjYXJyeSA9PT0gMCkgcmV0dXJuIHRoaXMuX3N0cmlwKCk7CgoJCQkgICAgLy8gU3VidHJhY3Rpb24gb3ZlcmZsb3cKCQkJICAgIGFzc2VydChjYXJyeSA9PT0gLTEpOwoJCQkgICAgY2FycnkgPSAwOwoJCQkgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdyA9IC0odGhpcy53b3Jkc1tpXSB8IDApICsgY2Fycnk7CgkJCSAgICAgIGNhcnJ5ID0gdyA+PiAyNjsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IHcgJiAweDNmZmZmZmY7CgkJCSAgICB9CgkJCSAgICB0aGlzLm5lZ2F0aXZlID0gMTsKCgkJCSAgICByZXR1cm4gdGhpcy5fc3RyaXAoKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuX3dvcmREaXYgPSBmdW5jdGlvbiBfd29yZERpdiAobnVtLCBtb2RlKSB7CgkJCSAgICB2YXIgc2hpZnQgPSB0aGlzLmxlbmd0aCAtIG51bS5sZW5ndGg7CgoJCQkgICAgdmFyIGEgPSB0aGlzLmNsb25lKCk7CgkJCSAgICB2YXIgYiA9IG51bTsKCgkJCSAgICAvLyBOb3JtYWxpemUKCQkJICAgIHZhciBiaGkgPSBiLndvcmRzW2IubGVuZ3RoIC0gMV0gfCAwOwoJCQkgICAgdmFyIGJoaUJpdHMgPSB0aGlzLl9jb3VudEJpdHMoYmhpKTsKCQkJICAgIHNoaWZ0ID0gMjYgLSBiaGlCaXRzOwoJCQkgICAgaWYgKHNoaWZ0ICE9PSAwKSB7CgkJCSAgICAgIGIgPSBiLnVzaGxuKHNoaWZ0KTsKCQkJICAgICAgYS5pdXNobG4oc2hpZnQpOwoJCQkgICAgICBiaGkgPSBiLndvcmRzW2IubGVuZ3RoIC0gMV0gfCAwOwoJCQkgICAgfQoKCQkJICAgIC8vIEluaXRpYWxpemUgcXVvdGllbnQKCQkJICAgIHZhciBtID0gYS5sZW5ndGggLSBiLmxlbmd0aDsKCQkJICAgIHZhciBxOwoKCQkJICAgIGlmIChtb2RlICE9PSAnbW9kJykgewoJCQkgICAgICBxID0gbmV3IEJOKG51bGwpOwoJCQkgICAgICBxLmxlbmd0aCA9IG0gKyAxOwoJCQkgICAgICBxLndvcmRzID0gbmV3IEFycmF5KHEubGVuZ3RoKTsKCQkJICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxLmxlbmd0aDsgaSsrKSB7CgkJCSAgICAgICAgcS53b3Jkc1tpXSA9IDA7CgkJCSAgICAgIH0KCQkJICAgIH0KCgkJCSAgICB2YXIgZGlmZiA9IGEuY2xvbmUoKS5faXNobG5zdWJtdWwoYiwgMSwgbSk7CgkJCSAgICBpZiAoZGlmZi5uZWdhdGl2ZSA9PT0gMCkgewoJCQkgICAgICBhID0gZGlmZjsKCQkJICAgICAgaWYgKHEpIHsKCQkJICAgICAgICBxLndvcmRzW21dID0gMTsKCQkJICAgICAgfQoJCQkgICAgfQoKCQkJICAgIGZvciAodmFyIGogPSBtIC0gMTsgaiA+PSAwOyBqLS0pIHsKCQkJICAgICAgdmFyIHFqID0gKGEud29yZHNbYi5sZW5ndGggKyBqXSB8IDApICogMHg0MDAwMDAwICsKCQkJICAgICAgICAoYS53b3Jkc1tiLmxlbmd0aCArIGogLSAxXSB8IDApOwoKCQkJICAgICAgLy8gTk9URTogKHFqIC8gYmhpKSBpcyAoMHgzZmZmZmZmICogMHg0MDAwMDAwICsgMHgzZmZmZmZmKSAvIDB4MjAwMDAwMCBtYXgKCQkJICAgICAgLy8gKDB4N2ZmZmZmZikKCQkJICAgICAgcWogPSBNYXRoLm1pbigocWogLyBiaGkpIHwgMCwgMHgzZmZmZmZmKTsKCgkJCSAgICAgIGEuX2lzaGxuc3VibXVsKGIsIHFqLCBqKTsKCQkJICAgICAgd2hpbGUgKGEubmVnYXRpdmUgIT09IDApIHsKCQkJICAgICAgICBxai0tOwoJCQkgICAgICAgIGEubmVnYXRpdmUgPSAwOwoJCQkgICAgICAgIGEuX2lzaGxuc3VibXVsKGIsIDEsIGopOwoJCQkgICAgICAgIGlmICghYS5pc1plcm8oKSkgewoJCQkgICAgICAgICAgYS5uZWdhdGl2ZSBePSAxOwoJCQkgICAgICAgIH0KCQkJICAgICAgfQoJCQkgICAgICBpZiAocSkgewoJCQkgICAgICAgIHEud29yZHNbal0gPSBxajsKCQkJICAgICAgfQoJCQkgICAgfQoJCQkgICAgaWYgKHEpIHsKCQkJICAgICAgcS5fc3RyaXAoKTsKCQkJICAgIH0KCQkJICAgIGEuX3N0cmlwKCk7CgoJCQkgICAgLy8gRGVub3JtYWxpemUKCQkJICAgIGlmIChtb2RlICE9PSAnZGl2JyAmJiBzaGlmdCAhPT0gMCkgewoJCQkgICAgICBhLml1c2hybihzaGlmdCk7CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHsKCQkJICAgICAgZGl2OiBxIHx8IG51bGwsCgkJCSAgICAgIG1vZDogYQoJCQkgICAgfTsKCQkJICB9OwoKCQkJICAvLyBOT1RFOiAxKSBgbW9kZWAgY2FuIGJlIHNldCB0byBgbW9kYCB0byByZXF1ZXN0IG1vZCBvbmx5LAoJCQkgIC8vICAgICAgIHRvIGBkaXZgIHRvIHJlcXVlc3QgZGl2IG9ubHksIG9yIGJlIGFic2VudCB0bwoJCQkgIC8vICAgICAgIHJlcXVlc3QgYm90aCBkaXYgJiBtb2QKCQkJICAvLyAgICAgICAyKSBgcG9zaXRpdmVgIGlzIHRydWUgaWYgdW5zaWduZWQgbW9kIGlzIHJlcXVlc3RlZAoJCQkgIEJOLnByb3RvdHlwZS5kaXZtb2QgPSBmdW5jdGlvbiBkaXZtb2QgKG51bSwgbW9kZSwgcG9zaXRpdmUpIHsKCQkJICAgIGFzc2VydCghbnVtLmlzWmVybygpKTsKCgkJCSAgICBpZiAodGhpcy5pc1plcm8oKSkgewoJCQkgICAgICByZXR1cm4gewoJCQkgICAgICAgIGRpdjogbmV3IEJOKDApLAoJCQkgICAgICAgIG1vZDogbmV3IEJOKDApCgkJCSAgICAgIH07CgkJCSAgICB9CgoJCQkgICAgdmFyIGRpdiwgbW9kLCByZXM7CgkJCSAgICBpZiAodGhpcy5uZWdhdGl2ZSAhPT0gMCAmJiBudW0ubmVnYXRpdmUgPT09IDApIHsKCQkJICAgICAgcmVzID0gdGhpcy5uZWcoKS5kaXZtb2QobnVtLCBtb2RlKTsKCgkJCSAgICAgIGlmIChtb2RlICE9PSAnbW9kJykgewoJCQkgICAgICAgIGRpdiA9IHJlcy5kaXYubmVnKCk7CgkJCSAgICAgIH0KCgkJCSAgICAgIGlmIChtb2RlICE9PSAnZGl2JykgewoJCQkgICAgICAgIG1vZCA9IHJlcy5tb2QubmVnKCk7CgkJCSAgICAgICAgaWYgKHBvc2l0aXZlICYmIG1vZC5uZWdhdGl2ZSAhPT0gMCkgewoJCQkgICAgICAgICAgbW9kLmlhZGQobnVtKTsKCQkJICAgICAgICB9CgkJCSAgICAgIH0KCgkJCSAgICAgIHJldHVybiB7CgkJCSAgICAgICAgZGl2OiBkaXYsCgkJCSAgICAgICAgbW9kOiBtb2QKCQkJICAgICAgfTsKCQkJICAgIH0KCgkJCSAgICBpZiAodGhpcy5uZWdhdGl2ZSA9PT0gMCAmJiBudW0ubmVnYXRpdmUgIT09IDApIHsKCQkJICAgICAgcmVzID0gdGhpcy5kaXZtb2QobnVtLm5lZygpLCBtb2RlKTsKCgkJCSAgICAgIGlmIChtb2RlICE9PSAnbW9kJykgewoJCQkgICAgICAgIGRpdiA9IHJlcy5kaXYubmVnKCk7CgkJCSAgICAgIH0KCgkJCSAgICAgIHJldHVybiB7CgkJCSAgICAgICAgZGl2OiBkaXYsCgkJCSAgICAgICAgbW9kOiByZXMubW9kCgkJCSAgICAgIH07CgkJCSAgICB9CgoJCQkgICAgaWYgKCh0aGlzLm5lZ2F0aXZlICYgbnVtLm5lZ2F0aXZlKSAhPT0gMCkgewoJCQkgICAgICByZXMgPSB0aGlzLm5lZygpLmRpdm1vZChudW0ubmVnKCksIG1vZGUpOwoKCQkJICAgICAgaWYgKG1vZGUgIT09ICdkaXYnKSB7CgkJCSAgICAgICAgbW9kID0gcmVzLm1vZC5uZWcoKTsKCQkJICAgICAgICBpZiAocG9zaXRpdmUgJiYgbW9kLm5lZ2F0aXZlICE9PSAwKSB7CgkJCSAgICAgICAgICBtb2QuaXN1YihudW0pOwoJCQkgICAgICAgIH0KCQkJICAgICAgfQoKCQkJICAgICAgcmV0dXJuIHsKCQkJICAgICAgICBkaXY6IHJlcy5kaXYsCgkJCSAgICAgICAgbW9kOiBtb2QKCQkJICAgICAgfTsKCQkJICAgIH0KCgkJCSAgICAvLyBCb3RoIG51bWJlcnMgYXJlIHBvc2l0aXZlIGF0IHRoaXMgcG9pbnQKCgkJCSAgICAvLyBTdHJpcCBib3RoIG51bWJlcnMgdG8gYXBwcm94aW1hdGUgc2hpZnQgdmFsdWUKCQkJICAgIGlmIChudW0ubGVuZ3RoID4gdGhpcy5sZW5ndGggfHwgdGhpcy5jbXAobnVtKSA8IDApIHsKCQkJICAgICAgcmV0dXJuIHsKCQkJICAgICAgICBkaXY6IG5ldyBCTigwKSwKCQkJICAgICAgICBtb2Q6IHRoaXMKCQkJICAgICAgfTsKCQkJICAgIH0KCgkJCSAgICAvLyBWZXJ5IHNob3J0IHJlZHVjdGlvbgoJCQkgICAgaWYgKG51bS5sZW5ndGggPT09IDEpIHsKCQkJICAgICAgaWYgKG1vZGUgPT09ICdkaXYnKSB7CgkJCSAgICAgICAgcmV0dXJuIHsKCQkJICAgICAgICAgIGRpdjogdGhpcy5kaXZuKG51bS53b3Jkc1swXSksCgkJCSAgICAgICAgICBtb2Q6IG51bGwKCQkJICAgICAgICB9OwoJCQkgICAgICB9CgoJCQkgICAgICBpZiAobW9kZSA9PT0gJ21vZCcpIHsKCQkJICAgICAgICByZXR1cm4gewoJCQkgICAgICAgICAgZGl2OiBudWxsLAoJCQkgICAgICAgICAgbW9kOiBuZXcgQk4odGhpcy5tb2RybihudW0ud29yZHNbMF0pKQoJCQkgICAgICAgIH07CgkJCSAgICAgIH0KCgkJCSAgICAgIHJldHVybiB7CgkJCSAgICAgICAgZGl2OiB0aGlzLmRpdm4obnVtLndvcmRzWzBdKSwKCQkJICAgICAgICBtb2Q6IG5ldyBCTih0aGlzLm1vZHJuKG51bS53b3Jkc1swXSkpCgkJCSAgICAgIH07CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHRoaXMuX3dvcmREaXYobnVtLCBtb2RlKTsKCQkJICB9OwoKCQkJICAvLyBGaW5kIGB0aGlzYCAvIGBudW1gCgkJCSAgQk4ucHJvdG90eXBlLmRpdiA9IGZ1bmN0aW9uIGRpdiAobnVtKSB7CgkJCSAgICByZXR1cm4gdGhpcy5kaXZtb2QobnVtLCAnZGl2JywgZmFsc2UpLmRpdjsKCQkJICB9OwoKCQkJICAvLyBGaW5kIGB0aGlzYCAlIGBudW1gCgkJCSAgQk4ucHJvdG90eXBlLm1vZCA9IGZ1bmN0aW9uIG1vZCAobnVtKSB7CgkJCSAgICByZXR1cm4gdGhpcy5kaXZtb2QobnVtLCAnbW9kJywgZmFsc2UpLm1vZDsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUudW1vZCA9IGZ1bmN0aW9uIHVtb2QgKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMuZGl2bW9kKG51bSwgJ21vZCcsIHRydWUpLm1vZDsKCQkJICB9OwoKCQkJICAvLyBGaW5kIFJvdW5kKGB0aGlzYCAvIGBudW1gKQoJCQkgIEJOLnByb3RvdHlwZS5kaXZSb3VuZCA9IGZ1bmN0aW9uIGRpdlJvdW5kIChudW0pIHsKCQkJICAgIHZhciBkbSA9IHRoaXMuZGl2bW9kKG51bSk7CgoJCQkgICAgLy8gRmFzdCBjYXNlIC0gZXhhY3QgZGl2aXNpb24KCQkJICAgIGlmIChkbS5tb2QuaXNaZXJvKCkpIHJldHVybiBkbS5kaXY7CgoJCQkgICAgdmFyIG1vZCA9IGRtLmRpdi5uZWdhdGl2ZSAhPT0gMCA/IGRtLm1vZC5pc3ViKG51bSkgOiBkbS5tb2Q7CgoJCQkgICAgdmFyIGhhbGYgPSBudW0udXNocm4oMSk7CgkJCSAgICB2YXIgcjIgPSBudW0uYW5kbG4oMSk7CgkJCSAgICB2YXIgY21wID0gbW9kLmNtcChoYWxmKTsKCgkJCSAgICAvLyBSb3VuZCBkb3duCgkJCSAgICBpZiAoY21wIDwgMCB8fCAocjIgPT09IDEgJiYgY21wID09PSAwKSkgcmV0dXJuIGRtLmRpdjsKCgkJCSAgICAvLyBSb3VuZCB1cAoJCQkgICAgcmV0dXJuIGRtLmRpdi5uZWdhdGl2ZSAhPT0gMCA/IGRtLmRpdi5pc3VibigxKSA6IGRtLmRpdi5pYWRkbigxKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUubW9kcm4gPSBmdW5jdGlvbiBtb2RybiAobnVtKSB7CgkJCSAgICB2YXIgaXNOZWdOdW0gPSBudW0gPCAwOwoJCQkgICAgaWYgKGlzTmVnTnVtKSBudW0gPSAtbnVtOwoKCQkJICAgIGFzc2VydChudW0gPD0gMHgzZmZmZmZmKTsKCQkJICAgIHZhciBwID0gKDEgPDwgMjYpICUgbnVtOwoKCQkJICAgIHZhciBhY2MgPSAwOwoJCQkgICAgZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJICAgICAgYWNjID0gKHAgKiBhY2MgKyAodGhpcy53b3Jkc1tpXSB8IDApKSAlIG51bTsKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gaXNOZWdOdW0gPyAtYWNjIDogYWNjOwoJCQkgIH07CgoJCQkgIC8vIFdBUk5JTkc6IERFUFJFQ0FURUQKCQkJICBCTi5wcm90b3R5cGUubW9kbiA9IGZ1bmN0aW9uIG1vZG4gKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMubW9kcm4obnVtKTsKCQkJICB9OwoKCQkJICAvLyBJbi1wbGFjZSBkaXZpc2lvbiBieSBudW1iZXIKCQkJICBCTi5wcm90b3R5cGUuaWRpdm4gPSBmdW5jdGlvbiBpZGl2biAobnVtKSB7CgkJCSAgICB2YXIgaXNOZWdOdW0gPSBudW0gPCAwOwoJCQkgICAgaWYgKGlzTmVnTnVtKSBudW0gPSAtbnVtOwoKCQkJICAgIGFzc2VydChudW0gPD0gMHgzZmZmZmZmKTsKCgkJCSAgICB2YXIgY2FycnkgPSAwOwoJCQkgICAgZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJICAgICAgdmFyIHcgPSAodGhpcy53b3Jkc1tpXSB8IDApICsgY2FycnkgKiAweDQwMDAwMDA7CgkJCSAgICAgIHRoaXMud29yZHNbaV0gPSAodyAvIG51bSkgfCAwOwoJCQkgICAgICBjYXJyeSA9IHcgJSBudW07CgkJCSAgICB9CgoJCQkgICAgdGhpcy5fc3RyaXAoKTsKCQkJICAgIHJldHVybiBpc05lZ051bSA/IHRoaXMuaW5lZygpIDogdGhpczsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuZGl2biA9IGZ1bmN0aW9uIGRpdm4gKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5pZGl2bihudW0pOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5lZ2NkID0gZnVuY3Rpb24gZWdjZCAocCkgewoJCQkgICAgYXNzZXJ0KHAubmVnYXRpdmUgPT09IDApOwoJCQkgICAgYXNzZXJ0KCFwLmlzWmVybygpKTsKCgkJCSAgICB2YXIgeCA9IHRoaXM7CgkJCSAgICB2YXIgeSA9IHAuY2xvbmUoKTsKCgkJCSAgICBpZiAoeC5uZWdhdGl2ZSAhPT0gMCkgewoJCQkgICAgICB4ID0geC51bW9kKHApOwoJCQkgICAgfSBlbHNlIHsKCQkJICAgICAgeCA9IHguY2xvbmUoKTsKCQkJICAgIH0KCgkJCSAgICAvLyBBICogeCArIEIgKiB5ID0geAoJCQkgICAgdmFyIEEgPSBuZXcgQk4oMSk7CgkJCSAgICB2YXIgQiA9IG5ldyBCTigwKTsKCgkJCSAgICAvLyBDICogeCArIEQgKiB5ID0geQoJCQkgICAgdmFyIEMgPSBuZXcgQk4oMCk7CgkJCSAgICB2YXIgRCA9IG5ldyBCTigxKTsKCgkJCSAgICB2YXIgZyA9IDA7CgoJCQkgICAgd2hpbGUgKHguaXNFdmVuKCkgJiYgeS5pc0V2ZW4oKSkgewoJCQkgICAgICB4Lml1c2hybigxKTsKCQkJICAgICAgeS5pdXNocm4oMSk7CgkJCSAgICAgICsrZzsKCQkJICAgIH0KCgkJCSAgICB2YXIgeXAgPSB5LmNsb25lKCk7CgkJCSAgICB2YXIgeHAgPSB4LmNsb25lKCk7CgoJCQkgICAgd2hpbGUgKCF4LmlzWmVybygpKSB7CgkJCSAgICAgIGZvciAodmFyIGkgPSAwLCBpbSA9IDE7ICh4LndvcmRzWzBdICYgaW0pID09PSAwICYmIGkgPCAyNjsgKytpLCBpbSA8PD0gMSk7CgkJCSAgICAgIGlmIChpID4gMCkgewoJCQkgICAgICAgIHguaXVzaHJuKGkpOwoJCQkgICAgICAgIHdoaWxlIChpLS0gPiAwKSB7CgkJCSAgICAgICAgICBpZiAoQS5pc09kZCgpIHx8IEIuaXNPZGQoKSkgewoJCQkgICAgICAgICAgICBBLmlhZGQoeXApOwoJCQkgICAgICAgICAgICBCLmlzdWIoeHApOwoJCQkgICAgICAgICAgfQoKCQkJICAgICAgICAgIEEuaXVzaHJuKDEpOwoJCQkgICAgICAgICAgQi5pdXNocm4oMSk7CgkJCSAgICAgICAgfQoJCQkgICAgICB9CgoJCQkgICAgICBmb3IgKHZhciBqID0gMCwgam0gPSAxOyAoeS53b3Jkc1swXSAmIGptKSA9PT0gMCAmJiBqIDwgMjY7ICsraiwgam0gPDw9IDEpOwoJCQkgICAgICBpZiAoaiA+IDApIHsKCQkJICAgICAgICB5Lml1c2hybihqKTsKCQkJICAgICAgICB3aGlsZSAoai0tID4gMCkgewoJCQkgICAgICAgICAgaWYgKEMuaXNPZGQoKSB8fCBELmlzT2RkKCkpIHsKCQkJICAgICAgICAgICAgQy5pYWRkKHlwKTsKCQkJICAgICAgICAgICAgRC5pc3ViKHhwKTsKCQkJICAgICAgICAgIH0KCgkJCSAgICAgICAgICBDLml1c2hybigxKTsKCQkJICAgICAgICAgIEQuaXVzaHJuKDEpOwoJCQkgICAgICAgIH0KCQkJICAgICAgfQoKCQkJICAgICAgaWYgKHguY21wKHkpID49IDApIHsKCQkJICAgICAgICB4LmlzdWIoeSk7CgkJCSAgICAgICAgQS5pc3ViKEMpOwoJCQkgICAgICAgIEIuaXN1YihEKTsKCQkJICAgICAgfSBlbHNlIHsKCQkJICAgICAgICB5LmlzdWIoeCk7CgkJCSAgICAgICAgQy5pc3ViKEEpOwoJCQkgICAgICAgIEQuaXN1YihCKTsKCQkJICAgICAgfQoJCQkgICAgfQoKCQkJICAgIHJldHVybiB7CgkJCSAgICAgIGE6IEMsCgkJCSAgICAgIGI6IEQsCgkJCSAgICAgIGdjZDogeS5pdXNobG4oZykKCQkJICAgIH07CgkJCSAgfTsKCgkJCSAgLy8gVGhpcyBpcyByZWR1Y2VkIGluY2FybmF0aW9uIG9mIHRoZSBiaW5hcnkgRUVBCgkJCSAgLy8gYWJvdmUsIGRlc2lnbmF0ZWQgdG8gaW52ZXJ0IG1lbWJlcnMgb2YgdGhlCgkJCSAgLy8gX3ByaW1lXyBmaWVsZHMgRihwKSBhdCBhIG1heGltYWwgc3BlZWQKCQkJICBCTi5wcm90b3R5cGUuX2ludm1wID0gZnVuY3Rpb24gX2ludm1wIChwKSB7CgkJCSAgICBhc3NlcnQocC5uZWdhdGl2ZSA9PT0gMCk7CgkJCSAgICBhc3NlcnQoIXAuaXNaZXJvKCkpOwoKCQkJICAgIHZhciBhID0gdGhpczsKCQkJICAgIHZhciBiID0gcC5jbG9uZSgpOwoKCQkJICAgIGlmIChhLm5lZ2F0aXZlICE9PSAwKSB7CgkJCSAgICAgIGEgPSBhLnVtb2QocCk7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBhID0gYS5jbG9uZSgpOwoJCQkgICAgfQoKCQkJICAgIHZhciB4MSA9IG5ldyBCTigxKTsKCQkJICAgIHZhciB4MiA9IG5ldyBCTigwKTsKCgkJCSAgICB2YXIgZGVsdGEgPSBiLmNsb25lKCk7CgoJCQkgICAgd2hpbGUgKGEuY21wbigxKSA+IDAgJiYgYi5jbXBuKDEpID4gMCkgewoJCQkgICAgICBmb3IgKHZhciBpID0gMCwgaW0gPSAxOyAoYS53b3Jkc1swXSAmIGltKSA9PT0gMCAmJiBpIDwgMjY7ICsraSwgaW0gPDw9IDEpOwoJCQkgICAgICBpZiAoaSA+IDApIHsKCQkJICAgICAgICBhLml1c2hybihpKTsKCQkJICAgICAgICB3aGlsZSAoaS0tID4gMCkgewoJCQkgICAgICAgICAgaWYgKHgxLmlzT2RkKCkpIHsKCQkJICAgICAgICAgICAgeDEuaWFkZChkZWx0YSk7CgkJCSAgICAgICAgICB9CgoJCQkgICAgICAgICAgeDEuaXVzaHJuKDEpOwoJCQkgICAgICAgIH0KCQkJICAgICAgfQoKCQkJICAgICAgZm9yICh2YXIgaiA9IDAsIGptID0gMTsgKGIud29yZHNbMF0gJiBqbSkgPT09IDAgJiYgaiA8IDI2OyArK2osIGptIDw8PSAxKTsKCQkJICAgICAgaWYgKGogPiAwKSB7CgkJCSAgICAgICAgYi5pdXNocm4oaik7CgkJCSAgICAgICAgd2hpbGUgKGotLSA+IDApIHsKCQkJICAgICAgICAgIGlmICh4Mi5pc09kZCgpKSB7CgkJCSAgICAgICAgICAgIHgyLmlhZGQoZGVsdGEpOwoJCQkgICAgICAgICAgfQoKCQkJICAgICAgICAgIHgyLml1c2hybigxKTsKCQkJICAgICAgICB9CgkJCSAgICAgIH0KCgkJCSAgICAgIGlmIChhLmNtcChiKSA+PSAwKSB7CgkJCSAgICAgICAgYS5pc3ViKGIpOwoJCQkgICAgICAgIHgxLmlzdWIoeDIpOwoJCQkgICAgICB9IGVsc2UgewoJCQkgICAgICAgIGIuaXN1YihhKTsKCQkJICAgICAgICB4Mi5pc3ViKHgxKTsKCQkJICAgICAgfQoJCQkgICAgfQoKCQkJICAgIHZhciByZXM7CgkJCSAgICBpZiAoYS5jbXBuKDEpID09PSAwKSB7CgkJCSAgICAgIHJlcyA9IHgxOwoJCQkgICAgfSBlbHNlIHsKCQkJICAgICAgcmVzID0geDI7CgkJCSAgICB9CgoJCQkgICAgaWYgKHJlcy5jbXBuKDApIDwgMCkgewoJCQkgICAgICByZXMuaWFkZChwKTsKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gcmVzOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5nY2QgPSBmdW5jdGlvbiBnY2QgKG51bSkgewoJCQkgICAgaWYgKHRoaXMuaXNaZXJvKCkpIHJldHVybiBudW0uYWJzKCk7CgkJCSAgICBpZiAobnVtLmlzWmVybygpKSByZXR1cm4gdGhpcy5hYnMoKTsKCgkJCSAgICB2YXIgYSA9IHRoaXMuY2xvbmUoKTsKCQkJICAgIHZhciBiID0gbnVtLmNsb25lKCk7CgkJCSAgICBhLm5lZ2F0aXZlID0gMDsKCQkJICAgIGIubmVnYXRpdmUgPSAwOwoKCQkJICAgIC8vIFJlbW92ZSBjb21tb24gZmFjdG9yIG9mIHR3bwoJCQkgICAgZm9yICh2YXIgc2hpZnQgPSAwOyBhLmlzRXZlbigpICYmIGIuaXNFdmVuKCk7IHNoaWZ0KyspIHsKCQkJICAgICAgYS5pdXNocm4oMSk7CgkJCSAgICAgIGIuaXVzaHJuKDEpOwoJCQkgICAgfQoKCQkJICAgIGRvIHsKCQkJICAgICAgd2hpbGUgKGEuaXNFdmVuKCkpIHsKCQkJICAgICAgICBhLml1c2hybigxKTsKCQkJICAgICAgfQoJCQkgICAgICB3aGlsZSAoYi5pc0V2ZW4oKSkgewoJCQkgICAgICAgIGIuaXVzaHJuKDEpOwoJCQkgICAgICB9CgoJCQkgICAgICB2YXIgciA9IGEuY21wKGIpOwoJCQkgICAgICBpZiAociA8IDApIHsKCQkJICAgICAgICAvLyBTd2FwIGBhYCBhbmQgYGJgIHRvIG1ha2UgYGFgIGFsd2F5cyBiaWdnZXIgdGhhbiBgYmAKCQkJICAgICAgICB2YXIgdCA9IGE7CgkJCSAgICAgICAgYSA9IGI7CgkJCSAgICAgICAgYiA9IHQ7CgkJCSAgICAgIH0gZWxzZSBpZiAociA9PT0gMCB8fCBiLmNtcG4oMSkgPT09IDApIHsKCQkJICAgICAgICBicmVhazsKCQkJICAgICAgfQoKCQkJICAgICAgYS5pc3ViKGIpOwoJCQkgICAgfSB3aGlsZSAodHJ1ZSk7CgoJCQkgICAgcmV0dXJuIGIuaXVzaGxuKHNoaWZ0KTsKCQkJICB9OwoKCQkJICAvLyBJbnZlcnQgbnVtYmVyIGluIHRoZSBmaWVsZCBGKG51bSkKCQkJICBCTi5wcm90b3R5cGUuaW52bSA9IGZ1bmN0aW9uIGludm0gKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMuZWdjZChudW0pLmEudW1vZChudW0pOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5pc0V2ZW4gPSBmdW5jdGlvbiBpc0V2ZW4gKCkgewoJCQkgICAgcmV0dXJuICh0aGlzLndvcmRzWzBdICYgMSkgPT09IDA7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmlzT2RkID0gZnVuY3Rpb24gaXNPZGQgKCkgewoJCQkgICAgcmV0dXJuICh0aGlzLndvcmRzWzBdICYgMSkgPT09IDE7CgkJCSAgfTsKCgkJCSAgLy8gQW5kIGZpcnN0IHdvcmQgYW5kIG51bQoJCQkgIEJOLnByb3RvdHlwZS5hbmRsbiA9IGZ1bmN0aW9uIGFuZGxuIChudW0pIHsKCQkJICAgIHJldHVybiB0aGlzLndvcmRzWzBdICYgbnVtOwoJCQkgIH07CgoJCQkgIC8vIEluY3JlbWVudCBhdCB0aGUgYml0IHBvc2l0aW9uIGluLWxpbmUKCQkJICBCTi5wcm90b3R5cGUuYmluY24gPSBmdW5jdGlvbiBiaW5jbiAoYml0KSB7CgkJCSAgICBhc3NlcnQodHlwZW9mIGJpdCA9PT0gJ251bWJlcicpOwoJCQkgICAgdmFyIHIgPSBiaXQgJSAyNjsKCQkJICAgIHZhciBzID0gKGJpdCAtIHIpIC8gMjY7CgkJCSAgICB2YXIgcSA9IDEgPDwgcjsKCgkJCSAgICAvLyBGYXN0IGNhc2U6IGJpdCBpcyBtdWNoIGhpZ2hlciB0aGFuIGFsbCBleGlzdGluZyB3b3JkcwoJCQkgICAgaWYgKHRoaXMubGVuZ3RoIDw9IHMpIHsKCQkJICAgICAgdGhpcy5fZXhwYW5kKHMgKyAxKTsKCQkJICAgICAgdGhpcy53b3Jkc1tzXSB8PSBxOwoJCQkgICAgICByZXR1cm4gdGhpczsKCQkJICAgIH0KCgkJCSAgICAvLyBBZGQgYml0IGFuZCBwcm9wYWdhdGUsIGlmIG5lZWRlZAoJCQkgICAgdmFyIGNhcnJ5ID0gcTsKCQkJICAgIGZvciAodmFyIGkgPSBzOyBjYXJyeSAhPT0gMCAmJiBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewoJCQkgICAgICB2YXIgdyA9IHRoaXMud29yZHNbaV0gfCAwOwoJCQkgICAgICB3ICs9IGNhcnJ5OwoJCQkgICAgICBjYXJyeSA9IHcgPj4+IDI2OwoJCQkgICAgICB3ICY9IDB4M2ZmZmZmZjsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IHc7CgkJCSAgICB9CgkJCSAgICBpZiAoY2FycnkgIT09IDApIHsKCQkJICAgICAgdGhpcy53b3Jkc1tpXSA9IGNhcnJ5OwoJCQkgICAgICB0aGlzLmxlbmd0aCsrOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHRoaXM7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmlzWmVybyA9IGZ1bmN0aW9uIGlzWmVybyAoKSB7CgkJCSAgICByZXR1cm4gdGhpcy5sZW5ndGggPT09IDEgJiYgdGhpcy53b3Jkc1swXSA9PT0gMDsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuY21wbiA9IGZ1bmN0aW9uIGNtcG4gKG51bSkgewoJCQkgICAgdmFyIG5lZ2F0aXZlID0gbnVtIDwgMDsKCgkJCSAgICBpZiAodGhpcy5uZWdhdGl2ZSAhPT0gMCAmJiAhbmVnYXRpdmUpIHJldHVybiAtMTsKCQkJICAgIGlmICh0aGlzLm5lZ2F0aXZlID09PSAwICYmIG5lZ2F0aXZlKSByZXR1cm4gMTsKCgkJCSAgICB0aGlzLl9zdHJpcCgpOwoKCQkJICAgIHZhciByZXM7CgkJCSAgICBpZiAodGhpcy5sZW5ndGggPiAxKSB7CgkJCSAgICAgIHJlcyA9IDE7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBpZiAobmVnYXRpdmUpIHsKCQkJICAgICAgICBudW0gPSAtbnVtOwoJCQkgICAgICB9CgoJCQkgICAgICBhc3NlcnQobnVtIDw9IDB4M2ZmZmZmZiwgJ051bWJlciBpcyB0b28gYmlnJyk7CgoJCQkgICAgICB2YXIgdyA9IHRoaXMud29yZHNbMF0gfCAwOwoJCQkgICAgICByZXMgPSB3ID09PSBudW0gPyAwIDogdyA8IG51bSA/IC0xIDogMTsKCQkJICAgIH0KCQkJICAgIGlmICh0aGlzLm5lZ2F0aXZlICE9PSAwKSByZXR1cm4gLXJlcyB8IDA7CgkJCSAgICByZXR1cm4gcmVzOwoJCQkgIH07CgoJCQkgIC8vIENvbXBhcmUgdHdvIG51bWJlcnMgYW5kIHJldHVybjoKCQkJICAvLyAxIC0gaWYgYHRoaXNgID4gYG51bWAKCQkJICAvLyAwIC0gaWYgYHRoaXNgID09IGBudW1gCgkJCSAgLy8gLTEgLSBpZiBgdGhpc2AgPCBgbnVtYAoJCQkgIEJOLnByb3RvdHlwZS5jbXAgPSBmdW5jdGlvbiBjbXAgKG51bSkgewoJCQkgICAgaWYgKHRoaXMubmVnYXRpdmUgIT09IDAgJiYgbnVtLm5lZ2F0aXZlID09PSAwKSByZXR1cm4gLTE7CgkJCSAgICBpZiAodGhpcy5uZWdhdGl2ZSA9PT0gMCAmJiBudW0ubmVnYXRpdmUgIT09IDApIHJldHVybiAxOwoKCQkJICAgIHZhciByZXMgPSB0aGlzLnVjbXAobnVtKTsKCQkJICAgIGlmICh0aGlzLm5lZ2F0aXZlICE9PSAwKSByZXR1cm4gLXJlcyB8IDA7CgkJCSAgICByZXR1cm4gcmVzOwoJCQkgIH07CgoJCQkgIC8vIFVuc2lnbmVkIGNvbXBhcmlzb24KCQkJICBCTi5wcm90b3R5cGUudWNtcCA9IGZ1bmN0aW9uIHVjbXAgKG51bSkgewoJCQkgICAgLy8gQXQgdGhpcyBwb2ludCBib3RoIG51bWJlcnMgaGF2ZSB0aGUgc2FtZSBzaWduCgkJCSAgICBpZiAodGhpcy5sZW5ndGggPiBudW0ubGVuZ3RoKSByZXR1cm4gMTsKCQkJICAgIGlmICh0aGlzLmxlbmd0aCA8IG51bS5sZW5ndGgpIHJldHVybiAtMTsKCgkJCSAgICB2YXIgcmVzID0gMDsKCQkJICAgIGZvciAodmFyIGkgPSB0aGlzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCSAgICAgIHZhciBhID0gdGhpcy53b3Jkc1tpXSB8IDA7CgkJCSAgICAgIHZhciBiID0gbnVtLndvcmRzW2ldIHwgMDsKCgkJCSAgICAgIGlmIChhID09PSBiKSBjb250aW51ZTsKCQkJICAgICAgaWYgKGEgPCBiKSB7CgkJCSAgICAgICAgcmVzID0gLTE7CgkJCSAgICAgIH0gZWxzZSBpZiAoYSA+IGIpIHsKCQkJICAgICAgICByZXMgPSAxOwoJCQkgICAgICB9CgkJCSAgICAgIGJyZWFrOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJlczsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuZ3RuID0gZnVuY3Rpb24gZ3RuIChudW0pIHsKCQkJICAgIHJldHVybiB0aGlzLmNtcG4obnVtKSA9PT0gMTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuZ3QgPSBmdW5jdGlvbiBndCAobnVtKSB7CgkJCSAgICByZXR1cm4gdGhpcy5jbXAobnVtKSA9PT0gMTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuZ3RlbiA9IGZ1bmN0aW9uIGd0ZW4gKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMuY21wbihudW0pID49IDA7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmd0ZSA9IGZ1bmN0aW9uIGd0ZSAobnVtKSB7CgkJCSAgICByZXR1cm4gdGhpcy5jbXAobnVtKSA+PSAwOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5sdG4gPSBmdW5jdGlvbiBsdG4gKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMuY21wbihudW0pID09PSAtMTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUubHQgPSBmdW5jdGlvbiBsdCAobnVtKSB7CgkJCSAgICByZXR1cm4gdGhpcy5jbXAobnVtKSA9PT0gLTE7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmx0ZW4gPSBmdW5jdGlvbiBsdGVuIChudW0pIHsKCQkJICAgIHJldHVybiB0aGlzLmNtcG4obnVtKSA8PSAwOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5sdGUgPSBmdW5jdGlvbiBsdGUgKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMuY21wKG51bSkgPD0gMDsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuZXFuID0gZnVuY3Rpb24gZXFuIChudW0pIHsKCQkJICAgIHJldHVybiB0aGlzLmNtcG4obnVtKSA9PT0gMDsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuZXEgPSBmdW5jdGlvbiBlcSAobnVtKSB7CgkJCSAgICByZXR1cm4gdGhpcy5jbXAobnVtKSA9PT0gMDsKCQkJICB9OwoKCQkJICAvLwoJCQkgIC8vIEEgcmVkdWNlIGNvbnRleHQsIGNvdWxkIGJlIHVzaW5nIG1vbnRnb21lcnkgb3Igc29tZXRoaW5nIGJldHRlciwgZGVwZW5kaW5nCgkJCSAgLy8gb24gdGhlIGBtYCBpdHNlbGYuCgkJCSAgLy8KCQkJICBCTi5yZWQgPSBmdW5jdGlvbiByZWQgKG51bSkgewoJCQkgICAgcmV0dXJuIG5ldyBSZWQobnVtKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUudG9SZWQgPSBmdW5jdGlvbiB0b1JlZCAoY3R4KSB7CgkJCSAgICBhc3NlcnQoIXRoaXMucmVkLCAnQWxyZWFkeSBhIG51bWJlciBpbiByZWR1Y3Rpb24gY29udGV4dCcpOwoJCQkgICAgYXNzZXJ0KHRoaXMubmVnYXRpdmUgPT09IDAsICdyZWQgd29ya3Mgb25seSB3aXRoIHBvc2l0aXZlcycpOwoJCQkgICAgcmV0dXJuIGN0eC5jb252ZXJ0VG8odGhpcykuX2ZvcmNlUmVkKGN0eCk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmZyb21SZWQgPSBmdW5jdGlvbiBmcm9tUmVkICgpIHsKCQkJICAgIGFzc2VydCh0aGlzLnJlZCwgJ2Zyb21SZWQgd29ya3Mgb25seSB3aXRoIG51bWJlcnMgaW4gcmVkdWN0aW9uIGNvbnRleHQnKTsKCQkJICAgIHJldHVybiB0aGlzLnJlZC5jb252ZXJ0RnJvbSh0aGlzKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUuX2ZvcmNlUmVkID0gZnVuY3Rpb24gX2ZvcmNlUmVkIChjdHgpIHsKCQkJICAgIHRoaXMucmVkID0gY3R4OwoJCQkgICAgcmV0dXJuIHRoaXM7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLmZvcmNlUmVkID0gZnVuY3Rpb24gZm9yY2VSZWQgKGN0eCkgewoJCQkgICAgYXNzZXJ0KCF0aGlzLnJlZCwgJ0FscmVhZHkgYSBudW1iZXIgaW4gcmVkdWN0aW9uIGNvbnRleHQnKTsKCQkJICAgIHJldHVybiB0aGlzLl9mb3JjZVJlZChjdHgpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5yZWRBZGQgPSBmdW5jdGlvbiByZWRBZGQgKG51bSkgewoJCQkgICAgYXNzZXJ0KHRoaXMucmVkLCAncmVkQWRkIHdvcmtzIG9ubHkgd2l0aCByZWQgbnVtYmVycycpOwoJCQkgICAgcmV0dXJuIHRoaXMucmVkLmFkZCh0aGlzLCBudW0pOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5yZWRJQWRkID0gZnVuY3Rpb24gcmVkSUFkZCAobnVtKSB7CgkJCSAgICBhc3NlcnQodGhpcy5yZWQsICdyZWRJQWRkIHdvcmtzIG9ubHkgd2l0aCByZWQgbnVtYmVycycpOwoJCQkgICAgcmV0dXJuIHRoaXMucmVkLmlhZGQodGhpcywgbnVtKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUucmVkU3ViID0gZnVuY3Rpb24gcmVkU3ViIChudW0pIHsKCQkJICAgIGFzc2VydCh0aGlzLnJlZCwgJ3JlZFN1YiB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMnKTsKCQkJICAgIHJldHVybiB0aGlzLnJlZC5zdWIodGhpcywgbnVtKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUucmVkSVN1YiA9IGZ1bmN0aW9uIHJlZElTdWIgKG51bSkgewoJCQkgICAgYXNzZXJ0KHRoaXMucmVkLCAncmVkSVN1YiB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMnKTsKCQkJICAgIHJldHVybiB0aGlzLnJlZC5pc3ViKHRoaXMsIG51bSk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLnJlZFNobCA9IGZ1bmN0aW9uIHJlZFNobCAobnVtKSB7CgkJCSAgICBhc3NlcnQodGhpcy5yZWQsICdyZWRTaGwgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzJyk7CgkJCSAgICByZXR1cm4gdGhpcy5yZWQuc2hsKHRoaXMsIG51bSk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLnJlZE11bCA9IGZ1bmN0aW9uIHJlZE11bCAobnVtKSB7CgkJCSAgICBhc3NlcnQodGhpcy5yZWQsICdyZWRNdWwgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzJyk7CgkJCSAgICB0aGlzLnJlZC5fdmVyaWZ5Mih0aGlzLCBudW0pOwoJCQkgICAgcmV0dXJuIHRoaXMucmVkLm11bCh0aGlzLCBudW0pOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5yZWRJTXVsID0gZnVuY3Rpb24gcmVkSU11bCAobnVtKSB7CgkJCSAgICBhc3NlcnQodGhpcy5yZWQsICdyZWRNdWwgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzJyk7CgkJCSAgICB0aGlzLnJlZC5fdmVyaWZ5Mih0aGlzLCBudW0pOwoJCQkgICAgcmV0dXJuIHRoaXMucmVkLmltdWwodGhpcywgbnVtKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUucmVkU3FyID0gZnVuY3Rpb24gcmVkU3FyICgpIHsKCQkJICAgIGFzc2VydCh0aGlzLnJlZCwgJ3JlZFNxciB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMnKTsKCQkJICAgIHRoaXMucmVkLl92ZXJpZnkxKHRoaXMpOwoJCQkgICAgcmV0dXJuIHRoaXMucmVkLnNxcih0aGlzKTsKCQkJICB9OwoKCQkJICBCTi5wcm90b3R5cGUucmVkSVNxciA9IGZ1bmN0aW9uIHJlZElTcXIgKCkgewoJCQkgICAgYXNzZXJ0KHRoaXMucmVkLCAncmVkSVNxciB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMnKTsKCQkJICAgIHRoaXMucmVkLl92ZXJpZnkxKHRoaXMpOwoJCQkgICAgcmV0dXJuIHRoaXMucmVkLmlzcXIodGhpcyk7CgkJCSAgfTsKCgkJCSAgLy8gU3F1YXJlIHJvb3Qgb3ZlciBwCgkJCSAgQk4ucHJvdG90eXBlLnJlZFNxcnQgPSBmdW5jdGlvbiByZWRTcXJ0ICgpIHsKCQkJICAgIGFzc2VydCh0aGlzLnJlZCwgJ3JlZFNxcnQgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzJyk7CgkJCSAgICB0aGlzLnJlZC5fdmVyaWZ5MSh0aGlzKTsKCQkJICAgIHJldHVybiB0aGlzLnJlZC5zcXJ0KHRoaXMpOwoJCQkgIH07CgoJCQkgIEJOLnByb3RvdHlwZS5yZWRJbnZtID0gZnVuY3Rpb24gcmVkSW52bSAoKSB7CgkJCSAgICBhc3NlcnQodGhpcy5yZWQsICdyZWRJbnZtIHdvcmtzIG9ubHkgd2l0aCByZWQgbnVtYmVycycpOwoJCQkgICAgdGhpcy5yZWQuX3ZlcmlmeTEodGhpcyk7CgkJCSAgICByZXR1cm4gdGhpcy5yZWQuaW52bSh0aGlzKTsKCQkJICB9OwoKCQkJICAvLyBSZXR1cm4gbmVnYXRpdmUgY2xvbmUgb2YgYHRoaXNgICUgYHJlZCBtb2R1bG9gCgkJCSAgQk4ucHJvdG90eXBlLnJlZE5lZyA9IGZ1bmN0aW9uIHJlZE5lZyAoKSB7CgkJCSAgICBhc3NlcnQodGhpcy5yZWQsICdyZWROZWcgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzJyk7CgkJCSAgICB0aGlzLnJlZC5fdmVyaWZ5MSh0aGlzKTsKCQkJICAgIHJldHVybiB0aGlzLnJlZC5uZWcodGhpcyk7CgkJCSAgfTsKCgkJCSAgQk4ucHJvdG90eXBlLnJlZFBvdyA9IGZ1bmN0aW9uIHJlZFBvdyAobnVtKSB7CgkJCSAgICBhc3NlcnQodGhpcy5yZWQgJiYgIW51bS5yZWQsICdyZWRQb3cobm9ybWFsTnVtKScpOwoJCQkgICAgdGhpcy5yZWQuX3ZlcmlmeTEodGhpcyk7CgkJCSAgICByZXR1cm4gdGhpcy5yZWQucG93KHRoaXMsIG51bSk7CgkJCSAgfTsKCgkJCSAgLy8gUHJpbWUgbnVtYmVycyB3aXRoIGVmZmljaWVudCByZWR1Y3Rpb24KCQkJICB2YXIgcHJpbWVzID0gewoJCQkgICAgazI1NjogbnVsbCwKCQkJICAgIHAyMjQ6IG51bGwsCgkJCSAgICBwMTkyOiBudWxsLAoJCQkgICAgcDI1NTE5OiBudWxsCgkJCSAgfTsKCgkJCSAgLy8gUHNldWRvLU1lcnNlbm5lIHByaW1lCgkJCSAgZnVuY3Rpb24gTVByaW1lIChuYW1lLCBwKSB7CgkJCSAgICAvLyBQID0gMiBeIE4gLSBLCgkJCSAgICB0aGlzLm5hbWUgPSBuYW1lOwoJCQkgICAgdGhpcy5wID0gbmV3IEJOKHAsIDE2KTsKCQkJICAgIHRoaXMubiA9IHRoaXMucC5iaXRMZW5ndGgoKTsKCQkJICAgIHRoaXMuayA9IG5ldyBCTigxKS5pdXNobG4odGhpcy5uKS5pc3ViKHRoaXMucCk7CgoJCQkgICAgdGhpcy50bXAgPSB0aGlzLl90bXAoKTsKCQkJICB9CgoJCQkgIE1QcmltZS5wcm90b3R5cGUuX3RtcCA9IGZ1bmN0aW9uIF90bXAgKCkgewoJCQkgICAgdmFyIHRtcCA9IG5ldyBCTihudWxsKTsKCQkJICAgIHRtcC53b3JkcyA9IG5ldyBBcnJheShNYXRoLmNlaWwodGhpcy5uIC8gMTMpKTsKCQkJICAgIHJldHVybiB0bXA7CgkJCSAgfTsKCgkJCSAgTVByaW1lLnByb3RvdHlwZS5pcmVkdWNlID0gZnVuY3Rpb24gaXJlZHVjZSAobnVtKSB7CgkJCSAgICAvLyBBc3N1bWVzIHRoYXQgYG51bWAgaXMgbGVzcyB0aGFuIGBQXjJgCgkJCSAgICAvLyBudW0gPSBISSAqICgyIF4gTiAtIEspICsgSEkgKiBLICsgTE8gPSBISSAqIEsgKyBMTyAobW9kIFApCgkJCSAgICB2YXIgciA9IG51bTsKCQkJICAgIHZhciBybGVuOwoKCQkJICAgIGRvIHsKCQkJICAgICAgdGhpcy5zcGxpdChyLCB0aGlzLnRtcCk7CgkJCSAgICAgIHIgPSB0aGlzLmltdWxLKHIpOwoJCQkgICAgICByID0gci5pYWRkKHRoaXMudG1wKTsKCQkJICAgICAgcmxlbiA9IHIuYml0TGVuZ3RoKCk7CgkJCSAgICB9IHdoaWxlIChybGVuID4gdGhpcy5uKTsKCgkJCSAgICB2YXIgY21wID0gcmxlbiA8IHRoaXMubiA/IC0xIDogci51Y21wKHRoaXMucCk7CgkJCSAgICBpZiAoY21wID09PSAwKSB7CgkJCSAgICAgIHIud29yZHNbMF0gPSAwOwoJCQkgICAgICByLmxlbmd0aCA9IDE7CgkJCSAgICB9IGVsc2UgaWYgKGNtcCA+IDApIHsKCQkJICAgICAgci5pc3ViKHRoaXMucCk7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBpZiAoci5zdHJpcCAhPT0gdW5kZWZpbmVkKSB7CgkJCSAgICAgICAgLy8gciBpcyBhIEJOIHY0IGluc3RhbmNlCgkJCSAgICAgICAgci5zdHJpcCgpOwoJCQkgICAgICB9IGVsc2UgewoJCQkgICAgICAgIC8vIHIgaXMgYSBCTiB2NSBpbnN0YW5jZQoJCQkgICAgICAgIHIuX3N0cmlwKCk7CgkJCSAgICAgIH0KCQkJICAgIH0KCgkJCSAgICByZXR1cm4gcjsKCQkJICB9OwoKCQkJICBNUHJpbWUucHJvdG90eXBlLnNwbGl0ID0gZnVuY3Rpb24gc3BsaXQgKGlucHV0LCBvdXQpIHsKCQkJICAgIGlucHV0Lml1c2hybih0aGlzLm4sIDAsIG91dCk7CgkJCSAgfTsKCgkJCSAgTVByaW1lLnByb3RvdHlwZS5pbXVsSyA9IGZ1bmN0aW9uIGltdWxLIChudW0pIHsKCQkJICAgIHJldHVybiBudW0uaW11bCh0aGlzLmspOwoJCQkgIH07CgoJCQkgIGZ1bmN0aW9uIEsyNTYgKCkgewoJCQkgICAgTVByaW1lLmNhbGwoCgkJCSAgICAgIHRoaXMsCgkJCSAgICAgICdrMjU2JywKCQkJICAgICAgJ2ZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZlIGZmZmZmYzJmJyk7CgkJCSAgfQoJCQkgIGluaGVyaXRzKEsyNTYsIE1QcmltZSk7CgoJCQkgIEsyNTYucHJvdG90eXBlLnNwbGl0ID0gZnVuY3Rpb24gc3BsaXQgKGlucHV0LCBvdXRwdXQpIHsKCQkJICAgIC8vIDI1NiA9IDkgKiAyNiArIDIyCgkJCSAgICB2YXIgbWFzayA9IDB4M2ZmZmZmOwoKCQkJICAgIHZhciBvdXRMZW4gPSBNYXRoLm1pbihpbnB1dC5sZW5ndGgsIDkpOwoJCQkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvdXRMZW47IGkrKykgewoJCQkgICAgICBvdXRwdXQud29yZHNbaV0gPSBpbnB1dC53b3Jkc1tpXTsKCQkJICAgIH0KCQkJICAgIG91dHB1dC5sZW5ndGggPSBvdXRMZW47CgoJCQkgICAgaWYgKGlucHV0Lmxlbmd0aCA8PSA5KSB7CgkJCSAgICAgIGlucHV0LndvcmRzWzBdID0gMDsKCQkJICAgICAgaW5wdXQubGVuZ3RoID0gMTsKCQkJICAgICAgcmV0dXJuOwoJCQkgICAgfQoKCQkJICAgIC8vIFNoaWZ0IGJ5IDkgbGltYnMKCQkJICAgIHZhciBwcmV2ID0gaW5wdXQud29yZHNbOV07CgkJCSAgICBvdXRwdXQud29yZHNbb3V0cHV0Lmxlbmd0aCsrXSA9IHByZXYgJiBtYXNrOwoKCQkJICAgIGZvciAoaSA9IDEwOyBpIDwgaW5wdXQubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdmFyIG5leHQgPSBpbnB1dC53b3Jkc1tpXSB8IDA7CgkJCSAgICAgIGlucHV0LndvcmRzW2kgLSAxMF0gPSAoKG5leHQgJiBtYXNrKSA8PCA0KSB8IChwcmV2ID4+PiAyMik7CgkJCSAgICAgIHByZXYgPSBuZXh0OwoJCQkgICAgfQoJCQkgICAgcHJldiA+Pj49IDIyOwoJCQkgICAgaW5wdXQud29yZHNbaSAtIDEwXSA9IHByZXY7CgkJCSAgICBpZiAocHJldiA9PT0gMCAmJiBpbnB1dC5sZW5ndGggPiAxMCkgewoJCQkgICAgICBpbnB1dC5sZW5ndGggLT0gMTA7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBpbnB1dC5sZW5ndGggLT0gOTsKCQkJICAgIH0KCQkJICB9OwoKCQkJICBLMjU2LnByb3RvdHlwZS5pbXVsSyA9IGZ1bmN0aW9uIGltdWxLIChudW0pIHsKCQkJICAgIC8vIEsgPSAweDEwMDAwMDNkMSA9IFsgMHg0MCwgMHgzZDEgXQoJCQkgICAgbnVtLndvcmRzW251bS5sZW5ndGhdID0gMDsKCQkJICAgIG51bS53b3Jkc1tudW0ubGVuZ3RoICsgMV0gPSAwOwoJCQkgICAgbnVtLmxlbmd0aCArPSAyOwoKCQkJICAgIC8vIGJvdW5kZWQgYXQ6IDB4NDAgKiAweDNmZmZmZmYgKyAweDNkMCA9IDB4MTAwMDAwMzkwCgkJCSAgICB2YXIgbG8gPSAwOwoJCQkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW0ubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdmFyIHcgPSBudW0ud29yZHNbaV0gfCAwOwoJCQkgICAgICBsbyArPSB3ICogMHgzZDE7CgkJCSAgICAgIG51bS53b3Jkc1tpXSA9IGxvICYgMHgzZmZmZmZmOwoJCQkgICAgICBsbyA9IHcgKiAweDQwICsgKChsbyAvIDB4NDAwMDAwMCkgfCAwKTsKCQkJICAgIH0KCgkJCSAgICAvLyBGYXN0IGxlbmd0aCByZWR1Y3Rpb24KCQkJICAgIGlmIChudW0ud29yZHNbbnVtLmxlbmd0aCAtIDFdID09PSAwKSB7CgkJCSAgICAgIG51bS5sZW5ndGgtLTsKCQkJICAgICAgaWYgKG51bS53b3Jkc1tudW0ubGVuZ3RoIC0gMV0gPT09IDApIHsKCQkJICAgICAgICBudW0ubGVuZ3RoLS07CgkJCSAgICAgIH0KCQkJICAgIH0KCQkJICAgIHJldHVybiBudW07CgkJCSAgfTsKCgkJCSAgZnVuY3Rpb24gUDIyNCAoKSB7CgkJCSAgICBNUHJpbWUuY2FsbCgKCQkJICAgICAgdGhpcywKCQkJICAgICAgJ3AyMjQnLAoJCQkgICAgICAnZmZmZmZmZmYgZmZmZmZmZmYgZmZmZmZmZmYgZmZmZmZmZmYgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDEnKTsKCQkJICB9CgkJCSAgaW5oZXJpdHMoUDIyNCwgTVByaW1lKTsKCgkJCSAgZnVuY3Rpb24gUDE5MiAoKSB7CgkJCSAgICBNUHJpbWUuY2FsbCgKCQkJICAgICAgdGhpcywKCQkJICAgICAgJ3AxOTInLAoJCQkgICAgICAnZmZmZmZmZmYgZmZmZmZmZmYgZmZmZmZmZmYgZmZmZmZmZmUgZmZmZmZmZmYgZmZmZmZmZmYnKTsKCQkJICB9CgkJCSAgaW5oZXJpdHMoUDE5MiwgTVByaW1lKTsKCgkJCSAgZnVuY3Rpb24gUDI1NTE5ICgpIHsKCQkJICAgIC8vIDIgXiAyNTUgLSAxOQoJCQkgICAgTVByaW1lLmNhbGwoCgkJCSAgICAgIHRoaXMsCgkJCSAgICAgICcyNTUxOScsCgkJCSAgICAgICc3ZmZmZmZmZmZmZmZmZmZmIGZmZmZmZmZmZmZmZmZmZmYgZmZmZmZmZmZmZmZmZmZmZiBmZmZmZmZmZmZmZmZmZmVkJyk7CgkJCSAgfQoJCQkgIGluaGVyaXRzKFAyNTUxOSwgTVByaW1lKTsKCgkJCSAgUDI1NTE5LnByb3RvdHlwZS5pbXVsSyA9IGZ1bmN0aW9uIGltdWxLIChudW0pIHsKCQkJICAgIC8vIEsgPSAweDEzCgkJCSAgICB2YXIgY2FycnkgPSAwOwoJCQkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW0ubGVuZ3RoOyBpKyspIHsKCQkJICAgICAgdmFyIGhpID0gKG51bS53b3Jkc1tpXSB8IDApICogMHgxMyArIGNhcnJ5OwoJCQkgICAgICB2YXIgbG8gPSBoaSAmIDB4M2ZmZmZmZjsKCQkJICAgICAgaGkgPj4+PSAyNjsKCgkJCSAgICAgIG51bS53b3Jkc1tpXSA9IGxvOwoJCQkgICAgICBjYXJyeSA9IGhpOwoJCQkgICAgfQoJCQkgICAgaWYgKGNhcnJ5ICE9PSAwKSB7CgkJCSAgICAgIG51bS53b3Jkc1tudW0ubGVuZ3RoKytdID0gY2Fycnk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gbnVtOwoJCQkgIH07CgoJCQkgIC8vIEV4cG9ydGVkIG1vc3RseSBmb3IgdGVzdGluZyBwdXJwb3NlcywgdXNlIHBsYWluIG5hbWUgaW5zdGVhZAoJCQkgIEJOLl9wcmltZSA9IGZ1bmN0aW9uIHByaW1lIChuYW1lKSB7CgkJCSAgICAvLyBDYWNoZWQgdmVyc2lvbiBvZiBwcmltZQoJCQkgICAgaWYgKHByaW1lc1tuYW1lXSkgcmV0dXJuIHByaW1lc1tuYW1lXTsKCgkJCSAgICB2YXIgcHJpbWU7CgkJCSAgICBpZiAobmFtZSA9PT0gJ2syNTYnKSB7CgkJCSAgICAgIHByaW1lID0gbmV3IEsyNTYoKTsKCQkJICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ3AyMjQnKSB7CgkJCSAgICAgIHByaW1lID0gbmV3IFAyMjQoKTsKCQkJICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ3AxOTInKSB7CgkJCSAgICAgIHByaW1lID0gbmV3IFAxOTIoKTsKCQkJICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ3AyNTUxOScpIHsKCQkJICAgICAgcHJpbWUgPSBuZXcgUDI1NTE5KCk7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gcHJpbWUgJyArIG5hbWUpOwoJCQkgICAgfQoJCQkgICAgcHJpbWVzW25hbWVdID0gcHJpbWU7CgoJCQkgICAgcmV0dXJuIHByaW1lOwoJCQkgIH07CgoJCQkgIC8vCgkJCSAgLy8gQmFzZSByZWR1Y3Rpb24gZW5naW5lCgkJCSAgLy8KCQkJICBmdW5jdGlvbiBSZWQgKG0pIHsKCQkJICAgIGlmICh0eXBlb2YgbSA9PT0gJ3N0cmluZycpIHsKCQkJICAgICAgdmFyIHByaW1lID0gQk4uX3ByaW1lKG0pOwoJCQkgICAgICB0aGlzLm0gPSBwcmltZS5wOwoJCQkgICAgICB0aGlzLnByaW1lID0gcHJpbWU7CgkJCSAgICB9IGVsc2UgewoJCQkgICAgICBhc3NlcnQobS5ndG4oMSksICdtb2R1bHVzIG11c3QgYmUgZ3JlYXRlciB0aGFuIDEnKTsKCQkJICAgICAgdGhpcy5tID0gbTsKCQkJICAgICAgdGhpcy5wcmltZSA9IG51bGw7CgkJCSAgICB9CgkJCSAgfQoKCQkJICBSZWQucHJvdG90eXBlLl92ZXJpZnkxID0gZnVuY3Rpb24gX3ZlcmlmeTEgKGEpIHsKCQkJICAgIGFzc2VydChhLm5lZ2F0aXZlID09PSAwLCAncmVkIHdvcmtzIG9ubHkgd2l0aCBwb3NpdGl2ZXMnKTsKCQkJICAgIGFzc2VydChhLnJlZCwgJ3JlZCB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMnKTsKCQkJICB9OwoKCQkJICBSZWQucHJvdG90eXBlLl92ZXJpZnkyID0gZnVuY3Rpb24gX3ZlcmlmeTIgKGEsIGIpIHsKCQkJICAgIGFzc2VydCgoYS5uZWdhdGl2ZSB8IGIubmVnYXRpdmUpID09PSAwLCAncmVkIHdvcmtzIG9ubHkgd2l0aCBwb3NpdGl2ZXMnKTsKCQkJICAgIGFzc2VydChhLnJlZCAmJiBhLnJlZCA9PT0gYi5yZWQsCgkJCSAgICAgICdyZWQgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzJyk7CgkJCSAgfTsKCgkJCSAgUmVkLnByb3RvdHlwZS5pbW9kID0gZnVuY3Rpb24gaW1vZCAoYSkgewoJCQkgICAgaWYgKHRoaXMucHJpbWUpIHJldHVybiB0aGlzLnByaW1lLmlyZWR1Y2UoYSkuX2ZvcmNlUmVkKHRoaXMpOwoKCQkJICAgIG1vdmUoYSwgYS51bW9kKHRoaXMubSkuX2ZvcmNlUmVkKHRoaXMpKTsKCQkJICAgIHJldHVybiBhOwoJCQkgIH07CgoJCQkgIFJlZC5wcm90b3R5cGUubmVnID0gZnVuY3Rpb24gbmVnIChhKSB7CgkJCSAgICBpZiAoYS5pc1plcm8oKSkgewoJCQkgICAgICByZXR1cm4gYS5jbG9uZSgpOwoJCQkgICAgfQoKCQkJICAgIHJldHVybiB0aGlzLm0uc3ViKGEpLl9mb3JjZVJlZCh0aGlzKTsKCQkJICB9OwoKCQkJICBSZWQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZCAoYSwgYikgewoJCQkgICAgdGhpcy5fdmVyaWZ5MihhLCBiKTsKCgkJCSAgICB2YXIgcmVzID0gYS5hZGQoYik7CgkJCSAgICBpZiAocmVzLmNtcCh0aGlzLm0pID49IDApIHsKCQkJICAgICAgcmVzLmlzdWIodGhpcy5tKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXMuX2ZvcmNlUmVkKHRoaXMpOwoJCQkgIH07CgoJCQkgIFJlZC5wcm90b3R5cGUuaWFkZCA9IGZ1bmN0aW9uIGlhZGQgKGEsIGIpIHsKCQkJICAgIHRoaXMuX3ZlcmlmeTIoYSwgYik7CgoJCQkgICAgdmFyIHJlcyA9IGEuaWFkZChiKTsKCQkJICAgIGlmIChyZXMuY21wKHRoaXMubSkgPj0gMCkgewoJCQkgICAgICByZXMuaXN1Yih0aGlzLm0pOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJlczsKCQkJICB9OwoKCQkJICBSZWQucHJvdG90eXBlLnN1YiA9IGZ1bmN0aW9uIHN1YiAoYSwgYikgewoJCQkgICAgdGhpcy5fdmVyaWZ5MihhLCBiKTsKCgkJCSAgICB2YXIgcmVzID0gYS5zdWIoYik7CgkJCSAgICBpZiAocmVzLmNtcG4oMCkgPCAwKSB7CgkJCSAgICAgIHJlcy5pYWRkKHRoaXMubSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmVzLl9mb3JjZVJlZCh0aGlzKTsKCQkJICB9OwoKCQkJICBSZWQucHJvdG90eXBlLmlzdWIgPSBmdW5jdGlvbiBpc3ViIChhLCBiKSB7CgkJCSAgICB0aGlzLl92ZXJpZnkyKGEsIGIpOwoKCQkJICAgIHZhciByZXMgPSBhLmlzdWIoYik7CgkJCSAgICBpZiAocmVzLmNtcG4oMCkgPCAwKSB7CgkJCSAgICAgIHJlcy5pYWRkKHRoaXMubSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmVzOwoJCQkgIH07CgoJCQkgIFJlZC5wcm90b3R5cGUuc2hsID0gZnVuY3Rpb24gc2hsIChhLCBudW0pIHsKCQkJICAgIHRoaXMuX3ZlcmlmeTEoYSk7CgkJCSAgICByZXR1cm4gdGhpcy5pbW9kKGEudXNobG4obnVtKSk7CgkJCSAgfTsKCgkJCSAgUmVkLnByb3RvdHlwZS5pbXVsID0gZnVuY3Rpb24gaW11bCAoYSwgYikgewoJCQkgICAgdGhpcy5fdmVyaWZ5MihhLCBiKTsKCQkJICAgIHJldHVybiB0aGlzLmltb2QoYS5pbXVsKGIpKTsKCQkJICB9OwoKCQkJICBSZWQucHJvdG90eXBlLm11bCA9IGZ1bmN0aW9uIG11bCAoYSwgYikgewoJCQkgICAgdGhpcy5fdmVyaWZ5MihhLCBiKTsKCQkJICAgIHJldHVybiB0aGlzLmltb2QoYS5tdWwoYikpOwoJCQkgIH07CgoJCQkgIFJlZC5wcm90b3R5cGUuaXNxciA9IGZ1bmN0aW9uIGlzcXIgKGEpIHsKCQkJICAgIHJldHVybiB0aGlzLmltdWwoYSwgYS5jbG9uZSgpKTsKCQkJICB9OwoKCQkJICBSZWQucHJvdG90eXBlLnNxciA9IGZ1bmN0aW9uIHNxciAoYSkgewoJCQkgICAgcmV0dXJuIHRoaXMubXVsKGEsIGEpOwoJCQkgIH07CgoJCQkgIFJlZC5wcm90b3R5cGUuc3FydCA9IGZ1bmN0aW9uIHNxcnQgKGEpIHsKCQkJICAgIGlmIChhLmlzWmVybygpKSByZXR1cm4gYS5jbG9uZSgpOwoKCQkJICAgIHZhciBtb2QzID0gdGhpcy5tLmFuZGxuKDMpOwoJCQkgICAgYXNzZXJ0KG1vZDMgJSAyID09PSAxKTsKCgkJCSAgICAvLyBGYXN0IGNhc2UKCQkJICAgIGlmIChtb2QzID09PSAzKSB7CgkJCSAgICAgIHZhciBwb3cgPSB0aGlzLm0uYWRkKG5ldyBCTigxKSkuaXVzaHJuKDIpOwoJCQkgICAgICByZXR1cm4gdGhpcy5wb3coYSwgcG93KTsKCQkJICAgIH0KCgkJCSAgICAvLyBUb25lbGxpLVNoYW5rcyBhbGdvcml0aG0gKFRvdGFsbHkgdW5vcHRpbWl6ZWQgYW5kIHNsb3cpCgkJCSAgICAvLwoJCQkgICAgLy8gRmluZCBRIGFuZCBTLCB0aGF0IFEgKiAyIF4gUyA9IChQIC0gMSkKCQkJICAgIHZhciBxID0gdGhpcy5tLnN1Ym4oMSk7CgkJCSAgICB2YXIgcyA9IDA7CgkJCSAgICB3aGlsZSAoIXEuaXNaZXJvKCkgJiYgcS5hbmRsbigxKSA9PT0gMCkgewoJCQkgICAgICBzKys7CgkJCSAgICAgIHEuaXVzaHJuKDEpOwoJCQkgICAgfQoJCQkgICAgYXNzZXJ0KCFxLmlzWmVybygpKTsKCgkJCSAgICB2YXIgb25lID0gbmV3IEJOKDEpLnRvUmVkKHRoaXMpOwoJCQkgICAgdmFyIG5PbmUgPSBvbmUucmVkTmVnKCk7CgoJCQkgICAgLy8gRmluZCBxdWFkcmF0aWMgbm9uLXJlc2lkdWUKCQkJICAgIC8vIE5PVEU6IE1heCBpcyBzdWNoIGJlY2F1c2Ugb2YgZ2VuZXJhbGl6ZWQgUmllbWFubiBoeXBvdGhlc2lzLgoJCQkgICAgdmFyIGxwb3cgPSB0aGlzLm0uc3VibigxKS5pdXNocm4oMSk7CgkJCSAgICB2YXIgeiA9IHRoaXMubS5iaXRMZW5ndGgoKTsKCQkJICAgIHogPSBuZXcgQk4oMiAqIHogKiB6KS50b1JlZCh0aGlzKTsKCgkJCSAgICB3aGlsZSAodGhpcy5wb3coeiwgbHBvdykuY21wKG5PbmUpICE9PSAwKSB7CgkJCSAgICAgIHoucmVkSUFkZChuT25lKTsKCQkJICAgIH0KCgkJCSAgICB2YXIgYyA9IHRoaXMucG93KHosIHEpOwoJCQkgICAgdmFyIHIgPSB0aGlzLnBvdyhhLCBxLmFkZG4oMSkuaXVzaHJuKDEpKTsKCQkJICAgIHZhciB0ID0gdGhpcy5wb3coYSwgcSk7CgkJCSAgICB2YXIgbSA9IHM7CgkJCSAgICB3aGlsZSAodC5jbXAob25lKSAhPT0gMCkgewoJCQkgICAgICB2YXIgdG1wID0gdDsKCQkJICAgICAgZm9yICh2YXIgaSA9IDA7IHRtcC5jbXAob25lKSAhPT0gMDsgaSsrKSB7CgkJCSAgICAgICAgdG1wID0gdG1wLnJlZFNxcigpOwoJCQkgICAgICB9CgkJCSAgICAgIGFzc2VydChpIDwgbSk7CgkJCSAgICAgIHZhciBiID0gdGhpcy5wb3coYywgbmV3IEJOKDEpLml1c2hsbihtIC0gaSAtIDEpKTsKCgkJCSAgICAgIHIgPSByLnJlZE11bChiKTsKCQkJICAgICAgYyA9IGIucmVkU3FyKCk7CgkJCSAgICAgIHQgPSB0LnJlZE11bChjKTsKCQkJICAgICAgbSA9IGk7CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHI7CgkJCSAgfTsKCgkJCSAgUmVkLnByb3RvdHlwZS5pbnZtID0gZnVuY3Rpb24gaW52bSAoYSkgewoJCQkgICAgdmFyIGludiA9IGEuX2ludm1wKHRoaXMubSk7CgkJCSAgICBpZiAoaW52Lm5lZ2F0aXZlICE9PSAwKSB7CgkJCSAgICAgIGludi5uZWdhdGl2ZSA9IDA7CgkJCSAgICAgIHJldHVybiB0aGlzLmltb2QoaW52KS5yZWROZWcoKTsKCQkJICAgIH0gZWxzZSB7CgkJCSAgICAgIHJldHVybiB0aGlzLmltb2QoaW52KTsKCQkJICAgIH0KCQkJICB9OwoKCQkJICBSZWQucHJvdG90eXBlLnBvdyA9IGZ1bmN0aW9uIHBvdyAoYSwgbnVtKSB7CgkJCSAgICBpZiAobnVtLmlzWmVybygpKSByZXR1cm4gbmV3IEJOKDEpLnRvUmVkKHRoaXMpOwoJCQkgICAgaWYgKG51bS5jbXBuKDEpID09PSAwKSByZXR1cm4gYS5jbG9uZSgpOwoKCQkJICAgIHZhciB3aW5kb3dTaXplID0gNDsKCQkJICAgIHZhciB3bmQgPSBuZXcgQXJyYXkoMSA8PCB3aW5kb3dTaXplKTsKCQkJICAgIHduZFswXSA9IG5ldyBCTigxKS50b1JlZCh0aGlzKTsKCQkJICAgIHduZFsxXSA9IGE7CgkJCSAgICBmb3IgKHZhciBpID0gMjsgaSA8IHduZC5sZW5ndGg7IGkrKykgewoJCQkgICAgICB3bmRbaV0gPSB0aGlzLm11bCh3bmRbaSAtIDFdLCBhKTsKCQkJICAgIH0KCgkJCSAgICB2YXIgcmVzID0gd25kWzBdOwoJCQkgICAgdmFyIGN1cnJlbnQgPSAwOwoJCQkgICAgdmFyIGN1cnJlbnRMZW4gPSAwOwoJCQkgICAgdmFyIHN0YXJ0ID0gbnVtLmJpdExlbmd0aCgpICUgMjY7CgkJCSAgICBpZiAoc3RhcnQgPT09IDApIHsKCQkJICAgICAgc3RhcnQgPSAyNjsKCQkJICAgIH0KCgkJCSAgICBmb3IgKGkgPSBudW0ubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJICAgICAgdmFyIHdvcmQgPSBudW0ud29yZHNbaV07CgkJCSAgICAgIGZvciAodmFyIGogPSBzdGFydCAtIDE7IGogPj0gMDsgai0tKSB7CgkJCSAgICAgICAgdmFyIGJpdCA9ICh3b3JkID4+IGopICYgMTsKCQkJICAgICAgICBpZiAocmVzICE9PSB3bmRbMF0pIHsKCQkJICAgICAgICAgIHJlcyA9IHRoaXMuc3FyKHJlcyk7CgkJCSAgICAgICAgfQoKCQkJICAgICAgICBpZiAoYml0ID09PSAwICYmIGN1cnJlbnQgPT09IDApIHsKCQkJICAgICAgICAgIGN1cnJlbnRMZW4gPSAwOwoJCQkgICAgICAgICAgY29udGludWU7CgkJCSAgICAgICAgfQoKCQkJICAgICAgICBjdXJyZW50IDw8PSAxOwoJCQkgICAgICAgIGN1cnJlbnQgfD0gYml0OwoJCQkgICAgICAgIGN1cnJlbnRMZW4rKzsKCQkJICAgICAgICBpZiAoY3VycmVudExlbiAhPT0gd2luZG93U2l6ZSAmJiAoaSAhPT0gMCB8fCBqICE9PSAwKSkgY29udGludWU7CgoJCQkgICAgICAgIHJlcyA9IHRoaXMubXVsKHJlcywgd25kW2N1cnJlbnRdKTsKCQkJICAgICAgICBjdXJyZW50TGVuID0gMDsKCQkJICAgICAgICBjdXJyZW50ID0gMDsKCQkJICAgICAgfQoJCQkgICAgICBzdGFydCA9IDI2OwoJCQkgICAgfQoKCQkJICAgIHJldHVybiByZXM7CgkJCSAgfTsKCgkJCSAgUmVkLnByb3RvdHlwZS5jb252ZXJ0VG8gPSBmdW5jdGlvbiBjb252ZXJ0VG8gKG51bSkgewoJCQkgICAgdmFyIHIgPSBudW0udW1vZCh0aGlzLm0pOwoKCQkJICAgIHJldHVybiByID09PSBudW0gPyByLmNsb25lKCkgOiByOwoJCQkgIH07CgoJCQkgIFJlZC5wcm90b3R5cGUuY29udmVydEZyb20gPSBmdW5jdGlvbiBjb252ZXJ0RnJvbSAobnVtKSB7CgkJCSAgICB2YXIgcmVzID0gbnVtLmNsb25lKCk7CgkJCSAgICByZXMucmVkID0gbnVsbDsKCQkJICAgIHJldHVybiByZXM7CgkJCSAgfTsKCgkJCSAgLy8KCQkJICAvLyBNb250Z29tZXJ5IG1ldGhvZCBlbmdpbmUKCQkJICAvLwoKCQkJICBCTi5tb250ID0gZnVuY3Rpb24gbW9udCAobnVtKSB7CgkJCSAgICByZXR1cm4gbmV3IE1vbnQobnVtKTsKCQkJICB9OwoKCQkJICBmdW5jdGlvbiBNb250IChtKSB7CgkJCSAgICBSZWQuY2FsbCh0aGlzLCBtKTsKCgkJCSAgICB0aGlzLnNoaWZ0ID0gdGhpcy5tLmJpdExlbmd0aCgpOwoJCQkgICAgaWYgKHRoaXMuc2hpZnQgJSAyNiAhPT0gMCkgewoJCQkgICAgICB0aGlzLnNoaWZ0ICs9IDI2IC0gKHRoaXMuc2hpZnQgJSAyNik7CgkJCSAgICB9CgoJCQkgICAgdGhpcy5yID0gbmV3IEJOKDEpLml1c2hsbih0aGlzLnNoaWZ0KTsKCQkJICAgIHRoaXMucjIgPSB0aGlzLmltb2QodGhpcy5yLnNxcigpKTsKCQkJICAgIHRoaXMucmludiA9IHRoaXMuci5faW52bXAodGhpcy5tKTsKCgkJCSAgICB0aGlzLm1pbnYgPSB0aGlzLnJpbnYubXVsKHRoaXMucikuaXN1Ym4oMSkuZGl2KHRoaXMubSk7CgkJCSAgICB0aGlzLm1pbnYgPSB0aGlzLm1pbnYudW1vZCh0aGlzLnIpOwoJCQkgICAgdGhpcy5taW52ID0gdGhpcy5yLnN1Yih0aGlzLm1pbnYpOwoJCQkgIH0KCQkJICBpbmhlcml0cyhNb250LCBSZWQpOwoKCQkJICBNb250LnByb3RvdHlwZS5jb252ZXJ0VG8gPSBmdW5jdGlvbiBjb252ZXJ0VG8gKG51bSkgewoJCQkgICAgcmV0dXJuIHRoaXMuaW1vZChudW0udXNobG4odGhpcy5zaGlmdCkpOwoJCQkgIH07CgoJCQkgIE1vbnQucHJvdG90eXBlLmNvbnZlcnRGcm9tID0gZnVuY3Rpb24gY29udmVydEZyb20gKG51bSkgewoJCQkgICAgdmFyIHIgPSB0aGlzLmltb2QobnVtLm11bCh0aGlzLnJpbnYpKTsKCQkJICAgIHIucmVkID0gbnVsbDsKCQkJICAgIHJldHVybiByOwoJCQkgIH07CgoJCQkgIE1vbnQucHJvdG90eXBlLmltdWwgPSBmdW5jdGlvbiBpbXVsIChhLCBiKSB7CgkJCSAgICBpZiAoYS5pc1plcm8oKSB8fCBiLmlzWmVybygpKSB7CgkJCSAgICAgIGEud29yZHNbMF0gPSAwOwoJCQkgICAgICBhLmxlbmd0aCA9IDE7CgkJCSAgICAgIHJldHVybiBhOwoJCQkgICAgfQoKCQkJICAgIHZhciB0ID0gYS5pbXVsKGIpOwoJCQkgICAgdmFyIGMgPSB0Lm1hc2tuKHRoaXMuc2hpZnQpLm11bCh0aGlzLm1pbnYpLmltYXNrbih0aGlzLnNoaWZ0KS5tdWwodGhpcy5tKTsKCQkJICAgIHZhciB1ID0gdC5pc3ViKGMpLml1c2hybih0aGlzLnNoaWZ0KTsKCQkJICAgIHZhciByZXMgPSB1OwoKCQkJICAgIGlmICh1LmNtcCh0aGlzLm0pID49IDApIHsKCQkJICAgICAgcmVzID0gdS5pc3ViKHRoaXMubSk7CgkJCSAgICB9IGVsc2UgaWYgKHUuY21wbigwKSA8IDApIHsKCQkJICAgICAgcmVzID0gdS5pYWRkKHRoaXMubSk7CgkJCSAgICB9CgoJCQkgICAgcmV0dXJuIHJlcy5fZm9yY2VSZWQodGhpcyk7CgkJCSAgfTsKCgkJCSAgTW9udC5wcm90b3R5cGUubXVsID0gZnVuY3Rpb24gbXVsIChhLCBiKSB7CgkJCSAgICBpZiAoYS5pc1plcm8oKSB8fCBiLmlzWmVybygpKSByZXR1cm4gbmV3IEJOKDApLl9mb3JjZVJlZCh0aGlzKTsKCgkJCSAgICB2YXIgdCA9IGEubXVsKGIpOwoJCQkgICAgdmFyIGMgPSB0Lm1hc2tuKHRoaXMuc2hpZnQpLm11bCh0aGlzLm1pbnYpLmltYXNrbih0aGlzLnNoaWZ0KS5tdWwodGhpcy5tKTsKCQkJICAgIHZhciB1ID0gdC5pc3ViKGMpLml1c2hybih0aGlzLnNoaWZ0KTsKCQkJICAgIHZhciByZXMgPSB1OwoJCQkgICAgaWYgKHUuY21wKHRoaXMubSkgPj0gMCkgewoJCQkgICAgICByZXMgPSB1LmlzdWIodGhpcy5tKTsKCQkJICAgIH0gZWxzZSBpZiAodS5jbXBuKDApIDwgMCkgewoJCQkgICAgICByZXMgPSB1LmlhZGQodGhpcy5tKTsKCQkJICAgIH0KCgkJCSAgICByZXR1cm4gcmVzLl9mb3JjZVJlZCh0aGlzKTsKCQkJICB9OwoKCQkJICBNb250LnByb3RvdHlwZS5pbnZtID0gZnVuY3Rpb24gaW52bSAoYSkgewoJCQkgICAgLy8gKEFSKV4tMSAqIFJeMiA9IChBXi0xICogUl4tMSkgKiBSXjIgPSBBXi0xICogUgoJCQkgICAgdmFyIHJlcyA9IHRoaXMuaW1vZChhLl9pbnZtcCh0aGlzLm0pLm11bCh0aGlzLnIyKSk7CgkJCSAgICByZXR1cm4gcmVzLl9mb3JjZVJlZCh0aGlzKTsKCQkJICB9OwoJCQl9KShtb2R1bGUsIGJuKTsgCgkJfSAoYm4kMSkpOwoJCXJldHVybiBibiQxLmV4cG9ydHM7Cgl9CgoJdmFyIGJuRXhwb3J0cyA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUJuKCk7Cgl2YXIgQk4gPSAvKkBfX1BVUkVfXyovZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMoYm5FeHBvcnRzKTsKCgl2YXIgc2FmZUJ1ZmZlciA9IHtleHBvcnRzOiB7fX07CgoJLyohIHNhZmUtYnVmZmVyLiBNSVQgTGljZW5zZS4gRmVyb3NzIEFib3VraGFkaWplaCA8aHR0cHM6Ly9mZXJvc3Mub3JnL29wZW5zb3VyY2U+ICovCgoJdmFyIGhhc1JlcXVpcmVkU2FmZUJ1ZmZlcjsKCglmdW5jdGlvbiByZXF1aXJlU2FmZUJ1ZmZlciAoKSB7CgkJaWYgKGhhc1JlcXVpcmVkU2FmZUJ1ZmZlcikgcmV0dXJuIHNhZmVCdWZmZXIuZXhwb3J0czsKCQloYXNSZXF1aXJlZFNhZmVCdWZmZXIgPSAxOwoJCShmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CgkJCS8qIGVzbGludC1kaXNhYmxlIG5vZGUvbm8tZGVwcmVjYXRlZC1hcGkgKi8KCQkJdmFyIGJ1ZmZlciA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUJ1ZmZlcigpOwoJCQl2YXIgQnVmZmVyID0gYnVmZmVyLkJ1ZmZlcjsKCgkJCS8vIGFsdGVybmF0aXZlIHRvIHVzaW5nIE9iamVjdC5rZXlzIGZvciBvbGQgYnJvd3NlcnMKCQkJZnVuY3Rpb24gY29weVByb3BzIChzcmMsIGRzdCkgewoJCQkgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKCQkJICAgIGRzdFtrZXldID0gc3JjW2tleV07CgkJCSAgfQoJCQl9CgkJCWlmIChCdWZmZXIuZnJvbSAmJiBCdWZmZXIuYWxsb2MgJiYgQnVmZmVyLmFsbG9jVW5zYWZlICYmIEJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cpIHsKCQkJICBtb2R1bGUuZXhwb3J0cyA9IGJ1ZmZlcjsKCQkJfSBlbHNlIHsKCQkJICAvLyBDb3B5IHByb3BlcnRpZXMgZnJvbSByZXF1aXJlKCdidWZmZXInKQoJCQkgIGNvcHlQcm9wcyhidWZmZXIsIGV4cG9ydHMpOwoJCQkgIGV4cG9ydHMuQnVmZmVyID0gU2FmZUJ1ZmZlcjsKCQkJfQoKCQkJZnVuY3Rpb24gU2FmZUJ1ZmZlciAoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKCQkJICByZXR1cm4gQnVmZmVyKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQoJCQl9CgoJCQlTYWZlQnVmZmVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQnVmZmVyLnByb3RvdHlwZSk7CgoJCQkvLyBDb3B5IHN0YXRpYyBtZXRob2RzIGZyb20gQnVmZmVyCgkJCWNvcHlQcm9wcyhCdWZmZXIsIFNhZmVCdWZmZXIpOwoKCQkJU2FmZUJ1ZmZlci5mcm9tID0gZnVuY3Rpb24gKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CgkJCSAgaWYgKHR5cGVvZiBhcmcgPT09ICdudW1iZXInKSB7CgkJCSAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IG5vdCBiZSBhIG51bWJlcicpCgkJCSAgfQoJCQkgIHJldHVybiBCdWZmZXIoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCgkJCX07CgoJCQlTYWZlQnVmZmVyLmFsbG9jID0gZnVuY3Rpb24gKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CgkJCSAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykgewoJCQkgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpCgkJCSAgfQoJCQkgIHZhciBidWYgPSBCdWZmZXIoc2l6ZSk7CgkJCSAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCkgewoJCQkgICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycpIHsKCQkJICAgICAgYnVmLmZpbGwoZmlsbCwgZW5jb2RpbmcpOwoJCQkgICAgfSBlbHNlIHsKCQkJICAgICAgYnVmLmZpbGwoZmlsbCk7CgkJCSAgICB9CgkJCSAgfSBlbHNlIHsKCQkJICAgIGJ1Zi5maWxsKDApOwoJCQkgIH0KCQkJICByZXR1cm4gYnVmCgkJCX07CgoJCQlTYWZlQnVmZmVyLmFsbG9jVW5zYWZlID0gZnVuY3Rpb24gKHNpemUpIHsKCQkJICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CgkJCSAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgbnVtYmVyJykKCQkJICB9CgkJCSAgcmV0dXJuIEJ1ZmZlcihzaXplKQoJCQl9OwoKCQkJU2FmZUJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cgPSBmdW5jdGlvbiAoc2l6ZSkgewoJCQkgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKCQkJICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBudW1iZXInKQoJCQkgIH0KCQkJICByZXR1cm4gYnVmZmVyLlNsb3dCdWZmZXIoc2l6ZSkKCQkJfTsgCgkJfSAoc2FmZUJ1ZmZlciwgc2FmZUJ1ZmZlci5leHBvcnRzKSk7CgkJcmV0dXJuIHNhZmVCdWZmZXIuZXhwb3J0czsKCX0KCgl2YXIgc3JjOwoJdmFyIGhhc1JlcXVpcmVkU3JjOwoKCWZ1bmN0aW9uIHJlcXVpcmVTcmMgKCkgewoJCWlmIChoYXNSZXF1aXJlZFNyYykgcmV0dXJuIHNyYzsKCQloYXNSZXF1aXJlZFNyYyA9IDE7CgkJLy8gYmFzZS14IGVuY29kaW5nIC8gZGVjb2RpbmcKCQkvLyBDb3B5cmlnaHQgKGMpIDIwMTggYmFzZS14IGNvbnRyaWJ1dG9ycwoJCS8vIENvcHlyaWdodCAoYykgMjAxNC0yMDE4IFRoZSBCaXRjb2luIENvcmUgZGV2ZWxvcGVycyAoYmFzZTU4LmNwcCkKCQkvLyBEaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIHNvZnR3YXJlIGxpY2Vuc2UsIHNlZSB0aGUgYWNjb21wYW55aW5nCgkJLy8gZmlsZSBMSUNFTlNFIG9yIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwLgoJCS8vIEB0cy1pZ25vcmUKCQl2YXIgX0J1ZmZlciA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZVNhZmVCdWZmZXIoKS5CdWZmZXI7CgkJZnVuY3Rpb24gYmFzZSAoQUxQSEFCRVQpIHsKCQkgIGlmIChBTFBIQUJFVC5sZW5ndGggPj0gMjU1KSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0FscGhhYmV0IHRvbyBsb25nJykgfQoJCSAgdmFyIEJBU0VfTUFQID0gbmV3IFVpbnQ4QXJyYXkoMjU2KTsKCQkgIGZvciAodmFyIGogPSAwOyBqIDwgQkFTRV9NQVAubGVuZ3RoOyBqKyspIHsKCQkgICAgQkFTRV9NQVBbal0gPSAyNTU7CgkJICB9CgkJICBmb3IgKHZhciBpID0gMDsgaSA8IEFMUEhBQkVULmxlbmd0aDsgaSsrKSB7CgkJICAgIHZhciB4ID0gQUxQSEFCRVQuY2hhckF0KGkpOwoJCSAgICB2YXIgeGMgPSB4LmNoYXJDb2RlQXQoMCk7CgkJICAgIGlmIChCQVNFX01BUFt4Y10gIT09IDI1NSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKHggKyAnIGlzIGFtYmlndW91cycpIH0KCQkgICAgQkFTRV9NQVBbeGNdID0gaTsKCQkgIH0KCQkgIHZhciBCQVNFID0gQUxQSEFCRVQubGVuZ3RoOwoJCSAgdmFyIExFQURFUiA9IEFMUEhBQkVULmNoYXJBdCgwKTsKCQkgIHZhciBGQUNUT1IgPSBNYXRoLmxvZyhCQVNFKSAvIE1hdGgubG9nKDI1Nik7IC8vIGxvZyhCQVNFKSAvIGxvZygyNTYpLCByb3VuZGVkIHVwCgkJICB2YXIgaUZBQ1RPUiA9IE1hdGgubG9nKDI1NikgLyBNYXRoLmxvZyhCQVNFKTsgLy8gbG9nKDI1NikgLyBsb2coQkFTRSksIHJvdW5kZWQgdXAKCQkgIGZ1bmN0aW9uIGVuY29kZSAoc291cmNlKSB7CgkJICAgIGlmIChBcnJheS5pc0FycmF5KHNvdXJjZSkgfHwgc291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSkgeyBzb3VyY2UgPSBfQnVmZmVyLmZyb20oc291cmNlKTsgfQoJCSAgICBpZiAoIV9CdWZmZXIuaXNCdWZmZXIoc291cmNlKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdFeHBlY3RlZCBCdWZmZXInKSB9CgkJICAgIGlmIChzb3VyY2UubGVuZ3RoID09PSAwKSB7IHJldHVybiAnJyB9CgkJICAgICAgICAvLyBTa2lwICYgY291bnQgbGVhZGluZyB6ZXJvZXMuCgkJICAgIHZhciB6ZXJvZXMgPSAwOwoJCSAgICB2YXIgbGVuZ3RoID0gMDsKCQkgICAgdmFyIHBiZWdpbiA9IDA7CgkJICAgIHZhciBwZW5kID0gc291cmNlLmxlbmd0aDsKCQkgICAgd2hpbGUgKHBiZWdpbiAhPT0gcGVuZCAmJiBzb3VyY2VbcGJlZ2luXSA9PT0gMCkgewoJCSAgICAgIHBiZWdpbisrOwoJCSAgICAgIHplcm9lcysrOwoJCSAgICB9CgkJICAgICAgICAvLyBBbGxvY2F0ZSBlbm91Z2ggc3BhY2UgaW4gYmlnLWVuZGlhbiBiYXNlNTggcmVwcmVzZW50YXRpb24uCgkJICAgIHZhciBzaXplID0gKChwZW5kIC0gcGJlZ2luKSAqIGlGQUNUT1IgKyAxKSA+Pj4gMDsKCQkgICAgdmFyIGI1OCA9IG5ldyBVaW50OEFycmF5KHNpemUpOwoJCSAgICAgICAgLy8gUHJvY2VzcyB0aGUgYnl0ZXMuCgkJICAgIHdoaWxlIChwYmVnaW4gIT09IHBlbmQpIHsKCQkgICAgICB2YXIgY2FycnkgPSBzb3VyY2VbcGJlZ2luXTsKCQkgICAgICAgICAgICAvLyBBcHBseSAiYjU4ID0gYjU4ICogMjU2ICsgY2giLgoJCSAgICAgIHZhciBpID0gMDsKCQkgICAgICBmb3IgKHZhciBpdDEgPSBzaXplIC0gMTsgKGNhcnJ5ICE9PSAwIHx8IGkgPCBsZW5ndGgpICYmIChpdDEgIT09IC0xKTsgaXQxLS0sIGkrKykgewoJCSAgICAgICAgY2FycnkgKz0gKDI1NiAqIGI1OFtpdDFdKSA+Pj4gMDsKCQkgICAgICAgIGI1OFtpdDFdID0gKGNhcnJ5ICUgQkFTRSkgPj4+IDA7CgkJICAgICAgICBjYXJyeSA9IChjYXJyeSAvIEJBU0UpID4+PiAwOwoJCSAgICAgIH0KCQkgICAgICBpZiAoY2FycnkgIT09IDApIHsgdGhyb3cgbmV3IEVycm9yKCdOb24temVybyBjYXJyeScpIH0KCQkgICAgICBsZW5ndGggPSBpOwoJCSAgICAgIHBiZWdpbisrOwoJCSAgICB9CgkJICAgICAgICAvLyBTa2lwIGxlYWRpbmcgemVyb2VzIGluIGJhc2U1OCByZXN1bHQuCgkJICAgIHZhciBpdDIgPSBzaXplIC0gbGVuZ3RoOwoJCSAgICB3aGlsZSAoaXQyICE9PSBzaXplICYmIGI1OFtpdDJdID09PSAwKSB7CgkJICAgICAgaXQyKys7CgkJICAgIH0KCQkgICAgICAgIC8vIFRyYW5zbGF0ZSB0aGUgcmVzdWx0IGludG8gYSBzdHJpbmcuCgkJICAgIHZhciBzdHIgPSBMRUFERVIucmVwZWF0KHplcm9lcyk7CgkJICAgIGZvciAoOyBpdDIgPCBzaXplOyArK2l0MikgeyBzdHIgKz0gQUxQSEFCRVQuY2hhckF0KGI1OFtpdDJdKTsgfQoJCSAgICByZXR1cm4gc3RyCgkJICB9CgkJICBmdW5jdGlvbiBkZWNvZGVVbnNhZmUgKHNvdXJjZSkgewoJCSAgICBpZiAodHlwZW9mIHNvdXJjZSAhPT0gJ3N0cmluZycpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgU3RyaW5nJykgfQoJCSAgICBpZiAoc291cmNlLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gX0J1ZmZlci5hbGxvYygwKSB9CgkJICAgIHZhciBwc3ogPSAwOwoJCSAgICAgICAgLy8gU2tpcCBhbmQgY291bnQgbGVhZGluZyAnMSdzLgoJCSAgICB2YXIgemVyb2VzID0gMDsKCQkgICAgdmFyIGxlbmd0aCA9IDA7CgkJICAgIHdoaWxlIChzb3VyY2VbcHN6XSA9PT0gTEVBREVSKSB7CgkJICAgICAgemVyb2VzKys7CgkJICAgICAgcHN6Kys7CgkJICAgIH0KCQkgICAgICAgIC8vIEFsbG9jYXRlIGVub3VnaCBzcGFjZSBpbiBiaWctZW5kaWFuIGJhc2UyNTYgcmVwcmVzZW50YXRpb24uCgkJICAgIHZhciBzaXplID0gKCgoc291cmNlLmxlbmd0aCAtIHBzeikgKiBGQUNUT1IpICsgMSkgPj4+IDA7IC8vIGxvZyg1OCkgLyBsb2coMjU2KSwgcm91bmRlZCB1cC4KCQkgICAgdmFyIGIyNTYgPSBuZXcgVWludDhBcnJheShzaXplKTsKCQkgICAgICAgIC8vIFByb2Nlc3MgdGhlIGNoYXJhY3RlcnMuCgkJICAgIHdoaWxlIChzb3VyY2VbcHN6XSkgewoJCSAgICAgICAgICAgIC8vIERlY29kZSBjaGFyYWN0ZXIKCQkgICAgICB2YXIgY2FycnkgPSBCQVNFX01BUFtzb3VyY2UuY2hhckNvZGVBdChwc3opXTsKCQkgICAgICAgICAgICAvLyBJbnZhbGlkIGNoYXJhY3RlcgoJCSAgICAgIGlmIChjYXJyeSA9PT0gMjU1KSB7IHJldHVybiB9CgkJICAgICAgdmFyIGkgPSAwOwoJCSAgICAgIGZvciAodmFyIGl0MyA9IHNpemUgLSAxOyAoY2FycnkgIT09IDAgfHwgaSA8IGxlbmd0aCkgJiYgKGl0MyAhPT0gLTEpOyBpdDMtLSwgaSsrKSB7CgkJICAgICAgICBjYXJyeSArPSAoQkFTRSAqIGIyNTZbaXQzXSkgPj4+IDA7CgkJICAgICAgICBiMjU2W2l0M10gPSAoY2FycnkgJSAyNTYpID4+PiAwOwoJCSAgICAgICAgY2FycnkgPSAoY2FycnkgLyAyNTYpID4+PiAwOwoJCSAgICAgIH0KCQkgICAgICBpZiAoY2FycnkgIT09IDApIHsgdGhyb3cgbmV3IEVycm9yKCdOb24temVybyBjYXJyeScpIH0KCQkgICAgICBsZW5ndGggPSBpOwoJCSAgICAgIHBzeisrOwoJCSAgICB9CgkJICAgICAgICAvLyBTa2lwIGxlYWRpbmcgemVyb2VzIGluIGIyNTYuCgkJICAgIHZhciBpdDQgPSBzaXplIC0gbGVuZ3RoOwoJCSAgICB3aGlsZSAoaXQ0ICE9PSBzaXplICYmIGIyNTZbaXQ0XSA9PT0gMCkgewoJCSAgICAgIGl0NCsrOwoJCSAgICB9CgkJICAgIHZhciB2Y2ggPSBfQnVmZmVyLmFsbG9jVW5zYWZlKHplcm9lcyArIChzaXplIC0gaXQ0KSk7CgkJICAgIHZjaC5maWxsKDB4MDAsIDAsIHplcm9lcyk7CgkJICAgIHZhciBqID0gemVyb2VzOwoJCSAgICB3aGlsZSAoaXQ0ICE9PSBzaXplKSB7CgkJICAgICAgdmNoW2orK10gPSBiMjU2W2l0NCsrXTsKCQkgICAgfQoJCSAgICByZXR1cm4gdmNoCgkJICB9CgkJICBmdW5jdGlvbiBkZWNvZGUgKHN0cmluZykgewoJCSAgICB2YXIgYnVmZmVyID0gZGVjb2RlVW5zYWZlKHN0cmluZyk7CgkJICAgIGlmIChidWZmZXIpIHsgcmV0dXJuIGJ1ZmZlciB9CgkJICAgIHRocm93IG5ldyBFcnJvcignTm9uLWJhc2UnICsgQkFTRSArICcgY2hhcmFjdGVyJykKCQkgIH0KCQkgIHJldHVybiB7CgkJICAgIGVuY29kZTogZW5jb2RlLAoJCSAgICBkZWNvZGVVbnNhZmU6IGRlY29kZVVuc2FmZSwKCQkgICAgZGVjb2RlOiBkZWNvZGUKCQkgIH0KCQl9CgkJc3JjID0gYmFzZTsKCQlyZXR1cm4gc3JjOwoJfQoKCXZhciBiczU4JDE7Cgl2YXIgaGFzUmVxdWlyZWRCczU4OwoKCWZ1bmN0aW9uIHJlcXVpcmVCczU4ICgpIHsKCQlpZiAoaGFzUmVxdWlyZWRCczU4KSByZXR1cm4gYnM1OCQxOwoJCWhhc1JlcXVpcmVkQnM1OCA9IDE7CgkJdmFyIGJhc2V4ID0gLypAX19QVVJFX18qLyByZXF1aXJlU3JjKCk7CgkJdmFyIEFMUEhBQkVUID0gJzEyMzQ1Njc4OUFCQ0RFRkdISktMTU5QUVJTVFVWV1hZWmFiY2RlZmdoaWprbW5vcHFyc3R1dnd4eXonOwoKCQliczU4JDEgPSBiYXNleChBTFBIQUJFVCk7CgkJcmV0dXJuIGJzNTgkMTsKCX0KCgl2YXIgYnM1OEV4cG9ydHMgPSAvKkBfX1BVUkVfXyovIHJlcXVpcmVCczU4KCk7Cgl2YXIgYnM1OCA9IC8qQF9fUFVSRV9fKi9nZXREZWZhdWx0RXhwb3J0RnJvbUNqcyhiczU4RXhwb3J0cyk7CgoJZnVuY3Rpb24gYW51bWJlcihuKSB7CgkgICAgaWYgKCFOdW1iZXIuaXNTYWZlSW50ZWdlcihuKSB8fCBuIDwgMCkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwb3NpdGl2ZSBpbnRlZ2VyIGV4cGVjdGVkLCBnb3QgJyArIG4pOwoJfQoJLy8gY29waWVkIGZyb20gdXRpbHMKCWZ1bmN0aW9uIGlzQnl0ZXMoYSkgewoJICAgIHJldHVybiBhIGluc3RhbmNlb2YgVWludDhBcnJheSB8fCAoQXJyYXlCdWZmZXIuaXNWaWV3KGEpICYmIGEuY29uc3RydWN0b3IubmFtZSA9PT0gJ1VpbnQ4QXJyYXknKTsKCX0KCWZ1bmN0aW9uIGFieXRlcyhiLCAuLi5sZW5ndGhzKSB7CgkgICAgaWYgKCFpc0J5dGVzKGIpKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VpbnQ4QXJyYXkgZXhwZWN0ZWQnKTsKCSAgICBpZiAobGVuZ3Rocy5sZW5ndGggPiAwICYmICFsZW5ndGhzLmluY2x1ZGVzKGIubGVuZ3RoKSkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVaW50OEFycmF5IGV4cGVjdGVkIG9mIGxlbmd0aCAnICsgbGVuZ3RocyArICcsIGdvdCBsZW5ndGg9JyArIGIubGVuZ3RoKTsKCX0KCWZ1bmN0aW9uIGFleGlzdHMoaW5zdGFuY2UsIGNoZWNrRmluaXNoZWQgPSB0cnVlKSB7CgkgICAgaWYgKGluc3RhbmNlLmRlc3Ryb3llZCkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdIYXNoIGluc3RhbmNlIGhhcyBiZWVuIGRlc3Ryb3llZCcpOwoJICAgIGlmIChjaGVja0ZpbmlzaGVkICYmIGluc3RhbmNlLmZpbmlzaGVkKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hhc2gjZGlnZXN0KCkgaGFzIGFscmVhZHkgYmVlbiBjYWxsZWQnKTsKCX0KCWZ1bmN0aW9uIGFvdXRwdXQob3V0LCBpbnN0YW5jZSkgewoJICAgIGFieXRlcyhvdXQpOwoJICAgIGNvbnN0IG1pbiA9IGluc3RhbmNlLm91dHB1dExlbjsKCSAgICBpZiAob3V0Lmxlbmd0aCA8IG1pbikgewoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2RpZ2VzdEludG8oKSBleHBlY3RzIG91dHB1dCBidWZmZXIgb2YgbGVuZ3RoIGF0IGxlYXN0ICcgKyBtaW4pOwoJICAgIH0KCX0KCgkvKiEgbm9ibGUtaGFzaGVzIC0gTUlUIExpY2Vuc2UgKGMpIDIwMjIgUGF1bCBNaWxsZXIgKHBhdWxtaWxsci5jb20pICovCgkvLyBXZSB1c2UgV2ViQ3J5cHRvIGFrYSBnbG9iYWxUaGlzLmNyeXB0bywgd2hpY2ggZXhpc3RzIGluIGJyb3dzZXJzIGFuZCBub2RlLmpzIDE2Ky4KCS8vIG5vZGUuanMgdmVyc2lvbnMgZWFybGllciB0aGFuIHYxOSBkb24ndCBkZWNsYXJlIGl0IGluIGdsb2JhbCBzY29wZS4KCS8vIEZvciBub2RlLmpzLCBwYWNrYWdlLmpzb24jZXhwb3J0cyBmaWVsZCBtYXBwaW5nIHJld3JpdGVzIGltcG9ydAoJLy8gZnJvbSBgY3J5cHRvYCB0byBgY3J5cHRvTm9kZWAsIHdoaWNoIGltcG9ydHMgbmF0aXZlIG1vZHVsZS4KCS8vIE1ha2VzIHRoZSB1dGlscyB1bi1pbXBvcnRhYmxlIGluIGJyb3dzZXJzIHdpdGhvdXQgYSBidW5kbGVyLgoJLy8gT25jZSBub2RlLmpzIDE4IGlzIGRlcHJlY2F0ZWQgKDIwMjUtMDQtMzApLCB3ZSBjYW4ganVzdCBkcm9wIHRoZSBpbXBvcnQuCgljb25zdCB1MzIgPSAoYXJyKSA9PiBuZXcgVWludDMyQXJyYXkoYXJyLmJ1ZmZlciwgYXJyLmJ5dGVPZmZzZXQsIE1hdGguZmxvb3IoYXJyLmJ5dGVMZW5ndGggLyA0KSk7CgkvLyBDYXN0IGFycmF5IHRvIHZpZXcKCWNvbnN0IGNyZWF0ZVZpZXcgPSAoYXJyKSA9PiBuZXcgRGF0YVZpZXcoYXJyLmJ1ZmZlciwgYXJyLmJ5dGVPZmZzZXQsIGFyci5ieXRlTGVuZ3RoKTsKCS8vIFRoZSByb3RhdGUgcmlnaHQgKGNpcmN1bGFyIHJpZ2h0IHNoaWZ0KSBvcGVyYXRpb24gZm9yIHVpbnQzMgoJY29uc3Qgcm90ciA9ICh3b3JkLCBzaGlmdCkgPT4gKHdvcmQgPDwgKDMyIC0gc2hpZnQpKSB8ICh3b3JkID4+PiBzaGlmdCk7Cgljb25zdCBpc0xFID0gLyogQF9fUFVSRV9fICovICgoKSA9PiBuZXcgVWludDhBcnJheShuZXcgVWludDMyQXJyYXkoWzB4MTEyMjMzNDRdKS5idWZmZXIpWzBdID09PSAweDQ0KSgpOwoJLy8gVGhlIGJ5dGUgc3dhcCBvcGVyYXRpb24gZm9yIHVpbnQzMgoJY29uc3QgYnl0ZVN3YXAgPSAod29yZCkgPT4gKCh3b3JkIDw8IDI0KSAmIDB4ZmYwMDAwMDApIHwKCSAgICAoKHdvcmQgPDwgOCkgJiAweGZmMDAwMCkgfAoJICAgICgod29yZCA+Pj4gOCkgJiAweGZmMDApIHwKCSAgICAoKHdvcmQgPj4+IDI0KSAmIDB4ZmYpOwoJLy8gSW4gcGxhY2UgYnl0ZSBzd2FwIGZvciBVaW50MzJBcnJheQoJZnVuY3Rpb24gYnl0ZVN3YXAzMihhcnIpIHsKCSAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewoJICAgICAgICBhcnJbaV0gPSBieXRlU3dhcChhcnJbaV0pOwoJICAgIH0KCX0KCS8qKgoJICogQGV4YW1wbGUgdXRmOFRvQnl0ZXMoJ2FiYycpIC8vIG5ldyBVaW50OEFycmF5KFs5NywgOTgsIDk5XSkKCSAqLwoJZnVuY3Rpb24gdXRmOFRvQnl0ZXMoc3RyKSB7CgkgICAgaWYgKHR5cGVvZiBzdHIgIT09ICdzdHJpbmcnKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3V0ZjhUb0J5dGVzIGV4cGVjdGVkIHN0cmluZywgZ290ICcgKyB0eXBlb2Ygc3RyKTsKCSAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkobmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cikpOyAvLyBodHRwczovL2J1Z3ppbC5sYS8xNjgxODA5Cgl9CgkvKioKCSAqIE5vcm1hbGl6ZXMgKG5vbi1oZXgpIHN0cmluZyBvciBVaW50OEFycmF5IHRvIFVpbnQ4QXJyYXkuCgkgKiBXYXJuaW5nOiB3aGVuIFVpbnQ4QXJyYXkgaXMgcGFzc2VkLCBpdCB3b3VsZCBOT1QgZ2V0IGNvcGllZC4KCSAqIEtlZXAgaW4gbWluZCBmb3IgZnV0dXJlIG11dGFibGUgb3BlcmF0aW9ucy4KCSAqLwoJZnVuY3Rpb24gdG9CeXRlcyhkYXRhKSB7CgkgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykKCSAgICAgICAgZGF0YSA9IHV0ZjhUb0J5dGVzKGRhdGEpOwoJICAgIGFieXRlcyhkYXRhKTsKCSAgICByZXR1cm4gZGF0YTsKCX0KCS8vIEZvciBydW50aW1lIGNoZWNrIGlmIGNsYXNzIGltcGxlbWVudHMgaW50ZXJmYWNlCgljbGFzcyBIYXNoIHsKCSAgICAvLyBTYWZlIHZlcnNpb24gdGhhdCBjbG9uZXMgaW50ZXJuYWwgc3RhdGUKCSAgICBjbG9uZSgpIHsKCSAgICAgICAgcmV0dXJuIHRoaXMuX2Nsb25lSW50bygpOwoJICAgIH0KCX0KCWZ1bmN0aW9uIHdyYXBDb25zdHJ1Y3RvcihoYXNoQ29ucykgewoJICAgIGNvbnN0IGhhc2hDID0gKG1zZykgPT4gaGFzaENvbnMoKS51cGRhdGUodG9CeXRlcyhtc2cpKS5kaWdlc3QoKTsKCSAgICBjb25zdCB0bXAgPSBoYXNoQ29ucygpOwoJICAgIGhhc2hDLm91dHB1dExlbiA9IHRtcC5vdXRwdXRMZW47CgkgICAgaGFzaEMuYmxvY2tMZW4gPSB0bXAuYmxvY2tMZW47CgkgICAgaGFzaEMuY3JlYXRlID0gKCkgPT4gaGFzaENvbnMoKTsKCSAgICByZXR1cm4gaGFzaEM7Cgl9CgoJLyoqCgkgKiBQb2x5ZmlsbCBmb3IgU2FmYXJpIDE0CgkgKi8KCWZ1bmN0aW9uIHNldEJpZ1VpbnQ2NCh2aWV3LCBieXRlT2Zmc2V0LCB2YWx1ZSwgaXNMRSkgewoJICAgIGlmICh0eXBlb2Ygdmlldy5zZXRCaWdVaW50NjQgPT09ICdmdW5jdGlvbicpCgkgICAgICAgIHJldHVybiB2aWV3LnNldEJpZ1VpbnQ2NChieXRlT2Zmc2V0LCB2YWx1ZSwgaXNMRSk7CgkgICAgY29uc3QgXzMybiA9IEJpZ0ludCgzMik7CgkgICAgY29uc3QgX3UzMl9tYXggPSBCaWdJbnQoMHhmZmZmZmZmZik7CgkgICAgY29uc3Qgd2ggPSBOdW1iZXIoKHZhbHVlID4+IF8zMm4pICYgX3UzMl9tYXgpOwoJICAgIGNvbnN0IHdsID0gTnVtYmVyKHZhbHVlICYgX3UzMl9tYXgpOwoJICAgIGNvbnN0IGggPSBpc0xFID8gNCA6IDA7CgkgICAgY29uc3QgbCA9IGlzTEUgPyAwIDogNDsKCSAgICB2aWV3LnNldFVpbnQzMihieXRlT2Zmc2V0ICsgaCwgd2gsIGlzTEUpOwoJICAgIHZpZXcuc2V0VWludDMyKGJ5dGVPZmZzZXQgKyBsLCB3bCwgaXNMRSk7Cgl9CgkvKioKCSAqIENob2ljZTogYSA/IGIgOiBjCgkgKi8KCWNvbnN0IENoaSA9IChhLCBiLCBjKSA9PiAoYSAmIGIpIF4gKH5hICYgYyk7CgkvKioKCSAqIE1ham9yaXR5IGZ1bmN0aW9uLCB0cnVlIGlmIGFueSB0d28gaW5wdXRzIGlzIHRydWUKCSAqLwoJY29uc3QgTWFqID0gKGEsIGIsIGMpID0+IChhICYgYikgXiAoYSAmIGMpIF4gKGIgJiBjKTsKCS8qKgoJICogTWVya2xlLURhbWdhcmQgaGFzaCBjb25zdHJ1Y3Rpb24gYmFzZSBjbGFzcy4KCSAqIENvdWxkIGJlIHVzZWQgdG8gY3JlYXRlIE1ENSwgUklQRU1ELCBTSEExLCBTSEEyLgoJICovCgljbGFzcyBIYXNoTUQgZXh0ZW5kcyBIYXNoIHsKCSAgICBjb25zdHJ1Y3RvcihibG9ja0xlbiwgb3V0cHV0TGVuLCBwYWRPZmZzZXQsIGlzTEUpIHsKCSAgICAgICAgc3VwZXIoKTsKCSAgICAgICAgdGhpcy5ibG9ja0xlbiA9IGJsb2NrTGVuOwoJICAgICAgICB0aGlzLm91dHB1dExlbiA9IG91dHB1dExlbjsKCSAgICAgICAgdGhpcy5wYWRPZmZzZXQgPSBwYWRPZmZzZXQ7CgkgICAgICAgIHRoaXMuaXNMRSA9IGlzTEU7CgkgICAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKCSAgICAgICAgdGhpcy5sZW5ndGggPSAwOwoJICAgICAgICB0aGlzLnBvcyA9IDA7CgkgICAgICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2U7CgkgICAgICAgIHRoaXMuYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoYmxvY2tMZW4pOwoJICAgICAgICB0aGlzLnZpZXcgPSBjcmVhdGVWaWV3KHRoaXMuYnVmZmVyKTsKCSAgICB9CgkgICAgdXBkYXRlKGRhdGEpIHsKCSAgICAgICAgYWV4aXN0cyh0aGlzKTsKCSAgICAgICAgY29uc3QgeyB2aWV3LCBidWZmZXIsIGJsb2NrTGVuIH0gPSB0aGlzOwoJICAgICAgICBkYXRhID0gdG9CeXRlcyhkYXRhKTsKCSAgICAgICAgY29uc3QgbGVuID0gZGF0YS5sZW5ndGg7CgkgICAgICAgIGZvciAobGV0IHBvcyA9IDA7IHBvcyA8IGxlbjspIHsKCSAgICAgICAgICAgIGNvbnN0IHRha2UgPSBNYXRoLm1pbihibG9ja0xlbiAtIHRoaXMucG9zLCBsZW4gLSBwb3MpOwoJICAgICAgICAgICAgLy8gRmFzdCBwYXRoOiB3ZSBoYXZlIGF0IGxlYXN0IG9uZSBibG9jayBpbiBpbnB1dCwgY2FzdCBpdCB0byB2aWV3IGFuZCBwcm9jZXNzCgkgICAgICAgICAgICBpZiAodGFrZSA9PT0gYmxvY2tMZW4pIHsKCSAgICAgICAgICAgICAgICBjb25zdCBkYXRhVmlldyA9IGNyZWF0ZVZpZXcoZGF0YSk7CgkgICAgICAgICAgICAgICAgZm9yICg7IGJsb2NrTGVuIDw9IGxlbiAtIHBvczsgcG9zICs9IGJsb2NrTGVuKQoJICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3MoZGF0YVZpZXcsIHBvcyk7CgkgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBidWZmZXIuc2V0KGRhdGEuc3ViYXJyYXkocG9zLCBwb3MgKyB0YWtlKSwgdGhpcy5wb3MpOwoJICAgICAgICAgICAgdGhpcy5wb3MgKz0gdGFrZTsKCSAgICAgICAgICAgIHBvcyArPSB0YWtlOwoJICAgICAgICAgICAgaWYgKHRoaXMucG9zID09PSBibG9ja0xlbikgewoJICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzcyh2aWV3LCAwKTsKCSAgICAgICAgICAgICAgICB0aGlzLnBvcyA9IDA7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgdGhpcy5sZW5ndGggKz0gZGF0YS5sZW5ndGg7CgkgICAgICAgIHRoaXMucm91bmRDbGVhbigpOwoJICAgICAgICByZXR1cm4gdGhpczsKCSAgICB9CgkgICAgZGlnZXN0SW50byhvdXQpIHsKCSAgICAgICAgYWV4aXN0cyh0aGlzKTsKCSAgICAgICAgYW91dHB1dChvdXQsIHRoaXMpOwoJICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKCSAgICAgICAgLy8gUGFkZGluZwoJICAgICAgICAvLyBXZSBjYW4gYXZvaWQgYWxsb2NhdGlvbiBvZiBidWZmZXIgZm9yIHBhZGRpbmcgY29tcGxldGVseSBpZiBpdAoJICAgICAgICAvLyB3YXMgcHJldmlvdXNseSBub3QgYWxsb2NhdGVkIGhlcmUuIEJ1dCBpdCB3b24ndCBjaGFuZ2UgcGVyZm9ybWFuY2UuCgkgICAgICAgIGNvbnN0IHsgYnVmZmVyLCB2aWV3LCBibG9ja0xlbiwgaXNMRSB9ID0gdGhpczsKCSAgICAgICAgbGV0IHsgcG9zIH0gPSB0aGlzOwoJICAgICAgICAvLyBhcHBlbmQgdGhlIGJpdCAnMScgdG8gdGhlIG1lc3NhZ2UKCSAgICAgICAgYnVmZmVyW3BvcysrXSA9IDBiMTAwMDAwMDA7CgkgICAgICAgIHRoaXMuYnVmZmVyLnN1YmFycmF5KHBvcykuZmlsbCgwKTsKCSAgICAgICAgLy8gd2UgaGF2ZSBsZXNzIHRoYW4gcGFkT2Zmc2V0IGxlZnQgaW4gYnVmZmVyLCBzbyB3ZSBjYW5ub3QgcHV0IGxlbmd0aCBpbgoJICAgICAgICAvLyBjdXJyZW50IGJsb2NrLCBuZWVkIHByb2Nlc3MgaXQgYW5kIHBhZCBhZ2FpbgoJICAgICAgICBpZiAodGhpcy5wYWRPZmZzZXQgPiBibG9ja0xlbiAtIHBvcykgewoJICAgICAgICAgICAgdGhpcy5wcm9jZXNzKHZpZXcsIDApOwoJICAgICAgICAgICAgcG9zID0gMDsKCSAgICAgICAgfQoJICAgICAgICAvLyBQYWQgdW50aWwgZnVsbCBibG9jayBieXRlIHdpdGggemVyb3MKCSAgICAgICAgZm9yIChsZXQgaSA9IHBvczsgaSA8IGJsb2NrTGVuOyBpKyspCgkgICAgICAgICAgICBidWZmZXJbaV0gPSAwOwoJICAgICAgICAvLyBOb3RlOiBzaGE1MTIgcmVxdWlyZXMgbGVuZ3RoIHRvIGJlIDEyOGJpdCBpbnRlZ2VyLCBidXQgbGVuZ3RoIGluIEpTIHdpbGwgb3ZlcmZsb3cgYmVmb3JlIHRoYXQKCSAgICAgICAgLy8gWW91IG5lZWQgdG8gd3JpdGUgYXJvdW5kIDIgZXhhYnl0ZXMgKHU2NF9tYXggLyA4IC8gKDEwMjQqKjYpKSBmb3IgdGhpcyB0byBoYXBwZW4uCgkgICAgICAgIC8vIFNvIHdlIGp1c3Qgd3JpdGUgbG93ZXN0IDY0IGJpdHMgb2YgdGhhdCB2YWx1ZS4KCSAgICAgICAgc2V0QmlnVWludDY0KHZpZXcsIGJsb2NrTGVuIC0gOCwgQmlnSW50KHRoaXMubGVuZ3RoICogOCksIGlzTEUpOwoJICAgICAgICB0aGlzLnByb2Nlc3ModmlldywgMCk7CgkgICAgICAgIGNvbnN0IG92aWV3ID0gY3JlYXRlVmlldyhvdXQpOwoJICAgICAgICBjb25zdCBsZW4gPSB0aGlzLm91dHB1dExlbjsKCSAgICAgICAgLy8gTk9URTogd2UgZG8gZGl2aXNpb24gYnkgNCBsYXRlciwgd2hpY2ggc2hvdWxkIGJlIGZ1c2VkIGluIHNpbmdsZSBvcCB3aXRoIG1vZHVsbyBieSBKSVQKCSAgICAgICAgaWYgKGxlbiAlIDQpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ19zaGEyOiBvdXRwdXRMZW4gc2hvdWxkIGJlIGFsaWduZWQgdG8gMzJiaXQnKTsKCSAgICAgICAgY29uc3Qgb3V0TGVuID0gbGVuIC8gNDsKCSAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLmdldCgpOwoJICAgICAgICBpZiAob3V0TGVuID4gc3RhdGUubGVuZ3RoKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdfc2hhMjogb3V0cHV0TGVuIGJpZ2dlciB0aGFuIHN0YXRlJyk7CgkgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3V0TGVuOyBpKyspCgkgICAgICAgICAgICBvdmlldy5zZXRVaW50MzIoNCAqIGksIHN0YXRlW2ldLCBpc0xFKTsKCSAgICB9CgkgICAgZGlnZXN0KCkgewoJICAgICAgICBjb25zdCB7IGJ1ZmZlciwgb3V0cHV0TGVuIH0gPSB0aGlzOwoJICAgICAgICB0aGlzLmRpZ2VzdEludG8oYnVmZmVyKTsKCSAgICAgICAgY29uc3QgcmVzID0gYnVmZmVyLnNsaWNlKDAsIG91dHB1dExlbik7CgkgICAgICAgIHRoaXMuZGVzdHJveSgpOwoJICAgICAgICByZXR1cm4gcmVzOwoJICAgIH0KCSAgICBfY2xvbmVJbnRvKHRvKSB7CgkgICAgICAgIHRvIHx8ICh0byA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkpOwoJICAgICAgICB0by5zZXQoLi4udGhpcy5nZXQoKSk7CgkgICAgICAgIGNvbnN0IHsgYmxvY2tMZW4sIGJ1ZmZlciwgbGVuZ3RoLCBmaW5pc2hlZCwgZGVzdHJveWVkLCBwb3MgfSA9IHRoaXM7CgkgICAgICAgIHRvLmxlbmd0aCA9IGxlbmd0aDsKCSAgICAgICAgdG8ucG9zID0gcG9zOwoJICAgICAgICB0by5maW5pc2hlZCA9IGZpbmlzaGVkOwoJICAgICAgICB0by5kZXN0cm95ZWQgPSBkZXN0cm95ZWQ7CgkgICAgICAgIGlmIChsZW5ndGggJSBibG9ja0xlbikKCSAgICAgICAgICAgIHRvLmJ1ZmZlci5zZXQoYnVmZmVyKTsKCSAgICAgICAgcmV0dXJuIHRvOwoJICAgIH0KCX0KCgkvLyBTSEEyLTI1NiBuZWVkIHRvIHRyeSAyXjEyOCBoYXNoZXMgdG8gZXhlY3V0ZSBiaXJ0aGRheSBhdHRhY2suCgkvLyBCVEMgbmV0d29yayBpcyBkb2luZyAyXjcwIGhhc2hlcy9zZWMgKDJeOTUgaGFzaGVzL3llYXIpIGFzIHBlciBsYXRlIDIwMjQuCgkvLyBSb3VuZCBjb25zdGFudHM6CgkvLyBmaXJzdCAzMiBiaXRzIG9mIHRoZSBmcmFjdGlvbmFsIHBhcnRzIG9mIHRoZSBjdWJlIHJvb3RzIG9mIHRoZSBmaXJzdCA2NCBwcmltZXMgMi4uMzExKQoJLy8gcHJldHRpZXItaWdub3JlCgljb25zdCBTSEEyNTZfSyQxID0gLyogQF9fUFVSRV9fICovIG5ldyBVaW50MzJBcnJheShbCgkgICAgMHg0MjhhMmY5OCwgMHg3MTM3NDQ5MSwgMHhiNWMwZmJjZiwgMHhlOWI1ZGJhNSwgMHgzOTU2YzI1YiwgMHg1OWYxMTFmMSwgMHg5MjNmODJhNCwgMHhhYjFjNWVkNSwKCSAgICAweGQ4MDdhYTk4LCAweDEyODM1YjAxLCAweDI0MzE4NWJlLCAweDU1MGM3ZGMzLCAweDcyYmU1ZDc0LCAweDgwZGViMWZlLCAweDliZGMwNmE3LCAweGMxOWJmMTc0LAoJICAgIDB4ZTQ5YjY5YzEsIDB4ZWZiZTQ3ODYsIDB4MGZjMTlkYzYsIDB4MjQwY2ExY2MsIDB4MmRlOTJjNmYsIDB4NGE3NDg0YWEsIDB4NWNiMGE5ZGMsIDB4NzZmOTg4ZGEsCgkgICAgMHg5ODNlNTE1MiwgMHhhODMxYzY2ZCwgMHhiMDAzMjdjOCwgMHhiZjU5N2ZjNywgMHhjNmUwMGJmMywgMHhkNWE3OTE0NywgMHgwNmNhNjM1MSwgMHgxNDI5Mjk2NywKCSAgICAweDI3YjcwYTg1LCAweDJlMWIyMTM4LCAweDRkMmM2ZGZjLCAweDUzMzgwZDEzLCAweDY1MGE3MzU0LCAweDc2NmEwYWJiLCAweDgxYzJjOTJlLCAweDkyNzIyYzg1LAoJICAgIDB4YTJiZmU4YTEsIDB4YTgxYTY2NGIsIDB4YzI0YjhiNzAsIDB4Yzc2YzUxYTMsIDB4ZDE5MmU4MTksIDB4ZDY5OTA2MjQsIDB4ZjQwZTM1ODUsIDB4MTA2YWEwNzAsCgkgICAgMHgxOWE0YzExNiwgMHgxZTM3NmMwOCwgMHgyNzQ4Nzc0YywgMHgzNGIwYmNiNSwgMHgzOTFjMGNiMywgMHg0ZWQ4YWE0YSwgMHg1YjljY2E0ZiwgMHg2ODJlNmZmMywKCSAgICAweDc0OGY4MmVlLCAweDc4YTU2MzZmLCAweDg0Yzg3ODE0LCAweDhjYzcwMjA4LCAweDkwYmVmZmZhLCAweGE0NTA2Y2ViLCAweGJlZjlhM2Y3LCAweGM2NzE3OGYyCgldKTsKCS8vIEluaXRpYWwgc3RhdGU6CgkvLyBmaXJzdCAzMiBiaXRzIG9mIHRoZSBmcmFjdGlvbmFsIHBhcnRzIG9mIHRoZSBzcXVhcmUgcm9vdHMgb2YgdGhlIGZpcnN0IDggcHJpbWVzIDIuLjE5CgkvLyBwcmV0dGllci1pZ25vcmUKCWNvbnN0IFNIQTI1Nl9JViQxID0gLyogQF9fUFVSRV9fICovIG5ldyBVaW50MzJBcnJheShbCgkgICAgMHg2YTA5ZTY2NywgMHhiYjY3YWU4NSwgMHgzYzZlZjM3MiwgMHhhNTRmZjUzYSwgMHg1MTBlNTI3ZiwgMHg5YjA1Njg4YywgMHgxZjgzZDlhYiwgMHg1YmUwY2QxOQoJXSk7CgkvLyBUZW1wb3JhcnkgYnVmZmVyLCBub3QgdXNlZCB0byBzdG9yZSBhbnl0aGluZyBiZXR3ZWVuIHJ1bnMKCS8vIE5hbWVkIHRoaXMgd2F5IGJlY2F1c2UgaXQgbWF0Y2hlcyBzcGVjaWZpY2F0aW9uLgoJY29uc3QgU0hBMjU2X1ckMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVWludDMyQXJyYXkoNjQpOwoJbGV0IFNIQTI1NiQxID0gY2xhc3MgU0hBMjU2IGV4dGVuZHMgSGFzaE1EIHsKCSAgICBjb25zdHJ1Y3RvcigpIHsKCSAgICAgICAgc3VwZXIoNjQsIDMyLCA4LCBmYWxzZSk7CgkgICAgICAgIC8vIFdlIGNhbm5vdCB1c2UgYXJyYXkgaGVyZSBzaW5jZSBhcnJheSBhbGxvd3MgaW5kZXhpbmcgYnkgdmFyaWFibGUKCSAgICAgICAgLy8gd2hpY2ggbWVhbnMgb3B0aW1pemVyL2NvbXBpbGVyIGNhbm5vdCB1c2UgcmVnaXN0ZXJzLgoJICAgICAgICB0aGlzLkEgPSBTSEEyNTZfSVYkMVswXSB8IDA7CgkgICAgICAgIHRoaXMuQiA9IFNIQTI1Nl9JViQxWzFdIHwgMDsKCSAgICAgICAgdGhpcy5DID0gU0hBMjU2X0lWJDFbMl0gfCAwOwoJICAgICAgICB0aGlzLkQgPSBTSEEyNTZfSVYkMVszXSB8IDA7CgkgICAgICAgIHRoaXMuRSA9IFNIQTI1Nl9JViQxWzRdIHwgMDsKCSAgICAgICAgdGhpcy5GID0gU0hBMjU2X0lWJDFbNV0gfCAwOwoJICAgICAgICB0aGlzLkcgPSBTSEEyNTZfSVYkMVs2XSB8IDA7CgkgICAgICAgIHRoaXMuSCA9IFNIQTI1Nl9JViQxWzddIHwgMDsKCSAgICB9CgkgICAgZ2V0KCkgewoJICAgICAgICBjb25zdCB7IEEsIEIsIEMsIEQsIEUsIEYsIEcsIEggfSA9IHRoaXM7CgkgICAgICAgIHJldHVybiBbQSwgQiwgQywgRCwgRSwgRiwgRywgSF07CgkgICAgfQoJICAgIC8vIHByZXR0aWVyLWlnbm9yZQoJICAgIHNldChBLCBCLCBDLCBELCBFLCBGLCBHLCBIKSB7CgkgICAgICAgIHRoaXMuQSA9IEEgfCAwOwoJICAgICAgICB0aGlzLkIgPSBCIHwgMDsKCSAgICAgICAgdGhpcy5DID0gQyB8IDA7CgkgICAgICAgIHRoaXMuRCA9IEQgfCAwOwoJICAgICAgICB0aGlzLkUgPSBFIHwgMDsKCSAgICAgICAgdGhpcy5GID0gRiB8IDA7CgkgICAgICAgIHRoaXMuRyA9IEcgfCAwOwoJICAgICAgICB0aGlzLkggPSBIIHwgMDsKCSAgICB9CgkgICAgcHJvY2Vzcyh2aWV3LCBvZmZzZXQpIHsKCSAgICAgICAgLy8gRXh0ZW5kIHRoZSBmaXJzdCAxNiB3b3JkcyBpbnRvIHRoZSByZW1haW5pbmcgNDggd29yZHMgd1sxNi4uNjNdIG9mIHRoZSBtZXNzYWdlIHNjaGVkdWxlIGFycmF5CgkgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTY7IGkrKywgb2Zmc2V0ICs9IDQpCgkgICAgICAgICAgICBTSEEyNTZfVyQxW2ldID0gdmlldy5nZXRVaW50MzIob2Zmc2V0LCBmYWxzZSk7CgkgICAgICAgIGZvciAobGV0IGkgPSAxNjsgaSA8IDY0OyBpKyspIHsKCSAgICAgICAgICAgIGNvbnN0IFcxNSA9IFNIQTI1Nl9XJDFbaSAtIDE1XTsKCSAgICAgICAgICAgIGNvbnN0IFcyID0gU0hBMjU2X1ckMVtpIC0gMl07CgkgICAgICAgICAgICBjb25zdCBzMCA9IHJvdHIoVzE1LCA3KSBeIHJvdHIoVzE1LCAxOCkgXiAoVzE1ID4+PiAzKTsKCSAgICAgICAgICAgIGNvbnN0IHMxID0gcm90cihXMiwgMTcpIF4gcm90cihXMiwgMTkpIF4gKFcyID4+PiAxMCk7CgkgICAgICAgICAgICBTSEEyNTZfVyQxW2ldID0gKHMxICsgU0hBMjU2X1ckMVtpIC0gN10gKyBzMCArIFNIQTI1Nl9XJDFbaSAtIDE2XSkgfCAwOwoJICAgICAgICB9CgkgICAgICAgIC8vIENvbXByZXNzaW9uIGZ1bmN0aW9uIG1haW4gbG9vcCwgNjQgcm91bmRzCgkgICAgICAgIGxldCB7IEEsIEIsIEMsIEQsIEUsIEYsIEcsIEggfSA9IHRoaXM7CgkgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNjQ7IGkrKykgewoJICAgICAgICAgICAgY29uc3Qgc2lnbWExID0gcm90cihFLCA2KSBeIHJvdHIoRSwgMTEpIF4gcm90cihFLCAyNSk7CgkgICAgICAgICAgICBjb25zdCBUMSA9IChIICsgc2lnbWExICsgQ2hpKEUsIEYsIEcpICsgU0hBMjU2X0skMVtpXSArIFNIQTI1Nl9XJDFbaV0pIHwgMDsKCSAgICAgICAgICAgIGNvbnN0IHNpZ21hMCA9IHJvdHIoQSwgMikgXiByb3RyKEEsIDEzKSBeIHJvdHIoQSwgMjIpOwoJICAgICAgICAgICAgY29uc3QgVDIgPSAoc2lnbWEwICsgTWFqKEEsIEIsIEMpKSB8IDA7CgkgICAgICAgICAgICBIID0gRzsKCSAgICAgICAgICAgIEcgPSBGOwoJICAgICAgICAgICAgRiA9IEU7CgkgICAgICAgICAgICBFID0gKEQgKyBUMSkgfCAwOwoJICAgICAgICAgICAgRCA9IEM7CgkgICAgICAgICAgICBDID0gQjsKCSAgICAgICAgICAgIEIgPSBBOwoJICAgICAgICAgICAgQSA9IChUMSArIFQyKSB8IDA7CgkgICAgICAgIH0KCSAgICAgICAgLy8gQWRkIHRoZSBjb21wcmVzc2VkIGNodW5rIHRvIHRoZSBjdXJyZW50IGhhc2ggdmFsdWUKCSAgICAgICAgQSA9IChBICsgdGhpcy5BKSB8IDA7CgkgICAgICAgIEIgPSAoQiArIHRoaXMuQikgfCAwOwoJICAgICAgICBDID0gKEMgKyB0aGlzLkMpIHwgMDsKCSAgICAgICAgRCA9IChEICsgdGhpcy5EKSB8IDA7CgkgICAgICAgIEUgPSAoRSArIHRoaXMuRSkgfCAwOwoJICAgICAgICBGID0gKEYgKyB0aGlzLkYpIHwgMDsKCSAgICAgICAgRyA9IChHICsgdGhpcy5HKSB8IDA7CgkgICAgICAgIEggPSAoSCArIHRoaXMuSCkgfCAwOwoJICAgICAgICB0aGlzLnNldChBLCBCLCBDLCBELCBFLCBGLCBHLCBIKTsKCSAgICB9CgkgICAgcm91bmRDbGVhbigpIHsKCSAgICAgICAgU0hBMjU2X1ckMS5maWxsKDApOwoJICAgIH0KCSAgICBkZXN0cm95KCkgewoJICAgICAgICB0aGlzLnNldCgwLCAwLCAwLCAwLCAwLCAwLCAwLCAwKTsKCSAgICAgICAgdGhpcy5idWZmZXIuZmlsbCgwKTsKCSAgICB9Cgl9OwoJLyoqCgkgKiBTSEEyLTI1NiBoYXNoIGZ1bmN0aW9uCgkgKiBAcGFyYW0gbWVzc2FnZSAtIGRhdGEgdGhhdCB3b3VsZCBiZSBoYXNoZWQKCSAqLwoJY29uc3Qgc2hhMjU2JDEgPSAvKiBAX19QVVJFX18gKi8gd3JhcENvbnN0cnVjdG9yKCgpID0+IG5ldyBTSEEyNTYkMSgpKTsKCgl2YXIgbGliID0ge307CgoJdmFyIGVuY29kaW5nX2xpYiA9IHt9OwoKCXZhciBoYXNSZXF1aXJlZEVuY29kaW5nX2xpYjsKCglmdW5jdGlvbiByZXF1aXJlRW5jb2RpbmdfbGliICgpIHsKCQlpZiAoaGFzUmVxdWlyZWRFbmNvZGluZ19saWIpIHJldHVybiBlbmNvZGluZ19saWI7CgkJaGFzUmVxdWlyZWRFbmNvZGluZ19saWIgPSAxOwoKCQkvLyBUaGlzIGlzIGZyZWUgYW5kIHVuZW5jdW1iZXJlZCBzb2Z0d2FyZSByZWxlYXNlZCBpbnRvIHRoZSBwdWJsaWMgZG9tYWluLgoJCS8vIFNlZSBMSUNFTlNFLm1kIGZvciBtb3JlIGluZm9ybWF0aW9uLgoKCQkvLwoJCS8vIFV0aWxpdGllcwoJCS8vCgoJCS8qKgoJCSAqIEBwYXJhbSB7bnVtYmVyfSBhIFRoZSBudW1iZXIgdG8gdGVzdC4KCQkgKiBAcGFyYW0ge251bWJlcn0gbWluIFRoZSBtaW5pbXVtIHZhbHVlIGluIHRoZSByYW5nZSwgaW5jbHVzaXZlLgoJCSAqIEBwYXJhbSB7bnVtYmVyfSBtYXggVGhlIG1heGltdW0gdmFsdWUgaW4gdGhlIHJhbmdlLCBpbmNsdXNpdmUuCgkJICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhID49IG1pbiBhbmQgYSA8PSBtYXguCgkJICovCgkJZnVuY3Rpb24gaW5SYW5nZShhLCBtaW4sIG1heCkgewoJCSAgcmV0dXJuIG1pbiA8PSBhICYmIGEgPD0gbWF4OwoJCX0KCgkJLyoqCgkJICogQHBhcmFtIHsqfSBvCgkJICogQHJldHVybiB7T2JqZWN0fQoJCSAqLwoJCWZ1bmN0aW9uIFRvRGljdGlvbmFyeShvKSB7CgkJICBpZiAobyA9PT0gdW5kZWZpbmVkKSByZXR1cm4ge307CgkJICBpZiAobyA9PT0gT2JqZWN0KG8pKSByZXR1cm4gbzsKCQkgIHRocm93IFR5cGVFcnJvcignQ291bGQgbm90IGNvbnZlcnQgYXJndW1lbnQgdG8gZGljdGlvbmFyeScpOwoJCX0KCgkJLyoqCgkJICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBJbnB1dCBzdHJpbmcgb2YgVVRGLTE2IGNvZGUgdW5pdHMuCgkJICogQHJldHVybiB7IUFycmF5LjxudW1iZXI+fSBDb2RlIHBvaW50cy4KCQkgKi8KCQlmdW5jdGlvbiBzdHJpbmdUb0NvZGVQb2ludHMoc3RyaW5nKSB7CgkJICAvLyBodHRwczovL2hleWNhbS5naXRodWIuaW8vd2ViaWRsLyNkZm4tb2J0YWluLXVuaWNvZGUKCgkJICAvLyAxLiBMZXQgUyBiZSB0aGUgRE9NU3RyaW5nIHZhbHVlLgoJCSAgdmFyIHMgPSBTdHJpbmcoc3RyaW5nKTsKCgkJICAvLyAyLiBMZXQgbiBiZSB0aGUgbGVuZ3RoIG9mIFMuCgkJICB2YXIgbiA9IHMubGVuZ3RoOwoKCQkgIC8vIDMuIEluaXRpYWxpemUgaSB0byAwLgoJCSAgdmFyIGkgPSAwOwoKCQkgIC8vIDQuIEluaXRpYWxpemUgVSB0byBiZSBhbiBlbXB0eSBzZXF1ZW5jZSBvZiBVbmljb2RlIGNoYXJhY3RlcnMuCgkJICB2YXIgdSA9IFtdOwoKCQkgIC8vIDUuIFdoaWxlIGkgPCBuOgoJCSAgd2hpbGUgKGkgPCBuKSB7CgoJCSAgICAvLyAxLiBMZXQgYyBiZSB0aGUgY29kZSB1bml0IGluIFMgYXQgaW5kZXggaS4KCQkgICAgdmFyIGMgPSBzLmNoYXJDb2RlQXQoaSk7CgoJCSAgICAvLyAyLiBEZXBlbmRpbmcgb24gdGhlIHZhbHVlIG9mIGM6CgoJCSAgICAvLyBjIDwgMHhEODAwIG9yIGMgPiAweERGRkYKCQkgICAgaWYgKGMgPCAweEQ4MDAgfHwgYyA+IDB4REZGRikgewoJCSAgICAgIC8vIEFwcGVuZCB0byBVIHRoZSBVbmljb2RlIGNoYXJhY3RlciB3aXRoIGNvZGUgcG9pbnQgYy4KCQkgICAgICB1LnB1c2goYyk7CgkJICAgIH0KCgkJICAgIC8vIDB4REMwMCDiiaQgYyDiiaQgMHhERkZGCgkJICAgIGVsc2UgaWYgKDB4REMwMCA8PSBjICYmIGMgPD0gMHhERkZGKSB7CgkJICAgICAgLy8gQXBwZW5kIHRvIFUgYSBVK0ZGRkQgUkVQTEFDRU1FTlQgQ0hBUkFDVEVSLgoJCSAgICAgIHUucHVzaCgweEZGRkQpOwoJCSAgICB9CgoJCSAgICAvLyAweEQ4MDAg4omkIGMg4omkIDB4REJGRgoJCSAgICBlbHNlIGlmICgweEQ4MDAgPD0gYyAmJiBjIDw9IDB4REJGRikgewoJCSAgICAgIC8vIDEuIElmIGkgPSBu4oiSMSwgdGhlbiBhcHBlbmQgdG8gVSBhIFUrRkZGRCBSRVBMQUNFTUVOVAoJCSAgICAgIC8vIENIQVJBQ1RFUi4KCQkgICAgICBpZiAoaSA9PT0gbiAtIDEpIHsKCQkgICAgICAgIHUucHVzaCgweEZGRkQpOwoJCSAgICAgIH0KCQkgICAgICAvLyAyLiBPdGhlcndpc2UsIGkgPCBu4oiSMToKCQkgICAgICBlbHNlIHsKCQkgICAgICAgIC8vIDEuIExldCBkIGJlIHRoZSBjb2RlIHVuaXQgaW4gUyBhdCBpbmRleCBpKzEuCgkJICAgICAgICB2YXIgZCA9IHN0cmluZy5jaGFyQ29kZUF0KGkgKyAxKTsKCgkJICAgICAgICAvLyAyLiBJZiAweERDMDAg4omkIGQg4omkIDB4REZGRiwgdGhlbjoKCQkgICAgICAgIGlmICgweERDMDAgPD0gZCAmJiBkIDw9IDB4REZGRikgewoJCSAgICAgICAgICAvLyAxLiBMZXQgYSBiZSBjICYgMHgzRkYuCgkJICAgICAgICAgIHZhciBhID0gYyAmIDB4M0ZGOwoKCQkgICAgICAgICAgLy8gMi4gTGV0IGIgYmUgZCAmIDB4M0ZGLgoJCSAgICAgICAgICB2YXIgYiA9IGQgJiAweDNGRjsKCgkJICAgICAgICAgIC8vIDMuIEFwcGVuZCB0byBVIHRoZSBVbmljb2RlIGNoYXJhY3RlciB3aXRoIGNvZGUgcG9pbnQKCQkgICAgICAgICAgLy8gMl4xNisyXjEwKmErYi4KCQkgICAgICAgICAgdS5wdXNoKDB4MTAwMDAgKyAoYSA8PCAxMCkgKyBiKTsKCgkJICAgICAgICAgIC8vIDQuIFNldCBpIHRvIGkrMS4KCQkgICAgICAgICAgaSArPSAxOwoJCSAgICAgICAgfQoKCQkgICAgICAgIC8vIDMuIE90aGVyd2lzZSwgZCA8IDB4REMwMCBvciBkID4gMHhERkZGLiBBcHBlbmQgdG8gVSBhCgkJICAgICAgICAvLyBVK0ZGRkQgUkVQTEFDRU1FTlQgQ0hBUkFDVEVSLgoJCSAgICAgICAgZWxzZSAgewoJCSAgICAgICAgICB1LnB1c2goMHhGRkZEKTsKCQkgICAgICAgIH0KCQkgICAgICB9CgkJICAgIH0KCgkJICAgIC8vIDMuIFNldCBpIHRvIGkrMS4KCQkgICAgaSArPSAxOwoJCSAgfQoKCQkgIC8vIDYuIFJldHVybiBVLgoJCSAgcmV0dXJuIHU7CgkJfQoKCQkvKioKCQkgKiBAcGFyYW0geyFBcnJheS48bnVtYmVyPn0gY29kZV9wb2ludHMgQXJyYXkgb2YgY29kZSBwb2ludHMuCgkJICogQHJldHVybiB7c3RyaW5nfSBzdHJpbmcgU3RyaW5nIG9mIFVURi0xNiBjb2RlIHVuaXRzLgoJCSAqLwoJCWZ1bmN0aW9uIGNvZGVQb2ludHNUb1N0cmluZyhjb2RlX3BvaW50cykgewoJCSAgdmFyIHMgPSAnJzsKCQkgIGZvciAodmFyIGkgPSAwOyBpIDwgY29kZV9wb2ludHMubGVuZ3RoOyArK2kpIHsKCQkgICAgdmFyIGNwID0gY29kZV9wb2ludHNbaV07CgkJICAgIGlmIChjcCA8PSAweEZGRkYpIHsKCQkgICAgICBzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoY3ApOwoJCSAgICB9IGVsc2UgewoJCSAgICAgIGNwIC09IDB4MTAwMDA7CgkJICAgICAgcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChjcCA+PiAxMCkgKyAweEQ4MDAsCgkJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjcCAmIDB4M0ZGKSArIDB4REMwMCk7CgkJICAgIH0KCQkgIH0KCQkgIHJldHVybiBzOwoJCX0KCgoJCS8vCgkJLy8gSW1wbGVtZW50YXRpb24gb2YgRW5jb2Rpbmcgc3BlY2lmaWNhdGlvbgoJCS8vIGh0dHBzOi8vZW5jb2Rpbmcuc3BlYy53aGF0d2cub3JnLwoJCS8vCgoJCS8vCgkJLy8gMy4gVGVybWlub2xvZ3kKCQkvLwoKCQkvKioKCQkgKiBFbmQtb2Ytc3RyZWFtIGlzIGEgc3BlY2lhbCB0b2tlbiB0aGF0IHNpZ25pZmllcyBubyBtb3JlIHRva2VucwoJCSAqIGFyZSBpbiB0aGUgc3RyZWFtLgoJCSAqIEBjb25zdAoJCSAqLyB2YXIgZW5kX29mX3N0cmVhbSA9IC0xOwoKCQkvKioKCQkgKiBBIHN0cmVhbSByZXByZXNlbnRzIGFuIG9yZGVyZWQgc2VxdWVuY2Ugb2YgdG9rZW5zLgoJCSAqCgkJICogQGNvbnN0cnVjdG9yCgkJICogQHBhcmFtIHshKEFycmF5LjxudW1iZXI+fFVpbnQ4QXJyYXkpfSB0b2tlbnMgQXJyYXkgb2YgdG9rZW5zIHRoYXQgcHJvdmlkZSB0aGUKCQkgKiBzdHJlYW0uCgkJICovCgkJZnVuY3Rpb24gU3RyZWFtKHRva2VucykgewoJCSAgLyoqIEB0eXBlIHshQXJyYXkuPG51bWJlcj59ICovCgkJICB0aGlzLnRva2VucyA9IFtdLnNsaWNlLmNhbGwodG9rZW5zKTsKCQl9CgoJCVN0cmVhbS5wcm90b3R5cGUgPSB7CgkJICAvKioKCQkgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgZW5kLW9mLXN0cmVhbSBoYXMgYmVlbiBoaXQuCgkJICAgKi8KCQkgIGVuZE9mU3RyZWFtOiBmdW5jdGlvbigpIHsKCQkgICAgcmV0dXJuICF0aGlzLnRva2Vucy5sZW5ndGg7CgkJICB9LAoKCQkgIC8qKgoJCSAgICogV2hlbiBhIHRva2VuIGlzIHJlYWQgZnJvbSBhIHN0cmVhbSwgdGhlIGZpcnN0IHRva2VuIGluIHRoZQoJCSAgICogc3RyZWFtIG11c3QgYmUgcmV0dXJuZWQgYW5kIHN1YnNlcXVlbnRseSByZW1vdmVkLCBhbmQKCQkgICAqIGVuZC1vZi1zdHJlYW0gbXVzdCBiZSByZXR1cm5lZCBvdGhlcndpc2UuCgkJICAgKgoJCSAgICogQHJldHVybiB7bnVtYmVyfSBHZXQgdGhlIG5leHQgdG9rZW4gZnJvbSB0aGUgc3RyZWFtLCBvcgoJCSAgICogZW5kX29mX3N0cmVhbS4KCQkgICAqLwoJCSAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJCSAgICBpZiAoIXRoaXMudG9rZW5zLmxlbmd0aCkKCQkgICAgICByZXR1cm4gZW5kX29mX3N0cmVhbTsKCQkgICAgIHJldHVybiB0aGlzLnRva2Vucy5zaGlmdCgpOwoJCSAgIH0sCgoJCSAgLyoqCgkJICAgKiBXaGVuIG9uZSBvciBtb3JlIHRva2VucyBhcmUgcHJlcGVuZGVkIHRvIGEgc3RyZWFtLCB0aG9zZSB0b2tlbnMKCQkgICAqIG11c3QgYmUgaW5zZXJ0ZWQsIGluIGdpdmVuIG9yZGVyLCBiZWZvcmUgdGhlIGZpcnN0IHRva2VuIGluIHRoZQoJCSAgICogc3RyZWFtLgoJCSAgICoKCQkgICAqIEBwYXJhbSB7KG51bWJlcnwhQXJyYXkuPG51bWJlcj4pfSB0b2tlbiBUaGUgdG9rZW4ocykgdG8gcHJlcGVuZCB0byB0aGUgc3RyZWFtLgoJCSAgICovCgkJICBwcmVwZW5kOiBmdW5jdGlvbih0b2tlbikgewoJCSAgICBpZiAoQXJyYXkuaXNBcnJheSh0b2tlbikpIHsKCQkgICAgICB2YXIgdG9rZW5zID0gLyoqQHR5cGUgeyFBcnJheS48bnVtYmVyPn0qLyh0b2tlbik7CgkJICAgICAgd2hpbGUgKHRva2Vucy5sZW5ndGgpCgkJICAgICAgICB0aGlzLnRva2Vucy51bnNoaWZ0KHRva2Vucy5wb3AoKSk7CgkJICAgIH0gZWxzZSB7CgkJICAgICAgdGhpcy50b2tlbnMudW5zaGlmdCh0b2tlbik7CgkJICAgIH0KCQkgIH0sCgoJCSAgLyoqCgkJICAgKiBXaGVuIG9uZSBvciBtb3JlIHRva2VucyBhcmUgcHVzaGVkIHRvIGEgc3RyZWFtLCB0aG9zZSB0b2tlbnMKCQkgICAqIG11c3QgYmUgaW5zZXJ0ZWQsIGluIGdpdmVuIG9yZGVyLCBhZnRlciB0aGUgbGFzdCB0b2tlbiBpbiB0aGUKCQkgICAqIHN0cmVhbS4KCQkgICAqCgkJICAgKiBAcGFyYW0geyhudW1iZXJ8IUFycmF5LjxudW1iZXI+KX0gdG9rZW4gVGhlIHRva2VucyhzKSB0byBwcmVwZW5kIHRvIHRoZSBzdHJlYW0uCgkJICAgKi8KCQkgIHB1c2g6IGZ1bmN0aW9uKHRva2VuKSB7CgkJICAgIGlmIChBcnJheS5pc0FycmF5KHRva2VuKSkgewoJCSAgICAgIHZhciB0b2tlbnMgPSAvKipAdHlwZSB7IUFycmF5LjxudW1iZXI+fSovKHRva2VuKTsKCQkgICAgICB3aGlsZSAodG9rZW5zLmxlbmd0aCkKCQkgICAgICAgIHRoaXMudG9rZW5zLnB1c2godG9rZW5zLnNoaWZ0KCkpOwoJCSAgICB9IGVsc2UgewoJCSAgICAgIHRoaXMudG9rZW5zLnB1c2godG9rZW4pOwoJCSAgICB9CgkJICB9CgkJfTsKCgkJLy8KCQkvLyA0LiBFbmNvZGluZ3MKCQkvLwoKCQkvLyA0LjEgRW5jb2RlcnMgYW5kIGRlY29kZXJzCgoJCS8qKiBAY29uc3QgKi8KCQl2YXIgZmluaXNoZWQgPSAtMTsKCgkJLyoqCgkJICogQHBhcmFtIHtib29sZWFufSBmYXRhbCBJZiB0cnVlLCBkZWNvZGluZyBlcnJvcnMgcmFpc2UgYW4gZXhjZXB0aW9uLgoJCSAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2NvZGVfcG9pbnQgT3ZlcnJpZGUgdGhlIHN0YW5kYXJkIGZhbGxiYWNrIGNvZGUgcG9pbnQuCgkJICogQHJldHVybiB7bnVtYmVyfSBUaGUgY29kZSBwb2ludCB0byBpbnNlcnQgb24gYSBkZWNvZGluZyBlcnJvci4KCQkgKi8KCQlmdW5jdGlvbiBkZWNvZGVyRXJyb3IoZmF0YWwsIG9wdF9jb2RlX3BvaW50KSB7CgkJICBpZiAoZmF0YWwpCgkJICAgIHRocm93IFR5cGVFcnJvcignRGVjb2RlciBlcnJvcicpOwoJCSAgcmV0dXJuIG9wdF9jb2RlX3BvaW50IHx8IDB4RkZGRDsKCQl9CgoJCS8vCgkJLy8gNy4gQVBJCgkJLy8KCgkJLyoqIEBjb25zdCAqLyB2YXIgREVGQVVMVF9FTkNPRElORyA9ICd1dGYtOCc7CgoJCS8vIDcuMSBJbnRlcmZhY2UgVGV4dERlY29kZXIKCgkJLyoqCgkJICogQGNvbnN0cnVjdG9yCgkJICogQHBhcmFtIHtzdHJpbmc9fSBlbmNvZGluZyBUaGUgbGFiZWwgb2YgdGhlIGVuY29kaW5nOwoJCSAqICAgICBkZWZhdWx0cyB0byAndXRmLTgnLgoJCSAqIEBwYXJhbSB7T2JqZWN0PX0gb3B0aW9ucwoJCSAqLwoJCWZ1bmN0aW9uIFRleHREZWNvZGVyKGVuY29kaW5nLCBvcHRpb25zKSB7CgkJICBpZiAoISh0aGlzIGluc3RhbmNlb2YgVGV4dERlY29kZXIpKSB7CgkJICAgIHJldHVybiBuZXcgVGV4dERlY29kZXIoZW5jb2RpbmcsIG9wdGlvbnMpOwoJCSAgfQoJCSAgZW5jb2RpbmcgPSBlbmNvZGluZyAhPT0gdW5kZWZpbmVkID8gU3RyaW5nKGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpIDogREVGQVVMVF9FTkNPRElORzsKCQkgIGlmIChlbmNvZGluZyAhPT0gREVGQVVMVF9FTkNPRElORykgewoJCSAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQuIE9ubHkgdXRmLTggaXMgc3VwcG9ydGVkJyk7CgkJICB9CgkJICBvcHRpb25zID0gVG9EaWN0aW9uYXJ5KG9wdGlvbnMpOwoKCQkgIC8qKiBAcHJpdmF0ZSBAdHlwZSB7Ym9vbGVhbn0gKi8KCQkgIHRoaXMuX3N0cmVhbWluZyA9IGZhbHNlOwoJCSAgLyoqIEBwcml2YXRlIEB0eXBlIHtib29sZWFufSAqLwoJCSAgdGhpcy5fQk9Nc2VlbiA9IGZhbHNlOwoJCSAgLyoqIEBwcml2YXRlIEB0eXBlIHs/RGVjb2Rlcn0gKi8KCQkgIHRoaXMuX2RlY29kZXIgPSBudWxsOwoJCSAgLyoqIEBwcml2YXRlIEB0eXBlIHtib29sZWFufSAqLwoJCSAgdGhpcy5fZmF0YWwgPSBCb29sZWFuKG9wdGlvbnNbJ2ZhdGFsJ10pOwoJCSAgLyoqIEBwcml2YXRlIEB0eXBlIHtib29sZWFufSAqLwoJCSAgdGhpcy5faWdub3JlQk9NID0gQm9vbGVhbihvcHRpb25zWydpZ25vcmVCT00nXSk7CgoJCSAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdlbmNvZGluZycsIHt2YWx1ZTogJ3V0Zi04J30pOwoJCSAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdmYXRhbCcsIHt2YWx1ZTogdGhpcy5fZmF0YWx9KTsKCQkgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnaWdub3JlQk9NJywge3ZhbHVlOiB0aGlzLl9pZ25vcmVCT019KTsKCQl9CgoJCVRleHREZWNvZGVyLnByb3RvdHlwZSA9IHsKCQkgIC8qKgoJCSAgICogQHBhcmFtIHtBcnJheUJ1ZmZlclZpZXc9fSBpbnB1dCBUaGUgYnVmZmVyIG9mIGJ5dGVzIHRvIGRlY29kZS4KCQkgICAqIEBwYXJhbSB7T2JqZWN0PX0gb3B0aW9ucwoJCSAgICogQHJldHVybiB7c3RyaW5nfSBUaGUgZGVjb2RlZCBzdHJpbmcuCgkJICAgKi8KCQkgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlKGlucHV0LCBvcHRpb25zKSB7CgkJICAgIHZhciBieXRlczsKCQkgICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ29iamVjdCcgJiYgaW5wdXQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewoJCSAgICAgIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQpOwoJCSAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ29iamVjdCcgJiYgJ2J1ZmZlcicgaW4gaW5wdXQgJiYKCQkgICAgICAgICAgICAgICBpbnB1dC5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewoJCSAgICAgIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQuYnVmZmVyLAoJCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuYnl0ZU9mZnNldCwKCQkgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LmJ5dGVMZW5ndGgpOwoJCSAgICB9IGVsc2UgewoJCSAgICAgIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoMCk7CgkJICAgIH0KCgkJICAgIG9wdGlvbnMgPSBUb0RpY3Rpb25hcnkob3B0aW9ucyk7CgoJCSAgICBpZiAoIXRoaXMuX3N0cmVhbWluZykgewoJCSAgICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgVVRGOERlY29kZXIoe2ZhdGFsOiB0aGlzLl9mYXRhbH0pOwoJCSAgICAgIHRoaXMuX0JPTXNlZW4gPSBmYWxzZTsKCQkgICAgfQoJCSAgICB0aGlzLl9zdHJlYW1pbmcgPSBCb29sZWFuKG9wdGlvbnNbJ3N0cmVhbSddKTsKCgkJICAgIHZhciBpbnB1dF9zdHJlYW0gPSBuZXcgU3RyZWFtKGJ5dGVzKTsKCgkJICAgIHZhciBjb2RlX3BvaW50cyA9IFtdOwoKCQkgICAgLyoqIEB0eXBlIHs/KG51bWJlcnwhQXJyYXkuPG51bWJlcj4pfSAqLwoJCSAgICB2YXIgcmVzdWx0OwoKCQkgICAgd2hpbGUgKCFpbnB1dF9zdHJlYW0uZW5kT2ZTdHJlYW0oKSkgewoJCSAgICAgIHJlc3VsdCA9IHRoaXMuX2RlY29kZXIuaGFuZGxlcihpbnB1dF9zdHJlYW0sIGlucHV0X3N0cmVhbS5yZWFkKCkpOwoJCSAgICAgIGlmIChyZXN1bHQgPT09IGZpbmlzaGVkKQoJCSAgICAgICAgYnJlYWs7CgkJICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCkKCQkgICAgICAgIGNvbnRpbnVlOwoJCSAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpCgkJICAgICAgICBjb2RlX3BvaW50cy5wdXNoLmFwcGx5KGNvZGVfcG9pbnRzLCAvKipAdHlwZSB7IUFycmF5LjxudW1iZXI+fSovKHJlc3VsdCkpOwoJCSAgICAgIGVsc2UKCQkgICAgICAgIGNvZGVfcG9pbnRzLnB1c2gocmVzdWx0KTsKCQkgICAgfQoJCSAgICBpZiAoIXRoaXMuX3N0cmVhbWluZykgewoJCSAgICAgIGRvIHsKCQkgICAgICAgIHJlc3VsdCA9IHRoaXMuX2RlY29kZXIuaGFuZGxlcihpbnB1dF9zdHJlYW0sIGlucHV0X3N0cmVhbS5yZWFkKCkpOwoJCSAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmluaXNoZWQpCgkJICAgICAgICAgIGJyZWFrOwoJCSAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCkKCQkgICAgICAgICAgY29udGludWU7CgkJICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKQoJCSAgICAgICAgICBjb2RlX3BvaW50cy5wdXNoLmFwcGx5KGNvZGVfcG9pbnRzLCAvKipAdHlwZSB7IUFycmF5LjxudW1iZXI+fSovKHJlc3VsdCkpOwoJCSAgICAgICAgZWxzZQoJCSAgICAgICAgICBjb2RlX3BvaW50cy5wdXNoKHJlc3VsdCk7CgkJICAgICAgfSB3aGlsZSAoIWlucHV0X3N0cmVhbS5lbmRPZlN0cmVhbSgpKTsKCQkgICAgICB0aGlzLl9kZWNvZGVyID0gbnVsbDsKCQkgICAgfQoKCQkgICAgaWYgKGNvZGVfcG9pbnRzLmxlbmd0aCkgewoJCSAgICAgIC8vIElmIGVuY29kaW5nIGlzIG9uZSBvZiB1dGYtOCwgdXRmLTE2YmUsIGFuZCB1dGYtMTZsZSwgYW5kCgkJICAgICAgLy8gaWdub3JlIEJPTSBmbGFnIGFuZCBCT00gc2VlbiBmbGFnIGFyZSB1bnNldCwgcnVuIHRoZXNlCgkJICAgICAgLy8gc3Vic3Vic3RlcHM6CgkJICAgICAgaWYgKFsndXRmLTgnXS5pbmRleE9mKHRoaXMuZW5jb2RpbmcpICE9PSAtMSAmJgoJCSAgICAgICAgICAhdGhpcy5faWdub3JlQk9NICYmICF0aGlzLl9CT01zZWVuKSB7CgkJICAgICAgICAvLyBJZiB0b2tlbiBpcyBVK0ZFRkYsIHNldCBCT00gc2VlbiBmbGFnLgoJCSAgICAgICAgaWYgKGNvZGVfcG9pbnRzWzBdID09PSAweEZFRkYpIHsKCQkgICAgICAgICAgdGhpcy5fQk9Nc2VlbiA9IHRydWU7CgkJICAgICAgICAgIGNvZGVfcG9pbnRzLnNoaWZ0KCk7CgkJICAgICAgICB9IGVsc2UgewoJCSAgICAgICAgICAvLyBPdGhlcndpc2UsIGlmIHRva2VuIGlzIG5vdCBlbmQtb2Ytc3RyZWFtLCBzZXQgQk9NIHNlZW4KCQkgICAgICAgICAgLy8gZmxhZyBhbmQgYXBwZW5kIHRva2VuIHRvIG91dHB1dC4KCQkgICAgICAgICAgdGhpcy5fQk9Nc2VlbiA9IHRydWU7CgkJICAgICAgICB9CgkJICAgICAgfQoJCSAgICB9CgoJCSAgICByZXR1cm4gY29kZVBvaW50c1RvU3RyaW5nKGNvZGVfcG9pbnRzKTsKCQkgIH0KCQl9OwoKCQkvLyA3LjIgSW50ZXJmYWNlIFRleHRFbmNvZGVyCgoJCS8qKgoJCSAqIEBjb25zdHJ1Y3RvcgoJCSAqIEBwYXJhbSB7c3RyaW5nPX0gZW5jb2RpbmcgVGhlIGxhYmVsIG9mIHRoZSBlbmNvZGluZzsKCQkgKiAgICAgZGVmYXVsdHMgdG8gJ3V0Zi04Jy4KCQkgKiBAcGFyYW0ge09iamVjdD19IG9wdGlvbnMKCQkgKi8KCQlmdW5jdGlvbiBUZXh0RW5jb2RlcihlbmNvZGluZywgb3B0aW9ucykgewoJCSAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFRleHRFbmNvZGVyKSkKCQkgICAgcmV0dXJuIG5ldyBUZXh0RW5jb2RlcihlbmNvZGluZywgb3B0aW9ucyk7CgkJICBlbmNvZGluZyA9IGVuY29kaW5nICE9PSB1bmRlZmluZWQgPyBTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkgOiBERUZBVUxUX0VOQ09ESU5HOwoJCSAgaWYgKGVuY29kaW5nICE9PSBERUZBVUxUX0VOQ09ESU5HKSB7CgkJICAgIHRocm93IG5ldyBFcnJvcignRW5jb2Rpbmcgbm90IHN1cHBvcnRlZC4gT25seSB1dGYtOCBpcyBzdXBwb3J0ZWQnKTsKCQkgIH0KCQkgIG9wdGlvbnMgPSBUb0RpY3Rpb25hcnkob3B0aW9ucyk7CgoJCSAgLyoqIEBwcml2YXRlIEB0eXBlIHtib29sZWFufSAqLwoJCSAgdGhpcy5fc3RyZWFtaW5nID0gZmFsc2U7CgkJICAvKiogQHByaXZhdGUgQHR5cGUgez9FbmNvZGVyfSAqLwoJCSAgdGhpcy5fZW5jb2RlciA9IG51bGw7CgkJICAvKiogQHByaXZhdGUgQHR5cGUge3tmYXRhbDogYm9vbGVhbn19ICovCgkJICB0aGlzLl9vcHRpb25zID0ge2ZhdGFsOiBCb29sZWFuKG9wdGlvbnNbJ2ZhdGFsJ10pfTsKCgkJICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2VuY29kaW5nJywge3ZhbHVlOiAndXRmLTgnfSk7CgkJfQoKCQlUZXh0RW5jb2Rlci5wcm90b3R5cGUgPSB7CgkJICAvKioKCQkgICAqIEBwYXJhbSB7c3RyaW5nPX0gb3B0X3N0cmluZyBUaGUgc3RyaW5nIHRvIGVuY29kZS4KCQkgICAqIEBwYXJhbSB7T2JqZWN0PX0gb3B0aW9ucwoJCSAgICogQHJldHVybiB7VWludDhBcnJheX0gRW5jb2RlZCBieXRlcywgYXMgYSBVaW50OEFycmF5LgoJCSAgICovCgkJICBlbmNvZGU6IGZ1bmN0aW9uIGVuY29kZShvcHRfc3RyaW5nLCBvcHRpb25zKSB7CgkJICAgIG9wdF9zdHJpbmcgPSBvcHRfc3RyaW5nID8gU3RyaW5nKG9wdF9zdHJpbmcpIDogJyc7CgkJICAgIG9wdGlvbnMgPSBUb0RpY3Rpb25hcnkob3B0aW9ucyk7CgoJCSAgICAvLyBOT1RFOiBUaGlzIG9wdGlvbiBpcyBub25zdGFuZGFyZC4gTm9uZSBvZiB0aGUgZW5jb2RpbmdzCgkJICAgIC8vIHBlcm1pdHRlZCBmb3IgZW5jb2RpbmcgKGkuZS4gVVRGLTgsIFVURi0xNikgYXJlIHN0YXRlZnVsLAoJCSAgICAvLyBzbyBzdHJlYW1pbmcgaXMgbm90IG5lY2Vzc2FyeS4KCQkgICAgaWYgKCF0aGlzLl9zdHJlYW1pbmcpCgkJICAgICAgdGhpcy5fZW5jb2RlciA9IG5ldyBVVEY4RW5jb2Rlcih0aGlzLl9vcHRpb25zKTsKCQkgICAgdGhpcy5fc3RyZWFtaW5nID0gQm9vbGVhbihvcHRpb25zWydzdHJlYW0nXSk7CgoJCSAgICB2YXIgYnl0ZXMgPSBbXTsKCQkgICAgdmFyIGlucHV0X3N0cmVhbSA9IG5ldyBTdHJlYW0oc3RyaW5nVG9Db2RlUG9pbnRzKG9wdF9zdHJpbmcpKTsKCQkgICAgLyoqIEB0eXBlIHs/KG51bWJlcnwhQXJyYXkuPG51bWJlcj4pfSAqLwoJCSAgICB2YXIgcmVzdWx0OwoJCSAgICB3aGlsZSAoIWlucHV0X3N0cmVhbS5lbmRPZlN0cmVhbSgpKSB7CgkJICAgICAgcmVzdWx0ID0gdGhpcy5fZW5jb2Rlci5oYW5kbGVyKGlucHV0X3N0cmVhbSwgaW5wdXRfc3RyZWFtLnJlYWQoKSk7CgkJICAgICAgaWYgKHJlc3VsdCA9PT0gZmluaXNoZWQpCgkJICAgICAgICBicmVhazsKCQkgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKQoJCSAgICAgICAgYnl0ZXMucHVzaC5hcHBseShieXRlcywgLyoqQHR5cGUgeyFBcnJheS48bnVtYmVyPn0qLyhyZXN1bHQpKTsKCQkgICAgICBlbHNlCgkJICAgICAgICBieXRlcy5wdXNoKHJlc3VsdCk7CgkJICAgIH0KCQkgICAgaWYgKCF0aGlzLl9zdHJlYW1pbmcpIHsKCQkgICAgICB3aGlsZSAodHJ1ZSkgewoJCSAgICAgICAgcmVzdWx0ID0gdGhpcy5fZW5jb2Rlci5oYW5kbGVyKGlucHV0X3N0cmVhbSwgaW5wdXRfc3RyZWFtLnJlYWQoKSk7CgkJICAgICAgICBpZiAocmVzdWx0ID09PSBmaW5pc2hlZCkKCQkgICAgICAgICAgYnJlYWs7CgkJICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKQoJCSAgICAgICAgICBieXRlcy5wdXNoLmFwcGx5KGJ5dGVzLCAvKipAdHlwZSB7IUFycmF5LjxudW1iZXI+fSovKHJlc3VsdCkpOwoJCSAgICAgICAgZWxzZQoJCSAgICAgICAgICBieXRlcy5wdXNoKHJlc3VsdCk7CgkJICAgICAgfQoJCSAgICAgIHRoaXMuX2VuY29kZXIgPSBudWxsOwoJCSAgICB9CgkJICAgIHJldHVybiBuZXcgVWludDhBcnJheShieXRlcyk7CgkJICB9CgkJfTsKCgkJLy8KCQkvLyA4LiBUaGUgZW5jb2RpbmcKCQkvLwoKCQkvLyA4LjEgdXRmLTgKCgkJLyoqCgkJICogQGNvbnN0cnVjdG9yCgkJICogQGltcGxlbWVudHMge0RlY29kZXJ9CgkJICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCgkJICovCgkJZnVuY3Rpb24gVVRGOERlY29kZXIob3B0aW9ucykgewoJCSAgdmFyIGZhdGFsID0gb3B0aW9ucy5mYXRhbDsKCgkJICAvLyB1dGYtOCdzIGRlY29kZXIncyBoYXMgYW4gYXNzb2NpYXRlZCB1dGYtOCBjb2RlIHBvaW50LCB1dGYtOAoJCSAgLy8gYnl0ZXMgc2VlbiwgYW5kIHV0Zi04IGJ5dGVzIG5lZWRlZCAoYWxsIGluaXRpYWxseSAwKSwgYSB1dGYtOAoJCSAgLy8gbG93ZXIgYm91bmRhcnkgKGluaXRpYWxseSAweDgwKSwgYW5kIGEgdXRmLTggdXBwZXIgYm91bmRhcnkKCQkgIC8vIChpbml0aWFsbHkgMHhCRikuCgkJICB2YXIgLyoqIEB0eXBlIHtudW1iZXJ9ICovIHV0ZjhfY29kZV9wb2ludCA9IDAsCgkJICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIHV0ZjhfYnl0ZXNfc2VlbiA9IDAsCgkJICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIHV0ZjhfYnl0ZXNfbmVlZGVkID0gMCwKCQkgICAgICAvKiogQHR5cGUge251bWJlcn0gKi8gdXRmOF9sb3dlcl9ib3VuZGFyeSA9IDB4ODAsCgkJICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovIHV0ZjhfdXBwZXJfYm91bmRhcnkgPSAweEJGOwoKCQkgIC8qKgoJCSAgICogQHBhcmFtIHtTdHJlYW19IHN0cmVhbSBUaGUgc3RyZWFtIG9mIGJ5dGVzIGJlaW5nIGRlY29kZWQuCgkJICAgKiBAcGFyYW0ge251bWJlcn0gYml0ZSBUaGUgbmV4dCBieXRlIHJlYWQgZnJvbSB0aGUgc3RyZWFtLgoJCSAgICogQHJldHVybiB7PyhudW1iZXJ8IUFycmF5LjxudW1iZXI+KX0gVGhlIG5leHQgY29kZSBwb2ludChzKQoJCSAgICogICAgIGRlY29kZWQsIG9yIG51bGwgaWYgbm90IGVub3VnaCBkYXRhIGV4aXN0cyBpbiB0aGUgaW5wdXQKCQkgICAqICAgICBzdHJlYW0gdG8gZGVjb2RlIGEgY29tcGxldGUgY29kZSBwb2ludC4KCQkgICAqLwoJCSAgdGhpcy5oYW5kbGVyID0gZnVuY3Rpb24oc3RyZWFtLCBiaXRlKSB7CgkJICAgIC8vIDEuIElmIGJ5dGUgaXMgZW5kLW9mLXN0cmVhbSBhbmQgdXRmLTggYnl0ZXMgbmVlZGVkIGlzIG5vdCAwLAoJCSAgICAvLyBzZXQgdXRmLTggYnl0ZXMgbmVlZGVkIHRvIDAgYW5kIHJldHVybiBlcnJvci4KCQkgICAgaWYgKGJpdGUgPT09IGVuZF9vZl9zdHJlYW0gJiYgdXRmOF9ieXRlc19uZWVkZWQgIT09IDApIHsKCQkgICAgICB1dGY4X2J5dGVzX25lZWRlZCA9IDA7CgkJICAgICAgcmV0dXJuIGRlY29kZXJFcnJvcihmYXRhbCk7CgkJICAgIH0KCgkJICAgIC8vIDIuIElmIGJ5dGUgaXMgZW5kLW9mLXN0cmVhbSwgcmV0dXJuIGZpbmlzaGVkLgoJCSAgICBpZiAoYml0ZSA9PT0gZW5kX29mX3N0cmVhbSkKCQkgICAgICByZXR1cm4gZmluaXNoZWQ7CgoJCSAgICAvLyAzLiBJZiB1dGYtOCBieXRlcyBuZWVkZWQgaXMgMCwgYmFzZWQgb24gYnl0ZToKCQkgICAgaWYgKHV0ZjhfYnl0ZXNfbmVlZGVkID09PSAwKSB7CgoJCSAgICAgIC8vIDB4MDAgdG8gMHg3RgoJCSAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4MDAsIDB4N0YpKSB7CgkJICAgICAgICAvLyBSZXR1cm4gYSBjb2RlIHBvaW50IHdob3NlIHZhbHVlIGlzIGJ5dGUuCgkJICAgICAgICByZXR1cm4gYml0ZTsKCQkgICAgICB9CgoJCSAgICAgIC8vIDB4QzIgdG8gMHhERgoJCSAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4QzIsIDB4REYpKSB7CgkJICAgICAgICAvLyBTZXQgdXRmLTggYnl0ZXMgbmVlZGVkIHRvIDEgYW5kIHV0Zi04IGNvZGUgcG9pbnQgdG8gYnl0ZQoJCSAgICAgICAgLy8g4oiSIDB4QzAuCgkJICAgICAgICB1dGY4X2J5dGVzX25lZWRlZCA9IDE7CgkJICAgICAgICB1dGY4X2NvZGVfcG9pbnQgPSBiaXRlIC0gMHhDMDsKCQkgICAgICB9CgoJCSAgICAgIC8vIDB4RTAgdG8gMHhFRgoJCSAgICAgIGVsc2UgaWYgKGluUmFuZ2UoYml0ZSwgMHhFMCwgMHhFRikpIHsKCQkgICAgICAgIC8vIDEuIElmIGJ5dGUgaXMgMHhFMCwgc2V0IHV0Zi04IGxvd2VyIGJvdW5kYXJ5IHRvIDB4QTAuCgkJICAgICAgICBpZiAoYml0ZSA9PT0gMHhFMCkKCQkgICAgICAgICAgdXRmOF9sb3dlcl9ib3VuZGFyeSA9IDB4QTA7CgkJICAgICAgICAvLyAyLiBJZiBieXRlIGlzIDB4RUQsIHNldCB1dGYtOCB1cHBlciBib3VuZGFyeSB0byAweDlGLgoJCSAgICAgICAgaWYgKGJpdGUgPT09IDB4RUQpCgkJICAgICAgICAgIHV0ZjhfdXBwZXJfYm91bmRhcnkgPSAweDlGOwoJCSAgICAgICAgLy8gMy4gU2V0IHV0Zi04IGJ5dGVzIG5lZWRlZCB0byAyIGFuZCB1dGYtOCBjb2RlIHBvaW50IHRvCgkJICAgICAgICAvLyBieXRlIOKIkiAweEUwLgoJCSAgICAgICAgdXRmOF9ieXRlc19uZWVkZWQgPSAyOwoJCSAgICAgICAgdXRmOF9jb2RlX3BvaW50ID0gYml0ZSAtIDB4RTA7CgkJICAgICAgfQoKCQkgICAgICAvLyAweEYwIHRvIDB4RjQKCQkgICAgICBlbHNlIGlmIChpblJhbmdlKGJpdGUsIDB4RjAsIDB4RjQpKSB7CgkJICAgICAgICAvLyAxLiBJZiBieXRlIGlzIDB4RjAsIHNldCB1dGYtOCBsb3dlciBib3VuZGFyeSB0byAweDkwLgoJCSAgICAgICAgaWYgKGJpdGUgPT09IDB4RjApCgkJICAgICAgICAgIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAweDkwOwoJCSAgICAgICAgLy8gMi4gSWYgYnl0ZSBpcyAweEY0LCBzZXQgdXRmLTggdXBwZXIgYm91bmRhcnkgdG8gMHg4Ri4KCQkgICAgICAgIGlmIChiaXRlID09PSAweEY0KQoJCSAgICAgICAgICB1dGY4X3VwcGVyX2JvdW5kYXJ5ID0gMHg4RjsKCQkgICAgICAgIC8vIDMuIFNldCB1dGYtOCBieXRlcyBuZWVkZWQgdG8gMyBhbmQgdXRmLTggY29kZSBwb2ludCB0bwoJCSAgICAgICAgLy8gYnl0ZSDiiJIgMHhGMC4KCQkgICAgICAgIHV0ZjhfYnl0ZXNfbmVlZGVkID0gMzsKCQkgICAgICAgIHV0ZjhfY29kZV9wb2ludCA9IGJpdGUgLSAweEYwOwoJCSAgICAgIH0KCgkJICAgICAgLy8gT3RoZXJ3aXNlCgkJICAgICAgZWxzZSB7CgkJICAgICAgICAvLyBSZXR1cm4gZXJyb3IuCgkJICAgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKCQkgICAgICB9CgoJCSAgICAgIC8vIFRoZW4gKGJ5dGUgaXMgaW4gdGhlIHJhbmdlIDB4QzIgdG8gMHhGNCkgc2V0IHV0Zi04IGNvZGUKCQkgICAgICAvLyBwb2ludCB0byB1dGYtOCBjb2RlIHBvaW50IDw8ICg2IMOXIHV0Zi04IGJ5dGVzIG5lZWRlZCkgYW5kCgkJICAgICAgLy8gcmV0dXJuIGNvbnRpbnVlLgoJCSAgICAgIHV0ZjhfY29kZV9wb2ludCA9IHV0ZjhfY29kZV9wb2ludCA8PCAoNiAqIHV0ZjhfYnl0ZXNfbmVlZGVkKTsKCQkgICAgICByZXR1cm4gbnVsbDsKCQkgICAgfQoKCQkgICAgLy8gNC4gSWYgYnl0ZSBpcyBub3QgaW4gdGhlIHJhbmdlIHV0Zi04IGxvd2VyIGJvdW5kYXJ5IHRvIHV0Zi04CgkJICAgIC8vIHVwcGVyIGJvdW5kYXJ5LCBydW4gdGhlc2Ugc3Vic3RlcHM6CgkJICAgIGlmICghaW5SYW5nZShiaXRlLCB1dGY4X2xvd2VyX2JvdW5kYXJ5LCB1dGY4X3VwcGVyX2JvdW5kYXJ5KSkgewoKCQkgICAgICAvLyAxLiBTZXQgdXRmLTggY29kZSBwb2ludCwgdXRmLTggYnl0ZXMgbmVlZGVkLCBhbmQgdXRmLTgKCQkgICAgICAvLyBieXRlcyBzZWVuIHRvIDAsIHNldCB1dGYtOCBsb3dlciBib3VuZGFyeSB0byAweDgwLCBhbmQgc2V0CgkJICAgICAgLy8gdXRmLTggdXBwZXIgYm91bmRhcnkgdG8gMHhCRi4KCQkgICAgICB1dGY4X2NvZGVfcG9pbnQgPSB1dGY4X2J5dGVzX25lZWRlZCA9IHV0ZjhfYnl0ZXNfc2VlbiA9IDA7CgkJICAgICAgdXRmOF9sb3dlcl9ib3VuZGFyeSA9IDB4ODA7CgkJICAgICAgdXRmOF91cHBlcl9ib3VuZGFyeSA9IDB4QkY7CgoJCSAgICAgIC8vIDIuIFByZXBlbmQgYnl0ZSB0byBzdHJlYW0uCgkJICAgICAgc3RyZWFtLnByZXBlbmQoYml0ZSk7CgoJCSAgICAgIC8vIDMuIFJldHVybiBlcnJvci4KCQkgICAgICByZXR1cm4gZGVjb2RlckVycm9yKGZhdGFsKTsKCQkgICAgfQoKCQkgICAgLy8gNS4gU2V0IHV0Zi04IGxvd2VyIGJvdW5kYXJ5IHRvIDB4ODAgYW5kIHV0Zi04IHVwcGVyIGJvdW5kYXJ5CgkJICAgIC8vIHRvIDB4QkYuCgkJICAgIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAweDgwOwoJCSAgICB1dGY4X3VwcGVyX2JvdW5kYXJ5ID0gMHhCRjsKCgkJICAgIC8vIDYuIEluY3JlYXNlIHV0Zi04IGJ5dGVzIHNlZW4gYnkgb25lIGFuZCBzZXQgdXRmLTggY29kZSBwb2ludAoJCSAgICAvLyB0byB1dGYtOCBjb2RlIHBvaW50ICsgKGJ5dGUg4oiSIDB4ODApIDw8ICg2IMOXICh1dGYtOCBieXRlcwoJCSAgICAvLyBuZWVkZWQg4oiSIHV0Zi04IGJ5dGVzIHNlZW4pKS4KCQkgICAgdXRmOF9ieXRlc19zZWVuICs9IDE7CgkJICAgIHV0ZjhfY29kZV9wb2ludCArPSAoYml0ZSAtIDB4ODApIDw8ICg2ICogKHV0ZjhfYnl0ZXNfbmVlZGVkIC0gdXRmOF9ieXRlc19zZWVuKSk7CgoJCSAgICAvLyA3LiBJZiB1dGYtOCBieXRlcyBzZWVuIGlzIG5vdCBlcXVhbCB0byB1dGYtOCBieXRlcyBuZWVkZWQsCgkJICAgIC8vIGNvbnRpbnVlLgoJCSAgICBpZiAodXRmOF9ieXRlc19zZWVuICE9PSB1dGY4X2J5dGVzX25lZWRlZCkKCQkgICAgICByZXR1cm4gbnVsbDsKCgkJICAgIC8vIDguIExldCBjb2RlIHBvaW50IGJlIHV0Zi04IGNvZGUgcG9pbnQuCgkJICAgIHZhciBjb2RlX3BvaW50ID0gdXRmOF9jb2RlX3BvaW50OwoKCQkgICAgLy8gOS4gU2V0IHV0Zi04IGNvZGUgcG9pbnQsIHV0Zi04IGJ5dGVzIG5lZWRlZCwgYW5kIHV0Zi04IGJ5dGVzCgkJICAgIC8vIHNlZW4gdG8gMC4KCQkgICAgdXRmOF9jb2RlX3BvaW50ID0gdXRmOF9ieXRlc19uZWVkZWQgPSB1dGY4X2J5dGVzX3NlZW4gPSAwOwoKCQkgICAgLy8gMTAuIFJldHVybiBhIGNvZGUgcG9pbnQgd2hvc2UgdmFsdWUgaXMgY29kZSBwb2ludC4KCQkgICAgcmV0dXJuIGNvZGVfcG9pbnQ7CgkJICB9OwoJCX0KCgkJLyoqCgkJICogQGNvbnN0cnVjdG9yCgkJICogQGltcGxlbWVudHMge0VuY29kZXJ9CgkJICogQHBhcmFtIHt7ZmF0YWw6IGJvb2xlYW59fSBvcHRpb25zCgkJICovCgkJZnVuY3Rpb24gVVRGOEVuY29kZXIob3B0aW9ucykgewoJCSAgb3B0aW9ucy5mYXRhbDsKCQkgIC8qKgoJCSAgICogQHBhcmFtIHtTdHJlYW19IHN0cmVhbSBJbnB1dCBzdHJlYW0uCgkJICAgKiBAcGFyYW0ge251bWJlcn0gY29kZV9wb2ludCBOZXh0IGNvZGUgcG9pbnQgcmVhZCBmcm9tIHRoZSBzdHJlYW0uCgkJICAgKiBAcmV0dXJuIHsobnVtYmVyfCFBcnJheS48bnVtYmVyPil9IEJ5dGUocykgdG8gZW1pdC4KCQkgICAqLwoJCSAgdGhpcy5oYW5kbGVyID0gZnVuY3Rpb24oc3RyZWFtLCBjb2RlX3BvaW50KSB7CgkJICAgIC8vIDEuIElmIGNvZGUgcG9pbnQgaXMgZW5kLW9mLXN0cmVhbSwgcmV0dXJuIGZpbmlzaGVkLgoJCSAgICBpZiAoY29kZV9wb2ludCA9PT0gZW5kX29mX3N0cmVhbSkKCQkgICAgICByZXR1cm4gZmluaXNoZWQ7CgoJCSAgICAvLyAyLiBJZiBjb2RlIHBvaW50IGlzIGluIHRoZSByYW5nZSBVKzAwMDAgdG8gVSswMDdGLCByZXR1cm4gYQoJCSAgICAvLyBieXRlIHdob3NlIHZhbHVlIGlzIGNvZGUgcG9pbnQuCgkJICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDAwMCwgMHgwMDdmKSkKCQkgICAgICByZXR1cm4gY29kZV9wb2ludDsKCgkJICAgIC8vIDMuIFNldCBjb3VudCBhbmQgb2Zmc2V0IGJhc2VkIG9uIHRoZSByYW5nZSBjb2RlIHBvaW50IGlzIGluOgoJCSAgICB2YXIgY291bnQsIG9mZnNldDsKCQkgICAgLy8gVSswMDgwIHRvIFUrMDdGRjogICAgMSBhbmQgMHhDMAoJCSAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwODAsIDB4MDdGRikpIHsKCQkgICAgICBjb3VudCA9IDE7CgkJICAgICAgb2Zmc2V0ID0gMHhDMDsKCQkgICAgfQoJCSAgICAvLyBVKzA4MDAgdG8gVStGRkZGOiAgICAyIGFuZCAweEUwCgkJICAgIGVsc2UgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHgwODAwLCAweEZGRkYpKSB7CgkJICAgICAgY291bnQgPSAyOwoJCSAgICAgIG9mZnNldCA9IDB4RTA7CgkJICAgIH0KCQkgICAgLy8gVSsxMDAwMCB0byBVKzEwRkZGRjogMyBhbmQgMHhGMAoJCSAgICBlbHNlIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MTAwMDAsIDB4MTBGRkZGKSkgewoJCSAgICAgIGNvdW50ID0gMzsKCQkgICAgICBvZmZzZXQgPSAweEYwOwoJCSAgICB9CgoJCSAgICAvLyA0LkxldCBieXRlcyBiZSBhIGJ5dGUgc2VxdWVuY2Ugd2hvc2UgZmlyc3QgYnl0ZSBpcyAoY29kZQoJCSAgICAvLyBwb2ludCA+PiAoNiDDlyBjb3VudCkpICsgb2Zmc2V0LgoJCSAgICB2YXIgYnl0ZXMgPSBbKGNvZGVfcG9pbnQgPj4gKDYgKiBjb3VudCkpICsgb2Zmc2V0XTsKCgkJICAgIC8vIDUuIFJ1biB0aGVzZSBzdWJzdGVwcyB3aGlsZSBjb3VudCBpcyBncmVhdGVyIHRoYW4gMDoKCQkgICAgd2hpbGUgKGNvdW50ID4gMCkgewoKCQkgICAgICAvLyAxLiBTZXQgdGVtcCB0byBjb2RlIHBvaW50ID4+ICg2IMOXIChjb3VudCDiiJIgMSkpLgoJCSAgICAgIHZhciB0ZW1wID0gY29kZV9wb2ludCA+PiAoNiAqIChjb3VudCAtIDEpKTsKCgkJICAgICAgLy8gMi4gQXBwZW5kIHRvIGJ5dGVzIDB4ODAgfCAodGVtcCAmIDB4M0YpLgoJCSAgICAgIGJ5dGVzLnB1c2goMHg4MCB8ICh0ZW1wICYgMHgzRikpOwoKCQkgICAgICAvLyAzLiBEZWNyZWFzZSBjb3VudCBieSBvbmUuCgkJICAgICAgY291bnQgLT0gMTsKCQkgICAgfQoKCQkgICAgLy8gNi4gUmV0dXJuIGJ5dGVzIGJ5dGVzLCBpbiBvcmRlci4KCQkgICAgcmV0dXJuIGJ5dGVzOwoJCSAgfTsKCQl9CgoJCWVuY29kaW5nX2xpYi5UZXh0RW5jb2RlciA9IFRleHRFbmNvZGVyOwoJCWVuY29kaW5nX2xpYi5UZXh0RGVjb2RlciA9IFRleHREZWNvZGVyOwoJCXJldHVybiBlbmNvZGluZ19saWI7Cgl9CgoJdmFyIGhhc1JlcXVpcmVkTGliOwoKCWZ1bmN0aW9uIHJlcXVpcmVMaWIgKCkgewoJCWlmIChoYXNSZXF1aXJlZExpYikgcmV0dXJuIGxpYjsKCQloYXNSZXF1aXJlZExpYiA9IDE7CgkJdmFyIF9fY3JlYXRlQmluZGluZyA9IChsaWIgJiYgbGliLl9fY3JlYXRlQmluZGluZykgfHwgKE9iamVjdC5jcmVhdGUgPyAoZnVuY3Rpb24obywgbSwgaywgazIpIHsKCQkgICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKCQkgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBtW2tdOyB9IH0pOwoJCX0pIDogKGZ1bmN0aW9uKG8sIG0sIGssIGsyKSB7CgkJICAgIGlmIChrMiA9PT0gdW5kZWZpbmVkKSBrMiA9IGs7CgkJICAgIG9bazJdID0gbVtrXTsKCQl9KSk7CgkJdmFyIF9fc2V0TW9kdWxlRGVmYXVsdCA9IChsaWIgJiYgbGliLl9fc2V0TW9kdWxlRGVmYXVsdCkgfHwgKE9iamVjdC5jcmVhdGUgPyAoZnVuY3Rpb24obywgdikgewoJCSAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobywgImRlZmF1bHQiLCB7IGVudW1lcmFibGU6IHRydWUsIHZhbHVlOiB2IH0pOwoJCX0pIDogZnVuY3Rpb24obywgdikgewoJCSAgICBvWyJkZWZhdWx0Il0gPSB2OwoJCX0pOwoJCXZhciBfX2RlY29yYXRlID0gKGxpYiAmJiBsaWIuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7CgkJICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7CgkJICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09ICJmdW5jdGlvbiIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTsKCQkgICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjsKCQkgICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjsKCQl9OwoJCXZhciBfX2ltcG9ydFN0YXIgPSAobGliICYmIGxpYi5fX2ltcG9ydFN0YXIpIHx8IGZ1bmN0aW9uIChtb2QpIHsKCQkgICAgaWYgKG1vZCAmJiBtb2QuX19lc01vZHVsZSkgcmV0dXJuIG1vZDsKCQkgICAgdmFyIHJlc3VsdCA9IHt9OwoJCSAgICBpZiAobW9kICE9IG51bGwpIGZvciAodmFyIGsgaW4gbW9kKSBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1vZCwgaykpIF9fY3JlYXRlQmluZGluZyhyZXN1bHQsIG1vZCwgayk7CgkJICAgIF9fc2V0TW9kdWxlRGVmYXVsdChyZXN1bHQsIG1vZCk7CgkJICAgIHJldHVybiByZXN1bHQ7CgkJfTsKCQl2YXIgX19pbXBvcnREZWZhdWx0ID0gKGxpYiAmJiBsaWIuX19pbXBvcnREZWZhdWx0KSB8fCBmdW5jdGlvbiAobW9kKSB7CgkJICAgIHJldHVybiAobW9kICYmIG1vZC5fX2VzTW9kdWxlKSA/IG1vZCA6IHsgImRlZmF1bHQiOiBtb2QgfTsKCQl9OwoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShsaWIsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKCQlsaWIuZGVzZXJpYWxpemVVbmNoZWNrZWQgPSBsaWIuZGVzZXJpYWxpemUgPSBsaWIuc2VyaWFsaXplID0gbGliLkJpbmFyeVJlYWRlciA9IGxpYi5CaW5hcnlXcml0ZXIgPSBsaWIuQm9yc2hFcnJvciA9IGxpYi5iYXNlRGVjb2RlID0gbGliLmJhc2VFbmNvZGUgPSB2b2lkIDA7CgkJY29uc3QgYm5fanNfMSA9IF9faW1wb3J0RGVmYXVsdCgvKkBfX1BVUkVfXyovIHJlcXVpcmVCbigpKTsKCQljb25zdCBiczU4XzEgPSBfX2ltcG9ydERlZmF1bHQoLypAX19QVVJFX18qLyByZXF1aXJlQnM1OCgpKTsKCQkvLyBUT0RPOiBNYWtlIHN1cmUgdGhpcyBwb2x5ZmlsbCBub3QgaW5jbHVkZWQgd2hlbiBub3QgcmVxdWlyZWQKCQljb25zdCBlbmNvZGluZyA9IF9faW1wb3J0U3RhcigvKkBfX1BVUkVfXyovIHJlcXVpcmVFbmNvZGluZ19saWIoKSk7CgkJY29uc3QgUmVzb2x2ZWRUZXh0RGVjb2RlciA9IHR5cGVvZiBUZXh0RGVjb2RlciAhPT0gImZ1bmN0aW9uIiA/IGVuY29kaW5nLlRleHREZWNvZGVyIDogVGV4dERlY29kZXI7CgkJY29uc3QgdGV4dERlY29kZXIgPSBuZXcgUmVzb2x2ZWRUZXh0RGVjb2RlcigidXRmLTgiLCB7IGZhdGFsOiB0cnVlIH0pOwoJCWZ1bmN0aW9uIGJhc2VFbmNvZGUodmFsdWUpIHsKCQkgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKCQkgICAgICAgIHZhbHVlID0gQnVmZmVyLmZyb20odmFsdWUsICJ1dGY4Iik7CgkJICAgIH0KCQkgICAgcmV0dXJuIGJzNThfMS5kZWZhdWx0LmVuY29kZShCdWZmZXIuZnJvbSh2YWx1ZSkpOwoJCX0KCQlsaWIuYmFzZUVuY29kZSA9IGJhc2VFbmNvZGU7CgkJZnVuY3Rpb24gYmFzZURlY29kZSh2YWx1ZSkgewoJCSAgICByZXR1cm4gQnVmZmVyLmZyb20oYnM1OF8xLmRlZmF1bHQuZGVjb2RlKHZhbHVlKSk7CgkJfQoJCWxpYi5iYXNlRGVjb2RlID0gYmFzZURlY29kZTsKCQljb25zdCBJTklUSUFMX0xFTkdUSCA9IDEwMjQ7CgkJY2xhc3MgQm9yc2hFcnJvciBleHRlbmRzIEVycm9yIHsKCQkgICAgY29uc3RydWN0b3IobWVzc2FnZSkgewoJCSAgICAgICAgc3VwZXIobWVzc2FnZSk7CgkJICAgICAgICB0aGlzLmZpZWxkUGF0aCA9IFtdOwoJCSAgICAgICAgdGhpcy5vcmlnaW5hbE1lc3NhZ2UgPSBtZXNzYWdlOwoJCSAgICB9CgkJICAgIGFkZFRvRmllbGRQYXRoKGZpZWxkTmFtZSkgewoJCSAgICAgICAgdGhpcy5maWVsZFBhdGguc3BsaWNlKDAsIDAsIGZpZWxkTmFtZSk7CgkJICAgICAgICAvLyBOT1RFOiBNb2RpZnlpbmcgbWVzc2FnZSBkaXJlY3RseSBhcyBqZXN0IGRvZXNuJ3QgdXNlIC50b1N0cmluZygpCgkJICAgICAgICB0aGlzLm1lc3NhZ2UgPSB0aGlzLm9yaWdpbmFsTWVzc2FnZSArICI6ICIgKyB0aGlzLmZpZWxkUGF0aC5qb2luKCIuIik7CgkJICAgIH0KCQl9CgkJbGliLkJvcnNoRXJyb3IgPSBCb3JzaEVycm9yOwoJCS8vLyBCaW5hcnkgZW5jb2Rlci4KCQljbGFzcyBCaW5hcnlXcml0ZXIgewoJCSAgICBjb25zdHJ1Y3RvcigpIHsKCQkgICAgICAgIHRoaXMuYnVmID0gQnVmZmVyLmFsbG9jKElOSVRJQUxfTEVOR1RIKTsKCQkgICAgICAgIHRoaXMubGVuZ3RoID0gMDsKCQkgICAgfQoJCSAgICBtYXliZVJlc2l6ZSgpIHsKCQkgICAgICAgIGlmICh0aGlzLmJ1Zi5sZW5ndGggPCAxNiArIHRoaXMubGVuZ3RoKSB7CgkJICAgICAgICAgICAgdGhpcy5idWYgPSBCdWZmZXIuY29uY2F0KFt0aGlzLmJ1ZiwgQnVmZmVyLmFsbG9jKElOSVRJQUxfTEVOR1RIKV0pOwoJCSAgICAgICAgfQoJCSAgICB9CgkJICAgIHdyaXRlVTgodmFsdWUpIHsKCQkgICAgICAgIHRoaXMubWF5YmVSZXNpemUoKTsKCQkgICAgICAgIHRoaXMuYnVmLndyaXRlVUludDgodmFsdWUsIHRoaXMubGVuZ3RoKTsKCQkgICAgICAgIHRoaXMubGVuZ3RoICs9IDE7CgkJICAgIH0KCQkgICAgd3JpdGVVMTYodmFsdWUpIHsKCQkgICAgICAgIHRoaXMubWF5YmVSZXNpemUoKTsKCQkgICAgICAgIHRoaXMuYnVmLndyaXRlVUludDE2TEUodmFsdWUsIHRoaXMubGVuZ3RoKTsKCQkgICAgICAgIHRoaXMubGVuZ3RoICs9IDI7CgkJICAgIH0KCQkgICAgd3JpdGVVMzIodmFsdWUpIHsKCQkgICAgICAgIHRoaXMubWF5YmVSZXNpemUoKTsKCQkgICAgICAgIHRoaXMuYnVmLndyaXRlVUludDMyTEUodmFsdWUsIHRoaXMubGVuZ3RoKTsKCQkgICAgICAgIHRoaXMubGVuZ3RoICs9IDQ7CgkJICAgIH0KCQkgICAgd3JpdGVVNjQodmFsdWUpIHsKCQkgICAgICAgIHRoaXMubWF5YmVSZXNpemUoKTsKCQkgICAgICAgIHRoaXMud3JpdGVCdWZmZXIoQnVmZmVyLmZyb20obmV3IGJuX2pzXzEuZGVmYXVsdCh2YWx1ZSkudG9BcnJheSgibGUiLCA4KSkpOwoJCSAgICB9CgkJICAgIHdyaXRlVTEyOCh2YWx1ZSkgewoJCSAgICAgICAgdGhpcy5tYXliZVJlc2l6ZSgpOwoJCSAgICAgICAgdGhpcy53cml0ZUJ1ZmZlcihCdWZmZXIuZnJvbShuZXcgYm5fanNfMS5kZWZhdWx0KHZhbHVlKS50b0FycmF5KCJsZSIsIDE2KSkpOwoJCSAgICB9CgkJICAgIHdyaXRlVTI1Nih2YWx1ZSkgewoJCSAgICAgICAgdGhpcy5tYXliZVJlc2l6ZSgpOwoJCSAgICAgICAgdGhpcy53cml0ZUJ1ZmZlcihCdWZmZXIuZnJvbShuZXcgYm5fanNfMS5kZWZhdWx0KHZhbHVlKS50b0FycmF5KCJsZSIsIDMyKSkpOwoJCSAgICB9CgkJICAgIHdyaXRlVTUxMih2YWx1ZSkgewoJCSAgICAgICAgdGhpcy5tYXliZVJlc2l6ZSgpOwoJCSAgICAgICAgdGhpcy53cml0ZUJ1ZmZlcihCdWZmZXIuZnJvbShuZXcgYm5fanNfMS5kZWZhdWx0KHZhbHVlKS50b0FycmF5KCJsZSIsIDY0KSkpOwoJCSAgICB9CgkJICAgIHdyaXRlQnVmZmVyKGJ1ZmZlcikgewoJCSAgICAgICAgLy8gQnVmZmVyLmZyb20gaXMgbmVlZGVkIGFzIHRoaXMuYnVmLnN1YmFycmF5IGNhbiByZXR1cm4gcGxhaW4gVWludDhBcnJheSBpbiBicm93c2VyCgkJICAgICAgICB0aGlzLmJ1ZiA9IEJ1ZmZlci5jb25jYXQoWwoJCSAgICAgICAgICAgIEJ1ZmZlci5mcm9tKHRoaXMuYnVmLnN1YmFycmF5KDAsIHRoaXMubGVuZ3RoKSksCgkJICAgICAgICAgICAgYnVmZmVyLAoJCSAgICAgICAgICAgIEJ1ZmZlci5hbGxvYyhJTklUSUFMX0xFTkdUSCksCgkJICAgICAgICBdKTsKCQkgICAgICAgIHRoaXMubGVuZ3RoICs9IGJ1ZmZlci5sZW5ndGg7CgkJICAgIH0KCQkgICAgd3JpdGVTdHJpbmcoc3RyKSB7CgkJICAgICAgICB0aGlzLm1heWJlUmVzaXplKCk7CgkJICAgICAgICBjb25zdCBiID0gQnVmZmVyLmZyb20oc3RyLCAidXRmOCIpOwoJCSAgICAgICAgdGhpcy53cml0ZVUzMihiLmxlbmd0aCk7CgkJICAgICAgICB0aGlzLndyaXRlQnVmZmVyKGIpOwoJCSAgICB9CgkJICAgIHdyaXRlRml4ZWRBcnJheShhcnJheSkgewoJCSAgICAgICAgdGhpcy53cml0ZUJ1ZmZlcihCdWZmZXIuZnJvbShhcnJheSkpOwoJCSAgICB9CgkJICAgIHdyaXRlQXJyYXkoYXJyYXksIGZuKSB7CgkJICAgICAgICB0aGlzLm1heWJlUmVzaXplKCk7CgkJICAgICAgICB0aGlzLndyaXRlVTMyKGFycmF5Lmxlbmd0aCk7CgkJICAgICAgICBmb3IgKGNvbnN0IGVsZW0gb2YgYXJyYXkpIHsKCQkgICAgICAgICAgICB0aGlzLm1heWJlUmVzaXplKCk7CgkJICAgICAgICAgICAgZm4oZWxlbSk7CgkJICAgICAgICB9CgkJICAgIH0KCQkgICAgdG9BcnJheSgpIHsKCQkgICAgICAgIHJldHVybiB0aGlzLmJ1Zi5zdWJhcnJheSgwLCB0aGlzLmxlbmd0aCk7CgkJICAgIH0KCQl9CgkJbGliLkJpbmFyeVdyaXRlciA9IEJpbmFyeVdyaXRlcjsKCQlmdW5jdGlvbiBoYW5kbGluZ1JhbmdlRXJyb3IodGFyZ2V0LCBwcm9wZXJ0eUtleSwgcHJvcGVydHlEZXNjcmlwdG9yKSB7CgkJICAgIGNvbnN0IG9yaWdpbmFsTWV0aG9kID0gcHJvcGVydHlEZXNjcmlwdG9yLnZhbHVlOwoJCSAgICBwcm9wZXJ0eURlc2NyaXB0b3IudmFsdWUgPSBmdW5jdGlvbiAoLi4uYXJncykgewoJCSAgICAgICAgdHJ5IHsKCQkgICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxNZXRob2QuYXBwbHkodGhpcywgYXJncyk7CgkJICAgICAgICB9CgkJICAgICAgICBjYXRjaCAoZSkgewoJCSAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgUmFuZ2VFcnJvcikgewoJCSAgICAgICAgICAgICAgICBjb25zdCBjb2RlID0gZS5jb2RlOwoJCSAgICAgICAgICAgICAgICBpZiAoWyJFUlJfQlVGRkVSX09VVF9PRl9CT1VORFMiLCAiRVJSX09VVF9PRl9SQU5HRSJdLmluZGV4T2YoY29kZSkgPj0gMCkgewoJCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJvcnNoRXJyb3IoIlJlYWNoZWQgdGhlIGVuZCBvZiBidWZmZXIgd2hlbiBkZXNlcmlhbGl6aW5nIik7CgkJICAgICAgICAgICAgICAgIH0KCQkgICAgICAgICAgICB9CgkJICAgICAgICAgICAgdGhyb3cgZTsKCQkgICAgICAgIH0KCQkgICAgfTsKCQl9CgkJY2xhc3MgQmluYXJ5UmVhZGVyIHsKCQkgICAgY29uc3RydWN0b3IoYnVmKSB7CgkJICAgICAgICB0aGlzLmJ1ZiA9IGJ1ZjsKCQkgICAgICAgIHRoaXMub2Zmc2V0ID0gMDsKCQkgICAgfQoJCSAgICByZWFkVTgoKSB7CgkJICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuYnVmLnJlYWRVSW50OCh0aGlzLm9mZnNldCk7CgkJICAgICAgICB0aGlzLm9mZnNldCArPSAxOwoJCSAgICAgICAgcmV0dXJuIHZhbHVlOwoJCSAgICB9CgkJICAgIHJlYWRVMTYoKSB7CgkJICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuYnVmLnJlYWRVSW50MTZMRSh0aGlzLm9mZnNldCk7CgkJICAgICAgICB0aGlzLm9mZnNldCArPSAyOwoJCSAgICAgICAgcmV0dXJuIHZhbHVlOwoJCSAgICB9CgkJICAgIHJlYWRVMzIoKSB7CgkJICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuYnVmLnJlYWRVSW50MzJMRSh0aGlzLm9mZnNldCk7CgkJICAgICAgICB0aGlzLm9mZnNldCArPSA0OwoJCSAgICAgICAgcmV0dXJuIHZhbHVlOwoJCSAgICB9CgkJICAgIHJlYWRVNjQoKSB7CgkJICAgICAgICBjb25zdCBidWYgPSB0aGlzLnJlYWRCdWZmZXIoOCk7CgkJICAgICAgICByZXR1cm4gbmV3IGJuX2pzXzEuZGVmYXVsdChidWYsICJsZSIpOwoJCSAgICB9CgkJICAgIHJlYWRVMTI4KCkgewoJCSAgICAgICAgY29uc3QgYnVmID0gdGhpcy5yZWFkQnVmZmVyKDE2KTsKCQkgICAgICAgIHJldHVybiBuZXcgYm5fanNfMS5kZWZhdWx0KGJ1ZiwgImxlIik7CgkJICAgIH0KCQkgICAgcmVhZFUyNTYoKSB7CgkJICAgICAgICBjb25zdCBidWYgPSB0aGlzLnJlYWRCdWZmZXIoMzIpOwoJCSAgICAgICAgcmV0dXJuIG5ldyBibl9qc18xLmRlZmF1bHQoYnVmLCAibGUiKTsKCQkgICAgfQoJCSAgICByZWFkVTUxMigpIHsKCQkgICAgICAgIGNvbnN0IGJ1ZiA9IHRoaXMucmVhZEJ1ZmZlcig2NCk7CgkJICAgICAgICByZXR1cm4gbmV3IGJuX2pzXzEuZGVmYXVsdChidWYsICJsZSIpOwoJCSAgICB9CgkJICAgIHJlYWRCdWZmZXIobGVuKSB7CgkJICAgICAgICBpZiAodGhpcy5vZmZzZXQgKyBsZW4gPiB0aGlzLmJ1Zi5sZW5ndGgpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgQm9yc2hFcnJvcihgRXhwZWN0ZWQgYnVmZmVyIGxlbmd0aCAke2xlbn0gaXNuJ3Qgd2l0aGluIGJvdW5kc2ApOwoJCSAgICAgICAgfQoJCSAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5idWYuc2xpY2UodGhpcy5vZmZzZXQsIHRoaXMub2Zmc2V0ICsgbGVuKTsKCQkgICAgICAgIHRoaXMub2Zmc2V0ICs9IGxlbjsKCQkgICAgICAgIHJldHVybiByZXN1bHQ7CgkJICAgIH0KCQkgICAgcmVhZFN0cmluZygpIHsKCQkgICAgICAgIGNvbnN0IGxlbiA9IHRoaXMucmVhZFUzMigpOwoJCSAgICAgICAgY29uc3QgYnVmID0gdGhpcy5yZWFkQnVmZmVyKGxlbik7CgkJICAgICAgICB0cnkgewoJCSAgICAgICAgICAgIC8vIE5PVEU6IFVzaW5nIFRleHREZWNvZGVyIHRvIGZhaWwgb24gaW52YWxpZCBVVEYtOAoJCSAgICAgICAgICAgIHJldHVybiB0ZXh0RGVjb2Rlci5kZWNvZGUoYnVmKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGNhdGNoIChlKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IEJvcnNoRXJyb3IoYEVycm9yIGRlY29kaW5nIFVURi04IHN0cmluZzogJHtlfWApOwoJCSAgICAgICAgfQoJCSAgICB9CgkJICAgIHJlYWRGaXhlZEFycmF5KGxlbikgewoJCSAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHRoaXMucmVhZEJ1ZmZlcihsZW4pKTsKCQkgICAgfQoJCSAgICByZWFkQXJyYXkoZm4pIHsKCQkgICAgICAgIGNvbnN0IGxlbiA9IHRoaXMucmVhZFUzMigpOwoJCSAgICAgICAgY29uc3QgcmVzdWx0ID0gQXJyYXkoKTsKCQkgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKCQkgICAgICAgICAgICByZXN1bHQucHVzaChmbigpKTsKCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiByZXN1bHQ7CgkJICAgIH0KCQl9CgkJX19kZWNvcmF0ZShbCgkJICAgIGhhbmRsaW5nUmFuZ2VFcnJvcgoJCV0sIEJpbmFyeVJlYWRlci5wcm90b3R5cGUsICJyZWFkVTgiLCBudWxsKTsKCQlfX2RlY29yYXRlKFsKCQkgICAgaGFuZGxpbmdSYW5nZUVycm9yCgkJXSwgQmluYXJ5UmVhZGVyLnByb3RvdHlwZSwgInJlYWRVMTYiLCBudWxsKTsKCQlfX2RlY29yYXRlKFsKCQkgICAgaGFuZGxpbmdSYW5nZUVycm9yCgkJXSwgQmluYXJ5UmVhZGVyLnByb3RvdHlwZSwgInJlYWRVMzIiLCBudWxsKTsKCQlfX2RlY29yYXRlKFsKCQkgICAgaGFuZGxpbmdSYW5nZUVycm9yCgkJXSwgQmluYXJ5UmVhZGVyLnByb3RvdHlwZSwgInJlYWRVNjQiLCBudWxsKTsKCQlfX2RlY29yYXRlKFsKCQkgICAgaGFuZGxpbmdSYW5nZUVycm9yCgkJXSwgQmluYXJ5UmVhZGVyLnByb3RvdHlwZSwgInJlYWRVMTI4IiwgbnVsbCk7CgkJX19kZWNvcmF0ZShbCgkJICAgIGhhbmRsaW5nUmFuZ2VFcnJvcgoJCV0sIEJpbmFyeVJlYWRlci5wcm90b3R5cGUsICJyZWFkVTI1NiIsIG51bGwpOwoJCV9fZGVjb3JhdGUoWwoJCSAgICBoYW5kbGluZ1JhbmdlRXJyb3IKCQldLCBCaW5hcnlSZWFkZXIucHJvdG90eXBlLCAicmVhZFU1MTIiLCBudWxsKTsKCQlfX2RlY29yYXRlKFsKCQkgICAgaGFuZGxpbmdSYW5nZUVycm9yCgkJXSwgQmluYXJ5UmVhZGVyLnByb3RvdHlwZSwgInJlYWRTdHJpbmciLCBudWxsKTsKCQlfX2RlY29yYXRlKFsKCQkgICAgaGFuZGxpbmdSYW5nZUVycm9yCgkJXSwgQmluYXJ5UmVhZGVyLnByb3RvdHlwZSwgInJlYWRGaXhlZEFycmF5IiwgbnVsbCk7CgkJX19kZWNvcmF0ZShbCgkJICAgIGhhbmRsaW5nUmFuZ2VFcnJvcgoJCV0sIEJpbmFyeVJlYWRlci5wcm90b3R5cGUsICJyZWFkQXJyYXkiLCBudWxsKTsKCQlsaWIuQmluYXJ5UmVhZGVyID0gQmluYXJ5UmVhZGVyOwoJCWZ1bmN0aW9uIGNhcGl0YWxpemVGaXJzdExldHRlcihzdHJpbmcpIHsKCQkgICAgcmV0dXJuIHN0cmluZy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zbGljZSgxKTsKCQl9CgkJZnVuY3Rpb24gc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIHZhbHVlLCBmaWVsZFR5cGUsIHdyaXRlcikgewoJCSAgICB0cnkgewoJCSAgICAgICAgLy8gVE9ETzogSGFuZGxlIG1pc3NpbmcgdmFsdWVzIHByb3Blcmx5IChtYWtlIHN1cmUgdGhleSBuZXZlciByZXN1bHQgaW4ganVzdCBza2lwcGVkIHdyaXRlKQoJCSAgICAgICAgaWYgKHR5cGVvZiBmaWVsZFR5cGUgPT09ICJzdHJpbmciKSB7CgkJICAgICAgICAgICAgd3JpdGVyW2B3cml0ZSR7Y2FwaXRhbGl6ZUZpcnN0TGV0dGVyKGZpZWxkVHlwZSl9YF0odmFsdWUpOwoJCSAgICAgICAgfQoJCSAgICAgICAgZWxzZSBpZiAoZmllbGRUeXBlIGluc3RhbmNlb2YgQXJyYXkpIHsKCQkgICAgICAgICAgICBpZiAodHlwZW9mIGZpZWxkVHlwZVswXSA9PT0gIm51bWJlciIpIHsKCQkgICAgICAgICAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCAhPT0gZmllbGRUeXBlWzBdKSB7CgkJICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQm9yc2hFcnJvcihgRXhwZWN0aW5nIGJ5dGUgYXJyYXkgb2YgbGVuZ3RoICR7ZmllbGRUeXBlWzBdfSwgYnV0IGdvdCAke3ZhbHVlLmxlbmd0aH0gYnl0ZXNgKTsKCQkgICAgICAgICAgICAgICAgfQoJCSAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGVGaXhlZEFycmF5KHZhbHVlKTsKCQkgICAgICAgICAgICB9CgkJICAgICAgICAgICAgZWxzZSBpZiAoZmllbGRUeXBlLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgZmllbGRUeXBlWzFdID09PSAibnVtYmVyIikgewoJCSAgICAgICAgICAgICAgICBpZiAodmFsdWUubGVuZ3RoICE9PSBmaWVsZFR5cGVbMV0pIHsKCQkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBCb3JzaEVycm9yKGBFeHBlY3RpbmcgYnl0ZSBhcnJheSBvZiBsZW5ndGggJHtmaWVsZFR5cGVbMV19LCBidXQgZ290ICR7dmFsdWUubGVuZ3RofSBieXRlc2ApOwoJCSAgICAgICAgICAgICAgICB9CgkJICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmllbGRUeXBlWzFdOyBpKyspIHsKCQkgICAgICAgICAgICAgICAgICAgIHNlcmlhbGl6ZUZpZWxkKHNjaGVtYSwgbnVsbCwgdmFsdWVbaV0sIGZpZWxkVHlwZVswXSwgd3JpdGVyKTsKCQkgICAgICAgICAgICAgICAgfQoJCSAgICAgICAgICAgIH0KCQkgICAgICAgICAgICBlbHNlIHsKCQkgICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlQXJyYXkodmFsdWUsIChpdGVtKSA9PiB7CgkJICAgICAgICAgICAgICAgICAgICBzZXJpYWxpemVGaWVsZChzY2hlbWEsIGZpZWxkTmFtZSwgaXRlbSwgZmllbGRUeXBlWzBdLCB3cml0ZXIpOwoJCSAgICAgICAgICAgICAgICB9KTsKCQkgICAgICAgICAgICB9CgkJICAgICAgICB9CgkJICAgICAgICBlbHNlIGlmIChmaWVsZFR5cGUua2luZCAhPT0gdW5kZWZpbmVkKSB7CgkJICAgICAgICAgICAgc3dpdGNoIChmaWVsZFR5cGUua2luZCkgewoJCSAgICAgICAgICAgICAgICBjYXNlICJvcHRpb24iOiB7CgkJICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewoJCSAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlci53cml0ZVU4KDApOwoJCSAgICAgICAgICAgICAgICAgICAgfQoJCSAgICAgICAgICAgICAgICAgICAgZWxzZSB7CgkJICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlVTgoMSk7CgkJICAgICAgICAgICAgICAgICAgICAgICAgc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIHZhbHVlLCBmaWVsZFR5cGUudHlwZSwgd3JpdGVyKTsKCQkgICAgICAgICAgICAgICAgICAgIH0KCQkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJCSAgICAgICAgICAgICAgICB9CgkJICAgICAgICAgICAgICAgIGNhc2UgIm1hcCI6IHsKCQkgICAgICAgICAgICAgICAgICAgIHdyaXRlci53cml0ZVUzMih2YWx1ZS5zaXplKTsKCQkgICAgICAgICAgICAgICAgICAgIHZhbHVlLmZvckVhY2goKHZhbCwga2V5KSA9PiB7CgkJICAgICAgICAgICAgICAgICAgICAgICAgc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIGtleSwgZmllbGRUeXBlLmtleSwgd3JpdGVyKTsKCQkgICAgICAgICAgICAgICAgICAgICAgICBzZXJpYWxpemVGaWVsZChzY2hlbWEsIGZpZWxkTmFtZSwgdmFsLCBmaWVsZFR5cGUudmFsdWUsIHdyaXRlcik7CgkJICAgICAgICAgICAgICAgICAgICB9KTsKCQkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJCSAgICAgICAgICAgICAgICB9CgkJICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkJICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQm9yc2hFcnJvcihgRmllbGRUeXBlICR7ZmllbGRUeXBlfSB1bnJlY29nbml6ZWRgKTsKCQkgICAgICAgICAgICB9CgkJICAgICAgICB9CgkJICAgICAgICBlbHNlIHsKCQkgICAgICAgICAgICBzZXJpYWxpemVTdHJ1Y3Qoc2NoZW1hLCB2YWx1ZSwgd3JpdGVyKTsKCQkgICAgICAgIH0KCQkgICAgfQoJCSAgICBjYXRjaCAoZXJyb3IpIHsKCQkgICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEJvcnNoRXJyb3IpIHsKCQkgICAgICAgICAgICBlcnJvci5hZGRUb0ZpZWxkUGF0aChmaWVsZE5hbWUpOwoJCSAgICAgICAgfQoJCSAgICAgICAgdGhyb3cgZXJyb3I7CgkJICAgIH0KCQl9CgkJZnVuY3Rpb24gc2VyaWFsaXplU3RydWN0KHNjaGVtYSwgb2JqLCB3cml0ZXIpIHsKCQkgICAgaWYgKHR5cGVvZiBvYmouYm9yc2hTZXJpYWxpemUgPT09ICJmdW5jdGlvbiIpIHsKCQkgICAgICAgIG9iai5ib3JzaFNlcmlhbGl6ZSh3cml0ZXIpOwoJCSAgICAgICAgcmV0dXJuOwoJCSAgICB9CgkJICAgIGNvbnN0IHN0cnVjdFNjaGVtYSA9IHNjaGVtYS5nZXQob2JqLmNvbnN0cnVjdG9yKTsKCQkgICAgaWYgKCFzdHJ1Y3RTY2hlbWEpIHsKCQkgICAgICAgIHRocm93IG5ldyBCb3JzaEVycm9yKGBDbGFzcyAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSBpcyBtaXNzaW5nIGluIHNjaGVtYWApOwoJCSAgICB9CgkJICAgIGlmIChzdHJ1Y3RTY2hlbWEua2luZCA9PT0gInN0cnVjdCIpIHsKCQkgICAgICAgIHN0cnVjdFNjaGVtYS5maWVsZHMubWFwKChbZmllbGROYW1lLCBmaWVsZFR5cGVdKSA9PiB7CgkJICAgICAgICAgICAgc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIG9ialtmaWVsZE5hbWVdLCBmaWVsZFR5cGUsIHdyaXRlcik7CgkJICAgICAgICB9KTsKCQkgICAgfQoJCSAgICBlbHNlIGlmIChzdHJ1Y3RTY2hlbWEua2luZCA9PT0gImVudW0iKSB7CgkJICAgICAgICBjb25zdCBuYW1lID0gb2JqW3N0cnVjdFNjaGVtYS5maWVsZF07CgkJICAgICAgICBmb3IgKGxldCBpZHggPSAwOyBpZHggPCBzdHJ1Y3RTY2hlbWEudmFsdWVzLmxlbmd0aDsgKytpZHgpIHsKCQkgICAgICAgICAgICBjb25zdCBbZmllbGROYW1lLCBmaWVsZFR5cGVdID0gc3RydWN0U2NoZW1hLnZhbHVlc1tpZHhdOwoJCSAgICAgICAgICAgIGlmIChmaWVsZE5hbWUgPT09IG5hbWUpIHsKCQkgICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlVTgoaWR4KTsKCQkgICAgICAgICAgICAgICAgc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIG9ialtmaWVsZE5hbWVdLCBmaWVsZFR5cGUsIHdyaXRlcik7CgkJICAgICAgICAgICAgICAgIGJyZWFrOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgIH0KCQkgICAgfQoJCSAgICBlbHNlIHsKCQkgICAgICAgIHRocm93IG5ldyBCb3JzaEVycm9yKGBVbmV4cGVjdGVkIHNjaGVtYSBraW5kOiAke3N0cnVjdFNjaGVtYS5raW5kfSBmb3IgJHtvYmouY29uc3RydWN0b3IubmFtZX1gKTsKCQkgICAgfQoJCX0KCQkvLy8gU2VyaWFsaXplIGdpdmVuIG9iamVjdCB1c2luZyBzY2hlbWEgb2YgdGhlIGZvcm06CgkJLy8vIHsgY2xhc3NfbmFtZSAtPiBbIFtmaWVsZF9uYW1lLCBmaWVsZF90eXBlXSwgLi4gXSwgLi4gfQoJCWZ1bmN0aW9uIHNlcmlhbGl6ZShzY2hlbWEsIG9iaiwgV3JpdGVyID0gQmluYXJ5V3JpdGVyKSB7CgkJICAgIGNvbnN0IHdyaXRlciA9IG5ldyBXcml0ZXIoKTsKCQkgICAgc2VyaWFsaXplU3RydWN0KHNjaGVtYSwgb2JqLCB3cml0ZXIpOwoJCSAgICByZXR1cm4gd3JpdGVyLnRvQXJyYXkoKTsKCQl9CgkJbGliLnNlcmlhbGl6ZSA9IHNlcmlhbGl6ZTsKCQlmdW5jdGlvbiBkZXNlcmlhbGl6ZUZpZWxkKHNjaGVtYSwgZmllbGROYW1lLCBmaWVsZFR5cGUsIHJlYWRlcikgewoJCSAgICB0cnkgewoJCSAgICAgICAgaWYgKHR5cGVvZiBmaWVsZFR5cGUgPT09ICJzdHJpbmciKSB7CgkJICAgICAgICAgICAgcmV0dXJuIHJlYWRlcltgcmVhZCR7Y2FwaXRhbGl6ZUZpcnN0TGV0dGVyKGZpZWxkVHlwZSl9YF0oKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGlmIChmaWVsZFR5cGUgaW5zdGFuY2VvZiBBcnJheSkgewoJCSAgICAgICAgICAgIGlmICh0eXBlb2YgZmllbGRUeXBlWzBdID09PSAibnVtYmVyIikgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gcmVhZGVyLnJlYWRGaXhlZEFycmF5KGZpZWxkVHlwZVswXSk7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBmaWVsZFR5cGVbMV0gPT09ICJudW1iZXIiKSB7CgkJICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdOwoJCSAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpZWxkVHlwZVsxXTsgaSsrKSB7CgkJICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChkZXNlcmlhbGl6ZUZpZWxkKHNjaGVtYSwgbnVsbCwgZmllbGRUeXBlWzBdLCByZWFkZXIpKTsKCQkgICAgICAgICAgICAgICAgfQoJCSAgICAgICAgICAgICAgICByZXR1cm4gYXJyOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgICAgICBlbHNlIHsKCQkgICAgICAgICAgICAgICAgcmV0dXJuIHJlYWRlci5yZWFkQXJyYXkoKCkgPT4gZGVzZXJpYWxpemVGaWVsZChzY2hlbWEsIGZpZWxkTmFtZSwgZmllbGRUeXBlWzBdLCByZWFkZXIpKTsKCQkgICAgICAgICAgICB9CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoZmllbGRUeXBlLmtpbmQgPT09ICJvcHRpb24iKSB7CgkJICAgICAgICAgICAgY29uc3Qgb3B0aW9uID0gcmVhZGVyLnJlYWRVOCgpOwoJCSAgICAgICAgICAgIGlmIChvcHRpb24pIHsKCQkgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIGZpZWxkVHlwZS50eXBlLCByZWFkZXIpOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKGZpZWxkVHlwZS5raW5kID09PSAibWFwIikgewoJCSAgICAgICAgICAgIGxldCBtYXAgPSBuZXcgTWFwKCk7CgkJICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gcmVhZGVyLnJlYWRVMzIoKTsKCQkgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGRlc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIGZpZWxkVHlwZS5rZXksIHJlYWRlcik7CgkJICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGRlc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIGZpZWxkVHlwZS52YWx1ZSwgcmVhZGVyKTsKCQkgICAgICAgICAgICAgICAgbWFwLnNldChrZXksIHZhbCk7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgICAgIHJldHVybiBtYXA7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gZGVzZXJpYWxpemVTdHJ1Y3Qoc2NoZW1hLCBmaWVsZFR5cGUsIHJlYWRlcik7CgkJICAgIH0KCQkgICAgY2F0Y2ggKGVycm9yKSB7CgkJICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBCb3JzaEVycm9yKSB7CgkJICAgICAgICAgICAgZXJyb3IuYWRkVG9GaWVsZFBhdGgoZmllbGROYW1lKTsKCQkgICAgICAgIH0KCQkgICAgICAgIHRocm93IGVycm9yOwoJCSAgICB9CgkJfQoJCWZ1bmN0aW9uIGRlc2VyaWFsaXplU3RydWN0KHNjaGVtYSwgY2xhc3NUeXBlLCByZWFkZXIpIHsKCQkgICAgaWYgKHR5cGVvZiBjbGFzc1R5cGUuYm9yc2hEZXNlcmlhbGl6ZSA9PT0gImZ1bmN0aW9uIikgewoJCSAgICAgICAgcmV0dXJuIGNsYXNzVHlwZS5ib3JzaERlc2VyaWFsaXplKHJlYWRlcik7CgkJICAgIH0KCQkgICAgY29uc3Qgc3RydWN0U2NoZW1hID0gc2NoZW1hLmdldChjbGFzc1R5cGUpOwoJCSAgICBpZiAoIXN0cnVjdFNjaGVtYSkgewoJCSAgICAgICAgdGhyb3cgbmV3IEJvcnNoRXJyb3IoYENsYXNzICR7Y2xhc3NUeXBlLm5hbWV9IGlzIG1pc3NpbmcgaW4gc2NoZW1hYCk7CgkJICAgIH0KCQkgICAgaWYgKHN0cnVjdFNjaGVtYS5raW5kID09PSAic3RydWN0IikgewoJCSAgICAgICAgY29uc3QgcmVzdWx0ID0ge307CgkJICAgICAgICBmb3IgKGNvbnN0IFtmaWVsZE5hbWUsIGZpZWxkVHlwZV0gb2Ygc2NoZW1hLmdldChjbGFzc1R5cGUpLmZpZWxkcykgewoJCSAgICAgICAgICAgIHJlc3VsdFtmaWVsZE5hbWVdID0gZGVzZXJpYWxpemVGaWVsZChzY2hlbWEsIGZpZWxkTmFtZSwgZmllbGRUeXBlLCByZWFkZXIpOwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIG5ldyBjbGFzc1R5cGUocmVzdWx0KTsKCQkgICAgfQoJCSAgICBpZiAoc3RydWN0U2NoZW1hLmtpbmQgPT09ICJlbnVtIikgewoJCSAgICAgICAgY29uc3QgaWR4ID0gcmVhZGVyLnJlYWRVOCgpOwoJCSAgICAgICAgaWYgKGlkeCA+PSBzdHJ1Y3RTY2hlbWEudmFsdWVzLmxlbmd0aCkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBCb3JzaEVycm9yKGBFbnVtIGluZGV4OiAke2lkeH0gaXMgb3V0IG9mIHJhbmdlYCk7CgkJICAgICAgICB9CgkJICAgICAgICBjb25zdCBbZmllbGROYW1lLCBmaWVsZFR5cGVdID0gc3RydWN0U2NoZW1hLnZhbHVlc1tpZHhdOwoJCSAgICAgICAgY29uc3QgZmllbGRWYWx1ZSA9IGRlc2VyaWFsaXplRmllbGQoc2NoZW1hLCBmaWVsZE5hbWUsIGZpZWxkVHlwZSwgcmVhZGVyKTsKCQkgICAgICAgIHJldHVybiBuZXcgY2xhc3NUeXBlKHsgW2ZpZWxkTmFtZV06IGZpZWxkVmFsdWUgfSk7CgkJICAgIH0KCQkgICAgdGhyb3cgbmV3IEJvcnNoRXJyb3IoYFVuZXhwZWN0ZWQgc2NoZW1hIGtpbmQ6ICR7c3RydWN0U2NoZW1hLmtpbmR9IGZvciAke2NsYXNzVHlwZS5jb25zdHJ1Y3Rvci5uYW1lfWApOwoJCX0KCQkvLy8gRGVzZXJpYWxpemVzIG9iamVjdCBmcm9tIGJ5dGVzIHVzaW5nIHNjaGVtYS4KCQlmdW5jdGlvbiBkZXNlcmlhbGl6ZShzY2hlbWEsIGNsYXNzVHlwZSwgYnVmZmVyLCBSZWFkZXIgPSBCaW5hcnlSZWFkZXIpIHsKCQkgICAgY29uc3QgcmVhZGVyID0gbmV3IFJlYWRlcihidWZmZXIpOwoJCSAgICBjb25zdCByZXN1bHQgPSBkZXNlcmlhbGl6ZVN0cnVjdChzY2hlbWEsIGNsYXNzVHlwZSwgcmVhZGVyKTsKCQkgICAgaWYgKHJlYWRlci5vZmZzZXQgPCBidWZmZXIubGVuZ3RoKSB7CgkJICAgICAgICB0aHJvdyBuZXcgQm9yc2hFcnJvcihgVW5leHBlY3RlZCAke2J1ZmZlci5sZW5ndGggLSByZWFkZXIub2Zmc2V0fSBieXRlcyBhZnRlciBkZXNlcmlhbGl6ZWQgZGF0YWApOwoJCSAgICB9CgkJICAgIHJldHVybiByZXN1bHQ7CgkJfQoJCWxpYi5kZXNlcmlhbGl6ZSA9IGRlc2VyaWFsaXplOwoJCS8vLyBEZXNlcmlhbGl6ZXMgb2JqZWN0IGZyb20gYnl0ZXMgdXNpbmcgc2NoZW1hLCB3aXRob3V0IGNoZWNraW5nIHRoZSBsZW5ndGggcmVhZAoJCWZ1bmN0aW9uIGRlc2VyaWFsaXplVW5jaGVja2VkKHNjaGVtYSwgY2xhc3NUeXBlLCBidWZmZXIsIFJlYWRlciA9IEJpbmFyeVJlYWRlcikgewoJCSAgICBjb25zdCByZWFkZXIgPSBuZXcgUmVhZGVyKGJ1ZmZlcik7CgkJICAgIHJldHVybiBkZXNlcmlhbGl6ZVN0cnVjdChzY2hlbWEsIGNsYXNzVHlwZSwgcmVhZGVyKTsKCQl9CgkJbGliLmRlc2VyaWFsaXplVW5jaGVja2VkID0gZGVzZXJpYWxpemVVbmNoZWNrZWQ7CgkJcmV0dXJuIGxpYjsKCX0KCgl2YXIgbGliRXhwb3J0cyA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUxpYigpOwoKCS8vIENsYXNzIHdyYXBwaW5nIGEgcGxhaW4gb2JqZWN0CglsZXQgU3RydWN0JDEgPSBjbGFzcyBTdHJ1Y3QgewoJICBjb25zdHJ1Y3Rvcihwcm9wZXJ0aWVzKSB7CgkgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBwcm9wZXJ0aWVzKTsKCSAgfQoJICBlbmNvZGUoKSB7CgkgICAgcmV0dXJuIGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20obGliRXhwb3J0cy5zZXJpYWxpemUoU09MQU5BX1NDSEVNQSwgdGhpcykpOwoJICB9CgkgIHN0YXRpYyBkZWNvZGUoZGF0YSkgewoJICAgIHJldHVybiBsaWJFeHBvcnRzLmRlc2VyaWFsaXplKFNPTEFOQV9TQ0hFTUEsIHRoaXMsIGRhdGEpOwoJICB9CgkgIHN0YXRpYyBkZWNvZGVVbmNoZWNrZWQoZGF0YSkgewoJICAgIHJldHVybiBsaWJFeHBvcnRzLmRlc2VyaWFsaXplVW5jaGVja2VkKFNPTEFOQV9TQ0hFTUEsIHRoaXMsIGRhdGEpOwoJICB9Cgl9OwoKCS8vIENsYXNzIHJlcHJlc2VudGluZyBhIFJ1c3QtY29tcGF0aWJsZSBlbnVtLCBzaW5jZSBlbnVtcyBhcmUgb25seSBzdHJpbmdzIG9yCgkvLyBudW1iZXJzIGluIHB1cmUgSlMKCWNsYXNzIEVudW0gZXh0ZW5kcyBTdHJ1Y3QkMSB7CgkgIGNvbnN0cnVjdG9yKHByb3BlcnRpZXMpIHsKCSAgICBzdXBlcihwcm9wZXJ0aWVzKTsKCSAgICB0aGlzLmVudW0gPSAnJzsKCSAgICBpZiAoT2JqZWN0LmtleXMocHJvcGVydGllcykubGVuZ3RoICE9PSAxKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VudW0gY2FuIG9ubHkgdGFrZSBzaW5nbGUgdmFsdWUnKTsKCSAgICB9CgkgICAgT2JqZWN0LmtleXMocHJvcGVydGllcykubWFwKGtleSA9PiB7CgkgICAgICB0aGlzLmVudW0gPSBrZXk7CgkgICAgfSk7CgkgIH0KCX0KCWNvbnN0IFNPTEFOQV9TQ0hFTUEgPSBuZXcgTWFwKCk7CgoJdmFyIF9QdWJsaWNLZXk7CgoJLyoqCgkgKiBNYXhpbXVtIGxlbmd0aCBvZiBkZXJpdmVkIHB1YmtleSBzZWVkCgkgKi8KCWNvbnN0IE1BWF9TRUVEX0xFTkdUSCA9IDMyOwoKCS8qKgoJICogU2l6ZSBvZiBwdWJsaWMga2V5IGluIGJ5dGVzCgkgKi8KCWNvbnN0IFBVQkxJQ19LRVlfTEVOR1RIID0gMzI7CgoJLyoqCgkgKiBWYWx1ZSB0byBiZSBjb252ZXJ0ZWQgaW50byBwdWJsaWMga2V5CgkgKi8KCgkvKioKCSAqIEpTT04gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIFB1YmxpY0tleSBjbGFzcwoJICovCgoJZnVuY3Rpb24gaXNQdWJsaWNLZXlEYXRhKHZhbHVlKSB7CgkgIHJldHVybiB2YWx1ZS5fYm4gIT09IHVuZGVmaW5lZDsKCX0KCgkvLyBsb2NhbCBjb3VudGVyIHVzZWQgYnkgUHVibGljS2V5LnVuaXF1ZSgpCglsZXQgdW5pcXVlUHVibGljS2V5Q291bnRlciA9IDE7CgoJLyoqCgkgKiBBIHB1YmxpYyBrZXkKCSAqLwoJY2xhc3MgUHVibGljS2V5IGV4dGVuZHMgU3RydWN0JDEgewoJICAvKioKCSAgICogQ3JlYXRlIGEgbmV3IFB1YmxpY0tleSBvYmplY3QKCSAgICogQHBhcmFtIHZhbHVlIGVkMjU1MTkgcHVibGljIGtleSBhcyBidWZmZXIgb3IgYmFzZS01OCBlbmNvZGVkIHN0cmluZwoJICAgKi8KCSAgY29uc3RydWN0b3IodmFsdWUpIHsKCSAgICBzdXBlcih7fSk7CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX2JuID0gdm9pZCAwOwoJICAgIGlmIChpc1B1YmxpY0tleURhdGEodmFsdWUpKSB7CgkgICAgICB0aGlzLl9ibiA9IHZhbHVlLl9ibjsKCSAgICB9IGVsc2UgewoJICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKCSAgICAgICAgLy8gYXNzdW1lIGJhc2UgNTggZW5jb2RpbmcgYnkgZGVmYXVsdAoJICAgICAgICBjb25zdCBkZWNvZGVkID0gYnM1OC5kZWNvZGUodmFsdWUpOwoJICAgICAgICBpZiAoZGVjb2RlZC5sZW5ndGggIT0gUFVCTElDX0tFWV9MRU5HVEgpIHsKCSAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcHVibGljIGtleSBpbnB1dGApOwoJICAgICAgICB9CgkgICAgICAgIHRoaXMuX2JuID0gbmV3IEJOKGRlY29kZWQpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5fYm4gPSBuZXcgQk4odmFsdWUpOwoJICAgICAgfQoJICAgICAgaWYgKHRoaXMuX2JuLmJ5dGVMZW5ndGgoKSA+IFBVQkxJQ19LRVlfTEVOR1RIKSB7CgkgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwdWJsaWMga2V5IGlucHV0YCk7CgkgICAgICB9CgkgICAgfQoJICB9CgoJICAvKioKCSAgICogUmV0dXJucyBhIHVuaXF1ZSBQdWJsaWNLZXkgZm9yIHRlc3RzIGFuZCBiZW5jaG1hcmtzIHVzaW5nIGEgY291bnRlcgoJICAgKi8KCSAgc3RhdGljIHVuaXF1ZSgpIHsKCSAgICBjb25zdCBrZXkgPSBuZXcgUHVibGljS2V5KHVuaXF1ZVB1YmxpY0tleUNvdW50ZXIpOwoJICAgIHVuaXF1ZVB1YmxpY0tleUNvdW50ZXIgKz0gMTsKCSAgICByZXR1cm4gbmV3IFB1YmxpY0tleShrZXkudG9CdWZmZXIoKSk7CgkgIH0KCgkgIC8qKgoJICAgKiBEZWZhdWx0IHB1YmxpYyBrZXkgdmFsdWUuIFRoZSBiYXNlNTgtZW5jb2RlZCBzdHJpbmcgcmVwcmVzZW50YXRpb24gaXMgYWxsIG9uZXMgKGFzIHNlZW4gYmVsb3cpCgkgICAqIFRoZSB1bmRlcmx5aW5nIEJOIG51bWJlciBpcyAzMiBieXRlcyB0aGF0IGFyZSBhbGwgemVyb3MKCSAgICovCgoJICAvKioKCSAgICogQ2hlY2tzIGlmIHR3byBwdWJsaWNLZXlzIGFyZSBlcXVhbAoJICAgKi8KCSAgZXF1YWxzKHB1YmxpY0tleSkgewoJICAgIHJldHVybiB0aGlzLl9ibi5lcShwdWJsaWNLZXkuX2JuKTsKCSAgfQoKCSAgLyoqCgkgICAqIFJldHVybiB0aGUgYmFzZS01OCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcHVibGljIGtleQoJICAgKi8KCSAgdG9CYXNlNTgoKSB7CgkgICAgcmV0dXJuIGJzNTguZW5jb2RlKHRoaXMudG9CeXRlcygpKTsKCSAgfQoJICB0b0pTT04oKSB7CgkgICAgcmV0dXJuIHRoaXMudG9CYXNlNTgoKTsKCSAgfQoKCSAgLyoqCgkgICAqIFJldHVybiB0aGUgYnl0ZSBhcnJheSByZXByZXNlbnRhdGlvbiBvZiB0aGUgcHVibGljIGtleSBpbiBiaWcgZW5kaWFuCgkgICAqLwoJICB0b0J5dGVzKCkgewoJICAgIGNvbnN0IGJ1ZiA9IHRoaXMudG9CdWZmZXIoKTsKCSAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYnVmLmJ1ZmZlciwgYnVmLmJ5dGVPZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoKTsKCSAgfQoKCSAgLyoqCgkgICAqIFJldHVybiB0aGUgQnVmZmVyIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBwdWJsaWMga2V5IGluIGJpZyBlbmRpYW4KCSAgICovCgkgIHRvQnVmZmVyKCkgewoJICAgIGNvbnN0IGIgPSB0aGlzLl9ibi50b0FycmF5TGlrZShidWZmZXJFeHBvcnRzLkJ1ZmZlcik7CgkgICAgaWYgKGIubGVuZ3RoID09PSBQVUJMSUNfS0VZX0xFTkdUSCkgewoJICAgICAgcmV0dXJuIGI7CgkgICAgfQoJICAgIGNvbnN0IHplcm9QYWQgPSBidWZmZXJFeHBvcnRzLkJ1ZmZlci5hbGxvYygzMik7CgkgICAgYi5jb3B5KHplcm9QYWQsIDMyIC0gYi5sZW5ndGgpOwoJICAgIHJldHVybiB6ZXJvUGFkOwoJICB9CgkgIGdldCBbU3ltYm9sLnRvU3RyaW5nVGFnXSgpIHsKCSAgICByZXR1cm4gYFB1YmxpY0tleSgke3RoaXMudG9TdHJpbmcoKX0pYDsKCSAgfQoKCSAgLyoqCgkgICAqIFJldHVybiB0aGUgYmFzZS01OCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcHVibGljIGtleQoJICAgKi8KCSAgdG9TdHJpbmcoKSB7CgkgICAgcmV0dXJuIHRoaXMudG9CYXNlNTgoKTsKCSAgfQoKCSAgLyoqCgkgICAqIERlcml2ZSBhIHB1YmxpYyBrZXkgZnJvbSBhbm90aGVyIGtleSwgYSBzZWVkLCBhbmQgYSBwcm9ncmFtIElELgoJICAgKiBUaGUgcHJvZ3JhbSBJRCB3aWxsIGFsc28gc2VydmUgYXMgdGhlIG93bmVyIG9mIHRoZSBwdWJsaWMga2V5LCBnaXZpbmcKCSAgICogaXQgcGVybWlzc2lvbiB0byB3cml0ZSBkYXRhIHRvIHRoZSBhY2NvdW50LgoJICAgKi8KCSAgLyogZXNsaW50LWRpc2FibGUgcmVxdWlyZS1hd2FpdCAqLwoJICBzdGF0aWMgYXN5bmMgY3JlYXRlV2l0aFNlZWQoZnJvbVB1YmxpY0tleSwgc2VlZCwgcHJvZ3JhbUlkKSB7CgkgICAgY29uc3QgYnVmZmVyID0gYnVmZmVyRXhwb3J0cy5CdWZmZXIuY29uY2F0KFtmcm9tUHVibGljS2V5LnRvQnVmZmVyKCksIGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oc2VlZCksIHByb2dyYW1JZC50b0J1ZmZlcigpXSk7CgkgICAgY29uc3QgcHVibGljS2V5Qnl0ZXMgPSBzaGEyNTYkMShidWZmZXIpOwoJICAgIHJldHVybiBuZXcgUHVibGljS2V5KHB1YmxpY0tleUJ5dGVzKTsKCSAgfQoKCSAgLyoqCgkgICAqIERlcml2ZSBhIHByb2dyYW0gYWRkcmVzcyBmcm9tIHNlZWRzIGFuZCBhIHByb2dyYW0gSUQuCgkgICAqLwoJICAvKiBlc2xpbnQtZGlzYWJsZSByZXF1aXJlLWF3YWl0ICovCgkgIHN0YXRpYyBjcmVhdGVQcm9ncmFtQWRkcmVzc1N5bmMoc2VlZHMsIHByb2dyYW1JZCkgewoJICAgIGxldCBidWZmZXIgPSBidWZmZXJFeHBvcnRzLkJ1ZmZlci5hbGxvYygwKTsKCSAgICBzZWVkcy5mb3JFYWNoKGZ1bmN0aW9uIChzZWVkKSB7CgkgICAgICBpZiAoc2VlZC5sZW5ndGggPiBNQVhfU0VFRF9MRU5HVEgpIHsKCSAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgTWF4IHNlZWQgbGVuZ3RoIGV4Y2VlZGVkYCk7CgkgICAgICB9CgkgICAgICBidWZmZXIgPSBidWZmZXJFeHBvcnRzLkJ1ZmZlci5jb25jYXQoW2J1ZmZlciwgdG9CdWZmZXIoc2VlZCldKTsKCSAgICB9KTsKCSAgICBidWZmZXIgPSBidWZmZXJFeHBvcnRzLkJ1ZmZlci5jb25jYXQoW2J1ZmZlciwgcHJvZ3JhbUlkLnRvQnVmZmVyKCksIGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oJ1Byb2dyYW1EZXJpdmVkQWRkcmVzcycpXSk7CgkgICAgY29uc3QgcHVibGljS2V5Qnl0ZXMgPSBzaGEyNTYkMShidWZmZXIpOwoJICAgIGlmIChpc09uQ3VydmUocHVibGljS2V5Qnl0ZXMpKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc2VlZHMsIGFkZHJlc3MgbXVzdCBmYWxsIG9mZiB0aGUgY3VydmVgKTsKCSAgICB9CgkgICAgcmV0dXJuIG5ldyBQdWJsaWNLZXkocHVibGljS2V5Qnl0ZXMpOwoJICB9CgoJICAvKioKCSAgICogQXN5bmMgdmVyc2lvbiBvZiBjcmVhdGVQcm9ncmFtQWRkcmVzc1N5bmMKCSAgICogRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CgkgICAqCgkgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgY3JlYXRlUHJvZ3JhbUFkZHJlc3NTeW5jfSBpbnN0ZWFkCgkgICAqLwoJICAvKiBlc2xpbnQtZGlzYWJsZSByZXF1aXJlLWF3YWl0ICovCgkgIHN0YXRpYyBhc3luYyBjcmVhdGVQcm9ncmFtQWRkcmVzcyhzZWVkcywgcHJvZ3JhbUlkKSB7CgkgICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZ3JhbUFkZHJlc3NTeW5jKHNlZWRzLCBwcm9ncmFtSWQpOwoJICB9CgoJICAvKioKCSAgICogRmluZCBhIHZhbGlkIHByb2dyYW0gYWRkcmVzcwoJICAgKgoJICAgKiBWYWxpZCBwcm9ncmFtIGFkZHJlc3NlcyBtdXN0IGZhbGwgb2ZmIHRoZSBlZDI1NTE5IGN1cnZlLiAgVGhpcyBmdW5jdGlvbgoJICAgKiBpdGVyYXRlcyBhIG5vbmNlIHVudGlsIGl0IGZpbmRzIG9uZSB0aGF0IHdoZW4gY29tYmluZWQgd2l0aCB0aGUgc2VlZHMKCSAgICogcmVzdWx0cyBpbiBhIHZhbGlkIHByb2dyYW0gYWRkcmVzcy4KCSAgICovCgkgIHN0YXRpYyBmaW5kUHJvZ3JhbUFkZHJlc3NTeW5jKHNlZWRzLCBwcm9ncmFtSWQpIHsKCSAgICBsZXQgbm9uY2UgPSAyNTU7CgkgICAgbGV0IGFkZHJlc3M7CgkgICAgd2hpbGUgKG5vbmNlICE9IDApIHsKCSAgICAgIHRyeSB7CgkgICAgICAgIGNvbnN0IHNlZWRzV2l0aE5vbmNlID0gc2VlZHMuY29uY2F0KGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oW25vbmNlXSkpOwoJICAgICAgICBhZGRyZXNzID0gdGhpcy5jcmVhdGVQcm9ncmFtQWRkcmVzc1N5bmMoc2VlZHNXaXRoTm9uY2UsIHByb2dyYW1JZCk7CgkgICAgICB9IGNhdGNoIChlcnIpIHsKCSAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFR5cGVFcnJvcikgewoJICAgICAgICAgIHRocm93IGVycjsKCSAgICAgICAgfQoJICAgICAgICBub25jZS0tOwoJICAgICAgICBjb250aW51ZTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBbYWRkcmVzcywgbm9uY2VdOwoJICAgIH0KCSAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIGEgdmlhYmxlIHByb2dyYW0gYWRkcmVzcyBub25jZWApOwoJICB9CgoJICAvKioKCSAgICogQXN5bmMgdmVyc2lvbiBvZiBmaW5kUHJvZ3JhbUFkZHJlc3NTeW5jCgkgICAqIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQoJICAgKgoJICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGZpbmRQcm9ncmFtQWRkcmVzc1N5bmN9IGluc3RlYWQKCSAgICovCgkgIHN0YXRpYyBhc3luYyBmaW5kUHJvZ3JhbUFkZHJlc3Moc2VlZHMsIHByb2dyYW1JZCkgewoJICAgIHJldHVybiB0aGlzLmZpbmRQcm9ncmFtQWRkcmVzc1N5bmMoc2VlZHMsIHByb2dyYW1JZCk7CgkgIH0KCgkgIC8qKgoJICAgKiBDaGVjayB0aGF0IGEgcHVia2V5IGlzIG9uIHRoZSBlZDI1NTE5IGN1cnZlLgoJICAgKi8KCSAgc3RhdGljIGlzT25DdXJ2ZShwdWJrZXlEYXRhKSB7CgkgICAgY29uc3QgcHVia2V5ID0gbmV3IFB1YmxpY0tleShwdWJrZXlEYXRhKTsKCSAgICByZXR1cm4gaXNPbkN1cnZlKHB1YmtleS50b0J5dGVzKCkpOwoJICB9Cgl9CglfUHVibGljS2V5ID0gUHVibGljS2V5OwoJUHVibGljS2V5LmRlZmF1bHQgPSBuZXcgX1B1YmxpY0tleSgnMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEnKTsKCVNPTEFOQV9TQ0hFTUEuc2V0KFB1YmxpY0tleSwgewoJICBraW5kOiAnc3RydWN0JywKCSAgZmllbGRzOiBbWydfYm4nLCAndTI1NiddXQoJfSk7CgoJLyoqCgkgKiBBbiBhY2NvdW50IGtleSBwYWlyIChwdWJsaWMgYW5kIHNlY3JldCBrZXlzKS4KCSAqCgkgKiBAZGVwcmVjYXRlZCBzaW5jZSB2MS4xMC4wLCBwbGVhc2UgdXNlIHtAbGluayBLZXlwYWlyfSBpbnN0ZWFkLgoJICovCgljbGFzcyBBY2NvdW50IHsKCSAgLyoqCgkgICAqIENyZWF0ZSBhIG5ldyBBY2NvdW50IG9iamVjdAoJICAgKgoJICAgKiBJZiB0aGUgc2VjcmV0S2V5IHBhcmFtZXRlciBpcyBub3QgcHJvdmlkZWQgYSBuZXcga2V5IHBhaXIgaXMgcmFuZG9tbHkKCSAgICogY3JlYXRlZCBmb3IgdGhlIGFjY291bnQKCSAgICoKCSAgICogQHBhcmFtIHNlY3JldEtleSBTZWNyZXQga2V5IGZvciB0aGUgYWNjb3VudAoJICAgKi8KCSAgY29uc3RydWN0b3Ioc2VjcmV0S2V5KSB7CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX3B1YmxpY0tleSA9IHZvaWQgMDsKCSAgICAvKiogQGludGVybmFsICovCgkgICAgdGhpcy5fc2VjcmV0S2V5ID0gdm9pZCAwOwoJICAgIGlmIChzZWNyZXRLZXkpIHsKCSAgICAgIGNvbnN0IHNlY3JldEtleUJ1ZmZlciA9IHRvQnVmZmVyKHNlY3JldEtleSk7CgkgICAgICBpZiAoc2VjcmV0S2V5Lmxlbmd0aCAhPT0gNjQpIHsKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdiYWQgc2VjcmV0IGtleSBzaXplJyk7CgkgICAgICB9CgkgICAgICB0aGlzLl9wdWJsaWNLZXkgPSBzZWNyZXRLZXlCdWZmZXIuc2xpY2UoMzIsIDY0KTsKCSAgICAgIHRoaXMuX3NlY3JldEtleSA9IHNlY3JldEtleUJ1ZmZlci5zbGljZSgwLCAzMik7CgkgICAgfSBlbHNlIHsKCSAgICAgIHRoaXMuX3NlY3JldEtleSA9IHRvQnVmZmVyKGdlbmVyYXRlUHJpdmF0ZUtleSgpKTsKCSAgICAgIHRoaXMuX3B1YmxpY0tleSA9IHRvQnVmZmVyKGdldFB1YmxpY0tleSh0aGlzLl9zZWNyZXRLZXkpKTsKCSAgICB9CgkgIH0KCgkgIC8qKgoJICAgKiBUaGUgcHVibGljIGtleSBmb3IgdGhpcyBhY2NvdW50CgkgICAqLwoJICBnZXQgcHVibGljS2V5KCkgewoJICAgIHJldHVybiBuZXcgUHVibGljS2V5KHRoaXMuX3B1YmxpY0tleSk7CgkgIH0KCgkgIC8qKgoJICAgKiBUaGUgKip1bmVuY3J5cHRlZCoqIHNlY3JldCBrZXkgZm9yIHRoaXMgYWNjb3VudC4gVGhlIGZpcnN0IDMyIGJ5dGVzCgkgICAqIGlzIHRoZSBwcml2YXRlIHNjYWxhciBhbmQgdGhlIGxhc3QgMzIgYnl0ZXMgaXMgdGhlIHB1YmxpYyBrZXkuCgkgICAqIFJlYWQgbW9yZTogaHR0cHM6Ly9ibG9nLm1vemlsbGEub3JnL3dhcm5lci8yMDExLzExLzI5L2VkMjU1MTkta2V5cy8KCSAgICovCgkgIGdldCBzZWNyZXRLZXkoKSB7CgkgICAgcmV0dXJuIGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmNvbmNhdChbdGhpcy5fc2VjcmV0S2V5LCB0aGlzLl9wdWJsaWNLZXldLCA2NCk7CgkgIH0KCX0KCgljb25zdCBCUEZfTE9BREVSX0RFUFJFQ0FURURfUFJPR1JBTV9JRCA9IG5ldyBQdWJsaWNLZXkoJ0JQRkxvYWRlcjExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEnKTsKCgl2YXIgTGF5b3V0ID0ge307CgoJLyogVGhlIE1JVCBMaWNlbnNlIChNSVQpCgkgKgoJICogQ29weXJpZ2h0IDIwMTUtMjAxOCBQZXRlciBBLiBCaWdvdAoJICoKCSAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKCSAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCgkgKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCgkgKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCgkgKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKCSAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgkgKgoJICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KCSAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoJICoKCSAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCgkgKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKCSAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQoJICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgoJICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKCSAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KCSAqIFRIRSBTT0ZUV0FSRS4KCSAqLwoKCXZhciBoYXNSZXF1aXJlZExheW91dDsKCglmdW5jdGlvbiByZXF1aXJlTGF5b3V0ICgpIHsKCQlpZiAoaGFzUmVxdWlyZWRMYXlvdXQpIHJldHVybiBMYXlvdXQ7CgkJaGFzUmVxdWlyZWRMYXlvdXQgPSAxOwoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShMYXlvdXQsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKCQlMYXlvdXQuczE2ID0gTGF5b3V0LnM4ID0gTGF5b3V0Lm51NjRiZSA9IExheW91dC51NDhiZSA9IExheW91dC51NDBiZSA9IExheW91dC51MzJiZSA9IExheW91dC51MjRiZSA9IExheW91dC51MTZiZSA9IExheW91dC5udTY0ID0gTGF5b3V0LnU0OCA9IExheW91dC51NDAgPSBMYXlvdXQudTMyID0gTGF5b3V0LnUyNCA9IExheW91dC51MTYgPSBMYXlvdXQudTggPSBMYXlvdXQub2Zmc2V0ID0gTGF5b3V0LmdyZWVkeSA9IExheW91dC5Db25zdGFudCA9IExheW91dC5VVEY4ID0gTGF5b3V0LkNTdHJpbmcgPSBMYXlvdXQuQmxvYiA9IExheW91dC5Cb29sZWFuID0gTGF5b3V0LkJpdEZpZWxkID0gTGF5b3V0LkJpdFN0cnVjdHVyZSA9IExheW91dC5WYXJpYW50TGF5b3V0ID0gTGF5b3V0LlVuaW9uID0gTGF5b3V0LlVuaW9uTGF5b3V0RGlzY3JpbWluYXRvciA9IExheW91dC5VbmlvbkRpc2NyaW1pbmF0b3IgPSBMYXlvdXQuU3RydWN0dXJlID0gTGF5b3V0LlNlcXVlbmNlID0gTGF5b3V0LkRvdWJsZUJFID0gTGF5b3V0LkRvdWJsZSA9IExheW91dC5GbG9hdEJFID0gTGF5b3V0LkZsb2F0ID0gTGF5b3V0Lk5lYXJJbnQ2NEJFID0gTGF5b3V0Lk5lYXJJbnQ2NCA9IExheW91dC5OZWFyVUludDY0QkUgPSBMYXlvdXQuTmVhclVJbnQ2NCA9IExheW91dC5JbnRCRSA9IExheW91dC5JbnQgPSBMYXlvdXQuVUludEJFID0gTGF5b3V0LlVJbnQgPSBMYXlvdXQuT2Zmc2V0TGF5b3V0ID0gTGF5b3V0LkdyZWVkeUNvdW50ID0gTGF5b3V0LkV4dGVybmFsTGF5b3V0ID0gTGF5b3V0LmJpbmRDb25zdHJ1Y3RvckxheW91dCA9IExheW91dC5uYW1lV2l0aFByb3BlcnR5ID0gTGF5b3V0LkxheW91dCA9IExheW91dC51aW50OEFycmF5VG9CdWZmZXIgPSBMYXlvdXQuY2hlY2tVaW50OEFycmF5ID0gdm9pZCAwOwoJCUxheW91dC5jb25zdGFudCA9IExheW91dC51dGY4ID0gTGF5b3V0LmNzdHIgPSBMYXlvdXQuYmxvYiA9IExheW91dC51bmlvbkxheW91dERpc2NyaW1pbmF0b3IgPSBMYXlvdXQudW5pb24gPSBMYXlvdXQuc2VxID0gTGF5b3V0LmJpdHMgPSBMYXlvdXQuc3RydWN0ID0gTGF5b3V0LmY2NGJlID0gTGF5b3V0LmY2NCA9IExheW91dC5mMzJiZSA9IExheW91dC5mMzIgPSBMYXlvdXQubnM2NGJlID0gTGF5b3V0LnM0OGJlID0gTGF5b3V0LnM0MGJlID0gTGF5b3V0LnMzMmJlID0gTGF5b3V0LnMyNGJlID0gTGF5b3V0LnMxNmJlID0gTGF5b3V0Lm5zNjQgPSBMYXlvdXQuczQ4ID0gTGF5b3V0LnM0MCA9IExheW91dC5zMzIgPSBMYXlvdXQuczI0ID0gdm9pZCAwOwoJCWNvbnN0IGJ1ZmZlcl8xID0gLypAX19QVVJFX18qLyByZXF1aXJlQnVmZmVyKCk7CgkJLyogQ2hlY2sgaWYgYSB2YWx1ZSBpcyBhIFVpbnQ4QXJyYXkuCgkJICoKCQkgKiBAaWdub3JlICovCgkJZnVuY3Rpb24gY2hlY2tVaW50OEFycmF5KGIpIHsKCQkgICAgaWYgKCEoYiBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpKSB7CgkJICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdiIG11c3QgYmUgYSBVaW50OEFycmF5Jyk7CgkJICAgIH0KCQl9CgkJTGF5b3V0LmNoZWNrVWludDhBcnJheSA9IGNoZWNrVWludDhBcnJheTsKCQkvKiBDcmVhdGUgYSBCdWZmZXIgaW5zdGFuY2UgZnJvbSBhIFVpbnQ4QXJyYXkuCgkJICoKCQkgKiBAaWdub3JlICovCgkJZnVuY3Rpb24gdWludDhBcnJheVRvQnVmZmVyKGIpIHsKCQkgICAgY2hlY2tVaW50OEFycmF5KGIpOwoJCSAgICByZXR1cm4gYnVmZmVyXzEuQnVmZmVyLmZyb20oYi5idWZmZXIsIGIuYnl0ZU9mZnNldCwgYi5sZW5ndGgpOwoJCX0KCQlMYXlvdXQudWludDhBcnJheVRvQnVmZmVyID0gdWludDhBcnJheVRvQnVmZmVyOwoJCS8qKgoJCSAqIEJhc2UgY2xhc3MgZm9yIGxheW91dCBvYmplY3RzLgoJCSAqCgkJICogKipOT1RFKiogVGhpcyBpcyBhbiBhYnN0cmFjdCBiYXNlIGNsYXNzOyB5b3UgY2FuIGNyZWF0ZSBpbnN0YW5jZXMKCQkgKiBpZiBpdCBhbXVzZXMgeW91LCBidXQgdGhleSB3b24ndCBzdXBwb3J0IHRoZSB7QGxpbmsKCQkgKiBMYXlvdXQjZW5jb2RlfGVuY29kZX0gb3Ige0BsaW5rIExheW91dCNkZWNvZGV8ZGVjb2RlfSBmdW5jdGlvbnMuCgkJICoKCQkgKiBAcGFyYW0ge051bWJlcn0gc3BhbiAtIEluaXRpYWxpemVyIGZvciB7QGxpbmsgTGF5b3V0I3NwYW58c3Bhbn0uICBUaGUKCQkgKiBwYXJhbWV0ZXIgbXVzdCBiZSBhbiBpbnRlZ2VyOyBhIG5lZ2F0aXZlIHZhbHVlIHNpZ25pZmllcyB0aGF0IHRoZQoJCSAqIHNwYW4gaXMge0BsaW5rIExheW91dCNnZXRTcGFufHZhbHVlLXNwZWNpZmljfS4KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gSW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICoKCQkgKiBAYWJzdHJhY3QKCQkgKi8KCQlsZXQgTGF5b3V0JDEgPSBjbGFzcyBMYXlvdXQgewoJCSAgICBjb25zdHJ1Y3RvcihzcGFuLCBwcm9wZXJ0eSkgewoJCSAgICAgICAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKHNwYW4pKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignc3BhbiBtdXN0IGJlIGFuIGludGVnZXInKTsKCQkgICAgICAgIH0KCQkgICAgICAgIC8qKiBUaGUgc3BhbiBvZiB0aGUgbGF5b3V0IGluIGJ5dGVzLgoJCSAgICAgICAgICoKCQkgICAgICAgICAqIFBvc2l0aXZlIHZhbHVlcyBhcmUgZ2VuZXJhbGx5IGV4cGVjdGVkLgoJCSAgICAgICAgICoKCQkgICAgICAgICAqIFplcm8gd2lsbCBvbmx5IGFwcGVhciBpbiB7QGxpbmsgQ29uc3RhbnR9cyBhbmQgaW4ge0BsaW5rCgkJICAgICAgICAgKiBTZXF1ZW5jZX1zIHdoZXJlIHRoZSB7QGxpbmsgU2VxdWVuY2UjY291bnR8Y291bnR9IGlzIHplcm8uCgkJICAgICAgICAgKgoJCSAgICAgICAgICogQSBuZWdhdGl2ZSB2YWx1ZSBpbmRpY2F0ZXMgdGhhdCB0aGUgc3BhbiBpcyB2YWx1ZS1zcGVjaWZpYywgYW5kCgkJICAgICAgICAgKiBtdXN0IGJlIG9idGFpbmVkIHVzaW5nIHtAbGluayBMYXlvdXQjZ2V0U3BhbnxnZXRTcGFufS4gKi8KCQkgICAgICAgIHRoaXMuc3BhbiA9IHNwYW47CgkJICAgICAgICAvKiogVGhlIHByb3BlcnR5IG5hbWUgdXNlZCB3aGVuIHRoaXMgbGF5b3V0IGlzIHJlcHJlc2VudGVkIGluIGFuCgkJICAgICAgICAgKiBPYmplY3QuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogVXNlZCBvbmx5IGZvciBsYXlvdXRzIHRoYXQge0BsaW5rIExheW91dCNkZWNvZGV8ZGVjb2RlfSB0byBPYmplY3QKCQkgICAgICAgICAqIGluc3RhbmNlcy4gIElmIGxlZnQgdW5kZWZpbmVkIHRoZSBzcGFuIG9mIHRoZSB1bm5hbWVkIGxheW91dCB3aWxsCgkJICAgICAgICAgKiBiZSB0cmVhdGVkIGFzIHBhZGRpbmc6IGl0IHdpbGwgbm90IGJlIG11dGF0ZWQgYnkge0BsaW5rCgkJICAgICAgICAgKiBMYXlvdXQjZW5jb2RlfGVuY29kZX0gbm9yIHJlcHJlc2VudGVkIGFzIGEgcHJvcGVydHkgaW4gdGhlCgkJICAgICAgICAgKiBkZWNvZGVkIE9iamVjdC4gKi8KCQkgICAgICAgIHRoaXMucHJvcGVydHkgPSBwcm9wZXJ0eTsKCQkgICAgfQoJCSAgICAvKiogRnVuY3Rpb24gdG8gY3JlYXRlIGFuIE9iamVjdCBpbnRvIHdoaWNoIGRlY29kZWQgcHJvcGVydGllcyB3aWxsCgkJICAgICAqIGJlIHdyaXR0ZW4uCgkJICAgICAqCgkJICAgICAqIFVzZWQgb25seSBmb3IgbGF5b3V0cyB0aGF0IHtAbGluayBMYXlvdXQjZGVjb2RlfGRlY29kZX0gdG8gT2JqZWN0CgkJICAgICAqIGluc3RhbmNlcywgd2hpY2ggbWVhbnM6CgkJICAgICAqICoge0BsaW5rIFN0cnVjdHVyZX0KCQkgICAgICogKiB7QGxpbmsgVW5pb259CgkJICAgICAqICoge0BsaW5rIFZhcmlhbnRMYXlvdXR9CgkJICAgICAqICoge0BsaW5rIEJpdFN0cnVjdHVyZX0KCQkgICAgICoKCQkgICAgICogSWYgbGVmdCB1bmRlZmluZWQgdGhlIEphdmFTY3JpcHQgcmVwcmVzZW50YXRpb24gb2YgdGhlc2UgbGF5b3V0cwoJCSAgICAgKiB3aWxsIGJlIE9iamVjdCBpbnN0YW5jZXMuCgkJICAgICAqCgkJICAgICAqIFNlZSB7QGxpbmsgYmluZENvbnN0cnVjdG9yTGF5b3V0fS4KCQkgICAgICovCgkJICAgIG1ha2VEZXN0aW5hdGlvbk9iamVjdCgpIHsKCQkgICAgICAgIHJldHVybiB7fTsKCQkgICAgfQoJCSAgICAvKioKCQkgICAgICogQ2FsY3VsYXRlIHRoZSBzcGFuIG9mIGEgc3BlY2lmaWMgaW5zdGFuY2Ugb2YgYSBsYXlvdXQuCgkJICAgICAqCgkJICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gYiAtIHRoZSBidWZmZXIgdGhhdCBjb250YWlucyBhbiBlbmNvZGVkIGluc3RhbmNlLgoJCSAgICAgKgoJCSAgICAgKiBAcGFyYW0ge051bWJlcn0gW29mZnNldF0gLSB0aGUgb2Zmc2V0IGF0IHdoaWNoIHRoZSBlbmNvZGVkIGluc3RhbmNlCgkJICAgICAqIHN0YXJ0cy4gIElmIGFic2VudCBhIHplcm8gb2Zmc2V0IGlzIGluZmVycmVkLgoJCSAgICAgKgoJCSAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9IC0gdGhlIG51bWJlciBvZiBieXRlcyBjb3ZlcmVkIGJ5IHRoZSBsYXlvdXQKCQkgICAgICogaW5zdGFuY2UuICBJZiB0aGlzIG1ldGhvZCBpcyBub3Qgb3ZlcnJpZGRlbiBpbiBhIHN1YmNsYXNzIHRoZQoJCSAgICAgKiBkZWZpbml0aW9uLXRpbWUgY29uc3RhbnQge0BsaW5rIExheW91dCNzcGFufHNwYW59IHdpbGwgYmUKCQkgICAgICogcmV0dXJuZWQuCgkJICAgICAqCgkJICAgICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IC0gaWYgdGhlIGxlbmd0aCBvZiB0aGUgdmFsdWUgY2Fubm90IGJlCgkJICAgICAqIGRldGVybWluZWQuCgkJICAgICAqLwoJCSAgICBnZXRTcGFuKGIsIG9mZnNldCkgewoJCSAgICAgICAgaWYgKDAgPiB0aGlzLnNwYW4pIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignaW5kZXRlcm1pbmF0ZSBzcGFuJyk7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gdGhpcy5zcGFuOwoJCSAgICB9CgkJICAgIC8qKgoJCSAgICAgKiBSZXBsaWNhdGUgdGhlIGxheW91dCB1c2luZyBhIG5ldyBwcm9wZXJ0eS4KCQkgICAgICoKCQkgICAgICogVGhpcyBmdW5jdGlvbiBtdXN0IGJlIHVzZWQgdG8gZ2V0IGEgc3RydWN0dXJhbGx5LWVxdWl2YWxlbnQgbGF5b3V0CgkJICAgICAqIHdpdGggYSBkaWZmZXJlbnQgbmFtZSBzaW5jZSBhbGwge0BsaW5rIExheW91dH0gaW5zdGFuY2VzIGFyZQoJCSAgICAgKiBpbW11dGFibGUuCgkJICAgICAqCgkJICAgICAqICoqTk9URSoqIFRoaXMgaXMgYSBzaGFsbG93IGNvcHkuICBBbGwgZmllbGRzIGV4Y2VwdCB7QGxpbmsKCQkgICAgICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fSBhcmUgc3RyaWN0bHkgZXF1YWwgdG8gdGhlIG9yaWdpbiBsYXlvdXQuCgkJICAgICAqCgkJICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSAtIHRoZSB2YWx1ZSBmb3Ige0BsaW5rCgkJICAgICAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0gaW4gdGhlIHJlcGxpY2EuCgkJICAgICAqCgkJICAgICAqIEByZXR1cm5zIHtMYXlvdXR9IC0gdGhlIGNvcHkgd2l0aCB7QGxpbmsgTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fQoJCSAgICAgKiBzZXQgdG8gYHByb3BlcnR5YC4KCQkgICAgICovCgkJICAgIHJlcGxpY2F0ZShwcm9wZXJ0eSkgewoJCSAgICAgICAgY29uc3QgcnYgPSBPYmplY3QuY3JlYXRlKHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlKTsKCQkgICAgICAgIE9iamVjdC5hc3NpZ24ocnYsIHRoaXMpOwoJCSAgICAgICAgcnYucHJvcGVydHkgPSBwcm9wZXJ0eTsKCQkgICAgICAgIHJldHVybiBydjsKCQkgICAgfQoJCSAgICAvKioKCQkgICAgICogQ3JlYXRlIGFuIG9iamVjdCBmcm9tIGxheW91dCBwcm9wZXJ0aWVzIGFuZCBhbiBhcnJheSBvZiB2YWx1ZXMuCgkJICAgICAqCgkJICAgICAqICoqTk9URSoqIFRoaXMgZnVuY3Rpb24gcmV0dXJucyBgdW5kZWZpbmVkYCBpZiBpbnZva2VkIG9uIGEgbGF5b3V0CgkJICAgICAqIHRoYXQgZG9lcyBub3QgcmV0dXJuIGl0cyB2YWx1ZSBhcyBhbiBPYmplY3QuICBPYmplY3RzIGFyZQoJCSAgICAgKiByZXR1cm5lZCBmb3IgdGhpbmdzIHRoYXQgYXJlIGEge0BsaW5rIFN0cnVjdHVyZX0sIHdoaWNoIGluY2x1ZGVzCgkJICAgICAqIHtAbGluayBWYXJpYW50TGF5b3V0fHZhcmlhbnQgbGF5b3V0c30gaWYgdGhleSBhcmUgc3RydWN0dXJlcywgYW5kCgkJICAgICAqIGV4Y2x1ZGVzIHtAbGluayBVbmlvbn1zLiAgSWYgeW91IHdhbnQgdGhpcyBmZWF0dXJlIGZvciBhIHVuaW9uCgkJICAgICAqIHlvdSBtdXN0IHVzZSB7QGxpbmsgVW5pb24uZ2V0VmFyaWFudHxnZXRWYXJpYW50fSB0byBzZWxlY3QgdGhlCgkJICAgICAqIGRlc2lyZWQgbGF5b3V0LgoJCSAgICAgKgoJCSAgICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZXMgLSBhbiBhcnJheSBvZiB2YWx1ZXMgdGhhdCBjb3JyZXNwb25kIHRvIHRoZQoJCSAgICAgKiBkZWZhdWx0IG9yZGVyIGZvciBwcm9wZXJ0aWVzLiAgQXMgd2l0aCB7QGxpbmsgTGF5b3V0I2RlY29kZXxkZWNvZGV9CgkJICAgICAqIGxheW91dCBlbGVtZW50cyB0aGF0IGhhdmUgbm8gcHJvcGVydHkgbmFtZSBhcmUgc2tpcHBlZCB3aGVuCgkJICAgICAqIGl0ZXJhdGluZyBvdmVyIHRoZSBhcnJheSB2YWx1ZXMuICBPbmx5IHRoZSB0b3AtbGV2ZWwgcHJvcGVydGllcyBhcmUKCQkgICAgICogYXNzaWduZWQ7IGFyZ3VtZW50cyBhcmUgbm90IGFzc2lnbmVkIHRvIHByb3BlcnRpZXMgb2YgY29udGFpbmVkCgkJICAgICAqIGxheW91dHMuICBBbnkgdW51c2VkIHZhbHVlcyBhcmUgaWdub3JlZC4KCQkgICAgICoKCQkgICAgICogQHJldHVybiB7KE9iamVjdHx1bmRlZmluZWQpfQoJCSAgICAgKi8KCQkgICAgZnJvbUFycmF5KHZhbHVlcykgewoJCSAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCQkgICAgfQoJCX07CgkJTGF5b3V0LkxheW91dCA9IExheW91dCQxOwoJCS8qIFByb3ZpZGUgdGV4dCB0aGF0IGNhcnJpZXMgYSBuYW1lIChzdWNoIGFzIGZvciBhIGZ1bmN0aW9uIHRoYXQgd2lsbAoJCSAqIGJlIHRocm93aW5nIGFuIGVycm9yKSBhbm5vdGF0ZWQgd2l0aCB0aGUgcHJvcGVydHkgb2YgYSBnaXZlbiBsYXlvdXQKCQkgKiAoc3VjaCBhcyBvbmUgZm9yIHdoaWNoIHRoZSB2YWx1ZSB3YXMgdW5hY2NlcHRhYmxlKS4KCQkgKgoJCSAqIEBpZ25vcmUgKi8KCQlmdW5jdGlvbiBuYW1lV2l0aFByb3BlcnR5KG5hbWUsIGxvKSB7CgkJICAgIGlmIChsby5wcm9wZXJ0eSkgewoJCSAgICAgICAgcmV0dXJuIG5hbWUgKyAnWycgKyBsby5wcm9wZXJ0eSArICddJzsKCQkgICAgfQoJCSAgICByZXR1cm4gbmFtZTsKCQl9CgkJTGF5b3V0Lm5hbWVXaXRoUHJvcGVydHkgPSBuYW1lV2l0aFByb3BlcnR5OwoJCS8qKgoJCSAqIEF1Z21lbnQgYSBjbGFzcyBzbyB0aGF0IGluc3RhbmNlcyBjYW4gYmUgZW5jb2RlZC9kZWNvZGVkIHVzaW5nIGEKCQkgKiBnaXZlbiBsYXlvdXQuCgkJICoKCQkgKiBDYWxsaW5nIHRoaXMgZnVuY3Rpb24gY291cGxlcyBgQ2xhc3NgIHdpdGggYGxheW91dGAgaW4gc2V2ZXJhbCB3YXlzOgoJCSAqCgkJICogKiBgQ2xhc3MubGF5b3V0X2AgYmVjb21lcyBhIHN0YXRpYyBtZW1iZXIgcHJvcGVydHkgZXF1YWwgdG8gYGxheW91dGA7CgkJICogKiBgbGF5b3V0LmJvdW5kQ29uc3RydWN0b3JfYCBiZWNvbWVzIGEgc3RhdGljIG1lbWJlciBwcm9wZXJ0eSBlcXVhbAoJCSAqICAgIHRvIGBDbGFzc2A7CgkJICogKiBUaGUge0BsaW5rIExheW91dCNtYWtlRGVzdGluYXRpb25PYmplY3R8bWFrZURlc3RpbmF0aW9uT2JqZWN0KCl9CgkJICogICBwcm9wZXJ0eSBvZiBgbGF5b3V0YCBpcyBzZXQgdG8gYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSBgbmV3CgkJICogICBDbGFzcygpYDsKCQkgKiAqIGBDbGFzcy5kZWNvZGUoYiwgb2Zmc2V0KWAgYmVjb21lcyBhIHN0YXRpYyBtZW1iZXIgZnVuY3Rpb24gdGhhdAoJCSAqICAgZGVsZWdhdGVzIHRvIHtAbGluayBMYXlvdXQjZGVjb2RlfGxheW91dC5kZWNvZGV9LiAgVGhlCgkJICogICBzeW50aGVzaXplZCBmdW5jdGlvbiBtYXkgYmUgY2FwdHVyZWQgYW5kIGV4dGVuZGVkLgoJCSAqICogYENsYXNzLnByb3RvdHlwZS5lbmNvZGUoYiwgb2Zmc2V0KWAgcHJvdmlkZXMgYW4gaW5zdGFuY2UgbWVtYmVyCgkJICogICBmdW5jdGlvbiB0aGF0IGRlbGVnYXRlcyB0byB7QGxpbmsgTGF5b3V0I2VuY29kZXxsYXlvdXQuZW5jb2RlfQoJCSAqICAgd2l0aCBgc3JjYCBzZXQgdG8gYHRoaXNgLiAgVGhlIHN5bnRoZXNpemVkIGZ1bmN0aW9uIG1heSBiZQoJCSAqICAgY2FwdHVyZWQgYW5kIGV4dGVuZGVkLCBidXQgd2hlbiB0aGUgZXh0ZW5zaW9uIGlzIGludm9rZWQgYHRoaXNgCgkJICogICBtdXN0IGJlIGV4cGxpY2l0bHkgYm91bmQgdG8gdGhlIGluc3RhbmNlLgoJCSAqCgkJICogQHBhcmFtIHtjbGFzc30gQ2xhc3MgLSBhIEphdmFTY3JpcHQgY2xhc3Mgd2l0aCBhIG51bGxhcnkKCQkgKiBjb25zdHJ1Y3Rvci4KCQkgKgoJCSAqIEBwYXJhbSB7TGF5b3V0fSBsYXlvdXQgLSB0aGUge0BsaW5rIExheW91dH0gaW5zdGFuY2UgdXNlZCB0byBlbmNvZGUKCQkgKiBpbnN0YW5jZXMgb2YgYENsYXNzYC4KCQkgKi8KCQkvLyBgQ2xhc3NgIG11c3QgYmUgYSBjb25zdHJ1Y3RvciBGdW5jdGlvbiwgYnV0IHRoZSBhc3NpZ25tZW50IG9mIGEgYGxheW91dF9gIHByb3BlcnR5IHRvIGl0IG1ha2VzIGl0IGRpZmZpY3VsdCB0byB0eXBlCgkJLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9leHBsaWNpdC1tb2R1bGUtYm91bmRhcnktdHlwZXMKCQlmdW5jdGlvbiBiaW5kQ29uc3RydWN0b3JMYXlvdXQoQ2xhc3MsIGxheW91dCkgewoJCSAgICBpZiAoJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIENsYXNzKSB7CgkJICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdDbGFzcyBtdXN0IGJlIGNvbnN0cnVjdG9yJyk7CgkJICAgIH0KCQkgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChDbGFzcywgJ2xheW91dF8nKSkgewoJCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDbGFzcyBpcyBhbHJlYWR5IGJvdW5kIHRvIGEgbGF5b3V0Jyk7CgkJICAgIH0KCQkgICAgaWYgKCEobGF5b3V0ICYmIChsYXlvdXQgaW5zdGFuY2VvZiBMYXlvdXQkMSkpKSB7CgkJICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdsYXlvdXQgbXVzdCBiZSBhIExheW91dCcpOwoJCSAgICB9CgkJICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobGF5b3V0LCAnYm91bmRDb25zdHJ1Y3Rvcl8nKSkgewoJCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdsYXlvdXQgaXMgYWxyZWFkeSBib3VuZCB0byBhIGNvbnN0cnVjdG9yJyk7CgkJICAgIH0KCQkgICAgQ2xhc3MubGF5b3V0XyA9IGxheW91dDsKCQkgICAgbGF5b3V0LmJvdW5kQ29uc3RydWN0b3JfID0gQ2xhc3M7CgkJICAgIGxheW91dC5tYWtlRGVzdGluYXRpb25PYmplY3QgPSAoKCkgPT4gbmV3IENsYXNzKCkpOwoJCSAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ2xhc3MucHJvdG90eXBlLCAnZW5jb2RlJywgewoJCSAgICAgICAgdmFsdWUoYiwgb2Zmc2V0KSB7CgkJICAgICAgICAgICAgcmV0dXJuIGxheW91dC5lbmNvZGUodGhpcywgYiwgb2Zmc2V0KTsKCQkgICAgICAgIH0sCgkJICAgICAgICB3cml0YWJsZTogdHJ1ZSwKCQkgICAgfSk7CgkJICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDbGFzcywgJ2RlY29kZScsIHsKCQkgICAgICAgIHZhbHVlKGIsIG9mZnNldCkgewoJCSAgICAgICAgICAgIHJldHVybiBsYXlvdXQuZGVjb2RlKGIsIG9mZnNldCk7CgkJICAgICAgICB9LAoJCSAgICAgICAgd3JpdGFibGU6IHRydWUsCgkJICAgIH0pOwoJCX0KCQlMYXlvdXQuYmluZENvbnN0cnVjdG9yTGF5b3V0ID0gYmluZENvbnN0cnVjdG9yTGF5b3V0OwoJCS8qKgoJCSAqIEFuIG9iamVjdCB0aGF0IGJlaGF2ZXMgbGlrZSBhIGxheW91dCBidXQgZG9lcyBub3QgY29uc3VtZSBzcGFjZQoJCSAqIHdpdGhpbiBpdHMgY29udGFpbmluZyBsYXlvdXQuCgkJICoKCQkgKiBUaGlzIGlzIHByaW1hcmlseSB1c2VkIHRvIG9idGFpbiBtZXRhZGF0YSBhYm91dCBhIG1lbWJlciwgc3VjaCBhcyBhCgkJICoge0BsaW5rIE9mZnNldExheW91dH0gdGhhdCBjYW4gcHJvdmlkZSBkYXRhIGFib3V0IGEge0BsaW5rCgkJICogTGF5b3V0I2dldFNwYW58dmFsdWUtc3BlY2lmaWMgc3Bhbn0uCgkJICoKCQkgKiAqKk5PVEUqKiBUaGlzIGlzIGFuIGFic3RyYWN0IGJhc2UgY2xhc3M7IHlvdSBjYW4gY3JlYXRlIGluc3RhbmNlcwoJCSAqIGlmIGl0IGFtdXNlcyB5b3UsIGJ1dCB0aGV5IHdvbid0IHN1cHBvcnQge0BsaW5rCgkJICogRXh0ZXJuYWxMYXlvdXQjaXNDb3VudHxpc0NvdW50fSBvciBvdGhlciB7QGxpbmsgTGF5b3V0fSBmdW5jdGlvbnMuCgkJICoKCQkgKiBAcGFyYW0ge051bWJlcn0gc3BhbiAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsgTGF5b3V0I3NwYW58c3Bhbn0uCgkJICogVGhlIHBhcmFtZXRlciBjYW4gcmFuZ2UgZnJvbSAxIHRocm91Z2ggNi4KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICoKCQkgKiBAYWJzdHJhY3QKCQkgKiBAYXVnbWVudHMge0xheW91dH0KCQkgKi8KCQljbGFzcyBFeHRlcm5hbExheW91dCBleHRlbmRzIExheW91dCQxIHsKCQkgICAgLyoqCgkJICAgICAqIFJldHVybiBgdHJ1ZWAgaWZmIHRoZSBleHRlcm5hbCBsYXlvdXQgZGVjb2RlcyB0byBhbiB1bnNpZ25lZAoJCSAgICAgKiBpbnRlZ2VyIGxheW91dC4KCQkgICAgICoKCQkgICAgICogSW4gdGhhdCBjYXNlIGl0IGNhbiBiZSB1c2VkIGFzIHRoZSBzb3VyY2Ugb2Yge0BsaW5rCgkJICAgICAqIFNlcXVlbmNlI2NvdW50fFNlcXVlbmNlIGNvdW50c30sIHtAbGluayBCbG9iI2xlbmd0aHxCbG9iIGxlbmd0aHN9LAoJCSAgICAgKiBvciBhcyB7QGxpbmsgVW5pb25MYXlvdXREaXNjcmltaW5hdG9yI2xheW91dHxleHRlcm5hbCB1bmlvbgoJCSAgICAgKiBkaXNjcmltaW5hdG9yc30uCgkJICAgICAqCgkJICAgICAqIEBhYnN0cmFjdAoJCSAgICAgKi8KCQkgICAgaXNDb3VudCgpIHsKCQkgICAgICAgIHRocm93IG5ldyBFcnJvcignRXh0ZXJuYWxMYXlvdXQgaXMgYWJzdHJhY3QnKTsKCQkgICAgfQoJCX0KCQlMYXlvdXQuRXh0ZXJuYWxMYXlvdXQgPSBFeHRlcm5hbExheW91dDsKCQkvKioKCQkgKiBBbiB7QGxpbmsgRXh0ZXJuYWxMYXlvdXR9IHRoYXQgZGV0ZXJtaW5lcyBpdHMge0BsaW5rCgkJICogTGF5b3V0I2RlY29kZXx2YWx1ZX0gYmFzZWQgb24gb2Zmc2V0IGludG8gYW5kIGxlbmd0aCBvZiB0aGUgYnVmZmVyCgkJICogb24gd2hpY2ggaXQgaXMgaW52b2tlZC4KCQkgKgoJCSAqICpGYWN0b3J5Kjoge0BsaW5rIG1vZHVsZTpMYXlvdXQuZ3JlZWR5fGdyZWVkeX0KCQkgKgoJCSAqIEBwYXJhbSB7TnVtYmVyfSBbZWxlbWVudFNwYW5dIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIEdyZWVkeUNvdW50I2VsZW1lbnRTcGFufGVsZW1lbnRTcGFufS4KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICoKCQkgKiBAYXVnbWVudHMge0V4dGVybmFsTGF5b3V0fQoJCSAqLwoJCWNsYXNzIEdyZWVkeUNvdW50IGV4dGVuZHMgRXh0ZXJuYWxMYXlvdXQgewoJCSAgICBjb25zdHJ1Y3RvcihlbGVtZW50U3BhbiA9IDEsIHByb3BlcnR5KSB7CgkJICAgICAgICBpZiAoKCFOdW1iZXIuaXNJbnRlZ2VyKGVsZW1lbnRTcGFuKSkgfHwgKDAgPj0gZWxlbWVudFNwYW4pKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignZWxlbWVudFNwYW4gbXVzdCBiZSBhIChwb3NpdGl2ZSkgaW50ZWdlcicpOwoJCSAgICAgICAgfQoJCSAgICAgICAgc3VwZXIoLTEsIHByb3BlcnR5KTsKCQkgICAgICAgIC8qKiBUaGUgbGF5b3V0IGZvciBpbmRpdmlkdWFsIGVsZW1lbnRzIG9mIHRoZSBzZXF1ZW5jZS4gIFRoZSB2YWx1ZQoJCSAgICAgICAgICogbXVzdCBiZSBhIHBvc2l0aXZlIGludGVnZXIuICBJZiBub3QgcHJvdmlkZWQsIHRoZSB2YWx1ZSB3aWxsIGJlCgkJICAgICAgICAgKiAxLiAqLwoJCSAgICAgICAgdGhpcy5lbGVtZW50U3BhbiA9IGVsZW1lbnRTcGFuOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgaXNDb3VudCgpIHsKCQkgICAgICAgIHJldHVybiB0cnVlOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZGVjb2RlKGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIGNoZWNrVWludDhBcnJheShiKTsKCQkgICAgICAgIGNvbnN0IHJlbSA9IGIubGVuZ3RoIC0gb2Zmc2V0OwoJCSAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IocmVtIC8gdGhpcy5lbGVtZW50U3Bhbik7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQpIHsKCQkgICAgICAgIHJldHVybiAwOwoJCSAgICB9CgkJfQoJCUxheW91dC5HcmVlZHlDb3VudCA9IEdyZWVkeUNvdW50OwoJCS8qKgoJCSAqIEFuIHtAbGluayBFeHRlcm5hbExheW91dH0gdGhhdCBzdXBwb3J0cyBhY2Nlc3NpbmcgYSB7QGxpbmsgTGF5b3V0fQoJCSAqIGF0IGEgZml4ZWQgb2Zmc2V0IGZyb20gdGhlIHN0YXJ0IG9mIGFub3RoZXIgTGF5b3V0LiAgVGhlIG9mZnNldCBtYXkKCQkgKiBiZSBiZWZvcmUsIHdpdGhpbiwgb3IgYWZ0ZXIgdGhlIGJhc2UgbGF5b3V0LgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5vZmZzZXR8b2Zmc2V0fQoJCSAqCgkJICogQHBhcmFtIHtMYXlvdXR9IGxheW91dCAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBPZmZzZXRMYXlvdXQjbGF5b3V0fGxheW91dH0sIG1vZHVsbyBgcHJvcGVydHlgLgoJCSAqCgkJICogQHBhcmFtIHtOdW1iZXJ9IFtvZmZzZXRdIC0gSW5pdGlhbGl6ZXMge0BsaW5rCgkJICogT2Zmc2V0TGF5b3V0I29mZnNldHxvZmZzZXR9LiAgRGVmYXVsdHMgdG8gemVyby4KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gT3B0aW9uYWwgbmV3IHByb3BlcnR5IG5hbWUgZm9yIGEKCQkgKiB7QGxpbmsgTGF5b3V0I3JlcGxpY2F0ZXwgcmVwbGljYX0gb2YgYGxheW91dGAgdG8gYmUgdXNlZCBhcyB7QGxpbmsKCQkgKiBPZmZzZXRMYXlvdXQjbGF5b3V0fGxheW91dH0uICBJZiBub3QgcHJvdmlkZWQgdGhlIGBsYXlvdXRgIGlzIHVzZWQKCQkgKiB1bmNoYW5nZWQuCgkJICoKCQkgKiBAYXVnbWVudHMge0xheW91dH0KCQkgKi8KCQljbGFzcyBPZmZzZXRMYXlvdXQgZXh0ZW5kcyBFeHRlcm5hbExheW91dCB7CgkJICAgIGNvbnN0cnVjdG9yKGxheW91dCwgb2Zmc2V0ID0gMCwgcHJvcGVydHkpIHsKCQkgICAgICAgIGlmICghKGxheW91dCBpbnN0YW5jZW9mIExheW91dCQxKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2xheW91dCBtdXN0IGJlIGEgTGF5b3V0Jyk7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoIU51bWJlci5pc0ludGVnZXIob2Zmc2V0KSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ29mZnNldCBtdXN0IGJlIGludGVnZXIgb3IgdW5kZWZpbmVkJyk7CgkJICAgICAgICB9CgkJICAgICAgICBzdXBlcihsYXlvdXQuc3BhbiwgcHJvcGVydHkgfHwgbGF5b3V0LnByb3BlcnR5KTsKCQkgICAgICAgIC8qKiBUaGUgc3Vib3JkaW5hdGVkIGxheW91dC4gKi8KCQkgICAgICAgIHRoaXMubGF5b3V0ID0gbGF5b3V0OwoJCSAgICAgICAgLyoqIFRoZSBsb2NhdGlvbiBvZiB7QGxpbmsgT2Zmc2V0TGF5b3V0I2xheW91dH0gcmVsYXRpdmUgdG8gdGhlCgkJICAgICAgICAgKiBzdGFydCBvZiBhbm90aGVyIGxheW91dC4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiBUaGUgdmFsdWUgbWF5IGJlIHBvc2l0aXZlIG9yIG5lZ2F0aXZlLCBidXQgYW4gZXJyb3Igd2lsbCB0aHJvd24KCQkgICAgICAgICAqIGlmIGF0IHRoZSBwb2ludCBvZiB1c2UgaXQgZ29lcyBvdXRzaWRlIHRoZSBzcGFuIG9mIHRoZSBVaW50OEFycmF5CgkJICAgICAgICAgKiBiZWluZyBhY2Nlc3NlZC4gICovCgkJICAgICAgICB0aGlzLm9mZnNldCA9IG9mZnNldDsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGlzQ291bnQoKSB7CgkJICAgICAgICByZXR1cm4gKCh0aGlzLmxheW91dCBpbnN0YW5jZW9mIFVJbnQpCgkJICAgICAgICAgICAgfHwgKHRoaXMubGF5b3V0IGluc3RhbmNlb2YgVUludEJFKSk7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBkZWNvZGUoYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgcmV0dXJuIHRoaXMubGF5b3V0LmRlY29kZShiLCBvZmZzZXQgKyB0aGlzLm9mZnNldCk7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICByZXR1cm4gdGhpcy5sYXlvdXQuZW5jb2RlKHNyYywgYiwgb2Zmc2V0ICsgdGhpcy5vZmZzZXQpOwoJCSAgICB9CgkJfQoJCUxheW91dC5PZmZzZXRMYXlvdXQgPSBPZmZzZXRMYXlvdXQ7CgkJLyoqCgkJICogUmVwcmVzZW50IGFuIHVuc2lnbmVkIGludGVnZXIgaW4gbGl0dGxlLWVuZGlhbiBmb3JtYXQuCgkJICoKCQkgKiAqRmFjdG9yeSo6IHtAbGluayBtb2R1bGU6TGF5b3V0LnU4fHU4fSwge0BsaW5rCgkJICogIG1vZHVsZTpMYXlvdXQudTE2fHUxNn0sIHtAbGluayBtb2R1bGU6TGF5b3V0LnUyNHx1MjR9LCB7QGxpbmsKCQkgKiAgbW9kdWxlOkxheW91dC51MzJ8dTMyfSwge0BsaW5rIG1vZHVsZTpMYXlvdXQudTQwfHU0MH0sIHtAbGluawoJCSAqICBtb2R1bGU6TGF5b3V0LnU0OHx1NDh9CgkJICoKCQkgKiBAcGFyYW0ge051bWJlcn0gc3BhbiAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsgTGF5b3V0I3NwYW58c3Bhbn0uCgkJICogVGhlIHBhcmFtZXRlciBjYW4gcmFuZ2UgZnJvbSAxIHRocm91Z2ggNi4KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICoKCQkgKiBAYXVnbWVudHMge0xheW91dH0KCQkgKi8KCQljbGFzcyBVSW50IGV4dGVuZHMgTGF5b3V0JDEgewoJCSAgICBjb25zdHJ1Y3RvcihzcGFuLCBwcm9wZXJ0eSkgewoJCSAgICAgICAgc3VwZXIoc3BhbiwgcHJvcGVydHkpOwoJCSAgICAgICAgaWYgKDYgPCB0aGlzLnNwYW4pIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc3BhbiBtdXN0IG5vdCBleGNlZWQgNiBieXRlcycpOwoJCSAgICAgICAgfQoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZGVjb2RlKGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIHJldHVybiB1aW50OEFycmF5VG9CdWZmZXIoYikucmVhZFVJbnRMRShvZmZzZXQsIHRoaXMuc3Bhbik7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICB1aW50OEFycmF5VG9CdWZmZXIoYikud3JpdGVVSW50TEUoc3JjLCBvZmZzZXQsIHRoaXMuc3Bhbik7CgkJICAgICAgICByZXR1cm4gdGhpcy5zcGFuOwoJCSAgICB9CgkJfQoJCUxheW91dC5VSW50ID0gVUludDsKCQkvKioKCQkgKiBSZXByZXNlbnQgYW4gdW5zaWduZWQgaW50ZWdlciBpbiBiaWctZW5kaWFuIGZvcm1hdC4KCQkgKgoJCSAqICpGYWN0b3J5Kjoge0BsaW5rIG1vZHVsZTpMYXlvdXQudThiZXx1OGJlfSwge0BsaW5rCgkJICogbW9kdWxlOkxheW91dC51MTZiZXx1MTZiZX0sIHtAbGluayBtb2R1bGU6TGF5b3V0LnUyNGJlfHUyNGJlfSwKCQkgKiB7QGxpbmsgbW9kdWxlOkxheW91dC51MzJiZXx1MzJiZX0sIHtAbGluawoJCSAqIG1vZHVsZTpMYXlvdXQudTQwYmV8dTQwYmV9LCB7QGxpbmsgbW9kdWxlOkxheW91dC51NDhiZXx1NDhiZX0KCQkgKgoJCSAqIEBwYXJhbSB7TnVtYmVyfSBzcGFuIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluayBMYXlvdXQjc3BhbnxzcGFufS4KCQkgKiBUaGUgcGFyYW1ldGVyIGNhbiByYW5nZSBmcm9tIDEgdGhyb3VnaCA2LgoJCSAqCgkJICogQHBhcmFtIHtzdHJpbmd9IFtwcm9wZXJ0eV0gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fS4KCQkgKgoJCSAqIEBhdWdtZW50cyB7TGF5b3V0fQoJCSAqLwoJCWNsYXNzIFVJbnRCRSBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3Ioc3BhbiwgcHJvcGVydHkpIHsKCQkgICAgICAgIHN1cGVyKHNwYW4sIHByb3BlcnR5KTsKCQkgICAgICAgIGlmICg2IDwgdGhpcy5zcGFuKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3NwYW4gbXVzdCBub3QgZXhjZWVkIDYgYnl0ZXMnKTsKCQkgICAgICAgIH0KCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICByZXR1cm4gdWludDhBcnJheVRvQnVmZmVyKGIpLnJlYWRVSW50QkUob2Zmc2V0LCB0aGlzLnNwYW4pOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgdWludDhBcnJheVRvQnVmZmVyKGIpLndyaXRlVUludEJFKHNyYywgb2Zmc2V0LCB0aGlzLnNwYW4pOwoJCSAgICAgICAgcmV0dXJuIHRoaXMuc3BhbjsKCQkgICAgfQoJCX0KCQlMYXlvdXQuVUludEJFID0gVUludEJFOwoJCS8qKgoJCSAqIFJlcHJlc2VudCBhIHNpZ25lZCBpbnRlZ2VyIGluIGxpdHRsZS1lbmRpYW4gZm9ybWF0LgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5zOHxzOH0sIHtAbGluawoJCSAqICBtb2R1bGU6TGF5b3V0LnMxNnxzMTZ9LCB7QGxpbmsgbW9kdWxlOkxheW91dC5zMjR8czI0fSwge0BsaW5rCgkJICogIG1vZHVsZTpMYXlvdXQuczMyfHMzMn0sIHtAbGluayBtb2R1bGU6TGF5b3V0LnM0MHxzNDB9LCB7QGxpbmsKCQkgKiAgbW9kdWxlOkxheW91dC5zNDh8czQ4fQoJCSAqCgkJICogQHBhcmFtIHtOdW1iZXJ9IHNwYW4gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rIExheW91dCNzcGFufHNwYW59LgoJCSAqIFRoZSBwYXJhbWV0ZXIgY2FuIHJhbmdlIGZyb20gMSB0aHJvdWdoIDYuCgkJICoKCQkgKiBAcGFyYW0ge3N0cmluZ30gW3Byb3BlcnR5XSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9LgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgSW50IGV4dGVuZHMgTGF5b3V0JDEgewoJCSAgICBjb25zdHJ1Y3RvcihzcGFuLCBwcm9wZXJ0eSkgewoJCSAgICAgICAgc3VwZXIoc3BhbiwgcHJvcGVydHkpOwoJCSAgICAgICAgaWYgKDYgPCB0aGlzLnNwYW4pIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc3BhbiBtdXN0IG5vdCBleGNlZWQgNiBieXRlcycpOwoJCSAgICAgICAgfQoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZGVjb2RlKGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIHJldHVybiB1aW50OEFycmF5VG9CdWZmZXIoYikucmVhZEludExFKG9mZnNldCwgdGhpcy5zcGFuKTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGVuY29kZShzcmMsIGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIHVpbnQ4QXJyYXlUb0J1ZmZlcihiKS53cml0ZUludExFKHNyYywgb2Zmc2V0LCB0aGlzLnNwYW4pOwoJCSAgICAgICAgcmV0dXJuIHRoaXMuc3BhbjsKCQkgICAgfQoJCX0KCQlMYXlvdXQuSW50ID0gSW50OwoJCS8qKgoJCSAqIFJlcHJlc2VudCBhIHNpZ25lZCBpbnRlZ2VyIGluIGJpZy1lbmRpYW4gZm9ybWF0LgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5zOGJlfHM4YmV9LCB7QGxpbmsKCQkgKiBtb2R1bGU6TGF5b3V0LnMxNmJlfHMxNmJlfSwge0BsaW5rIG1vZHVsZTpMYXlvdXQuczI0YmV8czI0YmV9LAoJCSAqIHtAbGluayBtb2R1bGU6TGF5b3V0LnMzMmJlfHMzMmJlfSwge0BsaW5rCgkJICogbW9kdWxlOkxheW91dC5zNDBiZXxzNDBiZX0sIHtAbGluayBtb2R1bGU6TGF5b3V0LnM0OGJlfHM0OGJlfQoJCSAqCgkJICogQHBhcmFtIHtOdW1iZXJ9IHNwYW4gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rIExheW91dCNzcGFufHNwYW59LgoJCSAqIFRoZSBwYXJhbWV0ZXIgY2FuIHJhbmdlIGZyb20gMSB0aHJvdWdoIDYuCgkJICoKCQkgKiBAcGFyYW0ge3N0cmluZ30gW3Byb3BlcnR5XSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9LgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgSW50QkUgZXh0ZW5kcyBMYXlvdXQkMSB7CgkJICAgIGNvbnN0cnVjdG9yKHNwYW4sIHByb3BlcnR5KSB7CgkJICAgICAgICBzdXBlcihzcGFuLCBwcm9wZXJ0eSk7CgkJICAgICAgICBpZiAoNiA8IHRoaXMuc3BhbikgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdzcGFuIG11c3Qgbm90IGV4Y2VlZCA2IGJ5dGVzJyk7CgkJICAgICAgICB9CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBkZWNvZGUoYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgcmV0dXJuIHVpbnQ4QXJyYXlUb0J1ZmZlcihiKS5yZWFkSW50QkUob2Zmc2V0LCB0aGlzLnNwYW4pOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgdWludDhBcnJheVRvQnVmZmVyKGIpLndyaXRlSW50QkUoc3JjLCBvZmZzZXQsIHRoaXMuc3Bhbik7CgkJICAgICAgICByZXR1cm4gdGhpcy5zcGFuOwoJCSAgICB9CgkJfQoJCUxheW91dC5JbnRCRSA9IEludEJFOwoJCWNvbnN0IFYyRTMyID0gTWF0aC5wb3coMiwgMzIpOwoJCS8qIFRydWUgbW9kdWx1cyBoaWdoIGFuZCBsb3cgMzItYml0IHdvcmRzLCB3aGVyZSBsb3cgd29yZCBpcyBhbHdheXMKCQkgKiBub24tbmVnYXRpdmUuICovCgkJZnVuY3Rpb24gZGl2bW9kSW50NjQoc3JjKSB7CgkJICAgIGNvbnN0IGhpMzIgPSBNYXRoLmZsb29yKHNyYyAvIFYyRTMyKTsKCQkgICAgY29uc3QgbG8zMiA9IHNyYyAtIChoaTMyICogVjJFMzIpOwoJCSAgICByZXR1cm4geyBoaTMyLCBsbzMyIH07CgkJfQoJCS8qIFJlY29uc3RydWN0IE51bWJlciBmcm9tIHF1b3RpZW50IGFuZCBub24tbmVnYXRpdmUgcmVtYWluZGVyICovCgkJZnVuY3Rpb24gcm91bmRlZEludDY0KGhpMzIsIGxvMzIpIHsKCQkgICAgcmV0dXJuIGhpMzIgKiBWMkUzMiArIGxvMzI7CgkJfQoJCS8qKgoJCSAqIFJlcHJlc2VudCBhbiB1bnNpZ25lZCA2NC1iaXQgaW50ZWdlciBpbiBsaXR0bGUtZW5kaWFuIGZvcm1hdCB3aGVuCgkJICogZW5jb2RlZCBhbmQgYXMgYSBuZWFyIGludGVncmFsIEphdmFTY3JpcHQgTnVtYmVyIHdoZW4gZGVjb2RlZC4KCQkgKgoJCSAqICpGYWN0b3J5Kjoge0BsaW5rIG1vZHVsZTpMYXlvdXQubnU2NHxudTY0fQoJCSAqCgkJICogKipOT1RFKiogVmFsdWVzIHdpdGggbWFnbml0dWRlIGdyZWF0ZXIgdGhhbiAyXjUyIG1heSBub3QgZGVjb2RlIHRvCgkJICogdGhlIGV4YWN0IHZhbHVlIG9mIHRoZSBlbmNvZGVkIHJlcHJlc2VudGF0aW9uLgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgTmVhclVJbnQ2NCBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IocHJvcGVydHkpIHsKCQkgICAgICAgIHN1cGVyKDgsIHByb3BlcnR5KTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBjb25zdCBidWZmZXIgPSB1aW50OEFycmF5VG9CdWZmZXIoYik7CgkJICAgICAgICBjb25zdCBsbzMyID0gYnVmZmVyLnJlYWRVSW50MzJMRShvZmZzZXQpOwoJCSAgICAgICAgY29uc3QgaGkzMiA9IGJ1ZmZlci5yZWFkVUludDMyTEUob2Zmc2V0ICsgNCk7CgkJICAgICAgICByZXR1cm4gcm91bmRlZEludDY0KGhpMzIsIGxvMzIpOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3Qgc3BsaXQgPSBkaXZtb2RJbnQ2NChzcmMpOwoJCSAgICAgICAgY29uc3QgYnVmZmVyID0gdWludDhBcnJheVRvQnVmZmVyKGIpOwoJCSAgICAgICAgYnVmZmVyLndyaXRlVUludDMyTEUoc3BsaXQubG8zMiwgb2Zmc2V0KTsKCQkgICAgICAgIGJ1ZmZlci53cml0ZVVJbnQzMkxFKHNwbGl0LmhpMzIsIG9mZnNldCArIDQpOwoJCSAgICAgICAgcmV0dXJuIDg7CgkJICAgIH0KCQl9CgkJTGF5b3V0Lk5lYXJVSW50NjQgPSBOZWFyVUludDY0OwoJCS8qKgoJCSAqIFJlcHJlc2VudCBhbiB1bnNpZ25lZCA2NC1iaXQgaW50ZWdlciBpbiBiaWctZW5kaWFuIGZvcm1hdCB3aGVuCgkJICogZW5jb2RlZCBhbmQgYXMgYSBuZWFyIGludGVncmFsIEphdmFTY3JpcHQgTnVtYmVyIHdoZW4gZGVjb2RlZC4KCQkgKgoJCSAqICpGYWN0b3J5Kjoge0BsaW5rIG1vZHVsZTpMYXlvdXQubnU2NGJlfG51NjRiZX0KCQkgKgoJCSAqICoqTk9URSoqIFZhbHVlcyB3aXRoIG1hZ25pdHVkZSBncmVhdGVyIHRoYW4gMl41MiBtYXkgbm90IGRlY29kZSB0bwoJCSAqIHRoZSBleGFjdCB2YWx1ZSBvZiB0aGUgZW5jb2RlZCByZXByZXNlbnRhdGlvbi4KCQkgKgoJCSAqIEBhdWdtZW50cyB7TGF5b3V0fQoJCSAqLwoJCWNsYXNzIE5lYXJVSW50NjRCRSBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IocHJvcGVydHkpIHsKCQkgICAgICAgIHN1cGVyKDgsIHByb3BlcnR5KTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBjb25zdCBidWZmZXIgPSB1aW50OEFycmF5VG9CdWZmZXIoYik7CgkJICAgICAgICBjb25zdCBoaTMyID0gYnVmZmVyLnJlYWRVSW50MzJCRShvZmZzZXQpOwoJCSAgICAgICAgY29uc3QgbG8zMiA9IGJ1ZmZlci5yZWFkVUludDMyQkUob2Zmc2V0ICsgNCk7CgkJICAgICAgICByZXR1cm4gcm91bmRlZEludDY0KGhpMzIsIGxvMzIpOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3Qgc3BsaXQgPSBkaXZtb2RJbnQ2NChzcmMpOwoJCSAgICAgICAgY29uc3QgYnVmZmVyID0gdWludDhBcnJheVRvQnVmZmVyKGIpOwoJCSAgICAgICAgYnVmZmVyLndyaXRlVUludDMyQkUoc3BsaXQuaGkzMiwgb2Zmc2V0KTsKCQkgICAgICAgIGJ1ZmZlci53cml0ZVVJbnQzMkJFKHNwbGl0LmxvMzIsIG9mZnNldCArIDQpOwoJCSAgICAgICAgcmV0dXJuIDg7CgkJICAgIH0KCQl9CgkJTGF5b3V0Lk5lYXJVSW50NjRCRSA9IE5lYXJVSW50NjRCRTsKCQkvKioKCQkgKiBSZXByZXNlbnQgYSBzaWduZWQgNjQtYml0IGludGVnZXIgaW4gbGl0dGxlLWVuZGlhbiBmb3JtYXQgd2hlbgoJCSAqIGVuY29kZWQgYW5kIGFzIGEgbmVhciBpbnRlZ3JhbCBKYXZhU2NyaXB0IE51bWJlciB3aGVuIGRlY29kZWQuCgkJICoKCQkgKiAqRmFjdG9yeSo6IHtAbGluayBtb2R1bGU6TGF5b3V0Lm5zNjR8bnM2NH0KCQkgKgoJCSAqICoqTk9URSoqIFZhbHVlcyB3aXRoIG1hZ25pdHVkZSBncmVhdGVyIHRoYW4gMl41MiBtYXkgbm90IGRlY29kZSB0bwoJCSAqIHRoZSBleGFjdCB2YWx1ZSBvZiB0aGUgZW5jb2RlZCByZXByZXNlbnRhdGlvbi4KCQkgKgoJCSAqIEBhdWdtZW50cyB7TGF5b3V0fQoJCSAqLwoJCWNsYXNzIE5lYXJJbnQ2NCBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IocHJvcGVydHkpIHsKCQkgICAgICAgIHN1cGVyKDgsIHByb3BlcnR5KTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBjb25zdCBidWZmZXIgPSB1aW50OEFycmF5VG9CdWZmZXIoYik7CgkJICAgICAgICBjb25zdCBsbzMyID0gYnVmZmVyLnJlYWRVSW50MzJMRShvZmZzZXQpOwoJCSAgICAgICAgY29uc3QgaGkzMiA9IGJ1ZmZlci5yZWFkSW50MzJMRShvZmZzZXQgKyA0KTsKCQkgICAgICAgIHJldHVybiByb3VuZGVkSW50NjQoaGkzMiwgbG8zMik7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBjb25zdCBzcGxpdCA9IGRpdm1vZEludDY0KHNyYyk7CgkJICAgICAgICBjb25zdCBidWZmZXIgPSB1aW50OEFycmF5VG9CdWZmZXIoYik7CgkJICAgICAgICBidWZmZXIud3JpdGVVSW50MzJMRShzcGxpdC5sbzMyLCBvZmZzZXQpOwoJCSAgICAgICAgYnVmZmVyLndyaXRlSW50MzJMRShzcGxpdC5oaTMyLCBvZmZzZXQgKyA0KTsKCQkgICAgICAgIHJldHVybiA4OwoJCSAgICB9CgkJfQoJCUxheW91dC5OZWFySW50NjQgPSBOZWFySW50NjQ7CgkJLyoqCgkJICogUmVwcmVzZW50IGEgc2lnbmVkIDY0LWJpdCBpbnRlZ2VyIGluIGJpZy1lbmRpYW4gZm9ybWF0IHdoZW4KCQkgKiBlbmNvZGVkIGFuZCBhcyBhIG5lYXIgaW50ZWdyYWwgSmF2YVNjcmlwdCBOdW1iZXIgd2hlbiBkZWNvZGVkLgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5uczY0YmV8bnM2NGJlfQoJCSAqCgkJICogKipOT1RFKiogVmFsdWVzIHdpdGggbWFnbml0dWRlIGdyZWF0ZXIgdGhhbiAyXjUyIG1heSBub3QgZGVjb2RlIHRvCgkJICogdGhlIGV4YWN0IHZhbHVlIG9mIHRoZSBlbmNvZGVkIHJlcHJlc2VudGF0aW9uLgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgTmVhckludDY0QkUgZXh0ZW5kcyBMYXlvdXQkMSB7CgkJICAgIGNvbnN0cnVjdG9yKHByb3BlcnR5KSB7CgkJICAgICAgICBzdXBlcig4LCBwcm9wZXJ0eSk7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBkZWNvZGUoYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3QgYnVmZmVyID0gdWludDhBcnJheVRvQnVmZmVyKGIpOwoJCSAgICAgICAgY29uc3QgaGkzMiA9IGJ1ZmZlci5yZWFkSW50MzJCRShvZmZzZXQpOwoJCSAgICAgICAgY29uc3QgbG8zMiA9IGJ1ZmZlci5yZWFkVUludDMyQkUob2Zmc2V0ICsgNCk7CgkJICAgICAgICByZXR1cm4gcm91bmRlZEludDY0KGhpMzIsIGxvMzIpOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3Qgc3BsaXQgPSBkaXZtb2RJbnQ2NChzcmMpOwoJCSAgICAgICAgY29uc3QgYnVmZmVyID0gdWludDhBcnJheVRvQnVmZmVyKGIpOwoJCSAgICAgICAgYnVmZmVyLndyaXRlSW50MzJCRShzcGxpdC5oaTMyLCBvZmZzZXQpOwoJCSAgICAgICAgYnVmZmVyLndyaXRlVUludDMyQkUoc3BsaXQubG8zMiwgb2Zmc2V0ICsgNCk7CgkJICAgICAgICByZXR1cm4gODsKCQkgICAgfQoJCX0KCQlMYXlvdXQuTmVhckludDY0QkUgPSBOZWFySW50NjRCRTsKCQkvKioKCQkgKiBSZXByZXNlbnQgYSAzMi1iaXQgZmxvYXRpbmcgcG9pbnQgbnVtYmVyIGluIGxpdHRsZS1lbmRpYW4gZm9ybWF0LgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5mMzJ8ZjMyfQoJCSAqCgkJICogQHBhcmFtIHtzdHJpbmd9IFtwcm9wZXJ0eV0gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fS4KCQkgKgoJCSAqIEBhdWdtZW50cyB7TGF5b3V0fQoJCSAqLwoJCWNsYXNzIEZsb2F0IGV4dGVuZHMgTGF5b3V0JDEgewoJCSAgICBjb25zdHJ1Y3Rvcihwcm9wZXJ0eSkgewoJCSAgICAgICAgc3VwZXIoNCwgcHJvcGVydHkpOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZGVjb2RlKGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIHJldHVybiB1aW50OEFycmF5VG9CdWZmZXIoYikucmVhZEZsb2F0TEUob2Zmc2V0KTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGVuY29kZShzcmMsIGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIHVpbnQ4QXJyYXlUb0J1ZmZlcihiKS53cml0ZUZsb2F0TEUoc3JjLCBvZmZzZXQpOwoJCSAgICAgICAgcmV0dXJuIDQ7CgkJICAgIH0KCQl9CgkJTGF5b3V0LkZsb2F0ID0gRmxvYXQ7CgkJLyoqCgkJICogUmVwcmVzZW50IGEgMzItYml0IGZsb2F0aW5nIHBvaW50IG51bWJlciBpbiBiaWctZW5kaWFuIGZvcm1hdC4KCQkgKgoJCSAqICpGYWN0b3J5Kjoge0BsaW5rIG1vZHVsZTpMYXlvdXQuZjMyYmV8ZjMyYmV9CgkJICoKCQkgKiBAcGFyYW0ge3N0cmluZ30gW3Byb3BlcnR5XSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9LgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgRmxvYXRCRSBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IocHJvcGVydHkpIHsKCQkgICAgICAgIHN1cGVyKDQsIHByb3BlcnR5KTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICByZXR1cm4gdWludDhBcnJheVRvQnVmZmVyKGIpLnJlYWRGbG9hdEJFKG9mZnNldCk7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICB1aW50OEFycmF5VG9CdWZmZXIoYikud3JpdGVGbG9hdEJFKHNyYywgb2Zmc2V0KTsKCQkgICAgICAgIHJldHVybiA0OwoJCSAgICB9CgkJfQoJCUxheW91dC5GbG9hdEJFID0gRmxvYXRCRTsKCQkvKioKCQkgKiBSZXByZXNlbnQgYSA2NC1iaXQgZmxvYXRpbmcgcG9pbnQgbnVtYmVyIGluIGxpdHRsZS1lbmRpYW4gZm9ybWF0LgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5mNjR8ZjY0fQoJCSAqCgkJICogQHBhcmFtIHtzdHJpbmd9IFtwcm9wZXJ0eV0gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fS4KCQkgKgoJCSAqIEBhdWdtZW50cyB7TGF5b3V0fQoJCSAqLwoJCWNsYXNzIERvdWJsZSBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IocHJvcGVydHkpIHsKCQkgICAgICAgIHN1cGVyKDgsIHByb3BlcnR5KTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICByZXR1cm4gdWludDhBcnJheVRvQnVmZmVyKGIpLnJlYWREb3VibGVMRShvZmZzZXQpOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgdWludDhBcnJheVRvQnVmZmVyKGIpLndyaXRlRG91YmxlTEUoc3JjLCBvZmZzZXQpOwoJCSAgICAgICAgcmV0dXJuIDg7CgkJICAgIH0KCQl9CgkJTGF5b3V0LkRvdWJsZSA9IERvdWJsZTsKCQkvKioKCQkgKiBSZXByZXNlbnQgYSA2NC1iaXQgZmxvYXRpbmcgcG9pbnQgbnVtYmVyIGluIGJpZy1lbmRpYW4gZm9ybWF0LgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5mNjRiZXxmNjRiZX0KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICoKCQkgKiBAYXVnbWVudHMge0xheW91dH0KCQkgKi8KCQljbGFzcyBEb3VibGVCRSBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IocHJvcGVydHkpIHsKCQkgICAgICAgIHN1cGVyKDgsIHByb3BlcnR5KTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICByZXR1cm4gdWludDhBcnJheVRvQnVmZmVyKGIpLnJlYWREb3VibGVCRShvZmZzZXQpOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgdWludDhBcnJheVRvQnVmZmVyKGIpLndyaXRlRG91YmxlQkUoc3JjLCBvZmZzZXQpOwoJCSAgICAgICAgcmV0dXJuIDg7CgkJICAgIH0KCQl9CgkJTGF5b3V0LkRvdWJsZUJFID0gRG91YmxlQkU7CgkJLyoqCgkJICogUmVwcmVzZW50IGEgY29udGlndW91cyBzZXF1ZW5jZSBvZiBhIHNwZWNpZmljIGxheW91dCBhcyBhbiBBcnJheS4KCQkgKgoJCSAqICpGYWN0b3J5Kjoge0BsaW5rIG1vZHVsZTpMYXlvdXQuc2VxfHNlcX0KCQkgKgoJCSAqIEBwYXJhbSB7TGF5b3V0fSBlbGVtZW50TGF5b3V0IC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIFNlcXVlbmNlI2VsZW1lbnRMYXlvdXR8ZWxlbWVudExheW91dH0uCgkJICoKCQkgKiBAcGFyYW0geyhOdW1iZXJ8RXh0ZXJuYWxMYXlvdXQpfSBjb3VudCAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBTZXF1ZW5jZSNjb3VudHxjb3VudH0uICBUaGUgcGFyYW1ldGVyIG11c3QgYmUgZWl0aGVyIGEgcG9zaXRpdmUKCQkgKiBpbnRlZ2VyIG9yIGFuIGluc3RhbmNlIG9mIHtAbGluayBFeHRlcm5hbExheW91dH0uCgkJICoKCQkgKiBAcGFyYW0ge3N0cmluZ30gW3Byb3BlcnR5XSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9LgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgU2VxdWVuY2UgZXh0ZW5kcyBMYXlvdXQkMSB7CgkJICAgIGNvbnN0cnVjdG9yKGVsZW1lbnRMYXlvdXQsIGNvdW50LCBwcm9wZXJ0eSkgewoJCSAgICAgICAgaWYgKCEoZWxlbWVudExheW91dCBpbnN0YW5jZW9mIExheW91dCQxKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2VsZW1lbnRMYXlvdXQgbXVzdCBiZSBhIExheW91dCcpOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKCEoKChjb3VudCBpbnN0YW5jZW9mIEV4dGVybmFsTGF5b3V0KSAmJiBjb3VudC5pc0NvdW50KCkpCgkJICAgICAgICAgICAgfHwgKE51bWJlci5pc0ludGVnZXIoY291bnQpICYmICgwIDw9IGNvdW50KSkpKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignY291bnQgbXVzdCBiZSBub24tbmVnYXRpdmUgaW50ZWdlciAnCgkJICAgICAgICAgICAgICAgICsgJ29yIGFuIHVuc2lnbmVkIGludGVnZXIgRXh0ZXJuYWxMYXlvdXQnKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGxldCBzcGFuID0gLTE7CgkJICAgICAgICBpZiAoKCEoY291bnQgaW5zdGFuY2VvZiBFeHRlcm5hbExheW91dCkpCgkJICAgICAgICAgICAgJiYgKDAgPCBlbGVtZW50TGF5b3V0LnNwYW4pKSB7CgkJICAgICAgICAgICAgc3BhbiA9IGNvdW50ICogZWxlbWVudExheW91dC5zcGFuOwoJCSAgICAgICAgfQoJCSAgICAgICAgc3VwZXIoc3BhbiwgcHJvcGVydHkpOwoJCSAgICAgICAgLyoqIFRoZSBsYXlvdXQgZm9yIGluZGl2aWR1YWwgZWxlbWVudHMgb2YgdGhlIHNlcXVlbmNlLiAqLwoJCSAgICAgICAgdGhpcy5lbGVtZW50TGF5b3V0ID0gZWxlbWVudExheW91dDsKCQkgICAgICAgIC8qKiBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIHRoZSBzZXF1ZW5jZS4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiBUaGlzIHdpbGwgYmUgZWl0aGVyIGEgbm9uLW5lZ2F0aXZlIGludGVnZXIgb3IgYW4gaW5zdGFuY2Ugb2YKCQkgICAgICAgICAqIHtAbGluayBFeHRlcm5hbExheW91dH0gZm9yIHdoaWNoIHtAbGluawoJCSAgICAgICAgICogRXh0ZXJuYWxMYXlvdXQjaXNDb3VudHxpc0NvdW50KCl9IGlzIGB0cnVlYC4gKi8KCQkgICAgICAgIHRoaXMuY291bnQgPSBjb3VudDsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGdldFNwYW4oYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgaWYgKDAgPD0gdGhpcy5zcGFuKSB7CgkJICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3BhbjsKCQkgICAgICAgIH0KCQkgICAgICAgIGxldCBzcGFuID0gMDsKCQkgICAgICAgIGxldCBjb3VudCA9IHRoaXMuY291bnQ7CgkJICAgICAgICBpZiAoY291bnQgaW5zdGFuY2VvZiBFeHRlcm5hbExheW91dCkgewoJCSAgICAgICAgICAgIGNvdW50ID0gY291bnQuZGVjb2RlKGIsIG9mZnNldCk7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoMCA8IHRoaXMuZWxlbWVudExheW91dC5zcGFuKSB7CgkJICAgICAgICAgICAgc3BhbiA9IGNvdW50ICogdGhpcy5lbGVtZW50TGF5b3V0LnNwYW47CgkJICAgICAgICB9CgkJICAgICAgICBlbHNlIHsKCQkgICAgICAgICAgICBsZXQgaWR4ID0gMDsKCQkgICAgICAgICAgICB3aGlsZSAoaWR4IDwgY291bnQpIHsKCQkgICAgICAgICAgICAgICAgc3BhbiArPSB0aGlzLmVsZW1lbnRMYXlvdXQuZ2V0U3BhbihiLCBvZmZzZXQgKyBzcGFuKTsKCQkgICAgICAgICAgICAgICAgKytpZHg7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHNwYW47CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBkZWNvZGUoYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3QgcnYgPSBbXTsKCQkgICAgICAgIGxldCBpID0gMDsKCQkgICAgICAgIGxldCBjb3VudCA9IHRoaXMuY291bnQ7CgkJICAgICAgICBpZiAoY291bnQgaW5zdGFuY2VvZiBFeHRlcm5hbExheW91dCkgewoJCSAgICAgICAgICAgIGNvdW50ID0gY291bnQuZGVjb2RlKGIsIG9mZnNldCk7CgkJICAgICAgICB9CgkJICAgICAgICB3aGlsZSAoaSA8IGNvdW50KSB7CgkJICAgICAgICAgICAgcnYucHVzaCh0aGlzLmVsZW1lbnRMYXlvdXQuZGVjb2RlKGIsIG9mZnNldCkpOwoJCSAgICAgICAgICAgIG9mZnNldCArPSB0aGlzLmVsZW1lbnRMYXlvdXQuZ2V0U3BhbihiLCBvZmZzZXQpOwoJCSAgICAgICAgICAgIGkgKz0gMTsKCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiBydjsKCQkgICAgfQoJCSAgICAvKiogSW1wbGVtZW50IHtAbGluayBMYXlvdXQjZW5jb2RlfGVuY29kZX0gZm9yIHtAbGluayBTZXF1ZW5jZX0uCgkJICAgICAqCgkJICAgICAqICoqTk9URSoqIElmIGBzcmNgIGlzIHNob3J0ZXIgdGhhbiB7QGxpbmsgU2VxdWVuY2UjY291bnR8Y291bnR9IHRoZW4KCQkgICAgICogdGhlIHVudXNlZCBzcGFjZSBpbiB0aGUgYnVmZmVyIGlzIGxlZnQgdW5jaGFuZ2VkLiAgSWYgYHNyY2AgaXMKCQkgICAgICogbG9uZ2VyIHRoYW4ge0BsaW5rIFNlcXVlbmNlI2NvdW50fGNvdW50fSB0aGUgdW5uZWVkZWQgZWxlbWVudHMgYXJlCgkJICAgICAqIGlnbm9yZWQuCgkJICAgICAqCgkJICAgICAqICoqTk9URSoqIElmIHtAbGluayBMYXlvdXQjY291bnR8Y291bnR9IGlzIGFuIGluc3RhbmNlIG9mIHtAbGluawoJCSAgICAgKiBFeHRlcm5hbExheW91dH0gdGhlbiB0aGUgbGVuZ3RoIG9mIGBzcmNgIHdpbGwgYmUgZW5jb2RlZCBhcyB0aGUKCQkgICAgICogY291bnQgYWZ0ZXIgYHNyY2AgaXMgZW5jb2RlZC4gKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3QgZWxvID0gdGhpcy5lbGVtZW50TGF5b3V0OwoJCSAgICAgICAgY29uc3Qgc3BhbiA9IHNyYy5yZWR1Y2UoKHNwYW4sIHYpID0+IHsKCQkgICAgICAgICAgICByZXR1cm4gc3BhbiArIGVsby5lbmNvZGUodiwgYiwgb2Zmc2V0ICsgc3Bhbik7CgkJICAgICAgICB9LCAwKTsKCQkgICAgICAgIGlmICh0aGlzLmNvdW50IGluc3RhbmNlb2YgRXh0ZXJuYWxMYXlvdXQpIHsKCQkgICAgICAgICAgICB0aGlzLmNvdW50LmVuY29kZShzcmMubGVuZ3RoLCBiLCBvZmZzZXQpOwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHNwYW47CgkJICAgIH0KCQl9CgkJTGF5b3V0LlNlcXVlbmNlID0gU2VxdWVuY2U7CgkJLyoqCgkJICogUmVwcmVzZW50IGEgY29udGlndW91cyBzZXF1ZW5jZSBvZiBhcmJpdHJhcnkgbGF5b3V0IGVsZW1lbnRzIGFzIGFuCgkJICogT2JqZWN0LgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5zdHJ1Y3R8c3RydWN0fQoJCSAqCgkJICogKipOT1RFKiogVGhlIHtAbGluayBMYXlvdXQjc3BhbnxzcGFufSBvZiB0aGUgc3RydWN0dXJlIGlzIHZhcmlhYmxlCgkJICogaWYgYW55IGxheW91dCBpbiB7QGxpbmsgU3RydWN0dXJlI2ZpZWxkc3xmaWVsZHN9IGhhcyBhIHZhcmlhYmxlCgkJICogc3Bhbi4gIFdoZW4ge0BsaW5rIExheW91dCNlbmNvZGV8ZW5jb2Rpbmd9IHdlIG11c3QgaGF2ZSBhIHZhbHVlIGZvcgoJCSAqIGFsbCB2YXJpYWJsZS1sZW5ndGggZmllbGRzLCBvciB3ZSB3b3VsZG4ndCBiZSBhYmxlIHRvIGZpZ3VyZSBvdXQKCQkgKiBob3cgbXVjaCBzcGFjZSB0byB1c2UgZm9yIHN0b3JhZ2UuICBXZSBjYW4gb25seSBpZGVudGlmeSB0aGUgdmFsdWUKCQkgKiBmb3IgYSBmaWVsZCB3aGVuIGl0IGhhcyBhIHtAbGluayBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9LiAgQXMKCQkgKiBzdWNoLCBhbHRob3VnaCBhIHN0cnVjdHVyZSBtYXkgY29udGFpbiBib3RoIHVubmFtZWQgZmllbGRzIGFuZAoJCSAqIHZhcmlhYmxlLWxlbmd0aCBmaWVsZHMsIGl0IGNhbm5vdCBjb250YWluIGFuIHVubmFtZWQKCQkgKiB2YXJpYWJsZS1sZW5ndGggZmllbGQuCgkJICoKCQkgKiBAcGFyYW0ge0xheW91dFtdfSBmaWVsZHMgLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogU3RydWN0dXJlI2ZpZWxkc3xmaWVsZHN9LiAgQW4gZXJyb3IgaXMgcmFpc2VkIGlmIHRoaXMgY29udGFpbnMgYQoJCSAqIHZhcmlhYmxlLWxlbmd0aCBmaWVsZCBmb3Igd2hpY2ggYSB7QGxpbmsgTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fQoJCSAqIGlzIG5vdCBkZWZpbmVkLgoJCSAqCgkJICogQHBhcmFtIHtzdHJpbmd9IFtwcm9wZXJ0eV0gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fS4KCQkgKgoJCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW2RlY29kZVByZWZpeGVzXSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBTdHJ1Y3R1cmUjZGVjb2RlUHJlZml4ZXN8cHJvcGVydHl9LgoJCSAqCgkJICogQHRocm93cyB7RXJyb3J9IC0gaWYgYGZpZWxkc2AgY29udGFpbnMgYW4gdW5uYW1lZCB2YXJpYWJsZS1sZW5ndGgKCQkgKiBsYXlvdXQuCgkJICoKCQkgKiBAYXVnbWVudHMge0xheW91dH0KCQkgKi8KCQljbGFzcyBTdHJ1Y3R1cmUgZXh0ZW5kcyBMYXlvdXQkMSB7CgkJICAgIGNvbnN0cnVjdG9yKGZpZWxkcywgcHJvcGVydHksIGRlY29kZVByZWZpeGVzKSB7CgkJICAgICAgICBpZiAoIShBcnJheS5pc0FycmF5KGZpZWxkcykKCQkgICAgICAgICAgICAmJiBmaWVsZHMucmVkdWNlKChhY2MsIHYpID0+IGFjYyAmJiAodiBpbnN0YW5jZW9mIExheW91dCQxKSwgdHJ1ZSkpKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignZmllbGRzIG11c3QgYmUgYXJyYXkgb2YgTGF5b3V0IGluc3RhbmNlcycpOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKCgnYm9vbGVhbicgPT09IHR5cGVvZiBwcm9wZXJ0eSkKCQkgICAgICAgICAgICAmJiAodW5kZWZpbmVkID09PSBkZWNvZGVQcmVmaXhlcykpIHsKCQkgICAgICAgICAgICBkZWNvZGVQcmVmaXhlcyA9IHByb3BlcnR5OwoJCSAgICAgICAgICAgIHByb3BlcnR5ID0gdW5kZWZpbmVkOwoJCSAgICAgICAgfQoJCSAgICAgICAgLyogVmVyaWZ5IGFic2VuY2Ugb2YgdW5uYW1lZCB2YXJpYWJsZS1sZW5ndGggZmllbGRzLiAqLwoJCSAgICAgICAgZm9yIChjb25zdCBmZCBvZiBmaWVsZHMpIHsKCQkgICAgICAgICAgICBpZiAoKDAgPiBmZC5zcGFuKQoJCSAgICAgICAgICAgICAgICAmJiAodW5kZWZpbmVkID09PSBmZC5wcm9wZXJ0eSkpIHsKCQkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdmaWVsZHMgY2Fubm90IGNvbnRhaW4gdW5uYW1lZCB2YXJpYWJsZS1sZW5ndGggbGF5b3V0Jyk7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgfQoJCSAgICAgICAgbGV0IHNwYW4gPSAtMTsKCQkgICAgICAgIHRyeSB7CgkJICAgICAgICAgICAgc3BhbiA9IGZpZWxkcy5yZWR1Y2UoKHNwYW4sIGZkKSA9PiBzcGFuICsgZmQuZ2V0U3BhbigpLCAwKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGNhdGNoIChlKSB7CgkJICAgICAgICAgICAgLy8gaWdub3JlIGVycm9yCgkJICAgICAgICB9CgkJICAgICAgICBzdXBlcihzcGFuLCBwcm9wZXJ0eSk7CgkJICAgICAgICAvKiogVGhlIHNlcXVlbmNlIG9mIHtAbGluayBMYXlvdXR9IHZhbHVlcyB0aGF0IGNvbXByaXNlIHRoZQoJCSAgICAgICAgICogc3RydWN0dXJlLgoJCSAgICAgICAgICoKCQkgICAgICAgICAqIFRoZSBpbmRpdmlkdWFsIGVsZW1lbnRzIG5lZWQgbm90IGJlIHRoZSBzYW1lIHR5cGUsIGFuZCBtYXkgYmUKCQkgICAgICAgICAqIGVpdGhlciBzY2FsYXIgb3IgYWdncmVnYXRlIGxheW91dHMuICBJZiBhIG1lbWJlciBsYXlvdXQgbGVhdmVzCgkJICAgICAgICAgKiBpdHMge0BsaW5rIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0gdW5kZWZpbmVkIHRoZQoJCSAgICAgICAgICogY29ycmVzcG9uZGluZyByZWdpb24gb2YgdGhlIGJ1ZmZlciBhc3NvY2lhdGVkIHdpdGggdGhlIGVsZW1lbnQKCQkgICAgICAgICAqIHdpbGwgbm90IGJlIG11dGF0ZWQuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogQHR5cGUge0xheW91dFtdfSAqLwoJCSAgICAgICAgdGhpcy5maWVsZHMgPSBmaWVsZHM7CgkJICAgICAgICAvKiogQ29udHJvbCBiZWhhdmlvciBvZiB7QGxpbmsgTGF5b3V0I2RlY29kZXxkZWNvZGUoKX0gZ2l2ZW4gc2hvcnQKCQkgICAgICAgICAqIGJ1ZmZlcnMuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogSW4gc29tZSBzaXR1YXRpb25zIGEgc3RydWN0dXJlIG1hbnkgYmUgZXh0ZW5kZWQgd2l0aCBhZGRpdGlvbmFsCgkJICAgICAgICAgKiBmaWVsZHMgb3ZlciB0aW1lLCB3aXRoIG9sZGVyIGluc3RhbGxhdGlvbnMgcHJvdmlkaW5nIG9ubHkgYQoJCSAgICAgICAgICogcHJlZml4IG9mIHRoZSBmdWxsIHN0cnVjdHVyZS4gIElmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgCgkJICAgICAgICAgKiBkZWNvZGluZyB3aWxsIGFjY2VwdCB0aG9zZSBidWZmZXJzIGFuZCBsZWF2ZSBzdWJzZXF1ZW50IGZpZWxkcwoJCSAgICAgICAgICogdW5kZWZpbmVkLCBhcyBsb25nIGFzIHRoZSBidWZmZXIgZW5kcyBhdCBhIGZpZWxkIGJvdW5kYXJ5LgoJCSAgICAgICAgICogRGVmYXVsdHMgdG8gYGZhbHNlYC4gKi8KCQkgICAgICAgIHRoaXMuZGVjb2RlUHJlZml4ZXMgPSAhIWRlY29kZVByZWZpeGVzOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZ2V0U3BhbihiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBpZiAoMCA8PSB0aGlzLnNwYW4pIHsKCQkgICAgICAgICAgICByZXR1cm4gdGhpcy5zcGFuOwoJCSAgICAgICAgfQoJCSAgICAgICAgbGV0IHNwYW4gPSAwOwoJCSAgICAgICAgdHJ5IHsKCQkgICAgICAgICAgICBzcGFuID0gdGhpcy5maWVsZHMucmVkdWNlKChzcGFuLCBmZCkgPT4gewoJCSAgICAgICAgICAgICAgICBjb25zdCBmc3AgPSBmZC5nZXRTcGFuKGIsIG9mZnNldCk7CgkJICAgICAgICAgICAgICAgIG9mZnNldCArPSBmc3A7CgkJICAgICAgICAgICAgICAgIHJldHVybiBzcGFuICsgZnNwOwoJCSAgICAgICAgICAgIH0sIDApOwoJCSAgICAgICAgfQoJCSAgICAgICAgY2F0Y2ggKGUpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignaW5kZXRlcm1pbmF0ZSBzcGFuJyk7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gc3BhbjsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBjaGVja1VpbnQ4QXJyYXkoYik7CgkJICAgICAgICBjb25zdCBkZXN0ID0gdGhpcy5tYWtlRGVzdGluYXRpb25PYmplY3QoKTsKCQkgICAgICAgIGZvciAoY29uc3QgZmQgb2YgdGhpcy5maWVsZHMpIHsKCQkgICAgICAgICAgICBpZiAodW5kZWZpbmVkICE9PSBmZC5wcm9wZXJ0eSkgewoJCSAgICAgICAgICAgICAgICBkZXN0W2ZkLnByb3BlcnR5XSA9IGZkLmRlY29kZShiLCBvZmZzZXQpOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgICAgICBvZmZzZXQgKz0gZmQuZ2V0U3BhbihiLCBvZmZzZXQpOwoJCSAgICAgICAgICAgIGlmICh0aGlzLmRlY29kZVByZWZpeGVzCgkJICAgICAgICAgICAgICAgICYmIChiLmxlbmd0aCA9PT0gb2Zmc2V0KSkgewoJCSAgICAgICAgICAgICAgICBicmVhazsKCQkgICAgICAgICAgICB9CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gZGVzdDsKCQkgICAgfQoJCSAgICAvKiogSW1wbGVtZW50IHtAbGluayBMYXlvdXQjZW5jb2RlfGVuY29kZX0gZm9yIHtAbGluayBTdHJ1Y3R1cmV9LgoJCSAgICAgKgoJCSAgICAgKiBJZiBgc3JjYCBpcyBtaXNzaW5nIGEgcHJvcGVydHkgZm9yIGEgbWVtYmVyIHdpdGggYSBkZWZpbmVkIHtAbGluawoJCSAgICAgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9IHRoZSBjb3JyZXNwb25kaW5nIHJlZ2lvbiBvZiB0aGUgYnVmZmVyIGlzCgkJICAgICAqIGxlZnQgdW5tb2RpZmllZC4gKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3QgZmlyc3RPZmZzZXQgPSBvZmZzZXQ7CgkJICAgICAgICBsZXQgbGFzdE9mZnNldCA9IDA7CgkJICAgICAgICBsZXQgbGFzdFdyb3RlID0gMDsKCQkgICAgICAgIGZvciAoY29uc3QgZmQgb2YgdGhpcy5maWVsZHMpIHsKCQkgICAgICAgICAgICBsZXQgc3BhbiA9IGZkLnNwYW47CgkJICAgICAgICAgICAgbGFzdFdyb3RlID0gKDAgPCBzcGFuKSA/IHNwYW4gOiAwOwoJCSAgICAgICAgICAgIGlmICh1bmRlZmluZWQgIT09IGZkLnByb3BlcnR5KSB7CgkJICAgICAgICAgICAgICAgIGNvbnN0IGZ2ID0gc3JjW2ZkLnByb3BlcnR5XTsKCQkgICAgICAgICAgICAgICAgaWYgKHVuZGVmaW5lZCAhPT0gZnYpIHsKCQkgICAgICAgICAgICAgICAgICAgIGxhc3RXcm90ZSA9IGZkLmVuY29kZShmdiwgYiwgb2Zmc2V0KTsKCQkgICAgICAgICAgICAgICAgICAgIGlmICgwID4gc3BhbikgewoJCSAgICAgICAgICAgICAgICAgICAgICAgIC8qIFJlYWQgdGhlIGFzLWVuY29kZWQgc3Bhbiwgd2hpY2ggaXMgbm90IG5lY2Vzc2FyaWx5IHRoZQoJCSAgICAgICAgICAgICAgICAgICAgICAgICAqIHNhbWUgYXMgd2hhdCB3ZSB3cm90ZS4gKi8KCQkgICAgICAgICAgICAgICAgICAgICAgICBzcGFuID0gZmQuZ2V0U3BhbihiLCBvZmZzZXQpOwoJCSAgICAgICAgICAgICAgICAgICAgfQoJCSAgICAgICAgICAgICAgICB9CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgICAgIGxhc3RPZmZzZXQgPSBvZmZzZXQ7CgkJICAgICAgICAgICAgb2Zmc2V0ICs9IHNwYW47CgkJICAgICAgICB9CgkJICAgICAgICAvKiBVc2UgKGxhc3RPZmZzZXQgKyBsYXN0V3JvdGUpIGluc3RlYWQgb2Ygb2Zmc2V0IGJlY2F1c2UgdGhlIGxhc3QKCQkgICAgICAgICAqIGl0ZW0gbWF5IGhhdmUgaGFkIGEgZHluYW1pYyBsZW5ndGggYW5kIHdlIGRvbid0IHdhbnQgdG8gaW5jbHVkZQoJCSAgICAgICAgICogdGhlIHBhZGRpbmcgYmV0d2VlbiBpdCBhbmQgdGhlIGVuZCBvZiB0aGUgc3BhY2UgcmVzZXJ2ZWQgZm9yCgkJICAgICAgICAgKiBpdC4gKi8KCQkgICAgICAgIHJldHVybiAobGFzdE9mZnNldCArIGxhc3RXcm90ZSkgLSBmaXJzdE9mZnNldDsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGZyb21BcnJheSh2YWx1ZXMpIHsKCQkgICAgICAgIGNvbnN0IGRlc3QgPSB0aGlzLm1ha2VEZXN0aW5hdGlvbk9iamVjdCgpOwoJCSAgICAgICAgZm9yIChjb25zdCBmZCBvZiB0aGlzLmZpZWxkcykgewoJCSAgICAgICAgICAgIGlmICgodW5kZWZpbmVkICE9PSBmZC5wcm9wZXJ0eSkKCQkgICAgICAgICAgICAgICAgJiYgKDAgPCB2YWx1ZXMubGVuZ3RoKSkgewoJCSAgICAgICAgICAgICAgICBkZXN0W2ZkLnByb3BlcnR5XSA9IHZhbHVlcy5zaGlmdCgpOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiBkZXN0OwoJCSAgICB9CgkJICAgIC8qKgoJCSAgICAgKiBHZXQgYWNjZXNzIHRvIHRoZSBsYXlvdXQgb2YgYSBnaXZlbiBwcm9wZXJ0eS4KCQkgICAgICoKCQkgICAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IC0gdGhlIHN0cnVjdHVyZSBtZW1iZXIgb2YgaW50ZXJlc3QuCgkJICAgICAqCgkJICAgICAqIEByZXR1cm4ge0xheW91dH0gLSB0aGUgbGF5b3V0IGFzc29jaWF0ZWQgd2l0aCBgcHJvcGVydHlgLCBvcgoJCSAgICAgKiB1bmRlZmluZWQgaWYgdGhlcmUgaXMgbm8gc3VjaCBwcm9wZXJ0eS4KCQkgICAgICovCgkJICAgIGxheW91dEZvcihwcm9wZXJ0eSkgewoJCSAgICAgICAgaWYgKCdzdHJpbmcnICE9PSB0eXBlb2YgcHJvcGVydHkpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdwcm9wZXJ0eSBtdXN0IGJlIHN0cmluZycpOwoJCSAgICAgICAgfQoJCSAgICAgICAgZm9yIChjb25zdCBmZCBvZiB0aGlzLmZpZWxkcykgewoJCSAgICAgICAgICAgIGlmIChmZC5wcm9wZXJ0eSA9PT0gcHJvcGVydHkpIHsKCQkgICAgICAgICAgICAgICAgcmV0dXJuIGZkOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkJICAgIH0KCQkgICAgLyoqCgkJICAgICAqIEdldCB0aGUgb2Zmc2V0IG9mIGEgc3RydWN0dXJlIG1lbWJlci4KCQkgICAgICoKCQkgICAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IC0gdGhlIHN0cnVjdHVyZSBtZW1iZXIgb2YgaW50ZXJlc3QuCgkJICAgICAqCgkJICAgICAqIEByZXR1cm4ge051bWJlcn0gLSB0aGUgb2Zmc2V0IGluIGJ5dGVzIHRvIHRoZSBzdGFydCBvZiBgcHJvcGVydHlgCgkJICAgICAqIHdpdGhpbiB0aGUgc3RydWN0dXJlLCBvciB1bmRlZmluZWQgaWYgYHByb3BlcnR5YCBpcyBub3QgYSBmaWVsZAoJCSAgICAgKiB3aXRoaW4gdGhlIHN0cnVjdHVyZS4gIElmIHRoZSBwcm9wZXJ0eSBpcyBhIG1lbWJlciBidXQgZm9sbG93cyBhCgkJICAgICAqIHZhcmlhYmxlLWxlbmd0aCBzdHJ1Y3R1cmUgbWVtYmVyIGEgbmVnYXRpdmUgbnVtYmVyIHdpbGwgYmUKCQkgICAgICogcmV0dXJuZWQuCgkJICAgICAqLwoJCSAgICBvZmZzZXRPZihwcm9wZXJ0eSkgewoJCSAgICAgICAgaWYgKCdzdHJpbmcnICE9PSB0eXBlb2YgcHJvcGVydHkpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdwcm9wZXJ0eSBtdXN0IGJlIHN0cmluZycpOwoJCSAgICAgICAgfQoJCSAgICAgICAgbGV0IG9mZnNldCA9IDA7CgkJICAgICAgICBmb3IgKGNvbnN0IGZkIG9mIHRoaXMuZmllbGRzKSB7CgkJICAgICAgICAgICAgaWYgKGZkLnByb3BlcnR5ID09PSBwcm9wZXJ0eSkgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gb2Zmc2V0OwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgICAgICBpZiAoMCA+IGZkLnNwYW4pIHsKCQkgICAgICAgICAgICAgICAgb2Zmc2V0ID0gLTE7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgICAgIGVsc2UgaWYgKDAgPD0gb2Zmc2V0KSB7CgkJICAgICAgICAgICAgICAgIG9mZnNldCArPSBmZC5zcGFuOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkJICAgIH0KCQl9CgkJTGF5b3V0LlN0cnVjdHVyZSA9IFN0cnVjdHVyZTsKCQkvKioKCQkgKiBBbiBvYmplY3QgdGhhdCBjYW4gcHJvdmlkZSBhIHtAbGluawoJCSAqIFVuaW9uI2Rpc2NyaW1pbmF0b3J8ZGlzY3JpbWluYXRvcn0gQVBJIGZvciB7QGxpbmsgVW5pb259LgoJCSAqCgkJICogKipOT1RFKiogVGhpcyBpcyBhbiBhYnN0cmFjdCBiYXNlIGNsYXNzOyB5b3UgY2FuIGNyZWF0ZSBpbnN0YW5jZXMKCQkgKiBpZiBpdCBhbXVzZXMgeW91LCBidXQgdGhleSB3b24ndCBzdXBwb3J0IHRoZSB7QGxpbmsKCQkgKiBVbmlvbkRpc2NyaW1pbmF0b3IjZW5jb2RlfGVuY29kZX0gb3Ige0BsaW5rCgkJICogVW5pb25EaXNjcmltaW5hdG9yI2RlY29kZXxkZWNvZGV9IGZ1bmN0aW9ucy4KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gRGVmYXVsdCBmb3Ige0BsaW5rCgkJICogVW5pb25EaXNjcmltaW5hdG9yI3Byb3BlcnR5fHByb3BlcnR5fS4KCQkgKgoJCSAqIEBhYnN0cmFjdAoJCSAqLwoJCWNsYXNzIFVuaW9uRGlzY3JpbWluYXRvciB7CgkJICAgIGNvbnN0cnVjdG9yKHByb3BlcnR5KSB7CgkJICAgICAgICAvKiogVGhlIHtAbGluayBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9IHRvIGJlIHVzZWQgd2hlbiB0aGUKCQkgICAgICAgICAqIGRpc2NyaW1pbmF0b3IgaXMgcmVmZXJlbmNlZCBpbiBpc29sYXRpb24gKGdlbmVyYWxseSB3aGVuIHtAbGluawoJCSAgICAgICAgICogVW5pb24jZGVjb2RlfFVuaW9uIGRlY29kZX0gY2Fubm90IGRlbGVnYXRlIHRvIGEgc3BlY2lmaWMKCQkgICAgICAgICAqIHZhcmlhbnQpLiAqLwoJCSAgICAgICAgdGhpcy5wcm9wZXJ0eSA9IHByb3BlcnR5OwoJCSAgICB9CgkJICAgIC8qKiBBbmFsb2cgdG8ge0BsaW5rIExheW91dCNkZWNvZGV8TGF5b3V0IGRlY29kZX0gZm9yIHVuaW9uIGRpc2NyaW1pbmF0b3JzLgoJCSAgICAgKgoJCSAgICAgKiBUaGUgaW1wbGVtZW50YXRpb24gb2YgdGhpcyBtZXRob2QgbmVlZCBub3QgcmVmZXJlbmNlIHRoZSBidWZmZXIgaWYKCQkgICAgICogdmFyaWFudCBpbmZvcm1hdGlvbiBpcyBhdmFpbGFibGUgdGhyb3VnaCBvdGhlciBtZWFucy4gKi8KCQkgICAgZGVjb2RlKGIsIG9mZnNldCkgewoJCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmlvbkRpc2NyaW1pbmF0b3IgaXMgYWJzdHJhY3QnKTsKCQkgICAgfQoJCSAgICAvKiogQW5hbG9nIHRvIHtAbGluayBMYXlvdXQjZGVjb2RlfExheW91dCBlbmNvZGV9IGZvciB1bmlvbiBkaXNjcmltaW5hdG9ycy4KCQkgICAgICoKCQkgICAgICogVGhlIGltcGxlbWVudGF0aW9uIG9mIHRoaXMgbWV0aG9kIG5lZWQgbm90IHN0b3JlIHRoZSB2YWx1ZSBpZgoJCSAgICAgKiB2YXJpYW50IGluZm9ybWF0aW9uIGlzIG1haW50YWluZWQgdGhyb3VnaCBvdGhlciBtZWFucy4gKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0KSB7CgkJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuaW9uRGlzY3JpbWluYXRvciBpcyBhYnN0cmFjdCcpOwoJCSAgICB9CgkJfQoJCUxheW91dC5VbmlvbkRpc2NyaW1pbmF0b3IgPSBVbmlvbkRpc2NyaW1pbmF0b3I7CgkJLyoqCgkJICogQW4gb2JqZWN0IHRoYXQgY2FuIHByb3ZpZGUgYSB7QGxpbmsKCQkgKiBVbmlvbkRpc2NyaW1pbmF0b3J8ZGlzY3JpbWluYXRvciBBUEl9IGZvciB7QGxpbmsgVW5pb259IHVzaW5nIGFuCgkJICogdW5zaWduZWQgaW50ZWdyYWwge0BsaW5rIExheW91dH0gaW5zdGFuY2UgbG9jYXRlZCBlaXRoZXIgaW5zaWRlIG9yCgkJICogb3V0c2lkZSB0aGUgdW5pb24uCgkJICoKCQkgKiBAcGFyYW0ge0V4dGVybmFsTGF5b3V0fSBsYXlvdXQgLSBpbml0aWFsaXplcyB7QGxpbmsKCQkgKiBVbmlvbkxheW91dERpc2NyaW1pbmF0b3IjbGF5b3V0fGxheW91dH0uICBNdXN0IHNhdGlzZnkge0BsaW5rCgkJICogRXh0ZXJuYWxMYXlvdXQjaXNDb3VudHxpc0NvdW50KCl9LgoJCSAqCgkJICogQHBhcmFtIHtzdHJpbmd9IFtwcm9wZXJ0eV0gLSBEZWZhdWx0IGZvciB7QGxpbmsKCQkgKiBVbmlvbkRpc2NyaW1pbmF0b3IjcHJvcGVydHl8cHJvcGVydHl9LCBzdXBlcnNlZGluZyB0aGUgcHJvcGVydHkKCQkgKiBmcm9tIGBsYXlvdXRgLCBidXQgZGVmYXVsdGluZyB0byBgdmFyaWFudGAgaWYgbmVpdGhlciBgcHJvcGVydHlgCgkJICogbm9yIGxheW91dCBwcm92aWRlIGEgcHJvcGVydHkgbmFtZS4KCQkgKgoJCSAqIEBhdWdtZW50cyB7VW5pb25EaXNjcmltaW5hdG9yfQoJCSAqLwoJCWNsYXNzIFVuaW9uTGF5b3V0RGlzY3JpbWluYXRvciBleHRlbmRzIFVuaW9uRGlzY3JpbWluYXRvciB7CgkJICAgIGNvbnN0cnVjdG9yKGxheW91dCwgcHJvcGVydHkpIHsKCQkgICAgICAgIGlmICghKChsYXlvdXQgaW5zdGFuY2VvZiBFeHRlcm5hbExheW91dCkKCQkgICAgICAgICAgICAmJiBsYXlvdXQuaXNDb3VudCgpKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2xheW91dCBtdXN0IGJlIGFuIHVuc2lnbmVkIGludGVnZXIgRXh0ZXJuYWxMYXlvdXQnKTsKCQkgICAgICAgIH0KCQkgICAgICAgIHN1cGVyKHByb3BlcnR5IHx8IGxheW91dC5wcm9wZXJ0eSB8fCAndmFyaWFudCcpOwoJCSAgICAgICAgLyoqIFRoZSB7QGxpbmsgRXh0ZXJuYWxMYXlvdXR9IHVzZWQgdG8gYWNjZXNzIHRoZSBkaXNjcmltaW5hdG9yCgkJICAgICAgICAgKiB2YWx1ZS4gKi8KCQkgICAgICAgIHRoaXMubGF5b3V0ID0gbGF5b3V0OwoJCSAgICB9CgkJICAgIC8qKiBEZWxlZ2F0ZSBkZWNvZGluZyB0byB7QGxpbmsgVW5pb25MYXlvdXREaXNjcmltaW5hdG9yI2xheW91dHxsYXlvdXR9LiAqLwoJCSAgICBkZWNvZGUoYiwgb2Zmc2V0KSB7CgkJICAgICAgICByZXR1cm4gdGhpcy5sYXlvdXQuZGVjb2RlKGIsIG9mZnNldCk7CgkJICAgIH0KCQkgICAgLyoqIERlbGVnYXRlIGVuY29kaW5nIHRvIHtAbGluayBVbmlvbkxheW91dERpc2NyaW1pbmF0b3IjbGF5b3V0fGxheW91dH0uICovCgkJICAgIGVuY29kZShzcmMsIGIsIG9mZnNldCkgewoJCSAgICAgICAgcmV0dXJuIHRoaXMubGF5b3V0LmVuY29kZShzcmMsIGIsIG9mZnNldCk7CgkJICAgIH0KCQl9CgkJTGF5b3V0LlVuaW9uTGF5b3V0RGlzY3JpbWluYXRvciA9IFVuaW9uTGF5b3V0RGlzY3JpbWluYXRvcjsKCQkvKioKCQkgKiBSZXByZXNlbnQgYW55IG51bWJlciBvZiBzcGFuLWNvbXBhdGlibGUgbGF5b3V0cy4KCQkgKgoJCSAqICpGYWN0b3J5Kjoge0BsaW5rIG1vZHVsZTpMYXlvdXQudW5pb258dW5pb259CgkJICoKCQkgKiBJZiB0aGUgdW5pb24gaGFzIGEge0BsaW5rIFVuaW9uI2RlZmF1bHRMYXlvdXR8ZGVmYXVsdCBsYXlvdXR9IHRoYXQKCQkgKiBsYXlvdXQgbXVzdCBoYXZlIGEgbm9uLW5lZ2F0aXZlIHtAbGluayBMYXlvdXQjc3BhbnxzcGFufS4gIFRoZSBzcGFuCgkJICogb2YgYSBmaXhlZC1zcGFuIHVuaW9uIGluY2x1ZGVzIGl0cyB7QGxpbmsKCQkgKiBVbmlvbiNkaXNjcmltaW5hdG9yfGRpc2NyaW1pbmF0b3J9IGlmIHRoZSB2YXJpYW50IGlzIGEge0BsaW5rCgkJICogVW5pb24jdXNlc1ByZWZpeERpc2NyaW1pbmF0b3J8cHJlZml4IG9mIHRoZSB1bmlvbn0sIHBsdXMgdGhlIHNwYW4KCQkgKiBvZiBpdHMge0BsaW5rIFVuaW9uI2RlZmF1bHRMYXlvdXR8ZGVmYXVsdCBsYXlvdXR9LgoJCSAqCgkJICogSWYgdGhlIHVuaW9uIGRvZXMgbm90IGhhdmUgYSBkZWZhdWx0IGxheW91dCB0aGVuIHRoZSBlbmNvZGVkIHNwYW4KCQkgKiBvZiB0aGUgdW5pb24gZGVwZW5kcyBvbiB0aGUgZW5jb2RlZCBzcGFuIG9mIGl0cyB2YXJpYW50ICh3aGljaCBtYXkKCQkgKiBiZSBmaXhlZCBvciB2YXJpYWJsZSkuCgkJICoKCQkgKiB7QGxpbmsgVmFyaWFudExheW91dCNsYXlvdXR8VmFyaWFudCBsYXlvdXR9cyBhcmUgYWRkZWQgdGhyb3VnaAoJCSAqIHtAbGluayBVbmlvbiNhZGRWYXJpYW50fGFkZFZhcmlhbnR9LiAgSWYgdGhlIHVuaW9uIGhhcyBhIGRlZmF1bHQKCQkgKiBsYXlvdXQsIHRoZSBzcGFuIG9mIHRoZSB7QGxpbmsgVmFyaWFudExheW91dCNsYXlvdXR8bGF5b3V0CgkJICogY29udGFpbmVkIGJ5IHRoZSB2YXJpYW50fSBtdXN0IG5vdCBleGNlZWQgdGhlIHNwYW4gb2YgdGhlIHtAbGluawoJCSAqIFVuaW9uI2RlZmF1bHRMYXlvdXR8ZGVmYXVsdCBsYXlvdXR9IChtaW51cyB0aGUgc3BhbiBvZiBhIHtAbGluawoJCSAqIFVuaW9uI3VzZXNQcmVmaXhEaXNjcmltaW5hdG9yfHByZWZpeCBkaXNyaW1pbmF0b3J9LCBpZiB1c2VkKS4gIFRoZQoJCSAqIHNwYW4gb2YgdGhlIHZhcmlhbnQgd2lsbCBlcXVhbCB0aGUgc3BhbiBvZiB0aGUgdW5pb24gaXRzZWxmLgoJCSAqCgkJICogVGhlIHZhcmlhbnQgZm9yIGEgYnVmZmVyIGNhbiBvbmx5IGJlIGlkZW50aWZpZWQgZnJvbSB0aGUge0BsaW5rCgkJICogVW5pb24jZGlzY3JpbWluYXRvcnxkaXNjcmltaW5hdG9yfSB7QGxpbmsKCQkgKiBVbmlvbkRpc2NyaW1pbmF0b3IjcHJvcGVydHl8cHJvcGVydHl9IChpbiB0aGUgY2FzZSBvZiB0aGUge0BsaW5rCgkJICogVW5pb24jZGVmYXVsdExheW91dHxkZWZhdWx0IGxheW91dH0pLCBvciBieSB1c2luZyB7QGxpbmsKCQkgKiBVbmlvbiNnZXRWYXJpYW50fGdldFZhcmlhbnR9IGFuZCBleGFtaW5pbmcgdGhlIHJlc3VsdGluZyB7QGxpbmsKCQkgKiBWYXJpYW50TGF5b3V0fSBpbnN0YW5jZS4KCQkgKgoJCSAqIEEgdmFyaWFudCBjb21wYXRpYmxlIHdpdGggYSBKYXZhU2NyaXB0IG9iamVjdCBjYW4gYmUgaWRlbnRpZmllZAoJCSAqIHVzaW5nIHtAbGluayBVbmlvbiNnZXRTb3VyY2VWYXJpYW50fGdldFNvdXJjZVZhcmlhbnR9LgoJCSAqCgkJICogQHBhcmFtIHsoVW5pb25EaXNjcmltaW5hdG9yfEV4dGVybmFsTGF5b3V0fExheW91dCl9IGRpc2NyIC0gSG93IHRvCgkJICogaWRlbnRpZnkgdGhlIGxheW91dCB1c2VkIHRvIGludGVycHJldCB0aGUgdW5pb24gY29udGVudHMuICBUaGUKCQkgKiBwYXJhbWV0ZXIgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgVW5pb25EaXNjcmltaW5hdG9yfSwgYW4KCQkgKiB7QGxpbmsgRXh0ZXJuYWxMYXlvdXR9IHRoYXQgc2F0aXNmaWVzIHtAbGluawoJCSAqIEV4dGVybmFsTGF5b3V0I2lzQ291bnR8aXNDb3VudCgpfSwgb3Ige0BsaW5rIFVJbnR9IChvciB7QGxpbmsKCQkgKiBVSW50QkV9KS4gIFdoZW4gYSBub24tZXh0ZXJuYWwgbGF5b3V0IGVsZW1lbnQgaXMgcGFzc2VkIHRoZSBsYXlvdXQKCQkgKiBhcHBlYXJzIGF0IHRoZSBzdGFydCBvZiB0aGUgdW5pb24uICBJbiBhbGwgY2FzZXMgdGhlIChzeW50aGVzaXplZCkKCQkgKiB7QGxpbmsgVW5pb25EaXNjcmltaW5hdG9yfSBpbnN0YW5jZSBpcyByZWNvcmRlZCBhcyB7QGxpbmsKCQkgKiBVbmlvbiNkaXNjcmltaW5hdG9yfGRpc2NyaW1pbmF0b3J9LgoJCSAqCgkJICogQHBhcmFtIHsoTGF5b3V0fG51bGwpfSBkZWZhdWx0TGF5b3V0IC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIFVuaW9uI2RlZmF1bHRMYXlvdXR8ZGVmYXVsdExheW91dH0uICBJZiBhYnNlbnQgZGVmYXVsdHMgdG8gYG51bGxgLgoJCSAqIElmIGBudWxsYCB0aGVyZSBpcyBubyBkZWZhdWx0IGxheW91dDogdGhlIHVuaW9uIGhhcyBkYXRhLWRlcGVuZGVudAoJCSAqIGxlbmd0aCBhbmQgYXR0ZW1wdHMgdG8gZGVjb2RlIG9yIGVuY29kZSB1bnJlY29nbml6ZWQgdmFyaWFudHMgd2lsbAoJCSAqIHRocm93IGFuIGV4Y2VwdGlvbi4gIEEge0BsaW5rIExheW91dH0gaW5zdGFuY2UgbXVzdCBoYXZlIGEKCQkgKiBub24tbmVnYXRpdmUge0BsaW5rIExheW91dCNzcGFufHNwYW59LCBhbmQgaWYgaXQgbGFja3MgYSB7QGxpbmsKCQkgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9IHRoZSB7QGxpbmsKCQkgKiBVbmlvbiNkZWZhdWx0TGF5b3V0fGRlZmF1bHRMYXlvdXR9IHdpbGwgYmUgYSB7QGxpbmsKCQkgKiBMYXlvdXQjcmVwbGljYXRlfHJlcGxpY2F9IHdpdGggcHJvcGVydHkgYGNvbnRlbnRgLgoJCSAqCgkJICogQHBhcmFtIHtzdHJpbmd9IFtwcm9wZXJ0eV0gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fS4KCQkgKgoJCSAqIEBhdWdtZW50cyB7TGF5b3V0fQoJCSAqLwoJCWNsYXNzIFVuaW9uIGV4dGVuZHMgTGF5b3V0JDEgewoJCSAgICBjb25zdHJ1Y3RvcihkaXNjciwgZGVmYXVsdExheW91dCwgcHJvcGVydHkpIHsKCQkgICAgICAgIGxldCBkaXNjcmltaW5hdG9yOwoJCSAgICAgICAgaWYgKChkaXNjciBpbnN0YW5jZW9mIFVJbnQpCgkJICAgICAgICAgICAgfHwgKGRpc2NyIGluc3RhbmNlb2YgVUludEJFKSkgewoJCSAgICAgICAgICAgIGRpc2NyaW1pbmF0b3IgPSBuZXcgVW5pb25MYXlvdXREaXNjcmltaW5hdG9yKG5ldyBPZmZzZXRMYXlvdXQoZGlzY3IpKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGVsc2UgaWYgKChkaXNjciBpbnN0YW5jZW9mIEV4dGVybmFsTGF5b3V0KQoJCSAgICAgICAgICAgICYmIGRpc2NyLmlzQ291bnQoKSkgewoJCSAgICAgICAgICAgIGRpc2NyaW1pbmF0b3IgPSBuZXcgVW5pb25MYXlvdXREaXNjcmltaW5hdG9yKGRpc2NyKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGVsc2UgaWYgKCEoZGlzY3IgaW5zdGFuY2VvZiBVbmlvbkRpc2NyaW1pbmF0b3IpKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignZGlzY3IgbXVzdCBiZSBhIFVuaW9uRGlzY3JpbWluYXRvciAnCgkJICAgICAgICAgICAgICAgICsgJ29yIGFuIHVuc2lnbmVkIGludGVnZXIgbGF5b3V0Jyk7CgkJICAgICAgICB9CgkJICAgICAgICBlbHNlIHsKCQkgICAgICAgICAgICBkaXNjcmltaW5hdG9yID0gZGlzY3I7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAodW5kZWZpbmVkID09PSBkZWZhdWx0TGF5b3V0KSB7CgkJICAgICAgICAgICAgZGVmYXVsdExheW91dCA9IG51bGw7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoISgobnVsbCA9PT0gZGVmYXVsdExheW91dCkKCQkgICAgICAgICAgICB8fCAoZGVmYXVsdExheW91dCBpbnN0YW5jZW9mIExheW91dCQxKSkpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdkZWZhdWx0TGF5b3V0IG11c3QgYmUgbnVsbCBvciBhIExheW91dCcpOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKG51bGwgIT09IGRlZmF1bHRMYXlvdXQpIHsKCQkgICAgICAgICAgICBpZiAoMCA+IGRlZmF1bHRMYXlvdXQuc3BhbikgewoJCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2RlZmF1bHRMYXlvdXQgbXVzdCBoYXZlIGNvbnN0YW50IHNwYW4nKTsKCQkgICAgICAgICAgICB9CgkJICAgICAgICAgICAgaWYgKHVuZGVmaW5lZCA9PT0gZGVmYXVsdExheW91dC5wcm9wZXJ0eSkgewoJCSAgICAgICAgICAgICAgICBkZWZhdWx0TGF5b3V0ID0gZGVmYXVsdExheW91dC5yZXBsaWNhdGUoJ2NvbnRlbnQnKTsKCQkgICAgICAgICAgICB9CgkJICAgICAgICB9CgkJICAgICAgICAvKiBUaGUgdW5pb24gc3BhbiBjYW4gYmUgZXN0aW1hdGVkIG9ubHkgaWYgdGhlcmUncyBhIGRlZmF1bHQKCQkgICAgICAgICAqIGxheW91dC4gIFRoZSB1bmlvbiBzcGFucyBpdHMgZGVmYXVsdCBsYXlvdXQsIHBsdXMgYW55IHByZWZpeAoJCSAgICAgICAgICogdmFyaWFudCBsYXlvdXQuICBCeSBjb25zdHJ1Y3Rpb24gYm90aCBsYXlvdXRzLCBpZiBwcmVzZW50LCBoYXZlCgkJICAgICAgICAgKiBub24tbmVnYXRpdmUgc3Bhbi4gKi8KCQkgICAgICAgIGxldCBzcGFuID0gLTE7CgkJICAgICAgICBpZiAoZGVmYXVsdExheW91dCkgewoJCSAgICAgICAgICAgIHNwYW4gPSBkZWZhdWx0TGF5b3V0LnNwYW47CgkJICAgICAgICAgICAgaWYgKCgwIDw9IHNwYW4pICYmICgoZGlzY3IgaW5zdGFuY2VvZiBVSW50KQoJCSAgICAgICAgICAgICAgICB8fCAoZGlzY3IgaW5zdGFuY2VvZiBVSW50QkUpKSkgewoJCSAgICAgICAgICAgICAgICBzcGFuICs9IGRpc2NyaW1pbmF0b3IubGF5b3V0LnNwYW47CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgfQoJCSAgICAgICAgc3VwZXIoc3BhbiwgcHJvcGVydHkpOwoJCSAgICAgICAgLyoqIFRoZSBpbnRlcmZhY2UgZm9yIHRoZSBkaXNjcmltaW5hdG9yIHZhbHVlIGluIGlzb2xhdGlvbi4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiBUaGlzIGEge0BsaW5rIFVuaW9uRGlzY3JpbWluYXRvcn0gZWl0aGVyIHBhc3NlZCB0byB0aGUKCQkgICAgICAgICAqIGNvbnN0cnVjdG9yIG9yIHN5bnRoZXNpemVkIGZyb20gdGhlIGBkaXNjcmAgY29uc3RydWN0b3IKCQkgICAgICAgICAqIGFyZ3VtZW50LiAge0BsaW5rCgkJICAgICAgICAgKiBVbmlvbiN1c2VzUHJlZml4RGlzY3JpbWluYXRvcnx1c2VzUHJlZml4RGlzY3JpbWluYXRvcn0gd2lsbCBiZQoJCSAgICAgICAgICogYHRydWVgIGlmZiB0aGUgYGRpc2NyYCBwYXJhbWV0ZXIgd2FzIGEgbm9uLW9mZnNldCB7QGxpbmsKCQkgICAgICAgICAqIExheW91dH0gaW5zdGFuY2UuICovCgkJICAgICAgICB0aGlzLmRpc2NyaW1pbmF0b3IgPSBkaXNjcmltaW5hdG9yOwoJCSAgICAgICAgLyoqIGB0cnVlYCBpZiB0aGUge0BsaW5rIFVuaW9uI2Rpc2NyaW1pbmF0b3J8ZGlzY3JpbWluYXRvcn0gaXMgdGhlCgkJICAgICAgICAgKiBmaXJzdCBmaWVsZCBpbiB0aGUgdW5pb24uCgkJICAgICAgICAgKgoJCSAgICAgICAgICogSWYgYGZhbHNlYCB0aGUgZGlzY3JpbWluYXRvciBpcyBvYnRhaW5lZCBmcm9tIHNvbWV3aGVyZQoJCSAgICAgICAgICogZWxzZS4gKi8KCQkgICAgICAgIHRoaXMudXNlc1ByZWZpeERpc2NyaW1pbmF0b3IgPSAoZGlzY3IgaW5zdGFuY2VvZiBVSW50KQoJCSAgICAgICAgICAgIHx8IChkaXNjciBpbnN0YW5jZW9mIFVJbnRCRSk7CgkJICAgICAgICAvKiogVGhlIGxheW91dCBmb3Igbm9uLWRpc2NyaW1pbmF0b3IgY29udGVudCB3aGVuIHRoZSB2YWx1ZSBvZiB0aGUKCQkgICAgICAgICAqIGRpc2NyaW1pbmF0b3IgaXMgbm90IHJlY29nbml6ZWQuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogVGhpcyBpcyB0aGUgdmFsdWUgcGFzc2VkIHRvIHRoZSBjb25zdHJ1Y3Rvci4gIEl0IGlzCgkJICAgICAgICAgKiBzdHJ1Y3R1cmFsbHkgZXF1aXZhbGVudCB0byB0aGUgc2Vjb25kIGNvbXBvbmVudCBvZiB7QGxpbmsKCQkgICAgICAgICAqIFVuaW9uI2xheW91dHxsYXlvdXR9IGJ1dCBtYXkgaGF2ZSBhIGRpZmZlcmVudCBwcm9wZXJ0eQoJCSAgICAgICAgICogbmFtZS4gKi8KCQkgICAgICAgIHRoaXMuZGVmYXVsdExheW91dCA9IGRlZmF1bHRMYXlvdXQ7CgkJICAgICAgICAvKiogQSByZWdpc3RyeSBvZiBhbGxvd2VkIHZhcmlhbnRzLgoJCSAgICAgICAgICoKCQkgICAgICAgICAqIFRoZSBrZXlzIGFyZSB1bnNpZ25lZCBpbnRlZ2VycyB3aGljaCBzaG91bGQgYmUgY29tcGF0aWJsZSB3aXRoCgkJICAgICAgICAgKiB7QGxpbmsgVW5pb24uZGlzY3JpbWluYXRvcnxkaXNjcmltaW5hdG9yfS4gIFRoZSBwcm9wZXJ0eSB2YWx1ZQoJCSAgICAgICAgICogaXMgdGhlIGNvcnJlc3BvbmRpbmcge0BsaW5rIFZhcmlhbnRMYXlvdXR9IGluc3RhbmNlcyBhc3NpZ25lZAoJCSAgICAgICAgICogdG8gdGhpcyB1bmlvbiBieSB7QGxpbmsgVW5pb24jYWRkVmFyaWFudHxhZGRWYXJpYW50fS4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiAqKk5PVEUqKiBUaGUgcmVnaXN0cnkgcmVtYWlucyBtdXRhYmxlIHNvIHRoYXQgdmFyaWFudHMgY2FuIGJlCgkJICAgICAgICAgKiB7QGxpbmsgVW5pb24jYWRkVmFyaWFudHxhZGRlZH0gYXQgYW55IHRpbWUuICBVc2VycyBzaG91bGQgbm90CgkJICAgICAgICAgKiBtYW5pcHVsYXRlIHRoZSBjb250ZW50IG9mIHRoaXMgcHJvcGVydHkuICovCgkJICAgICAgICB0aGlzLnJlZ2lzdHJ5ID0ge307CgkJICAgICAgICAvKiBQcml2YXRlIHZhcmlhYmxlIHVzZWQgd2hlbiBpbnZva2luZyBnZXRTb3VyY2VWYXJpYW50ICovCgkJICAgICAgICBsZXQgYm91bmRHZXRTb3VyY2VWYXJpYW50ID0gdGhpcy5kZWZhdWx0R2V0U291cmNlVmFyaWFudC5iaW5kKHRoaXMpOwoJCSAgICAgICAgLyoqIEZ1bmN0aW9uIHRvIGluZmVyIHRoZSB2YXJpYW50IHNlbGVjdGVkIGJ5IGEgc291cmNlIG9iamVjdC4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiBEZWZhdWx0cyB0byB7QGxpbmsKCQkgICAgICAgICAqIFVuaW9uI2RlZmF1bHRHZXRTb3VyY2VWYXJpYW50fGRlZmF1bHRHZXRTb3VyY2VWYXJpYW50fSBidXQgbWF5CgkJICAgICAgICAgKiBiZSBvdmVycmlkZGVuIHVzaW5nIHtAbGluawoJCSAgICAgICAgICogVW5pb24jY29uZmlnR2V0U291cmNlVmFyaWFudHxjb25maWdHZXRTb3VyY2VWYXJpYW50fS4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc3JjIC0gYXMgd2l0aCB7QGxpbmsKCQkgICAgICAgICAqIFVuaW9uI2RlZmF1bHRHZXRTb3VyY2VWYXJpYW50fGRlZmF1bHRHZXRTb3VyY2VWYXJpYW50fS4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiBAcmV0dXJucyB7KHVuZGVmaW5lZHxWYXJpYW50TGF5b3V0KX0gVGhlIGRlZmF1bHQgdmFyaWFudAoJCSAgICAgICAgICogKGB1bmRlZmluZWRgKSBvciBmaXJzdCByZWdpc3RlcmVkIHZhcmlhbnQgdGhhdCB1c2VzIGEgcHJvcGVydHkKCQkgICAgICAgICAqIGF2YWlsYWJsZSBpbiBgc3JjYC4gKi8KCQkgICAgICAgIHRoaXMuZ2V0U291cmNlVmFyaWFudCA9IGZ1bmN0aW9uIChzcmMpIHsKCQkgICAgICAgICAgICByZXR1cm4gYm91bmRHZXRTb3VyY2VWYXJpYW50KHNyYyk7CgkJICAgICAgICB9OwoJCSAgICAgICAgLyoqIEZ1bmN0aW9uIHRvIG92ZXJyaWRlIHRoZSBpbXBsZW1lbnRhdGlvbiBvZiB7QGxpbmsKCQkgICAgICAgICAqIFVuaW9uI2dldFNvdXJjZVZhcmlhbnR8Z2V0U291cmNlVmFyaWFudH0uCgkJICAgICAgICAgKgoJCSAgICAgICAgICogVXNlIHRoaXMgaWYgdGhlIGRlc2lyZWQgdmFyaWFudCBjYW5ub3QgYmUgaWRlbnRpZmllZCB1c2luZyB0aGUKCQkgICAgICAgICAqIGFsZ29yaXRobSBvZiB7QGxpbmsKCQkgICAgICAgICAqIFVuaW9uI2RlZmF1bHRHZXRTb3VyY2VWYXJpYW50fGRlZmF1bHRHZXRTb3VyY2VWYXJpYW50fS4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiAqKk5PVEUqKiBUaGUgcHJvdmlkZWQgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIGJvdW5kIHRvIHRoaXMKCQkgICAgICAgICAqIFVuaW9uIGluc3RhbmNlLCBwcm92aWRpbmcgbG9jYWwgYWNjZXNzIHRvIHtAbGluawoJCSAgICAgICAgICogVW5pb24jcmVnaXN0cnl8cmVnaXN0cnl9LgoJCSAgICAgICAgICoKCQkgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGdzdiAtIGEgZnVuY3Rpb24gdGhhdCBmb2xsb3dzIHRoZSBBUEkgb2YKCQkgICAgICAgICAqIHtAbGluayBVbmlvbiNkZWZhdWx0R2V0U291cmNlVmFyaWFudHxkZWZhdWx0R2V0U291cmNlVmFyaWFudH0uICovCgkJICAgICAgICB0aGlzLmNvbmZpZ0dldFNvdXJjZVZhcmlhbnQgPSBmdW5jdGlvbiAoZ3N2KSB7CgkJICAgICAgICAgICAgYm91bmRHZXRTb3VyY2VWYXJpYW50ID0gZ3N2LmJpbmQodGhpcyk7CgkJICAgICAgICB9OwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZ2V0U3BhbihiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBpZiAoMCA8PSB0aGlzLnNwYW4pIHsKCQkgICAgICAgICAgICByZXR1cm4gdGhpcy5zcGFuOwoJCSAgICAgICAgfQoJCSAgICAgICAgLyogRGVmYXVsdCBsYXlvdXRzIGFsd2F5cyBoYXZlIG5vbi1uZWdhdGl2ZSBzcGFuLCBzbyB3ZSBkb24ndCBoYXZlCgkJICAgICAgICAgKiBvbmUgYW5kIHdlIGhhdmUgdG8gcmVjb2duaXplIHRoZSB2YXJpYW50IHdoaWNoIHdpbGwgaW4gdHVybgoJCSAgICAgICAgICogZGV0ZXJtaW5lIHRoZSBzcGFuLiAqLwoJCSAgICAgICAgY29uc3QgdmxvID0gdGhpcy5nZXRWYXJpYW50KGIsIG9mZnNldCk7CgkJICAgICAgICBpZiAoIXZsbykgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndW5hYmxlIHRvIGRldGVybWluZSBzcGFuIGZvciB1bnJlY29nbml6ZWQgdmFyaWFudCcpOwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHZsby5nZXRTcGFuKGIsIG9mZnNldCk7CgkJICAgIH0KCQkgICAgLyoqCgkJICAgICAqIE1ldGhvZCB0byBpbmZlciBhIHJlZ2lzdGVyZWQgVW5pb24gdmFyaWFudCBjb21wYXRpYmxlIHdpdGggYHNyY2AuCgkJICAgICAqCgkJICAgICAqIFRoZSBmaXJzdCBzYXRpc2ZpZWQgcnVsZSBpbiB0aGUgZm9sbG93aW5nIHNlcXVlbmNlIGRlZmluZXMgdGhlCgkJICAgICAqIHJldHVybiB2YWx1ZToKCQkgICAgICogKiBJZiBgc3JjYCBoYXMgcHJvcGVydGllcyBtYXRjaGluZyB0aGUgVW5pb24gZGlzY3JpbWluYXRvciBhbmQKCQkgICAgICogICB0aGUgZGVmYXVsdCBsYXlvdXQsIGB1bmRlZmluZWRgIGlzIHJldHVybmVkIHJlZ2FyZGxlc3Mgb2YgdGhlCgkJICAgICAqICAgdmFsdWUgb2YgdGhlIGRpc2NyaW1pbmF0b3IgcHJvcGVydHkgKHRoaXMgZW5zdXJlcyB0aGUgZGVmYXVsdAoJCSAgICAgKiAgIGxheW91dCB3aWxsIGJlIHVzZWQpOwoJCSAgICAgKiAqIElmIGBzcmNgIGhhcyBhIHByb3BlcnR5IG1hdGNoaW5nIHRoZSBVbmlvbiBkaXNjcmltaW5hdG9yLCB0aGUKCQkgICAgICogICB2YWx1ZSBvZiB0aGUgZGlzY3JpbWluYXRvciBpZGVudGlmaWVzIGEgcmVnaXN0ZXJlZCB2YXJpYW50LCBhbmQKCQkgICAgICogICBlaXRoZXIgKGEpIHRoZSB2YXJpYW50IGhhcyBubyBsYXlvdXQsIG9yIChiKSBgc3JjYCBoYXMgdGhlCgkJICAgICAqICAgdmFyaWFudCdzIHByb3BlcnR5LCB0aGVuIHRoZSB2YXJpYW50IGlzIHJldHVybmVkIChiZWNhdXNlIHRoZQoJCSAgICAgKiAgIHNvdXJjZSBzYXRpc2ZpZXMgdGhlIGNvbnN0cmFpbnRzIG9mIHRoZSB2YXJpYW50IGl0IGlkZW50aWZpZXMpOwoJCSAgICAgKiAqIElmIGBzcmNgIGRvZXMgbm90IGhhdmUgYSBwcm9wZXJ0eSBtYXRjaGluZyB0aGUgVW5pb24KCQkgICAgICogICBkaXNjcmltaW5hdG9yLCBidXQgZG9lcyBoYXZlIGEgcHJvcGVydHkgbWF0Y2hpbmcgYSByZWdpc3RlcmVkCgkJICAgICAqICAgdmFyaWFudCwgdGhlbiB0aGUgdmFyaWFudCBpcyByZXR1cm5lZCAoYmVjYXVzZSB0aGUgc291cmNlCgkJICAgICAqICAgbWF0Y2hlcyBhIHZhcmlhbnQgd2l0aG91dCBhbiBleHBsaWNpdCBjb25mbGljdCk7CgkJICAgICAqICogQW4gZXJyb3IgaXMgdGhyb3duIChiZWNhdXNlIHdlIGVpdGhlciBjYW4ndCBpZGVudGlmeSBhIHZhcmlhbnQsCgkJICAgICAqICAgb3Igd2Ugd2VyZSBleHBsaWNpdGx5IHRvbGQgdGhlIHZhcmlhbnQgYnV0IGNhbid0IHNhdGlzZnkgaXQpLgoJCSAgICAgKgoJCSAgICAgKiBAcGFyYW0ge09iamVjdH0gc3JjIC0gYW4gb2JqZWN0IHByZXN1bWVkIHRvIGJlIGNvbXBhdGlibGUgd2l0aAoJCSAgICAgKiB0aGUgY29udGVudCBvZiB0aGUgVW5pb24uCgkJICAgICAqCgkJICAgICAqIEByZXR1cm4geyh1bmRlZmluZWR8VmFyaWFudExheW91dCl9IC0gYXMgZGVzY3JpYmVkIGFib3ZlLgoJCSAgICAgKgoJCSAgICAgKiBAdGhyb3dzIHtFcnJvcn0gLSBpZiBgc3JjYCBjYW5ub3QgYmUgYXNzb2NpYXRlZCB3aXRoIGEgZGVmYXVsdCBvcgoJCSAgICAgKiByZWdpc3RlcmVkIHZhcmlhbnQuCgkJICAgICAqLwoJCSAgICBkZWZhdWx0R2V0U291cmNlVmFyaWFudChzcmMpIHsKCQkgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3JjLCB0aGlzLmRpc2NyaW1pbmF0b3IucHJvcGVydHkpKSB7CgkJICAgICAgICAgICAgaWYgKHRoaXMuZGVmYXVsdExheW91dCAmJiB0aGlzLmRlZmF1bHRMYXlvdXQucHJvcGVydHkKCQkgICAgICAgICAgICAgICAgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNyYywgdGhpcy5kZWZhdWx0TGF5b3V0LnByb3BlcnR5KSkgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgICAgICBjb25zdCB2bG8gPSB0aGlzLnJlZ2lzdHJ5W3NyY1t0aGlzLmRpc2NyaW1pbmF0b3IucHJvcGVydHldXTsKCQkgICAgICAgICAgICBpZiAodmxvCgkJICAgICAgICAgICAgICAgICYmICgoIXZsby5sYXlvdXQpCgkJICAgICAgICAgICAgICAgICAgICB8fCAodmxvLnByb3BlcnR5ICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzcmMsIHZsby5wcm9wZXJ0eSkpKSkgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gdmxvOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgIH0KCQkgICAgICAgIGVsc2UgewoJCSAgICAgICAgICAgIGZvciAoY29uc3QgdGFnIGluIHRoaXMucmVnaXN0cnkpIHsKCQkgICAgICAgICAgICAgICAgY29uc3QgdmxvID0gdGhpcy5yZWdpc3RyeVt0YWddOwoJCSAgICAgICAgICAgICAgICBpZiAodmxvLnByb3BlcnR5ICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzcmMsIHZsby5wcm9wZXJ0eSkpIHsKCQkgICAgICAgICAgICAgICAgICAgIHJldHVybiB2bG87CgkJICAgICAgICAgICAgICAgIH0KCQkgICAgICAgICAgICB9CgkJICAgICAgICB9CgkJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3VuYWJsZSB0byBpbmZlciBzcmMgdmFyaWFudCcpOwoJCSAgICB9CgkJICAgIC8qKiBJbXBsZW1lbnQge0BsaW5rIExheW91dCNkZWNvZGV8ZGVjb2RlfSBmb3Ige0BsaW5rIFVuaW9ufS4KCQkgICAgICoKCQkgICAgICogSWYgdGhlIHZhcmlhbnQgaXMge0BsaW5rIFVuaW9uI2FkZFZhcmlhbnR8cmVnaXN0ZXJlZH0gdGhlIHJldHVybgoJCSAgICAgKiB2YWx1ZSBpcyBhbiBpbnN0YW5jZSBvZiB0aGF0IHZhcmlhbnQsIHdpdGggbm8gZXhwbGljaXQKCQkgICAgICogZGlzY3JpbWluYXRvci4gIE90aGVyd2lzZSB0aGUge0BsaW5rIFVuaW9uI2RlZmF1bHRMYXlvdXR8ZGVmYXVsdAoJCSAgICAgKiBsYXlvdXR9IGlzIHVzZWQgdG8gZGVjb2RlIHRoZSBjb250ZW50LiAqLwoJCSAgICBkZWNvZGUoYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgbGV0IGRlc3Q7CgkJICAgICAgICBjb25zdCBkbG8gPSB0aGlzLmRpc2NyaW1pbmF0b3I7CgkJICAgICAgICBjb25zdCBkaXNjciA9IGRsby5kZWNvZGUoYiwgb2Zmc2V0KTsKCQkgICAgICAgIGNvbnN0IGNsbyA9IHRoaXMucmVnaXN0cnlbZGlzY3JdOwoJCSAgICAgICAgaWYgKHVuZGVmaW5lZCA9PT0gY2xvKSB7CgkJICAgICAgICAgICAgY29uc3QgZGVmYXVsdExheW91dCA9IHRoaXMuZGVmYXVsdExheW91dDsKCQkgICAgICAgICAgICBsZXQgY29udGVudE9mZnNldCA9IDA7CgkJICAgICAgICAgICAgaWYgKHRoaXMudXNlc1ByZWZpeERpc2NyaW1pbmF0b3IpIHsKCQkgICAgICAgICAgICAgICAgY29udGVudE9mZnNldCA9IGRsby5sYXlvdXQuc3BhbjsKCQkgICAgICAgICAgICB9CgkJICAgICAgICAgICAgZGVzdCA9IHRoaXMubWFrZURlc3RpbmF0aW9uT2JqZWN0KCk7CgkJICAgICAgICAgICAgZGVzdFtkbG8ucHJvcGVydHldID0gZGlzY3I7CgkJICAgICAgICAgICAgLy8gZGVmYXVsdExheW91dC5wcm9wZXJ0eSBjYW4gYmUgdW5kZWZpbmVkLCBidXQgdGhpcyBpcyBhbGxvd2VkIGJ5IGJ1ZmZlci1sYXlvdXQKCQkgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvbgoJCSAgICAgICAgICAgIGRlc3RbZGVmYXVsdExheW91dC5wcm9wZXJ0eV0gPSBkZWZhdWx0TGF5b3V0LmRlY29kZShiLCBvZmZzZXQgKyBjb250ZW50T2Zmc2V0KTsKCQkgICAgICAgIH0KCQkgICAgICAgIGVsc2UgewoJCSAgICAgICAgICAgIGRlc3QgPSBjbG8uZGVjb2RlKGIsIG9mZnNldCk7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gZGVzdDsKCQkgICAgfQoJCSAgICAvKiogSW1wbGVtZW50IHtAbGluayBMYXlvdXQjZW5jb2RlfGVuY29kZX0gZm9yIHtAbGluayBVbmlvbn0uCgkJICAgICAqCgkJICAgICAqIFRoaXMgQVBJIGFzc3VtZXMgdGhlIGBzcmNgIG9iamVjdCBpcyBjb25zaXN0ZW50IHdpdGggdGhlIHVuaW9uJ3MKCQkgICAgICoge0BsaW5rIFVuaW9uI2RlZmF1bHRMYXlvdXR8ZGVmYXVsdCBsYXlvdXR9LiAgVG8gZW5jb2RlIHZhcmlhbnRzCgkJICAgICAqIHVzZSB0aGUgYXBwcm9wcmlhdGUgdmFyaWFudC1zcGVjaWZpYyB7QGxpbmsgVmFyaWFudExheW91dCNlbmNvZGV9CgkJICAgICAqIG1ldGhvZC4gKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3QgdmxvID0gdGhpcy5nZXRTb3VyY2VWYXJpYW50KHNyYyk7CgkJICAgICAgICBpZiAodW5kZWZpbmVkID09PSB2bG8pIHsKCQkgICAgICAgICAgICBjb25zdCBkbG8gPSB0aGlzLmRpc2NyaW1pbmF0b3I7CgkJICAgICAgICAgICAgLy8gdGhpcy5kZWZhdWx0TGF5b3V0IGlzIG5vdCB1bmRlZmluZWQgd2hlbiB2bG8gaXMgdW5kZWZpbmVkCgkJICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb24KCQkgICAgICAgICAgICBjb25zdCBjbG8gPSB0aGlzLmRlZmF1bHRMYXlvdXQ7CgkJICAgICAgICAgICAgbGV0IGNvbnRlbnRPZmZzZXQgPSAwOwoJCSAgICAgICAgICAgIGlmICh0aGlzLnVzZXNQcmVmaXhEaXNjcmltaW5hdG9yKSB7CgkJICAgICAgICAgICAgICAgIGNvbnRlbnRPZmZzZXQgPSBkbG8ubGF5b3V0LnNwYW47CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgICAgIGRsby5lbmNvZGUoc3JjW2Rsby5wcm9wZXJ0eV0sIGIsIG9mZnNldCk7CgkJICAgICAgICAgICAgLy8gY2xvLnByb3BlcnR5IGlzIG5vdCB1bmRlZmluZWQgd2hlbiB2bG8gaXMgdW5kZWZpbmVkCgkJICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb24KCQkgICAgICAgICAgICByZXR1cm4gY29udGVudE9mZnNldCArIGNsby5lbmNvZGUoc3JjW2Nsby5wcm9wZXJ0eV0sIGIsIG9mZnNldCArIGNvbnRlbnRPZmZzZXQpOwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHZsby5lbmNvZGUoc3JjLCBiLCBvZmZzZXQpOwoJCSAgICB9CgkJICAgIC8qKiBSZWdpc3RlciBhIG5ldyB2YXJpYW50IHN0cnVjdHVyZSB3aXRoaW4gYSB1bmlvbi4gIFRoZSBuZXdseQoJCSAgICAgKiBjcmVhdGVkIHZhcmlhbnQgaXMgcmV0dXJuZWQuCgkJICAgICAqCgkJICAgICAqIEBwYXJhbSB7TnVtYmVyfSB2YXJpYW50IC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAgICAgKiBWYXJpYW50TGF5b3V0I3ZhcmlhbnR8dmFyaWFudH0uCgkJICAgICAqCgkJICAgICAqIEBwYXJhbSB7TGF5b3V0fSBsYXlvdXQgLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICAgICAqIFZhcmlhbnRMYXlvdXQjbGF5b3V0fGxheW91dH0uCgkJICAgICAqCgkJICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgICAgICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fS4KCQkgICAgICoKCQkgICAgICogQHJldHVybiB7VmFyaWFudExheW91dH0gKi8KCQkgICAgYWRkVmFyaWFudCh2YXJpYW50LCBsYXlvdXQsIHByb3BlcnR5KSB7CgkJICAgICAgICBjb25zdCBydiA9IG5ldyBWYXJpYW50TGF5b3V0KHRoaXMsIHZhcmlhbnQsIGxheW91dCwgcHJvcGVydHkpOwoJCSAgICAgICAgdGhpcy5yZWdpc3RyeVt2YXJpYW50XSA9IHJ2OwoJCSAgICAgICAgcmV0dXJuIHJ2OwoJCSAgICB9CgkJICAgIC8qKgoJCSAgICAgKiBHZXQgdGhlIGxheW91dCBhc3NvY2lhdGVkIHdpdGggYSByZWdpc3RlcmVkIHZhcmlhbnQuCgkJICAgICAqCgkJICAgICAqIElmIGB2YmAgZG9lcyBub3QgcHJvZHVjZSBhIHJlZ2lzdGVyZWQgdmFyaWFudCB0aGUgZnVuY3Rpb24gcmV0dXJucwoJCSAgICAgKiBgdW5kZWZpbmVkYC4KCQkgICAgICoKCQkgICAgICogQHBhcmFtIHsoTnVtYmVyfFVpbnQ4QXJyYXkpfSB2YiAtIGVpdGhlciB0aGUgdmFyaWFudCBudW1iZXIsIG9yIGEKCQkgICAgICogYnVmZmVyIGZyb20gd2hpY2ggdGhlIGRpc2NyaW1pbmF0b3IgaXMgdG8gYmUgcmVhZC4KCQkgICAgICoKCQkgICAgICogQHBhcmFtIHtOdW1iZXJ9IG9mZnNldCAtIG9mZnNldCBpbnRvIGB2YmAgZm9yIHRoZSBzdGFydCBvZiB0aGUKCQkgICAgICogdW5pb24uICBVc2VkIG9ubHkgd2hlbiBgdmJgIGlzIGFuIGluc3RhbmNlIG9mIHtVaW50OEFycmF5fS4KCQkgICAgICoKCQkgICAgICogQHJldHVybiB7KHtWYXJpYW50TGF5b3V0fXx1bmRlZmluZWQpfQoJCSAgICAgKi8KCQkgICAgZ2V0VmFyaWFudCh2Yiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgbGV0IHZhcmlhbnQ7CgkJICAgICAgICBpZiAodmIgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CgkJICAgICAgICAgICAgdmFyaWFudCA9IHRoaXMuZGlzY3JpbWluYXRvci5kZWNvZGUodmIsIG9mZnNldCk7CgkJICAgICAgICB9CgkJICAgICAgICBlbHNlIHsKCQkgICAgICAgICAgICB2YXJpYW50ID0gdmI7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gdGhpcy5yZWdpc3RyeVt2YXJpYW50XTsKCQkgICAgfQoJCX0KCQlMYXlvdXQuVW5pb24gPSBVbmlvbjsKCQkvKioKCQkgKiBSZXByZXNlbnQgYSBzcGVjaWZpYyB2YXJpYW50IHdpdGhpbiBhIGNvbnRhaW5pbmcgdW5pb24uCgkJICoKCQkgKiAqKk5PVEUqKiBUaGUge0BsaW5rIExheW91dCNzcGFufHNwYW59IG9mIHRoZSB2YXJpYW50IG1heSBpbmNsdWRlCgkJICogdGhlIHNwYW4gb2YgdGhlIHtAbGluayBVbmlvbiNkaXNjcmltaW5hdG9yfGRpc2NyaW1pbmF0b3J9IHVzZWQgdG8KCQkgKiBpZGVudGlmeSBpdCwgYnV0IHZhbHVlcyByZWFkIGFuZCB3cml0dGVuIHVzaW5nIHRoZSB2YXJpYW50IHN0cmljdGx5CgkJICogY29uZm9ybSB0byB0aGUgY29udGVudCBvZiB7QGxpbmsgVmFyaWFudExheW91dCNsYXlvdXR8bGF5b3V0fS4KCQkgKgoJCSAqICoqTk9URSoqIFVzZXIgY29kZSBzaG91bGQgbm90IGludm9rZSB0aGlzIGNvbnN0cnVjdG9yIGRpcmVjdGx5LiAgVXNlCgkJICogdGhlIHVuaW9uIHtAbGluayBVbmlvbiNhZGRWYXJpYW50fGFkZFZhcmlhbnR9IGhlbHBlciBtZXRob2QuCgkJICoKCQkgKiBAcGFyYW0ge1VuaW9ufSB1bmlvbiAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBWYXJpYW50TGF5b3V0I3VuaW9ufHVuaW9ufS4KCQkgKgoJCSAqIEBwYXJhbSB7TnVtYmVyfSB2YXJpYW50IC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIFZhcmlhbnRMYXlvdXQjdmFyaWFudHx2YXJpYW50fS4KCQkgKgoJCSAqIEBwYXJhbSB7TGF5b3V0fSBbbGF5b3V0XSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBWYXJpYW50TGF5b3V0I2xheW91dHxsYXlvdXR9LiAgSWYgYWJzZW50IHRoZSB2YXJpYW50IGNhcnJpZXMgbm8KCQkgKiBkYXRhLgoJCSAqCgkJICogQHBhcmFtIHtTdHJpbmd9IFtwcm9wZXJ0eV0gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fS4gIFVubGlrZSBtYW55IG90aGVyIGxheW91dHMsIHZhcmlhbnQKCQkgKiBsYXlvdXRzIG5vcm1hbGx5IGluY2x1ZGUgYSBwcm9wZXJ0eSBuYW1lIHNvIHRoZXkgY2FuIGJlIGlkZW50aWZpZWQKCQkgKiB3aXRoaW4gdGhlaXIgY29udGFpbmluZyB7QGxpbmsgVW5pb259LiAgVGhlIHByb3BlcnR5IGlkZW50aWZpZXIgbWF5CgkJICogYmUgYWJzZW50IG9ubHkgaWYgYGxheW91dGAgaXMgaXMgYWJzZW50LgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgVmFyaWFudExheW91dCBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IodW5pb24sIHZhcmlhbnQsIGxheW91dCwgcHJvcGVydHkpIHsKCQkgICAgICAgIGlmICghKHVuaW9uIGluc3RhbmNlb2YgVW5pb24pKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigndW5pb24gbXVzdCBiZSBhIFVuaW9uJyk7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoKCFOdW1iZXIuaXNJbnRlZ2VyKHZhcmlhbnQpKSB8fCAoMCA+IHZhcmlhbnQpKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigndmFyaWFudCBtdXN0IGJlIGEgKG5vbi1uZWdhdGl2ZSkgaW50ZWdlcicpOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKCgnc3RyaW5nJyA9PT0gdHlwZW9mIGxheW91dCkKCQkgICAgICAgICAgICAmJiAodW5kZWZpbmVkID09PSBwcm9wZXJ0eSkpIHsKCQkgICAgICAgICAgICBwcm9wZXJ0eSA9IGxheW91dDsKCQkgICAgICAgICAgICBsYXlvdXQgPSBudWxsOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKGxheW91dCkgewoJCSAgICAgICAgICAgIGlmICghKGxheW91dCBpbnN0YW5jZW9mIExheW91dCQxKSkgewoJCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdsYXlvdXQgbXVzdCBiZSBhIExheW91dCcpOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgICAgICBpZiAoKG51bGwgIT09IHVuaW9uLmRlZmF1bHRMYXlvdXQpCgkJICAgICAgICAgICAgICAgICYmICgwIDw9IGxheW91dC5zcGFuKQoJCSAgICAgICAgICAgICAgICAmJiAobGF5b3V0LnNwYW4gPiB1bmlvbi5kZWZhdWx0TGF5b3V0LnNwYW4pKSB7CgkJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndmFyaWFudCBzcGFuIGV4Y2VlZHMgc3BhbiBvZiBjb250YWluaW5nIHVuaW9uJyk7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgICAgIGlmICgnc3RyaW5nJyAhPT0gdHlwZW9mIHByb3BlcnR5KSB7CgkJICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3ZhcmlhbnQgbXVzdCBoYXZlIGEgU3RyaW5nIHByb3BlcnR5Jyk7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgfQoJCSAgICAgICAgbGV0IHNwYW4gPSB1bmlvbi5zcGFuOwoJCSAgICAgICAgaWYgKDAgPiB1bmlvbi5zcGFuKSB7CgkJICAgICAgICAgICAgc3BhbiA9IGxheW91dCA/IGxheW91dC5zcGFuIDogMDsKCQkgICAgICAgICAgICBpZiAoKDAgPD0gc3BhbikgJiYgdW5pb24udXNlc1ByZWZpeERpc2NyaW1pbmF0b3IpIHsKCQkgICAgICAgICAgICAgICAgc3BhbiArPSB1bmlvbi5kaXNjcmltaW5hdG9yLmxheW91dC5zcGFuOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgIH0KCQkgICAgICAgIHN1cGVyKHNwYW4sIHByb3BlcnR5KTsKCQkgICAgICAgIC8qKiBUaGUge0BsaW5rIFVuaW9ufSB0byB3aGljaCB0aGlzIHZhcmlhbnQgYmVsb25ncy4gKi8KCQkgICAgICAgIHRoaXMudW5pb24gPSB1bmlvbjsKCQkgICAgICAgIC8qKiBUaGUgdW5zaWduZWQgaW50ZWdyYWwgdmFsdWUgaWRlbnRpZnlpbmcgdGhpcyB2YXJpYW50IHdpdGhpbgoJCSAgICAgICAgICogdGhlIHtAbGluayBVbmlvbiNkaXNjcmltaW5hdG9yfGRpc2NyaW1pbmF0b3J9IG9mIHRoZSBjb250YWluaW5nCgkJICAgICAgICAgKiB1bmlvbi4gKi8KCQkgICAgICAgIHRoaXMudmFyaWFudCA9IHZhcmlhbnQ7CgkJICAgICAgICAvKiogVGhlIHtAbGluayBMYXlvdXR9IHRvIGJlIHVzZWQgd2hlbiByZWFkaW5nL3dyaXRpbmcgdGhlCgkJICAgICAgICAgKiBub24tZGlzY3JpbWluYXRvciBwYXJ0IG9mIHRoZSB7QGxpbmsKCQkgICAgICAgICAqIFZhcmlhbnRMYXlvdXQjdW5pb258dW5pb259LiAgSWYgYG51bGxgIHRoZSB2YXJpYW50IGNhcnJpZXMgbm8KCQkgICAgICAgICAqIGRhdGEuICovCgkJICAgICAgICB0aGlzLmxheW91dCA9IGxheW91dCB8fCBudWxsOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZ2V0U3BhbihiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBpZiAoMCA8PSB0aGlzLnNwYW4pIHsKCQkgICAgICAgICAgICAvKiBXaWxsIGJlIGVxdWFsIHRvIHRoZSBjb250YWluaW5nIHVuaW9uIHNwYW4gaWYgdGhhdCBpcyBub3QKCQkgICAgICAgICAgICAgKiB2YXJpYWJsZS4gKi8KCQkgICAgICAgICAgICByZXR1cm4gdGhpcy5zcGFuOwoJCSAgICAgICAgfQoJCSAgICAgICAgbGV0IGNvbnRlbnRPZmZzZXQgPSAwOwoJCSAgICAgICAgaWYgKHRoaXMudW5pb24udXNlc1ByZWZpeERpc2NyaW1pbmF0b3IpIHsKCQkgICAgICAgICAgICBjb250ZW50T2Zmc2V0ID0gdGhpcy51bmlvbi5kaXNjcmltaW5hdG9yLmxheW91dC5zcGFuOwoJCSAgICAgICAgfQoJCSAgICAgICAgLyogU3BhbiBpcyBkZWZpbmVkIHNvbGVseSBieSB0aGUgdmFyaWFudCAoYW5kIHByZWZpeCBkaXNjcmltaW5hdG9yKSAqLwoJCSAgICAgICAgbGV0IHNwYW4gPSAwOwoJCSAgICAgICAgaWYgKHRoaXMubGF5b3V0KSB7CgkJICAgICAgICAgICAgc3BhbiA9IHRoaXMubGF5b3V0LmdldFNwYW4oYiwgb2Zmc2V0ICsgY29udGVudE9mZnNldCk7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gY29udGVudE9mZnNldCArIHNwYW47CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBkZWNvZGUoYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3QgZGVzdCA9IHRoaXMubWFrZURlc3RpbmF0aW9uT2JqZWN0KCk7CgkJICAgICAgICBpZiAodGhpcyAhPT0gdGhpcy51bmlvbi5nZXRWYXJpYW50KGIsIG9mZnNldCkpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3ZhcmlhbnQgbWlzbWF0Y2gnKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGxldCBjb250ZW50T2Zmc2V0ID0gMDsKCQkgICAgICAgIGlmICh0aGlzLnVuaW9uLnVzZXNQcmVmaXhEaXNjcmltaW5hdG9yKSB7CgkJICAgICAgICAgICAgY29udGVudE9mZnNldCA9IHRoaXMudW5pb24uZGlzY3JpbWluYXRvci5sYXlvdXQuc3BhbjsKCQkgICAgICAgIH0KCQkgICAgICAgIGlmICh0aGlzLmxheW91dCkgewoJCSAgICAgICAgICAgIGRlc3RbdGhpcy5wcm9wZXJ0eV0gPSB0aGlzLmxheW91dC5kZWNvZGUoYiwgb2Zmc2V0ICsgY29udGVudE9mZnNldCk7CgkJICAgICAgICB9CgkJICAgICAgICBlbHNlIGlmICh0aGlzLnByb3BlcnR5KSB7CgkJICAgICAgICAgICAgZGVzdFt0aGlzLnByb3BlcnR5XSA9IHRydWU7CgkJICAgICAgICB9CgkJICAgICAgICBlbHNlIGlmICh0aGlzLnVuaW9uLnVzZXNQcmVmaXhEaXNjcmltaW5hdG9yKSB7CgkJICAgICAgICAgICAgZGVzdFt0aGlzLnVuaW9uLmRpc2NyaW1pbmF0b3IucHJvcGVydHldID0gdGhpcy52YXJpYW50OwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIGRlc3Q7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBsZXQgY29udGVudE9mZnNldCA9IDA7CgkJICAgICAgICBpZiAodGhpcy51bmlvbi51c2VzUHJlZml4RGlzY3JpbWluYXRvcikgewoJCSAgICAgICAgICAgIGNvbnRlbnRPZmZzZXQgPSB0aGlzLnVuaW9uLmRpc2NyaW1pbmF0b3IubGF5b3V0LnNwYW47CgkJICAgICAgICB9CgkJICAgICAgICBpZiAodGhpcy5sYXlvdXQKCQkgICAgICAgICAgICAmJiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzcmMsIHRoaXMucHJvcGVydHkpKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3ZhcmlhbnQgbGFja3MgcHJvcGVydHkgJyArIHRoaXMucHJvcGVydHkpOwoJCSAgICAgICAgfQoJCSAgICAgICAgdGhpcy51bmlvbi5kaXNjcmltaW5hdG9yLmVuY29kZSh0aGlzLnZhcmlhbnQsIGIsIG9mZnNldCk7CgkJICAgICAgICBsZXQgc3BhbiA9IGNvbnRlbnRPZmZzZXQ7CgkJICAgICAgICBpZiAodGhpcy5sYXlvdXQpIHsKCQkgICAgICAgICAgICB0aGlzLmxheW91dC5lbmNvZGUoc3JjW3RoaXMucHJvcGVydHldLCBiLCBvZmZzZXQgKyBjb250ZW50T2Zmc2V0KTsKCQkgICAgICAgICAgICBzcGFuICs9IHRoaXMubGF5b3V0LmdldFNwYW4oYiwgb2Zmc2V0ICsgY29udGVudE9mZnNldCk7CgkJICAgICAgICAgICAgaWYgKCgwIDw9IHRoaXMudW5pb24uc3BhbikKCQkgICAgICAgICAgICAgICAgJiYgKHNwYW4gPiB0aGlzLnVuaW9uLnNwYW4pKSB7CgkJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZW5jb2RlZCB2YXJpYW50IG92ZXJydW5zIGNvbnRhaW5pbmcgdW5pb24nKTsKCQkgICAgICAgICAgICB9CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gc3BhbjsKCQkgICAgfQoJCSAgICAvKiogRGVsZWdhdGUge0BsaW5rIExheW91dCNmcm9tQXJyYXl8ZnJvbUFycmF5fSB0byB7QGxpbmsKCQkgICAgICogVmFyaWFudExheW91dCNsYXlvdXR8bGF5b3V0fS4gKi8KCQkgICAgZnJvbUFycmF5KHZhbHVlcykgewoJCSAgICAgICAgaWYgKHRoaXMubGF5b3V0KSB7CgkJICAgICAgICAgICAgcmV0dXJuIHRoaXMubGF5b3V0LmZyb21BcnJheSh2YWx1ZXMpOwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCQkgICAgfQoJCX0KCQlMYXlvdXQuVmFyaWFudExheW91dCA9IFZhcmlhbnRMYXlvdXQ7CgkJLyoqIEphdmFTY3JpcHQgY2hvc2UgdG8gZGVmaW5lIGJpdHdpc2Ugb3BlcmF0aW9ucyBhcyBvcGVyYXRpbmcgb24KCQkgKiBzaWduZWQgMzItYml0IHZhbHVlcyBpbiAyJ3MgY29tcGxlbWVudCBmb3JtLCBtZWFuaW5nIGFueSBpbnRlZ2VyCgkJICogd2l0aCBiaXQgMzEgc2V0IGlzIGdvaW5nIHRvIGxvb2sgbmVnYXRpdmUuICBGb3IgcmlnaHQgc2hpZnRzIHRoYXQncwoJCSAqIG5vdCBhIHByb2JsZW0sIGJlY2F1c2UgYD4+PmAgaXMgYSBsb2dpY2FsIHNoaWZ0LCBidXQgZm9yIGV2ZXJ5CgkJICogb3RoZXIgYml0d2lzZSBvcGVyYXRvciB3ZSBoYXZlIHRvIGNvbXBlbnNhdGUgZm9yIHBvc3NpYmxlIG5lZ2F0aXZlCgkJICogcmVzdWx0cy4gKi8KCQlmdW5jdGlvbiBmaXhCaXR3aXNlUmVzdWx0KHYpIHsKCQkgICAgaWYgKDAgPiB2KSB7CgkJICAgICAgICB2ICs9IDB4MTAwMDAwMDAwOwoJCSAgICB9CgkJICAgIHJldHVybiB2OwoJCX0KCQkvKioKCQkgKiBDb250YWluIGEgc2VxdWVuY2Ugb2YgYml0IGZpZWxkcyBhcyBhbiB1bnNpZ25lZCBpbnRlZ2VyLgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5iaXRzfGJpdHN9CgkJICoKCQkgKiBUaGlzIGlzIGEgY29udGFpbmVyIGVsZW1lbnQ7IHdpdGhpbiBpdCB0aGVyZSBhcmUge0BsaW5rIEJpdEZpZWxkfQoJCSAqIGluc3RhbmNlcyB0aGF0IHByb3ZpZGUgdGhlIGV4dHJhY3RlZCBwcm9wZXJ0aWVzLiAgVGhlIGNvbnRhaW5lcgoJCSAqIHNpbXBseSBkZWZpbmVzIHRoZSBhZ2dyZWdhdGUgcmVwcmVzZW50YXRpb24gYW5kIGl0cyBiaXQgb3JkZXJpbmcuCgkJICogVGhlIHJlcHJlc2VudGF0aW9uIGlzIGFuIG9iamVjdCBjb250YWluaW5nIHByb3BlcnRpZXMgd2l0aCBudW1lcmljCgkJICogb3Ige0BsaW5rIEJvb2xlYW59IHZhbHVlcy4KCQkgKgoJCSAqIHtAbGluayBCaXRGaWVsZH1zIGFyZSBhZGRlZCB3aXRoIHRoZSB7QGxpbmsKCQkgKiBCaXRTdHJ1Y3R1cmUjYWRkRmllbGR8YWRkRmllbGR9IGFuZCB7QGxpbmsKCQkgKiBCaXRTdHJ1Y3R1cmUjYWRkQm9vbGVhbnxhZGRCb29sZWFufSBtZXRob2RzLgoKCQkgKiBAcGFyYW0ge0xheW91dH0gd29yZCAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBCaXRTdHJ1Y3R1cmUjd29yZHx3b3JkfS4gIFRoZSBwYXJhbWV0ZXIgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZgoJCSAqIHtAbGluayBVSW50fSAob3Ige0BsaW5rIFVJbnRCRX0pIHRoYXQgaXMgbm8gbW9yZSB0aGFuIDQgYnl0ZXMgd2lkZS4KCQkgKgoJCSAqIEBwYXJhbSB7Ym9vbH0gW21zYl0gLSBgdHJ1ZWAgaWYgdGhlIGJpdCBudW1iZXJpbmcgc3RhcnRzIGF0IHRoZQoJCSAqIG1vc3Qgc2lnbmlmaWNhbnQgYml0IG9mIHRoZSBjb250YWluaW5nIHdvcmQ7IGBmYWxzZWAgKGRlZmF1bHQpIGlmCgkJICogaXQgc3RhcnRzIGF0IHRoZSBsZWFzdCBzaWduaWZpY2FudCBiaXQgb2YgdGhlIGNvbnRhaW5pbmcgd29yZC4gIElmCgkJICogdGhlIHBhcmFtZXRlciBhdCB0aGlzIHBvc2l0aW9uIGlzIGEgc3RyaW5nIGFuZCBgcHJvcGVydHlgIGlzCgkJICogYHVuZGVmaW5lZGAgdGhlIHZhbHVlIG9mIHRoaXMgYXJndW1lbnQgd2lsbCBpbnN0ZWFkIGJlIHVzZWQgYXMgdGhlCgkJICogdmFsdWUgb2YgYHByb3BlcnR5YC4KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICoKCQkgKiBAYXVnbWVudHMge0xheW91dH0KCQkgKi8KCQljbGFzcyBCaXRTdHJ1Y3R1cmUgZXh0ZW5kcyBMYXlvdXQkMSB7CgkJICAgIGNvbnN0cnVjdG9yKHdvcmQsIG1zYiwgcHJvcGVydHkpIHsKCQkgICAgICAgIGlmICghKCh3b3JkIGluc3RhbmNlb2YgVUludCkKCQkgICAgICAgICAgICB8fCAod29yZCBpbnN0YW5jZW9mIFVJbnRCRSkpKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignd29yZCBtdXN0IGJlIGEgVUludCBvciBVSW50QkUgbGF5b3V0Jyk7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoKCdzdHJpbmcnID09PSB0eXBlb2YgbXNiKQoJCSAgICAgICAgICAgICYmICh1bmRlZmluZWQgPT09IHByb3BlcnR5KSkgewoJCSAgICAgICAgICAgIHByb3BlcnR5ID0gbXNiOwoJCSAgICAgICAgICAgIG1zYiA9IGZhbHNlOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKDQgPCB3b3JkLnNwYW4pIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignd29yZCBjYW5ub3QgZXhjZWVkIDMyIGJpdHMnKTsKCQkgICAgICAgIH0KCQkgICAgICAgIHN1cGVyKHdvcmQuc3BhbiwgcHJvcGVydHkpOwoJCSAgICAgICAgLyoqIFRoZSBsYXlvdXQgdXNlZCBmb3IgdGhlIHBhY2tlZCB2YWx1ZS4gIHtAbGluayBCaXRGaWVsZH0KCQkgICAgICAgICAqIGluc3RhbmNlcyBhcmUgcGFja2VkIHNlcXVlbnRpYWxseSBkZXBlbmRpbmcgb24ge0BsaW5rCgkJICAgICAgICAgKiBCaXRTdHJ1Y3R1cmUjbXNifG1zYn0uICovCgkJICAgICAgICB0aGlzLndvcmQgPSB3b3JkOwoJCSAgICAgICAgLyoqIFdoZXRoZXIgdGhlIGJpdCBzZXF1ZW5jZXMgYXJlIHBhY2tlZCBzdGFydGluZyBhdCB0aGUgbW9zdAoJCSAgICAgICAgICogc2lnbmlmaWNhbnQgYml0IGdyb3dpbmcgZG93biAoYHRydWVgKSwgb3IgdGhlIGxlYXN0IHNpZ25pZmljYW50CgkJICAgICAgICAgKiBiaXQgZ3Jvd2luZyB1cCAoYGZhbHNlYCkuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogKipOT1RFKiogUmVnYXJkbGVzcyBvZiB0aGlzIHZhbHVlLCB0aGUgbGVhc3Qgc2lnbmlmaWNhbnQgYml0IG9mCgkJICAgICAgICAgKiBhbnkge0BsaW5rIEJpdEZpZWxkfSB2YWx1ZSBpcyB0aGUgbGVhc3Qgc2lnbmlmaWNhbnQgYml0IG9mIHRoZQoJCSAgICAgICAgICogY29ycmVzcG9uZGluZyBzZWN0aW9uIG9mIHRoZSBwYWNrZWQgdmFsdWUuICovCgkJICAgICAgICB0aGlzLm1zYiA9ICEhbXNiOwoJCSAgICAgICAgLyoqIFRoZSBzZXF1ZW5jZSBvZiB7QGxpbmsgQml0RmllbGR9IGxheW91dHMgdGhhdCBjb21wcmlzZSB0aGUKCQkgICAgICAgICAqIHBhY2tlZCBzdHJ1Y3R1cmUuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogKipOT1RFKiogVGhlIGFycmF5IHJlbWFpbnMgbXV0YWJsZSB0byBhbGxvdyBmaWVsZHMgdG8gYmUge0BsaW5rCgkJICAgICAgICAgKiBCaXRTdHJ1Y3R1cmUjYWRkRmllbGR8YWRkZWR9IGFmdGVyIGNvbnN0cnVjdGlvbi4gIFVzZXJzIHNob3VsZAoJCSAgICAgICAgICogbm90IG1hbmlwdWxhdGUgdGhlIGNvbnRlbnQgb2YgdGhpcyBwcm9wZXJ0eS4qLwoJCSAgICAgICAgdGhpcy5maWVsZHMgPSBbXTsKCQkgICAgICAgIC8qIFN0b3JhZ2UgZm9yIHRoZSB2YWx1ZS4gIENhcHR1cmUgYSB2YXJpYWJsZSBpbnN0ZWFkIG9mIHVzaW5nIGFuCgkJICAgICAgICAgKiBpbnN0YW5jZSBwcm9wZXJ0eSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYW55dGhpbmcgdG8gY2hhbmdlIHRoZQoJCSAgICAgICAgICogdmFsdWUgd2l0aG91dCBnb2luZyB0aHJvdWdoIHRoZSBtdXRhdG9yLiAqLwoJCSAgICAgICAgbGV0IHZhbHVlID0gMDsKCQkgICAgICAgIHRoaXMuX3BhY2tlZFNldFZhbHVlID0gZnVuY3Rpb24gKHYpIHsKCQkgICAgICAgICAgICB2YWx1ZSA9IGZpeEJpdHdpc2VSZXN1bHQodik7CgkJICAgICAgICAgICAgcmV0dXJuIHRoaXM7CgkJICAgICAgICB9OwoJCSAgICAgICAgdGhpcy5fcGFja2VkR2V0VmFsdWUgPSBmdW5jdGlvbiAoKSB7CgkJICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwoJCSAgICAgICAgfTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBjb25zdCBkZXN0ID0gdGhpcy5tYWtlRGVzdGluYXRpb25PYmplY3QoKTsKCQkgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy53b3JkLmRlY29kZShiLCBvZmZzZXQpOwoJCSAgICAgICAgdGhpcy5fcGFja2VkU2V0VmFsdWUodmFsdWUpOwoJCSAgICAgICAgZm9yIChjb25zdCBmZCBvZiB0aGlzLmZpZWxkcykgewoJCSAgICAgICAgICAgIGlmICh1bmRlZmluZWQgIT09IGZkLnByb3BlcnR5KSB7CgkJICAgICAgICAgICAgICAgIGRlc3RbZmQucHJvcGVydHldID0gZmQuZGVjb2RlKGIpOwoJCSAgICAgICAgICAgIH0KCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiBkZXN0OwoJCSAgICB9CgkJICAgIC8qKiBJbXBsZW1lbnQge0BsaW5rIExheW91dCNlbmNvZGV8ZW5jb2RlfSBmb3Ige0BsaW5rIEJpdFN0cnVjdHVyZX0uCgkJICAgICAqCgkJICAgICAqIElmIGBzcmNgIGlzIG1pc3NpbmcgYSBwcm9wZXJ0eSBmb3IgYSBtZW1iZXIgd2l0aCBhIGRlZmluZWQge0BsaW5rCgkJICAgICAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0gdGhlIGNvcnJlc3BvbmRpbmcgcmVnaW9uIG9mIHRoZSBwYWNrZWQKCQkgICAgICogdmFsdWUgaXMgbGVmdCB1bm1vZGlmaWVkLiAgVW51c2VkIGJpdHMgYXJlIGFsc28gbGVmdCB1bm1vZGlmaWVkLiAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMud29yZC5kZWNvZGUoYiwgb2Zmc2V0KTsKCQkgICAgICAgIHRoaXMuX3BhY2tlZFNldFZhbHVlKHZhbHVlKTsKCQkgICAgICAgIGZvciAoY29uc3QgZmQgb2YgdGhpcy5maWVsZHMpIHsKCQkgICAgICAgICAgICBpZiAodW5kZWZpbmVkICE9PSBmZC5wcm9wZXJ0eSkgewoJCSAgICAgICAgICAgICAgICBjb25zdCBmdiA9IHNyY1tmZC5wcm9wZXJ0eV07CgkJICAgICAgICAgICAgICAgIGlmICh1bmRlZmluZWQgIT09IGZ2KSB7CgkJICAgICAgICAgICAgICAgICAgICBmZC5lbmNvZGUoZnYpOwoJCSAgICAgICAgICAgICAgICB9CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHRoaXMud29yZC5lbmNvZGUodGhpcy5fcGFja2VkR2V0VmFsdWUoKSwgYiwgb2Zmc2V0KTsKCQkgICAgfQoJCSAgICAvKiogUmVnaXN0ZXIgYSBuZXcgYml0ZmllbGQgd2l0aCBhIGNvbnRhaW5pbmcgYml0IHN0cnVjdHVyZS4gIFRoZQoJCSAgICAgKiByZXN1bHRpbmcgYml0ZmllbGQgaXMgcmV0dXJuZWQuCgkJICAgICAqCgkJICAgICAqIEBwYXJhbSB7TnVtYmVyfSBiaXRzIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluayBCaXRGaWVsZCNiaXRzfGJpdHN9LgoJCSAgICAgKgoJCSAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICAgICAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICAgICAqCgkJICAgICAqIEByZXR1cm4ge0JpdEZpZWxkfSAqLwoJCSAgICBhZGRGaWVsZChiaXRzLCBwcm9wZXJ0eSkgewoJCSAgICAgICAgY29uc3QgYmYgPSBuZXcgQml0RmllbGQodGhpcywgYml0cywgcHJvcGVydHkpOwoJCSAgICAgICAgdGhpcy5maWVsZHMucHVzaChiZik7CgkJICAgICAgICByZXR1cm4gYmY7CgkJICAgIH0KCQkgICAgLyoqIEFzIHdpdGgge0BsaW5rIEJpdFN0cnVjdHVyZSNhZGRGaWVsZHxhZGRGaWVsZH0gZm9yIHNpbmdsZS1iaXQKCQkgICAgICogZmllbGRzIHdpdGggYGJvb2xlYW5gIHZhbHVlIHJlcHJlc2VudGF0aW9uLgoJCSAgICAgKgoJCSAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICAgICAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICAgICAqCgkJICAgICAqIEByZXR1cm4ge0Jvb2xlYW59ICovCgkJICAgIC8vIGBCb29sZWFuYCBjb25mbGljdHMgd2l0aCB0aGUgbmF0aXZlIHByaW1pdGl2ZSB0eXBlCgkJICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXR5cGVzCgkJICAgIGFkZEJvb2xlYW4ocHJvcGVydHkpIHsKCQkgICAgICAgIC8vIFRoaXMgaXMgbXkgQm9vbGVhbiwgbm90IHRoZSBKYXZhc2NyaXB0IG9uZS4KCQkgICAgICAgIGNvbnN0IGJmID0gbmV3IEJvb2xlYW4odGhpcywgcHJvcGVydHkpOwoJCSAgICAgICAgdGhpcy5maWVsZHMucHVzaChiZik7CgkJICAgICAgICByZXR1cm4gYmY7CgkJICAgIH0KCQkgICAgLyoqCgkJICAgICAqIEdldCBhY2Nlc3MgdG8gdGhlIGJpdCBmaWVsZCBmb3IgYSBnaXZlbiBwcm9wZXJ0eS4KCQkgICAgICoKCQkgICAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IC0gdGhlIGJpdCBmaWVsZCBvZiBpbnRlcmVzdC4KCQkgICAgICoKCQkgICAgICogQHJldHVybiB7Qml0RmllbGR9IC0gdGhlIGZpZWxkIGFzc29jaWF0ZWQgd2l0aCBgcHJvcGVydHlgLCBvcgoJCSAgICAgKiB1bmRlZmluZWQgaWYgdGhlcmUgaXMgbm8gc3VjaCBwcm9wZXJ0eS4KCQkgICAgICovCgkJICAgIGZpZWxkRm9yKHByb3BlcnR5KSB7CgkJICAgICAgICBpZiAoJ3N0cmluZycgIT09IHR5cGVvZiBwcm9wZXJ0eSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3Byb3BlcnR5IG11c3QgYmUgc3RyaW5nJyk7CgkJICAgICAgICB9CgkJICAgICAgICBmb3IgKGNvbnN0IGZkIG9mIHRoaXMuZmllbGRzKSB7CgkJICAgICAgICAgICAgaWYgKGZkLnByb3BlcnR5ID09PSBwcm9wZXJ0eSkgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gZmQ7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCQkgICAgfQoJCX0KCQlMYXlvdXQuQml0U3RydWN0dXJlID0gQml0U3RydWN0dXJlOwoJCS8qKgoJCSAqIFJlcHJlc2VudCBhIHNlcXVlbmNlIG9mIGJpdHMgd2l0aGluIGEge0BsaW5rIEJpdFN0cnVjdHVyZX0uCgkJICoKCQkgKiBBbGwgYml0IGZpZWxkIHZhbHVlcyBhcmUgcmVwcmVzZW50ZWQgYXMgdW5zaWduZWQgaW50ZWdlcnMuCgkJICoKCQkgKiAqKk5PVEUqKiBVc2VyIGNvZGUgc2hvdWxkIG5vdCBpbnZva2UgdGhpcyBjb25zdHJ1Y3RvciBkaXJlY3RseS4KCQkgKiBVc2UgdGhlIGNvbnRhaW5lciB7QGxpbmsgQml0U3RydWN0dXJlI2FkZEZpZWxkfGFkZEZpZWxkfSBoZWxwZXIKCQkgKiBtZXRob2QuCgkJICoKCQkgKiAqKk5PVEUqKiBCaXRGaWVsZCBpbnN0YW5jZXMgYXJlIG5vdCBpbnN0YW5jZXMgb2Yge0BsaW5rIExheW91dH0KCQkgKiBzaW5jZSB7QGxpbmsgTGF5b3V0I3NwYW58c3Bhbn0gbWVhc3VyZXMgOC1iaXQgdW5pdHMuCgkJICoKCQkgKiBAcGFyYW0ge0JpdFN0cnVjdHVyZX0gY29udGFpbmVyIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIEJpdEZpZWxkI2NvbnRhaW5lcnxjb250YWluZXJ9LgoJCSAqCgkJICogQHBhcmFtIHtOdW1iZXJ9IGJpdHMgLSBpbml0aWFsaXplciBmb3Ige0BsaW5rIEJpdEZpZWxkI2JpdHN8Yml0c30uCgkJICoKCQkgKiBAcGFyYW0ge3N0cmluZ30gW3Byb3BlcnR5XSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9LgoJCSAqLwoJCWNsYXNzIEJpdEZpZWxkIHsKCQkgICAgY29uc3RydWN0b3IoY29udGFpbmVyLCBiaXRzLCBwcm9wZXJ0eSkgewoJCSAgICAgICAgaWYgKCEoY29udGFpbmVyIGluc3RhbmNlb2YgQml0U3RydWN0dXJlKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2NvbnRhaW5lciBtdXN0IGJlIGEgQml0U3RydWN0dXJlJyk7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoKCFOdW1iZXIuaXNJbnRlZ2VyKGJpdHMpKSB8fCAoMCA+PSBiaXRzKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2JpdHMgbXVzdCBiZSBwb3NpdGl2ZSBpbnRlZ2VyJyk7CgkJICAgICAgICB9CgkJICAgICAgICBjb25zdCB0b3RhbEJpdHMgPSA4ICogY29udGFpbmVyLnNwYW47CgkJICAgICAgICBjb25zdCB1c2VkQml0cyA9IGNvbnRhaW5lci5maWVsZHMucmVkdWNlKChzdW0sIGZkKSA9PiBzdW0gKyBmZC5iaXRzLCAwKTsKCQkgICAgICAgIGlmICgoYml0cyArIHVzZWRCaXRzKSA+IHRvdGFsQml0cykgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYml0cyB0b28gbG9uZyBmb3Igc3BhbiByZW1haW5kZXIgKCcKCQkgICAgICAgICAgICAgICAgKyAodG90YWxCaXRzIC0gdXNlZEJpdHMpICsgJyBvZiAnCgkJICAgICAgICAgICAgICAgICsgdG90YWxCaXRzICsgJyByZW1haW4pJyk7CgkJICAgICAgICB9CgkJICAgICAgICAvKiogVGhlIHtAbGluayBCaXRTdHJ1Y3R1cmV9IGluc3RhbmNlIHRvIHdoaWNoIHRoaXMgYml0IGZpZWxkCgkJICAgICAgICAgKiBiZWxvbmdzLiAqLwoJCSAgICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7CgkJICAgICAgICAvKiogVGhlIHNwYW4gb2YgdGhpcyB2YWx1ZSBpbiBiaXRzLiAqLwoJCSAgICAgICAgdGhpcy5iaXRzID0gYml0czsKCQkgICAgICAgIC8qKiBBIG1hc2sgb2Yge0BsaW5rIEJpdEZpZWxkI2JpdHN8Yml0c30gYml0cyBpc29sYXRpbmcgdmFsdWUgYml0cwoJCSAgICAgICAgICogdGhhdCBmaXQgd2l0aGluIHRoZSBmaWVsZC4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiBUaGF0IGlzLCBpdCBtYXNrcyBhIHZhbHVlIHRoYXQgaGFzIG5vdCB5ZXQgYmVlbiBzaGlmdGVkIGludG8KCQkgICAgICAgICAqIHBvc2l0aW9uIHdpdGhpbiBpdHMgY29udGFpbmluZyBwYWNrZWQgaW50ZWdlci4gKi8KCQkgICAgICAgIHRoaXMudmFsdWVNYXNrID0gKDEgPDwgYml0cykgLSAxOwoJCSAgICAgICAgaWYgKDMyID09PSBiaXRzKSB7IC8vIHNoaWZ0ZWQgdmFsdWUgb3V0IG9mIHJhbmdlCgkJICAgICAgICAgICAgdGhpcy52YWx1ZU1hc2sgPSAweEZGRkZGRkZGOwoJCSAgICAgICAgfQoJCSAgICAgICAgLyoqIFRoZSBvZmZzZXQgb2YgdGhlIHZhbHVlIHdpdGhpbiB0aGUgY29udGFpbmluZyBwYWNrZWQgdW5zaWduZWQKCQkgICAgICAgICAqIGludGVnZXIuICBUaGUgbGVhc3Qgc2lnbmlmaWNhbnQgYml0IG9mIHRoZSBwYWNrZWQgdmFsdWUgaXMgYXQKCQkgICAgICAgICAqIG9mZnNldCB6ZXJvLCByZWdhcmRsZXNzIG9mIGJpdCBvcmRlcmluZyB1c2VkLiAqLwoJCSAgICAgICAgdGhpcy5zdGFydCA9IHVzZWRCaXRzOwoJCSAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyLm1zYikgewoJCSAgICAgICAgICAgIHRoaXMuc3RhcnQgPSB0b3RhbEJpdHMgLSB1c2VkQml0cyAtIGJpdHM7CgkJICAgICAgICB9CgkJICAgICAgICAvKiogQSBtYXNrIG9mIHtAbGluayBCaXRGaWVsZCNiaXRzfGJpdHN9IGlzb2xhdGluZyB0aGUgZmllbGQgdmFsdWUKCQkgICAgICAgICAqIHdpdGhpbiB0aGUgY29udGFpbmluZyBwYWNrZWQgdW5zaWduZWQgaW50ZWdlci4gKi8KCQkgICAgICAgIHRoaXMud29yZE1hc2sgPSBmaXhCaXR3aXNlUmVzdWx0KHRoaXMudmFsdWVNYXNrIDw8IHRoaXMuc3RhcnQpOwoJCSAgICAgICAgLyoqIFRoZSBwcm9wZXJ0eSBuYW1lIHVzZWQgd2hlbiB0aGlzIGJpdGZpZWxkIGlzIHJlcHJlc2VudGVkIGluIGFuCgkJICAgICAgICAgKiBPYmplY3QuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogSW50ZW5kZWQgdG8gYmUgZnVuY3Rpb25hbGx5IGVxdWl2YWxlbnQgdG8ge0BsaW5rCgkJICAgICAgICAgKiBMYXlvdXQjcHJvcGVydHl9LgoJCSAgICAgICAgICoKCQkgICAgICAgICAqIElmIGxlZnQgdW5kZWZpbmVkIHRoZSBjb3JyZXNwb25kaW5nIHNwYW4gb2YgYml0cyB3aWxsIGJlCgkJICAgICAgICAgKiB0cmVhdGVkIGFzIHBhZGRpbmc6IGl0IHdpbGwgbm90IGJlIG11dGF0ZWQgYnkge0BsaW5rCgkJICAgICAgICAgKiBMYXlvdXQjZW5jb2RlfGVuY29kZX0gbm9yIHJlcHJlc2VudGVkIGFzIGEgcHJvcGVydHkgaW4gdGhlCgkJICAgICAgICAgKiBkZWNvZGVkIE9iamVjdC4gKi8KCQkgICAgICAgIHRoaXMucHJvcGVydHkgPSBwcm9wZXJ0eTsKCQkgICAgfQoJCSAgICAvKiogU3RvcmUgYSB2YWx1ZSBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIHN1YnNlcXVlbmNlIG9mIHRoZSBjb250YWluaW5nCgkJICAgICAqIGJpdCBmaWVsZC4gKi8KCQkgICAgZGVjb2RlKGIsIG9mZnNldCkgewoJCSAgICAgICAgY29uc3Qgd29yZCA9IHRoaXMuY29udGFpbmVyLl9wYWNrZWRHZXRWYWx1ZSgpOwoJCSAgICAgICAgY29uc3Qgd29yZFZhbHVlID0gZml4Qml0d2lzZVJlc3VsdCh3b3JkICYgdGhpcy53b3JkTWFzayk7CgkJICAgICAgICBjb25zdCB2YWx1ZSA9IHdvcmRWYWx1ZSA+Pj4gdGhpcy5zdGFydDsKCQkgICAgICAgIHJldHVybiB2YWx1ZTsKCQkgICAgfQoJCSAgICAvKiogU3RvcmUgYSB2YWx1ZSBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIHN1YnNlcXVlbmNlIG9mIHRoZSBjb250YWluaW5nCgkJICAgICAqIGJpdCBmaWVsZC4KCQkgICAgICoKCQkgICAgICogKipOT1RFKiogVGhpcyBpcyBub3QgYSBzcGVjaWFsaXphdGlvbiBvZiB7QGxpbmsKCQkgICAgICogTGF5b3V0I2VuY29kZXxMYXlvdXQuZW5jb2RlfSBhbmQgdGhlcmUgaXMgbm8gcmV0dXJuIHZhbHVlLiAqLwoJCSAgICBlbmNvZGUodmFsdWUpIHsKCQkgICAgICAgIGlmICgnbnVtYmVyJyAhPT0gdHlwZW9mIHZhbHVlCgkJICAgICAgICAgICAgfHwgIU51bWJlci5pc0ludGVnZXIodmFsdWUpCgkJICAgICAgICAgICAgfHwgKHZhbHVlICE9PSBmaXhCaXR3aXNlUmVzdWx0KHZhbHVlICYgdGhpcy52YWx1ZU1hc2spKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IobmFtZVdpdGhQcm9wZXJ0eSgnQml0RmllbGQuZW5jb2RlJywgdGhpcykKCQkgICAgICAgICAgICAgICAgKyAnIHZhbHVlIG11c3QgYmUgaW50ZWdlciBub3QgZXhjZWVkaW5nICcgKyB0aGlzLnZhbHVlTWFzayk7CgkJICAgICAgICB9CgkJICAgICAgICBjb25zdCB3b3JkID0gdGhpcy5jb250YWluZXIuX3BhY2tlZEdldFZhbHVlKCk7CgkJICAgICAgICBjb25zdCB3b3JkVmFsdWUgPSBmaXhCaXR3aXNlUmVzdWx0KHZhbHVlIDw8IHRoaXMuc3RhcnQpOwoJCSAgICAgICAgdGhpcy5jb250YWluZXIuX3BhY2tlZFNldFZhbHVlKGZpeEJpdHdpc2VSZXN1bHQod29yZCAmIH50aGlzLndvcmRNYXNrKQoJCSAgICAgICAgICAgIHwgd29yZFZhbHVlKTsKCQkgICAgfQoJCX0KCQlMYXlvdXQuQml0RmllbGQgPSBCaXRGaWVsZDsKCQkvKioKCQkgKiBSZXByZXNlbnQgYSBzaW5nbGUgYml0IHdpdGhpbiBhIHtAbGluayBCaXRTdHJ1Y3R1cmV9IGFzIGEKCQkgKiBKYXZhU2NyaXB0IGJvb2xlYW4uCgkJICoKCQkgKiAqKk5PVEUqKiBVc2VyIGNvZGUgc2hvdWxkIG5vdCBpbnZva2UgdGhpcyBjb25zdHJ1Y3RvciBkaXJlY3RseS4KCQkgKiBVc2UgdGhlIGNvbnRhaW5lciB7QGxpbmsgQml0U3RydWN0dXJlI2FkZEJvb2xlYW58YWRkQm9vbGVhbn0gaGVscGVyCgkJICogbWV0aG9kLgoJCSAqCgkJICogQHBhcmFtIHtCaXRTdHJ1Y3R1cmV9IGNvbnRhaW5lciAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBCaXRGaWVsZCNjb250YWluZXJ8Y29udGFpbmVyfS4KCQkgKgoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbcHJvcGVydHldIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICoKCQkgKiBAYXVnbWVudHMge0JpdEZpZWxkfQoJCSAqLwoJCS8qIGVzbGludC1kaXNhYmxlIG5vLWV4dGVuZC1uYXRpdmUgKi8KCQljbGFzcyBCb29sZWFuIGV4dGVuZHMgQml0RmllbGQgewoJCSAgICBjb25zdHJ1Y3Rvcihjb250YWluZXIsIHByb3BlcnR5KSB7CgkJICAgICAgICBzdXBlcihjb250YWluZXIsIDEsIHByb3BlcnR5KTsKCQkgICAgfQoJCSAgICAvKiogT3ZlcnJpZGUge0BsaW5rIEJpdEZpZWxkI2RlY29kZXxkZWNvZGV9IGZvciB7QGxpbmsgQm9vbGVhbnxCb29sZWFufS4KCQkgICAgICoKCQkgICAgICogQHJldHVybnMge2Jvb2xlYW59ICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQpIHsKCQkgICAgICAgIHJldHVybiAhIXN1cGVyLmRlY29kZShiLCBvZmZzZXQpOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHZhbHVlKSB7CgkJICAgICAgICBpZiAoJ2Jvb2xlYW4nID09PSB0eXBlb2YgdmFsdWUpIHsKCQkgICAgICAgICAgICAvLyBCaXRGaWVsZCByZXF1aXJlcyBpbnRlZ2VyIHZhbHVlcwoJCSAgICAgICAgICAgIHZhbHVlID0gK3ZhbHVlOwoJCSAgICAgICAgfQoJCSAgICAgICAgc3VwZXIuZW5jb2RlKHZhbHVlKTsKCQkgICAgfQoJCX0KCQlMYXlvdXQuQm9vbGVhbiA9IEJvb2xlYW47CgkJLyogZXNsaW50LWVuYWJsZSBuby1leHRlbmQtbmF0aXZlICovCgkJLyoqCgkJICogQ29udGFpbiBhIGZpeGVkLWxlbmd0aCBibG9jayBvZiBhcmJpdHJhcnkgZGF0YSwgcmVwcmVzZW50ZWQgYXMgYQoJCSAqIFVpbnQ4QXJyYXkuCgkJICoKCQkgKiAqRmFjdG9yeSo6IHtAbGluayBtb2R1bGU6TGF5b3V0LmJsb2J8YmxvYn0KCQkgKgoJCSAqIEBwYXJhbSB7KE51bWJlcnxFeHRlcm5hbExheW91dCl9IGxlbmd0aCAtIGluaXRpYWxpemVzIHtAbGluawoJCSAqIEJsb2IjbGVuZ3RofGxlbmd0aH0uCgkJICoKCQkgKiBAcGFyYW0ge1N0cmluZ30gW3Byb3BlcnR5XSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9LgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgQmxvYiBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IobGVuZ3RoLCBwcm9wZXJ0eSkgewoJCSAgICAgICAgaWYgKCEoKChsZW5ndGggaW5zdGFuY2VvZiBFeHRlcm5hbExheW91dCkgJiYgbGVuZ3RoLmlzQ291bnQoKSkKCQkgICAgICAgICAgICB8fCAoTnVtYmVyLmlzSW50ZWdlcihsZW5ndGgpICYmICgwIDw9IGxlbmd0aCkpKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2xlbmd0aCBtdXN0IGJlIHBvc2l0aXZlIGludGVnZXIgJwoJCSAgICAgICAgICAgICAgICArICdvciBhbiB1bnNpZ25lZCBpbnRlZ2VyIEV4dGVybmFsTGF5b3V0Jyk7CgkJICAgICAgICB9CgkJICAgICAgICBsZXQgc3BhbiA9IC0xOwoJCSAgICAgICAgaWYgKCEobGVuZ3RoIGluc3RhbmNlb2YgRXh0ZXJuYWxMYXlvdXQpKSB7CgkJICAgICAgICAgICAgc3BhbiA9IGxlbmd0aDsKCQkgICAgICAgIH0KCQkgICAgICAgIHN1cGVyKHNwYW4sIHByb3BlcnR5KTsKCQkgICAgICAgIC8qKiBUaGUgbnVtYmVyIG9mIGJ5dGVzIGluIHRoZSBibG9iLgoJCSAgICAgICAgICoKCQkgICAgICAgICAqIFRoaXMgbWF5IGJlIGEgbm9uLW5lZ2F0aXZlIGludGVnZXIsIG9yIGFuIGluc3RhbmNlIG9mIHtAbGluawoJCSAgICAgICAgICogRXh0ZXJuYWxMYXlvdXR9IHRoYXQgc2F0aXNmaWVzIHtAbGluawoJCSAgICAgICAgICogRXh0ZXJuYWxMYXlvdXQjaXNDb3VudHxpc0NvdW50KCl9LiAqLwoJCSAgICAgICAgdGhpcy5sZW5ndGggPSBsZW5ndGg7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBnZXRTcGFuKGIsIG9mZnNldCkgewoJCSAgICAgICAgbGV0IHNwYW4gPSB0aGlzLnNwYW47CgkJICAgICAgICBpZiAoMCA+IHNwYW4pIHsKCQkgICAgICAgICAgICBzcGFuID0gdGhpcy5sZW5ndGguZGVjb2RlKGIsIG9mZnNldCk7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gc3BhbjsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGRlY29kZShiLCBvZmZzZXQgPSAwKSB7CgkJICAgICAgICBsZXQgc3BhbiA9IHRoaXMuc3BhbjsKCQkgICAgICAgIGlmICgwID4gc3BhbikgewoJCSAgICAgICAgICAgIHNwYW4gPSB0aGlzLmxlbmd0aC5kZWNvZGUoYiwgb2Zmc2V0KTsKCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiB1aW50OEFycmF5VG9CdWZmZXIoYikuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyBzcGFuKTsKCQkgICAgfQoJCSAgICAvKiogSW1wbGVtZW50IHtAbGluayBMYXlvdXQjZW5jb2RlfGVuY29kZX0gZm9yIHtAbGluayBCbG9ifS4KCQkgICAgICoKCQkgICAgICogKipOT1RFKiogSWYge0BsaW5rIExheW91dCNjb3VudHxjb3VudH0gaXMgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rCgkJICAgICAqIEV4dGVybmFsTGF5b3V0fSB0aGVuIHRoZSBsZW5ndGggb2YgYHNyY2Agd2lsbCBiZSBlbmNvZGVkIGFzIHRoZQoJCSAgICAgKiBjb3VudCBhZnRlciBgc3JjYCBpcyBlbmNvZGVkLiAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQpIHsKCQkgICAgICAgIGxldCBzcGFuID0gdGhpcy5sZW5ndGg7CgkJICAgICAgICBpZiAodGhpcy5sZW5ndGggaW5zdGFuY2VvZiBFeHRlcm5hbExheW91dCkgewoJCSAgICAgICAgICAgIHNwYW4gPSBzcmMubGVuZ3RoOwoJCSAgICAgICAgfQoJCSAgICAgICAgaWYgKCEoc3JjIGluc3RhbmNlb2YgVWludDhBcnJheSAmJiBzcGFuID09PSBzcmMubGVuZ3RoKSkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IobmFtZVdpdGhQcm9wZXJ0eSgnQmxvYi5lbmNvZGUnLCB0aGlzKQoJCSAgICAgICAgICAgICAgICArICcgcmVxdWlyZXMgKGxlbmd0aCAnICsgc3BhbiArICcpIFVpbnQ4QXJyYXkgYXMgc3JjJyk7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoKG9mZnNldCArIHNwYW4pID4gYi5sZW5ndGgpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignZW5jb2Rpbmcgb3ZlcnJ1bnMgVWludDhBcnJheScpOwoJCSAgICAgICAgfQoJCSAgICAgICAgY29uc3Qgc3JjQnVmZmVyID0gdWludDhBcnJheVRvQnVmZmVyKHNyYyk7CgkJICAgICAgICB1aW50OEFycmF5VG9CdWZmZXIoYikud3JpdGUoc3JjQnVmZmVyLnRvU3RyaW5nKCdoZXgnKSwgb2Zmc2V0LCBzcGFuLCAnaGV4Jyk7CgkJICAgICAgICBpZiAodGhpcy5sZW5ndGggaW5zdGFuY2VvZiBFeHRlcm5hbExheW91dCkgewoJCSAgICAgICAgICAgIHRoaXMubGVuZ3RoLmVuY29kZShzcGFuLCBiLCBvZmZzZXQpOwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHNwYW47CgkJICAgIH0KCQl9CgkJTGF5b3V0LkJsb2IgPSBCbG9iOwoJCS8qKgoJCSAqIENvbnRhaW4gYSBgTlVMYC10ZXJtaW5hdGVkIFVURjggc3RyaW5nLgoJCSAqCgkJICogKkZhY3RvcnkqOiB7QGxpbmsgbW9kdWxlOkxheW91dC5jc3RyfGNzdHJ9CgkJICoKCQkgKiAqKk5PVEUqKiBBbnkgVVRGOCBzdHJpbmcgdGhhdCBpbmNvcnBvcmF0ZXMgYSB6ZXJvLXZhbHVlZCBieXRlIHdpbGwKCQkgKiBub3QgYmUgY29ycmVjdGx5IGRlY29kZWQgYnkgdGhpcyBsYXlvdXQuCgkJICoKCQkgKiBAcGFyYW0ge1N0cmluZ30gW3Byb3BlcnR5XSAtIGluaXRpYWxpemVyIGZvciB7QGxpbmsKCQkgKiBMYXlvdXQjcHJvcGVydHl8cHJvcGVydHl9LgoJCSAqCgkJICogQGF1Z21lbnRzIHtMYXlvdXR9CgkJICovCgkJY2xhc3MgQ1N0cmluZyBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IocHJvcGVydHkpIHsKCQkgICAgICAgIHN1cGVyKC0xLCBwcm9wZXJ0eSk7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBnZXRTcGFuKGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIGNoZWNrVWludDhBcnJheShiKTsKCQkgICAgICAgIGxldCBpZHggPSBvZmZzZXQ7CgkJICAgICAgICB3aGlsZSAoKGlkeCA8IGIubGVuZ3RoKSAmJiAoMCAhPT0gYltpZHhdKSkgewoJCSAgICAgICAgICAgIGlkeCArPSAxOwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIDEgKyBpZHggLSBvZmZzZXQ7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBkZWNvZGUoYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY29uc3Qgc3BhbiA9IHRoaXMuZ2V0U3BhbihiLCBvZmZzZXQpOwoJCSAgICAgICAgcmV0dXJuIHVpbnQ4QXJyYXlUb0J1ZmZlcihiKS5zbGljZShvZmZzZXQsIG9mZnNldCArIHNwYW4gLSAxKS50b1N0cmluZygndXRmLTgnKTsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGVuY29kZShzcmMsIGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIC8qIE11c3QgZm9yY2UgdGhpcyB0byBhIHN0cmluZywgbGVzdCBpdCBiZSBhIG51bWJlciBhbmQgdGhlCgkJICAgICAgICAgKiAidXRmOC1lbmNvZGluZyIgYmVsb3cgYWN0dWFsbHkgYWxsb2NhdGUgYSBidWZmZXIgb2YgbGVuZ3RoCgkJICAgICAgICAgKiBzcmMgKi8KCQkgICAgICAgIGlmICgnc3RyaW5nJyAhPT0gdHlwZW9mIHNyYykgewoJCSAgICAgICAgICAgIHNyYyA9IFN0cmluZyhzcmMpOwoJCSAgICAgICAgfQoJCSAgICAgICAgY29uc3Qgc3JjYiA9IGJ1ZmZlcl8xLkJ1ZmZlci5mcm9tKHNyYywgJ3V0ZjgnKTsKCQkgICAgICAgIGNvbnN0IHNwYW4gPSBzcmNiLmxlbmd0aDsKCQkgICAgICAgIGlmICgob2Zmc2V0ICsgc3BhbikgPiBiLmxlbmd0aCkgewoJCSAgICAgICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdlbmNvZGluZyBvdmVycnVucyBCdWZmZXInKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHVpbnQ4QXJyYXlUb0J1ZmZlcihiKTsKCQkgICAgICAgIHNyY2IuY29weShidWZmZXIsIG9mZnNldCk7CgkJICAgICAgICBidWZmZXJbb2Zmc2V0ICsgc3Bhbl0gPSAwOwoJCSAgICAgICAgcmV0dXJuIHNwYW4gKyAxOwoJCSAgICB9CgkJfQoJCUxheW91dC5DU3RyaW5nID0gQ1N0cmluZzsKCQkvKioKCQkgKiBDb250YWluIGEgVVRGOCBzdHJpbmcgd2l0aCBpbXBsaWNpdCBsZW5ndGguCgkJICoKCQkgKiAqRmFjdG9yeSo6IHtAbGluayBtb2R1bGU6TGF5b3V0LnV0Zjh8dXRmOH0KCQkgKgoJCSAqICoqTk9URSoqIEJlY2F1c2UgdGhlIGxlbmd0aCBpcyBpbXBsaWNpdCBpbiB0aGUgc2l6ZSBvZiB0aGUgYnVmZmVyCgkJICogdGhpcyBsYXlvdXQgc2hvdWxkIGJlIHVzZWQgb25seSBpbiBpc29sYXRpb24sIG9yIGluIGEgc2l0dWF0aW9uCgkJICogd2hlcmUgdGhlIGxlbmd0aCBjYW4gYmUgZXhwcmVzc2VkIGJ5IG9wZXJhdGluZyBvbiBhIHNsaWNlIG9mIHRoZQoJCSAqIGNvbnRhaW5pbmcgYnVmZmVyLgoJCSAqCgkJICogQHBhcmFtIHtOdW1iZXJ9IFttYXhTcGFuXSAtIHRoZSBtYXhpbXVtIGxlbmd0aCBhbGxvd2VkIGZvciBlbmNvZGVkCgkJICogc3RyaW5nIGNvbnRlbnQuICBJZiBub3QgcHJvdmlkZWQgdGhlcmUgaXMgbm8gYm91bmQgb24gdGhlIGFsbG93ZWQKCQkgKiBjb250ZW50LgoJCSAqCgkJICogQHBhcmFtIHtTdHJpbmd9IFtwcm9wZXJ0eV0gLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogTGF5b3V0I3Byb3BlcnR5fHByb3BlcnR5fS4KCQkgKgoJCSAqIEBhdWdtZW50cyB7TGF5b3V0fQoJCSAqLwoJCWNsYXNzIFVURjggZXh0ZW5kcyBMYXlvdXQkMSB7CgkJICAgIGNvbnN0cnVjdG9yKG1heFNwYW4sIHByb3BlcnR5KSB7CgkJICAgICAgICBpZiAoKCdzdHJpbmcnID09PSB0eXBlb2YgbWF4U3BhbikgJiYgKHVuZGVmaW5lZCA9PT0gcHJvcGVydHkpKSB7CgkJICAgICAgICAgICAgcHJvcGVydHkgPSBtYXhTcGFuOwoJCSAgICAgICAgICAgIG1heFNwYW4gPSB1bmRlZmluZWQ7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAodW5kZWZpbmVkID09PSBtYXhTcGFuKSB7CgkJICAgICAgICAgICAgbWF4U3BhbiA9IC0xOwoJCSAgICAgICAgfQoJCSAgICAgICAgZWxzZSBpZiAoIU51bWJlci5pc0ludGVnZXIobWF4U3BhbikpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdtYXhTcGFuIG11c3QgYmUgYW4gaW50ZWdlcicpOwoJCSAgICAgICAgfQoJCSAgICAgICAgc3VwZXIoLTEsIHByb3BlcnR5KTsKCQkgICAgICAgIC8qKiBUaGUgbWF4aW11bSBzcGFuIG9mIHRoZSBsYXlvdXQgaW4gYnl0ZXMuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogUG9zaXRpdmUgdmFsdWVzIGFyZSBnZW5lcmFsbHkgZXhwZWN0ZWQuICBaZXJvIGlzIGFibm9ybWFsLgoJCSAgICAgICAgICogQXR0ZW1wdHMgdG8gZW5jb2RlIG9yIGRlY29kZSBhIHZhbHVlIHRoYXQgZXhjZWVkcyB0aGlzIGxlbmd0aAoJCSAgICAgICAgICogd2lsbCB0aHJvdyBhIGBSYW5nZUVycm9yYC4KCQkgICAgICAgICAqCgkJICAgICAgICAgKiBBIG5lZ2F0aXZlIHZhbHVlIGluZGljYXRlcyB0aGF0IHRoZXJlIGlzIG5vIGJvdW5kIG9uIHRoZSBsZW5ndGgKCQkgICAgICAgICAqIG9mIHRoZSBjb250ZW50LiAqLwoJCSAgICAgICAgdGhpcy5tYXhTcGFuID0gbWF4U3BhbjsKCQkgICAgfQoJCSAgICAvKiogQG92ZXJyaWRlICovCgkJICAgIGdldFNwYW4oYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgY2hlY2tVaW50OEFycmF5KGIpOwoJCSAgICAgICAgcmV0dXJuIGIubGVuZ3RoIC0gb2Zmc2V0OwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZGVjb2RlKGIsIG9mZnNldCA9IDApIHsKCQkgICAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLmdldFNwYW4oYiwgb2Zmc2V0KTsKCQkgICAgICAgIGlmICgoMCA8PSB0aGlzLm1heFNwYW4pCgkJICAgICAgICAgICAgJiYgKHRoaXMubWF4U3BhbiA8IHNwYW4pKSB7CgkJICAgICAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3RleHQgbGVuZ3RoIGV4Y2VlZHMgbWF4U3BhbicpOwoJCSAgICAgICAgfQoJCSAgICAgICAgcmV0dXJuIHVpbnQ4QXJyYXlUb0J1ZmZlcihiKS5zbGljZShvZmZzZXQsIG9mZnNldCArIHNwYW4pLnRvU3RyaW5nKCd1dGYtOCcpOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZW5jb2RlKHNyYywgYiwgb2Zmc2V0ID0gMCkgewoJCSAgICAgICAgLyogTXVzdCBmb3JjZSB0aGlzIHRvIGEgc3RyaW5nLCBsZXN0IGl0IGJlIGEgbnVtYmVyIGFuZCB0aGUKCQkgICAgICAgICAqICJ1dGY4LWVuY29kaW5nIiBiZWxvdyBhY3R1YWxseSBhbGxvY2F0ZSBhIGJ1ZmZlciBvZiBsZW5ndGgKCQkgICAgICAgICAqIHNyYyAqLwoJCSAgICAgICAgaWYgKCdzdHJpbmcnICE9PSB0eXBlb2Ygc3JjKSB7CgkJICAgICAgICAgICAgc3JjID0gU3RyaW5nKHNyYyk7CgkJICAgICAgICB9CgkJICAgICAgICBjb25zdCBzcmNiID0gYnVmZmVyXzEuQnVmZmVyLmZyb20oc3JjLCAndXRmOCcpOwoJCSAgICAgICAgY29uc3Qgc3BhbiA9IHNyY2IubGVuZ3RoOwoJCSAgICAgICAgaWYgKCgwIDw9IHRoaXMubWF4U3BhbikKCQkgICAgICAgICAgICAmJiAodGhpcy5tYXhTcGFuIDwgc3BhbikpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigndGV4dCBsZW5ndGggZXhjZWVkcyBtYXhTcGFuJyk7CgkJICAgICAgICB9CgkJICAgICAgICBpZiAoKG9mZnNldCArIHNwYW4pID4gYi5sZW5ndGgpIHsKCQkgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignZW5jb2Rpbmcgb3ZlcnJ1bnMgQnVmZmVyJyk7CgkJICAgICAgICB9CgkJICAgICAgICBzcmNiLmNvcHkodWludDhBcnJheVRvQnVmZmVyKGIpLCBvZmZzZXQpOwoJCSAgICAgICAgcmV0dXJuIHNwYW47CgkJICAgIH0KCQl9CgkJTGF5b3V0LlVURjggPSBVVEY4OwoJCS8qKgoJCSAqIENvbnRhaW4gYSBjb25zdGFudCB2YWx1ZS4KCQkgKgoJCSAqIFRoaXMgbGF5b3V0IG1heSBiZSB1c2VkIGluIGNhc2VzIHdoZXJlIGEgSmF2YVNjcmlwdCB2YWx1ZSBjYW4gYmUKCQkgKiBpbmZlcnJlZCB3aXRob3V0IGFuIGV4cHJlc3Npb24gaW4gdGhlIGJpbmFyeSBlbmNvZGluZy4gIEFuIGV4YW1wbGUKCQkgKiB3b3VsZCBiZSBhIHtAbGluayBWYXJpYW50TGF5b3V0fHZhcmlhbnQgbGF5b3V0fSB3aGVyZSB0aGUgY29udGVudAoJCSAqIGlzIGltcGxpZWQgYnkgdGhlIHVuaW9uIHtAbGluayBVbmlvbiNkaXNjcmltaW5hdG9yfGRpc2NyaW1pbmF0b3J9LgoJCSAqCgkJICogQHBhcmFtIHtPYmplY3R8TnVtYmVyfFN0cmluZ30gdmFsdWUgLSBpbml0aWFsaXplciBmb3Ige0BsaW5rCgkJICogQ29uc3RhbnQjdmFsdWV8dmFsdWV9LiAgSWYgdGhlIHZhbHVlIGlzIGFuIG9iamVjdCAob3IgYXJyYXkpIGFuZAoJCSAqIHRoZSBhcHBsaWNhdGlvbiBpbnRlbmRzIHRoZSBvYmplY3QgdG8gcmVtYWluIHVuY2hhbmdlZCByZWdhcmRsZXNzCgkJICogb2Ygd2hhdCBpcyBkb25lIHRvIHZhbHVlcyBkZWNvZGVkIGJ5IHRoaXMgbGF5b3V0LCB0aGUgdmFsdWUgc2hvdWxkCgkJICogYmUgZnJvemVuIHByaW9yIHBhc3NpbmcgaXQgdG8gdGhpcyBjb25zdHJ1Y3Rvci4KCQkgKgoJCSAqIEBwYXJhbSB7U3RyaW5nfSBbcHJvcGVydHldIC0gaW5pdGlhbGl6ZXIgZm9yIHtAbGluawoJCSAqIExheW91dCNwcm9wZXJ0eXxwcm9wZXJ0eX0uCgkJICoKCQkgKiBAYXVnbWVudHMge0xheW91dH0KCQkgKi8KCQljbGFzcyBDb25zdGFudCBleHRlbmRzIExheW91dCQxIHsKCQkgICAgY29uc3RydWN0b3IodmFsdWUsIHByb3BlcnR5KSB7CgkJICAgICAgICBzdXBlcigwLCBwcm9wZXJ0eSk7CgkJICAgICAgICAvKiogVGhlIHZhbHVlIHByb2R1Y2VkIGJ5IHRoaXMgY29uc3RhbnQgd2hlbiB0aGUgbGF5b3V0IGlzIHtAbGluawoJCSAgICAgICAgICogQ29uc3RhbnQjZGVjb2RlfGRlY29kZWR9LgoJCSAgICAgICAgICoKCQkgICAgICAgICAqIEFueSBKYXZhU2NyaXB0IHZhbHVlIGluY2x1ZGluZyBgbnVsbGAgYW5kIGB1bmRlZmluZWRgIGlzCgkJICAgICAgICAgKiBwZXJtaXR0ZWQuCgkJICAgICAgICAgKgoJCSAgICAgICAgICogKipXQVJOSU5HKiogSWYgYHZhbHVlYCBwYXNzZWQgaW4gdGhlIGNvbnN0cnVjdG9yIHdhcyBub3QKCQkgICAgICAgICAqIGZyb3plbiwgaXQgaXMgcG9zc2libGUgZm9yIHVzZXJzIG9mIGRlY29kZWQgdmFsdWVzIHRvIGNoYW5nZQoJCSAgICAgICAgICogdGhlIGNvbnRlbnQgb2YgdGhlIHZhbHVlLiAqLwoJCSAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwoJCSAgICB9CgkJICAgIC8qKiBAb3ZlcnJpZGUgKi8KCQkgICAgZGVjb2RlKGIsIG9mZnNldCkgewoJCSAgICAgICAgcmV0dXJuIHRoaXMudmFsdWU7CgkJICAgIH0KCQkgICAgLyoqIEBvdmVycmlkZSAqLwoJCSAgICBlbmNvZGUoc3JjLCBiLCBvZmZzZXQpIHsKCQkgICAgICAgIC8qIENvbnN0YW50cyB0YWtlIG5vIHNwYWNlICovCgkJICAgICAgICByZXR1cm4gMDsKCQkgICAgfQoJCX0KCQlMYXlvdXQuQ29uc3RhbnQgPSBDb25zdGFudDsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIEdyZWVkeUNvdW50fS4gKi8KCQlMYXlvdXQuZ3JlZWR5ID0gKChlbGVtZW50U3BhbiwgcHJvcGVydHkpID0+IG5ldyBHcmVlZHlDb3VudChlbGVtZW50U3BhbiwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIE9mZnNldExheW91dH0uICovCgkJTGF5b3V0Lm9mZnNldCA9ICgobGF5b3V0LCBvZmZzZXQsIHByb3BlcnR5KSA9PiBuZXcgT2Zmc2V0TGF5b3V0KGxheW91dCwgb2Zmc2V0LCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgVUludHx1bnNpZ25lZCBpbnQgbGF5b3V0c30gc3Bhbm5pbmcgb25lCgkJICogYnl0ZS4gKi8KCQlMYXlvdXQudTggPSAoKHByb3BlcnR5KSA9PiBuZXcgVUludCgxLCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgVUludHxsaXR0bGUtZW5kaWFuIHVuc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIHNwYW5uaW5nIHR3byBieXRlcy4gKi8KCQlMYXlvdXQudTE2ID0gKChwcm9wZXJ0eSkgPT4gbmV3IFVJbnQoMiwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIFVJbnR8bGl0dGxlLWVuZGlhbiB1bnNpZ25lZCBpbnQgbGF5b3V0c30KCQkgKiBzcGFubmluZyB0aHJlZSBieXRlcy4gKi8KCQlMYXlvdXQudTI0ID0gKChwcm9wZXJ0eSkgPT4gbmV3IFVJbnQoMywgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIFVJbnR8bGl0dGxlLWVuZGlhbiB1bnNpZ25lZCBpbnQgbGF5b3V0c30KCQkgKiBzcGFubmluZyBmb3VyIGJ5dGVzLiAqLwoJCUxheW91dC51MzIgPSAoKHByb3BlcnR5KSA9PiBuZXcgVUludCg0LCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgVUludHxsaXR0bGUtZW5kaWFuIHVuc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIHNwYW5uaW5nIGZpdmUgYnl0ZXMuICovCgkJTGF5b3V0LnU0MCA9ICgocHJvcGVydHkpID0+IG5ldyBVSW50KDUsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBVSW50fGxpdHRsZS1lbmRpYW4gdW5zaWduZWQgaW50IGxheW91dHN9CgkJICogc3Bhbm5pbmcgc2l4IGJ5dGVzLiAqLwoJCUxheW91dC51NDggPSAoKHByb3BlcnR5KSA9PiBuZXcgVUludCg2LCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgTmVhclVJbnQ2NHxsaXR0bGUtZW5kaWFuIHVuc2lnbmVkIGludAoJCSAqIGxheW91dHN9IGludGVycHJldGVkIGFzIE51bWJlcnMuICovCgkJTGF5b3V0Lm51NjQgPSAoKHByb3BlcnR5KSA9PiBuZXcgTmVhclVJbnQ2NChwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgVUludHxiaWctZW5kaWFuIHVuc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIHNwYW5uaW5nIHR3byBieXRlcy4gKi8KCQlMYXlvdXQudTE2YmUgPSAoKHByb3BlcnR5KSA9PiBuZXcgVUludEJFKDIsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBVSW50fGJpZy1lbmRpYW4gdW5zaWduZWQgaW50IGxheW91dHN9CgkJICogc3Bhbm5pbmcgdGhyZWUgYnl0ZXMuICovCgkJTGF5b3V0LnUyNGJlID0gKChwcm9wZXJ0eSkgPT4gbmV3IFVJbnRCRSgzLCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgVUludHxiaWctZW5kaWFuIHVuc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIHNwYW5uaW5nIGZvdXIgYnl0ZXMuICovCgkJTGF5b3V0LnUzMmJlID0gKChwcm9wZXJ0eSkgPT4gbmV3IFVJbnRCRSg0LCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgVUludHxiaWctZW5kaWFuIHVuc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIHNwYW5uaW5nIGZpdmUgYnl0ZXMuICovCgkJTGF5b3V0LnU0MGJlID0gKChwcm9wZXJ0eSkgPT4gbmV3IFVJbnRCRSg1LCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgVUludHxiaWctZW5kaWFuIHVuc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIHNwYW5uaW5nIHNpeCBieXRlcy4gKi8KCQlMYXlvdXQudTQ4YmUgPSAoKHByb3BlcnR5KSA9PiBuZXcgVUludEJFKDYsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBOZWFyVUludDY0QkV8YmlnLWVuZGlhbiB1bnNpZ25lZCBpbnQKCQkgKiBsYXlvdXRzfSBpbnRlcnByZXRlZCBhcyBOdW1iZXJzLiAqLwoJCUxheW91dC5udTY0YmUgPSAoKHByb3BlcnR5KSA9PiBuZXcgTmVhclVJbnQ2NEJFKHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBJbnR8c2lnbmVkIGludCBsYXlvdXRzfSBzcGFubmluZyBvbmUKCQkgKiBieXRlLiAqLwoJCUxheW91dC5zOCA9ICgocHJvcGVydHkpID0+IG5ldyBJbnQoMSwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIEludHxsaXR0bGUtZW5kaWFuIHNpZ25lZCBpbnQgbGF5b3V0c30KCQkgKiBzcGFubmluZyB0d28gYnl0ZXMuICovCgkJTGF5b3V0LnMxNiA9ICgocHJvcGVydHkpID0+IG5ldyBJbnQoMiwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIEludHxsaXR0bGUtZW5kaWFuIHNpZ25lZCBpbnQgbGF5b3V0c30KCQkgKiBzcGFubmluZyB0aHJlZSBieXRlcy4gKi8KCQlMYXlvdXQuczI0ID0gKChwcm9wZXJ0eSkgPT4gbmV3IEludCgzLCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgSW50fGxpdHRsZS1lbmRpYW4gc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIHNwYW5uaW5nIGZvdXIgYnl0ZXMuICovCgkJTGF5b3V0LnMzMiA9ICgocHJvcGVydHkpID0+IG5ldyBJbnQoNCwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIEludHxsaXR0bGUtZW5kaWFuIHNpZ25lZCBpbnQgbGF5b3V0c30KCQkgKiBzcGFubmluZyBmaXZlIGJ5dGVzLiAqLwoJCUxheW91dC5zNDAgPSAoKHByb3BlcnR5KSA9PiBuZXcgSW50KDUsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBJbnR8bGl0dGxlLWVuZGlhbiBzaWduZWQgaW50IGxheW91dHN9CgkJICogc3Bhbm5pbmcgc2l4IGJ5dGVzLiAqLwoJCUxheW91dC5zNDggPSAoKHByb3BlcnR5KSA9PiBuZXcgSW50KDYsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBOZWFySW50NjR8bGl0dGxlLWVuZGlhbiBzaWduZWQgaW50IGxheW91dHN9CgkJICogaW50ZXJwcmV0ZWQgYXMgTnVtYmVycy4gKi8KCQlMYXlvdXQubnM2NCA9ICgocHJvcGVydHkpID0+IG5ldyBOZWFySW50NjQocHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIEludHxiaWctZW5kaWFuIHNpZ25lZCBpbnQgbGF5b3V0c30KCQkgKiBzcGFubmluZyB0d28gYnl0ZXMuICovCgkJTGF5b3V0LnMxNmJlID0gKChwcm9wZXJ0eSkgPT4gbmV3IEludEJFKDIsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBJbnR8YmlnLWVuZGlhbiBzaWduZWQgaW50IGxheW91dHN9CgkJICogc3Bhbm5pbmcgdGhyZWUgYnl0ZXMuICovCgkJTGF5b3V0LnMyNGJlID0gKChwcm9wZXJ0eSkgPT4gbmV3IEludEJFKDMsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBJbnR8YmlnLWVuZGlhbiBzaWduZWQgaW50IGxheW91dHN9CgkJICogc3Bhbm5pbmcgZm91ciBieXRlcy4gKi8KCQlMYXlvdXQuczMyYmUgPSAoKHByb3BlcnR5KSA9PiBuZXcgSW50QkUoNCwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIEludHxiaWctZW5kaWFuIHNpZ25lZCBpbnQgbGF5b3V0c30KCQkgKiBzcGFubmluZyBmaXZlIGJ5dGVzLiAqLwoJCUxheW91dC5zNDBiZSA9ICgocHJvcGVydHkpID0+IG5ldyBJbnRCRSg1LCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgSW50fGJpZy1lbmRpYW4gc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIHNwYW5uaW5nIHNpeCBieXRlcy4gKi8KCQlMYXlvdXQuczQ4YmUgPSAoKHByb3BlcnR5KSA9PiBuZXcgSW50QkUoNiwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIE5lYXJJbnQ2NEJFfGJpZy1lbmRpYW4gc2lnbmVkIGludCBsYXlvdXRzfQoJCSAqIGludGVycHJldGVkIGFzIE51bWJlcnMuICovCgkJTGF5b3V0Lm5zNjRiZSA9ICgocHJvcGVydHkpID0+IG5ldyBOZWFySW50NjRCRShwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgRmxvYXR8bGl0dGxlLWVuZGlhbiAzMi1iaXQgZmxvYXRpbmcgcG9pbnR9IHZhbHVlcy4gKi8KCQlMYXlvdXQuZjMyID0gKChwcm9wZXJ0eSkgPT4gbmV3IEZsb2F0KHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBGbG9hdEJFfGJpZy1lbmRpYW4gMzItYml0IGZsb2F0aW5nIHBvaW50fSB2YWx1ZXMuICovCgkJTGF5b3V0LmYzMmJlID0gKChwcm9wZXJ0eSkgPT4gbmV3IEZsb2F0QkUocHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIERvdWJsZXxsaXR0bGUtZW5kaWFuIDY0LWJpdCBmbG9hdGluZyBwb2ludH0gdmFsdWVzLiAqLwoJCUxheW91dC5mNjQgPSAoKHByb3BlcnR5KSA9PiBuZXcgRG91YmxlKHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBEb3VibGVCRXxiaWctZW5kaWFuIDY0LWJpdCBmbG9hdGluZyBwb2ludH0gdmFsdWVzLiAqLwoJCUxheW91dC5mNjRiZSA9ICgocHJvcGVydHkpID0+IG5ldyBEb3VibGVCRShwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgU3RydWN0dXJlfSB2YWx1ZXMuICovCgkJTGF5b3V0LnN0cnVjdCA9ICgoZmllbGRzLCBwcm9wZXJ0eSwgZGVjb2RlUHJlZml4ZXMpID0+IG5ldyBTdHJ1Y3R1cmUoZmllbGRzLCBwcm9wZXJ0eSwgZGVjb2RlUHJlZml4ZXMpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIEJpdFN0cnVjdHVyZX0gdmFsdWVzLiAqLwoJCUxheW91dC5iaXRzID0gKCh3b3JkLCBtc2IsIHByb3BlcnR5KSA9PiBuZXcgQml0U3RydWN0dXJlKHdvcmQsIG1zYiwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIFNlcXVlbmNlfSB2YWx1ZXMuICovCgkJTGF5b3V0LnNlcSA9ICgoZWxlbWVudExheW91dCwgY291bnQsIHByb3BlcnR5KSA9PiBuZXcgU2VxdWVuY2UoZWxlbWVudExheW91dCwgY291bnQsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBVbmlvbn0gdmFsdWVzLiAqLwoJCUxheW91dC51bmlvbiA9ICgoZGlzY3IsIGRlZmF1bHRMYXlvdXQsIHByb3BlcnR5KSA9PiBuZXcgVW5pb24oZGlzY3IsIGRlZmF1bHRMYXlvdXQsIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBVbmlvbkxheW91dERpc2NyaW1pbmF0b3J9IHZhbHVlcy4gKi8KCQlMYXlvdXQudW5pb25MYXlvdXREaXNjcmltaW5hdG9yID0gKChsYXlvdXQsIHByb3BlcnR5KSA9PiBuZXcgVW5pb25MYXlvdXREaXNjcmltaW5hdG9yKGxheW91dCwgcHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIEJsb2J9IHZhbHVlcy4gKi8KCQlMYXlvdXQuYmxvYiA9ICgobGVuZ3RoLCBwcm9wZXJ0eSkgPT4gbmV3IEJsb2IobGVuZ3RoLCBwcm9wZXJ0eSkpOwoJCS8qKiBGYWN0b3J5IGZvciB7QGxpbmsgQ1N0cmluZ30gdmFsdWVzLiAqLwoJCUxheW91dC5jc3RyID0gKChwcm9wZXJ0eSkgPT4gbmV3IENTdHJpbmcocHJvcGVydHkpKTsKCQkvKiogRmFjdG9yeSBmb3Ige0BsaW5rIFVURjh9IHZhbHVlcy4gKi8KCQlMYXlvdXQudXRmOCA9ICgobWF4U3BhbiwgcHJvcGVydHkpID0+IG5ldyBVVEY4KG1heFNwYW4sIHByb3BlcnR5KSk7CgkJLyoqIEZhY3RvcnkgZm9yIHtAbGluayBDb25zdGFudH0gdmFsdWVzLiAqLwoJCUxheW91dC5jb25zdGFudCA9ICgodmFsdWUsIHByb3BlcnR5KSA9PiBuZXcgQ29uc3RhbnQodmFsdWUsIHByb3BlcnR5KSk7CgkJCgkJcmV0dXJuIExheW91dDsKCX0KCgl2YXIgTGF5b3V0RXhwb3J0cyA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUxheW91dCgpOwoKCS8qKgoJICogTWF4aW11bSBvdmVyLXRoZS13aXJlIHNpemUgb2YgYSBUcmFuc2FjdGlvbgoJICoKCSAqIDEyODAgaXMgSVB2NiBtaW5pbXVtIE1UVQoJICogNDAgYnl0ZXMgaXMgdGhlIHNpemUgb2YgdGhlIElQdjYgaGVhZGVyCgkgKiA4IGJ5dGVzIGlzIHRoZSBzaXplIG9mIHRoZSBmcmFnbWVudCBoZWFkZXIKCSAqLwoJY29uc3QgUEFDS0VUX0RBVEFfU0laRSA9IDEyODAgLSA0MCAtIDg7Cgljb25zdCBWRVJTSU9OX1BSRUZJWF9NQVNLID0gMHg3ZjsKCWNvbnN0IFNJR05BVFVSRV9MRU5HVEhfSU5fQllURVMgPSA2NDsKCgljbGFzcyBUcmFuc2FjdGlvbkV4cGlyZWRCbG9ja2hlaWdodEV4Y2VlZGVkRXJyb3IgZXh0ZW5kcyBFcnJvciB7CgkgIGNvbnN0cnVjdG9yKHNpZ25hdHVyZSkgewoJICAgIHN1cGVyKGBTaWduYXR1cmUgJHtzaWduYXR1cmV9IGhhcyBleHBpcmVkOiBibG9jayBoZWlnaHQgZXhjZWVkZWQuYCk7CgkgICAgdGhpcy5zaWduYXR1cmUgPSB2b2lkIDA7CgkgICAgdGhpcy5zaWduYXR1cmUgPSBzaWduYXR1cmU7CgkgIH0KCX0KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShUcmFuc2FjdGlvbkV4cGlyZWRCbG9ja2hlaWdodEV4Y2VlZGVkRXJyb3IucHJvdG90eXBlLCAnbmFtZScsIHsKCSAgdmFsdWU6ICdUcmFuc2FjdGlvbkV4cGlyZWRCbG9ja2hlaWdodEV4Y2VlZGVkRXJyb3InCgl9KTsKCWNsYXNzIFRyYW5zYWN0aW9uRXhwaXJlZFRpbWVvdXRFcnJvciBleHRlbmRzIEVycm9yIHsKCSAgY29uc3RydWN0b3Ioc2lnbmF0dXJlLCB0aW1lb3V0U2Vjb25kcykgewoJICAgIHN1cGVyKGBUcmFuc2FjdGlvbiB3YXMgbm90IGNvbmZpcm1lZCBpbiAke3RpbWVvdXRTZWNvbmRzLnRvRml4ZWQoMil9IHNlY29uZHMuIEl0IGlzIGAgKyAndW5rbm93biBpZiBpdCBzdWNjZWVkZWQgb3IgZmFpbGVkLiBDaGVjayBzaWduYXR1cmUgJyArIGAke3NpZ25hdHVyZX0gdXNpbmcgdGhlIFNvbGFuYSBFeHBsb3JlciBvciBDTEkgdG9vbHMuYCk7CgkgICAgdGhpcy5zaWduYXR1cmUgPSB2b2lkIDA7CgkgICAgdGhpcy5zaWduYXR1cmUgPSBzaWduYXR1cmU7CgkgIH0KCX0KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShUcmFuc2FjdGlvbkV4cGlyZWRUaW1lb3V0RXJyb3IucHJvdG90eXBlLCAnbmFtZScsIHsKCSAgdmFsdWU6ICdUcmFuc2FjdGlvbkV4cGlyZWRUaW1lb3V0RXJyb3InCgl9KTsKCWNsYXNzIFRyYW5zYWN0aW9uRXhwaXJlZE5vbmNlSW52YWxpZEVycm9yIGV4dGVuZHMgRXJyb3IgewoJICBjb25zdHJ1Y3RvcihzaWduYXR1cmUpIHsKCSAgICBzdXBlcihgU2lnbmF0dXJlICR7c2lnbmF0dXJlfSBoYXMgZXhwaXJlZDogdGhlIG5vbmNlIGlzIG5vIGxvbmdlciB2YWxpZC5gKTsKCSAgICB0aGlzLnNpZ25hdHVyZSA9IHZvaWQgMDsKCSAgICB0aGlzLnNpZ25hdHVyZSA9IHNpZ25hdHVyZTsKCSAgfQoJfQoJT2JqZWN0LmRlZmluZVByb3BlcnR5KFRyYW5zYWN0aW9uRXhwaXJlZE5vbmNlSW52YWxpZEVycm9yLnByb3RvdHlwZSwgJ25hbWUnLCB7CgkgIHZhbHVlOiAnVHJhbnNhY3Rpb25FeHBpcmVkTm9uY2VJbnZhbGlkRXJyb3InCgl9KTsKCgljbGFzcyBNZXNzYWdlQWNjb3VudEtleXMgewoJICBjb25zdHJ1Y3RvcihzdGF0aWNBY2NvdW50S2V5cywgYWNjb3VudEtleXNGcm9tTG9va3VwcykgewoJICAgIHRoaXMuc3RhdGljQWNjb3VudEtleXMgPSB2b2lkIDA7CgkgICAgdGhpcy5hY2NvdW50S2V5c0Zyb21Mb29rdXBzID0gdm9pZCAwOwoJICAgIHRoaXMuc3RhdGljQWNjb3VudEtleXMgPSBzdGF0aWNBY2NvdW50S2V5czsKCSAgICB0aGlzLmFjY291bnRLZXlzRnJvbUxvb2t1cHMgPSBhY2NvdW50S2V5c0Zyb21Mb29rdXBzOwoJICB9CgkgIGtleVNlZ21lbnRzKCkgewoJICAgIGNvbnN0IGtleVNlZ21lbnRzID0gW3RoaXMuc3RhdGljQWNjb3VudEtleXNdOwoJICAgIGlmICh0aGlzLmFjY291bnRLZXlzRnJvbUxvb2t1cHMpIHsKCSAgICAgIGtleVNlZ21lbnRzLnB1c2godGhpcy5hY2NvdW50S2V5c0Zyb21Mb29rdXBzLndyaXRhYmxlKTsKCSAgICAgIGtleVNlZ21lbnRzLnB1c2godGhpcy5hY2NvdW50S2V5c0Zyb21Mb29rdXBzLnJlYWRvbmx5KTsKCSAgICB9CgkgICAgcmV0dXJuIGtleVNlZ21lbnRzOwoJICB9CgkgIGdldChpbmRleCkgewoJICAgIGZvciAoY29uc3Qga2V5U2VnbWVudCBvZiB0aGlzLmtleVNlZ21lbnRzKCkpIHsKCSAgICAgIGlmIChpbmRleCA8IGtleVNlZ21lbnQubGVuZ3RoKSB7CgkgICAgICAgIHJldHVybiBrZXlTZWdtZW50W2luZGV4XTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGluZGV4IC09IGtleVNlZ21lbnQubGVuZ3RoOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm47CgkgIH0KCSAgZ2V0IGxlbmd0aCgpIHsKCSAgICByZXR1cm4gdGhpcy5rZXlTZWdtZW50cygpLmZsYXQoKS5sZW5ndGg7CgkgIH0KCSAgY29tcGlsZUluc3RydWN0aW9ucyhpbnN0cnVjdGlvbnMpIHsKCSAgICAvLyBCYWlsIGVhcmx5IGlmIGFueSBhY2NvdW50IGluZGV4ZXMgd291bGQgb3ZlcmZsb3cgYSB1OAoJICAgIGNvbnN0IFU4X01BWCA9IDI1NTsKCSAgICBpZiAodGhpcy5sZW5ndGggPiBVOF9NQVggKyAxKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FjY291bnQgaW5kZXggb3ZlcmZsb3cgZW5jb3VudGVyZWQgZHVyaW5nIGNvbXBpbGF0aW9uJyk7CgkgICAgfQoJICAgIGNvbnN0IGtleUluZGV4TWFwID0gbmV3IE1hcCgpOwoJICAgIHRoaXMua2V5U2VnbWVudHMoKS5mbGF0KCkuZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4gewoJICAgICAga2V5SW5kZXhNYXAuc2V0KGtleS50b0Jhc2U1OCgpLCBpbmRleCk7CgkgICAgfSk7CgkgICAgY29uc3QgZmluZEtleUluZGV4ID0ga2V5ID0+IHsKCSAgICAgIGNvbnN0IGtleUluZGV4ID0ga2V5SW5kZXhNYXAuZ2V0KGtleS50b0Jhc2U1OCgpKTsKCSAgICAgIGlmIChrZXlJbmRleCA9PT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ0VuY291bnRlcmVkIGFuIHVua25vd24gaW5zdHJ1Y3Rpb24gYWNjb3VudCBrZXkgZHVyaW5nIGNvbXBpbGF0aW9uJyk7CgkgICAgICByZXR1cm4ga2V5SW5kZXg7CgkgICAgfTsKCSAgICByZXR1cm4gaW5zdHJ1Y3Rpb25zLm1hcChpbnN0cnVjdGlvbiA9PiB7CgkgICAgICByZXR1cm4gewoJICAgICAgICBwcm9ncmFtSWRJbmRleDogZmluZEtleUluZGV4KGluc3RydWN0aW9uLnByb2dyYW1JZCksCgkgICAgICAgIGFjY291bnRLZXlJbmRleGVzOiBpbnN0cnVjdGlvbi5rZXlzLm1hcChtZXRhID0+IGZpbmRLZXlJbmRleChtZXRhLnB1YmtleSkpLAoJICAgICAgICBkYXRhOiBpbnN0cnVjdGlvbi5kYXRhCgkgICAgICB9OwoJICAgIH0pOwoJICB9Cgl9CgoJLyoqCgkgKiBMYXlvdXQgZm9yIGEgcHVibGljIGtleQoJICovCgljb25zdCBwdWJsaWNLZXkgPSAocHJvcGVydHkgPSAncHVibGljS2V5JykgPT4gewoJICByZXR1cm4gTGF5b3V0RXhwb3J0cy5ibG9iKDMyLCBwcm9wZXJ0eSk7Cgl9OwoKCS8qKgoJICogTGF5b3V0IGZvciBhIHNpZ25hdHVyZQoJICovCgljb25zdCBzaWduYXR1cmUgPSAocHJvcGVydHkgPSAnc2lnbmF0dXJlJykgPT4gewoJICByZXR1cm4gTGF5b3V0RXhwb3J0cy5ibG9iKDY0LCBwcm9wZXJ0eSk7Cgl9OwoJLyoqCgkgKiBMYXlvdXQgZm9yIGEgUnVzdCBTdHJpbmcgdHlwZQoJICovCgljb25zdCBydXN0U3RyaW5nID0gKHByb3BlcnR5ID0gJ3N0cmluZycpID0+IHsKCSAgY29uc3QgcnNsID0gTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdsZW5ndGgnKSwgTGF5b3V0RXhwb3J0cy51MzIoJ2xlbmd0aFBhZGRpbmcnKSwgTGF5b3V0RXhwb3J0cy5ibG9iKExheW91dEV4cG9ydHMub2Zmc2V0KExheW91dEV4cG9ydHMudTMyKCksIC04KSwgJ2NoYXJzJyldLCBwcm9wZXJ0eSk7CgkgIGNvbnN0IF9kZWNvZGUgPSByc2wuZGVjb2RlLmJpbmQocnNsKTsKCSAgY29uc3QgX2VuY29kZSA9IHJzbC5lbmNvZGUuYmluZChyc2wpOwoJICBjb25zdCByc2xTaGltID0gcnNsOwoJICByc2xTaGltLmRlY29kZSA9IChiLCBvZmZzZXQpID0+IHsKCSAgICBjb25zdCBkYXRhID0gX2RlY29kZShiLCBvZmZzZXQpOwoJICAgIHJldHVybiBkYXRhWydjaGFycyddLnRvU3RyaW5nKCk7CgkgIH07CgkgIHJzbFNoaW0uZW5jb2RlID0gKHN0ciwgYiwgb2Zmc2V0KSA9PiB7CgkgICAgY29uc3QgZGF0YSA9IHsKCSAgICAgIGNoYXJzOiBidWZmZXJFeHBvcnRzLkJ1ZmZlci5mcm9tKHN0ciwgJ3V0ZjgnKQoJICAgIH07CgkgICAgcmV0dXJuIF9lbmNvZGUoZGF0YSwgYiwgb2Zmc2V0KTsKCSAgfTsKCSAgcnNsU2hpbS5hbGxvYyA9IHN0ciA9PiB7CgkgICAgcmV0dXJuIExheW91dEV4cG9ydHMudTMyKCkuc3BhbiArIExheW91dEV4cG9ydHMudTMyKCkuc3BhbiArIGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oc3RyLCAndXRmOCcpLmxlbmd0aDsKCSAgfTsKCSAgcmV0dXJuIHJzbFNoaW07Cgl9OwoKCS8qKgoJICogTGF5b3V0IGZvciBhbiBBdXRob3JpemVkIG9iamVjdAoJICovCgljb25zdCBhdXRob3JpemVkID0gKHByb3BlcnR5ID0gJ2F1dGhvcml6ZWQnKSA9PiB7CgkgIHJldHVybiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbcHVibGljS2V5KCdzdGFrZXInKSwgcHVibGljS2V5KCd3aXRoZHJhd2VyJyldLCBwcm9wZXJ0eSk7Cgl9OwoKCS8qKgoJICogTGF5b3V0IGZvciBhIExvY2t1cCBvYmplY3QKCSAqLwoJY29uc3QgbG9ja3VwID0gKHByb3BlcnR5ID0gJ2xvY2t1cCcpID0+IHsKCSAgcmV0dXJuIExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLm5zNjQoJ3VuaXhUaW1lc3RhbXAnKSwgTGF5b3V0RXhwb3J0cy5uczY0KCdlcG9jaCcpLCBwdWJsaWNLZXkoJ2N1c3RvZGlhbicpXSwgcHJvcGVydHkpOwoJfTsKCgkvKioKCSAqICBMYXlvdXQgZm9yIGEgVm90ZUluaXQgb2JqZWN0CgkgKi8KCWNvbnN0IHZvdGVJbml0ID0gKHByb3BlcnR5ID0gJ3ZvdGVJbml0JykgPT4gewoJICByZXR1cm4gTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW3B1YmxpY0tleSgnbm9kZVB1YmtleScpLCBwdWJsaWNLZXkoJ2F1dGhvcml6ZWRWb3RlcicpLCBwdWJsaWNLZXkoJ2F1dGhvcml6ZWRXaXRoZHJhd2VyJyksIExheW91dEV4cG9ydHMudTgoJ2NvbW1pc3Npb24nKV0sIHByb3BlcnR5KTsKCX07CgoJLyoqCgkgKiAgTGF5b3V0IGZvciBhIFZvdGVBdXRob3JpemVXaXRoU2VlZEFyZ3Mgb2JqZWN0CgkgKi8KCWNvbnN0IHZvdGVBdXRob3JpemVXaXRoU2VlZEFyZ3MgPSAocHJvcGVydHkgPSAndm90ZUF1dGhvcml6ZVdpdGhTZWVkQXJncycpID0+IHsKCSAgcmV0dXJuIExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMigndm90ZUF1dGhvcml6YXRpb25UeXBlJyksIHB1YmxpY0tleSgnY3VycmVudEF1dGhvcml0eURlcml2ZWRLZXlPd25lclB1YmtleScpLCBydXN0U3RyaW5nKCdjdXJyZW50QXV0aG9yaXR5RGVyaXZlZEtleVNlZWQnKSwgcHVibGljS2V5KCduZXdBdXRob3JpemVkJyldLCBwcm9wZXJ0eSk7Cgl9OwoJZnVuY3Rpb24gZ2V0QWxsb2ModHlwZSwgZmllbGRzKSB7CgkgIGNvbnN0IGdldEl0ZW1BbGxvYyA9IGl0ZW0gPT4gewoJICAgIGlmIChpdGVtLnNwYW4gPj0gMCkgewoJICAgICAgcmV0dXJuIGl0ZW0uc3BhbjsKCSAgICB9IGVsc2UgaWYgKHR5cGVvZiBpdGVtLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICByZXR1cm4gaXRlbS5hbGxvYyhmaWVsZHNbaXRlbS5wcm9wZXJ0eV0pOwoJICAgIH0gZWxzZSBpZiAoJ2NvdW50JyBpbiBpdGVtICYmICdlbGVtZW50TGF5b3V0JyBpbiBpdGVtKSB7CgkgICAgICBjb25zdCBmaWVsZCA9IGZpZWxkc1tpdGVtLnByb3BlcnR5XTsKCSAgICAgIGlmIChBcnJheS5pc0FycmF5KGZpZWxkKSkgewoJICAgICAgICByZXR1cm4gZmllbGQubGVuZ3RoICogZ2V0SXRlbUFsbG9jKGl0ZW0uZWxlbWVudExheW91dCk7CgkgICAgICB9CgkgICAgfSBlbHNlIGlmICgnZmllbGRzJyBpbiBpdGVtKSB7CgkgICAgICAvLyBUaGlzIGlzIGEgYFN0cnVjdHVyZWAgd2hvc2Ugc2l6ZSBuZWVkcyB0byBiZSByZWN1cnNpdmVseSBtZWFzdXJlZC4KCSAgICAgIHJldHVybiBnZXRBbGxvYyh7CgkgICAgICAgIGxheW91dDogaXRlbQoJICAgICAgfSwgZmllbGRzW2l0ZW0ucHJvcGVydHldKTsKCSAgICB9CgkgICAgLy8gQ291bGRuJ3QgZGV0ZXJtaW5lIGFsbG9jYXRlZCBzaXplIG9mIGxheW91dAoJICAgIHJldHVybiAwOwoJICB9OwoJICBsZXQgYWxsb2MgPSAwOwoJICB0eXBlLmxheW91dC5maWVsZHMuZm9yRWFjaChpdGVtID0+IHsKCSAgICBhbGxvYyArPSBnZXRJdGVtQWxsb2MoaXRlbSk7CgkgIH0pOwoJICByZXR1cm4gYWxsb2M7Cgl9CgoJZnVuY3Rpb24gZGVjb2RlTGVuZ3RoKGJ5dGVzKSB7CgkgIGxldCBsZW4gPSAwOwoJICBsZXQgc2l6ZSA9IDA7CgkgIGZvciAoOzspIHsKCSAgICBsZXQgZWxlbSA9IGJ5dGVzLnNoaWZ0KCk7CgkgICAgbGVuIHw9IChlbGVtICYgMHg3ZikgPDwgc2l6ZSAqIDc7CgkgICAgc2l6ZSArPSAxOwoJICAgIGlmICgoZWxlbSAmIDB4ODApID09PSAwKSB7CgkgICAgICBicmVhazsKCSAgICB9CgkgIH0KCSAgcmV0dXJuIGxlbjsKCX0KCWZ1bmN0aW9uIGVuY29kZUxlbmd0aChieXRlcywgbGVuKSB7CgkgIGxldCByZW1fbGVuID0gbGVuOwoJICBmb3IgKDs7KSB7CgkgICAgbGV0IGVsZW0gPSByZW1fbGVuICYgMHg3ZjsKCSAgICByZW1fbGVuID4+PSA3OwoJICAgIGlmIChyZW1fbGVuID09IDApIHsKCSAgICAgIGJ5dGVzLnB1c2goZWxlbSk7CgkgICAgICBicmVhazsKCSAgICB9IGVsc2UgewoJICAgICAgZWxlbSB8PSAweDgwOwoJICAgICAgYnl0ZXMucHVzaChlbGVtKTsKCSAgICB9CgkgIH0KCX0KCglmdW5jdGlvbiBhc3NlcnQkMSAoY29uZGl0aW9uLCBtZXNzYWdlKSB7CgkgIGlmICghY29uZGl0aW9uKSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UgfHwgJ0Fzc2VydGlvbiBmYWlsZWQnKTsKCSAgfQoJfQoKCWNsYXNzIENvbXBpbGVkS2V5cyB7CgkgIGNvbnN0cnVjdG9yKHBheWVyLCBrZXlNZXRhTWFwKSB7CgkgICAgdGhpcy5wYXllciA9IHZvaWQgMDsKCSAgICB0aGlzLmtleU1ldGFNYXAgPSB2b2lkIDA7CgkgICAgdGhpcy5wYXllciA9IHBheWVyOwoJICAgIHRoaXMua2V5TWV0YU1hcCA9IGtleU1ldGFNYXA7CgkgIH0KCSAgc3RhdGljIGNvbXBpbGUoaW5zdHJ1Y3Rpb25zLCBwYXllcikgewoJICAgIGNvbnN0IGtleU1ldGFNYXAgPSBuZXcgTWFwKCk7CgkgICAgY29uc3QgZ2V0T3JJbnNlcnREZWZhdWx0ID0gcHVia2V5ID0+IHsKCSAgICAgIGNvbnN0IGFkZHJlc3MgPSBwdWJrZXkudG9CYXNlNTgoKTsKCSAgICAgIGxldCBrZXlNZXRhID0ga2V5TWV0YU1hcC5nZXQoYWRkcmVzcyk7CgkgICAgICBpZiAoa2V5TWV0YSA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgIGtleU1ldGEgPSB7CgkgICAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlLAoJICAgICAgICAgIGlzSW52b2tlZDogZmFsc2UKCSAgICAgICAgfTsKCSAgICAgICAga2V5TWV0YU1hcC5zZXQoYWRkcmVzcywga2V5TWV0YSk7CgkgICAgICB9CgkgICAgICByZXR1cm4ga2V5TWV0YTsKCSAgICB9OwoJICAgIGNvbnN0IHBheWVyS2V5TWV0YSA9IGdldE9ySW5zZXJ0RGVmYXVsdChwYXllcik7CgkgICAgcGF5ZXJLZXlNZXRhLmlzU2lnbmVyID0gdHJ1ZTsKCSAgICBwYXllcktleU1ldGEuaXNXcml0YWJsZSA9IHRydWU7CgkgICAgZm9yIChjb25zdCBpeCBvZiBpbnN0cnVjdGlvbnMpIHsKCSAgICAgIGdldE9ySW5zZXJ0RGVmYXVsdChpeC5wcm9ncmFtSWQpLmlzSW52b2tlZCA9IHRydWU7CgkgICAgICBmb3IgKGNvbnN0IGFjY291bnRNZXRhIG9mIGl4LmtleXMpIHsKCSAgICAgICAgY29uc3Qga2V5TWV0YSA9IGdldE9ySW5zZXJ0RGVmYXVsdChhY2NvdW50TWV0YS5wdWJrZXkpOwoJICAgICAgICBrZXlNZXRhLmlzU2lnbmVyIHx8PSBhY2NvdW50TWV0YS5pc1NpZ25lcjsKCSAgICAgICAga2V5TWV0YS5pc1dyaXRhYmxlIHx8PSBhY2NvdW50TWV0YS5pc1dyaXRhYmxlOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gbmV3IENvbXBpbGVkS2V5cyhwYXllciwga2V5TWV0YU1hcCk7CgkgIH0KCSAgZ2V0TWVzc2FnZUNvbXBvbmVudHMoKSB7CgkgICAgY29uc3QgbWFwRW50cmllcyA9IFsuLi50aGlzLmtleU1ldGFNYXAuZW50cmllcygpXTsKCSAgICBhc3NlcnQkMShtYXBFbnRyaWVzLmxlbmd0aCA8PSAyNTYsICdNYXggc3RhdGljIGFjY291bnQga2V5cyBsZW5ndGggZXhjZWVkZWQnKTsKCSAgICBjb25zdCB3cml0YWJsZVNpZ25lcnMgPSBtYXBFbnRyaWVzLmZpbHRlcigoWywgbWV0YV0pID0+IG1ldGEuaXNTaWduZXIgJiYgbWV0YS5pc1dyaXRhYmxlKTsKCSAgICBjb25zdCByZWFkb25seVNpZ25lcnMgPSBtYXBFbnRyaWVzLmZpbHRlcigoWywgbWV0YV0pID0+IG1ldGEuaXNTaWduZXIgJiYgIW1ldGEuaXNXcml0YWJsZSk7CgkgICAgY29uc3Qgd3JpdGFibGVOb25TaWduZXJzID0gbWFwRW50cmllcy5maWx0ZXIoKFssIG1ldGFdKSA9PiAhbWV0YS5pc1NpZ25lciAmJiBtZXRhLmlzV3JpdGFibGUpOwoJICAgIGNvbnN0IHJlYWRvbmx5Tm9uU2lnbmVycyA9IG1hcEVudHJpZXMuZmlsdGVyKChbLCBtZXRhXSkgPT4gIW1ldGEuaXNTaWduZXIgJiYgIW1ldGEuaXNXcml0YWJsZSk7CgkgICAgY29uc3QgaGVhZGVyID0gewoJICAgICAgbnVtUmVxdWlyZWRTaWduYXR1cmVzOiB3cml0YWJsZVNpZ25lcnMubGVuZ3RoICsgcmVhZG9ubHlTaWduZXJzLmxlbmd0aCwKCSAgICAgIG51bVJlYWRvbmx5U2lnbmVkQWNjb3VudHM6IHJlYWRvbmx5U2lnbmVycy5sZW5ndGgsCgkgICAgICBudW1SZWFkb25seVVuc2lnbmVkQWNjb3VudHM6IHJlYWRvbmx5Tm9uU2lnbmVycy5sZW5ndGgKCSAgICB9OwoKCSAgICAvLyBzYW5pdHkgY2hlY2tzCgkgICAgewoJICAgICAgYXNzZXJ0JDEod3JpdGFibGVTaWduZXJzLmxlbmd0aCA+IDAsICdFeHBlY3RlZCBhdCBsZWFzdCBvbmUgd3JpdGFibGUgc2lnbmVyIGtleScpOwoJICAgICAgY29uc3QgW3BheWVyQWRkcmVzc10gPSB3cml0YWJsZVNpZ25lcnNbMF07CgkgICAgICBhc3NlcnQkMShwYXllckFkZHJlc3MgPT09IHRoaXMucGF5ZXIudG9CYXNlNTgoKSwgJ0V4cGVjdGVkIGZpcnN0IHdyaXRhYmxlIHNpZ25lciBrZXkgdG8gYmUgdGhlIGZlZSBwYXllcicpOwoJICAgIH0KCSAgICBjb25zdCBzdGF0aWNBY2NvdW50S2V5cyA9IFsuLi53cml0YWJsZVNpZ25lcnMubWFwKChbYWRkcmVzc10pID0+IG5ldyBQdWJsaWNLZXkoYWRkcmVzcykpLCAuLi5yZWFkb25seVNpZ25lcnMubWFwKChbYWRkcmVzc10pID0+IG5ldyBQdWJsaWNLZXkoYWRkcmVzcykpLCAuLi53cml0YWJsZU5vblNpZ25lcnMubWFwKChbYWRkcmVzc10pID0+IG5ldyBQdWJsaWNLZXkoYWRkcmVzcykpLCAuLi5yZWFkb25seU5vblNpZ25lcnMubWFwKChbYWRkcmVzc10pID0+IG5ldyBQdWJsaWNLZXkoYWRkcmVzcykpXTsKCSAgICByZXR1cm4gW2hlYWRlciwgc3RhdGljQWNjb3VudEtleXNdOwoJICB9CgkgIGV4dHJhY3RUYWJsZUxvb2t1cChsb29rdXBUYWJsZSkgewoJICAgIGNvbnN0IFt3cml0YWJsZUluZGV4ZXMsIGRyYWluZWRXcml0YWJsZUtleXNdID0gdGhpcy5kcmFpbktleXNGb3VuZEluTG9va3VwVGFibGUobG9va3VwVGFibGUuc3RhdGUuYWRkcmVzc2VzLCBrZXlNZXRhID0+ICFrZXlNZXRhLmlzU2lnbmVyICYmICFrZXlNZXRhLmlzSW52b2tlZCAmJiBrZXlNZXRhLmlzV3JpdGFibGUpOwoJICAgIGNvbnN0IFtyZWFkb25seUluZGV4ZXMsIGRyYWluZWRSZWFkb25seUtleXNdID0gdGhpcy5kcmFpbktleXNGb3VuZEluTG9va3VwVGFibGUobG9va3VwVGFibGUuc3RhdGUuYWRkcmVzc2VzLCBrZXlNZXRhID0+ICFrZXlNZXRhLmlzU2lnbmVyICYmICFrZXlNZXRhLmlzSW52b2tlZCAmJiAha2V5TWV0YS5pc1dyaXRhYmxlKTsKCgkgICAgLy8gRG9uJ3QgZXh0cmFjdCBsb29rdXAgaWYgbm8ga2V5cyB3ZXJlIGZvdW5kCgkgICAgaWYgKHdyaXRhYmxlSW5kZXhlcy5sZW5ndGggPT09IDAgJiYgcmVhZG9ubHlJbmRleGVzLmxlbmd0aCA9PT0gMCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICByZXR1cm4gW3sKCSAgICAgIGFjY291bnRLZXk6IGxvb2t1cFRhYmxlLmtleSwKCSAgICAgIHdyaXRhYmxlSW5kZXhlcywKCSAgICAgIHJlYWRvbmx5SW5kZXhlcwoJICAgIH0sIHsKCSAgICAgIHdyaXRhYmxlOiBkcmFpbmVkV3JpdGFibGVLZXlzLAoJICAgICAgcmVhZG9ubHk6IGRyYWluZWRSZWFkb25seUtleXMKCSAgICB9XTsKCSAgfQoKCSAgLyoqIEBpbnRlcm5hbCAqLwoJICBkcmFpbktleXNGb3VuZEluTG9va3VwVGFibGUobG9va3VwVGFibGVFbnRyaWVzLCBrZXlNZXRhRmlsdGVyKSB7CgkgICAgY29uc3QgbG9va3VwVGFibGVJbmRleGVzID0gbmV3IEFycmF5KCk7CgkgICAgY29uc3QgZHJhaW5lZEtleXMgPSBuZXcgQXJyYXkoKTsKCSAgICBmb3IgKGNvbnN0IFthZGRyZXNzLCBrZXlNZXRhXSBvZiB0aGlzLmtleU1ldGFNYXAuZW50cmllcygpKSB7CgkgICAgICBpZiAoa2V5TWV0YUZpbHRlcihrZXlNZXRhKSkgewoJICAgICAgICBjb25zdCBrZXkgPSBuZXcgUHVibGljS2V5KGFkZHJlc3MpOwoJICAgICAgICBjb25zdCBsb29rdXBUYWJsZUluZGV4ID0gbG9va3VwVGFibGVFbnRyaWVzLmZpbmRJbmRleChlbnRyeSA9PiBlbnRyeS5lcXVhbHMoa2V5KSk7CgkgICAgICAgIGlmIChsb29rdXBUYWJsZUluZGV4ID49IDApIHsKCSAgICAgICAgICBhc3NlcnQkMShsb29rdXBUYWJsZUluZGV4IDwgMjU2LCAnTWF4IGxvb2t1cCB0YWJsZSBpbmRleCBleGNlZWRlZCcpOwoJICAgICAgICAgIGxvb2t1cFRhYmxlSW5kZXhlcy5wdXNoKGxvb2t1cFRhYmxlSW5kZXgpOwoJICAgICAgICAgIGRyYWluZWRLZXlzLnB1c2goa2V5KTsKCSAgICAgICAgICB0aGlzLmtleU1ldGFNYXAuZGVsZXRlKGFkZHJlc3MpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBbbG9va3VwVGFibGVJbmRleGVzLCBkcmFpbmVkS2V5c107CgkgIH0KCX0KCgljb25zdCBFTkRfT0ZfQlVGRkVSX0VSUk9SX01FU1NBR0UgPSAnUmVhY2hlZCBlbmQgb2YgYnVmZmVyIHVuZXhwZWN0ZWRseSc7CgoJLyoqCgkgKiBEZWxlZ2F0ZXMgdG8gYEFycmF5I3NoaWZ0YCwgYnV0IHRocm93cyBpZiB0aGUgYXJyYXkgaXMgemVyby1sZW5ndGguCgkgKi8KCWZ1bmN0aW9uIGd1YXJkZWRTaGlmdChieXRlQXJyYXkpIHsKCSAgaWYgKGJ5dGVBcnJheS5sZW5ndGggPT09IDApIHsKCSAgICB0aHJvdyBuZXcgRXJyb3IoRU5EX09GX0JVRkZFUl9FUlJPUl9NRVNTQUdFKTsKCSAgfQoJICByZXR1cm4gYnl0ZUFycmF5LnNoaWZ0KCk7Cgl9CgoJLyoqCgkgKiBEZWxlZ2F0ZXMgdG8gYEFycmF5I3NwbGljZWAsIGJ1dCB0aHJvd3MgaWYgdGhlIHNlY3Rpb24gYmVpbmcgc3BsaWNlZCBvdXQgZXh0ZW5kcyBwYXN0IHRoZSBlbmQgb2YKCSAqIHRoZSBhcnJheS4KCSAqLwoJZnVuY3Rpb24gZ3VhcmRlZFNwbGljZShieXRlQXJyYXksIC4uLmFyZ3MpIHsKCSAgY29uc3QgW3N0YXJ0XSA9IGFyZ3M7CgkgIGlmIChhcmdzLmxlbmd0aCA9PT0gMiAvLyBJbXBsaWVzIHRoYXQgYGRlbGV0ZUNvdW50YCB3YXMgc3VwcGxpZWQKCSAgPyBzdGFydCArIChhcmdzWzFdID8/IDApID4gYnl0ZUFycmF5Lmxlbmd0aCA6IHN0YXJ0ID49IGJ5dGVBcnJheS5sZW5ndGgpIHsKCSAgICB0aHJvdyBuZXcgRXJyb3IoRU5EX09GX0JVRkZFUl9FUlJPUl9NRVNTQUdFKTsKCSAgfQoJICByZXR1cm4gYnl0ZUFycmF5LnNwbGljZSguLi5hcmdzKTsKCX0KCgkvKioKCSAqIEFuIGluc3RydWN0aW9uIHRvIGV4ZWN1dGUgYnkgYSBwcm9ncmFtCgkgKgoJICogQHByb3BlcnR5IHtudW1iZXJ9IHByb2dyYW1JZEluZGV4CgkgKiBAcHJvcGVydHkge251bWJlcltdfSBhY2NvdW50cwoJICogQHByb3BlcnR5IHtzdHJpbmd9IGRhdGEKCSAqLwoKCS8qKgoJICogTWVzc2FnZSBjb25zdHJ1Y3RvciBhcmd1bWVudHMKCSAqLwoKCS8qKgoJICogTGlzdCBvZiBpbnN0cnVjdGlvbnMgdG8gYmUgcHJvY2Vzc2VkIGF0b21pY2FsbHkKCSAqLwoJY2xhc3MgTWVzc2FnZSB7CgkgIGNvbnN0cnVjdG9yKGFyZ3MpIHsKCSAgICB0aGlzLmhlYWRlciA9IHZvaWQgMDsKCSAgICB0aGlzLmFjY291bnRLZXlzID0gdm9pZCAwOwoJICAgIHRoaXMucmVjZW50QmxvY2toYXNoID0gdm9pZCAwOwoJICAgIHRoaXMuaW5zdHJ1Y3Rpb25zID0gdm9pZCAwOwoJICAgIHRoaXMuaW5kZXhUb1Byb2dyYW1JZHMgPSBuZXcgTWFwKCk7CgkgICAgdGhpcy5oZWFkZXIgPSBhcmdzLmhlYWRlcjsKCSAgICB0aGlzLmFjY291bnRLZXlzID0gYXJncy5hY2NvdW50S2V5cy5tYXAoYWNjb3VudCA9PiBuZXcgUHVibGljS2V5KGFjY291bnQpKTsKCSAgICB0aGlzLnJlY2VudEJsb2NraGFzaCA9IGFyZ3MucmVjZW50QmxvY2toYXNoOwoJICAgIHRoaXMuaW5zdHJ1Y3Rpb25zID0gYXJncy5pbnN0cnVjdGlvbnM7CgkgICAgdGhpcy5pbnN0cnVjdGlvbnMuZm9yRWFjaChpeCA9PiB0aGlzLmluZGV4VG9Qcm9ncmFtSWRzLnNldChpeC5wcm9ncmFtSWRJbmRleCwgdGhpcy5hY2NvdW50S2V5c1tpeC5wcm9ncmFtSWRJbmRleF0pKTsKCSAgfQoJICBnZXQgdmVyc2lvbigpIHsKCSAgICByZXR1cm4gJ2xlZ2FjeSc7CgkgIH0KCSAgZ2V0IHN0YXRpY0FjY291bnRLZXlzKCkgewoJICAgIHJldHVybiB0aGlzLmFjY291bnRLZXlzOwoJICB9CgkgIGdldCBjb21waWxlZEluc3RydWN0aW9ucygpIHsKCSAgICByZXR1cm4gdGhpcy5pbnN0cnVjdGlvbnMubWFwKGl4ID0+ICh7CgkgICAgICBwcm9ncmFtSWRJbmRleDogaXgucHJvZ3JhbUlkSW5kZXgsCgkgICAgICBhY2NvdW50S2V5SW5kZXhlczogaXguYWNjb3VudHMsCgkgICAgICBkYXRhOiBiczU4LmRlY29kZShpeC5kYXRhKQoJICAgIH0pKTsKCSAgfQoJICBnZXQgYWRkcmVzc1RhYmxlTG9va3VwcygpIHsKCSAgICByZXR1cm4gW107CgkgIH0KCSAgZ2V0QWNjb3VudEtleXMoKSB7CgkgICAgcmV0dXJuIG5ldyBNZXNzYWdlQWNjb3VudEtleXModGhpcy5zdGF0aWNBY2NvdW50S2V5cyk7CgkgIH0KCSAgc3RhdGljIGNvbXBpbGUoYXJncykgewoJICAgIGNvbnN0IGNvbXBpbGVkS2V5cyA9IENvbXBpbGVkS2V5cy5jb21waWxlKGFyZ3MuaW5zdHJ1Y3Rpb25zLCBhcmdzLnBheWVyS2V5KTsKCSAgICBjb25zdCBbaGVhZGVyLCBzdGF0aWNBY2NvdW50S2V5c10gPSBjb21waWxlZEtleXMuZ2V0TWVzc2FnZUNvbXBvbmVudHMoKTsKCSAgICBjb25zdCBhY2NvdW50S2V5cyA9IG5ldyBNZXNzYWdlQWNjb3VudEtleXMoc3RhdGljQWNjb3VudEtleXMpOwoJICAgIGNvbnN0IGluc3RydWN0aW9ucyA9IGFjY291bnRLZXlzLmNvbXBpbGVJbnN0cnVjdGlvbnMoYXJncy5pbnN0cnVjdGlvbnMpLm1hcChpeCA9PiAoewoJICAgICAgcHJvZ3JhbUlkSW5kZXg6IGl4LnByb2dyYW1JZEluZGV4LAoJICAgICAgYWNjb3VudHM6IGl4LmFjY291bnRLZXlJbmRleGVzLAoJICAgICAgZGF0YTogYnM1OC5lbmNvZGUoaXguZGF0YSkKCSAgICB9KSk7CgkgICAgcmV0dXJuIG5ldyBNZXNzYWdlKHsKCSAgICAgIGhlYWRlciwKCSAgICAgIGFjY291bnRLZXlzOiBzdGF0aWNBY2NvdW50S2V5cywKCSAgICAgIHJlY2VudEJsb2NraGFzaDogYXJncy5yZWNlbnRCbG9ja2hhc2gsCgkgICAgICBpbnN0cnVjdGlvbnMKCSAgICB9KTsKCSAgfQoJICBpc0FjY291bnRTaWduZXIoaW5kZXgpIHsKCSAgICByZXR1cm4gaW5kZXggPCB0aGlzLmhlYWRlci5udW1SZXF1aXJlZFNpZ25hdHVyZXM7CgkgIH0KCSAgaXNBY2NvdW50V3JpdGFibGUoaW5kZXgpIHsKCSAgICBjb25zdCBudW1TaWduZWRBY2NvdW50cyA9IHRoaXMuaGVhZGVyLm51bVJlcXVpcmVkU2lnbmF0dXJlczsKCSAgICBpZiAoaW5kZXggPj0gdGhpcy5oZWFkZXIubnVtUmVxdWlyZWRTaWduYXR1cmVzKSB7CgkgICAgICBjb25zdCB1bnNpZ25lZEFjY291bnRJbmRleCA9IGluZGV4IC0gbnVtU2lnbmVkQWNjb3VudHM7CgkgICAgICBjb25zdCBudW1VbnNpZ25lZEFjY291bnRzID0gdGhpcy5hY2NvdW50S2V5cy5sZW5ndGggLSBudW1TaWduZWRBY2NvdW50czsKCSAgICAgIGNvbnN0IG51bVdyaXRhYmxlVW5zaWduZWRBY2NvdW50cyA9IG51bVVuc2lnbmVkQWNjb3VudHMgLSB0aGlzLmhlYWRlci5udW1SZWFkb25seVVuc2lnbmVkQWNjb3VudHM7CgkgICAgICByZXR1cm4gdW5zaWduZWRBY2NvdW50SW5kZXggPCBudW1Xcml0YWJsZVVuc2lnbmVkQWNjb3VudHM7CgkgICAgfSBlbHNlIHsKCSAgICAgIGNvbnN0IG51bVdyaXRhYmxlU2lnbmVkQWNjb3VudHMgPSBudW1TaWduZWRBY2NvdW50cyAtIHRoaXMuaGVhZGVyLm51bVJlYWRvbmx5U2lnbmVkQWNjb3VudHM7CgkgICAgICByZXR1cm4gaW5kZXggPCBudW1Xcml0YWJsZVNpZ25lZEFjY291bnRzOwoJICAgIH0KCSAgfQoJICBpc1Byb2dyYW1JZChpbmRleCkgewoJICAgIHJldHVybiB0aGlzLmluZGV4VG9Qcm9ncmFtSWRzLmhhcyhpbmRleCk7CgkgIH0KCSAgcHJvZ3JhbUlkcygpIHsKCSAgICByZXR1cm4gWy4uLnRoaXMuaW5kZXhUb1Byb2dyYW1JZHMudmFsdWVzKCldOwoJICB9CgkgIG5vblByb2dyYW1JZHMoKSB7CgkgICAgcmV0dXJuIHRoaXMuYWNjb3VudEtleXMuZmlsdGVyKChfLCBpbmRleCkgPT4gIXRoaXMuaXNQcm9ncmFtSWQoaW5kZXgpKTsKCSAgfQoJICBzZXJpYWxpemUoKSB7CgkgICAgY29uc3QgbnVtS2V5cyA9IHRoaXMuYWNjb3VudEtleXMubGVuZ3RoOwoJICAgIGxldCBrZXlDb3VudCA9IFtdOwoJICAgIGVuY29kZUxlbmd0aChrZXlDb3VudCwgbnVtS2V5cyk7CgkgICAgY29uc3QgaW5zdHJ1Y3Rpb25zID0gdGhpcy5pbnN0cnVjdGlvbnMubWFwKGluc3RydWN0aW9uID0+IHsKCSAgICAgIGNvbnN0IHsKCSAgICAgICAgYWNjb3VudHMsCgkgICAgICAgIHByb2dyYW1JZEluZGV4CgkgICAgICB9ID0gaW5zdHJ1Y3Rpb247CgkgICAgICBjb25zdCBkYXRhID0gQXJyYXkuZnJvbShiczU4LmRlY29kZShpbnN0cnVjdGlvbi5kYXRhKSk7CgkgICAgICBsZXQga2V5SW5kaWNlc0NvdW50ID0gW107CgkgICAgICBlbmNvZGVMZW5ndGgoa2V5SW5kaWNlc0NvdW50LCBhY2NvdW50cy5sZW5ndGgpOwoJICAgICAgbGV0IGRhdGFDb3VudCA9IFtdOwoJICAgICAgZW5jb2RlTGVuZ3RoKGRhdGFDb3VudCwgZGF0YS5sZW5ndGgpOwoJICAgICAgcmV0dXJuIHsKCSAgICAgICAgcHJvZ3JhbUlkSW5kZXgsCgkgICAgICAgIGtleUluZGljZXNDb3VudDogYnVmZmVyRXhwb3J0cy5CdWZmZXIuZnJvbShrZXlJbmRpY2VzQ291bnQpLAoJICAgICAgICBrZXlJbmRpY2VzOiBhY2NvdW50cywKCSAgICAgICAgZGF0YUxlbmd0aDogYnVmZmVyRXhwb3J0cy5CdWZmZXIuZnJvbShkYXRhQ291bnQpLAoJICAgICAgICBkYXRhCgkgICAgICB9OwoJICAgIH0pOwoJICAgIGxldCBpbnN0cnVjdGlvbkNvdW50ID0gW107CgkgICAgZW5jb2RlTGVuZ3RoKGluc3RydWN0aW9uQ291bnQsIGluc3RydWN0aW9ucy5sZW5ndGgpOwoJICAgIGxldCBpbnN0cnVjdGlvbkJ1ZmZlciA9IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmFsbG9jKFBBQ0tFVF9EQVRBX1NJWkUpOwoJICAgIGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oaW5zdHJ1Y3Rpb25Db3VudCkuY29weShpbnN0cnVjdGlvbkJ1ZmZlcik7CgkgICAgbGV0IGluc3RydWN0aW9uQnVmZmVyTGVuZ3RoID0gaW5zdHJ1Y3Rpb25Db3VudC5sZW5ndGg7CgkgICAgaW5zdHJ1Y3Rpb25zLmZvckVhY2goaW5zdHJ1Y3Rpb24gPT4gewoJICAgICAgY29uc3QgaW5zdHJ1Y3Rpb25MYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51OCgncHJvZ3JhbUlkSW5kZXgnKSwgTGF5b3V0RXhwb3J0cy5ibG9iKGluc3RydWN0aW9uLmtleUluZGljZXNDb3VudC5sZW5ndGgsICdrZXlJbmRpY2VzQ291bnQnKSwgTGF5b3V0RXhwb3J0cy5zZXEoTGF5b3V0RXhwb3J0cy51OCgna2V5SW5kZXgnKSwgaW5zdHJ1Y3Rpb24ua2V5SW5kaWNlcy5sZW5ndGgsICdrZXlJbmRpY2VzJyksIExheW91dEV4cG9ydHMuYmxvYihpbnN0cnVjdGlvbi5kYXRhTGVuZ3RoLmxlbmd0aCwgJ2RhdGFMZW5ndGgnKSwgTGF5b3V0RXhwb3J0cy5zZXEoTGF5b3V0RXhwb3J0cy51OCgndXNlcmRhdHVtJyksIGluc3RydWN0aW9uLmRhdGEubGVuZ3RoLCAnZGF0YScpXSk7CgkgICAgICBjb25zdCBsZW5ndGggPSBpbnN0cnVjdGlvbkxheW91dC5lbmNvZGUoaW5zdHJ1Y3Rpb24sIGluc3RydWN0aW9uQnVmZmVyLCBpbnN0cnVjdGlvbkJ1ZmZlckxlbmd0aCk7CgkgICAgICBpbnN0cnVjdGlvbkJ1ZmZlckxlbmd0aCArPSBsZW5ndGg7CgkgICAgfSk7CgkgICAgaW5zdHJ1Y3Rpb25CdWZmZXIgPSBpbnN0cnVjdGlvbkJ1ZmZlci5zbGljZSgwLCBpbnN0cnVjdGlvbkJ1ZmZlckxlbmd0aCk7CgkgICAgY29uc3Qgc2lnbkRhdGFMYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy5ibG9iKDEsICdudW1SZXF1aXJlZFNpZ25hdHVyZXMnKSwgTGF5b3V0RXhwb3J0cy5ibG9iKDEsICdudW1SZWFkb25seVNpZ25lZEFjY291bnRzJyksIExheW91dEV4cG9ydHMuYmxvYigxLCAnbnVtUmVhZG9ubHlVbnNpZ25lZEFjY291bnRzJyksIExheW91dEV4cG9ydHMuYmxvYihrZXlDb3VudC5sZW5ndGgsICdrZXlDb3VudCcpLCBMYXlvdXRFeHBvcnRzLnNlcShwdWJsaWNLZXkoJ2tleScpLCBudW1LZXlzLCAna2V5cycpLCBwdWJsaWNLZXkoJ3JlY2VudEJsb2NraGFzaCcpXSk7CgkgICAgY29uc3QgdHJhbnNhY3Rpb24gPSB7CgkgICAgICBudW1SZXF1aXJlZFNpZ25hdHVyZXM6IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oW3RoaXMuaGVhZGVyLm51bVJlcXVpcmVkU2lnbmF0dXJlc10pLAoJICAgICAgbnVtUmVhZG9ubHlTaWduZWRBY2NvdW50czogYnVmZmVyRXhwb3J0cy5CdWZmZXIuZnJvbShbdGhpcy5oZWFkZXIubnVtUmVhZG9ubHlTaWduZWRBY2NvdW50c10pLAoJICAgICAgbnVtUmVhZG9ubHlVbnNpZ25lZEFjY291bnRzOiBidWZmZXJFeHBvcnRzLkJ1ZmZlci5mcm9tKFt0aGlzLmhlYWRlci5udW1SZWFkb25seVVuc2lnbmVkQWNjb3VudHNdKSwKCSAgICAgIGtleUNvdW50OiBidWZmZXJFeHBvcnRzLkJ1ZmZlci5mcm9tKGtleUNvdW50KSwKCSAgICAgIGtleXM6IHRoaXMuYWNjb3VudEtleXMubWFwKGtleSA9PiB0b0J1ZmZlcihrZXkudG9CeXRlcygpKSksCgkgICAgICByZWNlbnRCbG9ja2hhc2g6IGJzNTguZGVjb2RlKHRoaXMucmVjZW50QmxvY2toYXNoKQoJICAgIH07CgkgICAgbGV0IHNpZ25EYXRhID0gYnVmZmVyRXhwb3J0cy5CdWZmZXIuYWxsb2MoMjA0OCk7CgkgICAgY29uc3QgbGVuZ3RoID0gc2lnbkRhdGFMYXlvdXQuZW5jb2RlKHRyYW5zYWN0aW9uLCBzaWduRGF0YSk7CgkgICAgaW5zdHJ1Y3Rpb25CdWZmZXIuY29weShzaWduRGF0YSwgbGVuZ3RoKTsKCSAgICByZXR1cm4gc2lnbkRhdGEuc2xpY2UoMCwgbGVuZ3RoICsgaW5zdHJ1Y3Rpb25CdWZmZXIubGVuZ3RoKTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhIGNvbXBpbGVkIG1lc3NhZ2UgaW50byBhIE1lc3NhZ2Ugb2JqZWN0LgoJICAgKi8KCSAgc3RhdGljIGZyb20oYnVmZmVyKSB7CgkgICAgLy8gU2xpY2UgdXAgd2lyZSBkYXRhCgkgICAgbGV0IGJ5dGVBcnJheSA9IFsuLi5idWZmZXJdOwoJICAgIGNvbnN0IG51bVJlcXVpcmVkU2lnbmF0dXJlcyA9IGd1YXJkZWRTaGlmdChieXRlQXJyYXkpOwoJICAgIGlmIChudW1SZXF1aXJlZFNpZ25hdHVyZXMgIT09IChudW1SZXF1aXJlZFNpZ25hdHVyZXMgJiBWRVJTSU9OX1BSRUZJWF9NQVNLKSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdWZXJzaW9uZWQgbWVzc2FnZXMgbXVzdCBiZSBkZXNlcmlhbGl6ZWQgd2l0aCBWZXJzaW9uZWRNZXNzYWdlLmRlc2VyaWFsaXplKCknKTsKCSAgICB9CgkgICAgY29uc3QgbnVtUmVhZG9ubHlTaWduZWRBY2NvdW50cyA9IGd1YXJkZWRTaGlmdChieXRlQXJyYXkpOwoJICAgIGNvbnN0IG51bVJlYWRvbmx5VW5zaWduZWRBY2NvdW50cyA9IGd1YXJkZWRTaGlmdChieXRlQXJyYXkpOwoJICAgIGNvbnN0IGFjY291bnRDb3VudCA9IGRlY29kZUxlbmd0aChieXRlQXJyYXkpOwoJICAgIGxldCBhY2NvdW50S2V5cyA9IFtdOwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWNjb3VudENvdW50OyBpKyspIHsKCSAgICAgIGNvbnN0IGFjY291bnQgPSBndWFyZGVkU3BsaWNlKGJ5dGVBcnJheSwgMCwgUFVCTElDX0tFWV9MRU5HVEgpOwoJICAgICAgYWNjb3VudEtleXMucHVzaChuZXcgUHVibGljS2V5KGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oYWNjb3VudCkpKTsKCSAgICB9CgkgICAgY29uc3QgcmVjZW50QmxvY2toYXNoID0gZ3VhcmRlZFNwbGljZShieXRlQXJyYXksIDAsIFBVQkxJQ19LRVlfTEVOR1RIKTsKCSAgICBjb25zdCBpbnN0cnVjdGlvbkNvdW50ID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgbGV0IGluc3RydWN0aW9ucyA9IFtdOwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zdHJ1Y3Rpb25Db3VudDsgaSsrKSB7CgkgICAgICBjb25zdCBwcm9ncmFtSWRJbmRleCA9IGd1YXJkZWRTaGlmdChieXRlQXJyYXkpOwoJICAgICAgY29uc3QgYWNjb3VudENvdW50ID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgICBjb25zdCBhY2NvdW50cyA9IGd1YXJkZWRTcGxpY2UoYnl0ZUFycmF5LCAwLCBhY2NvdW50Q291bnQpOwoJICAgICAgY29uc3QgZGF0YUxlbmd0aCA9IGRlY29kZUxlbmd0aChieXRlQXJyYXkpOwoJICAgICAgY29uc3QgZGF0YVNsaWNlID0gZ3VhcmRlZFNwbGljZShieXRlQXJyYXksIDAsIGRhdGFMZW5ndGgpOwoJICAgICAgY29uc3QgZGF0YSA9IGJzNTguZW5jb2RlKGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oZGF0YVNsaWNlKSk7CgkgICAgICBpbnN0cnVjdGlvbnMucHVzaCh7CgkgICAgICAgIHByb2dyYW1JZEluZGV4LAoJICAgICAgICBhY2NvdW50cywKCSAgICAgICAgZGF0YQoJICAgICAgfSk7CgkgICAgfQoJICAgIGNvbnN0IG1lc3NhZ2VBcmdzID0gewoJICAgICAgaGVhZGVyOiB7CgkgICAgICAgIG51bVJlcXVpcmVkU2lnbmF0dXJlcywKCSAgICAgICAgbnVtUmVhZG9ubHlTaWduZWRBY2NvdW50cywKCSAgICAgICAgbnVtUmVhZG9ubHlVbnNpZ25lZEFjY291bnRzCgkgICAgICB9LAoJICAgICAgcmVjZW50QmxvY2toYXNoOiBiczU4LmVuY29kZShidWZmZXJFeHBvcnRzLkJ1ZmZlci5mcm9tKHJlY2VudEJsb2NraGFzaCkpLAoJICAgICAgYWNjb3VudEtleXMsCgkgICAgICBpbnN0cnVjdGlvbnMKCSAgICB9OwoJICAgIHJldHVybiBuZXcgTWVzc2FnZShtZXNzYWdlQXJncyk7CgkgIH0KCX0KCgkvKioKCSAqIE1lc3NhZ2UgY29uc3RydWN0b3IgYXJndW1lbnRzCgkgKi8KCgljbGFzcyBNZXNzYWdlVjAgewoJICBjb25zdHJ1Y3RvcihhcmdzKSB7CgkgICAgdGhpcy5oZWFkZXIgPSB2b2lkIDA7CgkgICAgdGhpcy5zdGF0aWNBY2NvdW50S2V5cyA9IHZvaWQgMDsKCSAgICB0aGlzLnJlY2VudEJsb2NraGFzaCA9IHZvaWQgMDsKCSAgICB0aGlzLmNvbXBpbGVkSW5zdHJ1Y3Rpb25zID0gdm9pZCAwOwoJICAgIHRoaXMuYWRkcmVzc1RhYmxlTG9va3VwcyA9IHZvaWQgMDsKCSAgICB0aGlzLmhlYWRlciA9IGFyZ3MuaGVhZGVyOwoJICAgIHRoaXMuc3RhdGljQWNjb3VudEtleXMgPSBhcmdzLnN0YXRpY0FjY291bnRLZXlzOwoJICAgIHRoaXMucmVjZW50QmxvY2toYXNoID0gYXJncy5yZWNlbnRCbG9ja2hhc2g7CgkgICAgdGhpcy5jb21waWxlZEluc3RydWN0aW9ucyA9IGFyZ3MuY29tcGlsZWRJbnN0cnVjdGlvbnM7CgkgICAgdGhpcy5hZGRyZXNzVGFibGVMb29rdXBzID0gYXJncy5hZGRyZXNzVGFibGVMb29rdXBzOwoJICB9CgkgIGdldCB2ZXJzaW9uKCkgewoJICAgIHJldHVybiAwOwoJICB9CgkgIGdldCBudW1BY2NvdW50S2V5c0Zyb21Mb29rdXBzKCkgewoJICAgIGxldCBjb3VudCA9IDA7CgkgICAgZm9yIChjb25zdCBsb29rdXAgb2YgdGhpcy5hZGRyZXNzVGFibGVMb29rdXBzKSB7CgkgICAgICBjb3VudCArPSBsb29rdXAucmVhZG9ubHlJbmRleGVzLmxlbmd0aCArIGxvb2t1cC53cml0YWJsZUluZGV4ZXMubGVuZ3RoOwoJICAgIH0KCSAgICByZXR1cm4gY291bnQ7CgkgIH0KCSAgZ2V0QWNjb3VudEtleXMoYXJncykgewoJICAgIGxldCBhY2NvdW50S2V5c0Zyb21Mb29rdXBzOwoJICAgIGlmIChhcmdzICYmICdhY2NvdW50S2V5c0Zyb21Mb29rdXBzJyBpbiBhcmdzICYmIGFyZ3MuYWNjb3VudEtleXNGcm9tTG9va3VwcykgewoJICAgICAgaWYgKHRoaXMubnVtQWNjb3VudEtleXNGcm9tTG9va3VwcyAhPSBhcmdzLmFjY291bnRLZXlzRnJvbUxvb2t1cHMud3JpdGFibGUubGVuZ3RoICsgYXJncy5hY2NvdW50S2V5c0Zyb21Mb29rdXBzLnJlYWRvbmx5Lmxlbmd0aCkgewoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBnZXQgYWNjb3VudCBrZXlzIGJlY2F1c2Ugb2YgYSBtaXNtYXRjaCBpbiB0aGUgbnVtYmVyIG9mIGFjY291bnQga2V5cyBmcm9tIGxvb2t1cHMnKTsKCSAgICAgIH0KCSAgICAgIGFjY291bnRLZXlzRnJvbUxvb2t1cHMgPSBhcmdzLmFjY291bnRLZXlzRnJvbUxvb2t1cHM7CgkgICAgfSBlbHNlIGlmIChhcmdzICYmICdhZGRyZXNzTG9va3VwVGFibGVBY2NvdW50cycgaW4gYXJncyAmJiBhcmdzLmFkZHJlc3NMb29rdXBUYWJsZUFjY291bnRzKSB7CgkgICAgICBhY2NvdW50S2V5c0Zyb21Mb29rdXBzID0gdGhpcy5yZXNvbHZlQWRkcmVzc1RhYmxlTG9va3VwcyhhcmdzLmFkZHJlc3NMb29rdXBUYWJsZUFjY291bnRzKTsKCSAgICB9IGVsc2UgaWYgKHRoaXMuYWRkcmVzc1RhYmxlTG9va3Vwcy5sZW5ndGggPiAwKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBnZXQgYWNjb3VudCBrZXlzIGJlY2F1c2UgYWRkcmVzcyB0YWJsZSBsb29rdXBzIHdlcmUgbm90IHJlc29sdmVkJyk7CgkgICAgfQoJICAgIHJldHVybiBuZXcgTWVzc2FnZUFjY291bnRLZXlzKHRoaXMuc3RhdGljQWNjb3VudEtleXMsIGFjY291bnRLZXlzRnJvbUxvb2t1cHMpOwoJICB9CgkgIGlzQWNjb3VudFNpZ25lcihpbmRleCkgewoJICAgIHJldHVybiBpbmRleCA8IHRoaXMuaGVhZGVyLm51bVJlcXVpcmVkU2lnbmF0dXJlczsKCSAgfQoJICBpc0FjY291bnRXcml0YWJsZShpbmRleCkgewoJICAgIGNvbnN0IG51bVNpZ25lZEFjY291bnRzID0gdGhpcy5oZWFkZXIubnVtUmVxdWlyZWRTaWduYXR1cmVzOwoJICAgIGNvbnN0IG51bVN0YXRpY0FjY291bnRLZXlzID0gdGhpcy5zdGF0aWNBY2NvdW50S2V5cy5sZW5ndGg7CgkgICAgaWYgKGluZGV4ID49IG51bVN0YXRpY0FjY291bnRLZXlzKSB7CgkgICAgICBjb25zdCBsb29rdXBBY2NvdW50S2V5c0luZGV4ID0gaW5kZXggLSBudW1TdGF0aWNBY2NvdW50S2V5czsKCSAgICAgIGNvbnN0IG51bVdyaXRhYmxlTG9va3VwQWNjb3VudEtleXMgPSB0aGlzLmFkZHJlc3NUYWJsZUxvb2t1cHMucmVkdWNlKChjb3VudCwgbG9va3VwKSA9PiBjb3VudCArIGxvb2t1cC53cml0YWJsZUluZGV4ZXMubGVuZ3RoLCAwKTsKCSAgICAgIHJldHVybiBsb29rdXBBY2NvdW50S2V5c0luZGV4IDwgbnVtV3JpdGFibGVMb29rdXBBY2NvdW50S2V5czsKCSAgICB9IGVsc2UgaWYgKGluZGV4ID49IHRoaXMuaGVhZGVyLm51bVJlcXVpcmVkU2lnbmF0dXJlcykgewoJICAgICAgY29uc3QgdW5zaWduZWRBY2NvdW50SW5kZXggPSBpbmRleCAtIG51bVNpZ25lZEFjY291bnRzOwoJICAgICAgY29uc3QgbnVtVW5zaWduZWRBY2NvdW50cyA9IG51bVN0YXRpY0FjY291bnRLZXlzIC0gbnVtU2lnbmVkQWNjb3VudHM7CgkgICAgICBjb25zdCBudW1Xcml0YWJsZVVuc2lnbmVkQWNjb3VudHMgPSBudW1VbnNpZ25lZEFjY291bnRzIC0gdGhpcy5oZWFkZXIubnVtUmVhZG9ubHlVbnNpZ25lZEFjY291bnRzOwoJICAgICAgcmV0dXJuIHVuc2lnbmVkQWNjb3VudEluZGV4IDwgbnVtV3JpdGFibGVVbnNpZ25lZEFjY291bnRzOwoJICAgIH0gZWxzZSB7CgkgICAgICBjb25zdCBudW1Xcml0YWJsZVNpZ25lZEFjY291bnRzID0gbnVtU2lnbmVkQWNjb3VudHMgLSB0aGlzLmhlYWRlci5udW1SZWFkb25seVNpZ25lZEFjY291bnRzOwoJICAgICAgcmV0dXJuIGluZGV4IDwgbnVtV3JpdGFibGVTaWduZWRBY2NvdW50czsKCSAgICB9CgkgIH0KCSAgcmVzb2x2ZUFkZHJlc3NUYWJsZUxvb2t1cHMoYWRkcmVzc0xvb2t1cFRhYmxlQWNjb3VudHMpIHsKCSAgICBjb25zdCBhY2NvdW50S2V5c0Zyb21Mb29rdXBzID0gewoJICAgICAgd3JpdGFibGU6IFtdLAoJICAgICAgcmVhZG9ubHk6IFtdCgkgICAgfTsKCSAgICBmb3IgKGNvbnN0IHRhYmxlTG9va3VwIG9mIHRoaXMuYWRkcmVzc1RhYmxlTG9va3VwcykgewoJICAgICAgY29uc3QgdGFibGVBY2NvdW50ID0gYWRkcmVzc0xvb2t1cFRhYmxlQWNjb3VudHMuZmluZChhY2NvdW50ID0+IGFjY291bnQua2V5LmVxdWFscyh0YWJsZUxvb2t1cC5hY2NvdW50S2V5KSk7CgkgICAgICBpZiAoIXRhYmxlQWNjb3VudCkgewoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBmaW5kIGFkZHJlc3MgbG9va3VwIHRhYmxlIGFjY291bnQgZm9yIHRhYmxlIGtleSAke3RhYmxlTG9va3VwLmFjY291bnRLZXkudG9CYXNlNTgoKX1gKTsKCSAgICAgIH0KCSAgICAgIGZvciAoY29uc3QgaW5kZXggb2YgdGFibGVMb29rdXAud3JpdGFibGVJbmRleGVzKSB7CgkgICAgICAgIGlmIChpbmRleCA8IHRhYmxlQWNjb3VudC5zdGF0ZS5hZGRyZXNzZXMubGVuZ3RoKSB7CgkgICAgICAgICAgYWNjb3VudEtleXNGcm9tTG9va3Vwcy53cml0YWJsZS5wdXNoKHRhYmxlQWNjb3VudC5zdGF0ZS5hZGRyZXNzZXNbaW5kZXhdKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBmaW5kIGFkZHJlc3MgZm9yIGluZGV4ICR7aW5kZXh9IGluIGFkZHJlc3MgbG9va3VwIHRhYmxlICR7dGFibGVMb29rdXAuYWNjb3VudEtleS50b0Jhc2U1OCgpfWApOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICBmb3IgKGNvbnN0IGluZGV4IG9mIHRhYmxlTG9va3VwLnJlYWRvbmx5SW5kZXhlcykgewoJICAgICAgICBpZiAoaW5kZXggPCB0YWJsZUFjY291bnQuc3RhdGUuYWRkcmVzc2VzLmxlbmd0aCkgewoJICAgICAgICAgIGFjY291bnRLZXlzRnJvbUxvb2t1cHMucmVhZG9ubHkucHVzaCh0YWJsZUFjY291bnQuc3RhdGUuYWRkcmVzc2VzW2luZGV4XSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZmluZCBhZGRyZXNzIGZvciBpbmRleCAke2luZGV4fSBpbiBhZGRyZXNzIGxvb2t1cCB0YWJsZSAke3RhYmxlTG9va3VwLmFjY291bnRLZXkudG9CYXNlNTgoKX1gKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gYWNjb3VudEtleXNGcm9tTG9va3VwczsKCSAgfQoJICBzdGF0aWMgY29tcGlsZShhcmdzKSB7CgkgICAgY29uc3QgY29tcGlsZWRLZXlzID0gQ29tcGlsZWRLZXlzLmNvbXBpbGUoYXJncy5pbnN0cnVjdGlvbnMsIGFyZ3MucGF5ZXJLZXkpOwoJICAgIGNvbnN0IGFkZHJlc3NUYWJsZUxvb2t1cHMgPSBuZXcgQXJyYXkoKTsKCSAgICBjb25zdCBhY2NvdW50S2V5c0Zyb21Mb29rdXBzID0gewoJICAgICAgd3JpdGFibGU6IG5ldyBBcnJheSgpLAoJICAgICAgcmVhZG9ubHk6IG5ldyBBcnJheSgpCgkgICAgfTsKCSAgICBjb25zdCBsb29rdXBUYWJsZUFjY291bnRzID0gYXJncy5hZGRyZXNzTG9va3VwVGFibGVBY2NvdW50cyB8fCBbXTsKCSAgICBmb3IgKGNvbnN0IGxvb2t1cFRhYmxlIG9mIGxvb2t1cFRhYmxlQWNjb3VudHMpIHsKCSAgICAgIGNvbnN0IGV4dHJhY3RSZXN1bHQgPSBjb21waWxlZEtleXMuZXh0cmFjdFRhYmxlTG9va3VwKGxvb2t1cFRhYmxlKTsKCSAgICAgIGlmIChleHRyYWN0UmVzdWx0ICE9PSB1bmRlZmluZWQpIHsKCSAgICAgICAgY29uc3QgW2FkZHJlc3NUYWJsZUxvb2t1cCwgewoJICAgICAgICAgIHdyaXRhYmxlLAoJICAgICAgICAgIHJlYWRvbmx5CgkgICAgICAgIH1dID0gZXh0cmFjdFJlc3VsdDsKCSAgICAgICAgYWRkcmVzc1RhYmxlTG9va3Vwcy5wdXNoKGFkZHJlc3NUYWJsZUxvb2t1cCk7CgkgICAgICAgIGFjY291bnRLZXlzRnJvbUxvb2t1cHMud3JpdGFibGUucHVzaCguLi53cml0YWJsZSk7CgkgICAgICAgIGFjY291bnRLZXlzRnJvbUxvb2t1cHMucmVhZG9ubHkucHVzaCguLi5yZWFkb25seSk7CgkgICAgICB9CgkgICAgfQoJICAgIGNvbnN0IFtoZWFkZXIsIHN0YXRpY0FjY291bnRLZXlzXSA9IGNvbXBpbGVkS2V5cy5nZXRNZXNzYWdlQ29tcG9uZW50cygpOwoJICAgIGNvbnN0IGFjY291bnRLZXlzID0gbmV3IE1lc3NhZ2VBY2NvdW50S2V5cyhzdGF0aWNBY2NvdW50S2V5cywgYWNjb3VudEtleXNGcm9tTG9va3Vwcyk7CgkgICAgY29uc3QgY29tcGlsZWRJbnN0cnVjdGlvbnMgPSBhY2NvdW50S2V5cy5jb21waWxlSW5zdHJ1Y3Rpb25zKGFyZ3MuaW5zdHJ1Y3Rpb25zKTsKCSAgICByZXR1cm4gbmV3IE1lc3NhZ2VWMCh7CgkgICAgICBoZWFkZXIsCgkgICAgICBzdGF0aWNBY2NvdW50S2V5cywKCSAgICAgIHJlY2VudEJsb2NraGFzaDogYXJncy5yZWNlbnRCbG9ja2hhc2gsCgkgICAgICBjb21waWxlZEluc3RydWN0aW9ucywKCSAgICAgIGFkZHJlc3NUYWJsZUxvb2t1cHMKCSAgICB9KTsKCSAgfQoJICBzZXJpYWxpemUoKSB7CgkgICAgY29uc3QgZW5jb2RlZFN0YXRpY0FjY291bnRLZXlzTGVuZ3RoID0gQXJyYXkoKTsKCSAgICBlbmNvZGVMZW5ndGgoZW5jb2RlZFN0YXRpY0FjY291bnRLZXlzTGVuZ3RoLCB0aGlzLnN0YXRpY0FjY291bnRLZXlzLmxlbmd0aCk7CgkgICAgY29uc3Qgc2VyaWFsaXplZEluc3RydWN0aW9ucyA9IHRoaXMuc2VyaWFsaXplSW5zdHJ1Y3Rpb25zKCk7CgkgICAgY29uc3QgZW5jb2RlZEluc3RydWN0aW9uc0xlbmd0aCA9IEFycmF5KCk7CgkgICAgZW5jb2RlTGVuZ3RoKGVuY29kZWRJbnN0cnVjdGlvbnNMZW5ndGgsIHRoaXMuY29tcGlsZWRJbnN0cnVjdGlvbnMubGVuZ3RoKTsKCSAgICBjb25zdCBzZXJpYWxpemVkQWRkcmVzc1RhYmxlTG9va3VwcyA9IHRoaXMuc2VyaWFsaXplQWRkcmVzc1RhYmxlTG9va3VwcygpOwoJICAgIGNvbnN0IGVuY29kZWRBZGRyZXNzVGFibGVMb29rdXBzTGVuZ3RoID0gQXJyYXkoKTsKCSAgICBlbmNvZGVMZW5ndGgoZW5jb2RlZEFkZHJlc3NUYWJsZUxvb2t1cHNMZW5ndGgsIHRoaXMuYWRkcmVzc1RhYmxlTG9va3Vwcy5sZW5ndGgpOwoJICAgIGNvbnN0IG1lc3NhZ2VMYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51OCgncHJlZml4JyksIExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnU4KCdudW1SZXF1aXJlZFNpZ25hdHVyZXMnKSwgTGF5b3V0RXhwb3J0cy51OCgnbnVtUmVhZG9ubHlTaWduZWRBY2NvdW50cycpLCBMYXlvdXRFeHBvcnRzLnU4KCdudW1SZWFkb25seVVuc2lnbmVkQWNjb3VudHMnKV0sICdoZWFkZXInKSwgTGF5b3V0RXhwb3J0cy5ibG9iKGVuY29kZWRTdGF0aWNBY2NvdW50S2V5c0xlbmd0aC5sZW5ndGgsICdzdGF0aWNBY2NvdW50S2V5c0xlbmd0aCcpLCBMYXlvdXRFeHBvcnRzLnNlcShwdWJsaWNLZXkoKSwgdGhpcy5zdGF0aWNBY2NvdW50S2V5cy5sZW5ndGgsICdzdGF0aWNBY2NvdW50S2V5cycpLCBwdWJsaWNLZXkoJ3JlY2VudEJsb2NraGFzaCcpLCBMYXlvdXRFeHBvcnRzLmJsb2IoZW5jb2RlZEluc3RydWN0aW9uc0xlbmd0aC5sZW5ndGgsICdpbnN0cnVjdGlvbnNMZW5ndGgnKSwgTGF5b3V0RXhwb3J0cy5ibG9iKHNlcmlhbGl6ZWRJbnN0cnVjdGlvbnMubGVuZ3RoLCAnc2VyaWFsaXplZEluc3RydWN0aW9ucycpLCBMYXlvdXRFeHBvcnRzLmJsb2IoZW5jb2RlZEFkZHJlc3NUYWJsZUxvb2t1cHNMZW5ndGgubGVuZ3RoLCAnYWRkcmVzc1RhYmxlTG9va3Vwc0xlbmd0aCcpLCBMYXlvdXRFeHBvcnRzLmJsb2Ioc2VyaWFsaXplZEFkZHJlc3NUYWJsZUxvb2t1cHMubGVuZ3RoLCAnc2VyaWFsaXplZEFkZHJlc3NUYWJsZUxvb2t1cHMnKV0pOwoJICAgIGNvbnN0IHNlcmlhbGl6ZWRNZXNzYWdlID0gbmV3IFVpbnQ4QXJyYXkoUEFDS0VUX0RBVEFfU0laRSk7CgkgICAgY29uc3QgTUVTU0FHRV9WRVJTSU9OXzBfUFJFRklYID0gMSA8PCA3OwoJICAgIGNvbnN0IHNlcmlhbGl6ZWRNZXNzYWdlTGVuZ3RoID0gbWVzc2FnZUxheW91dC5lbmNvZGUoewoJICAgICAgcHJlZml4OiBNRVNTQUdFX1ZFUlNJT05fMF9QUkVGSVgsCgkgICAgICBoZWFkZXI6IHRoaXMuaGVhZGVyLAoJICAgICAgc3RhdGljQWNjb3VudEtleXNMZW5ndGg6IG5ldyBVaW50OEFycmF5KGVuY29kZWRTdGF0aWNBY2NvdW50S2V5c0xlbmd0aCksCgkgICAgICBzdGF0aWNBY2NvdW50S2V5czogdGhpcy5zdGF0aWNBY2NvdW50S2V5cy5tYXAoa2V5ID0+IGtleS50b0J5dGVzKCkpLAoJICAgICAgcmVjZW50QmxvY2toYXNoOiBiczU4LmRlY29kZSh0aGlzLnJlY2VudEJsb2NraGFzaCksCgkgICAgICBpbnN0cnVjdGlvbnNMZW5ndGg6IG5ldyBVaW50OEFycmF5KGVuY29kZWRJbnN0cnVjdGlvbnNMZW5ndGgpLAoJICAgICAgc2VyaWFsaXplZEluc3RydWN0aW9ucywKCSAgICAgIGFkZHJlc3NUYWJsZUxvb2t1cHNMZW5ndGg6IG5ldyBVaW50OEFycmF5KGVuY29kZWRBZGRyZXNzVGFibGVMb29rdXBzTGVuZ3RoKSwKCSAgICAgIHNlcmlhbGl6ZWRBZGRyZXNzVGFibGVMb29rdXBzCgkgICAgfSwgc2VyaWFsaXplZE1lc3NhZ2UpOwoJICAgIHJldHVybiBzZXJpYWxpemVkTWVzc2FnZS5zbGljZSgwLCBzZXJpYWxpemVkTWVzc2FnZUxlbmd0aCk7CgkgIH0KCSAgc2VyaWFsaXplSW5zdHJ1Y3Rpb25zKCkgewoJICAgIGxldCBzZXJpYWxpemVkTGVuZ3RoID0gMDsKCSAgICBjb25zdCBzZXJpYWxpemVkSW5zdHJ1Y3Rpb25zID0gbmV3IFVpbnQ4QXJyYXkoUEFDS0VUX0RBVEFfU0laRSk7CgkgICAgZm9yIChjb25zdCBpbnN0cnVjdGlvbiBvZiB0aGlzLmNvbXBpbGVkSW5zdHJ1Y3Rpb25zKSB7CgkgICAgICBjb25zdCBlbmNvZGVkQWNjb3VudEtleUluZGV4ZXNMZW5ndGggPSBBcnJheSgpOwoJICAgICAgZW5jb2RlTGVuZ3RoKGVuY29kZWRBY2NvdW50S2V5SW5kZXhlc0xlbmd0aCwgaW5zdHJ1Y3Rpb24uYWNjb3VudEtleUluZGV4ZXMubGVuZ3RoKTsKCSAgICAgIGNvbnN0IGVuY29kZWREYXRhTGVuZ3RoID0gQXJyYXkoKTsKCSAgICAgIGVuY29kZUxlbmd0aChlbmNvZGVkRGF0YUxlbmd0aCwgaW5zdHJ1Y3Rpb24uZGF0YS5sZW5ndGgpOwoJICAgICAgY29uc3QgaW5zdHJ1Y3Rpb25MYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51OCgncHJvZ3JhbUlkSW5kZXgnKSwgTGF5b3V0RXhwb3J0cy5ibG9iKGVuY29kZWRBY2NvdW50S2V5SW5kZXhlc0xlbmd0aC5sZW5ndGgsICdlbmNvZGVkQWNjb3VudEtleUluZGV4ZXNMZW5ndGgnKSwgTGF5b3V0RXhwb3J0cy5zZXEoTGF5b3V0RXhwb3J0cy51OCgpLCBpbnN0cnVjdGlvbi5hY2NvdW50S2V5SW5kZXhlcy5sZW5ndGgsICdhY2NvdW50S2V5SW5kZXhlcycpLCBMYXlvdXRFeHBvcnRzLmJsb2IoZW5jb2RlZERhdGFMZW5ndGgubGVuZ3RoLCAnZW5jb2RlZERhdGFMZW5ndGgnKSwgTGF5b3V0RXhwb3J0cy5ibG9iKGluc3RydWN0aW9uLmRhdGEubGVuZ3RoLCAnZGF0YScpXSk7CgkgICAgICBzZXJpYWxpemVkTGVuZ3RoICs9IGluc3RydWN0aW9uTGF5b3V0LmVuY29kZSh7CgkgICAgICAgIHByb2dyYW1JZEluZGV4OiBpbnN0cnVjdGlvbi5wcm9ncmFtSWRJbmRleCwKCSAgICAgICAgZW5jb2RlZEFjY291bnRLZXlJbmRleGVzTGVuZ3RoOiBuZXcgVWludDhBcnJheShlbmNvZGVkQWNjb3VudEtleUluZGV4ZXNMZW5ndGgpLAoJICAgICAgICBhY2NvdW50S2V5SW5kZXhlczogaW5zdHJ1Y3Rpb24uYWNjb3VudEtleUluZGV4ZXMsCgkgICAgICAgIGVuY29kZWREYXRhTGVuZ3RoOiBuZXcgVWludDhBcnJheShlbmNvZGVkRGF0YUxlbmd0aCksCgkgICAgICAgIGRhdGE6IGluc3RydWN0aW9uLmRhdGEKCSAgICAgIH0sIHNlcmlhbGl6ZWRJbnN0cnVjdGlvbnMsIHNlcmlhbGl6ZWRMZW5ndGgpOwoJICAgIH0KCSAgICByZXR1cm4gc2VyaWFsaXplZEluc3RydWN0aW9ucy5zbGljZSgwLCBzZXJpYWxpemVkTGVuZ3RoKTsKCSAgfQoJICBzZXJpYWxpemVBZGRyZXNzVGFibGVMb29rdXBzKCkgewoJICAgIGxldCBzZXJpYWxpemVkTGVuZ3RoID0gMDsKCSAgICBjb25zdCBzZXJpYWxpemVkQWRkcmVzc1RhYmxlTG9va3VwcyA9IG5ldyBVaW50OEFycmF5KFBBQ0tFVF9EQVRBX1NJWkUpOwoJICAgIGZvciAoY29uc3QgbG9va3VwIG9mIHRoaXMuYWRkcmVzc1RhYmxlTG9va3VwcykgewoJICAgICAgY29uc3QgZW5jb2RlZFdyaXRhYmxlSW5kZXhlc0xlbmd0aCA9IEFycmF5KCk7CgkgICAgICBlbmNvZGVMZW5ndGgoZW5jb2RlZFdyaXRhYmxlSW5kZXhlc0xlbmd0aCwgbG9va3VwLndyaXRhYmxlSW5kZXhlcy5sZW5ndGgpOwoJICAgICAgY29uc3QgZW5jb2RlZFJlYWRvbmx5SW5kZXhlc0xlbmd0aCA9IEFycmF5KCk7CgkgICAgICBlbmNvZGVMZW5ndGgoZW5jb2RlZFJlYWRvbmx5SW5kZXhlc0xlbmd0aCwgbG9va3VwLnJlYWRvbmx5SW5kZXhlcy5sZW5ndGgpOwoJICAgICAgY29uc3QgYWRkcmVzc1RhYmxlTG9va3VwTGF5b3V0ID0gTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW3B1YmxpY0tleSgnYWNjb3VudEtleScpLCBMYXlvdXRFeHBvcnRzLmJsb2IoZW5jb2RlZFdyaXRhYmxlSW5kZXhlc0xlbmd0aC5sZW5ndGgsICdlbmNvZGVkV3JpdGFibGVJbmRleGVzTGVuZ3RoJyksIExheW91dEV4cG9ydHMuc2VxKExheW91dEV4cG9ydHMudTgoKSwgbG9va3VwLndyaXRhYmxlSW5kZXhlcy5sZW5ndGgsICd3cml0YWJsZUluZGV4ZXMnKSwgTGF5b3V0RXhwb3J0cy5ibG9iKGVuY29kZWRSZWFkb25seUluZGV4ZXNMZW5ndGgubGVuZ3RoLCAnZW5jb2RlZFJlYWRvbmx5SW5kZXhlc0xlbmd0aCcpLCBMYXlvdXRFeHBvcnRzLnNlcShMYXlvdXRFeHBvcnRzLnU4KCksIGxvb2t1cC5yZWFkb25seUluZGV4ZXMubGVuZ3RoLCAncmVhZG9ubHlJbmRleGVzJyldKTsKCSAgICAgIHNlcmlhbGl6ZWRMZW5ndGggKz0gYWRkcmVzc1RhYmxlTG9va3VwTGF5b3V0LmVuY29kZSh7CgkgICAgICAgIGFjY291bnRLZXk6IGxvb2t1cC5hY2NvdW50S2V5LnRvQnl0ZXMoKSwKCSAgICAgICAgZW5jb2RlZFdyaXRhYmxlSW5kZXhlc0xlbmd0aDogbmV3IFVpbnQ4QXJyYXkoZW5jb2RlZFdyaXRhYmxlSW5kZXhlc0xlbmd0aCksCgkgICAgICAgIHdyaXRhYmxlSW5kZXhlczogbG9va3VwLndyaXRhYmxlSW5kZXhlcywKCSAgICAgICAgZW5jb2RlZFJlYWRvbmx5SW5kZXhlc0xlbmd0aDogbmV3IFVpbnQ4QXJyYXkoZW5jb2RlZFJlYWRvbmx5SW5kZXhlc0xlbmd0aCksCgkgICAgICAgIHJlYWRvbmx5SW5kZXhlczogbG9va3VwLnJlYWRvbmx5SW5kZXhlcwoJICAgICAgfSwgc2VyaWFsaXplZEFkZHJlc3NUYWJsZUxvb2t1cHMsIHNlcmlhbGl6ZWRMZW5ndGgpOwoJICAgIH0KCSAgICByZXR1cm4gc2VyaWFsaXplZEFkZHJlc3NUYWJsZUxvb2t1cHMuc2xpY2UoMCwgc2VyaWFsaXplZExlbmd0aCk7CgkgIH0KCSAgc3RhdGljIGRlc2VyaWFsaXplKHNlcmlhbGl6ZWRNZXNzYWdlKSB7CgkgICAgbGV0IGJ5dGVBcnJheSA9IFsuLi5zZXJpYWxpemVkTWVzc2FnZV07CgkgICAgY29uc3QgcHJlZml4ID0gZ3VhcmRlZFNoaWZ0KGJ5dGVBcnJheSk7CgkgICAgY29uc3QgbWFza2VkUHJlZml4ID0gcHJlZml4ICYgVkVSU0lPTl9QUkVGSVhfTUFTSzsKCSAgICBhc3NlcnQkMShwcmVmaXggIT09IG1hc2tlZFByZWZpeCwgYEV4cGVjdGVkIHZlcnNpb25lZCBtZXNzYWdlIGJ1dCByZWNlaXZlZCBsZWdhY3kgbWVzc2FnZWApOwoJICAgIGNvbnN0IHZlcnNpb24gPSBtYXNrZWRQcmVmaXg7CgkgICAgYXNzZXJ0JDEodmVyc2lvbiA9PT0gMCwgYEV4cGVjdGVkIHZlcnNpb25lZCBtZXNzYWdlIHdpdGggdmVyc2lvbiAwIGJ1dCBmb3VuZCB2ZXJzaW9uICR7dmVyc2lvbn1gKTsKCSAgICBjb25zdCBoZWFkZXIgPSB7CgkgICAgICBudW1SZXF1aXJlZFNpZ25hdHVyZXM6IGd1YXJkZWRTaGlmdChieXRlQXJyYXkpLAoJICAgICAgbnVtUmVhZG9ubHlTaWduZWRBY2NvdW50czogZ3VhcmRlZFNoaWZ0KGJ5dGVBcnJheSksCgkgICAgICBudW1SZWFkb25seVVuc2lnbmVkQWNjb3VudHM6IGd1YXJkZWRTaGlmdChieXRlQXJyYXkpCgkgICAgfTsKCSAgICBjb25zdCBzdGF0aWNBY2NvdW50S2V5cyA9IFtdOwoJICAgIGNvbnN0IHN0YXRpY0FjY291bnRLZXlzTGVuZ3RoID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGF0aWNBY2NvdW50S2V5c0xlbmd0aDsgaSsrKSB7CgkgICAgICBzdGF0aWNBY2NvdW50S2V5cy5wdXNoKG5ldyBQdWJsaWNLZXkoZ3VhcmRlZFNwbGljZShieXRlQXJyYXksIDAsIFBVQkxJQ19LRVlfTEVOR1RIKSkpOwoJICAgIH0KCSAgICBjb25zdCByZWNlbnRCbG9ja2hhc2ggPSBiczU4LmVuY29kZShndWFyZGVkU3BsaWNlKGJ5dGVBcnJheSwgMCwgUFVCTElDX0tFWV9MRU5HVEgpKTsKCSAgICBjb25zdCBpbnN0cnVjdGlvbkNvdW50ID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgY29uc3QgY29tcGlsZWRJbnN0cnVjdGlvbnMgPSBbXTsKCSAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluc3RydWN0aW9uQ291bnQ7IGkrKykgewoJICAgICAgY29uc3QgcHJvZ3JhbUlkSW5kZXggPSBndWFyZGVkU2hpZnQoYnl0ZUFycmF5KTsKCSAgICAgIGNvbnN0IGFjY291bnRLZXlJbmRleGVzTGVuZ3RoID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgICBjb25zdCBhY2NvdW50S2V5SW5kZXhlcyA9IGd1YXJkZWRTcGxpY2UoYnl0ZUFycmF5LCAwLCBhY2NvdW50S2V5SW5kZXhlc0xlbmd0aCk7CgkgICAgICBjb25zdCBkYXRhTGVuZ3RoID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgICBjb25zdCBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoZ3VhcmRlZFNwbGljZShieXRlQXJyYXksIDAsIGRhdGFMZW5ndGgpKTsKCSAgICAgIGNvbXBpbGVkSW5zdHJ1Y3Rpb25zLnB1c2goewoJICAgICAgICBwcm9ncmFtSWRJbmRleCwKCSAgICAgICAgYWNjb3VudEtleUluZGV4ZXMsCgkgICAgICAgIGRhdGEKCSAgICAgIH0pOwoJICAgIH0KCSAgICBjb25zdCBhZGRyZXNzVGFibGVMb29rdXBzQ291bnQgPSBkZWNvZGVMZW5ndGgoYnl0ZUFycmF5KTsKCSAgICBjb25zdCBhZGRyZXNzVGFibGVMb29rdXBzID0gW107CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhZGRyZXNzVGFibGVMb29rdXBzQ291bnQ7IGkrKykgewoJICAgICAgY29uc3QgYWNjb3VudEtleSA9IG5ldyBQdWJsaWNLZXkoZ3VhcmRlZFNwbGljZShieXRlQXJyYXksIDAsIFBVQkxJQ19LRVlfTEVOR1RIKSk7CgkgICAgICBjb25zdCB3cml0YWJsZUluZGV4ZXNMZW5ndGggPSBkZWNvZGVMZW5ndGgoYnl0ZUFycmF5KTsKCSAgICAgIGNvbnN0IHdyaXRhYmxlSW5kZXhlcyA9IGd1YXJkZWRTcGxpY2UoYnl0ZUFycmF5LCAwLCB3cml0YWJsZUluZGV4ZXNMZW5ndGgpOwoJICAgICAgY29uc3QgcmVhZG9ubHlJbmRleGVzTGVuZ3RoID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgICBjb25zdCByZWFkb25seUluZGV4ZXMgPSBndWFyZGVkU3BsaWNlKGJ5dGVBcnJheSwgMCwgcmVhZG9ubHlJbmRleGVzTGVuZ3RoKTsKCSAgICAgIGFkZHJlc3NUYWJsZUxvb2t1cHMucHVzaCh7CgkgICAgICAgIGFjY291bnRLZXksCgkgICAgICAgIHdyaXRhYmxlSW5kZXhlcywKCSAgICAgICAgcmVhZG9ubHlJbmRleGVzCgkgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIG5ldyBNZXNzYWdlVjAoewoJICAgICAgaGVhZGVyLAoJICAgICAgc3RhdGljQWNjb3VudEtleXMsCgkgICAgICByZWNlbnRCbG9ja2hhc2gsCgkgICAgICBjb21waWxlZEluc3RydWN0aW9ucywKCSAgICAgIGFkZHJlc3NUYWJsZUxvb2t1cHMKCSAgICB9KTsKCSAgfQoJfQoKCS8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZWRlY2xhcmUKCWNvbnN0IFZlcnNpb25lZE1lc3NhZ2UgPSB7CgkgIGRlc2VyaWFsaXplTWVzc2FnZVZlcnNpb24oc2VyaWFsaXplZE1lc3NhZ2UpIHsKCSAgICBjb25zdCBwcmVmaXggPSBzZXJpYWxpemVkTWVzc2FnZVswXTsKCSAgICBjb25zdCBtYXNrZWRQcmVmaXggPSBwcmVmaXggJiBWRVJTSU9OX1BSRUZJWF9NQVNLOwoKCSAgICAvLyBpZiB0aGUgaGlnaGVzdCBiaXQgb2YgdGhlIHByZWZpeCBpcyBub3Qgc2V0LCB0aGUgbWVzc2FnZSBpcyBub3QgdmVyc2lvbmVkCgkgICAgaWYgKG1hc2tlZFByZWZpeCA9PT0gcHJlZml4KSB7CgkgICAgICByZXR1cm4gJ2xlZ2FjeSc7CgkgICAgfQoKCSAgICAvLyB0aGUgbG93ZXIgNyBiaXRzIG9mIHRoZSBwcmVmaXggaW5kaWNhdGUgdGhlIG1lc3NhZ2UgdmVyc2lvbgoJICAgIHJldHVybiBtYXNrZWRQcmVmaXg7CgkgIH0sCgkgIGRlc2VyaWFsaXplOiBzZXJpYWxpemVkTWVzc2FnZSA9PiB7CgkgICAgY29uc3QgdmVyc2lvbiA9IFZlcnNpb25lZE1lc3NhZ2UuZGVzZXJpYWxpemVNZXNzYWdlVmVyc2lvbihzZXJpYWxpemVkTWVzc2FnZSk7CgkgICAgaWYgKHZlcnNpb24gPT09ICdsZWdhY3knKSB7CgkgICAgICByZXR1cm4gTWVzc2FnZS5mcm9tKHNlcmlhbGl6ZWRNZXNzYWdlKTsKCSAgICB9CgkgICAgaWYgKHZlcnNpb24gPT09IDApIHsKCSAgICAgIHJldHVybiBNZXNzYWdlVjAuZGVzZXJpYWxpemUoc2VyaWFsaXplZE1lc3NhZ2UpOwoJICAgIH0gZWxzZSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRyYW5zYWN0aW9uIG1lc3NhZ2UgdmVyc2lvbiAke3ZlcnNpb259IGRlc2VyaWFsaXphdGlvbiBpcyBub3Qgc3VwcG9ydGVkYCk7CgkgICAgfQoJICB9Cgl9OwoKCS8qKiBAaW50ZXJuYWwgKi8KCgkvKioKCSAqIFRyYW5zYWN0aW9uIHNpZ25hdHVyZSBhcyBiYXNlLTU4IGVuY29kZWQgc3RyaW5nCgkgKi8KCglsZXQgVHJhbnNhY3Rpb25TdGF0dXMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKFRyYW5zYWN0aW9uU3RhdHVzKSB7CgkgIFRyYW5zYWN0aW9uU3RhdHVzW1RyYW5zYWN0aW9uU3RhdHVzWyJCTE9DS0hFSUdIVF9FWENFRURFRCJdID0gMF0gPSAiQkxPQ0tIRUlHSFRfRVhDRUVERUQiOwoJICBUcmFuc2FjdGlvblN0YXR1c1tUcmFuc2FjdGlvblN0YXR1c1siUFJPQ0VTU0VEIl0gPSAxXSA9ICJQUk9DRVNTRUQiOwoJICBUcmFuc2FjdGlvblN0YXR1c1tUcmFuc2FjdGlvblN0YXR1c1siVElNRURfT1VUIl0gPSAyXSA9ICJUSU1FRF9PVVQiOwoJICBUcmFuc2FjdGlvblN0YXR1c1tUcmFuc2FjdGlvblN0YXR1c1siTk9OQ0VfSU5WQUxJRCJdID0gM10gPSAiTk9OQ0VfSU5WQUxJRCI7CgkgIHJldHVybiBUcmFuc2FjdGlvblN0YXR1czsKCX0oe30pOwoKCS8qKgoJICogRGVmYXVsdCAoZW1wdHkpIHNpZ25hdHVyZQoJICovCgljb25zdCBERUZBVUxUX1NJR05BVFVSRSA9IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmFsbG9jKFNJR05BVFVSRV9MRU5HVEhfSU5fQllURVMpLmZpbGwoMCk7CgoJLyoqCgkgKiBBY2NvdW50IG1ldGFkYXRhIHVzZWQgdG8gZGVmaW5lIGluc3RydWN0aW9ucwoJICovCgoJLyoqCgkgKiBMaXN0IG9mIFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24gb2JqZWN0IGZpZWxkcyB0aGF0IG1heSBiZSBpbml0aWFsaXplZCBhdCBjb25zdHJ1Y3Rpb24KCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIFRyYW5zYWN0aW9uLnNlcmlhbGl6ZSgpCgkgKi8KCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCgoJLyoqCgkgKiBUcmFuc2FjdGlvbiBJbnN0cnVjdGlvbiBjbGFzcwoJICovCgljbGFzcyBUcmFuc2FjdGlvbkluc3RydWN0aW9uIHsKCSAgY29uc3RydWN0b3Iob3B0cykgewoJICAgIC8qKgoJICAgICAqIFB1YmxpYyBrZXlzIHRvIGluY2x1ZGUgaW4gdGhpcyB0cmFuc2FjdGlvbgoJICAgICAqIEJvb2xlYW4gcmVwcmVzZW50cyB3aGV0aGVyIHRoaXMgcHVia2V5IG5lZWRzIHRvIHNpZ24gdGhlIHRyYW5zYWN0aW9uCgkgICAgICovCgkgICAgdGhpcy5rZXlzID0gdm9pZCAwOwoJICAgIC8qKgoJICAgICAqIFByb2dyYW0gSWQgdG8gZXhlY3V0ZQoJICAgICAqLwoJICAgIHRoaXMucHJvZ3JhbUlkID0gdm9pZCAwOwoJICAgIC8qKgoJICAgICAqIFByb2dyYW0gaW5wdXQKCSAgICAgKi8KCSAgICB0aGlzLmRhdGEgPSBidWZmZXJFeHBvcnRzLkJ1ZmZlci5hbGxvYygwKTsKCSAgICB0aGlzLnByb2dyYW1JZCA9IG9wdHMucHJvZ3JhbUlkOwoJICAgIHRoaXMua2V5cyA9IG9wdHMua2V5czsKCSAgICBpZiAob3B0cy5kYXRhKSB7CgkgICAgICB0aGlzLmRhdGEgPSBvcHRzLmRhdGE7CgkgICAgfQoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICB0b0pTT04oKSB7CgkgICAgcmV0dXJuIHsKCSAgICAgIGtleXM6IHRoaXMua2V5cy5tYXAoKHsKCSAgICAgICAgcHVia2V5LAoJICAgICAgICBpc1NpZ25lciwKCSAgICAgICAgaXNXcml0YWJsZQoJICAgICAgfSkgPT4gKHsKCSAgICAgICAgcHVia2V5OiBwdWJrZXkudG9KU09OKCksCgkgICAgICAgIGlzU2lnbmVyLAoJICAgICAgICBpc1dyaXRhYmxlCgkgICAgICB9KSksCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLnRvSlNPTigpLAoJICAgICAgZGF0YTogWy4uLnRoaXMuZGF0YV0KCSAgICB9OwoJICB9Cgl9CgoJLyoqCgkgKiBQYWlyIG9mIHNpZ25hdHVyZSBhbmQgY29ycmVzcG9uZGluZyBwdWJsaWMga2V5CgkgKi8KCgkvKioKCSAqIExpc3Qgb2YgVHJhbnNhY3Rpb24gb2JqZWN0IGZpZWxkcyB0aGF0IG1heSBiZSBpbml0aWFsaXplZCBhdCBjb25zdHJ1Y3Rpb24KCSAqLwoKCS8vIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5OyBhbiB1bmZvcnR1bmF0ZSBjb25zZXF1ZW5jZSBvZiBiZWluZwoJLy8gZm9yY2VkIHRvIG92ZXItZXhwb3J0IHR5cGVzIGJ5IHRoZSBkb2N1bWVudGF0aW9uIGdlbmVyYXRvci4KCS8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vc29sYW5hLWxhYnMvc29sYW5hL3B1bGwvMjU4MjAKCgkvKioKCSAqIEJsb2NraGFzaC1iYXNlZCB0cmFuc2FjdGlvbnMgaGF2ZSBhIGxpZmV0aW1lIHRoYXQgYXJlIGRlZmluZWQgYnkKCSAqIHRoZSBibG9ja2hhc2ggdGhleSBpbmNsdWRlLiBBbnkgdHJhbnNhY3Rpb24gd2hvc2UgYmxvY2toYXNoIGlzCgkgKiB0b28gb2xkIHdpbGwgYmUgcmVqZWN0ZWQuCgkgKi8KCgkvKioKCSAqIFVzZSB0aGVzZSBvcHRpb25zIHRvIGNvbnN0cnVjdCBhIGR1cmFibGUgbm9uY2UgdHJhbnNhY3Rpb24uCgkgKi8KCgkvKioKCSAqIE5vbmNlIGluZm9ybWF0aW9uIHRvIGJlIHVzZWQgdG8gYnVpbGQgYW4gb2ZmbGluZSBUcmFuc2FjdGlvbi4KCSAqLwoKCS8qKgoJICogQGludGVybmFsCgkgKi8KCgkvKioKCSAqIFRyYW5zYWN0aW9uIGNsYXNzCgkgKi8KCWNsYXNzIFRyYW5zYWN0aW9uIHsKCSAgLyoqCgkgICAqIFRoZSBmaXJzdCAocGF5ZXIpIFRyYW5zYWN0aW9uIHNpZ25hdHVyZQoJICAgKgoJICAgKiBAcmV0dXJucyB7QnVmZmVyIHwgbnVsbH0gQnVmZmVyIG9mIHBheWVyJ3Mgc2lnbmF0dXJlCgkgICAqLwoJICBnZXQgc2lnbmF0dXJlKCkgewoJICAgIGlmICh0aGlzLnNpZ25hdHVyZXMubGVuZ3RoID4gMCkgewoJICAgICAgcmV0dXJuIHRoaXMuc2lnbmF0dXJlc1swXS5zaWduYXR1cmU7CgkgICAgfQoJICAgIHJldHVybiBudWxsOwoJICB9CgoJICAvKioKCSAgICogVGhlIHRyYW5zYWN0aW9uIGZlZSBwYXllcgoJICAgKi8KCgkgIC8vIENvbnN0cnVjdCBhIHRyYW5zYWN0aW9uIHdpdGggYSBibG9ja2hhc2ggYW5kIGxhc3RWYWxpZEJsb2NrSGVpZ2h0CgoJICAvLyBDb25zdHJ1Y3QgYSB0cmFuc2FjdGlvbiB1c2luZyBhIGR1cmFibGUgbm9uY2UKCgkgIC8qKgoJICAgKiBAZGVwcmVjYXRlZCBgVHJhbnNhY3Rpb25DdG9yRmllbGRzYCBoYXMgYmVlbiBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbi4KCSAgICogUGxlYXNlIHN1cHBseSBhIGBUcmFuc2FjdGlvbkJsb2NraGFzaEN0b3JgIGluc3RlYWQuCgkgICAqLwoKCSAgLyoqCgkgICAqIENvbnN0cnVjdCBhbiBlbXB0eSBUcmFuc2FjdGlvbgoJICAgKi8KCSAgY29uc3RydWN0b3Iob3B0cykgewoJICAgIC8qKgoJICAgICAqIFNpZ25hdHVyZXMgZm9yIHRoZSB0cmFuc2FjdGlvbi4gIFR5cGljYWxseSBjcmVhdGVkIGJ5IGludm9raW5nIHRoZQoJICAgICAqIGBzaWduKClgIG1ldGhvZAoJICAgICAqLwoJICAgIHRoaXMuc2lnbmF0dXJlcyA9IFtdOwoJICAgIHRoaXMuZmVlUGF5ZXIgPSB2b2lkIDA7CgkgICAgLyoqCgkgICAgICogVGhlIGluc3RydWN0aW9ucyB0byBhdG9taWNhbGx5IGV4ZWN1dGUKCSAgICAgKi8KCSAgICB0aGlzLmluc3RydWN0aW9ucyA9IFtdOwoJICAgIC8qKgoJICAgICAqIEEgcmVjZW50IHRyYW5zYWN0aW9uIGlkLiBNdXN0IGJlIHBvcHVsYXRlZCBieSB0aGUgY2FsbGVyCgkgICAgICovCgkgICAgdGhpcy5yZWNlbnRCbG9ja2hhc2ggPSB2b2lkIDA7CgkgICAgLyoqCgkgICAgICogdGhlIGxhc3QgYmxvY2sgY2hhaW4gY2FuIGFkdmFuY2UgdG8gYmVmb3JlIHR4IGlzIGRlY2xhcmVkIGV4cGlyZWQKCSAgICAgKiAqLwoJICAgIHRoaXMubGFzdFZhbGlkQmxvY2tIZWlnaHQgPSB2b2lkIDA7CgkgICAgLyoqCgkgICAgICogT3B0aW9uYWwgTm9uY2UgaW5mb3JtYXRpb24uIElmIHBvcHVsYXRlZCwgdHJhbnNhY3Rpb24gd2lsbCB1c2UgYSBkdXJhYmxlCgkgICAgICogTm9uY2UgaGFzaCBpbnN0ZWFkIG9mIGEgcmVjZW50QmxvY2toYXNoLiBNdXN0IGJlIHBvcHVsYXRlZCBieSB0aGUgY2FsbGVyCgkgICAgICovCgkgICAgdGhpcy5ub25jZUluZm8gPSB2b2lkIDA7CgkgICAgLyoqCgkgICAgICogSWYgdGhpcyBpcyBhIG5vbmNlIHRyYW5zYWN0aW9uIHRoaXMgcmVwcmVzZW50cyB0aGUgbWluaW11bSBzbG90IGZyb20gd2hpY2gKCSAgICAgKiB0byBldmFsdWF0ZSBpZiB0aGUgbm9uY2UgaGFzIGFkdmFuY2VkIHdoZW4gYXR0ZW1wdGluZyB0byBjb25maXJtIHRoZQoJICAgICAqIHRyYW5zYWN0aW9uLiBUaGlzIHByb3RlY3RzIGFnYWluc3QgYSBjYXNlIHdoZXJlIHRoZSB0cmFuc2FjdGlvbiBjb25maXJtYXRpb24KCSAgICAgKiBsb2dpYyBsb2FkcyB0aGUgbm9uY2UgYWNjb3VudCBmcm9tIGFuIG9sZCBzbG90IGFuZCBhc3N1bWVzIHRoZSBtaXNtYXRjaCBpbgoJICAgICAqIG5vbmNlIHZhbHVlIGltcGxpZXMgdGhhdCB0aGUgbm9uY2UgaGFzIGJlZW4gYWR2YW5jZWQuCgkgICAgICovCgkgICAgdGhpcy5taW5Ob25jZUNvbnRleHRTbG90ID0gdm9pZCAwOwoJICAgIC8qKgoJICAgICAqIEBpbnRlcm5hbAoJICAgICAqLwoJICAgIHRoaXMuX21lc3NhZ2UgPSB2b2lkIDA7CgkgICAgLyoqCgkgICAgICogQGludGVybmFsCgkgICAgICovCgkgICAgdGhpcy5fanNvbiA9IHZvaWQgMDsKCSAgICBpZiAoIW9wdHMpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgaWYgKG9wdHMuZmVlUGF5ZXIpIHsKCSAgICAgIHRoaXMuZmVlUGF5ZXIgPSBvcHRzLmZlZVBheWVyOwoJICAgIH0KCSAgICBpZiAob3B0cy5zaWduYXR1cmVzKSB7CgkgICAgICB0aGlzLnNpZ25hdHVyZXMgPSBvcHRzLnNpZ25hdHVyZXM7CgkgICAgfQoJICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob3B0cywgJ25vbmNlSW5mbycpKSB7CgkgICAgICBjb25zdCB7CgkgICAgICAgIG1pbkNvbnRleHRTbG90LAoJICAgICAgICBub25jZUluZm8KCSAgICAgIH0gPSBvcHRzOwoJICAgICAgdGhpcy5taW5Ob25jZUNvbnRleHRTbG90ID0gbWluQ29udGV4dFNsb3Q7CgkgICAgICB0aGlzLm5vbmNlSW5mbyA9IG5vbmNlSW5mbzsKCSAgICB9IGVsc2UgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvcHRzLCAnbGFzdFZhbGlkQmxvY2tIZWlnaHQnKSkgewoJICAgICAgY29uc3QgewoJICAgICAgICBibG9ja2hhc2gsCgkgICAgICAgIGxhc3RWYWxpZEJsb2NrSGVpZ2h0CgkgICAgICB9ID0gb3B0czsKCSAgICAgIHRoaXMucmVjZW50QmxvY2toYXNoID0gYmxvY2toYXNoOwoJICAgICAgdGhpcy5sYXN0VmFsaWRCbG9ja0hlaWdodCA9IGxhc3RWYWxpZEJsb2NrSGVpZ2h0OwoJICAgIH0gZWxzZSB7CgkgICAgICBjb25zdCB7CgkgICAgICAgIHJlY2VudEJsb2NraGFzaCwKCSAgICAgICAgbm9uY2VJbmZvCgkgICAgICB9ID0gb3B0czsKCSAgICAgIGlmIChub25jZUluZm8pIHsKCSAgICAgICAgdGhpcy5ub25jZUluZm8gPSBub25jZUluZm87CgkgICAgICB9CgkgICAgICB0aGlzLnJlY2VudEJsb2NraGFzaCA9IHJlY2VudEJsb2NraGFzaDsKCSAgICB9CgkgIH0KCgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIHRvSlNPTigpIHsKCSAgICByZXR1cm4gewoJICAgICAgcmVjZW50QmxvY2toYXNoOiB0aGlzLnJlY2VudEJsb2NraGFzaCB8fCBudWxsLAoJICAgICAgZmVlUGF5ZXI6IHRoaXMuZmVlUGF5ZXIgPyB0aGlzLmZlZVBheWVyLnRvSlNPTigpIDogbnVsbCwKCSAgICAgIG5vbmNlSW5mbzogdGhpcy5ub25jZUluZm8gPyB7CgkgICAgICAgIG5vbmNlOiB0aGlzLm5vbmNlSW5mby5ub25jZSwKCSAgICAgICAgbm9uY2VJbnN0cnVjdGlvbjogdGhpcy5ub25jZUluZm8ubm9uY2VJbnN0cnVjdGlvbi50b0pTT04oKQoJICAgICAgfSA6IG51bGwsCgkgICAgICBpbnN0cnVjdGlvbnM6IHRoaXMuaW5zdHJ1Y3Rpb25zLm1hcChpbnN0cnVjdGlvbiA9PiBpbnN0cnVjdGlvbi50b0pTT04oKSksCgkgICAgICBzaWduZXJzOiB0aGlzLnNpZ25hdHVyZXMubWFwKCh7CgkgICAgICAgIHB1YmxpY0tleQoJICAgICAgfSkgPT4gewoJICAgICAgICByZXR1cm4gcHVibGljS2V5LnRvSlNPTigpOwoJICAgICAgfSkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogQWRkIG9uZSBvciBtb3JlIGluc3RydWN0aW9ucyB0byB0aGlzIFRyYW5zYWN0aW9uCgkgICAqCgkgICAqIEBwYXJhbSB7QXJyYXk8IFRyYW5zYWN0aW9uIHwgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbiB8IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb25DdG9yRmllbGRzID59IGl0ZW1zIC0gSW5zdHJ1Y3Rpb25zIHRvIGFkZCB0byB0aGUgVHJhbnNhY3Rpb24KCSAgICovCgkgIGFkZCguLi5pdGVtcykgewoJICAgIGlmIChpdGVtcy5sZW5ndGggPT09IDApIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignTm8gaW5zdHJ1Y3Rpb25zJyk7CgkgICAgfQoJICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7CgkgICAgICBpZiAoJ2luc3RydWN0aW9ucycgaW4gaXRlbSkgewoJICAgICAgICB0aGlzLmluc3RydWN0aW9ucyA9IHRoaXMuaW5zdHJ1Y3Rpb25zLmNvbmNhdChpdGVtLmluc3RydWN0aW9ucyk7CgkgICAgICB9IGVsc2UgaWYgKCdkYXRhJyBpbiBpdGVtICYmICdwcm9ncmFtSWQnIGluIGl0ZW0gJiYgJ2tleXMnIGluIGl0ZW0pIHsKCSAgICAgICAgdGhpcy5pbnN0cnVjdGlvbnMucHVzaChpdGVtKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRoaXMuaW5zdHJ1Y3Rpb25zLnB1c2gobmV3IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24oaXRlbSkpOwoJICAgICAgfQoJICAgIH0pOwoJICAgIHJldHVybiB0aGlzOwoJICB9CgoJICAvKioKCSAgICogQ29tcGlsZSB0cmFuc2FjdGlvbiBkYXRhCgkgICAqLwoJICBjb21waWxlTWVzc2FnZSgpIHsKCSAgICBpZiAodGhpcy5fbWVzc2FnZSAmJiBKU09OLnN0cmluZ2lmeSh0aGlzLnRvSlNPTigpKSA9PT0gSlNPTi5zdHJpbmdpZnkodGhpcy5fanNvbikpIHsKCSAgICAgIHJldHVybiB0aGlzLl9tZXNzYWdlOwoJICAgIH0KCSAgICBsZXQgcmVjZW50QmxvY2toYXNoOwoJICAgIGxldCBpbnN0cnVjdGlvbnM7CgkgICAgaWYgKHRoaXMubm9uY2VJbmZvKSB7CgkgICAgICByZWNlbnRCbG9ja2hhc2ggPSB0aGlzLm5vbmNlSW5mby5ub25jZTsKCSAgICAgIGlmICh0aGlzLmluc3RydWN0aW9uc1swXSAhPSB0aGlzLm5vbmNlSW5mby5ub25jZUluc3RydWN0aW9uKSB7CgkgICAgICAgIGluc3RydWN0aW9ucyA9IFt0aGlzLm5vbmNlSW5mby5ub25jZUluc3RydWN0aW9uLCAuLi50aGlzLmluc3RydWN0aW9uc107CgkgICAgICB9IGVsc2UgewoJICAgICAgICBpbnN0cnVjdGlvbnMgPSB0aGlzLmluc3RydWN0aW9uczsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgcmVjZW50QmxvY2toYXNoID0gdGhpcy5yZWNlbnRCbG9ja2hhc2g7CgkgICAgICBpbnN0cnVjdGlvbnMgPSB0aGlzLmluc3RydWN0aW9uczsKCSAgICB9CgkgICAgaWYgKCFyZWNlbnRCbG9ja2hhc2gpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignVHJhbnNhY3Rpb24gcmVjZW50QmxvY2toYXNoIHJlcXVpcmVkJyk7CgkgICAgfQoJICAgIGlmIChpbnN0cnVjdGlvbnMubGVuZ3RoIDwgMSkgewoJICAgICAgY29uc29sZS53YXJuKCdObyBpbnN0cnVjdGlvbnMgcHJvdmlkZWQnKTsKCSAgICB9CgkgICAgbGV0IGZlZVBheWVyOwoJICAgIGlmICh0aGlzLmZlZVBheWVyKSB7CgkgICAgICBmZWVQYXllciA9IHRoaXMuZmVlUGF5ZXI7CgkgICAgfSBlbHNlIGlmICh0aGlzLnNpZ25hdHVyZXMubGVuZ3RoID4gMCAmJiB0aGlzLnNpZ25hdHVyZXNbMF0ucHVibGljS2V5KSB7CgkgICAgICAvLyBVc2UgaW1wbGljaXQgZmVlIHBheWVyCgkgICAgICBmZWVQYXllciA9IHRoaXMuc2lnbmF0dXJlc1swXS5wdWJsaWNLZXk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignVHJhbnNhY3Rpb24gZmVlIHBheWVyIHJlcXVpcmVkJyk7CgkgICAgfQoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zdHJ1Y3Rpb25zLmxlbmd0aDsgaSsrKSB7CgkgICAgICBpZiAoaW5zdHJ1Y3Rpb25zW2ldLnByb2dyYW1JZCA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgIHRocm93IG5ldyBFcnJvcihgVHJhbnNhY3Rpb24gaW5zdHJ1Y3Rpb24gaW5kZXggJHtpfSBoYXMgdW5kZWZpbmVkIHByb2dyYW0gaWRgKTsKCSAgICAgIH0KCSAgICB9CgkgICAgY29uc3QgcHJvZ3JhbUlkcyA9IFtdOwoJICAgIGNvbnN0IGFjY291bnRNZXRhcyA9IFtdOwoJICAgIGluc3RydWN0aW9ucy5mb3JFYWNoKGluc3RydWN0aW9uID0+IHsKCSAgICAgIGluc3RydWN0aW9uLmtleXMuZm9yRWFjaChhY2NvdW50TWV0YSA9PiB7CgkgICAgICAgIGFjY291bnRNZXRhcy5wdXNoKHsKCSAgICAgICAgICAuLi5hY2NvdW50TWV0YQoJICAgICAgICB9KTsKCSAgICAgIH0pOwoJICAgICAgY29uc3QgcHJvZ3JhbUlkID0gaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkLnRvU3RyaW5nKCk7CgkgICAgICBpZiAoIXByb2dyYW1JZHMuaW5jbHVkZXMocHJvZ3JhbUlkKSkgewoJICAgICAgICBwcm9ncmFtSWRzLnB1c2gocHJvZ3JhbUlkKTsKCSAgICAgIH0KCSAgICB9KTsKCgkgICAgLy8gQXBwZW5kIHByb2dyYW1JRCBhY2NvdW50IG1ldGFzCgkgICAgcHJvZ3JhbUlkcy5mb3JFYWNoKHByb2dyYW1JZCA9PiB7CgkgICAgICBhY2NvdW50TWV0YXMucHVzaCh7CgkgICAgICAgIHB1YmtleTogbmV3IFB1YmxpY0tleShwcm9ncmFtSWQpLAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9KTsKCSAgICB9KTsKCgkgICAgLy8gQ3VsbCBkdXBsaWNhdGUgYWNjb3VudCBtZXRhcwoJICAgIGNvbnN0IHVuaXF1ZU1ldGFzID0gW107CgkgICAgYWNjb3VudE1ldGFzLmZvckVhY2goYWNjb3VudE1ldGEgPT4gewoJICAgICAgY29uc3QgcHVia2V5U3RyaW5nID0gYWNjb3VudE1ldGEucHVia2V5LnRvU3RyaW5nKCk7CgkgICAgICBjb25zdCB1bmlxdWVJbmRleCA9IHVuaXF1ZU1ldGFzLmZpbmRJbmRleCh4ID0+IHsKCSAgICAgICAgcmV0dXJuIHgucHVia2V5LnRvU3RyaW5nKCkgPT09IHB1YmtleVN0cmluZzsKCSAgICAgIH0pOwoJICAgICAgaWYgKHVuaXF1ZUluZGV4ID4gLTEpIHsKCSAgICAgICAgdW5pcXVlTWV0YXNbdW5pcXVlSW5kZXhdLmlzV3JpdGFibGUgPSB1bmlxdWVNZXRhc1t1bmlxdWVJbmRleF0uaXNXcml0YWJsZSB8fCBhY2NvdW50TWV0YS5pc1dyaXRhYmxlOwoJICAgICAgICB1bmlxdWVNZXRhc1t1bmlxdWVJbmRleF0uaXNTaWduZXIgPSB1bmlxdWVNZXRhc1t1bmlxdWVJbmRleF0uaXNTaWduZXIgfHwgYWNjb3VudE1ldGEuaXNTaWduZXI7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB1bmlxdWVNZXRhcy5wdXNoKGFjY291bnRNZXRhKTsKCSAgICAgIH0KCSAgICB9KTsKCgkgICAgLy8gU29ydC4gUHJpb3JpdGl6aW5nIGZpcnN0IGJ5IHNpZ25lciwgdGhlbiBieSB3cml0YWJsZQoJICAgIHVuaXF1ZU1ldGFzLnNvcnQoZnVuY3Rpb24gKHgsIHkpIHsKCSAgICAgIGlmICh4LmlzU2lnbmVyICE9PSB5LmlzU2lnbmVyKSB7CgkgICAgICAgIC8vIFNpZ25lcnMgYWx3YXlzIGNvbWUgYmVmb3JlIG5vbi1zaWduZXJzCgkgICAgICAgIHJldHVybiB4LmlzU2lnbmVyID8gLTEgOiAxOwoJICAgICAgfQoJICAgICAgaWYgKHguaXNXcml0YWJsZSAhPT0geS5pc1dyaXRhYmxlKSB7CgkgICAgICAgIC8vIFdyaXRhYmxlIGFjY291bnRzIGFsd2F5cyBjb21lIGJlZm9yZSByZWFkLW9ubHkgYWNjb3VudHMKCSAgICAgICAgcmV0dXJuIHguaXNXcml0YWJsZSA/IC0xIDogMTsKCSAgICAgIH0KCSAgICAgIC8vIE90aGVyd2lzZSwgc29ydCBieSBwdWJrZXksIHN0cmluZ3dpc2UuCgkgICAgICBjb25zdCBvcHRpb25zID0gewoJICAgICAgICBsb2NhbGVNYXRjaGVyOiAnYmVzdCBmaXQnLAoJICAgICAgICB1c2FnZTogJ3NvcnQnLAoJICAgICAgICBzZW5zaXRpdml0eTogJ3ZhcmlhbnQnLAoJICAgICAgICBpZ25vcmVQdW5jdHVhdGlvbjogZmFsc2UsCgkgICAgICAgIG51bWVyaWM6IGZhbHNlLAoJICAgICAgICBjYXNlRmlyc3Q6ICdsb3dlcicKCSAgICAgIH07CgkgICAgICByZXR1cm4geC5wdWJrZXkudG9CYXNlNTgoKS5sb2NhbGVDb21wYXJlKHkucHVia2V5LnRvQmFzZTU4KCksICdlbicsIG9wdGlvbnMpOwoJICAgIH0pOwoKCSAgICAvLyBNb3ZlIGZlZSBwYXllciB0byB0aGUgZnJvbnQKCSAgICBjb25zdCBmZWVQYXllckluZGV4ID0gdW5pcXVlTWV0YXMuZmluZEluZGV4KHggPT4gewoJICAgICAgcmV0dXJuIHgucHVia2V5LmVxdWFscyhmZWVQYXllcik7CgkgICAgfSk7CgkgICAgaWYgKGZlZVBheWVySW5kZXggPiAtMSkgewoJICAgICAgY29uc3QgW3BheWVyTWV0YV0gPSB1bmlxdWVNZXRhcy5zcGxpY2UoZmVlUGF5ZXJJbmRleCwgMSk7CgkgICAgICBwYXllck1ldGEuaXNTaWduZXIgPSB0cnVlOwoJICAgICAgcGF5ZXJNZXRhLmlzV3JpdGFibGUgPSB0cnVlOwoJICAgICAgdW5pcXVlTWV0YXMudW5zaGlmdChwYXllck1ldGEpOwoJICAgIH0gZWxzZSB7CgkgICAgICB1bmlxdWVNZXRhcy51bnNoaWZ0KHsKCSAgICAgICAgcHVia2V5OiBmZWVQYXllciwKCSAgICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0pOwoJICAgIH0KCgkgICAgLy8gRGlzYWxsb3cgdW5rbm93biBzaWduZXJzCgkgICAgZm9yIChjb25zdCBzaWduYXR1cmUgb2YgdGhpcy5zaWduYXR1cmVzKSB7CgkgICAgICBjb25zdCB1bmlxdWVJbmRleCA9IHVuaXF1ZU1ldGFzLmZpbmRJbmRleCh4ID0+IHsKCSAgICAgICAgcmV0dXJuIHgucHVia2V5LmVxdWFscyhzaWduYXR1cmUucHVibGljS2V5KTsKCSAgICAgIH0pOwoJICAgICAgaWYgKHVuaXF1ZUluZGV4ID4gLTEpIHsKCSAgICAgICAgaWYgKCF1bmlxdWVNZXRhc1t1bmlxdWVJbmRleF0uaXNTaWduZXIpIHsKCSAgICAgICAgICB1bmlxdWVNZXRhc1t1bmlxdWVJbmRleF0uaXNTaWduZXIgPSB0cnVlOwoJICAgICAgICAgIGNvbnNvbGUud2FybignVHJhbnNhY3Rpb24gcmVmZXJlbmNlcyBhIHNpZ25hdHVyZSB0aGF0IGlzIHVubmVjZXNzYXJ5LCAnICsgJ29ubHkgdGhlIGZlZSBwYXllciBhbmQgaW5zdHJ1Y3Rpb24gc2lnbmVyIGFjY291bnRzIHNob3VsZCBzaWduIGEgdHJhbnNhY3Rpb24uICcgKyAnVGhpcyBiZWhhdmlvciBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIHRocm93IGFuIGVycm9yIGluIHRoZSBuZXh0IG1ham9yIHZlcnNpb24gcmVsZWFzZS4nKTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIHNpZ25lcjogJHtzaWduYXR1cmUucHVibGljS2V5LnRvU3RyaW5nKCl9YCk7CgkgICAgICB9CgkgICAgfQoJICAgIGxldCBudW1SZXF1aXJlZFNpZ25hdHVyZXMgPSAwOwoJICAgIGxldCBudW1SZWFkb25seVNpZ25lZEFjY291bnRzID0gMDsKCSAgICBsZXQgbnVtUmVhZG9ubHlVbnNpZ25lZEFjY291bnRzID0gMDsKCgkgICAgLy8gU3BsaXQgb3V0IHNpZ25pbmcgZnJvbSBub24tc2lnbmluZyBrZXlzIGFuZCBjb3VudCBoZWFkZXIgdmFsdWVzCgkgICAgY29uc3Qgc2lnbmVkS2V5cyA9IFtdOwoJICAgIGNvbnN0IHVuc2lnbmVkS2V5cyA9IFtdOwoJICAgIHVuaXF1ZU1ldGFzLmZvckVhY2goKHsKCSAgICAgIHB1YmtleSwKCSAgICAgIGlzU2lnbmVyLAoJICAgICAgaXNXcml0YWJsZQoJICAgIH0pID0+IHsKCSAgICAgIGlmIChpc1NpZ25lcikgewoJICAgICAgICBzaWduZWRLZXlzLnB1c2gocHVia2V5LnRvU3RyaW5nKCkpOwoJICAgICAgICBudW1SZXF1aXJlZFNpZ25hdHVyZXMgKz0gMTsKCSAgICAgICAgaWYgKCFpc1dyaXRhYmxlKSB7CgkgICAgICAgICAgbnVtUmVhZG9ubHlTaWduZWRBY2NvdW50cyArPSAxOwoJICAgICAgICB9CgkgICAgICB9IGVsc2UgewoJICAgICAgICB1bnNpZ25lZEtleXMucHVzaChwdWJrZXkudG9TdHJpbmcoKSk7CgkgICAgICAgIGlmICghaXNXcml0YWJsZSkgewoJICAgICAgICAgIG51bVJlYWRvbmx5VW5zaWduZWRBY2NvdW50cyArPSAxOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSk7CgkgICAgY29uc3QgYWNjb3VudEtleXMgPSBzaWduZWRLZXlzLmNvbmNhdCh1bnNpZ25lZEtleXMpOwoJICAgIGNvbnN0IGNvbXBpbGVkSW5zdHJ1Y3Rpb25zID0gaW5zdHJ1Y3Rpb25zLm1hcChpbnN0cnVjdGlvbiA9PiB7CgkgICAgICBjb25zdCB7CgkgICAgICAgIGRhdGEsCgkgICAgICAgIHByb2dyYW1JZAoJICAgICAgfSA9IGluc3RydWN0aW9uOwoJICAgICAgcmV0dXJuIHsKCSAgICAgICAgcHJvZ3JhbUlkSW5kZXg6IGFjY291bnRLZXlzLmluZGV4T2YocHJvZ3JhbUlkLnRvU3RyaW5nKCkpLAoJICAgICAgICBhY2NvdW50czogaW5zdHJ1Y3Rpb24ua2V5cy5tYXAobWV0YSA9PiBhY2NvdW50S2V5cy5pbmRleE9mKG1ldGEucHVia2V5LnRvU3RyaW5nKCkpKSwKCSAgICAgICAgZGF0YTogYnM1OC5lbmNvZGUoZGF0YSkKCSAgICAgIH07CgkgICAgfSk7CgkgICAgY29tcGlsZWRJbnN0cnVjdGlvbnMuZm9yRWFjaChpbnN0cnVjdGlvbiA9PiB7CgkgICAgICBhc3NlcnQkMShpbnN0cnVjdGlvbi5wcm9ncmFtSWRJbmRleCA+PSAwKTsKCSAgICAgIGluc3RydWN0aW9uLmFjY291bnRzLmZvckVhY2goa2V5SW5kZXggPT4gYXNzZXJ0JDEoa2V5SW5kZXggPj0gMCkpOwoJICAgIH0pOwoJICAgIHJldHVybiBuZXcgTWVzc2FnZSh7CgkgICAgICBoZWFkZXI6IHsKCSAgICAgICAgbnVtUmVxdWlyZWRTaWduYXR1cmVzLAoJICAgICAgICBudW1SZWFkb25seVNpZ25lZEFjY291bnRzLAoJICAgICAgICBudW1SZWFkb25seVVuc2lnbmVkQWNjb3VudHMKCSAgICAgIH0sCgkgICAgICBhY2NvdW50S2V5cywKCSAgICAgIHJlY2VudEJsb2NraGFzaCwKCSAgICAgIGluc3RydWN0aW9uczogY29tcGlsZWRJbnN0cnVjdGlvbnMKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgX2NvbXBpbGUoKSB7CgkgICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuY29tcGlsZU1lc3NhZ2UoKTsKCSAgICBjb25zdCBzaWduZWRLZXlzID0gbWVzc2FnZS5hY2NvdW50S2V5cy5zbGljZSgwLCBtZXNzYWdlLmhlYWRlci5udW1SZXF1aXJlZFNpZ25hdHVyZXMpOwoJICAgIGlmICh0aGlzLnNpZ25hdHVyZXMubGVuZ3RoID09PSBzaWduZWRLZXlzLmxlbmd0aCkgewoJICAgICAgY29uc3QgdmFsaWQgPSB0aGlzLnNpZ25hdHVyZXMuZXZlcnkoKHBhaXIsIGluZGV4KSA9PiB7CgkgICAgICAgIHJldHVybiBzaWduZWRLZXlzW2luZGV4XS5lcXVhbHMocGFpci5wdWJsaWNLZXkpOwoJICAgICAgfSk7CgkgICAgICBpZiAodmFsaWQpIHJldHVybiBtZXNzYWdlOwoJICAgIH0KCSAgICB0aGlzLnNpZ25hdHVyZXMgPSBzaWduZWRLZXlzLm1hcChwdWJsaWNLZXkgPT4gKHsKCSAgICAgIHNpZ25hdHVyZTogbnVsbCwKCSAgICAgIHB1YmxpY0tleQoJICAgIH0pKTsKCSAgICByZXR1cm4gbWVzc2FnZTsKCSAgfQoKCSAgLyoqCgkgICAqIEdldCBhIGJ1ZmZlciBvZiB0aGUgVHJhbnNhY3Rpb24gZGF0YSB0aGF0IG5lZWQgdG8gYmUgY292ZXJlZCBieSBzaWduYXR1cmVzCgkgICAqLwoJICBzZXJpYWxpemVNZXNzYWdlKCkgewoJICAgIHJldHVybiB0aGlzLl9jb21waWxlKCkuc2VyaWFsaXplKCk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZXQgdGhlIGVzdGltYXRlZCBmZWUgYXNzb2NpYXRlZCB3aXRoIGEgdHJhbnNhY3Rpb24KCSAgICoKCSAgICogQHBhcmFtIHtDb25uZWN0aW9ufSBjb25uZWN0aW9uIENvbm5lY3Rpb24gdG8gUlBDIEVuZHBvaW50LgoJICAgKgoJICAgKiBAcmV0dXJucyB7UHJvbWlzZTxudW1iZXIgfCBudWxsPn0gVGhlIGVzdGltYXRlZCBmZWUgZm9yIHRoZSB0cmFuc2FjdGlvbgoJICAgKi8KCSAgYXN5bmMgZ2V0RXN0aW1hdGVkRmVlKGNvbm5lY3Rpb24pIHsKCSAgICByZXR1cm4gKGF3YWl0IGNvbm5lY3Rpb24uZ2V0RmVlRm9yTWVzc2FnZSh0aGlzLmNvbXBpbGVNZXNzYWdlKCkpKS52YWx1ZTsKCSAgfQoKCSAgLyoqCgkgICAqIFNwZWNpZnkgdGhlIHB1YmxpYyBrZXlzIHdoaWNoIHdpbGwgYmUgdXNlZCB0byBzaWduIHRoZSBUcmFuc2FjdGlvbi4KCSAgICogVGhlIGZpcnN0IHNpZ25lciB3aWxsIGJlIHVzZWQgYXMgdGhlIHRyYW5zYWN0aW9uIGZlZSBwYXllciBhY2NvdW50LgoJICAgKgoJICAgKiBTaWduYXR1cmVzIGNhbiBiZSBhZGRlZCB3aXRoIGVpdGhlciBgcGFydGlhbFNpZ25gIG9yIGBhZGRTaWduYXR1cmVgCgkgICAqCgkgICAqIEBkZXByZWNhdGVkIERlcHJlY2F0ZWQgc2luY2UgdjAuODQuMC4gT25seSB0aGUgZmVlIHBheWVyIG5lZWRzIHRvIGJlCgkgICAqIHNwZWNpZmllZCBhbmQgaXQgY2FuIGJlIHNldCBpbiB0aGUgVHJhbnNhY3Rpb24gY29uc3RydWN0b3Igb3Igd2l0aCB0aGUKCSAgICogYGZlZVBheWVyYCBwcm9wZXJ0eS4KCSAgICovCgkgIHNldFNpZ25lcnMoLi4uc2lnbmVycykgewoJICAgIGlmIChzaWduZXJzLmxlbmd0aCA9PT0gMCkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzaWduZXJzJyk7CgkgICAgfQoJICAgIGNvbnN0IHNlZW4gPSBuZXcgU2V0KCk7CgkgICAgdGhpcy5zaWduYXR1cmVzID0gc2lnbmVycy5maWx0ZXIocHVibGljS2V5ID0+IHsKCSAgICAgIGNvbnN0IGtleSA9IHB1YmxpY0tleS50b1N0cmluZygpOwoJICAgICAgaWYgKHNlZW4uaGFzKGtleSkpIHsKCSAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgc2Vlbi5hZGQoa2V5KTsKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICB9CgkgICAgfSkubWFwKHB1YmxpY0tleSA9PiAoewoJICAgICAgc2lnbmF0dXJlOiBudWxsLAoJICAgICAgcHVibGljS2V5CgkgICAgfSkpOwoJICB9CgoJICAvKioKCSAgICogU2lnbiB0aGUgVHJhbnNhY3Rpb24gd2l0aCB0aGUgc3BlY2lmaWVkIHNpZ25lcnMuIE11bHRpcGxlIHNpZ25hdHVyZXMgbWF5CgkgICAqIGJlIGFwcGxpZWQgdG8gYSBUcmFuc2FjdGlvbi4gVGhlIGZpcnN0IHNpZ25hdHVyZSBpcyBjb25zaWRlcmVkICJwcmltYXJ5IgoJICAgKiBhbmQgaXMgdXNlZCBpZGVudGlmeSBhbmQgY29uZmlybSB0cmFuc2FjdGlvbnMuCgkgICAqCgkgICAqIElmIHRoZSBUcmFuc2FjdGlvbiBgZmVlUGF5ZXJgIGlzIG5vdCBzZXQsIHRoZSBmaXJzdCBzaWduZXIgd2lsbCBiZSB1c2VkCgkgICAqIGFzIHRoZSB0cmFuc2FjdGlvbiBmZWUgcGF5ZXIgYWNjb3VudC4KCSAgICoKCSAgICogVHJhbnNhY3Rpb24gZmllbGRzIHNob3VsZCBub3QgYmUgbW9kaWZpZWQgYWZ0ZXIgdGhlIGZpcnN0IGNhbGwgdG8gYHNpZ25gLAoJICAgKiBhcyBkb2luZyBzbyBtYXkgaW52YWxpZGF0ZSB0aGUgc2lnbmF0dXJlIGFuZCBjYXVzZSB0aGUgVHJhbnNhY3Rpb24gdG8gYmUKCSAgICogcmVqZWN0ZWQuCgkgICAqCgkgICAqIFRoZSBUcmFuc2FjdGlvbiBtdXN0IGJlIGFzc2lnbmVkIGEgdmFsaWQgYHJlY2VudEJsb2NraGFzaGAgYmVmb3JlIGludm9raW5nIHRoaXMgbWV0aG9kCgkgICAqCgkgICAqIEBwYXJhbSB7QXJyYXk8U2lnbmVyPn0gc2lnbmVycyBBcnJheSBvZiBzaWduZXJzIHRoYXQgd2lsbCBzaWduIHRoZSB0cmFuc2FjdGlvbgoJICAgKi8KCSAgc2lnbiguLi5zaWduZXJzKSB7CgkgICAgaWYgKHNpZ25lcnMubGVuZ3RoID09PSAwKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNpZ25lcnMnKTsKCSAgICB9CgoJICAgIC8vIERlZHVwZSBzaWduZXJzCgkgICAgY29uc3Qgc2VlbiA9IG5ldyBTZXQoKTsKCSAgICBjb25zdCB1bmlxdWVTaWduZXJzID0gW107CgkgICAgZm9yIChjb25zdCBzaWduZXIgb2Ygc2lnbmVycykgewoJICAgICAgY29uc3Qga2V5ID0gc2lnbmVyLnB1YmxpY0tleS50b1N0cmluZygpOwoJICAgICAgaWYgKHNlZW4uaGFzKGtleSkpIHsKCSAgICAgICAgY29udGludWU7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBzZWVuLmFkZChrZXkpOwoJICAgICAgICB1bmlxdWVTaWduZXJzLnB1c2goc2lnbmVyKTsKCSAgICAgIH0KCSAgICB9CgkgICAgdGhpcy5zaWduYXR1cmVzID0gdW5pcXVlU2lnbmVycy5tYXAoc2lnbmVyID0+ICh7CgkgICAgICBzaWduYXR1cmU6IG51bGwsCgkgICAgICBwdWJsaWNLZXk6IHNpZ25lci5wdWJsaWNLZXkKCSAgICB9KSk7CgkgICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuX2NvbXBpbGUoKTsKCSAgICB0aGlzLl9wYXJ0aWFsU2lnbihtZXNzYWdlLCAuLi51bmlxdWVTaWduZXJzKTsKCSAgfQoKCSAgLyoqCgkgICAqIFBhcnRpYWxseSBzaWduIGEgdHJhbnNhY3Rpb24gd2l0aCB0aGUgc3BlY2lmaWVkIGFjY291bnRzLiBBbGwgYWNjb3VudHMgbXVzdAoJICAgKiBjb3JyZXNwb25kIHRvIGVpdGhlciB0aGUgZmVlIHBheWVyIG9yIGEgc2lnbmVyIGFjY291bnQgaW4gdGhlIHRyYW5zYWN0aW9uCgkgICAqIGluc3RydWN0aW9ucy4KCSAgICoKCSAgICogQWxsIHRoZSBjYXZlYXRzIGZyb20gdGhlIGBzaWduYCBtZXRob2QgYXBwbHkgdG8gYHBhcnRpYWxTaWduYAoJICAgKgoJICAgKiBAcGFyYW0ge0FycmF5PFNpZ25lcj59IHNpZ25lcnMgQXJyYXkgb2Ygc2lnbmVycyB0aGF0IHdpbGwgc2lnbiB0aGUgdHJhbnNhY3Rpb24KCSAgICovCgkgIHBhcnRpYWxTaWduKC4uLnNpZ25lcnMpIHsKCSAgICBpZiAoc2lnbmVycy5sZW5ndGggPT09IDApIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2lnbmVycycpOwoJICAgIH0KCgkgICAgLy8gRGVkdXBlIHNpZ25lcnMKCSAgICBjb25zdCBzZWVuID0gbmV3IFNldCgpOwoJICAgIGNvbnN0IHVuaXF1ZVNpZ25lcnMgPSBbXTsKCSAgICBmb3IgKGNvbnN0IHNpZ25lciBvZiBzaWduZXJzKSB7CgkgICAgICBjb25zdCBrZXkgPSBzaWduZXIucHVibGljS2V5LnRvU3RyaW5nKCk7CgkgICAgICBpZiAoc2Vlbi5oYXMoa2V5KSkgewoJICAgICAgICBjb250aW51ZTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHNlZW4uYWRkKGtleSk7CgkgICAgICAgIHVuaXF1ZVNpZ25lcnMucHVzaChzaWduZXIpOwoJICAgICAgfQoJICAgIH0KCSAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5fY29tcGlsZSgpOwoJICAgIHRoaXMuX3BhcnRpYWxTaWduKG1lc3NhZ2UsIC4uLnVuaXF1ZVNpZ25lcnMpOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfcGFydGlhbFNpZ24obWVzc2FnZSwgLi4uc2lnbmVycykgewoJICAgIGNvbnN0IHNpZ25EYXRhID0gbWVzc2FnZS5zZXJpYWxpemUoKTsKCSAgICBzaWduZXJzLmZvckVhY2goc2lnbmVyID0+IHsKCSAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHNpZ24oc2lnbkRhdGEsIHNpZ25lci5zZWNyZXRLZXkpOwoJICAgICAgdGhpcy5fYWRkU2lnbmF0dXJlKHNpZ25lci5wdWJsaWNLZXksIHRvQnVmZmVyKHNpZ25hdHVyZSkpOwoJICAgIH0pOwoJICB9CgoJICAvKioKCSAgICogQWRkIGFuIGV4dGVybmFsbHkgY3JlYXRlZCBzaWduYXR1cmUgdG8gYSB0cmFuc2FjdGlvbi4gVGhlIHB1YmxpYyBrZXkKCSAgICogbXVzdCBjb3JyZXNwb25kIHRvIGVpdGhlciB0aGUgZmVlIHBheWVyIG9yIGEgc2lnbmVyIGFjY291bnQgaW4gdGhlIHRyYW5zYWN0aW9uCgkgICAqIGluc3RydWN0aW9ucy4KCSAgICoKCSAgICogQHBhcmFtIHtQdWJsaWNLZXl9IHB1YmtleSBQdWJsaWMga2V5IHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgdHJhbnNhY3Rpb24uCgkgICAqIEBwYXJhbSB7QnVmZmVyfSBzaWduYXR1cmUgQW4gZXh0ZXJuYWxseSBjcmVhdGVkIHNpZ25hdHVyZSB0byBhZGQgdG8gdGhlIHRyYW5zYWN0aW9uLgoJICAgKi8KCSAgYWRkU2lnbmF0dXJlKHB1YmtleSwgc2lnbmF0dXJlKSB7CgkgICAgdGhpcy5fY29tcGlsZSgpOyAvLyBFbnN1cmUgc2lnbmF0dXJlcyBhcnJheSBpcyBwb3B1bGF0ZWQKCSAgICB0aGlzLl9hZGRTaWduYXR1cmUocHVia2V5LCBzaWduYXR1cmUpOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfYWRkU2lnbmF0dXJlKHB1YmtleSwgc2lnbmF0dXJlKSB7CgkgICAgYXNzZXJ0JDEoc2lnbmF0dXJlLmxlbmd0aCA9PT0gNjQpOwoJICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zaWduYXR1cmVzLmZpbmRJbmRleChzaWdwYWlyID0+IHB1YmtleS5lcXVhbHMoc2lncGFpci5wdWJsaWNLZXkpKTsKCSAgICBpZiAoaW5kZXggPCAwKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVua25vd24gc2lnbmVyOiAke3B1YmtleS50b1N0cmluZygpfWApOwoJICAgIH0KCSAgICB0aGlzLnNpZ25hdHVyZXNbaW5kZXhdLnNpZ25hdHVyZSA9IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oc2lnbmF0dXJlKTsKCSAgfQoKCSAgLyoqCgkgICAqIFZlcmlmeSBzaWduYXR1cmVzIG9mIGEgVHJhbnNhY3Rpb24KCSAgICogT3B0aW9uYWwgcGFyYW1ldGVyIHNwZWNpZmllcyBpZiB3ZSdyZSBleHBlY3RpbmcgYSBmdWxseSBzaWduZWQgVHJhbnNhY3Rpb24gb3IgYSBwYXJ0aWFsbHkgc2lnbmVkIG9uZS4KCSAgICogSWYgbm8gYm9vbGVhbiBpcyBwcm92aWRlZCwgd2UgZXhwZWN0IGEgZnVsbHkgc2lnbmVkIFRyYW5zYWN0aW9uIGJ5IGRlZmF1bHQuCgkgICAqCgkgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3JlcXVpcmVBbGxTaWduYXR1cmVzPXRydWVdIFJlcXVpcmUgYSBmdWxseSBzaWduZWQgVHJhbnNhY3Rpb24KCSAgICovCgkgIHZlcmlmeVNpZ25hdHVyZXMocmVxdWlyZUFsbFNpZ25hdHVyZXMgPSB0cnVlKSB7CgkgICAgY29uc3Qgc2lnbmF0dXJlRXJyb3JzID0gdGhpcy5fZ2V0TWVzc2FnZVNpZ25lZG5lc3NFcnJvcnModGhpcy5zZXJpYWxpemVNZXNzYWdlKCksIHJlcXVpcmVBbGxTaWduYXR1cmVzKTsKCSAgICByZXR1cm4gIXNpZ25hdHVyZUVycm9yczsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgX2dldE1lc3NhZ2VTaWduZWRuZXNzRXJyb3JzKG1lc3NhZ2UsIHJlcXVpcmVBbGxTaWduYXR1cmVzKSB7CgkgICAgY29uc3QgZXJyb3JzID0ge307CgkgICAgZm9yIChjb25zdCB7CgkgICAgICBzaWduYXR1cmUsCgkgICAgICBwdWJsaWNLZXkKCSAgICB9IG9mIHRoaXMuc2lnbmF0dXJlcykgewoJICAgICAgaWYgKHNpZ25hdHVyZSA9PT0gbnVsbCkgewoJICAgICAgICBpZiAocmVxdWlyZUFsbFNpZ25hdHVyZXMpIHsKCSAgICAgICAgICAoZXJyb3JzLm1pc3NpbmcgfHw9IFtdKS5wdXNoKHB1YmxpY0tleSk7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGlmICghdmVyaWZ5KHNpZ25hdHVyZSwgbWVzc2FnZSwgcHVibGljS2V5LnRvQnl0ZXMoKSkpIHsKCSAgICAgICAgICAoZXJyb3JzLmludmFsaWQgfHw9IFtdKS5wdXNoKHB1YmxpY0tleSk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIGVycm9ycy5pbnZhbGlkIHx8IGVycm9ycy5taXNzaW5nID8gZXJyb3JzIDogdW5kZWZpbmVkOwoJICB9CgoJICAvKioKCSAgICogU2VyaWFsaXplIHRoZSBUcmFuc2FjdGlvbiBpbiB0aGUgd2lyZSBmb3JtYXQuCgkgICAqCgkgICAqIEBwYXJhbSB7QnVmZmVyfSBbY29uZmlnXSBDb25maWcgb2YgdHJhbnNhY3Rpb24uCgkgICAqCgkgICAqIEByZXR1cm5zIHtCdWZmZXJ9IFNpZ25hdHVyZSBvZiB0cmFuc2FjdGlvbiBpbiB3aXJlIGZvcm1hdC4KCSAgICovCgkgIHNlcmlhbGl6ZShjb25maWcpIHsKCSAgICBjb25zdCB7CgkgICAgICByZXF1aXJlQWxsU2lnbmF0dXJlcywKCSAgICAgIHZlcmlmeVNpZ25hdHVyZXMKCSAgICB9ID0gT2JqZWN0LmFzc2lnbih7CgkgICAgICByZXF1aXJlQWxsU2lnbmF0dXJlczogdHJ1ZSwKCSAgICAgIHZlcmlmeVNpZ25hdHVyZXM6IHRydWUKCSAgICB9LCBjb25maWcpOwoJICAgIGNvbnN0IHNpZ25EYXRhID0gdGhpcy5zZXJpYWxpemVNZXNzYWdlKCk7CgkgICAgaWYgKHZlcmlmeVNpZ25hdHVyZXMpIHsKCSAgICAgIGNvbnN0IHNpZ0Vycm9ycyA9IHRoaXMuX2dldE1lc3NhZ2VTaWduZWRuZXNzRXJyb3JzKHNpZ25EYXRhLCByZXF1aXJlQWxsU2lnbmF0dXJlcyk7CgkgICAgICBpZiAoc2lnRXJyb3JzKSB7CgkgICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSAnU2lnbmF0dXJlIHZlcmlmaWNhdGlvbiBmYWlsZWQuJzsKCSAgICAgICAgaWYgKHNpZ0Vycm9ycy5pbnZhbGlkKSB7CgkgICAgICAgICAgZXJyb3JNZXNzYWdlICs9IGBcbkludmFsaWQgc2lnbmF0dXJlIGZvciBwdWJsaWMga2V5JHtzaWdFcnJvcnMuaW52YWxpZC5sZW5ndGggPT09IDEgPyAnJyA6ICcocyknfSBbXGAke3NpZ0Vycm9ycy5pbnZhbGlkLm1hcChwID0+IHAudG9CYXNlNTgoKSkuam9pbignYCwgYCcpfVxgXS5gOwoJICAgICAgICB9CgkgICAgICAgIGlmIChzaWdFcnJvcnMubWlzc2luZykgewoJICAgICAgICAgIGVycm9yTWVzc2FnZSArPSBgXG5NaXNzaW5nIHNpZ25hdHVyZSBmb3IgcHVibGljIGtleSR7c2lnRXJyb3JzLm1pc3NpbmcubGVuZ3RoID09PSAxID8gJycgOiAnKHMpJ30gW1xgJHtzaWdFcnJvcnMubWlzc2luZy5tYXAocCA9PiBwLnRvQmFzZTU4KCkpLmpvaW4oJ2AsIGAnKX1cYF0uYDsKCSAgICAgICAgfQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHRoaXMuX3NlcmlhbGl6ZShzaWduRGF0YSk7CgkgIH0KCgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIF9zZXJpYWxpemUoc2lnbkRhdGEpIHsKCSAgICBjb25zdCB7CgkgICAgICBzaWduYXR1cmVzCgkgICAgfSA9IHRoaXM7CgkgICAgY29uc3Qgc2lnbmF0dXJlQ291bnQgPSBbXTsKCSAgICBlbmNvZGVMZW5ndGgoc2lnbmF0dXJlQ291bnQsIHNpZ25hdHVyZXMubGVuZ3RoKTsKCSAgICBjb25zdCB0cmFuc2FjdGlvbkxlbmd0aCA9IHNpZ25hdHVyZUNvdW50Lmxlbmd0aCArIHNpZ25hdHVyZXMubGVuZ3RoICogNjQgKyBzaWduRGF0YS5sZW5ndGg7CgkgICAgY29uc3Qgd2lyZVRyYW5zYWN0aW9uID0gYnVmZmVyRXhwb3J0cy5CdWZmZXIuYWxsb2ModHJhbnNhY3Rpb25MZW5ndGgpOwoJICAgIGFzc2VydCQxKHNpZ25hdHVyZXMubGVuZ3RoIDwgMjU2KTsKCSAgICBidWZmZXJFeHBvcnRzLkJ1ZmZlci5mcm9tKHNpZ25hdHVyZUNvdW50KS5jb3B5KHdpcmVUcmFuc2FjdGlvbiwgMCk7CgkgICAgc2lnbmF0dXJlcy5mb3JFYWNoKCh7CgkgICAgICBzaWduYXR1cmUKCSAgICB9LCBpbmRleCkgPT4gewoJICAgICAgaWYgKHNpZ25hdHVyZSAhPT0gbnVsbCkgewoJICAgICAgICBhc3NlcnQkMShzaWduYXR1cmUubGVuZ3RoID09PSA2NCwgYHNpZ25hdHVyZSBoYXMgaW52YWxpZCBsZW5ndGhgKTsKCSAgICAgICAgYnVmZmVyRXhwb3J0cy5CdWZmZXIuZnJvbShzaWduYXR1cmUpLmNvcHkod2lyZVRyYW5zYWN0aW9uLCBzaWduYXR1cmVDb3VudC5sZW5ndGggKyBpbmRleCAqIDY0KTsKCSAgICAgIH0KCSAgICB9KTsKCSAgICBzaWduRGF0YS5jb3B5KHdpcmVUcmFuc2FjdGlvbiwgc2lnbmF0dXJlQ291bnQubGVuZ3RoICsgc2lnbmF0dXJlcy5sZW5ndGggKiA2NCk7CgkgICAgYXNzZXJ0JDEod2lyZVRyYW5zYWN0aW9uLmxlbmd0aCA8PSBQQUNLRVRfREFUQV9TSVpFLCBgVHJhbnNhY3Rpb24gdG9vIGxhcmdlOiAke3dpcmVUcmFuc2FjdGlvbi5sZW5ndGh9ID4gJHtQQUNLRVRfREFUQV9TSVpFfWApOwoJICAgIHJldHVybiB3aXJlVHJhbnNhY3Rpb247CgkgIH0KCgkgIC8qKgoJICAgKiBEZXByZWNhdGVkIG1ldGhvZAoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIGdldCBrZXlzKCkgewoJICAgIGFzc2VydCQxKHRoaXMuaW5zdHJ1Y3Rpb25zLmxlbmd0aCA9PT0gMSk7CgkgICAgcmV0dXJuIHRoaXMuaW5zdHJ1Y3Rpb25zWzBdLmtleXMubWFwKGtleU9iaiA9PiBrZXlPYmoucHVia2V5KTsKCSAgfQoKCSAgLyoqCgkgICAqIERlcHJlY2F0ZWQgbWV0aG9kCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgZ2V0IHByb2dyYW1JZCgpIHsKCSAgICBhc3NlcnQkMSh0aGlzLmluc3RydWN0aW9ucy5sZW5ndGggPT09IDEpOwoJICAgIHJldHVybiB0aGlzLmluc3RydWN0aW9uc1swXS5wcm9ncmFtSWQ7CgkgIH0KCgkgIC8qKgoJICAgKiBEZXByZWNhdGVkIG1ldGhvZAoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIGdldCBkYXRhKCkgewoJICAgIGFzc2VydCQxKHRoaXMuaW5zdHJ1Y3Rpb25zLmxlbmd0aCA9PT0gMSk7CgkgICAgcmV0dXJuIHRoaXMuaW5zdHJ1Y3Rpb25zWzBdLmRhdGE7CgkgIH0KCgkgIC8qKgoJICAgKiBQYXJzZSBhIHdpcmUgdHJhbnNhY3Rpb24gaW50byBhIFRyYW5zYWN0aW9uIG9iamVjdC4KCSAgICoKCSAgICogQHBhcmFtIHtCdWZmZXIgfCBVaW50OEFycmF5IHwgQXJyYXk8bnVtYmVyPn0gYnVmZmVyIFNpZ25hdHVyZSBvZiB3aXJlIFRyYW5zYWN0aW9uCgkgICAqCgkgICAqIEByZXR1cm5zIHtUcmFuc2FjdGlvbn0gVHJhbnNhY3Rpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBzaWduYXR1cmUKCSAgICovCgkgIHN0YXRpYyBmcm9tKGJ1ZmZlcikgewoJICAgIC8vIFNsaWNlIHVwIHdpcmUgZGF0YQoJICAgIGxldCBieXRlQXJyYXkgPSBbLi4uYnVmZmVyXTsKCSAgICBjb25zdCBzaWduYXR1cmVDb3VudCA9IGRlY29kZUxlbmd0aChieXRlQXJyYXkpOwoJICAgIGxldCBzaWduYXR1cmVzID0gW107CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaWduYXR1cmVDb3VudDsgaSsrKSB7CgkgICAgICBjb25zdCBzaWduYXR1cmUgPSBndWFyZGVkU3BsaWNlKGJ5dGVBcnJheSwgMCwgU0lHTkFUVVJFX0xFTkdUSF9JTl9CWVRFUyk7CgkgICAgICBzaWduYXR1cmVzLnB1c2goYnM1OC5lbmNvZGUoYnVmZmVyRXhwb3J0cy5CdWZmZXIuZnJvbShzaWduYXR1cmUpKSk7CgkgICAgfQoJICAgIHJldHVybiBUcmFuc2FjdGlvbi5wb3B1bGF0ZShNZXNzYWdlLmZyb20oYnl0ZUFycmF5KSwgc2lnbmF0dXJlcyk7CgkgIH0KCgkgIC8qKgoJICAgKiBQb3B1bGF0ZSBUcmFuc2FjdGlvbiBvYmplY3QgZnJvbSBtZXNzYWdlIGFuZCBzaWduYXR1cmVzCgkgICAqCgkgICAqIEBwYXJhbSB7TWVzc2FnZX0gbWVzc2FnZSBNZXNzYWdlIG9mIHRyYW5zYWN0aW9uCgkgICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gc2lnbmF0dXJlcyBMaXN0IG9mIHNpZ25hdHVyZXMgdG8gYXNzaWduIHRvIHRoZSB0cmFuc2FjdGlvbgoJICAgKgoJICAgKiBAcmV0dXJucyB7VHJhbnNhY3Rpb259IFRoZSBwb3B1bGF0ZWQgVHJhbnNhY3Rpb24KCSAgICovCgkgIHN0YXRpYyBwb3B1bGF0ZShtZXNzYWdlLCBzaWduYXR1cmVzID0gW10pIHsKCSAgICBjb25zdCB0cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpOwoJICAgIHRyYW5zYWN0aW9uLnJlY2VudEJsb2NraGFzaCA9IG1lc3NhZ2UucmVjZW50QmxvY2toYXNoOwoJICAgIGlmIChtZXNzYWdlLmhlYWRlci5udW1SZXF1aXJlZFNpZ25hdHVyZXMgPiAwKSB7CgkgICAgICB0cmFuc2FjdGlvbi5mZWVQYXllciA9IG1lc3NhZ2UuYWNjb3VudEtleXNbMF07CgkgICAgfQoJICAgIHNpZ25hdHVyZXMuZm9yRWFjaCgoc2lnbmF0dXJlLCBpbmRleCkgPT4gewoJICAgICAgY29uc3Qgc2lnUHVia2V5UGFpciA9IHsKCSAgICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmUgPT0gYnM1OC5lbmNvZGUoREVGQVVMVF9TSUdOQVRVUkUpID8gbnVsbCA6IGJzNTguZGVjb2RlKHNpZ25hdHVyZSksCgkgICAgICAgIHB1YmxpY0tleTogbWVzc2FnZS5hY2NvdW50S2V5c1tpbmRleF0KCSAgICAgIH07CgkgICAgICB0cmFuc2FjdGlvbi5zaWduYXR1cmVzLnB1c2goc2lnUHVia2V5UGFpcik7CgkgICAgfSk7CgkgICAgbWVzc2FnZS5pbnN0cnVjdGlvbnMuZm9yRWFjaChpbnN0cnVjdGlvbiA9PiB7CgkgICAgICBjb25zdCBrZXlzID0gaW5zdHJ1Y3Rpb24uYWNjb3VudHMubWFwKGFjY291bnQgPT4gewoJICAgICAgICBjb25zdCBwdWJrZXkgPSBtZXNzYWdlLmFjY291bnRLZXlzW2FjY291bnRdOwoJICAgICAgICByZXR1cm4gewoJICAgICAgICAgIHB1YmtleSwKCSAgICAgICAgICBpc1NpZ25lcjogdHJhbnNhY3Rpb24uc2lnbmF0dXJlcy5zb21lKGtleU9iaiA9PiBrZXlPYmoucHVibGljS2V5LnRvU3RyaW5nKCkgPT09IHB1YmtleS50b1N0cmluZygpKSB8fCBtZXNzYWdlLmlzQWNjb3VudFNpZ25lcihhY2NvdW50KSwKCSAgICAgICAgICBpc1dyaXRhYmxlOiBtZXNzYWdlLmlzQWNjb3VudFdyaXRhYmxlKGFjY291bnQpCgkgICAgICAgIH07CgkgICAgICB9KTsKCSAgICAgIHRyYW5zYWN0aW9uLmluc3RydWN0aW9ucy5wdXNoKG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHsKCSAgICAgICAga2V5cywKCSAgICAgICAgcHJvZ3JhbUlkOiBtZXNzYWdlLmFjY291bnRLZXlzW2luc3RydWN0aW9uLnByb2dyYW1JZEluZGV4XSwKCSAgICAgICAgZGF0YTogYnM1OC5kZWNvZGUoaW5zdHJ1Y3Rpb24uZGF0YSkKCSAgICAgIH0pKTsKCSAgICB9KTsKCSAgICB0cmFuc2FjdGlvbi5fbWVzc2FnZSA9IG1lc3NhZ2U7CgkgICAgdHJhbnNhY3Rpb24uX2pzb24gPSB0cmFuc2FjdGlvbi50b0pTT04oKTsKCSAgICByZXR1cm4gdHJhbnNhY3Rpb247CgkgIH0KCX0KCgljbGFzcyBUcmFuc2FjdGlvbk1lc3NhZ2UgewoJICBjb25zdHJ1Y3RvcihhcmdzKSB7CgkgICAgdGhpcy5wYXllcktleSA9IHZvaWQgMDsKCSAgICB0aGlzLmluc3RydWN0aW9ucyA9IHZvaWQgMDsKCSAgICB0aGlzLnJlY2VudEJsb2NraGFzaCA9IHZvaWQgMDsKCSAgICB0aGlzLnBheWVyS2V5ID0gYXJncy5wYXllcktleTsKCSAgICB0aGlzLmluc3RydWN0aW9ucyA9IGFyZ3MuaW5zdHJ1Y3Rpb25zOwoJICAgIHRoaXMucmVjZW50QmxvY2toYXNoID0gYXJncy5yZWNlbnRCbG9ja2hhc2g7CgkgIH0KCSAgc3RhdGljIGRlY29tcGlsZShtZXNzYWdlLCBhcmdzKSB7CgkgICAgY29uc3QgewoJICAgICAgaGVhZGVyLAoJICAgICAgY29tcGlsZWRJbnN0cnVjdGlvbnMsCgkgICAgICByZWNlbnRCbG9ja2hhc2gKCSAgICB9ID0gbWVzc2FnZTsKCSAgICBjb25zdCB7CgkgICAgICBudW1SZXF1aXJlZFNpZ25hdHVyZXMsCgkgICAgICBudW1SZWFkb25seVNpZ25lZEFjY291bnRzLAoJICAgICAgbnVtUmVhZG9ubHlVbnNpZ25lZEFjY291bnRzCgkgICAgfSA9IGhlYWRlcjsKCSAgICBjb25zdCBudW1Xcml0YWJsZVNpZ25lZEFjY291bnRzID0gbnVtUmVxdWlyZWRTaWduYXR1cmVzIC0gbnVtUmVhZG9ubHlTaWduZWRBY2NvdW50czsKCSAgICBhc3NlcnQkMShudW1Xcml0YWJsZVNpZ25lZEFjY291bnRzID4gMCwgJ01lc3NhZ2UgaGVhZGVyIGlzIGludmFsaWQnKTsKCSAgICBjb25zdCBudW1Xcml0YWJsZVVuc2lnbmVkQWNjb3VudHMgPSBtZXNzYWdlLnN0YXRpY0FjY291bnRLZXlzLmxlbmd0aCAtIG51bVJlcXVpcmVkU2lnbmF0dXJlcyAtIG51bVJlYWRvbmx5VW5zaWduZWRBY2NvdW50czsKCSAgICBhc3NlcnQkMShudW1Xcml0YWJsZVVuc2lnbmVkQWNjb3VudHMgPj0gMCwgJ01lc3NhZ2UgaGVhZGVyIGlzIGludmFsaWQnKTsKCSAgICBjb25zdCBhY2NvdW50S2V5cyA9IG1lc3NhZ2UuZ2V0QWNjb3VudEtleXMoYXJncyk7CgkgICAgY29uc3QgcGF5ZXJLZXkgPSBhY2NvdW50S2V5cy5nZXQoMCk7CgkgICAgaWYgKHBheWVyS2V5ID09PSB1bmRlZmluZWQpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGRlY29tcGlsZSBtZXNzYWdlIGJlY2F1c2Ugbm8gYWNjb3VudCBrZXlzIHdlcmUgZm91bmQnKTsKCSAgICB9CgkgICAgY29uc3QgaW5zdHJ1Y3Rpb25zID0gW107CgkgICAgZm9yIChjb25zdCBjb21waWxlZEl4IG9mIGNvbXBpbGVkSW5zdHJ1Y3Rpb25zKSB7CgkgICAgICBjb25zdCBrZXlzID0gW107CgkgICAgICBmb3IgKGNvbnN0IGtleUluZGV4IG9mIGNvbXBpbGVkSXguYWNjb3VudEtleUluZGV4ZXMpIHsKCSAgICAgICAgY29uc3QgcHVia2V5ID0gYWNjb3VudEtleXMuZ2V0KGtleUluZGV4KTsKCSAgICAgICAgaWYgKHB1YmtleSA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZmluZCBrZXkgZm9yIGFjY291bnQga2V5IGluZGV4ICR7a2V5SW5kZXh9YCk7CgkgICAgICAgIH0KCSAgICAgICAgY29uc3QgaXNTaWduZXIgPSBrZXlJbmRleCA8IG51bVJlcXVpcmVkU2lnbmF0dXJlczsKCSAgICAgICAgbGV0IGlzV3JpdGFibGU7CgkgICAgICAgIGlmIChpc1NpZ25lcikgewoJICAgICAgICAgIGlzV3JpdGFibGUgPSBrZXlJbmRleCA8IG51bVdyaXRhYmxlU2lnbmVkQWNjb3VudHM7CgkgICAgICAgIH0gZWxzZSBpZiAoa2V5SW5kZXggPCBhY2NvdW50S2V5cy5zdGF0aWNBY2NvdW50S2V5cy5sZW5ndGgpIHsKCSAgICAgICAgICBpc1dyaXRhYmxlID0ga2V5SW5kZXggLSBudW1SZXF1aXJlZFNpZ25hdHVyZXMgPCBudW1Xcml0YWJsZVVuc2lnbmVkQWNjb3VudHM7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgaXNXcml0YWJsZSA9IGtleUluZGV4IC0gYWNjb3VudEtleXMuc3RhdGljQWNjb3VudEtleXMubGVuZ3RoIDwKCSAgICAgICAgICAvLyBhY2NvdW50S2V5c0Zyb21Mb29rdXBzIGNhbm5vdCBiZSB1bmRlZmluZWQgYmVjYXVzZSB3ZSBhbHJlYWR5IGZvdW5kIGEgcHVia2V5IGZvciB0aGlzIGluZGV4IGFib3ZlCgkgICAgICAgICAgYWNjb3VudEtleXMuYWNjb3VudEtleXNGcm9tTG9va3Vwcy53cml0YWJsZS5sZW5ndGg7CgkgICAgICAgIH0KCSAgICAgICAga2V5cy5wdXNoKHsKCSAgICAgICAgICBwdWJrZXksCgkgICAgICAgICAgaXNTaWduZXI6IGtleUluZGV4IDwgaGVhZGVyLm51bVJlcXVpcmVkU2lnbmF0dXJlcywKCSAgICAgICAgICBpc1dyaXRhYmxlCgkgICAgICAgIH0pOwoJICAgICAgfQoJICAgICAgY29uc3QgcHJvZ3JhbUlkID0gYWNjb3VudEtleXMuZ2V0KGNvbXBpbGVkSXgucHJvZ3JhbUlkSW5kZXgpOwoJICAgICAgaWYgKHByb2dyYW1JZCA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGZpbmQgcHJvZ3JhbSBpZCBmb3IgcHJvZ3JhbSBpZCBpbmRleCAke2NvbXBpbGVkSXgucHJvZ3JhbUlkSW5kZXh9YCk7CgkgICAgICB9CgkgICAgICBpbnN0cnVjdGlvbnMucHVzaChuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICAgIHByb2dyYW1JZCwKCSAgICAgICAgZGF0YTogdG9CdWZmZXIoY29tcGlsZWRJeC5kYXRhKSwKCSAgICAgICAga2V5cwoJICAgICAgfSkpOwoJICAgIH0KCSAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uTWVzc2FnZSh7CgkgICAgICBwYXllcktleSwKCSAgICAgIGluc3RydWN0aW9ucywKCSAgICAgIHJlY2VudEJsb2NraGFzaAoJICAgIH0pOwoJICB9CgkgIGNvbXBpbGVUb0xlZ2FjeU1lc3NhZ2UoKSB7CgkgICAgcmV0dXJuIE1lc3NhZ2UuY29tcGlsZSh7CgkgICAgICBwYXllcktleTogdGhpcy5wYXllcktleSwKCSAgICAgIHJlY2VudEJsb2NraGFzaDogdGhpcy5yZWNlbnRCbG9ja2hhc2gsCgkgICAgICBpbnN0cnVjdGlvbnM6IHRoaXMuaW5zdHJ1Y3Rpb25zCgkgICAgfSk7CgkgIH0KCSAgY29tcGlsZVRvVjBNZXNzYWdlKGFkZHJlc3NMb29rdXBUYWJsZUFjY291bnRzKSB7CgkgICAgcmV0dXJuIE1lc3NhZ2VWMC5jb21waWxlKHsKCSAgICAgIHBheWVyS2V5OiB0aGlzLnBheWVyS2V5LAoJICAgICAgcmVjZW50QmxvY2toYXNoOiB0aGlzLnJlY2VudEJsb2NraGFzaCwKCSAgICAgIGluc3RydWN0aW9uczogdGhpcy5pbnN0cnVjdGlvbnMsCgkgICAgICBhZGRyZXNzTG9va3VwVGFibGVBY2NvdW50cwoJICAgIH0pOwoJICB9Cgl9CgoJLyoqCgkgKiBWZXJzaW9uZWQgdHJhbnNhY3Rpb24gY2xhc3MKCSAqLwoJY2xhc3MgVmVyc2lvbmVkVHJhbnNhY3Rpb24gewoJICBnZXQgdmVyc2lvbigpIHsKCSAgICByZXR1cm4gdGhpcy5tZXNzYWdlLnZlcnNpb247CgkgIH0KCSAgY29uc3RydWN0b3IobWVzc2FnZSwgc2lnbmF0dXJlcykgewoJICAgIHRoaXMuc2lnbmF0dXJlcyA9IHZvaWQgMDsKCSAgICB0aGlzLm1lc3NhZ2UgPSB2b2lkIDA7CgkgICAgaWYgKHNpZ25hdHVyZXMgIT09IHVuZGVmaW5lZCkgewoJICAgICAgYXNzZXJ0JDEoc2lnbmF0dXJlcy5sZW5ndGggPT09IG1lc3NhZ2UuaGVhZGVyLm51bVJlcXVpcmVkU2lnbmF0dXJlcywgJ0V4cGVjdGVkIHNpZ25hdHVyZXMgbGVuZ3RoIHRvIGJlIGVxdWFsIHRvIHRoZSBudW1iZXIgb2YgcmVxdWlyZWQgc2lnbmF0dXJlcycpOwoJICAgICAgdGhpcy5zaWduYXR1cmVzID0gc2lnbmF0dXJlczsKCSAgICB9IGVsc2UgewoJICAgICAgY29uc3QgZGVmYXVsdFNpZ25hdHVyZXMgPSBbXTsKCSAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWVzc2FnZS5oZWFkZXIubnVtUmVxdWlyZWRTaWduYXR1cmVzOyBpKyspIHsKCSAgICAgICAgZGVmYXVsdFNpZ25hdHVyZXMucHVzaChuZXcgVWludDhBcnJheShTSUdOQVRVUkVfTEVOR1RIX0lOX0JZVEVTKSk7CgkgICAgICB9CgkgICAgICB0aGlzLnNpZ25hdHVyZXMgPSBkZWZhdWx0U2lnbmF0dXJlczsKCSAgICB9CgkgICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKCSAgfQoJICBzZXJpYWxpemUoKSB7CgkgICAgY29uc3Qgc2VyaWFsaXplZE1lc3NhZ2UgPSB0aGlzLm1lc3NhZ2Uuc2VyaWFsaXplKCk7CgkgICAgY29uc3QgZW5jb2RlZFNpZ25hdHVyZXNMZW5ndGggPSBBcnJheSgpOwoJICAgIGVuY29kZUxlbmd0aChlbmNvZGVkU2lnbmF0dXJlc0xlbmd0aCwgdGhpcy5zaWduYXR1cmVzLmxlbmd0aCk7CgkgICAgY29uc3QgdHJhbnNhY3Rpb25MYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy5ibG9iKGVuY29kZWRTaWduYXR1cmVzTGVuZ3RoLmxlbmd0aCwgJ2VuY29kZWRTaWduYXR1cmVzTGVuZ3RoJyksIExheW91dEV4cG9ydHMuc2VxKHNpZ25hdHVyZSgpLCB0aGlzLnNpZ25hdHVyZXMubGVuZ3RoLCAnc2lnbmF0dXJlcycpLCBMYXlvdXRFeHBvcnRzLmJsb2Ioc2VyaWFsaXplZE1lc3NhZ2UubGVuZ3RoLCAnc2VyaWFsaXplZE1lc3NhZ2UnKV0pOwoJICAgIGNvbnN0IHNlcmlhbGl6ZWRUcmFuc2FjdGlvbiA9IG5ldyBVaW50OEFycmF5KDIwNDgpOwoJICAgIGNvbnN0IHNlcmlhbGl6ZWRUcmFuc2FjdGlvbkxlbmd0aCA9IHRyYW5zYWN0aW9uTGF5b3V0LmVuY29kZSh7CgkgICAgICBlbmNvZGVkU2lnbmF0dXJlc0xlbmd0aDogbmV3IFVpbnQ4QXJyYXkoZW5jb2RlZFNpZ25hdHVyZXNMZW5ndGgpLAoJICAgICAgc2lnbmF0dXJlczogdGhpcy5zaWduYXR1cmVzLAoJICAgICAgc2VyaWFsaXplZE1lc3NhZ2UKCSAgICB9LCBzZXJpYWxpemVkVHJhbnNhY3Rpb24pOwoJICAgIHJldHVybiBzZXJpYWxpemVkVHJhbnNhY3Rpb24uc2xpY2UoMCwgc2VyaWFsaXplZFRyYW5zYWN0aW9uTGVuZ3RoKTsKCSAgfQoJICBzdGF0aWMgZGVzZXJpYWxpemUoc2VyaWFsaXplZFRyYW5zYWN0aW9uKSB7CgkgICAgbGV0IGJ5dGVBcnJheSA9IFsuLi5zZXJpYWxpemVkVHJhbnNhY3Rpb25dOwoJICAgIGNvbnN0IHNpZ25hdHVyZXMgPSBbXTsKCSAgICBjb25zdCBzaWduYXR1cmVzTGVuZ3RoID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaWduYXR1cmVzTGVuZ3RoOyBpKyspIHsKCSAgICAgIHNpZ25hdHVyZXMucHVzaChuZXcgVWludDhBcnJheShndWFyZGVkU3BsaWNlKGJ5dGVBcnJheSwgMCwgU0lHTkFUVVJFX0xFTkdUSF9JTl9CWVRFUykpKTsKCSAgICB9CgkgICAgY29uc3QgbWVzc2FnZSA9IFZlcnNpb25lZE1lc3NhZ2UuZGVzZXJpYWxpemUobmV3IFVpbnQ4QXJyYXkoYnl0ZUFycmF5KSk7CgkgICAgcmV0dXJuIG5ldyBWZXJzaW9uZWRUcmFuc2FjdGlvbihtZXNzYWdlLCBzaWduYXR1cmVzKTsKCSAgfQoJICBzaWduKHNpZ25lcnMpIHsKCSAgICBjb25zdCBtZXNzYWdlRGF0YSA9IHRoaXMubWVzc2FnZS5zZXJpYWxpemUoKTsKCSAgICBjb25zdCBzaWduZXJQdWJrZXlzID0gdGhpcy5tZXNzYWdlLnN0YXRpY0FjY291bnRLZXlzLnNsaWNlKDAsIHRoaXMubWVzc2FnZS5oZWFkZXIubnVtUmVxdWlyZWRTaWduYXR1cmVzKTsKCSAgICBmb3IgKGNvbnN0IHNpZ25lciBvZiBzaWduZXJzKSB7CgkgICAgICBjb25zdCBzaWduZXJJbmRleCA9IHNpZ25lclB1YmtleXMuZmluZEluZGV4KHB1YmtleSA9PiBwdWJrZXkuZXF1YWxzKHNpZ25lci5wdWJsaWNLZXkpKTsKCSAgICAgIGFzc2VydCQxKHNpZ25lckluZGV4ID49IDAsIGBDYW5ub3Qgc2lnbiB3aXRoIG5vbiBzaWduZXIga2V5ICR7c2lnbmVyLnB1YmxpY0tleS50b0Jhc2U1OCgpfWApOwoJICAgICAgdGhpcy5zaWduYXR1cmVzW3NpZ25lckluZGV4XSA9IHNpZ24obWVzc2FnZURhdGEsIHNpZ25lci5zZWNyZXRLZXkpOwoJICAgIH0KCSAgfQoJICBhZGRTaWduYXR1cmUocHVibGljS2V5LCBzaWduYXR1cmUpIHsKCSAgICBhc3NlcnQkMShzaWduYXR1cmUuYnl0ZUxlbmd0aCA9PT0gNjQsICdTaWduYXR1cmUgbXVzdCBiZSA2NCBieXRlcyBsb25nJyk7CgkgICAgY29uc3Qgc2lnbmVyUHVia2V5cyA9IHRoaXMubWVzc2FnZS5zdGF0aWNBY2NvdW50S2V5cy5zbGljZSgwLCB0aGlzLm1lc3NhZ2UuaGVhZGVyLm51bVJlcXVpcmVkU2lnbmF0dXJlcyk7CgkgICAgY29uc3Qgc2lnbmVySW5kZXggPSBzaWduZXJQdWJrZXlzLmZpbmRJbmRleChwdWJrZXkgPT4gcHVia2V5LmVxdWFscyhwdWJsaWNLZXkpKTsKCSAgICBhc3NlcnQkMShzaWduZXJJbmRleCA+PSAwLCBgQ2FuIG5vdCBhZGQgc2lnbmF0dXJlOyBcYCR7cHVibGljS2V5LnRvQmFzZTU4KCl9XGAgaXMgbm90IHJlcXVpcmVkIHRvIHNpZ24gdGhpcyB0cmFuc2FjdGlvbmApOwoJICAgIHRoaXMuc2lnbmF0dXJlc1tzaWduZXJJbmRleF0gPSBzaWduYXR1cmU7CgkgIH0KCX0KCgkvLyBUT0RPOiBUaGVzZSBjb25zdGFudHMgc2hvdWxkIGJlIHJlbW92ZWQgaW4gZmF2b3Igb2YgcmVhZGluZyB0aGVtIG91dCBvZiBhCgkvLyBTeXNjYWxsIGFjY291bnQKCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCgljb25zdCBOVU1fVElDS1NfUEVSX1NFQ09ORCA9IDE2MDsKCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCgljb25zdCBERUZBVUxUX1RJQ0tTX1BFUl9TTE9UID0gNjQ7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgTlVNX1NMT1RTX1BFUl9TRUNPTkQgPSBOVU1fVElDS1NfUEVSX1NFQ09ORCAvIERFRkFVTFRfVElDS1NfUEVSX1NMT1Q7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgTVNfUEVSX1NMT1QgPSAxMDAwIC8gTlVNX1NMT1RTX1BFUl9TRUNPTkQ7CgoJY29uc3QgU1lTVkFSX0NMT0NLX1BVQktFWSA9IG5ldyBQdWJsaWNLZXkoJ1N5c3ZhckMxb2NrMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEnKTsKCWNvbnN0IFNZU1ZBUl9FUE9DSF9TQ0hFRFVMRV9QVUJLRVkgPSBuZXcgUHVibGljS2V5KCdTeXN2YXJFcG9jaFNjaGVkdTFlMTExMTExMTExMTExMTExMTExMTExMTExJyk7Cgljb25zdCBTWVNWQVJfSU5TVFJVQ1RJT05TX1BVQktFWSA9IG5ldyBQdWJsaWNLZXkoJ1N5c3ZhcjFuc3RydWN0aW9uczExMTExMTExMTExMTExMTExMTExMTExMTEnKTsKCWNvbnN0IFNZU1ZBUl9SRUNFTlRfQkxPQ0tIQVNIRVNfUFVCS0VZID0gbmV3IFB1YmxpY0tleSgnU3lzdmFyUmVjZW50QjFvY2tIYXNoZXMxMTExMTExMTExMTExMTExMTExMScpOwoJY29uc3QgU1lTVkFSX1JFTlRfUFVCS0VZID0gbmV3IFB1YmxpY0tleSgnU3lzdmFyUmVudDExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMScpOwoJY29uc3QgU1lTVkFSX1JFV0FSRFNfUFVCS0VZID0gbmV3IFB1YmxpY0tleSgnU3lzdmFyUmV3YXJkczExMTExMTExMTExMTExMTExMTExMTExMTExMTExMScpOwoJY29uc3QgU1lTVkFSX1NMT1RfSEFTSEVTX1BVQktFWSA9IG5ldyBQdWJsaWNLZXkoJ1N5c3ZhclMxb3RIYXNoZXMxMTExMTExMTExMTExMTExMTExMTExMTExMTEnKTsKCWNvbnN0IFNZU1ZBUl9TTE9UX0hJU1RPUllfUFVCS0VZID0gbmV3IFB1YmxpY0tleSgnU3lzdmFyUzFvdEhpc3RvcnkxMTExMTExMTExMTExMTExMTExMTExMTExMScpOwoJY29uc3QgU1lTVkFSX1NUQUtFX0hJU1RPUllfUFVCS0VZID0gbmV3IFB1YmxpY0tleSgnU3lzdmFyU3Rha2VIaXN0b3J5MTExMTExMTExMTExMTExMTExMTExMTExMScpOwoKCWNsYXNzIFNlbmRUcmFuc2FjdGlvbkVycm9yIGV4dGVuZHMgRXJyb3IgewoJICBjb25zdHJ1Y3Rvcih7CgkgICAgYWN0aW9uLAoJICAgIHNpZ25hdHVyZSwKCSAgICB0cmFuc2FjdGlvbk1lc3NhZ2UsCgkgICAgbG9ncwoJICB9KSB7CgkgICAgY29uc3QgbWF5YmVMb2dzT3V0cHV0ID0gbG9ncyA/IGBMb2dzOiBcbiR7SlNPTi5zdHJpbmdpZnkobG9ncy5zbGljZSgtMTApLCBudWxsLCAyKX0uIGAgOiAnJzsKCSAgICBjb25zdCBndWlkZVRleHQgPSAnXG5DYXRjaCB0aGUgYFNlbmRUcmFuc2FjdGlvbkVycm9yYCBhbmQgY2FsbCBgZ2V0TG9ncygpYCBvbiBpdCBmb3IgZnVsbCBkZXRhaWxzLic7CgkgICAgbGV0IG1lc3NhZ2U7CgkgICAgc3dpdGNoIChhY3Rpb24pIHsKCSAgICAgIGNhc2UgJ3NlbmQnOgoJICAgICAgICBtZXNzYWdlID0gYFRyYW5zYWN0aW9uICR7c2lnbmF0dXJlfSByZXN1bHRlZCBpbiBhbiBlcnJvci4gXG5gICsgYCR7dHJhbnNhY3Rpb25NZXNzYWdlfS4gYCArIG1heWJlTG9nc091dHB1dCArIGd1aWRlVGV4dDsKCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdzaW11bGF0ZSc6CgkgICAgICAgIG1lc3NhZ2UgPSBgU2ltdWxhdGlvbiBmYWlsZWQuIFxuTWVzc2FnZTogJHt0cmFuc2FjdGlvbk1lc3NhZ2V9LiBcbmAgKyBtYXliZUxvZ3NPdXRwdXQgKyBndWlkZVRleHQ7CgkgICAgICAgIGJyZWFrOwoJICAgICAgZGVmYXVsdDoKCSAgICAgICAgewoJICAgICAgICAgIG1lc3NhZ2UgPSBgVW5rbm93biBhY3Rpb24gJyR7KGEgPT4gYSkoYWN0aW9uKX0nYDsKCSAgICAgICAgfQoJICAgIH0KCSAgICBzdXBlcihtZXNzYWdlKTsKCSAgICB0aGlzLnNpZ25hdHVyZSA9IHZvaWQgMDsKCSAgICB0aGlzLnRyYW5zYWN0aW9uTWVzc2FnZSA9IHZvaWQgMDsKCSAgICB0aGlzLnRyYW5zYWN0aW9uTG9ncyA9IHZvaWQgMDsKCSAgICB0aGlzLnNpZ25hdHVyZSA9IHNpZ25hdHVyZTsKCSAgICB0aGlzLnRyYW5zYWN0aW9uTWVzc2FnZSA9IHRyYW5zYWN0aW9uTWVzc2FnZTsKCSAgICB0aGlzLnRyYW5zYWN0aW9uTG9ncyA9IGxvZ3MgPyBsb2dzIDogdW5kZWZpbmVkOwoJICB9CgkgIGdldCB0cmFuc2FjdGlvbkVycm9yKCkgewoJICAgIHJldHVybiB7CgkgICAgICBtZXNzYWdlOiB0aGlzLnRyYW5zYWN0aW9uTWVzc2FnZSwKCSAgICAgIGxvZ3M6IEFycmF5LmlzQXJyYXkodGhpcy50cmFuc2FjdGlvbkxvZ3MpID8gdGhpcy50cmFuc2FjdGlvbkxvZ3MgOiB1bmRlZmluZWQKCSAgICB9OwoJICB9CgoJICAvKiBAZGVwcmVjYXRlZCBVc2UgYGF3YWl0IGdldExvZ3MoKWAgaW5zdGVhZCAqLwoJICBnZXQgbG9ncygpIHsKCSAgICBjb25zdCBjYWNoZWRMb2dzID0gdGhpcy50cmFuc2FjdGlvbkxvZ3M7CgkgICAgaWYgKGNhY2hlZExvZ3MgIT0gbnVsbCAmJiB0eXBlb2YgY2FjaGVkTG9ncyA9PT0gJ29iamVjdCcgJiYgJ3RoZW4nIGluIGNhY2hlZExvZ3MpIHsKCSAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgfQoJICAgIHJldHVybiBjYWNoZWRMb2dzOwoJICB9CgkgIGFzeW5jIGdldExvZ3MoY29ubmVjdGlvbikgewoJICAgIGlmICghQXJyYXkuaXNBcnJheSh0aGlzLnRyYW5zYWN0aW9uTG9ncykpIHsKCSAgICAgIHRoaXMudHJhbnNhY3Rpb25Mb2dzID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJICAgICAgICBjb25uZWN0aW9uLmdldFRyYW5zYWN0aW9uKHRoaXMuc2lnbmF0dXJlKS50aGVuKHR4ID0+IHsKCSAgICAgICAgICBpZiAodHggJiYgdHgubWV0YSAmJiB0eC5tZXRhLmxvZ01lc3NhZ2VzKSB7CgkgICAgICAgICAgICBjb25zdCBsb2dzID0gdHgubWV0YS5sb2dNZXNzYWdlczsKCSAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb25Mb2dzID0gbG9nczsKCSAgICAgICAgICAgIHJlc29sdmUobG9ncyk7CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ0xvZyBtZXNzYWdlcyBub3QgZm91bmQnKSk7CgkgICAgICAgICAgfQoJICAgICAgICB9KS5jYXRjaChyZWplY3QpOwoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiBhd2FpdCB0aGlzLnRyYW5zYWN0aW9uTG9nczsKCSAgfQoJfQoKCS8vIEtlZXAgaW4gc3luYyB3aXRoIGNsaWVudC9zcmMvcnBjX2N1c3RvbV9lcnJvcnMucnMKCS8vIFR5cGVzY3JpcHQgYGVudW1zYCB0aHdhcnQgdHJlZS1zaGFraW5nLiBTZWUgaHR0cHM6Ly9iYXJnc3Rlbi5vcmcvanN0cy9lbnVtcy8KCWNvbnN0IFNvbGFuYUpTT05SUENFcnJvckNvZGUgPSB7CgkgIEpTT05fUlBDX1NFUlZFUl9FUlJPUl9CTE9DS19DTEVBTkVEX1VQOiAtMzIwMDEsCgkgIEpTT05fUlBDX1NFUlZFUl9FUlJPUl9TRU5EX1RSQU5TQUNUSU9OX1BSRUZMSUdIVF9GQUlMVVJFOiAtMzIwMDIsCgkgIEpTT05fUlBDX1NFUlZFUl9FUlJPUl9UUkFOU0FDVElPTl9TSUdOQVRVUkVfVkVSSUZJQ0FUSU9OX0ZBSUxVUkU6IC0zMjAwMywKCSAgSlNPTl9SUENfU0VSVkVSX0VSUk9SX0JMT0NLX05PVF9BVkFJTEFCTEU6IC0zMjAwNCwKCSAgSlNPTl9SUENfU0VSVkVSX0VSUk9SX05PREVfVU5IRUFMVEhZOiAtMzIwMDUsCgkgIEpTT05fUlBDX1NFUlZFUl9FUlJPUl9UUkFOU0FDVElPTl9QUkVDT01QSUxFX1ZFUklGSUNBVElPTl9GQUlMVVJFOiAtMzIwMDYsCgkgIEpTT05fUlBDX1NFUlZFUl9FUlJPUl9TTE9UX1NLSVBQRUQ6IC0zMjAwNywKCSAgSlNPTl9SUENfU0VSVkVSX0VSUk9SX05PX1NOQVBTSE9UOiAtMzIwMDgsCgkgIEpTT05fUlBDX1NFUlZFUl9FUlJPUl9MT05HX1RFUk1fU1RPUkFHRV9TTE9UX1NLSVBQRUQ6IC0zMjAwOSwKCSAgSlNPTl9SUENfU0VSVkVSX0VSUk9SX0tFWV9FWENMVURFRF9GUk9NX1NFQ09OREFSWV9JTkRFWDogLTMyMDEwLAoJICBKU09OX1JQQ19TRVJWRVJfRVJST1JfVFJBTlNBQ1RJT05fSElTVE9SWV9OT1RfQVZBSUxBQkxFOiAtMzIwMTEsCgkgIEpTT05fUlBDX1NDQU5fRVJST1I6IC0zMjAxMiwKCSAgSlNPTl9SUENfU0VSVkVSX0VSUk9SX1RSQU5TQUNUSU9OX1NJR05BVFVSRV9MRU5fTUlTTUFUQ0g6IC0zMjAxMywKCSAgSlNPTl9SUENfU0VSVkVSX0VSUk9SX0JMT0NLX1NUQVRVU19OT1RfQVZBSUxBQkxFX1lFVDogLTMyMDE0LAoJICBKU09OX1JQQ19TRVJWRVJfRVJST1JfVU5TVVBQT1JURURfVFJBTlNBQ1RJT05fVkVSU0lPTjogLTMyMDE1LAoJICBKU09OX1JQQ19TRVJWRVJfRVJST1JfTUlOX0NPTlRFWFRfU0xPVF9OT1RfUkVBQ0hFRDogLTMyMDE2Cgl9OwoJY2xhc3MgU29sYW5hSlNPTlJQQ0Vycm9yIGV4dGVuZHMgRXJyb3IgewoJICBjb25zdHJ1Y3Rvcih7CgkgICAgY29kZSwKCSAgICBtZXNzYWdlLAoJICAgIGRhdGEKCSAgfSwgY3VzdG9tTWVzc2FnZSkgewoJICAgIHN1cGVyKGN1c3RvbU1lc3NhZ2UgIT0gbnVsbCA/IGAke2N1c3RvbU1lc3NhZ2V9OiAke21lc3NhZ2V9YCA6IG1lc3NhZ2UpOwoJICAgIHRoaXMuY29kZSA9IHZvaWQgMDsKCSAgICB0aGlzLmRhdGEgPSB2b2lkIDA7CgkgICAgdGhpcy5jb2RlID0gY29kZTsKCSAgICB0aGlzLmRhdGEgPSBkYXRhOwoJICAgIHRoaXMubmFtZSA9ICdTb2xhbmFKU09OUlBDRXJyb3InOwoJICB9Cgl9CgoJLyoqCgkgKiBTaWduLCBzZW5kIGFuZCBjb25maXJtIGEgdHJhbnNhY3Rpb24uCgkgKgoJICogSWYgYGNvbW1pdG1lbnRgIG9wdGlvbiBpcyBub3Qgc3BlY2lmaWVkLCBkZWZhdWx0cyB0byAnbWF4JyBjb21taXRtZW50LgoJICoKCSAqIEBwYXJhbSB7Q29ubmVjdGlvbn0gY29ubmVjdGlvbgoJICogQHBhcmFtIHtUcmFuc2FjdGlvbn0gdHJhbnNhY3Rpb24KCSAqIEBwYXJhbSB7QXJyYXk8U2lnbmVyPn0gc2lnbmVycwoJICogQHBhcmFtIHtDb25maXJtT3B0aW9uc30gW29wdGlvbnNdCgkgKiBAcmV0dXJucyB7UHJvbWlzZTxUcmFuc2FjdGlvblNpZ25hdHVyZT59CgkgKi8KCWFzeW5jIGZ1bmN0aW9uIHNlbmRBbmRDb25maXJtVHJhbnNhY3Rpb24oY29ubmVjdGlvbiwgdHJhbnNhY3Rpb24sIHNpZ25lcnMsIG9wdGlvbnMpIHsKCSAgY29uc3Qgc2VuZE9wdGlvbnMgPSBvcHRpb25zICYmIHsKCSAgICBza2lwUHJlZmxpZ2h0OiBvcHRpb25zLnNraXBQcmVmbGlnaHQsCgkgICAgcHJlZmxpZ2h0Q29tbWl0bWVudDogb3B0aW9ucy5wcmVmbGlnaHRDb21taXRtZW50IHx8IG9wdGlvbnMuY29tbWl0bWVudCwKCSAgICBtYXhSZXRyaWVzOiBvcHRpb25zLm1heFJldHJpZXMsCgkgICAgbWluQ29udGV4dFNsb3Q6IG9wdGlvbnMubWluQ29udGV4dFNsb3QKCSAgfTsKCSAgY29uc3Qgc2lnbmF0dXJlID0gYXdhaXQgY29ubmVjdGlvbi5zZW5kVHJhbnNhY3Rpb24odHJhbnNhY3Rpb24sIHNpZ25lcnMsIHNlbmRPcHRpb25zKTsKCSAgbGV0IHN0YXR1czsKCSAgaWYgKHRyYW5zYWN0aW9uLnJlY2VudEJsb2NraGFzaCAhPSBudWxsICYmIHRyYW5zYWN0aW9uLmxhc3RWYWxpZEJsb2NrSGVpZ2h0ICE9IG51bGwpIHsKCSAgICBzdGF0dXMgPSAoYXdhaXQgY29ubmVjdGlvbi5jb25maXJtVHJhbnNhY3Rpb24oewoJICAgICAgYWJvcnRTaWduYWw6IG9wdGlvbnM/LmFib3J0U2lnbmFsLAoJICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmUsCgkgICAgICBibG9ja2hhc2g6IHRyYW5zYWN0aW9uLnJlY2VudEJsb2NraGFzaCwKCSAgICAgIGxhc3RWYWxpZEJsb2NrSGVpZ2h0OiB0cmFuc2FjdGlvbi5sYXN0VmFsaWRCbG9ja0hlaWdodAoJICAgIH0sIG9wdGlvbnMgJiYgb3B0aW9ucy5jb21taXRtZW50KSkudmFsdWU7CgkgIH0gZWxzZSBpZiAodHJhbnNhY3Rpb24ubWluTm9uY2VDb250ZXh0U2xvdCAhPSBudWxsICYmIHRyYW5zYWN0aW9uLm5vbmNlSW5mbyAhPSBudWxsKSB7CgkgICAgY29uc3QgewoJICAgICAgbm9uY2VJbnN0cnVjdGlvbgoJICAgIH0gPSB0cmFuc2FjdGlvbi5ub25jZUluZm87CgkgICAgY29uc3Qgbm9uY2VBY2NvdW50UHVia2V5ID0gbm9uY2VJbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleTsKCSAgICBzdGF0dXMgPSAoYXdhaXQgY29ubmVjdGlvbi5jb25maXJtVHJhbnNhY3Rpb24oewoJICAgICAgYWJvcnRTaWduYWw6IG9wdGlvbnM/LmFib3J0U2lnbmFsLAoJICAgICAgbWluQ29udGV4dFNsb3Q6IHRyYW5zYWN0aW9uLm1pbk5vbmNlQ29udGV4dFNsb3QsCgkgICAgICBub25jZUFjY291bnRQdWJrZXksCgkgICAgICBub25jZVZhbHVlOiB0cmFuc2FjdGlvbi5ub25jZUluZm8ubm9uY2UsCgkgICAgICBzaWduYXR1cmUKCSAgICB9LCBvcHRpb25zICYmIG9wdGlvbnMuY29tbWl0bWVudCkpLnZhbHVlOwoJICB9IGVsc2UgewoJICAgIGlmIChvcHRpb25zPy5hYm9ydFNpZ25hbCAhPSBudWxsKSB7CgkgICAgICBjb25zb2xlLndhcm4oJ3NlbmRBbmRDb25maXJtVHJhbnNhY3Rpb24oKTogQSB0cmFuc2FjdGlvbiB3aXRoIGEgZGVwcmVjYXRlZCBjb25maXJtYXRpb24gc3RyYXRlZ3kgd2FzICcgKyAnc3VwcGxpZWQgYWxvbmcgd2l0aCBhbiBgYWJvcnRTaWduYWxgLiBPbmx5IHRyYW5zYWN0aW9ucyBoYXZpbmcgYGxhc3RWYWxpZEJsb2NrSGVpZ2h0YCAnICsgJ29yIGEgY29tYmluYXRpb24gb2YgYG5vbmNlSW5mb2AgYW5kIGBtaW5Ob25jZUNvbnRleHRTbG90YCBhcmUgYWJvcnRhYmxlLicpOwoJICAgIH0KCSAgICBzdGF0dXMgPSAoYXdhaXQgY29ubmVjdGlvbi5jb25maXJtVHJhbnNhY3Rpb24oc2lnbmF0dXJlLCBvcHRpb25zICYmIG9wdGlvbnMuY29tbWl0bWVudCkpLnZhbHVlOwoJICB9CgkgIGlmIChzdGF0dXMuZXJyKSB7CgkgICAgaWYgKHNpZ25hdHVyZSAhPSBudWxsKSB7CgkgICAgICB0aHJvdyBuZXcgU2VuZFRyYW5zYWN0aW9uRXJyb3IoewoJICAgICAgICBhY3Rpb246ICdzZW5kJywKCSAgICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmUsCgkgICAgICAgIHRyYW5zYWN0aW9uTWVzc2FnZTogYFN0YXR1czogKCR7SlNPTi5zdHJpbmdpZnkoc3RhdHVzKX0pYAoJICAgICAgfSk7CgkgICAgfQoJICAgIHRocm93IG5ldyBFcnJvcihgVHJhbnNhY3Rpb24gJHtzaWduYXR1cmV9IGZhaWxlZCAoJHtKU09OLnN0cmluZ2lmeShzdGF0dXMpfSlgKTsKCSAgfQoJICByZXR1cm4gc2lnbmF0dXJlOwoJfQoKCS8vIHp6egoJZnVuY3Rpb24gc2xlZXAobXMpIHsKCSAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCS8qKgoJICogQGludGVybmFsCgkgKi8KCgkvKioKCSAqIFBvcHVsYXRlIGEgYnVmZmVyIG9mIGluc3RydWN0aW9uIGRhdGEgdXNpbmcgYW4gSW5zdHJ1Y3Rpb25UeXBlCgkgKiBAaW50ZXJuYWwKCSAqLwoJZnVuY3Rpb24gZW5jb2RlRGF0YSh0eXBlLCBmaWVsZHMpIHsKCSAgY29uc3QgYWxsb2NMZW5ndGggPSB0eXBlLmxheW91dC5zcGFuID49IDAgPyB0eXBlLmxheW91dC5zcGFuIDogZ2V0QWxsb2ModHlwZSwgZmllbGRzKTsKCSAgY29uc3QgZGF0YSA9IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmFsbG9jKGFsbG9jTGVuZ3RoKTsKCSAgY29uc3QgbGF5b3V0RmllbGRzID0gT2JqZWN0LmFzc2lnbih7CgkgICAgaW5zdHJ1Y3Rpb246IHR5cGUuaW5kZXgKCSAgfSwgZmllbGRzKTsKCSAgdHlwZS5sYXlvdXQuZW5jb2RlKGxheW91dEZpZWxkcywgZGF0YSk7CgkgIHJldHVybiBkYXRhOwoJfQoKCS8qKgoJICogRGVjb2RlIGluc3RydWN0aW9uIGRhdGEgYnVmZmVyIHVzaW5nIGFuIEluc3RydWN0aW9uVHlwZQoJICogQGludGVybmFsCgkgKi8KCWZ1bmN0aW9uIGRlY29kZURhdGEkMSh0eXBlLCBidWZmZXIpIHsKCSAgbGV0IGRhdGE7CgkgIHRyeSB7CgkgICAgZGF0YSA9IHR5cGUubGF5b3V0LmRlY29kZShidWZmZXIpOwoJICB9IGNhdGNoIChlcnIpIHsKCSAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgaW5zdHJ1Y3Rpb247ICcgKyBlcnIpOwoJICB9CgkgIGlmIChkYXRhLmluc3RydWN0aW9uICE9PSB0eXBlLmluZGV4KSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIGluc3RydWN0aW9uOyBpbnN0cnVjdGlvbiBpbmRleCBtaXNtYXRjaCAke2RhdGEuaW5zdHJ1Y3Rpb259ICE9ICR7dHlwZS5pbmRleH1gKTsKCSAgfQoJICByZXR1cm4gZGF0YTsKCX0KCgkvKioKCSAqIGh0dHBzOi8vZ2l0aHViLmNvbS9zb2xhbmEtbGFicy9zb2xhbmEvYmxvYi85MGJlZGQ3ZTA2N2I1YjhmM2RkYmI0NWRhMDBhNGU5Y2FiYjIyYzYyL3Nkay9zcmMvZmVlX2NhbGN1bGF0b3IucnMjTDctTDExCgkgKgoJICogQGludGVybmFsCgkgKi8KCWNvbnN0IEZlZUNhbGN1bGF0b3JMYXlvdXQgPSBMYXlvdXRFeHBvcnRzLm51NjQoJ2xhbXBvcnRzUGVyU2lnbmF0dXJlJyk7CgoJLyoqCgkgKiBDYWxjdWxhdG9yIGZvciB0cmFuc2FjdGlvbiBmZWVzLgoJICoKCSAqIEBkZXByZWNhdGVkIERlcHJlY2F0ZWQgc2luY2UgU29sYW5hIHYxLjguMC4KCSAqLwoKCS8qKgoJICogU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9zb2xhbmEtbGFicy9zb2xhbmEvYmxvYi8wZWEyODQzZWM5Y2RjNTE3NTcyYjhlNjJjOTU5ZjQxYjU1Y2Y0NDUzL3Nkay9zcmMvbm9uY2Vfc3RhdGUucnMjTDI5LUwzMgoJICoKCSAqIEBpbnRlcm5hbAoJICovCgljb25zdCBOb25jZUFjY291bnRMYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ3ZlcnNpb24nKSwgTGF5b3V0RXhwb3J0cy51MzIoJ3N0YXRlJyksIHB1YmxpY0tleSgnYXV0aG9yaXplZFB1YmtleScpLCBwdWJsaWNLZXkoJ25vbmNlJyksIExheW91dEV4cG9ydHMuc3RydWN0KFtGZWVDYWxjdWxhdG9yTGF5b3V0XSwgJ2ZlZUNhbGN1bGF0b3InKV0pOwoJY29uc3QgTk9OQ0VfQUNDT1VOVF9MRU5HVEggPSBOb25jZUFjY291bnRMYXlvdXQuc3BhbjsKCgkvKioKCSAqIEEgZHVyYWJsZSBub25jZSBpcyBhIDMyIGJ5dGUgdmFsdWUgZW5jb2RlZCBhcyBhIGJhc2U1OCBzdHJpbmcuCgkgKi8KCgkvKioKCSAqIE5vbmNlQWNjb3VudCBjbGFzcwoJICovCgljbGFzcyBOb25jZUFjY291bnQgewoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBjb25zdHJ1Y3RvcihhcmdzKSB7CgkgICAgdGhpcy5hdXRob3JpemVkUHVia2V5ID0gdm9pZCAwOwoJICAgIHRoaXMubm9uY2UgPSB2b2lkIDA7CgkgICAgdGhpcy5mZWVDYWxjdWxhdG9yID0gdm9pZCAwOwoJICAgIHRoaXMuYXV0aG9yaXplZFB1YmtleSA9IGFyZ3MuYXV0aG9yaXplZFB1YmtleTsKCSAgICB0aGlzLm5vbmNlID0gYXJncy5ub25jZTsKCSAgICB0aGlzLmZlZUNhbGN1bGF0b3IgPSBhcmdzLmZlZUNhbGN1bGF0b3I7CgkgIH0KCgkgIC8qKgoJICAgKiBEZXNlcmlhbGl6ZSBOb25jZUFjY291bnQgZnJvbSB0aGUgYWNjb3VudCBkYXRhLgoJICAgKgoJICAgKiBAcGFyYW0gYnVmZmVyIGFjY291bnQgZGF0YQoJICAgKiBAcmV0dXJuIE5vbmNlQWNjb3VudAoJICAgKi8KCSAgc3RhdGljIGZyb21BY2NvdW50RGF0YShidWZmZXIpIHsKCSAgICBjb25zdCBub25jZUFjY291bnQgPSBOb25jZUFjY291bnRMYXlvdXQuZGVjb2RlKHRvQnVmZmVyKGJ1ZmZlciksIDApOwoJICAgIHJldHVybiBuZXcgTm9uY2VBY2NvdW50KHsKCSAgICAgIGF1dGhvcml6ZWRQdWJrZXk6IG5ldyBQdWJsaWNLZXkobm9uY2VBY2NvdW50LmF1dGhvcml6ZWRQdWJrZXkpLAoJICAgICAgbm9uY2U6IG5ldyBQdWJsaWNLZXkobm9uY2VBY2NvdW50Lm5vbmNlKS50b1N0cmluZygpLAoJICAgICAgZmVlQ2FsY3VsYXRvcjogbm9uY2VBY2NvdW50LmZlZUNhbGN1bGF0b3IKCSAgICB9KTsKCSAgfQoJfQoKCXZhciBicm93c2VyJDEgPSB7fTsKCgl2YXIgaGFzUmVxdWlyZWRCcm93c2VyJDE7CgoJZnVuY3Rpb24gcmVxdWlyZUJyb3dzZXIkMSAoKSB7CgkJaWYgKGhhc1JlcXVpcmVkQnJvd3NlciQxKSByZXR1cm4gYnJvd3NlciQxOwoJCWhhc1JlcXVpcmVkQnJvd3NlciQxID0gMTsKCgkJT2JqZWN0LmRlZmluZVByb3BlcnR5KGJyb3dzZXIkMSwgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwoJCS8qKgoJCSAqIENvbnZlcnQgYSBsaXR0bGUtZW5kaWFuIGJ1ZmZlciBpbnRvIGEgQmlnSW50LgoJCSAqIEBwYXJhbSBidWYgVGhlIGxpdHRsZS1lbmRpYW4gYnVmZmVyIHRvIGNvbnZlcnQKCQkgKiBAcmV0dXJucyBBIEJpZ0ludCB3aXRoIHRoZSBsaXR0bGUtZW5kaWFuIHJlcHJlc2VudGF0aW9uIG9mIGJ1Zi4KCQkgKi8KCQlmdW5jdGlvbiB0b0JpZ0ludExFKGJ1ZikgewoJCSAgICB7CgkJICAgICAgICBjb25zdCByZXZlcnNlZCA9IEJ1ZmZlci5mcm9tKGJ1Zik7CgkJICAgICAgICByZXZlcnNlZC5yZXZlcnNlKCk7CgkJICAgICAgICBjb25zdCBoZXggPSByZXZlcnNlZC50b1N0cmluZygnaGV4Jyk7CgkJICAgICAgICBpZiAoaGV4Lmxlbmd0aCA9PT0gMCkgewoJCSAgICAgICAgICAgIHJldHVybiBCaWdJbnQoMCk7CgkJICAgICAgICB9CgkJICAgICAgICByZXR1cm4gQmlnSW50KGAweCR7aGV4fWApOwoJCSAgICB9CgkJfQoJCWJyb3dzZXIkMS50b0JpZ0ludExFID0gdG9CaWdJbnRMRTsKCQkvKioKCQkgKiBDb252ZXJ0IGEgYmlnLWVuZGlhbiBidWZmZXIgaW50byBhIEJpZ0ludAoJCSAqIEBwYXJhbSBidWYgVGhlIGJpZy1lbmRpYW4gYnVmZmVyIHRvIGNvbnZlcnQuCgkJICogQHJldHVybnMgQSBCaWdJbnQgd2l0aCB0aGUgYmlnLWVuZGlhbiByZXByZXNlbnRhdGlvbiBvZiBidWYuCgkJICovCgkJZnVuY3Rpb24gdG9CaWdJbnRCRShidWYpIHsKCQkgICAgewoJCSAgICAgICAgY29uc3QgaGV4ID0gYnVmLnRvU3RyaW5nKCdoZXgnKTsKCQkgICAgICAgIGlmIChoZXgubGVuZ3RoID09PSAwKSB7CgkJICAgICAgICAgICAgcmV0dXJuIEJpZ0ludCgwKTsKCQkgICAgICAgIH0KCQkgICAgICAgIHJldHVybiBCaWdJbnQoYDB4JHtoZXh9YCk7CgkJICAgIH0KCQl9CgkJYnJvd3NlciQxLnRvQmlnSW50QkUgPSB0b0JpZ0ludEJFOwoJCS8qKgoJCSAqIENvbnZlcnQgYSBCaWdJbnQgdG8gYSBsaXR0bGUtZW5kaWFuIGJ1ZmZlci4KCQkgKiBAcGFyYW0gbnVtICAgVGhlIEJpZ0ludCB0byBjb252ZXJ0LgoJCSAqIEBwYXJhbSB3aWR0aCBUaGUgbnVtYmVyIG9mIGJ5dGVzIHRoYXQgdGhlIHJlc3VsdGluZyBidWZmZXIgc2hvdWxkIGJlLgoJCSAqIEByZXR1cm5zIEEgbGl0dGxlLWVuZGlhbiBidWZmZXIgcmVwcmVzZW50YXRpb24gb2YgbnVtLgoJCSAqLwoJCWZ1bmN0aW9uIHRvQnVmZmVyTEUobnVtLCB3aWR0aCkgewoJCSAgICB7CgkJICAgICAgICBjb25zdCBoZXggPSBudW0udG9TdHJpbmcoMTYpOwoJCSAgICAgICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oaGV4LnBhZFN0YXJ0KHdpZHRoICogMiwgJzAnKS5zbGljZSgwLCB3aWR0aCAqIDIpLCAnaGV4Jyk7CgkJICAgICAgICBidWZmZXIucmV2ZXJzZSgpOwoJCSAgICAgICAgcmV0dXJuIGJ1ZmZlcjsKCQkgICAgfQoJCX0KCQlicm93c2VyJDEudG9CdWZmZXJMRSA9IHRvQnVmZmVyTEU7CgkJLyoqCgkJICogQ29udmVydCBhIEJpZ0ludCB0byBhIGJpZy1lbmRpYW4gYnVmZmVyLgoJCSAqIEBwYXJhbSBudW0gICBUaGUgQmlnSW50IHRvIGNvbnZlcnQuCgkJICogQHBhcmFtIHdpZHRoIFRoZSBudW1iZXIgb2YgYnl0ZXMgdGhhdCB0aGUgcmVzdWx0aW5nIGJ1ZmZlciBzaG91bGQgYmUuCgkJICogQHJldHVybnMgQSBiaWctZW5kaWFuIGJ1ZmZlciByZXByZXNlbnRhdGlvbiBvZiBudW0uCgkJICovCgkJZnVuY3Rpb24gdG9CdWZmZXJCRShudW0sIHdpZHRoKSB7CgkJICAgIHsKCQkgICAgICAgIGNvbnN0IGhleCA9IG51bS50b1N0cmluZygxNik7CgkJICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oaGV4LnBhZFN0YXJ0KHdpZHRoICogMiwgJzAnKS5zbGljZSgwLCB3aWR0aCAqIDIpLCAnaGV4Jyk7CgkJICAgIH0KCQl9CgkJYnJvd3NlciQxLnRvQnVmZmVyQkUgPSB0b0J1ZmZlckJFOwoJCXJldHVybiBicm93c2VyJDE7Cgl9CgoJdmFyIGJyb3dzZXJFeHBvcnRzJDEgPSAvKkBfX1BVUkVfXyovIHJlcXVpcmVCcm93c2VyJDEoKTsKCgljb25zdCBlbmNvZGVEZWNvZGUgPSBsYXlvdXQgPT4gewoJICBjb25zdCBkZWNvZGUgPSBsYXlvdXQuZGVjb2RlLmJpbmQobGF5b3V0KTsKCSAgY29uc3QgZW5jb2RlID0gbGF5b3V0LmVuY29kZS5iaW5kKGxheW91dCk7CgkgIHJldHVybiB7CgkgICAgZGVjb2RlLAoJICAgIGVuY29kZQoJICB9OwoJfTsKCWNvbnN0IGJpZ0ludCA9IGxlbmd0aCA9PiBwcm9wZXJ0eSA9PiB7CgkgIGNvbnN0IGxheW91dCA9IExheW91dEV4cG9ydHMuYmxvYihsZW5ndGgsIHByb3BlcnR5KTsKCSAgY29uc3QgewoJICAgIGVuY29kZSwKCSAgICBkZWNvZGUKCSAgfSA9IGVuY29kZURlY29kZShsYXlvdXQpOwoJICBjb25zdCBiaWdJbnRMYXlvdXQgPSBsYXlvdXQ7CgkgIGJpZ0ludExheW91dC5kZWNvZGUgPSAoYnVmZmVyLCBvZmZzZXQpID0+IHsKCSAgICBjb25zdCBzcmMgPSBkZWNvZGUoYnVmZmVyLCBvZmZzZXQpOwoJICAgIHJldHVybiBicm93c2VyRXhwb3J0cyQxLnRvQmlnSW50TEUoYnVmZmVyRXhwb3J0cy5CdWZmZXIuZnJvbShzcmMpKTsKCSAgfTsKCSAgYmlnSW50TGF5b3V0LmVuY29kZSA9IChiaWdJbnQsIGJ1ZmZlciwgb2Zmc2V0KSA9PiB7CgkgICAgY29uc3Qgc3JjID0gYnJvd3NlckV4cG9ydHMkMS50b0J1ZmZlckxFKGJpZ0ludCwgbGVuZ3RoKTsKCSAgICByZXR1cm4gZW5jb2RlKHNyYywgYnVmZmVyLCBvZmZzZXQpOwoJICB9OwoJICByZXR1cm4gYmlnSW50TGF5b3V0OwoJfTsKCWNvbnN0IHU2NCA9IGJpZ0ludCg4KTsKCgkvKioKCSAqIENyZWF0ZSBhY2NvdW50IHN5c3RlbSB0cmFuc2FjdGlvbiBwYXJhbXMKCSAqLwoKCS8qKgoJICogVHJhbnNmZXIgc3lzdGVtIHRyYW5zYWN0aW9uIHBhcmFtcwoJICovCgoJLyoqCgkgKiBBc3NpZ24gc3lzdGVtIHRyYW5zYWN0aW9uIHBhcmFtcwoJICovCgoJLyoqCgkgKiBDcmVhdGUgYWNjb3VudCB3aXRoIHNlZWQgc3lzdGVtIHRyYW5zYWN0aW9uIHBhcmFtcwoJICovCgoJLyoqCgkgKiBDcmVhdGUgbm9uY2UgYWNjb3VudCBzeXN0ZW0gdHJhbnNhY3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIENyZWF0ZSBub25jZSBhY2NvdW50IHdpdGggc2VlZCBzeXN0ZW0gdHJhbnNhY3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIEluaXRpYWxpemUgbm9uY2UgYWNjb3VudCBzeXN0ZW0gaW5zdHJ1Y3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIEFkdmFuY2Ugbm9uY2UgYWNjb3VudCBzeXN0ZW0gaW5zdHJ1Y3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIFdpdGhkcmF3IG5vbmNlIGFjY291bnQgc3lzdGVtIHRyYW5zYWN0aW9uIHBhcmFtcwoJICovCgoJLyoqCgkgKiBBdXRob3JpemUgbm9uY2UgYWNjb3VudCBzeXN0ZW0gdHJhbnNhY3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIEFsbG9jYXRlIGFjY291bnQgc3lzdGVtIHRyYW5zYWN0aW9uIHBhcmFtcwoJICovCgoJLyoqCgkgKiBBbGxvY2F0ZSBhY2NvdW50IHdpdGggc2VlZCBzeXN0ZW0gdHJhbnNhY3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIEFzc2lnbiBhY2NvdW50IHdpdGggc2VlZCBzeXN0ZW0gdHJhbnNhY3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIFRyYW5zZmVyIHdpdGggc2VlZCBzeXN0ZW0gdHJhbnNhY3Rpb24gcGFyYW1zCgkgKi8KCgkvKiogRGVjb2RlZCB0cmFuc2ZlciBzeXN0ZW0gdHJhbnNhY3Rpb24gaW5zdHJ1Y3Rpb24gKi8KCgkvKiogRGVjb2RlZCB0cmFuc2ZlcldpdGhTZWVkIHN5c3RlbSB0cmFuc2FjdGlvbiBpbnN0cnVjdGlvbiAqLwoKCS8qKgoJICogU3lzdGVtIEluc3RydWN0aW9uIGNsYXNzCgkgKi8KCWNsYXNzIFN5c3RlbUluc3RydWN0aW9uIHsKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgY29uc3RydWN0b3IoKSB7fQoKCSAgLyoqCgkgICAqIERlY29kZSBhIHN5c3RlbSBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHR5cGUuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlSW5zdHJ1Y3Rpb25UeXBlKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIGNvbnN0IGluc3RydWN0aW9uVHlwZUxheW91dCA9IExheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpOwoJICAgIGNvbnN0IHR5cGVJbmRleCA9IGluc3RydWN0aW9uVHlwZUxheW91dC5kZWNvZGUoaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgbGV0IHR5cGU7CgkgICAgZm9yIChjb25zdCBbaXhUeXBlLCBsYXlvdXRdIG9mIE9iamVjdC5lbnRyaWVzKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTKSkgewoJICAgICAgaWYgKGxheW91dC5pbmRleCA9PSB0eXBlSW5kZXgpIHsKCSAgICAgICAgdHlwZSA9IGl4VHlwZTsKCSAgICAgICAgYnJlYWs7CgkgICAgICB9CgkgICAgfQoJICAgIGlmICghdHlwZSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnN0cnVjdGlvbiB0eXBlIGluY29ycmVjdDsgbm90IGEgU3lzdGVtSW5zdHJ1Y3Rpb24nKTsKCSAgICB9CgkgICAgcmV0dXJuIHR5cGU7CgkgIH0KCgkgIC8qKgoJICAgKiBEZWNvZGUgYSBjcmVhdGUgYWNjb3VudCBzeXN0ZW0gaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlQ3JlYXRlQWNjb3VudChpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICB0aGlzLmNoZWNrS2V5TGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDIpOwoJICAgIGNvbnN0IHsKCSAgICAgIGxhbXBvcnRzLAoJICAgICAgc3BhY2UsCgkgICAgICBwcm9ncmFtSWQKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkNyZWF0ZSwgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgcmV0dXJuIHsKCSAgICAgIGZyb21QdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgbmV3QWNjb3VudFB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1sxXS5wdWJrZXksCgkgICAgICBsYW1wb3J0cywKCSAgICAgIHNwYWNlLAoJICAgICAgcHJvZ3JhbUlkOiBuZXcgUHVibGljS2V5KHByb2dyYW1JZCkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGEgdHJhbnNmZXIgc3lzdGVtIGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZVRyYW5zZmVyKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIHRoaXMuY2hlY2tLZXlMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMik7CgkgICAgY29uc3QgewoJICAgICAgbGFtcG9ydHMKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLlRyYW5zZmVyLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgZnJvbVB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICB0b1B1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1sxXS5wdWJrZXksCgkgICAgICBsYW1wb3J0cwoJICAgIH07CgkgIH0KCgkgIC8qKgoJICAgKiBEZWNvZGUgYSB0cmFuc2ZlciB3aXRoIHNlZWQgc3lzdGVtIGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZVRyYW5zZmVyV2l0aFNlZWQoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCAzKTsKCSAgICBjb25zdCB7CgkgICAgICBsYW1wb3J0cywKCSAgICAgIHNlZWQsCgkgICAgICBwcm9ncmFtSWQKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLlRyYW5zZmVyV2l0aFNlZWQsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICBmcm9tUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIGJhc2VQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMV0ucHVia2V5LAoJICAgICAgdG9QdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMl0ucHVia2V5LAoJICAgICAgbGFtcG9ydHMsCgkgICAgICBzZWVkLAoJICAgICAgcHJvZ3JhbUlkOiBuZXcgUHVibGljS2V5KHByb2dyYW1JZCkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGFuIGFsbG9jYXRlIHN5c3RlbSBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVBbGxvY2F0ZShpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICB0aGlzLmNoZWNrS2V5TGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDEpOwoJICAgIGNvbnN0IHsKCSAgICAgIHNwYWNlCgkgICAgfSA9IGRlY29kZURhdGEkMShTWVNURU1fSU5TVFJVQ1RJT05fTEFZT1VUUy5BbGxvY2F0ZSwgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgcmV0dXJuIHsKCSAgICAgIGFjY291bnRQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgc3BhY2UKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGFuIGFsbG9jYXRlIHdpdGggc2VlZCBzeXN0ZW0gaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlQWxsb2NhdGVXaXRoU2VlZChpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICB0aGlzLmNoZWNrS2V5TGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDEpOwoJICAgIGNvbnN0IHsKCSAgICAgIGJhc2UsCgkgICAgICBzZWVkLAoJICAgICAgc3BhY2UsCgkgICAgICBwcm9ncmFtSWQKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkFsbG9jYXRlV2l0aFNlZWQsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICBhY2NvdW50UHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIGJhc2VQdWJrZXk6IG5ldyBQdWJsaWNLZXkoYmFzZSksCgkgICAgICBzZWVkLAoJICAgICAgc3BhY2UsCgkgICAgICBwcm9ncmFtSWQ6IG5ldyBQdWJsaWNLZXkocHJvZ3JhbUlkKQoJICAgIH07CgkgIH0KCgkgIC8qKgoJICAgKiBEZWNvZGUgYW4gYXNzaWduIHN5c3RlbSBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVBc3NpZ24oaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCAxKTsKCSAgICBjb25zdCB7CgkgICAgICBwcm9ncmFtSWQKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkFzc2lnbiwgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgcmV0dXJuIHsKCSAgICAgIGFjY291bnRQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgcHJvZ3JhbUlkOiBuZXcgUHVibGljS2V5KHByb2dyYW1JZCkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGFuIGFzc2lnbiB3aXRoIHNlZWQgc3lzdGVtIGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZUFzc2lnbldpdGhTZWVkKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIHRoaXMuY2hlY2tLZXlMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMSk7CgkgICAgY29uc3QgewoJICAgICAgYmFzZSwKCSAgICAgIHNlZWQsCgkgICAgICBwcm9ncmFtSWQKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkFzc2lnbldpdGhTZWVkLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgYWNjb3VudFB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICBiYXNlUHVia2V5OiBuZXcgUHVibGljS2V5KGJhc2UpLAoJICAgICAgc2VlZCwKCSAgICAgIHByb2dyYW1JZDogbmV3IFB1YmxpY0tleShwcm9ncmFtSWQpCgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhIGNyZWF0ZSBhY2NvdW50IHdpdGggc2VlZCBzeXN0ZW0gaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlQ3JlYXRlV2l0aFNlZWQoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCAyKTsKCSAgICBjb25zdCB7CgkgICAgICBiYXNlLAoJICAgICAgc2VlZCwKCSAgICAgIGxhbXBvcnRzLAoJICAgICAgc3BhY2UsCgkgICAgICBwcm9ncmFtSWQKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkNyZWF0ZVdpdGhTZWVkLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgZnJvbVB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICBuZXdBY2NvdW50UHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzFdLnB1YmtleSwKCSAgICAgIGJhc2VQdWJrZXk6IG5ldyBQdWJsaWNLZXkoYmFzZSksCgkgICAgICBzZWVkLAoJICAgICAgbGFtcG9ydHMsCgkgICAgICBzcGFjZSwKCSAgICAgIHByb2dyYW1JZDogbmV3IFB1YmxpY0tleShwcm9ncmFtSWQpCgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhIG5vbmNlIGluaXRpYWxpemUgc3lzdGVtIGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZU5vbmNlSW5pdGlhbGl6ZShpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICB0aGlzLmNoZWNrS2V5TGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDMpOwoJICAgIGNvbnN0IHsKCSAgICAgIGF1dGhvcml6ZWQKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkluaXRpYWxpemVOb25jZUFjY291bnQsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICBub25jZVB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5OiBuZXcgUHVibGljS2V5KGF1dGhvcml6ZWQpCgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhIG5vbmNlIGFkdmFuY2Ugc3lzdGVtIGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZU5vbmNlQWR2YW5jZShpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICB0aGlzLmNoZWNrS2V5TGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDMpOwoJICAgIGRlY29kZURhdGEkMShTWVNURU1fSU5TVFJVQ1RJT05fTEFZT1VUUy5BZHZhbmNlTm9uY2VBY2NvdW50LCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgbm9uY2VQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgYXV0aG9yaXplZFB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1syXS5wdWJrZXkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGEgbm9uY2Ugd2l0aGRyYXcgc3lzdGVtIGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZU5vbmNlV2l0aGRyYXcoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCA1KTsKCSAgICBjb25zdCB7CgkgICAgICBsYW1wb3J0cwoJICAgIH0gPSBkZWNvZGVEYXRhJDEoU1lTVEVNX0lOU1RSVUNUSU9OX0xBWU9VVFMuV2l0aGRyYXdOb25jZUFjY291bnQsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICBub25jZVB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICB0b1B1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1sxXS5wdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzRdLnB1YmtleSwKCSAgICAgIGxhbXBvcnRzCgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhIG5vbmNlIGF1dGhvcml6ZSBzeXN0ZW0gaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlTm9uY2VBdXRob3JpemUoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCAyKTsKCSAgICBjb25zdCB7CgkgICAgICBhdXRob3JpemVkCgkgICAgfSA9IGRlY29kZURhdGEkMShTWVNURU1fSU5TVFJVQ1RJT05fTEFZT1VUUy5BdXRob3JpemVOb25jZUFjY291bnQsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICBub25jZVB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzFdLnB1YmtleSwKCSAgICAgIG5ld0F1dGhvcml6ZWRQdWJrZXk6IG5ldyBQdWJsaWNLZXkoYXV0aG9yaXplZCkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBzdGF0aWMgY2hlY2tQcm9ncmFtSWQocHJvZ3JhbUlkKSB7CgkgICAgaWYgKCFwcm9ncmFtSWQuZXF1YWxzKFN5c3RlbVByb2dyYW0ucHJvZ3JhbUlkKSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGluc3RydWN0aW9uOyBwcm9ncmFtSWQgaXMgbm90IFN5c3RlbVByb2dyYW0nKTsKCSAgICB9CgkgIH0KCgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIHN0YXRpYyBjaGVja0tleUxlbmd0aChrZXlzLCBleHBlY3RlZExlbmd0aCkgewoJICAgIGlmIChrZXlzLmxlbmd0aCA8IGV4cGVjdGVkTGVuZ3RoKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgaW5zdHJ1Y3Rpb247IGZvdW5kICR7a2V5cy5sZW5ndGh9IGtleXMsIGV4cGVjdGVkIGF0IGxlYXN0ICR7ZXhwZWN0ZWRMZW5ndGh9YCk7CgkgICAgfQoJICB9Cgl9CgoJLyoqCgkgKiBBbiBlbnVtZXJhdGlvbiBvZiB2YWxpZCBTeXN0ZW1JbnN0cnVjdGlvblR5cGUncwoJICovCgoJLyoqCgkgKiBBbiBlbnVtZXJhdGlvbiBvZiB2YWxpZCBzeXN0ZW0gSW5zdHJ1Y3Rpb25UeXBlJ3MKCSAqIEBpbnRlcm5hbAoJICovCgljb25zdCBTWVNURU1fSU5TVFJVQ1RJT05fTEFZT1VUUyA9IE9iamVjdC5mcmVlemUoewoJICBDcmVhdGU6IHsKCSAgICBpbmRleDogMCwKCSAgICBsYXlvdXQ6IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgTGF5b3V0RXhwb3J0cy5uczY0KCdsYW1wb3J0cycpLCBMYXlvdXRFeHBvcnRzLm5zNjQoJ3NwYWNlJyksIHB1YmxpY0tleSgncHJvZ3JhbUlkJyldKQoJICB9LAoJICBBc3NpZ246IHsKCSAgICBpbmRleDogMSwKCSAgICBsYXlvdXQ6IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgcHVibGljS2V5KCdwcm9ncmFtSWQnKV0pCgkgIH0sCgkgIFRyYW5zZmVyOiB7CgkgICAgaW5kZXg6IDIsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyksIHU2NCgnbGFtcG9ydHMnKV0pCgkgIH0sCgkgIENyZWF0ZVdpdGhTZWVkOiB7CgkgICAgaW5kZXg6IDMsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyksIHB1YmxpY0tleSgnYmFzZScpLCBydXN0U3RyaW5nKCdzZWVkJyksIExheW91dEV4cG9ydHMubnM2NCgnbGFtcG9ydHMnKSwgTGF5b3V0RXhwb3J0cy5uczY0KCdzcGFjZScpLCBwdWJsaWNLZXkoJ3Byb2dyYW1JZCcpXSkKCSAgfSwKCSAgQWR2YW5jZU5vbmNlQWNjb3VudDogewoJICAgIGluZGV4OiA0LAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpXSkKCSAgfSwKCSAgV2l0aGRyYXdOb25jZUFjY291bnQ6IHsKCSAgICBpbmRleDogNSwKCSAgICBsYXlvdXQ6IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgTGF5b3V0RXhwb3J0cy5uczY0KCdsYW1wb3J0cycpXSkKCSAgfSwKCSAgSW5pdGlhbGl6ZU5vbmNlQWNjb3VudDogewoJICAgIGluZGV4OiA2LAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpLCBwdWJsaWNLZXkoJ2F1dGhvcml6ZWQnKV0pCgkgIH0sCgkgIEF1dGhvcml6ZU5vbmNlQWNjb3VudDogewoJICAgIGluZGV4OiA3LAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpLCBwdWJsaWNLZXkoJ2F1dGhvcml6ZWQnKV0pCgkgIH0sCgkgIEFsbG9jYXRlOiB7CgkgICAgaW5kZXg6IDgsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyksIExheW91dEV4cG9ydHMubnM2NCgnc3BhY2UnKV0pCgkgIH0sCgkgIEFsbG9jYXRlV2l0aFNlZWQ6IHsKCSAgICBpbmRleDogOSwKCSAgICBsYXlvdXQ6IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgcHVibGljS2V5KCdiYXNlJyksIHJ1c3RTdHJpbmcoJ3NlZWQnKSwgTGF5b3V0RXhwb3J0cy5uczY0KCdzcGFjZScpLCBwdWJsaWNLZXkoJ3Byb2dyYW1JZCcpXSkKCSAgfSwKCSAgQXNzaWduV2l0aFNlZWQ6IHsKCSAgICBpbmRleDogMTAsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyksIHB1YmxpY0tleSgnYmFzZScpLCBydXN0U3RyaW5nKCdzZWVkJyksIHB1YmxpY0tleSgncHJvZ3JhbUlkJyldKQoJICB9LAoJICBUcmFuc2ZlcldpdGhTZWVkOiB7CgkgICAgaW5kZXg6IDExLAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpLCB1NjQoJ2xhbXBvcnRzJyksIHJ1c3RTdHJpbmcoJ3NlZWQnKSwgcHVibGljS2V5KCdwcm9ncmFtSWQnKV0pCgkgIH0sCgkgIFVwZ3JhZGVOb25jZUFjY291bnQ6IHsKCSAgICBpbmRleDogMTIsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyldKQoJICB9Cgl9KTsKCgkvKioKCSAqIEZhY3RvcnkgY2xhc3MgZm9yIHRyYW5zYWN0aW9ucyB0byBpbnRlcmFjdCB3aXRoIHRoZSBTeXN0ZW0gcHJvZ3JhbQoJICovCgljbGFzcyBTeXN0ZW1Qcm9ncmFtIHsKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgY29uc3RydWN0b3IoKSB7fQoKCSAgLyoqCgkgICAqIFB1YmxpYyBrZXkgdGhhdCBpZGVudGlmaWVzIHRoZSBTeXN0ZW0gcHJvZ3JhbQoJICAgKi8KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIHRyYW5zYWN0aW9uIGluc3RydWN0aW9uIHRoYXQgY3JlYXRlcyBhIG5ldyBhY2NvdW50CgkgICAqLwoJICBzdGF0aWMgY3JlYXRlQWNjb3VudChwYXJhbXMpIHsKCSAgICBjb25zdCB0eXBlID0gU1lTVEVNX0lOU1RSVUNUSU9OX0xBWU9VVFMuQ3JlYXRlOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgIGxhbXBvcnRzOiBwYXJhbXMubGFtcG9ydHMsCgkgICAgICBzcGFjZTogcGFyYW1zLnNwYWNlLAoJICAgICAgcHJvZ3JhbUlkOiB0b0J1ZmZlcihwYXJhbXMucHJvZ3JhbUlkLnRvQnVmZmVyKCkpCgkgICAgfSk7CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHsKCSAgICAgIGtleXM6IFt7CgkgICAgICAgIHB1YmtleTogcGFyYW1zLmZyb21QdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogcGFyYW1zLm5ld0FjY291bnRQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9XSwKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQsCgkgICAgICBkYXRhCgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIHRyYW5zYWN0aW9uIGluc3RydWN0aW9uIHRoYXQgdHJhbnNmZXJzIGxhbXBvcnRzIGZyb20gb25lIGFjY291bnQgdG8gYW5vdGhlcgoJICAgKi8KCSAgc3RhdGljIHRyYW5zZmVyKHBhcmFtcykgewoJICAgIGxldCBkYXRhOwoJICAgIGxldCBrZXlzOwoJICAgIGlmICgnYmFzZVB1YmtleScgaW4gcGFyYW1zKSB7CgkgICAgICBjb25zdCB0eXBlID0gU1lTVEVNX0lOU1RSVUNUSU9OX0xBWU9VVFMuVHJhbnNmZXJXaXRoU2VlZDsKCSAgICAgIGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgICAgbGFtcG9ydHM6IEJpZ0ludChwYXJhbXMubGFtcG9ydHMpLAoJICAgICAgICBzZWVkOiBwYXJhbXMuc2VlZCwKCSAgICAgICAgcHJvZ3JhbUlkOiB0b0J1ZmZlcihwYXJhbXMucHJvZ3JhbUlkLnRvQnVmZmVyKCkpCgkgICAgICB9KTsKCSAgICAgIGtleXMgPSBbewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy5mcm9tUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBwYXJhbXMuYmFzZVB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogcGFyYW1zLnRvUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH1dOwoJICAgIH0gZWxzZSB7CgkgICAgICBjb25zdCB0eXBlID0gU1lTVEVNX0lOU1RSVUNUSU9OX0xBWU9VVFMuVHJhbnNmZXI7CgkgICAgICBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICAgIGxhbXBvcnRzOiBCaWdJbnQocGFyYW1zLmxhbXBvcnRzKQoJICAgICAgfSk7CgkgICAgICBrZXlzID0gW3sKCSAgICAgICAgcHVia2V5OiBwYXJhbXMuZnJvbVB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBwYXJhbXMudG9QdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgICAgaXNXcml0YWJsZTogdHJ1ZQoJICAgICAgfV07CgkgICAgfQoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBrZXlzLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgdHJhbnNhY3Rpb24gaW5zdHJ1Y3Rpb24gdGhhdCBhc3NpZ25zIGFuIGFjY291bnQgdG8gYSBwcm9ncmFtCgkgICAqLwoJICBzdGF0aWMgYXNzaWduKHBhcmFtcykgewoJICAgIGxldCBkYXRhOwoJICAgIGxldCBrZXlzOwoJICAgIGlmICgnYmFzZVB1YmtleScgaW4gcGFyYW1zKSB7CgkgICAgICBjb25zdCB0eXBlID0gU1lTVEVNX0lOU1RSVUNUSU9OX0xBWU9VVFMuQXNzaWduV2l0aFNlZWQ7CgkgICAgICBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICAgIGJhc2U6IHRvQnVmZmVyKHBhcmFtcy5iYXNlUHVia2V5LnRvQnVmZmVyKCkpLAoJICAgICAgICBzZWVkOiBwYXJhbXMuc2VlZCwKCSAgICAgICAgcHJvZ3JhbUlkOiB0b0J1ZmZlcihwYXJhbXMucHJvZ3JhbUlkLnRvQnVmZmVyKCkpCgkgICAgICB9KTsKCSAgICAgIGtleXMgPSBbewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy5hY2NvdW50UHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBwYXJhbXMuYmFzZVB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9XTsKCSAgICB9IGVsc2UgewoJICAgICAgY29uc3QgdHlwZSA9IFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkFzc2lnbjsKCSAgICAgIGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgICAgcHJvZ3JhbUlkOiB0b0J1ZmZlcihwYXJhbXMucHJvZ3JhbUlkLnRvQnVmZmVyKCkpCgkgICAgICB9KTsKCSAgICAgIGtleXMgPSBbewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy5hY2NvdW50UHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgICAgaXNXcml0YWJsZTogdHJ1ZQoJICAgICAgfV07CgkgICAgfQoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBrZXlzLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgdHJhbnNhY3Rpb24gaW5zdHJ1Y3Rpb24gdGhhdCBjcmVhdGVzIGEgbmV3IGFjY291bnQgYXQKCSAgICogICBhbiBhZGRyZXNzIGdlbmVyYXRlZCB3aXRoIGBmcm9tYCwgYSBzZWVkLCBhbmQgcHJvZ3JhbUlkCgkgICAqLwoJICBzdGF0aWMgY3JlYXRlQWNjb3VudFdpdGhTZWVkKHBhcmFtcykgewoJICAgIGNvbnN0IHR5cGUgPSBTWVNURU1fSU5TVFJVQ1RJT05fTEFZT1VUUy5DcmVhdGVXaXRoU2VlZDsKCSAgICBjb25zdCBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICBiYXNlOiB0b0J1ZmZlcihwYXJhbXMuYmFzZVB1YmtleS50b0J1ZmZlcigpKSwKCSAgICAgIHNlZWQ6IHBhcmFtcy5zZWVkLAoJICAgICAgbGFtcG9ydHM6IHBhcmFtcy5sYW1wb3J0cywKCSAgICAgIHNwYWNlOiBwYXJhbXMuc3BhY2UsCgkgICAgICBwcm9ncmFtSWQ6IHRvQnVmZmVyKHBhcmFtcy5wcm9ncmFtSWQudG9CdWZmZXIoKSkKCSAgICB9KTsKCSAgICBsZXQga2V5cyA9IFt7CgkgICAgICBwdWJrZXk6IHBhcmFtcy5mcm9tUHVia2V5LAoJICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBwYXJhbXMubmV3QWNjb3VudFB1YmtleSwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICB9XTsKCSAgICBpZiAoIXBhcmFtcy5iYXNlUHVia2V5LmVxdWFscyhwYXJhbXMuZnJvbVB1YmtleSkpIHsKCSAgICAgIGtleXMucHVzaCh7CgkgICAgICAgIHB1YmtleTogcGFyYW1zLmJhc2VQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBrZXlzLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgdHJhbnNhY3Rpb24gdGhhdCBjcmVhdGVzIGEgbmV3IE5vbmNlIGFjY291bnQKCSAgICovCgkgIHN0YXRpYyBjcmVhdGVOb25jZUFjY291bnQocGFyYW1zKSB7CgkgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKTsKCSAgICBpZiAoJ2Jhc2VQdWJrZXknIGluIHBhcmFtcyAmJiAnc2VlZCcgaW4gcGFyYW1zKSB7CgkgICAgICB0cmFuc2FjdGlvbi5hZGQoU3lzdGVtUHJvZ3JhbS5jcmVhdGVBY2NvdW50V2l0aFNlZWQoewoJICAgICAgICBmcm9tUHVia2V5OiBwYXJhbXMuZnJvbVB1YmtleSwKCSAgICAgICAgbmV3QWNjb3VudFB1YmtleTogcGFyYW1zLm5vbmNlUHVia2V5LAoJICAgICAgICBiYXNlUHVia2V5OiBwYXJhbXMuYmFzZVB1YmtleSwKCSAgICAgICAgc2VlZDogcGFyYW1zLnNlZWQsCgkgICAgICAgIGxhbXBvcnRzOiBwYXJhbXMubGFtcG9ydHMsCgkgICAgICAgIHNwYWNlOiBOT05DRV9BQ0NPVU5UX0xFTkdUSCwKCSAgICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZAoJICAgICAgfSkpOwoJICAgIH0gZWxzZSB7CgkgICAgICB0cmFuc2FjdGlvbi5hZGQoU3lzdGVtUHJvZ3JhbS5jcmVhdGVBY2NvdW50KHsKCSAgICAgICAgZnJvbVB1YmtleTogcGFyYW1zLmZyb21QdWJrZXksCgkgICAgICAgIG5ld0FjY291bnRQdWJrZXk6IHBhcmFtcy5ub25jZVB1YmtleSwKCSAgICAgICAgbGFtcG9ydHM6IHBhcmFtcy5sYW1wb3J0cywKCSAgICAgICAgc3BhY2U6IE5PTkNFX0FDQ09VTlRfTEVOR1RILAoJICAgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkCgkgICAgICB9KSk7CgkgICAgfQoJICAgIGNvbnN0IGluaXRQYXJhbXMgPSB7CgkgICAgICBub25jZVB1YmtleTogcGFyYW1zLm5vbmNlUHVia2V5LAoJICAgICAgYXV0aG9yaXplZFB1YmtleTogcGFyYW1zLmF1dGhvcml6ZWRQdWJrZXkKCSAgICB9OwoJICAgIHRyYW5zYWN0aW9uLmFkZCh0aGlzLm5vbmNlSW5pdGlhbGl6ZShpbml0UGFyYW1zKSk7CgkgICAgcmV0dXJuIHRyYW5zYWN0aW9uOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYW4gaW5zdHJ1Y3Rpb24gdG8gaW5pdGlhbGl6ZSBhIE5vbmNlIGFjY291bnQKCSAgICovCgkgIHN0YXRpYyBub25jZUluaXRpYWxpemUocGFyYW1zKSB7CgkgICAgY29uc3QgdHlwZSA9IFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkluaXRpYWxpemVOb25jZUFjY291bnQ7CgkgICAgY29uc3QgZGF0YSA9IGVuY29kZURhdGEodHlwZSwgewoJICAgICAgYXV0aG9yaXplZDogdG9CdWZmZXIocGFyYW1zLmF1dGhvcml6ZWRQdWJrZXkudG9CdWZmZXIoKSkKCSAgICB9KTsKCSAgICBjb25zdCBpbnN0cnVjdGlvbkRhdGEgPSB7CgkgICAgICBrZXlzOiBbewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy5ub25jZVB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogU1lTVkFSX1JFQ0VOVF9CTE9DS0hBU0hFU19QVUJLRVksCgkgICAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBTWVNWQVJfUkVOVF9QVUJLRVksCgkgICAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgIH1dLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9OwoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbihpbnN0cnVjdGlvbkRhdGEpOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYW4gaW5zdHJ1Y3Rpb24gdG8gYWR2YW5jZSB0aGUgbm9uY2UgaW4gYSBOb25jZSBhY2NvdW50CgkgICAqLwoJICBzdGF0aWMgbm9uY2VBZHZhbmNlKHBhcmFtcykgewoJICAgIGNvbnN0IHR5cGUgPSBTWVNURU1fSU5TVFJVQ1RJT05fTEFZT1VUUy5BZHZhbmNlTm9uY2VBY2NvdW50OwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUpOwoJICAgIGNvbnN0IGluc3RydWN0aW9uRGF0YSA9IHsKCSAgICAgIGtleXM6IFt7CgkgICAgICAgIHB1YmtleTogcGFyYW1zLm5vbmNlUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBTWVNWQVJfUkVDRU5UX0JMT0NLSEFTSEVTX1BVQktFWSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy5hdXRob3JpemVkUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgIH1dLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9OwoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbihpbnN0cnVjdGlvbkRhdGEpOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYSB0cmFuc2FjdGlvbiBpbnN0cnVjdGlvbiB0aGF0IHdpdGhkcmF3cyBsYW1wb3J0cyBmcm9tIGEgTm9uY2UgYWNjb3VudAoJICAgKi8KCSAgc3RhdGljIG5vbmNlV2l0aGRyYXcocGFyYW1zKSB7CgkgICAgY29uc3QgdHlwZSA9IFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLldpdGhkcmF3Tm9uY2VBY2NvdW50OwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgIGxhbXBvcnRzOiBwYXJhbXMubGFtcG9ydHMKCSAgICB9KTsKCSAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24oewoJICAgICAga2V5czogW3sKCSAgICAgICAgcHVia2V5OiBwYXJhbXMubm9uY2VQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgICAgaXNXcml0YWJsZTogdHJ1ZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy50b1B1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogU1lTVkFSX1JFQ0VOVF9CTE9DS0hBU0hFU19QVUJLRVksCgkgICAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBTWVNWQVJfUkVOVF9QVUJLRVksCgkgICAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBwYXJhbXMuYXV0aG9yaXplZFB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9XSwKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQsCgkgICAgICBkYXRhCgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIHRyYW5zYWN0aW9uIGluc3RydWN0aW9uIHRoYXQgYXV0aG9yaXplcyBhIG5ldyBQdWJsaWNLZXkgYXMgdGhlIGF1dGhvcml0eQoJICAgKiBvbiBhIE5vbmNlIGFjY291bnQuCgkgICAqLwoJICBzdGF0aWMgbm9uY2VBdXRob3JpemUocGFyYW1zKSB7CgkgICAgY29uc3QgdHlwZSA9IFNZU1RFTV9JTlNUUlVDVElPTl9MQVlPVVRTLkF1dGhvcml6ZU5vbmNlQWNjb3VudDsKCSAgICBjb25zdCBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICBhdXRob3JpemVkOiB0b0J1ZmZlcihwYXJhbXMubmV3QXV0aG9yaXplZFB1YmtleS50b0J1ZmZlcigpKQoJICAgIH0pOwoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBrZXlzOiBbewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy5ub25jZVB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogcGFyYW1zLmF1dGhvcml6ZWRQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfV0sCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAgZGF0YQoJICAgIH0pOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYSB0cmFuc2FjdGlvbiBpbnN0cnVjdGlvbiB0aGF0IGFsbG9jYXRlcyBzcGFjZSBpbiBhbiBhY2NvdW50IHdpdGhvdXQgZnVuZGluZwoJICAgKi8KCSAgc3RhdGljIGFsbG9jYXRlKHBhcmFtcykgewoJICAgIGxldCBkYXRhOwoJICAgIGxldCBrZXlzOwoJICAgIGlmICgnYmFzZVB1YmtleScgaW4gcGFyYW1zKSB7CgkgICAgICBjb25zdCB0eXBlID0gU1lTVEVNX0lOU1RSVUNUSU9OX0xBWU9VVFMuQWxsb2NhdGVXaXRoU2VlZDsKCSAgICAgIGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgICAgYmFzZTogdG9CdWZmZXIocGFyYW1zLmJhc2VQdWJrZXkudG9CdWZmZXIoKSksCgkgICAgICAgIHNlZWQ6IHBhcmFtcy5zZWVkLAoJICAgICAgICBzcGFjZTogcGFyYW1zLnNwYWNlLAoJICAgICAgICBwcm9ncmFtSWQ6IHRvQnVmZmVyKHBhcmFtcy5wcm9ncmFtSWQudG9CdWZmZXIoKSkKCSAgICAgIH0pOwoJICAgICAga2V5cyA9IFt7CgkgICAgICAgIHB1YmtleTogcGFyYW1zLmFjY291bnRQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgICAgaXNXcml0YWJsZTogdHJ1ZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy5iYXNlUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgIH1dOwoJICAgIH0gZWxzZSB7CgkgICAgICBjb25zdCB0eXBlID0gU1lTVEVNX0lOU1RSVUNUSU9OX0xBWU9VVFMuQWxsb2NhdGU7CgkgICAgICBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICAgIHNwYWNlOiBwYXJhbXMuc3BhY2UKCSAgICAgIH0pOwoJICAgICAga2V5cyA9IFt7CgkgICAgICAgIHB1YmtleTogcGFyYW1zLmFjY291bnRQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9XTsKCSAgICB9CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHsKCSAgICAgIGtleXMsCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAgZGF0YQoJICAgIH0pOwoJICB9Cgl9CglTeXN0ZW1Qcm9ncmFtLnByb2dyYW1JZCA9IG5ldyBQdWJsaWNLZXkoJzExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExJyk7CgoJLy8gS2VlcCBwcm9ncmFtIGNodW5rcyB1bmRlciBQQUNLRVRfREFUQV9TSVpFLCBsZWF2aW5nIGVub3VnaCByb29tIGZvciB0aGUKCS8vIHJlc3Qgb2YgdGhlIFRyYW5zYWN0aW9uIGZpZWxkcwoJLy8KCS8vIFRPRE86IHJlcGxhY2UgMzAwIHdpdGggYSBwcm9wZXIgY29uc3RhbnQgZm9yIHRoZSBzaXplIG9mIHRoZSBvdGhlcgoJLy8gVHJhbnNhY3Rpb24gZmllbGRzCgljb25zdCBDSFVOS19TSVpFID0gUEFDS0VUX0RBVEFfU0laRSAtIDMwMDsKCgkvKioKCSAqIFByb2dyYW0gbG9hZGVyIGludGVyZmFjZQoJICovCgljbGFzcyBMb2FkZXIgewoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBjb25zdHJ1Y3RvcigpIHt9CgoJICAvKioKCSAgICogQW1vdW50IG9mIHByb2dyYW0gZGF0YSBwbGFjZWQgaW4gZWFjaCBsb2FkIFRyYW5zYWN0aW9uCgkgICAqLwoKCSAgLyoqCgkgICAqIE1pbmltdW0gbnVtYmVyIG9mIHNpZ25hdHVyZXMgcmVxdWlyZWQgdG8gbG9hZCBhIHByb2dyYW0gbm90IGluY2x1ZGluZwoJICAgKiByZXRyaWVzCgkgICAqCgkgICAqIENhbiBiZSB1c2VkIHRvIGNhbGN1bGF0ZSB0cmFuc2FjdGlvbiBmZWVzCgkgICAqLwoJICBzdGF0aWMgZ2V0TWluTnVtU2lnbmF0dXJlcyhkYXRhTGVuZ3RoKSB7CgkgICAgcmV0dXJuIDIgKiAoCgkgICAgLy8gRXZlcnkgdHJhbnNhY3Rpb24gcmVxdWlyZXMgdHdvIHNpZ25hdHVyZXMgKHBheWVyICsgcHJvZ3JhbSkKCSAgICBNYXRoLmNlaWwoZGF0YUxlbmd0aCAvIExvYWRlci5jaHVua1NpemUpICsgMSArCgkgICAgLy8gQWRkIG9uZSBmb3IgQ3JlYXRlIHRyYW5zYWN0aW9uCgkgICAgMSkgLy8gQWRkIG9uZSBmb3IgRmluYWxpemUgdHJhbnNhY3Rpb24KCSAgICA7CgkgIH0KCgkgIC8qKgoJICAgKiBMb2FkcyBhIGdlbmVyaWMgcHJvZ3JhbQoJICAgKgoJICAgKiBAcGFyYW0gY29ubmVjdGlvbiBUaGUgY29ubmVjdGlvbiB0byB1c2UKCSAgICogQHBhcmFtIHBheWVyIFN5c3RlbSBhY2NvdW50IHRoYXQgcGF5cyB0byBsb2FkIHRoZSBwcm9ncmFtCgkgICAqIEBwYXJhbSBwcm9ncmFtIEFjY291bnQgdG8gbG9hZCB0aGUgcHJvZ3JhbSBpbnRvCgkgICAqIEBwYXJhbSBwcm9ncmFtSWQgUHVibGljIGtleSB0aGF0IGlkZW50aWZpZXMgdGhlIGxvYWRlcgoJICAgKiBAcGFyYW0gZGF0YSBQcm9ncmFtIG9jdGV0cwoJICAgKiBAcmV0dXJuIHRydWUgaWYgcHJvZ3JhbSB3YXMgbG9hZGVkIHN1Y2Nlc3NmdWxseSwgZmFsc2UgaWYgcHJvZ3JhbSB3YXMgYWxyZWFkeSBsb2FkZWQKCSAgICovCgkgIHN0YXRpYyBhc3luYyBsb2FkKGNvbm5lY3Rpb24sIHBheWVyLCBwcm9ncmFtLCBwcm9ncmFtSWQsIGRhdGEpIHsKCSAgICB7CgkgICAgICBjb25zdCBiYWxhbmNlTmVlZGVkID0gYXdhaXQgY29ubmVjdGlvbi5nZXRNaW5pbXVtQmFsYW5jZUZvclJlbnRFeGVtcHRpb24oZGF0YS5sZW5ndGgpOwoKCSAgICAgIC8vIEZldGNoIHByb2dyYW0gYWNjb3VudCBpbmZvIHRvIGNoZWNrIGlmIGl0IGhhcyBhbHJlYWR5IGJlZW4gY3JlYXRlZAoJICAgICAgY29uc3QgcHJvZ3JhbUluZm8gPSBhd2FpdCBjb25uZWN0aW9uLmdldEFjY291bnRJbmZvKHByb2dyYW0ucHVibGljS2V5LCAnY29uZmlybWVkJyk7CgkgICAgICBsZXQgdHJhbnNhY3Rpb24gPSBudWxsOwoJICAgICAgaWYgKHByb2dyYW1JbmZvICE9PSBudWxsKSB7CgkgICAgICAgIGlmIChwcm9ncmFtSW5mby5leGVjdXRhYmxlKSB7CgkgICAgICAgICAgY29uc29sZS5lcnJvcignUHJvZ3JhbSBsb2FkIGZhaWxlZCwgYWNjb3VudCBpcyBhbHJlYWR5IGV4ZWN1dGFibGUnKTsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKHByb2dyYW1JbmZvLmRhdGEubGVuZ3RoICE9PSBkYXRhLmxlbmd0aCkgewoJICAgICAgICAgIHRyYW5zYWN0aW9uID0gdHJhbnNhY3Rpb24gfHwgbmV3IFRyYW5zYWN0aW9uKCk7CgkgICAgICAgICAgdHJhbnNhY3Rpb24uYWRkKFN5c3RlbVByb2dyYW0uYWxsb2NhdGUoewoJICAgICAgICAgICAgYWNjb3VudFB1YmtleTogcHJvZ3JhbS5wdWJsaWNLZXksCgkgICAgICAgICAgICBzcGFjZTogZGF0YS5sZW5ndGgKCSAgICAgICAgICB9KSk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKCFwcm9ncmFtSW5mby5vd25lci5lcXVhbHMocHJvZ3JhbUlkKSkgewoJICAgICAgICAgIHRyYW5zYWN0aW9uID0gdHJhbnNhY3Rpb24gfHwgbmV3IFRyYW5zYWN0aW9uKCk7CgkgICAgICAgICAgdHJhbnNhY3Rpb24uYWRkKFN5c3RlbVByb2dyYW0uYXNzaWduKHsKCSAgICAgICAgICAgIGFjY291bnRQdWJrZXk6IHByb2dyYW0ucHVibGljS2V5LAoJICAgICAgICAgICAgcHJvZ3JhbUlkCgkgICAgICAgICAgfSkpOwoJICAgICAgICB9CgkgICAgICAgIGlmIChwcm9ncmFtSW5mby5sYW1wb3J0cyA8IGJhbGFuY2VOZWVkZWQpIHsKCSAgICAgICAgICB0cmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9uIHx8IG5ldyBUcmFuc2FjdGlvbigpOwoJICAgICAgICAgIHRyYW5zYWN0aW9uLmFkZChTeXN0ZW1Qcm9ncmFtLnRyYW5zZmVyKHsKCSAgICAgICAgICAgIGZyb21QdWJrZXk6IHBheWVyLnB1YmxpY0tleSwKCSAgICAgICAgICAgIHRvUHVia2V5OiBwcm9ncmFtLnB1YmxpY0tleSwKCSAgICAgICAgICAgIGxhbXBvcnRzOiBiYWxhbmNlTmVlZGVkIC0gcHJvZ3JhbUluZm8ubGFtcG9ydHMKCSAgICAgICAgICB9KSk7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRyYW5zYWN0aW9uID0gbmV3IFRyYW5zYWN0aW9uKCkuYWRkKFN5c3RlbVByb2dyYW0uY3JlYXRlQWNjb3VudCh7CgkgICAgICAgICAgZnJvbVB1YmtleTogcGF5ZXIucHVibGljS2V5LAoJICAgICAgICAgIG5ld0FjY291bnRQdWJrZXk6IHByb2dyYW0ucHVibGljS2V5LAoJICAgICAgICAgIGxhbXBvcnRzOiBiYWxhbmNlTmVlZGVkID4gMCA/IGJhbGFuY2VOZWVkZWQgOiAxLAoJICAgICAgICAgIHNwYWNlOiBkYXRhLmxlbmd0aCwKCSAgICAgICAgICBwcm9ncmFtSWQKCSAgICAgICAgfSkpOwoJICAgICAgfQoKCSAgICAgIC8vIElmIHRoZSBhY2NvdW50IGlzIGFscmVhZHkgY3JlYXRlZCBjb3JyZWN0bHksIHNraXAgdGhpcyBzdGVwCgkgICAgICAvLyBhbmQgcHJvY2VlZCBkaXJlY3RseSB0byBsb2FkaW5nIGluc3RydWN0aW9ucwoJICAgICAgaWYgKHRyYW5zYWN0aW9uICE9PSBudWxsKSB7CgkgICAgICAgIGF3YWl0IHNlbmRBbmRDb25maXJtVHJhbnNhY3Rpb24oY29ubmVjdGlvbiwgdHJhbnNhY3Rpb24sIFtwYXllciwgcHJvZ3JhbV0sIHsKCSAgICAgICAgICBjb21taXRtZW50OiAnY29uZmlybWVkJwoJICAgICAgICB9KTsKCSAgICAgIH0KCSAgICB9CgkgICAgY29uc3QgZGF0YUxheW91dCA9IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgTGF5b3V0RXhwb3J0cy51MzIoJ29mZnNldCcpLCBMYXlvdXRFeHBvcnRzLnUzMignYnl0ZXNMZW5ndGgnKSwgTGF5b3V0RXhwb3J0cy51MzIoJ2J5dGVzTGVuZ3RoUGFkZGluZycpLCBMYXlvdXRFeHBvcnRzLnNlcShMYXlvdXRFeHBvcnRzLnU4KCdieXRlJyksIExheW91dEV4cG9ydHMub2Zmc2V0KExheW91dEV4cG9ydHMudTMyKCksIC04KSwgJ2J5dGVzJyldKTsKCSAgICBjb25zdCBjaHVua1NpemUgPSBMb2FkZXIuY2h1bmtTaXplOwoJICAgIGxldCBvZmZzZXQgPSAwOwoJICAgIGxldCBhcnJheSA9IGRhdGE7CgkgICAgbGV0IHRyYW5zYWN0aW9ucyA9IFtdOwoJICAgIHdoaWxlIChhcnJheS5sZW5ndGggPiAwKSB7CgkgICAgICBjb25zdCBieXRlcyA9IGFycmF5LnNsaWNlKDAsIGNodW5rU2l6ZSk7CgkgICAgICBjb25zdCBkYXRhID0gYnVmZmVyRXhwb3J0cy5CdWZmZXIuYWxsb2MoY2h1bmtTaXplICsgMTYpOwoJICAgICAgZGF0YUxheW91dC5lbmNvZGUoewoJICAgICAgICBpbnN0cnVjdGlvbjogMCwKCSAgICAgICAgLy8gTG9hZCBpbnN0cnVjdGlvbgoJICAgICAgICBvZmZzZXQsCgkgICAgICAgIGJ5dGVzOiBieXRlcywKCSAgICAgICAgYnl0ZXNMZW5ndGg6IDAsCgkgICAgICAgIGJ5dGVzTGVuZ3RoUGFkZGluZzogMAoJICAgICAgfSwgZGF0YSk7CgkgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpLmFkZCh7CgkgICAgICAgIGtleXM6IFt7CgkgICAgICAgICAgcHVia2V5OiBwcm9ncmFtLnB1YmxpY0tleSwKCSAgICAgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICAgIH1dLAoJICAgICAgICBwcm9ncmFtSWQsCgkgICAgICAgIGRhdGEKCSAgICAgIH0pOwoJICAgICAgdHJhbnNhY3Rpb25zLnB1c2goc2VuZEFuZENvbmZpcm1UcmFuc2FjdGlvbihjb25uZWN0aW9uLCB0cmFuc2FjdGlvbiwgW3BheWVyLCBwcm9ncmFtXSwgewoJICAgICAgICBjb21taXRtZW50OiAnY29uZmlybWVkJwoJICAgICAgfSkpOwoKCSAgICAgIC8vIERlbGF5IGJldHdlZW4gc2VuZHMgaW4gYW4gYXR0ZW1wdCB0byByZWR1Y2UgcmF0ZSBsaW1pdCBlcnJvcnMKCSAgICAgIGlmIChjb25uZWN0aW9uLl9ycGNFbmRwb2ludC5pbmNsdWRlcygnc29sYW5hLmNvbScpKSB7CgkgICAgICAgIGNvbnN0IFJFUVVFU1RTX1BFUl9TRUNPTkQgPSA0OwoJICAgICAgICBhd2FpdCBzbGVlcCgxMDAwIC8gUkVRVUVTVFNfUEVSX1NFQ09ORCk7CgkgICAgICB9CgkgICAgICBvZmZzZXQgKz0gY2h1bmtTaXplOwoJICAgICAgYXJyYXkgPSBhcnJheS5zbGljZShjaHVua1NpemUpOwoJICAgIH0KCSAgICBhd2FpdCBQcm9taXNlLmFsbCh0cmFuc2FjdGlvbnMpOwoKCSAgICAvLyBGaW5hbGl6ZSB0aGUgYWNjb3VudCBsb2FkZWQgd2l0aCBwcm9ncmFtIGRhdGEgZm9yIGV4ZWN1dGlvbgoJICAgIHsKCSAgICAgIGNvbnN0IGRhdGFMYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyldKTsKCSAgICAgIGNvbnN0IGRhdGEgPSBidWZmZXJFeHBvcnRzLkJ1ZmZlci5hbGxvYyhkYXRhTGF5b3V0LnNwYW4pOwoJICAgICAgZGF0YUxheW91dC5lbmNvZGUoewoJICAgICAgICBpbnN0cnVjdGlvbjogMSAvLyBGaW5hbGl6ZSBpbnN0cnVjdGlvbgoJICAgICAgfSwgZGF0YSk7CgkgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpLmFkZCh7CgkgICAgICAgIGtleXM6IFt7CgkgICAgICAgICAgcHVia2V5OiBwcm9ncmFtLnB1YmxpY0tleSwKCSAgICAgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICAgIH0sIHsKCSAgICAgICAgICBwdWJrZXk6IFNZU1ZBUl9SRU5UX1BVQktFWSwKCSAgICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgICAgfV0sCgkgICAgICAgIHByb2dyYW1JZCwKCSAgICAgICAgZGF0YQoJICAgICAgfSk7CgkgICAgICBjb25zdCBkZXBsb3lDb21taXRtZW50ID0gJ3Byb2Nlc3NlZCc7CgkgICAgICBjb25zdCBmaW5hbGl6ZVNpZ25hdHVyZSA9IGF3YWl0IGNvbm5lY3Rpb24uc2VuZFRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uLCBbcGF5ZXIsIHByb2dyYW1dLCB7CgkgICAgICAgIHByZWZsaWdodENvbW1pdG1lbnQ6IGRlcGxveUNvbW1pdG1lbnQKCSAgICAgIH0pOwoJICAgICAgY29uc3QgewoJICAgICAgICBjb250ZXh0LAoJICAgICAgICB2YWx1ZQoJICAgICAgfSA9IGF3YWl0IGNvbm5lY3Rpb24uY29uZmlybVRyYW5zYWN0aW9uKHsKCSAgICAgICAgc2lnbmF0dXJlOiBmaW5hbGl6ZVNpZ25hdHVyZSwKCSAgICAgICAgbGFzdFZhbGlkQmxvY2tIZWlnaHQ6IHRyYW5zYWN0aW9uLmxhc3RWYWxpZEJsb2NrSGVpZ2h0LAoJICAgICAgICBibG9ja2hhc2g6IHRyYW5zYWN0aW9uLnJlY2VudEJsb2NraGFzaAoJICAgICAgfSwgZGVwbG95Q29tbWl0bWVudCk7CgkgICAgICBpZiAodmFsdWUuZXJyKSB7CgkgICAgICAgIHRocm93IG5ldyBFcnJvcihgVHJhbnNhY3Rpb24gJHtmaW5hbGl6ZVNpZ25hdHVyZX0gZmFpbGVkICgke0pTT04uc3RyaW5naWZ5KHZhbHVlKX0pYCk7CgkgICAgICB9CgkgICAgICAvLyBXZSBwcmV2ZW50IHByb2dyYW1zIGZyb20gYmVpbmcgdXNhYmxlIHVudGlsIHRoZSBzbG90IGFmdGVyIHRoZWlyIGRlcGxveW1lbnQuCgkgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3NvbGFuYS1sYWJzL3NvbGFuYS9wdWxsLzI5NjU0CgkgICAgICB3aGlsZSAodHJ1ZSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnN0YW50LWNvbmRpdGlvbgoJICAgICAgKSB7CgkgICAgICAgIHRyeSB7CgkgICAgICAgICAgY29uc3QgY3VycmVudFNsb3QgPSBhd2FpdCBjb25uZWN0aW9uLmdldFNsb3QoewoJICAgICAgICAgICAgY29tbWl0bWVudDogZGVwbG95Q29tbWl0bWVudAoJICAgICAgICAgIH0pOwoJICAgICAgICAgIGlmIChjdXJyZW50U2xvdCA+IGNvbnRleHQuc2xvdCkgewoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgfQoJICAgICAgICB9IGNhdGNoIHsKCSAgICAgICAgICAvKiBlbXB0eSAqLwoJICAgICAgICB9CgkgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBNYXRoLnJvdW5kKE1TX1BFUl9TTE9UIC8gMikpKTsKCSAgICAgIH0KCSAgICB9CgoJICAgIC8vIHN1Y2Nlc3MKCSAgICByZXR1cm4gdHJ1ZTsKCSAgfQoJfQoJTG9hZGVyLmNodW5rU2l6ZSA9IENIVU5LX1NJWkU7CgoJLyoqCgkgKiBAZGVwcmVjYXRlZCBEZXByZWNhdGVkIHNpbmNlIFNvbGFuYSB2MS4xNy4yMC4KCSAqLwoJY29uc3QgQlBGX0xPQURFUl9QUk9HUkFNX0lEID0gbmV3IFB1YmxpY0tleSgnQlBGTG9hZGVyMjExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMScpOwoKCS8qKgoJICogRmFjdG9yeSBjbGFzcyBmb3IgdHJhbnNhY3Rpb25zIHRvIGludGVyYWN0IHdpdGggYSBwcm9ncmFtIGxvYWRlcgoJICoKCSAqIEBkZXByZWNhdGVkIERlcHJlY2F0ZWQgc2luY2UgU29sYW5hIHYxLjE3LjIwLgoJICovCgljbGFzcyBCcGZMb2FkZXIgewoJICAvKioKCSAgICogTWluaW11bSBudW1iZXIgb2Ygc2lnbmF0dXJlcyByZXF1aXJlZCB0byBsb2FkIGEgcHJvZ3JhbSBub3QgaW5jbHVkaW5nCgkgICAqIHJldHJpZXMKCSAgICoKCSAgICogQ2FuIGJlIHVzZWQgdG8gY2FsY3VsYXRlIHRyYW5zYWN0aW9uIGZlZXMKCSAgICovCgkgIHN0YXRpYyBnZXRNaW5OdW1TaWduYXR1cmVzKGRhdGFMZW5ndGgpIHsKCSAgICByZXR1cm4gTG9hZGVyLmdldE1pbk51bVNpZ25hdHVyZXMoZGF0YUxlbmd0aCk7CgkgIH0KCgkgIC8qKgoJICAgKiBMb2FkIGEgU0JGIHByb2dyYW0KCSAgICoKCSAgICogQHBhcmFtIGNvbm5lY3Rpb24gVGhlIGNvbm5lY3Rpb24gdG8gdXNlCgkgICAqIEBwYXJhbSBwYXllciBBY2NvdW50IHRoYXQgd2lsbCBwYXkgcHJvZ3JhbSBsb2FkaW5nIGZlZXMKCSAgICogQHBhcmFtIHByb2dyYW0gQWNjb3VudCB0byBsb2FkIHRoZSBwcm9ncmFtIGludG8KCSAgICogQHBhcmFtIGVsZiBUaGUgZW50aXJlIEVMRiBjb250YWluaW5nIHRoZSBTQkYgcHJvZ3JhbQoJICAgKiBAcGFyYW0gbG9hZGVyUHJvZ3JhbUlkIFRoZSBwcm9ncmFtIGlkIG9mIHRoZSBCUEYgbG9hZGVyIHRvIHVzZQoJICAgKiBAcmV0dXJuIHRydWUgaWYgcHJvZ3JhbSB3YXMgbG9hZGVkIHN1Y2Nlc3NmdWxseSwgZmFsc2UgaWYgcHJvZ3JhbSB3YXMgYWxyZWFkeSBsb2FkZWQKCSAgICovCgkgIHN0YXRpYyBsb2FkKGNvbm5lY3Rpb24sIHBheWVyLCBwcm9ncmFtLCBlbGYsIGxvYWRlclByb2dyYW1JZCkgewoJICAgIHJldHVybiBMb2FkZXIubG9hZChjb25uZWN0aW9uLCBwYXllciwgcHJvZ3JhbSwgbG9hZGVyUHJvZ3JhbUlkLCBlbGYpOwoJICB9Cgl9CgoJdmFyIGZhc3RTdGFibGVTdHJpbmdpZnkkMTsKCXZhciBoYXNSZXF1aXJlZEZhc3RTdGFibGVTdHJpbmdpZnk7CgoJZnVuY3Rpb24gcmVxdWlyZUZhc3RTdGFibGVTdHJpbmdpZnkgKCkgewoJCWlmIChoYXNSZXF1aXJlZEZhc3RTdGFibGVTdHJpbmdpZnkpIHJldHVybiBmYXN0U3RhYmxlU3RyaW5naWZ5JDE7CgkJaGFzUmVxdWlyZWRGYXN0U3RhYmxlU3RyaW5naWZ5ID0gMTsKCQl2YXIgb2JqVG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoJCXZhciBvYmpLZXlzID0gT2JqZWN0LmtleXMgfHwgZnVuY3Rpb24ob2JqKSB7CgkJCQl2YXIga2V5cyA9IFtdOwoJCQkJZm9yICh2YXIgbmFtZSBpbiBvYmopIHsKCQkJCQlrZXlzLnB1c2gobmFtZSk7CgkJCQl9CgkJCQlyZXR1cm4ga2V5czsKCQkJfTsKCgkJZnVuY3Rpb24gc3RyaW5naWZ5KHZhbCwgaXNBcnJheVByb3ApIHsKCQkJdmFyIGksIG1heCwgc3RyLCBrZXlzLCBrZXksIHByb3BWYWwsIHRvU3RyOwoJCQlpZiAodmFsID09PSB0cnVlKSB7CgkJCQlyZXR1cm4gInRydWUiOwoJCQl9CgkJCWlmICh2YWwgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm4gImZhbHNlIjsKCQkJfQoJCQlzd2l0Y2ggKHR5cGVvZiB2YWwpIHsKCQkJCWNhc2UgIm9iamVjdCI6CgkJCQkJaWYgKHZhbCA9PT0gbnVsbCkgewoJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQl9IGVsc2UgaWYgKHZhbC50b0pTT04gJiYgdHlwZW9mIHZhbC50b0pTT04gPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJcmV0dXJuIHN0cmluZ2lmeSh2YWwudG9KU09OKCksIGlzQXJyYXlQcm9wKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0b1N0ciA9IG9ialRvU3RyaW5nLmNhbGwodmFsKTsKCQkJCQkJaWYgKHRvU3RyID09PSAiW29iamVjdCBBcnJheV0iKSB7CgkJCQkJCQlzdHIgPSAnWyc7CgkJCQkJCQltYXggPSB2YWwubGVuZ3RoIC0gMTsKCQkJCQkJCWZvcihpID0gMDsgaSA8IG1heDsgaSsrKSB7CgkJCQkJCQkJc3RyICs9IHN0cmluZ2lmeSh2YWxbaV0sIHRydWUpICsgJywnOwoJCQkJCQkJfQoJCQkJCQkJaWYgKG1heCA+IC0xKSB7CgkJCQkJCQkJc3RyICs9IHN0cmluZ2lmeSh2YWxbaV0sIHRydWUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHN0ciArICddJzsKCQkJCQkJfSBlbHNlIGlmICh0b1N0ciA9PT0gIltvYmplY3QgT2JqZWN0XSIpIHsKCQkJCQkJCS8vIG9ubHkgb2JqZWN0IGlzIGxlZnQKCQkJCQkJCWtleXMgPSBvYmpLZXlzKHZhbCkuc29ydCgpOwoJCQkJCQkJbWF4ID0ga2V5cy5sZW5ndGg7CgkJCQkJCQlzdHIgPSAiIjsKCQkJCQkJCWkgPSAwOwoJCQkJCQkJd2hpbGUgKGkgPCBtYXgpIHsKCQkJCQkJCQlrZXkgPSBrZXlzW2ldOwoJCQkJCQkJCXByb3BWYWwgPSBzdHJpbmdpZnkodmFsW2tleV0sIGZhbHNlKTsKCQkJCQkJCQlpZiAocHJvcFZhbCAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJCQkJCWlmIChzdHIpIHsKCQkJCQkJCQkJCXN0ciArPSAnLCc7CgkJCQkJCQkJCX0KCQkJCQkJCQkJc3RyICs9IEpTT04uc3RyaW5naWZ5KGtleSkgKyAnOicgKyBwcm9wVmFsOwoJCQkJCQkJCX0KCQkJCQkJCQlpKys7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gJ3snICsgc3RyICsgJ30nOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbCk7CgkJCQkJCX0KCQkJCQl9CgkJCQljYXNlICJmdW5jdGlvbiI6CgkJCQljYXNlICJ1bmRlZmluZWQiOgoJCQkJCXJldHVybiBpc0FycmF5UHJvcCA/IG51bGwgOiB1bmRlZmluZWQ7CgkJCQljYXNlICJzdHJpbmciOgoJCQkJCXJldHVybiBKU09OLnN0cmluZ2lmeSh2YWwpOwoJCQkJZGVmYXVsdDoKCQkJCQlyZXR1cm4gaXNGaW5pdGUodmFsKSA/IHZhbCA6IG51bGw7CgkJCX0KCQl9CgoJCWZhc3RTdGFibGVTdHJpbmdpZnkkMSA9IGZ1bmN0aW9uKHZhbCkgewoJCQl2YXIgcmV0dXJuVmFsID0gc3RyaW5naWZ5KHZhbCwgZmFsc2UpOwoJCQlpZiAocmV0dXJuVmFsICE9PSB1bmRlZmluZWQpIHsKCQkJCXJldHVybiAnJysgcmV0dXJuVmFsOwoJCQl9CgkJfTsKCQlyZXR1cm4gZmFzdFN0YWJsZVN0cmluZ2lmeSQxOwoJfQoKCXZhciBmYXN0U3RhYmxlU3RyaW5naWZ5RXhwb3J0cyA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUZhc3RTdGFibGVTdHJpbmdpZnkoKTsKCXZhciBmYXN0U3RhYmxlU3RyaW5naWZ5ID0gLypAX19QVVJFX18qL2dldERlZmF1bHRFeHBvcnRGcm9tQ2pzKGZhc3RTdGFibGVTdHJpbmdpZnlFeHBvcnRzKTsKCgkvKioKCSAqIEEgYFN0cnVjdEZhaWx1cmVgIHJlcHJlc2VudHMgYSBzaW5nbGUgc3BlY2lmaWMgZmFpbHVyZSBpbiB2YWxpZGF0aW9uLgoJICovCgkvKioKCSAqIGBTdHJ1Y3RFcnJvcmAgb2JqZWN0cyBhcmUgdGhyb3duIChvciByZXR1cm5lZCkgd2hlbiB2YWxpZGF0aW9uIGZhaWxzLgoJICoKCSAqIFZhbGlkYXRpb24gbG9naWMgaXMgZGVzaWduIHRvIGV4aXQgZWFybHkgZm9yIG1heGltdW0gcGVyZm9ybWFuY2UuIFRoZSBlcnJvcgoJICogcmVwcmVzZW50cyB0aGUgZmlyc3QgZXJyb3IgZW5jb3VudGVyZWQgZHVyaW5nIHZhbGlkYXRpb24uIEZvciBtb3JlIGRldGFpbCwKCSAqIHRoZSBgZXJyb3IuZmFpbHVyZXNgIHByb3BlcnR5IGlzIGEgZ2VuZXJhdG9yIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHJ1biB0bwoJICogY29udGludWUgdmFsaWRhdGlvbiBhbmQgcmVjZWl2ZSBhbGwgdGhlIGZhaWx1cmVzIGluIHRoZSBkYXRhLgoJICovCgljbGFzcyBTdHJ1Y3RFcnJvciBleHRlbmRzIFR5cGVFcnJvciB7CgkgICAgY29uc3RydWN0b3IoZmFpbHVyZSwgZmFpbHVyZXMpIHsKCSAgICAgICAgbGV0IGNhY2hlZDsKCSAgICAgICAgY29uc3QgeyBtZXNzYWdlLCBleHBsYW5hdGlvbiwgLi4ucmVzdCB9ID0gZmFpbHVyZTsKCSAgICAgICAgY29uc3QgeyBwYXRoIH0gPSBmYWlsdXJlOwoJICAgICAgICBjb25zdCBtc2cgPSBwYXRoLmxlbmd0aCA9PT0gMCA/IG1lc3NhZ2UgOiBgQXQgcGF0aDogJHtwYXRoLmpvaW4oJy4nKX0gLS0gJHttZXNzYWdlfWA7CgkgICAgICAgIHN1cGVyKGV4cGxhbmF0aW9uID8/IG1zZyk7CgkgICAgICAgIGlmIChleHBsYW5hdGlvbiAhPSBudWxsKQoJICAgICAgICAgICAgdGhpcy5jYXVzZSA9IG1zZzsKCSAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCByZXN0KTsKCSAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5jb25zdHJ1Y3Rvci5uYW1lOwoJICAgICAgICB0aGlzLmZhaWx1cmVzID0gKCkgPT4gewoJICAgICAgICAgICAgcmV0dXJuIChjYWNoZWQgPz8gKGNhY2hlZCA9IFtmYWlsdXJlLCAuLi5mYWlsdXJlcygpXSkpOwoJICAgICAgICB9OwoJICAgIH0KCX0KCgkvKioKCSAqIENoZWNrIGlmIGEgdmFsdWUgaXMgYW4gaXRlcmF0b3IuCgkgKi8KCWZ1bmN0aW9uIGlzSXRlcmFibGUoeCkgewoJICAgIHJldHVybiBpc09iamVjdCh4KSAmJiB0eXBlb2YgeFtTeW1ib2wuaXRlcmF0b3JdID09PSAnZnVuY3Rpb24nOwoJfQoJLyoqCgkgKiBDaGVjayBpZiBhIHZhbHVlIGlzIGEgcGxhaW4gb2JqZWN0LgoJICovCglmdW5jdGlvbiBpc09iamVjdCh4KSB7CgkgICAgcmV0dXJuIHR5cGVvZiB4ID09PSAnb2JqZWN0JyAmJiB4ICE9IG51bGw7Cgl9CgkvKioKCSAqIENoZWNrIGlmIGEgdmFsdWUgaXMgYSBub24tYXJyYXkgb2JqZWN0LgoJICovCglmdW5jdGlvbiBpc05vbkFycmF5T2JqZWN0KHgpIHsKCSAgICByZXR1cm4gaXNPYmplY3QoeCkgJiYgIUFycmF5LmlzQXJyYXkoeCk7Cgl9CgkvKioKCSAqIFJldHVybiBhIHZhbHVlIGFzIGEgcHJpbnRhYmxlIHN0cmluZy4KCSAqLwoJZnVuY3Rpb24gcHJpbnQodmFsdWUpIHsKCSAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3ltYm9sJykgewoJICAgICAgICByZXR1cm4gdmFsdWUudG9TdHJpbmcoKTsKCSAgICB9CgkgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiBgJHt2YWx1ZX1gOwoJfQoJLyoqCgkgKiBTaGlmdHMgKHJlbW92ZXMgYW5kIHJldHVybnMpIHRoZSBmaXJzdCB2YWx1ZSBmcm9tIHRoZSBgaW5wdXRgIGl0ZXJhdG9yLgoJICogTGlrZSBgQXJyYXkucHJvdG90eXBlLnNoaWZ0KClgIGJ1dCBmb3IgYW4gYEl0ZXJhdG9yYC4KCSAqLwoJZnVuY3Rpb24gc2hpZnRJdGVyYXRvcihpbnB1dCkgewoJICAgIGNvbnN0IHsgZG9uZSwgdmFsdWUgfSA9IGlucHV0Lm5leHQoKTsKCSAgICByZXR1cm4gZG9uZSA/IHVuZGVmaW5lZCA6IHZhbHVlOwoJfQoJLyoqCgkgKiBDb252ZXJ0IGEgc2luZ2xlIHZhbGlkYXRpb24gcmVzdWx0IHRvIGEgZmFpbHVyZS4KCSAqLwoJZnVuY3Rpb24gdG9GYWlsdXJlKHJlc3VsdCwgY29udGV4dCwgc3RydWN0LCB2YWx1ZSkgewoJICAgIGlmIChyZXN1bHQgPT09IHRydWUpIHsKCSAgICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBlbHNlIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7CgkgICAgICAgIHJlc3VsdCA9IHt9OwoJICAgIH0KCSAgICBlbHNlIGlmICh0eXBlb2YgcmVzdWx0ID09PSAnc3RyaW5nJykgewoJICAgICAgICByZXN1bHQgPSB7IG1lc3NhZ2U6IHJlc3VsdCB9OwoJICAgIH0KCSAgICBjb25zdCB7IHBhdGgsIGJyYW5jaCB9ID0gY29udGV4dDsKCSAgICBjb25zdCB7IHR5cGUgfSA9IHN0cnVjdDsKCSAgICBjb25zdCB7IHJlZmluZW1lbnQsIG1lc3NhZ2UgPSBgRXhwZWN0ZWQgYSB2YWx1ZSBvZiB0eXBlIFxgJHt0eXBlfVxgJHtyZWZpbmVtZW50ID8gYCB3aXRoIHJlZmluZW1lbnQgXGAke3JlZmluZW1lbnR9XGBgIDogJyd9LCBidXQgcmVjZWl2ZWQ6IFxgJHtwcmludCh2YWx1ZSl9XGBgLCB9ID0gcmVzdWx0OwoJICAgIHJldHVybiB7CgkgICAgICAgIHZhbHVlLAoJICAgICAgICB0eXBlLAoJICAgICAgICByZWZpbmVtZW50LAoJICAgICAgICBrZXk6IHBhdGhbcGF0aC5sZW5ndGggLSAxXSwKCSAgICAgICAgcGF0aCwKCSAgICAgICAgYnJhbmNoLAoJICAgICAgICAuLi5yZXN1bHQsCgkgICAgICAgIG1lc3NhZ2UsCgkgICAgfTsKCX0KCS8qKgoJICogQ29udmVydCBhIHZhbGlkYXRpb24gcmVzdWx0IHRvIGFuIGl0ZXJhYmxlIG9mIGZhaWx1cmVzLgoJICovCglmdW5jdGlvbiogdG9GYWlsdXJlcyhyZXN1bHQsIGNvbnRleHQsIHN0cnVjdCwgdmFsdWUpIHsKCSAgICBpZiAoIWlzSXRlcmFibGUocmVzdWx0KSkgewoJICAgICAgICByZXN1bHQgPSBbcmVzdWx0XTsKCSAgICB9CgkgICAgZm9yIChjb25zdCByIG9mIHJlc3VsdCkgewoJICAgICAgICBjb25zdCBmYWlsdXJlID0gdG9GYWlsdXJlKHIsIGNvbnRleHQsIHN0cnVjdCwgdmFsdWUpOwoJICAgICAgICBpZiAoZmFpbHVyZSkgewoJICAgICAgICAgICAgeWllbGQgZmFpbHVyZTsKCSAgICAgICAgfQoJICAgIH0KCX0KCS8qKgoJICogQ2hlY2sgYSB2YWx1ZSBhZ2FpbnN0IGEgc3RydWN0LCB0cmF2ZXJzaW5nIGRlZXBseSBpbnRvIG5lc3RlZCB2YWx1ZXMsIGFuZAoJICogcmV0dXJuaW5nIGFuIGl0ZXJhdG9yIG9mIGZhaWx1cmVzIG9yIHN1Y2Nlc3MuCgkgKi8KCWZ1bmN0aW9uKiBydW4odmFsdWUsIHN0cnVjdCwgb3B0aW9ucyA9IHt9KSB7CgkgICAgY29uc3QgeyBwYXRoID0gW10sIGJyYW5jaCA9IFt2YWx1ZV0sIGNvZXJjZSA9IGZhbHNlLCBtYXNrID0gZmFsc2UgfSA9IG9wdGlvbnM7CgkgICAgY29uc3QgY3R4ID0geyBwYXRoLCBicmFuY2gsIG1hc2sgfTsKCSAgICBpZiAoY29lcmNlKSB7CgkgICAgICAgIHZhbHVlID0gc3RydWN0LmNvZXJjZXIodmFsdWUsIGN0eCk7CgkgICAgfQoJICAgIGxldCBzdGF0dXMgPSAndmFsaWQnOwoJICAgIGZvciAoY29uc3QgZmFpbHVyZSBvZiBzdHJ1Y3QudmFsaWRhdG9yKHZhbHVlLCBjdHgpKSB7CgkgICAgICAgIGZhaWx1cmUuZXhwbGFuYXRpb24gPSBvcHRpb25zLm1lc3NhZ2U7CgkgICAgICAgIHN0YXR1cyA9ICdub3RfdmFsaWQnOwoJICAgICAgICB5aWVsZCBbZmFpbHVyZSwgdW5kZWZpbmVkXTsKCSAgICB9CgkgICAgZm9yIChsZXQgW2ssIHYsIHNdIG9mIHN0cnVjdC5lbnRyaWVzKHZhbHVlLCBjdHgpKSB7CgkgICAgICAgIGNvbnN0IHRzID0gcnVuKHYsIHMsIHsKCSAgICAgICAgICAgIHBhdGg6IGsgPT09IHVuZGVmaW5lZCA/IHBhdGggOiBbLi4ucGF0aCwga10sCgkgICAgICAgICAgICBicmFuY2g6IGsgPT09IHVuZGVmaW5lZCA/IGJyYW5jaCA6IFsuLi5icmFuY2gsIHZdLAoJICAgICAgICAgICAgY29lcmNlLAoJICAgICAgICAgICAgbWFzaywKCSAgICAgICAgICAgIG1lc3NhZ2U6IG9wdGlvbnMubWVzc2FnZSwKCSAgICAgICAgfSk7CgkgICAgICAgIGZvciAoY29uc3QgdCBvZiB0cykgewoJICAgICAgICAgICAgaWYgKHRbMF0pIHsKCSAgICAgICAgICAgICAgICBzdGF0dXMgPSB0WzBdLnJlZmluZW1lbnQgIT0gbnVsbCA/ICdub3RfcmVmaW5lZCcgOiAnbm90X3ZhbGlkJzsKCSAgICAgICAgICAgICAgICB5aWVsZCBbdFswXSwgdW5kZWZpbmVkXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UgaWYgKGNvZXJjZSkgewoJICAgICAgICAgICAgICAgIHYgPSB0WzFdOwoJICAgICAgICAgICAgICAgIGlmIChrID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE1hcCkgewoJICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zZXQoaywgdik7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgU2V0KSB7CgkgICAgICAgICAgICAgICAgICAgIHZhbHVlLmFkZCh2KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNPYmplY3QodmFsdWUpKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQgfHwgayBpbiB2YWx1ZSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgkgICAgaWYgKHN0YXR1cyAhPT0gJ25vdF92YWxpZCcpIHsKCSAgICAgICAgZm9yIChjb25zdCBmYWlsdXJlIG9mIHN0cnVjdC5yZWZpbmVyKHZhbHVlLCBjdHgpKSB7CgkgICAgICAgICAgICBmYWlsdXJlLmV4cGxhbmF0aW9uID0gb3B0aW9ucy5tZXNzYWdlOwoJICAgICAgICAgICAgc3RhdHVzID0gJ25vdF9yZWZpbmVkJzsKCSAgICAgICAgICAgIHlpZWxkIFtmYWlsdXJlLCB1bmRlZmluZWRdOwoJICAgICAgICB9CgkgICAgfQoJICAgIGlmIChzdGF0dXMgPT09ICd2YWxpZCcpIHsKCSAgICAgICAgeWllbGQgW3VuZGVmaW5lZCwgdmFsdWVdOwoJICAgIH0KCX0KCgkvKioKCSAqIGBTdHJ1Y3RgIG9iamVjdHMgZW5jYXBzdWxhdGUgdGhlIHZhbGlkYXRpb24gbG9naWMgZm9yIGEgc3BlY2lmaWMgdHlwZSBvZgoJICogdmFsdWVzLiBPbmNlIGNvbnN0cnVjdGVkLCB5b3UgdXNlIHRoZSBgYXNzZXJ0YCwgYGlzYCBvciBgdmFsaWRhdGVgIGhlbHBlcnMgdG8KCSAqIHZhbGlkYXRlIHVua25vd24gaW5wdXQgZGF0YSBhZ2FpbnN0IHRoZSBzdHJ1Y3QuCgkgKi8KCWNsYXNzIFN0cnVjdCB7CgkgICAgY29uc3RydWN0b3IocHJvcHMpIHsKCSAgICAgICAgY29uc3QgeyB0eXBlLCBzY2hlbWEsIHZhbGlkYXRvciwgcmVmaW5lciwgY29lcmNlciA9ICh2YWx1ZSkgPT4gdmFsdWUsIGVudHJpZXMgPSBmdW5jdGlvbiogKCkgeyB9LCB9ID0gcHJvcHM7CgkgICAgICAgIHRoaXMudHlwZSA9IHR5cGU7CgkgICAgICAgIHRoaXMuc2NoZW1hID0gc2NoZW1hOwoJICAgICAgICB0aGlzLmVudHJpZXMgPSBlbnRyaWVzOwoJICAgICAgICB0aGlzLmNvZXJjZXIgPSBjb2VyY2VyOwoJICAgICAgICBpZiAodmFsaWRhdG9yKSB7CgkgICAgICAgICAgICB0aGlzLnZhbGlkYXRvciA9ICh2YWx1ZSwgY29udGV4dCkgPT4gewoJICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHZhbGlkYXRvcih2YWx1ZSwgY29udGV4dCk7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRvRmFpbHVyZXMocmVzdWx0LCBjb250ZXh0LCB0aGlzLCB2YWx1ZSk7CgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgdGhpcy52YWxpZGF0b3IgPSAoKSA9PiBbXTsKCSAgICAgICAgfQoJICAgICAgICBpZiAocmVmaW5lcikgewoJICAgICAgICAgICAgdGhpcy5yZWZpbmVyID0gKHZhbHVlLCBjb250ZXh0KSA9PiB7CgkgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVmaW5lcih2YWx1ZSwgY29udGV4dCk7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRvRmFpbHVyZXMocmVzdWx0LCBjb250ZXh0LCB0aGlzLCB2YWx1ZSk7CgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgdGhpcy5yZWZpbmVyID0gKCkgPT4gW107CgkgICAgICAgIH0KCSAgICB9CgkgICAgLyoqCgkgICAgICogQXNzZXJ0IHRoYXQgYSB2YWx1ZSBwYXNzZXMgdGhlIHN0cnVjdCdzIHZhbGlkYXRpb24sIHRocm93aW5nIGlmIGl0IGRvZXNuJ3QuCgkgICAgICovCgkgICAgYXNzZXJ0KHZhbHVlLCBtZXNzYWdlKSB7CgkgICAgICAgIHJldHVybiBhc3NlcnQodmFsdWUsIHRoaXMsIG1lc3NhZ2UpOwoJICAgIH0KCSAgICAvKioKCSAgICAgKiBDcmVhdGUgYSB2YWx1ZSB3aXRoIHRoZSBzdHJ1Y3QncyBjb2VyY2lvbiBsb2dpYywgdGhlbiB2YWxpZGF0ZSBpdC4KCSAgICAgKi8KCSAgICBjcmVhdGUodmFsdWUsIG1lc3NhZ2UpIHsKCSAgICAgICAgcmV0dXJuIGNyZWF0ZSh2YWx1ZSwgdGhpcywgbWVzc2FnZSk7CgkgICAgfQoJICAgIC8qKgoJICAgICAqIENoZWNrIGlmIGEgdmFsdWUgcGFzc2VzIHRoZSBzdHJ1Y3QncyB2YWxpZGF0aW9uLgoJICAgICAqLwoJICAgIGlzKHZhbHVlKSB7CgkgICAgICAgIHJldHVybiBpcyh2YWx1ZSwgdGhpcyk7CgkgICAgfQoJICAgIC8qKgoJICAgICAqIE1hc2sgYSB2YWx1ZSwgY29lcmNpbmcgYW5kIHZhbGlkYXRpbmcgaXQsIGJ1dCByZXR1cm5pbmcgb25seSB0aGUgc3Vic2V0IG9mCgkgICAgICogcHJvcGVydGllcyBkZWZpbmVkIGJ5IHRoZSBzdHJ1Y3QncyBzY2hlbWEuIE1hc2tpbmcgYXBwbGllcyByZWN1cnNpdmVseSB0bwoJICAgICAqIHByb3BzIG9mIGBvYmplY3RgIHN0cnVjdHMgb25seS4KCSAgICAgKi8KCSAgICBtYXNrKHZhbHVlLCBtZXNzYWdlKSB7CgkgICAgICAgIHJldHVybiBtYXNrKHZhbHVlLCB0aGlzLCBtZXNzYWdlKTsKCSAgICB9CgkgICAgLyoqCgkgICAgICogVmFsaWRhdGUgYSB2YWx1ZSB3aXRoIHRoZSBzdHJ1Y3QncyB2YWxpZGF0aW9uIGxvZ2ljLCByZXR1cm5pbmcgYSB0dXBsZQoJICAgICAqIHJlcHJlc2VudGluZyB0aGUgcmVzdWx0LgoJICAgICAqCgkgICAgICogWW91IG1heSBvcHRpb25hbGx5IHBhc3MgYHRydWVgIGZvciB0aGUgYGNvZXJjZWAgYXJndW1lbnQgdG8gY29lcmNlCgkgICAgICogdGhlIHZhbHVlIGJlZm9yZSBhdHRlbXB0aW5nIHRvIHZhbGlkYXRlIGl0LiBJZiB5b3UgZG8sIHRoZSByZXN1bHQgd2lsbAoJICAgICAqIGNvbnRhaW4gdGhlIGNvZXJjZWQgcmVzdWx0IHdoZW4gc3VjY2Vzc2Z1bC4gQWxzbywgYG1hc2tgIHdpbGwgdHVybiBvbgoJICAgICAqIG1hc2tpbmcgb2YgdGhlIHVua25vd24gYG9iamVjdGAgcHJvcHMgcmVjdXJzaXZlbHkgaWYgcGFzc2VkLgoJICAgICAqLwoJICAgIHZhbGlkYXRlKHZhbHVlLCBvcHRpb25zID0ge30pIHsKCSAgICAgICAgcmV0dXJuIHZhbGlkYXRlJDEodmFsdWUsIHRoaXMsIG9wdGlvbnMpOwoJICAgIH0KCX0KCS8qKgoJICogQXNzZXJ0IHRoYXQgYSB2YWx1ZSBwYXNzZXMgYSBzdHJ1Y3QsIHRocm93aW5nIGlmIGl0IGRvZXNuJ3QuCgkgKi8KCWZ1bmN0aW9uIGFzc2VydCh2YWx1ZSwgc3RydWN0LCBtZXNzYWdlKSB7CgkgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdGUkMSh2YWx1ZSwgc3RydWN0LCB7IG1lc3NhZ2UgfSk7CgkgICAgaWYgKHJlc3VsdFswXSkgewoJICAgICAgICB0aHJvdyByZXN1bHRbMF07CgkgICAgfQoJfQoJLyoqCgkgKiBDcmVhdGUgYSB2YWx1ZSB3aXRoIHRoZSBjb2VyY2lvbiBsb2dpYyBvZiBzdHJ1Y3QgYW5kIHZhbGlkYXRlIGl0LgoJICovCglmdW5jdGlvbiBjcmVhdGUodmFsdWUsIHN0cnVjdCwgbWVzc2FnZSkgewoJICAgIGNvbnN0IHJlc3VsdCA9IHZhbGlkYXRlJDEodmFsdWUsIHN0cnVjdCwgeyBjb2VyY2U6IHRydWUsIG1lc3NhZ2UgfSk7CgkgICAgaWYgKHJlc3VsdFswXSkgewoJICAgICAgICB0aHJvdyByZXN1bHRbMF07CgkgICAgfQoJICAgIGVsc2UgewoJICAgICAgICByZXR1cm4gcmVzdWx0WzFdOwoJICAgIH0KCX0KCS8qKgoJICogTWFzayBhIHZhbHVlLCByZXR1cm5pbmcgb25seSB0aGUgc3Vic2V0IG9mIHByb3BlcnRpZXMgZGVmaW5lZCBieSBhIHN0cnVjdC4KCSAqLwoJZnVuY3Rpb24gbWFzayh2YWx1ZSwgc3RydWN0LCBtZXNzYWdlKSB7CgkgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdGUkMSh2YWx1ZSwgc3RydWN0LCB7IGNvZXJjZTogdHJ1ZSwgbWFzazogdHJ1ZSwgbWVzc2FnZSB9KTsKCSAgICBpZiAocmVzdWx0WzBdKSB7CgkgICAgICAgIHRocm93IHJlc3VsdFswXTsKCSAgICB9CgkgICAgZWxzZSB7CgkgICAgICAgIHJldHVybiByZXN1bHRbMV07CgkgICAgfQoJfQoJLyoqCgkgKiBDaGVjayBpZiBhIHZhbHVlIHBhc3NlcyBhIHN0cnVjdC4KCSAqLwoJZnVuY3Rpb24gaXModmFsdWUsIHN0cnVjdCkgewoJICAgIGNvbnN0IHJlc3VsdCA9IHZhbGlkYXRlJDEodmFsdWUsIHN0cnVjdCk7CgkgICAgcmV0dXJuICFyZXN1bHRbMF07Cgl9CgkvKioKCSAqIFZhbGlkYXRlIGEgdmFsdWUgYWdhaW5zdCBhIHN0cnVjdCwgcmV0dXJuaW5nIGFuIGVycm9yIGlmIGludmFsaWQsIG9yIHRoZQoJICogdmFsdWUgKHdpdGggcG90ZW50aWFsIGNvZXJjaW9uKSBpZiB2YWxpZC4KCSAqLwoJZnVuY3Rpb24gdmFsaWRhdGUkMSh2YWx1ZSwgc3RydWN0LCBvcHRpb25zID0ge30pIHsKCSAgICBjb25zdCB0dXBsZXMgPSBydW4odmFsdWUsIHN0cnVjdCwgb3B0aW9ucyk7CgkgICAgY29uc3QgdHVwbGUgPSBzaGlmdEl0ZXJhdG9yKHR1cGxlcyk7CgkgICAgaWYgKHR1cGxlWzBdKSB7CgkgICAgICAgIGNvbnN0IGVycm9yID0gbmV3IFN0cnVjdEVycm9yKHR1cGxlWzBdLCBmdW5jdGlvbiogKCkgewoJICAgICAgICAgICAgZm9yIChjb25zdCB0IG9mIHR1cGxlcykgewoJICAgICAgICAgICAgICAgIGlmICh0WzBdKSB7CgkgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRbMF07CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICAgICAgcmV0dXJuIFtlcnJvciwgdW5kZWZpbmVkXTsKCSAgICB9CgkgICAgZWxzZSB7CgkgICAgICAgIGNvbnN0IHYgPSB0dXBsZVsxXTsKCSAgICAgICAgcmV0dXJuIFt1bmRlZmluZWQsIHZdOwoJICAgIH0KCX0KCS8qKgoJICogRGVmaW5lIGEgbmV3IHN0cnVjdCB0eXBlIHdpdGggYSBjdXN0b20gdmFsaWRhdGlvbiBmdW5jdGlvbi4KCSAqLwoJZnVuY3Rpb24gZGVmaW5lKG5hbWUsIHZhbGlkYXRvcikgewoJICAgIHJldHVybiBuZXcgU3RydWN0KHsgdHlwZTogbmFtZSwgc2NoZW1hOiBudWxsLCB2YWxpZGF0b3IgfSk7Cgl9CgoJLyoqCgkgKiBFbnN1cmUgdGhhdCBhbnkgdmFsdWUgcGFzc2VzIHZhbGlkYXRpb24uCgkgKi8KCWZ1bmN0aW9uIGFueSgpIHsKCSAgICByZXR1cm4gZGVmaW5lKCdhbnknLCAoKSA9PiB0cnVlKTsKCX0KCWZ1bmN0aW9uIGFycmF5KEVsZW1lbnQpIHsKCSAgICByZXR1cm4gbmV3IFN0cnVjdCh7CgkgICAgICAgIHR5cGU6ICdhcnJheScsCgkgICAgICAgIHNjaGVtYTogRWxlbWVudCwKCSAgICAgICAgKmVudHJpZXModmFsdWUpIHsKCSAgICAgICAgICAgIGlmIChFbGVtZW50ICYmIEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CgkgICAgICAgICAgICAgICAgZm9yIChjb25zdCBbaSwgdl0gb2YgdmFsdWUuZW50cmllcygpKSB7CgkgICAgICAgICAgICAgICAgICAgIHlpZWxkIFtpLCB2LCBFbGVtZW50XTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgkgICAgICAgIGNvZXJjZXIodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlLnNsaWNlKCkgOiB2YWx1ZTsKCSAgICAgICAgfSwKCSAgICAgICAgdmFsaWRhdG9yKHZhbHVlKSB7CgkgICAgICAgICAgICByZXR1cm4gKEFycmF5LmlzQXJyYXkodmFsdWUpIHx8CgkgICAgICAgICAgICAgICAgYEV4cGVjdGVkIGFuIGFycmF5IHZhbHVlLCBidXQgcmVjZWl2ZWQ6ICR7cHJpbnQodmFsdWUpfWApOwoJICAgICAgICB9LAoJICAgIH0pOwoJfQoJLyoqCgkgKiBFbnN1cmUgdGhhdCBhIHZhbHVlIGlzIGEgYm9vbGVhbi4KCSAqLwoJZnVuY3Rpb24gYm9vbGVhbigpIHsKCSAgICByZXR1cm4gZGVmaW5lKCdib29sZWFuJywgKHZhbHVlKSA9PiB7CgkgICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJzsKCSAgICB9KTsKCX0KCS8qKgoJICogRW5zdXJlIHRoYXQgYSB2YWx1ZSBpcyBhbiBpbnN0YW5jZSBvZiBhIHNwZWNpZmljIGNsYXNzLgoJICovCglmdW5jdGlvbiBpbnN0YW5jZShDbGFzcykgewoJICAgIHJldHVybiBkZWZpbmUoJ2luc3RhbmNlJywgKHZhbHVlKSA9PiB7CgkgICAgICAgIHJldHVybiAodmFsdWUgaW5zdGFuY2VvZiBDbGFzcyB8fAoJICAgICAgICAgICAgYEV4cGVjdGVkIGEgXGAke0NsYXNzLm5hbWV9XGAgaW5zdGFuY2UsIGJ1dCByZWNlaXZlZDogJHtwcmludCh2YWx1ZSl9YCk7CgkgICAgfSk7Cgl9CglmdW5jdGlvbiBsaXRlcmFsKGNvbnN0YW50KSB7CgkgICAgY29uc3QgZGVzY3JpcHRpb24gPSBwcmludChjb25zdGFudCk7CgkgICAgY29uc3QgdCA9IHR5cGVvZiBjb25zdGFudDsKCSAgICByZXR1cm4gbmV3IFN0cnVjdCh7CgkgICAgICAgIHR5cGU6ICdsaXRlcmFsJywKCSAgICAgICAgc2NoZW1hOiB0ID09PSAnc3RyaW5nJyB8fCB0ID09PSAnbnVtYmVyJyB8fCB0ID09PSAnYm9vbGVhbicgPyBjb25zdGFudCA6IG51bGwsCgkgICAgICAgIHZhbGlkYXRvcih2YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gY29uc3RhbnQgfHwKCSAgICAgICAgICAgICAgICBgRXhwZWN0ZWQgdGhlIGxpdGVyYWwgXGAke2Rlc2NyaXB0aW9ufVxgLCBidXQgcmVjZWl2ZWQ6ICR7cHJpbnQodmFsdWUpfWApOwoJICAgICAgICB9LAoJICAgIH0pOwoJfQoJLyoqCgkgKiBFbnN1cmUgdGhhdCBubyB2YWx1ZSBldmVyIHBhc3NlcyB2YWxpZGF0aW9uLgoJICovCglmdW5jdGlvbiBuZXZlcigpIHsKCSAgICByZXR1cm4gZGVmaW5lKCduZXZlcicsICgpID0+IGZhbHNlKTsKCX0KCS8qKgoJICogQXVnbWVudCBhbiBleGlzdGluZyBzdHJ1Y3QgdG8gYWxsb3cgYG51bGxgIHZhbHVlcy4KCSAqLwoJZnVuY3Rpb24gbnVsbGFibGUoc3RydWN0KSB7CgkgICAgcmV0dXJuIG5ldyBTdHJ1Y3QoewoJICAgICAgICAuLi5zdHJ1Y3QsCgkgICAgICAgIHZhbGlkYXRvcjogKHZhbHVlLCBjdHgpID0+IHZhbHVlID09PSBudWxsIHx8IHN0cnVjdC52YWxpZGF0b3IodmFsdWUsIGN0eCksCgkgICAgICAgIHJlZmluZXI6ICh2YWx1ZSwgY3R4KSA9PiB2YWx1ZSA9PT0gbnVsbCB8fCBzdHJ1Y3QucmVmaW5lcih2YWx1ZSwgY3R4KSwKCSAgICB9KTsKCX0KCS8qKgoJICogRW5zdXJlIHRoYXQgYSB2YWx1ZSBpcyBhIG51bWJlci4KCSAqLwoJZnVuY3Rpb24gbnVtYmVyKCkgewoJICAgIHJldHVybiBkZWZpbmUoJ251bWJlcicsICh2YWx1ZSkgPT4gewoJICAgICAgICByZXR1cm4gKCh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInICYmICFpc05hTih2YWx1ZSkpIHx8CgkgICAgICAgICAgICBgRXhwZWN0ZWQgYSBudW1iZXIsIGJ1dCByZWNlaXZlZDogJHtwcmludCh2YWx1ZSl9YCk7CgkgICAgfSk7Cgl9CgkvKioKCSAqIEF1Z21lbnQgYSBzdHJ1Y3QgdG8gYWxsb3cgYHVuZGVmaW5lZGAgdmFsdWVzLgoJICovCglmdW5jdGlvbiBvcHRpb25hbChzdHJ1Y3QpIHsKCSAgICByZXR1cm4gbmV3IFN0cnVjdCh7CgkgICAgICAgIC4uLnN0cnVjdCwKCSAgICAgICAgdmFsaWRhdG9yOiAodmFsdWUsIGN0eCkgPT4gdmFsdWUgPT09IHVuZGVmaW5lZCB8fCBzdHJ1Y3QudmFsaWRhdG9yKHZhbHVlLCBjdHgpLAoJICAgICAgICByZWZpbmVyOiAodmFsdWUsIGN0eCkgPT4gdmFsdWUgPT09IHVuZGVmaW5lZCB8fCBzdHJ1Y3QucmVmaW5lcih2YWx1ZSwgY3R4KSwKCSAgICB9KTsKCX0KCS8qKgoJICogRW5zdXJlIHRoYXQgYSB2YWx1ZSBpcyBhbiBvYmplY3Qgd2l0aCBrZXlzIGFuZCB2YWx1ZXMgb2Ygc3BlY2lmaWMgdHlwZXMsIGJ1dAoJICogd2l0aG91dCBlbnN1cmluZyBhbnkgc3BlY2lmaWMgc2hhcGUgb2YgcHJvcGVydGllcy4KCSAqCgkgKiBMaWtlIFR5cGVTY3JpcHQncyBgUmVjb3JkYCB1dGlsaXR5LgoJICovCglmdW5jdGlvbiByZWNvcmQoS2V5LCBWYWx1ZSkgewoJICAgIHJldHVybiBuZXcgU3RydWN0KHsKCSAgICAgICAgdHlwZTogJ3JlY29yZCcsCgkgICAgICAgIHNjaGVtYTogbnVsbCwKCSAgICAgICAgKmVudHJpZXModmFsdWUpIHsKCSAgICAgICAgICAgIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGsgaW4gdmFsdWUpIHsKCSAgICAgICAgICAgICAgICAgICAgY29uc3QgdiA9IHZhbHVlW2tdOwoJICAgICAgICAgICAgICAgICAgICB5aWVsZCBbaywgaywgS2V5XTsKCSAgICAgICAgICAgICAgICAgICAgeWllbGQgW2ssIHYsIFZhbHVlXTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgkgICAgICAgIHZhbGlkYXRvcih2YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIChpc05vbkFycmF5T2JqZWN0KHZhbHVlKSB8fAoJICAgICAgICAgICAgICAgIGBFeHBlY3RlZCBhbiBvYmplY3QsIGJ1dCByZWNlaXZlZDogJHtwcmludCh2YWx1ZSl9YCk7CgkgICAgICAgIH0sCgkgICAgICAgIGNvZXJjZXIodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBpc05vbkFycmF5T2JqZWN0KHZhbHVlKSA/IHsgLi4udmFsdWUgfSA6IHZhbHVlOwoJICAgICAgICB9LAoJICAgIH0pOwoJfQoJLyoqCgkgKiBFbnN1cmUgdGhhdCBhIHZhbHVlIGlzIGEgc3RyaW5nLgoJICovCglmdW5jdGlvbiBzdHJpbmcoKSB7CgkgICAgcmV0dXJuIGRlZmluZSgnc3RyaW5nJywgKHZhbHVlKSA9PiB7CgkgICAgICAgIHJldHVybiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyB8fAoJICAgICAgICAgICAgYEV4cGVjdGVkIGEgc3RyaW5nLCBidXQgcmVjZWl2ZWQ6ICR7cHJpbnQodmFsdWUpfWApOwoJICAgIH0pOwoJfQoJLyoqCgkgKiBFbnN1cmUgdGhhdCBhIHZhbHVlIGlzIGEgdHVwbGUgb2YgYSBzcGVjaWZpYyBsZW5ndGgsIGFuZCB0aGF0IGVhY2ggb2YgaXRzCgkgKiBlbGVtZW50cyBpcyBvZiBhIHNwZWNpZmljIHR5cGUuCgkgKi8KCWZ1bmN0aW9uIHR1cGxlKFN0cnVjdHMpIHsKCSAgICBjb25zdCBOZXZlciA9IG5ldmVyKCk7CgkgICAgcmV0dXJuIG5ldyBTdHJ1Y3QoewoJICAgICAgICB0eXBlOiAndHVwbGUnLAoJICAgICAgICBzY2hlbWE6IG51bGwsCgkgICAgICAgICplbnRyaWVzKHZhbHVlKSB7CgkgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBjb25zdCBsZW5ndGggPSBNYXRoLm1heChTdHJ1Y3RzLmxlbmd0aCwgdmFsdWUubGVuZ3RoKTsKCSAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgIHlpZWxkIFtpLCB2YWx1ZVtpXSwgU3RydWN0c1tpXSB8fCBOZXZlcl07CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoJICAgICAgICB2YWxpZGF0b3IodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwKCSAgICAgICAgICAgICAgICBgRXhwZWN0ZWQgYW4gYXJyYXksIGJ1dCByZWNlaXZlZDogJHtwcmludCh2YWx1ZSl9YCk7CgkgICAgICAgIH0sCgkgICAgICAgIGNvZXJjZXIodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlLnNsaWNlKCkgOiB2YWx1ZTsKCSAgICAgICAgfSwKCSAgICB9KTsKCX0KCS8qKgoJICogRW5zdXJlIHRoYXQgYSB2YWx1ZSBoYXMgYSBzZXQgb2Yga25vd24gcHJvcGVydGllcyBvZiBzcGVjaWZpYyB0eXBlcy4KCSAqCgkgKiBOb3RlOiBVbnJlY29nbml6ZWQgcHJvcGVydGllcyBhcmUgYWxsb3dlZCBhbmQgdW50b3VjaGVkLiBUaGlzIGlzIHNpbWlsYXIgdG8KCSAqIGhvdyBUeXBlU2NyaXB0J3Mgc3RydWN0dXJhbCB0eXBpbmcgd29ya3MuCgkgKi8KCWZ1bmN0aW9uIHR5cGUoc2NoZW1hKSB7CgkgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHNjaGVtYSk7CgkgICAgcmV0dXJuIG5ldyBTdHJ1Y3QoewoJICAgICAgICB0eXBlOiAndHlwZScsCgkgICAgICAgIHNjaGVtYSwKCSAgICAgICAgKmVudHJpZXModmFsdWUpIHsKCSAgICAgICAgICAgIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGsgb2Yga2V5cykgewoJICAgICAgICAgICAgICAgICAgICB5aWVsZCBbaywgdmFsdWVba10sIHNjaGVtYVtrXV07CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoJICAgICAgICB2YWxpZGF0b3IodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiAoaXNOb25BcnJheU9iamVjdCh2YWx1ZSkgfHwKCSAgICAgICAgICAgICAgICBgRXhwZWN0ZWQgYW4gb2JqZWN0LCBidXQgcmVjZWl2ZWQ6ICR7cHJpbnQodmFsdWUpfWApOwoJICAgICAgICB9LAoJICAgICAgICBjb2VyY2VyKHZhbHVlKSB7CgkgICAgICAgICAgICByZXR1cm4gaXNOb25BcnJheU9iamVjdCh2YWx1ZSkgPyB7IC4uLnZhbHVlIH0gOiB2YWx1ZTsKCSAgICAgICAgfSwKCSAgICB9KTsKCX0KCS8qKgoJICogRW5zdXJlIHRoYXQgYSB2YWx1ZSBtYXRjaGVzIG9uZSBvZiBhIHNldCBvZiB0eXBlcy4KCSAqLwoJZnVuY3Rpb24gdW5pb24oU3RydWN0cykgewoJICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gU3RydWN0cy5tYXAoKHMpID0+IHMudHlwZSkuam9pbignIHwgJyk7CgkgICAgcmV0dXJuIG5ldyBTdHJ1Y3QoewoJICAgICAgICB0eXBlOiAndW5pb24nLAoJICAgICAgICBzY2hlbWE6IG51bGwsCgkgICAgICAgIGNvZXJjZXIodmFsdWUsIGN0eCkgewoJICAgICAgICAgICAgZm9yIChjb25zdCBTIG9mIFN0cnVjdHMpIHsKCSAgICAgICAgICAgICAgICBjb25zdCBbZXJyb3IsIGNvZXJjZWRdID0gUy52YWxpZGF0ZSh2YWx1ZSwgewoJICAgICAgICAgICAgICAgICAgICBjb2VyY2U6IHRydWUsCgkgICAgICAgICAgICAgICAgICAgIG1hc2s6IGN0eC5tYXNrLAoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgIGlmICghZXJyb3IpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvZXJjZWQ7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwoJICAgICAgICB9LAoJICAgICAgICB2YWxpZGF0b3IodmFsdWUsIGN0eCkgewoJICAgICAgICAgICAgY29uc3QgZmFpbHVyZXMgPSBbXTsKCSAgICAgICAgICAgIGZvciAoY29uc3QgUyBvZiBTdHJ1Y3RzKSB7CgkgICAgICAgICAgICAgICAgY29uc3QgWy4uLnR1cGxlc10gPSBydW4odmFsdWUsIFMsIGN0eCk7CgkgICAgICAgICAgICAgICAgY29uc3QgW2ZpcnN0XSA9IHR1cGxlczsKCSAgICAgICAgICAgICAgICBpZiAoIWZpcnN0WzBdKSB7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBbXTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgW2ZhaWx1cmVdIG9mIHR1cGxlcykgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZhaWx1cmUpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsdXJlcy5wdXNoKGZhaWx1cmUpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIFsKCSAgICAgICAgICAgICAgICBgRXhwZWN0ZWQgdGhlIHZhbHVlIHRvIHNhdGlzZnkgYSB1bmlvbiBvZiBcYCR7ZGVzY3JpcHRpb259XGAsIGJ1dCByZWNlaXZlZDogJHtwcmludCh2YWx1ZSl9YCwKCSAgICAgICAgICAgICAgICAuLi5mYWlsdXJlcywKCSAgICAgICAgICAgIF07CgkgICAgICAgIH0sCgkgICAgfSk7Cgl9CgkvKioKCSAqIEVuc3VyZSB0aGF0IGFueSB2YWx1ZSBwYXNzZXMgdmFsaWRhdGlvbiwgd2l0aG91dCB3aWRlbmluZyBpdHMgdHlwZSB0byBgYW55YC4KCSAqLwoJZnVuY3Rpb24gdW5rbm93bigpIHsKCSAgICByZXR1cm4gZGVmaW5lKCd1bmtub3duJywgKCkgPT4gdHJ1ZSk7Cgl9CgoJLyoqCgkgKiBBdWdtZW50IGEgYFN0cnVjdGAgdG8gYWRkIGFuIGFkZGl0aW9uYWwgY29lcmNpb24gc3RlcCB0byBpdHMgaW5wdXQuCgkgKgoJICogVGhpcyBhbGxvd3MgeW91IHRvIHRyYW5zZm9ybSBpbnB1dCBkYXRhIGJlZm9yZSB2YWxpZGF0aW5nIGl0LCB0byBpbmNyZWFzZSB0aGUKCSAqIGxpa2VsaWhvb2QgdGhhdCBpdCBwYXNzZXMgdmFsaWRhdGlvbuKAlGZvciBleGFtcGxlIGZvciBkZWZhdWx0IHZhbHVlcywgcGFyc2luZwoJICogZGlmZmVyZW50IGZvcm1hdHMsIGV0Yy4KCSAqCgkgKiBOb3RlOiBZb3UgbXVzdCB1c2UgYGNyZWF0ZSh2YWx1ZSwgU3RydWN0KWAgb24gdGhlIHZhbHVlIHRvIGhhdmUgdGhlIGNvZXJjaW9uCgkgKiB0YWtlIGVmZmVjdCEgVXNpbmcgc2ltcGx5IGBhc3NlcnQoKWAgb3IgYGlzKClgIHdpbGwgbm90IHVzZSBjb2VyY2lvbi4KCSAqLwoJZnVuY3Rpb24gY29lcmNlKHN0cnVjdCwgY29uZGl0aW9uLCBjb2VyY2VyKSB7CgkgICAgcmV0dXJuIG5ldyBTdHJ1Y3QoewoJICAgICAgICAuLi5zdHJ1Y3QsCgkgICAgICAgIGNvZXJjZXI6ICh2YWx1ZSwgY3R4KSA9PiB7CgkgICAgICAgICAgICByZXR1cm4gaXModmFsdWUsIGNvbmRpdGlvbikKCSAgICAgICAgICAgICAgICA/IHN0cnVjdC5jb2VyY2VyKGNvZXJjZXIodmFsdWUsIGN0eCksIGN0eCkKCSAgICAgICAgICAgICAgICA6IHN0cnVjdC5jb2VyY2VyKHZhbHVlLCBjdHgpOwoJICAgICAgICB9LAoJICAgIH0pOwoJfQoKCS8vIFVuaXF1ZSBJRCBjcmVhdGlvbiByZXF1aXJlcyBhIGhpZ2ggcXVhbGl0eSByYW5kb20gIyBnZW5lcmF0b3IuIEluIHRoZSBicm93c2VyIHdlIHRoZXJlZm9yZQoJLy8gcmVxdWlyZSB0aGUgY3J5cHRvIEFQSSBhbmQgZG8gbm90IHN1cHBvcnQgYnVpbHQtaW4gZmFsbGJhY2sgdG8gbG93ZXIgcXVhbGl0eSByYW5kb20gbnVtYmVyCgkvLyBnZW5lcmF0b3JzIChsaWtlIE1hdGgucmFuZG9tKCkpLgoJdmFyIGdldFJhbmRvbVZhbHVlczsKCXZhciBybmRzOCA9IG5ldyBVaW50OEFycmF5KDE2KTsKCWZ1bmN0aW9uIHJuZygpIHsKCSAgLy8gbGF6eSBsb2FkIHNvIHRoYXQgZW52aXJvbm1lbnRzIHRoYXQgbmVlZCB0byBwb2x5ZmlsbCBoYXZlIGEgY2hhbmNlIHRvIGRvIHNvCgkgIGlmICghZ2V0UmFuZG9tVmFsdWVzKSB7CgkgICAgLy8gZ2V0UmFuZG9tVmFsdWVzIG5lZWRzIHRvIGJlIGludm9rZWQgaW4gYSBjb250ZXh0IHdoZXJlICJ0aGlzIiBpcyBhIENyeXB0byBpbXBsZW1lbnRhdGlvbi4gQWxzbywKCSAgICAvLyBmaW5kIHRoZSBjb21wbGV0ZSBpbXBsZW1lbnRhdGlvbiBvZiBjcnlwdG8gKG1zQ3J5cHRvKSBvbiBJRTExLgoJICAgIGdldFJhbmRvbVZhbHVlcyA9IHR5cGVvZiBjcnlwdG8gIT09ICd1bmRlZmluZWQnICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKGNyeXB0bykgfHwgdHlwZW9mIG1zQ3J5cHRvICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgbXNDcnlwdG8uZ2V0UmFuZG9tVmFsdWVzID09PSAnZnVuY3Rpb24nICYmIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKG1zQ3J5cHRvKTsKCgkgICAgaWYgKCFnZXRSYW5kb21WYWx1ZXMpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignY3J5cHRvLmdldFJhbmRvbVZhbHVlcygpIG5vdCBzdXBwb3J0ZWQuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vdXVpZGpzL3V1aWQjZ2V0cmFuZG9tdmFsdWVzLW5vdC1zdXBwb3J0ZWQnKTsKCSAgICB9CgkgIH0KCgkgIHJldHVybiBnZXRSYW5kb21WYWx1ZXMocm5kczgpOwoJfQoKCXZhciBSRUdFWCA9IC9eKD86WzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzEtNV1bMC05YS1mXXszfS1bODlhYl1bMC05YS1mXXszfS1bMC05YS1mXXsxMn18MDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwKSQvaTsKCglmdW5jdGlvbiB2YWxpZGF0ZSh1dWlkKSB7CgkgIHJldHVybiB0eXBlb2YgdXVpZCA9PT0gJ3N0cmluZycgJiYgUkVHRVgudGVzdCh1dWlkKTsKCX0KCgkvKioKCSAqIENvbnZlcnQgYXJyYXkgb2YgMTYgYnl0ZSB2YWx1ZXMgdG8gVVVJRCBzdHJpbmcgZm9ybWF0IG9mIHRoZSBmb3JtOgoJICogWFhYWFhYWFgtWFhYWC1YWFhYLVhYWFgtWFhYWFhYWFhYWFhYCgkgKi8KCgl2YXIgYnl0ZVRvSGV4ID0gW107CgoJZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewoJICBieXRlVG9IZXgucHVzaCgoaSArIDB4MTAwKS50b1N0cmluZygxNikuc3Vic3RyKDEpKTsKCX0KCglmdW5jdGlvbiBzdHJpbmdpZnkoYXJyKSB7CgkgIHZhciBvZmZzZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IDA7CgkgIC8vIE5vdGU6IEJlIGNhcmVmdWwgZWRpdGluZyB0aGlzIGNvZGUhICBJdCdzIGJlZW4gdHVuZWQgZm9yIHBlcmZvcm1hbmNlCgkgIC8vIGFuZCB3b3JrcyBpbiB3YXlzIHlvdSBtYXkgbm90IGV4cGVjdC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS91dWlkanMvdXVpZC9wdWxsLzQzNAoJICB2YXIgdXVpZCA9IChieXRlVG9IZXhbYXJyW29mZnNldCArIDBdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMV1dICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyAyXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDNdXSArICctJyArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgNF1dICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyA1XV0gKyAnLScgKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDZdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgN11dICsgJy0nICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyA4XV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDldXSArICctJyArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMTBdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMTFdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMTJdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMTNdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMTRdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMTVdXSkudG9Mb3dlckNhc2UoKTsgLy8gQ29uc2lzdGVuY3kgY2hlY2sgZm9yIHZhbGlkIFVVSUQuICBJZiB0aGlzIHRocm93cywgaXQncyBsaWtlbHkgZHVlIHRvIG9uZQoJICAvLyBvZiB0aGUgZm9sbG93aW5nOgoJICAvLyAtIE9uZSBvciBtb3JlIGlucHV0IGFycmF5IHZhbHVlcyBkb24ndCBtYXAgdG8gYSBoZXggb2N0ZXQgKGxlYWRpbmcgdG8KCSAgLy8gInVuZGVmaW5lZCIgaW4gdGhlIHV1aWQpCgkgIC8vIC0gSW52YWxpZCBpbnB1dCB2YWx1ZXMgZm9yIHRoZSBSRkMgYHZlcnNpb25gIG9yIGB2YXJpYW50YCBmaWVsZHMKCgkgIGlmICghdmFsaWRhdGUodXVpZCkpIHsKCSAgICB0aHJvdyBUeXBlRXJyb3IoJ1N0cmluZ2lmaWVkIFVVSUQgaXMgaW52YWxpZCcpOwoJICB9CgoJICByZXR1cm4gdXVpZDsKCX0KCgkvLwoJLy8gSW5zcGlyZWQgYnkgaHR0cHM6Ly9naXRodWIuY29tL0xpb3NLL1VVSUQuanMKCS8vIGFuZCBodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvdXVpZC5odG1sCgoJdmFyIF9ub2RlSWQ7CgoJdmFyIF9jbG9ja3NlcTsgLy8gUHJldmlvdXMgdXVpZCBjcmVhdGlvbiB0aW1lCgoKCXZhciBfbGFzdE1TZWNzID0gMDsKCXZhciBfbGFzdE5TZWNzID0gMDsgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS91dWlkanMvdXVpZCBmb3IgQVBJIGRldGFpbHMKCglmdW5jdGlvbiB2MShvcHRpb25zLCBidWYsIG9mZnNldCkgewoJICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKCSAgdmFyIGIgPSBidWYgfHwgbmV3IEFycmF5KDE2KTsKCSAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkgIHZhciBub2RlID0gb3B0aW9ucy5ub2RlIHx8IF9ub2RlSWQ7CgkgIHZhciBjbG9ja3NlcSA9IG9wdGlvbnMuY2xvY2tzZXEgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY2xvY2tzZXEgOiBfY2xvY2tzZXE7IC8vIG5vZGUgYW5kIGNsb2Nrc2VxIG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQgdG8gcmFuZG9tIHZhbHVlcyBpZiB0aGV5J3JlIG5vdAoJICAvLyBzcGVjaWZpZWQuICBXZSBkbyB0aGlzIGxhemlseSB0byBtaW5pbWl6ZSBpc3N1ZXMgcmVsYXRlZCB0byBpbnN1ZmZpY2llbnQKCSAgLy8gc3lzdGVtIGVudHJvcHkuICBTZWUgIzE4OQoKCSAgaWYgKG5vZGUgPT0gbnVsbCB8fCBjbG9ja3NlcSA9PSBudWxsKSB7CgkgICAgdmFyIHNlZWRCeXRlcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBybmcpKCk7CgoJICAgIGlmIChub2RlID09IG51bGwpIHsKCSAgICAgIC8vIFBlciA0LjUsIGNyZWF0ZSBhbmQgNDgtYml0IG5vZGUgaWQsICg0NyByYW5kb20gYml0cyArIG11bHRpY2FzdCBiaXQgPSAxKQoJICAgICAgbm9kZSA9IF9ub2RlSWQgPSBbc2VlZEJ5dGVzWzBdIHwgMHgwMSwgc2VlZEJ5dGVzWzFdLCBzZWVkQnl0ZXNbMl0sIHNlZWRCeXRlc1szXSwgc2VlZEJ5dGVzWzRdLCBzZWVkQnl0ZXNbNV1dOwoJICAgIH0KCgkgICAgaWYgKGNsb2Nrc2VxID09IG51bGwpIHsKCSAgICAgIC8vIFBlciA0LjIuMiwgcmFuZG9taXplICgxNCBiaXQpIGNsb2Nrc2VxCgkgICAgICBjbG9ja3NlcSA9IF9jbG9ja3NlcSA9IChzZWVkQnl0ZXNbNl0gPDwgOCB8IHNlZWRCeXRlc1s3XSkgJiAweDNmZmY7CgkgICAgfQoJICB9IC8vIFVVSUQgdGltZXN0YW1wcyBhcmUgMTAwIG5hbm8tc2Vjb25kIHVuaXRzIHNpbmNlIHRoZSBHcmVnb3JpYW4gZXBvY2gsCgkgIC8vICgxNTgyLTEwLTE1IDAwOjAwKS4gIEpTTnVtYmVycyBhcmVuJ3QgcHJlY2lzZSBlbm91Z2ggZm9yIHRoaXMsIHNvCgkgIC8vIHRpbWUgaXMgaGFuZGxlZCBpbnRlcm5hbGx5IGFzICdtc2VjcycgKGludGVnZXIgbWlsbGlzZWNvbmRzKSBhbmQgJ25zZWNzJwoJICAvLyAoMTAwLW5hbm9zZWNvbmRzIG9mZnNldCBmcm9tIG1zZWNzKSBzaW5jZSB1bml4IGVwb2NoLCAxOTcwLTAxLTAxIDAwOjAwLgoKCgkgIHZhciBtc2VjcyA9IG9wdGlvbnMubXNlY3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubXNlY3MgOiBEYXRlLm5vdygpOyAvLyBQZXIgNC4yLjEuMiwgdXNlIGNvdW50IG9mIHV1aWQncyBnZW5lcmF0ZWQgZHVyaW5nIHRoZSBjdXJyZW50IGNsb2NrCgkgIC8vIGN5Y2xlIHRvIHNpbXVsYXRlIGhpZ2hlciByZXNvbHV0aW9uIGNsb2NrCgoJICB2YXIgbnNlY3MgPSBvcHRpb25zLm5zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm5zZWNzIDogX2xhc3ROU2VjcyArIDE7IC8vIFRpbWUgc2luY2UgbGFzdCB1dWlkIGNyZWF0aW9uIChpbiBtc2VjcykKCgkgIHZhciBkdCA9IG1zZWNzIC0gX2xhc3RNU2VjcyArIChuc2VjcyAtIF9sYXN0TlNlY3MpIC8gMTAwMDA7IC8vIFBlciA0LjIuMS4yLCBCdW1wIGNsb2Nrc2VxIG9uIGNsb2NrIHJlZ3Jlc3Npb24KCgkgIGlmIChkdCA8IDAgJiYgb3B0aW9ucy5jbG9ja3NlcSA9PT0gdW5kZWZpbmVkKSB7CgkgICAgY2xvY2tzZXEgPSBjbG9ja3NlcSArIDEgJiAweDNmZmY7CgkgIH0gLy8gUmVzZXQgbnNlY3MgaWYgY2xvY2sgcmVncmVzc2VzIChuZXcgY2xvY2tzZXEpIG9yIHdlJ3ZlIG1vdmVkIG9udG8gYSBuZXcKCSAgLy8gdGltZSBpbnRlcnZhbAoKCgkgIGlmICgoZHQgPCAwIHx8IG1zZWNzID4gX2xhc3RNU2VjcykgJiYgb3B0aW9ucy5uc2VjcyA9PT0gdW5kZWZpbmVkKSB7CgkgICAgbnNlY3MgPSAwOwoJICB9IC8vIFBlciA0LjIuMS4yIFRocm93IGVycm9yIGlmIHRvbyBtYW55IHV1aWRzIGFyZSByZXF1ZXN0ZWQKCgoJICBpZiAobnNlY3MgPj0gMTAwMDApIHsKCSAgICB0aHJvdyBuZXcgRXJyb3IoInV1aWQudjEoKTogQ2FuJ3QgY3JlYXRlIG1vcmUgdGhhbiAxME0gdXVpZHMvc2VjIik7CgkgIH0KCgkgIF9sYXN0TVNlY3MgPSBtc2VjczsKCSAgX2xhc3ROU2VjcyA9IG5zZWNzOwoJICBfY2xvY2tzZXEgPSBjbG9ja3NlcTsgLy8gUGVyIDQuMS40IC0gQ29udmVydCBmcm9tIHVuaXggZXBvY2ggdG8gR3JlZ29yaWFuIGVwb2NoCgoJICBtc2VjcyArPSAxMjIxOTI5MjgwMDAwMDsgLy8gYHRpbWVfbG93YAoKCSAgdmFyIHRsID0gKChtc2VjcyAmIDB4ZmZmZmZmZikgKiAxMDAwMCArIG5zZWNzKSAlIDB4MTAwMDAwMDAwOwoJICBiW2krK10gPSB0bCA+Pj4gMjQgJiAweGZmOwoJICBiW2krK10gPSB0bCA+Pj4gMTYgJiAweGZmOwoJICBiW2krK10gPSB0bCA+Pj4gOCAmIDB4ZmY7CgkgIGJbaSsrXSA9IHRsICYgMHhmZjsgLy8gYHRpbWVfbWlkYAoKCSAgdmFyIHRtaCA9IG1zZWNzIC8gMHgxMDAwMDAwMDAgKiAxMDAwMCAmIDB4ZmZmZmZmZjsKCSAgYltpKytdID0gdG1oID4+PiA4ICYgMHhmZjsKCSAgYltpKytdID0gdG1oICYgMHhmZjsgLy8gYHRpbWVfaGlnaF9hbmRfdmVyc2lvbmAKCgkgIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAweGYgfCAweDEwOyAvLyBpbmNsdWRlIHZlcnNpb24KCgkgIGJbaSsrXSA9IHRtaCA+Pj4gMTYgJiAweGZmOyAvLyBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAgKFBlciA0LjIuMiAtIGluY2x1ZGUgdmFyaWFudCkKCgkgIGJbaSsrXSA9IGNsb2Nrc2VxID4+PiA4IHwgMHg4MDsgLy8gYGNsb2NrX3NlcV9sb3dgCgoJICBiW2krK10gPSBjbG9ja3NlcSAmIDB4ZmY7IC8vIGBub2RlYAoKCSAgZm9yICh2YXIgbiA9IDA7IG4gPCA2OyArK24pIHsKCSAgICBiW2kgKyBuXSA9IG5vZGVbbl07CgkgIH0KCgkgIHJldHVybiBidWYgfHwgc3RyaW5naWZ5KGIpOwoJfQoKCWZ1bmN0aW9uIHBhcnNlKHV1aWQpIHsKCSAgaWYgKCF2YWxpZGF0ZSh1dWlkKSkgewoJICAgIHRocm93IFR5cGVFcnJvcignSW52YWxpZCBVVUlEJyk7CgkgIH0KCgkgIHZhciB2OwoJICB2YXIgYXJyID0gbmV3IFVpbnQ4QXJyYXkoMTYpOyAvLyBQYXJzZSAjIyMjIyMjIy0uLi4uLS4uLi4tLi4uLi0uLi4uLi4uLi4uLi4KCgkgIGFyclswXSA9ICh2ID0gcGFyc2VJbnQodXVpZC5zbGljZSgwLCA4KSwgMTYpKSA+Pj4gMjQ7CgkgIGFyclsxXSA9IHYgPj4+IDE2ICYgMHhmZjsKCSAgYXJyWzJdID0gdiA+Pj4gOCAmIDB4ZmY7CgkgIGFyclszXSA9IHYgJiAweGZmOyAvLyBQYXJzZSAuLi4uLi4uLi0jIyMjLS4uLi4tLi4uLi0uLi4uLi4uLi4uLi4KCgkgIGFycls0XSA9ICh2ID0gcGFyc2VJbnQodXVpZC5zbGljZSg5LCAxMyksIDE2KSkgPj4+IDg7CgkgIGFycls1XSA9IHYgJiAweGZmOyAvLyBQYXJzZSAuLi4uLi4uLi0uLi4uLSMjIyMtLi4uLi0uLi4uLi4uLi4uLi4KCgkgIGFycls2XSA9ICh2ID0gcGFyc2VJbnQodXVpZC5zbGljZSgxNCwgMTgpLCAxNikpID4+PiA4OwoJICBhcnJbN10gPSB2ICYgMHhmZjsgLy8gUGFyc2UgLi4uLi4uLi4tLi4uLi0uLi4uLSMjIyMtLi4uLi4uLi4uLi4uCgoJICBhcnJbOF0gPSAodiA9IHBhcnNlSW50KHV1aWQuc2xpY2UoMTksIDIzKSwgMTYpKSA+Pj4gODsKCSAgYXJyWzldID0gdiAmIDB4ZmY7IC8vIFBhcnNlIC4uLi4uLi4uLS4uLi4tLi4uLi0uLi4uLSMjIyMjIyMjIyMjIwoJICAvLyAoVXNlICIvIiB0byBhdm9pZCAzMi1iaXQgdHJ1bmNhdGlvbiB3aGVuIGJpdC1zaGlmdGluZyBoaWdoLW9yZGVyIGJ5dGVzKQoKCSAgYXJyWzEwXSA9ICh2ID0gcGFyc2VJbnQodXVpZC5zbGljZSgyNCwgMzYpLCAxNikpIC8gMHgxMDAwMDAwMDAwMCAmIDB4ZmY7CgkgIGFyclsxMV0gPSB2IC8gMHgxMDAwMDAwMDAgJiAweGZmOwoJICBhcnJbMTJdID0gdiA+Pj4gMjQgJiAweGZmOwoJICBhcnJbMTNdID0gdiA+Pj4gMTYgJiAweGZmOwoJICBhcnJbMTRdID0gdiA+Pj4gOCAmIDB4ZmY7CgkgIGFyclsxNV0gPSB2ICYgMHhmZjsKCSAgcmV0dXJuIGFycjsKCX0KCglmdW5jdGlvbiBzdHJpbmdUb0J5dGVzKHN0cikgewoJICBzdHIgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoc3RyKSk7IC8vIFVURjggZXNjYXBlCgoJICB2YXIgYnl0ZXMgPSBbXTsKCgkgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CgkgICAgYnl0ZXMucHVzaChzdHIuY2hhckNvZGVBdChpKSk7CgkgIH0KCgkgIHJldHVybiBieXRlczsKCX0KCgl2YXIgRE5TID0gJzZiYTdiODEwLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCc7Cgl2YXIgVVJMID0gJzZiYTdiODExLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCc7CglmdW5jdGlvbiB2MzUgKG5hbWUsIHZlcnNpb24sIGhhc2hmdW5jKSB7CgkgIGZ1bmN0aW9uIGdlbmVyYXRlVVVJRCh2YWx1ZSwgbmFtZXNwYWNlLCBidWYsIG9mZnNldCkgewoJICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CgkgICAgICB2YWx1ZSA9IHN0cmluZ1RvQnl0ZXModmFsdWUpOwoJICAgIH0KCgkgICAgaWYgKHR5cGVvZiBuYW1lc3BhY2UgPT09ICdzdHJpbmcnKSB7CgkgICAgICBuYW1lc3BhY2UgPSBwYXJzZShuYW1lc3BhY2UpOwoJICAgIH0KCgkgICAgaWYgKG5hbWVzcGFjZS5sZW5ndGggIT09IDE2KSB7CgkgICAgICB0aHJvdyBUeXBlRXJyb3IoJ05hbWVzcGFjZSBtdXN0IGJlIGFycmF5LWxpa2UgKDE2IGl0ZXJhYmxlIGludGVnZXIgdmFsdWVzLCAwLTI1NSknKTsKCSAgICB9IC8vIENvbXB1dGUgaGFzaCBvZiBuYW1lc3BhY2UgYW5kIHZhbHVlLCBQZXIgNC4zCgkgICAgLy8gRnV0dXJlOiBVc2Ugc3ByZWFkIHN5bnRheCB3aGVuIHN1cHBvcnRlZCBvbiBhbGwgcGxhdGZvcm1zLCBlLmcuIGBieXRlcyA9CgkgICAgLy8gaGFzaGZ1bmMoWy4uLm5hbWVzcGFjZSwgLi4uIHZhbHVlXSlgCgoKCSAgICB2YXIgYnl0ZXMgPSBuZXcgVWludDhBcnJheSgxNiArIHZhbHVlLmxlbmd0aCk7CgkgICAgYnl0ZXMuc2V0KG5hbWVzcGFjZSk7CgkgICAgYnl0ZXMuc2V0KHZhbHVlLCBuYW1lc3BhY2UubGVuZ3RoKTsKCSAgICBieXRlcyA9IGhhc2hmdW5jKGJ5dGVzKTsKCSAgICBieXRlc1s2XSA9IGJ5dGVzWzZdICYgMHgwZiB8IHZlcnNpb247CgkgICAgYnl0ZXNbOF0gPSBieXRlc1s4XSAmIDB4M2YgfCAweDgwOwoKCSAgICBpZiAoYnVmKSB7CgkgICAgICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKCgkgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDE2OyArK2kpIHsKCSAgICAgICAgYnVmW29mZnNldCArIGldID0gYnl0ZXNbaV07CgkgICAgICB9CgoJICAgICAgcmV0dXJuIGJ1ZjsKCSAgICB9CgoJICAgIHJldHVybiBzdHJpbmdpZnkoYnl0ZXMpOwoJICB9IC8vIEZ1bmN0aW9uI25hbWUgaXMgbm90IHNldHRhYmxlIG9uIHNvbWUgcGxhdGZvcm1zICgjMjcwKQoKCgkgIHRyeSB7CgkgICAgZ2VuZXJhdGVVVUlELm5hbWUgPSBuYW1lOyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZW1wdHkKCSAgfSBjYXRjaCAoZXJyKSB7fSAvLyBGb3IgQ29tbW9uSlMgZGVmYXVsdCBleHBvcnQgc3VwcG9ydAoKCgkgIGdlbmVyYXRlVVVJRC5ETlMgPSBETlM7CgkgIGdlbmVyYXRlVVVJRC5VUkwgPSBVUkw7CgkgIHJldHVybiBnZW5lcmF0ZVVVSUQ7Cgl9CgoJLyoKCSAqIEJyb3dzZXItY29tcGF0aWJsZSBKYXZhU2NyaXB0IE1ENQoJICoKCSAqIE1vZGlmaWNhdGlvbiBvZiBKYXZhU2NyaXB0IE1ENQoJICogaHR0cHM6Ly9naXRodWIuY29tL2JsdWVpbXAvSmF2YVNjcmlwdC1NRDUKCSAqCgkgKiBDb3B5cmlnaHQgMjAxMSwgU2ViYXN0aWFuIFRzY2hhbgoJICogaHR0cHM6Ly9ibHVlaW1wLm5ldAoJICoKCSAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZToKCSAqIGh0dHBzOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUCgkgKgoJICogQmFzZWQgb24KCSAqIEEgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgUlNBIERhdGEgU2VjdXJpdHksIEluYy4gTUQ1IE1lc3NhZ2UKCSAqIERpZ2VzdCBBbGdvcml0aG0sIGFzIGRlZmluZWQgaW4gUkZDIDEzMjEuCgkgKiBWZXJzaW9uIDIuMiBDb3B5cmlnaHQgKEMpIFBhdWwgSm9obnN0b24gMTk5OSAtIDIwMDkKCSAqIE90aGVyIGNvbnRyaWJ1dG9yczogR3JlZyBIb2x0LCBBbmRyZXcgS2VwZXJ0LCBZZG5hciwgTG9zdGluZXQKCSAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgTGljZW5zZQoJICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIG1vcmUgaW5mby4KCSAqLwoJZnVuY3Rpb24gbWQ1KGJ5dGVzKSB7CgkgIGlmICh0eXBlb2YgYnl0ZXMgPT09ICdzdHJpbmcnKSB7CgkgICAgdmFyIG1zZyA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChieXRlcykpOyAvLyBVVEY4IGVzY2FwZQoKCSAgICBieXRlcyA9IG5ldyBVaW50OEFycmF5KG1zZy5sZW5ndGgpOwoKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1zZy5sZW5ndGg7ICsraSkgewoJICAgICAgYnl0ZXNbaV0gPSBtc2cuY2hhckNvZGVBdChpKTsKCSAgICB9CgkgIH0KCgkgIHJldHVybiBtZDVUb0hleEVuY29kZWRBcnJheSh3b3Jkc1RvTWQ1KGJ5dGVzVG9Xb3JkcyhieXRlcyksIGJ5dGVzLmxlbmd0aCAqIDgpKTsKCX0KCS8qCgkgKiBDb252ZXJ0IGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMgdG8gYW4gYXJyYXkgb2YgYnl0ZXMKCSAqLwoKCglmdW5jdGlvbiBtZDVUb0hleEVuY29kZWRBcnJheShpbnB1dCkgewoJICB2YXIgb3V0cHV0ID0gW107CgkgIHZhciBsZW5ndGgzMiA9IGlucHV0Lmxlbmd0aCAqIDMyOwoJICB2YXIgaGV4VGFiID0gJzAxMjM0NTY3ODlhYmNkZWYnOwoKCSAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGgzMjsgaSArPSA4KSB7CgkgICAgdmFyIHggPSBpbnB1dFtpID4+IDVdID4+PiBpICUgMzIgJiAweGZmOwoJICAgIHZhciBoZXggPSBwYXJzZUludChoZXhUYWIuY2hhckF0KHggPj4+IDQgJiAweDBmKSArIGhleFRhYi5jaGFyQXQoeCAmIDB4MGYpLCAxNik7CgkgICAgb3V0cHV0LnB1c2goaGV4KTsKCSAgfQoKCSAgcmV0dXJuIG91dHB1dDsKCX0KCS8qKgoJICogQ2FsY3VsYXRlIG91dHB1dCBsZW5ndGggd2l0aCBwYWRkaW5nIGFuZCBiaXQgbGVuZ3RoCgkgKi8KCgoJZnVuY3Rpb24gZ2V0T3V0cHV0TGVuZ3RoKGlucHV0TGVuZ3RoOCkgewoJICByZXR1cm4gKGlucHV0TGVuZ3RoOCArIDY0ID4+PiA5IDw8IDQpICsgMTQgKyAxOwoJfQoJLyoKCSAqIENhbGN1bGF0ZSB0aGUgTUQ1IG9mIGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMsIGFuZCBhIGJpdCBsZW5ndGguCgkgKi8KCgoJZnVuY3Rpb24gd29yZHNUb01kNSh4LCBsZW4pIHsKCSAgLyogYXBwZW5kIHBhZGRpbmcgKi8KCSAgeFtsZW4gPj4gNV0gfD0gMHg4MCA8PCBsZW4gJSAzMjsKCSAgeFtnZXRPdXRwdXRMZW5ndGgobGVuKSAtIDFdID0gbGVuOwoJICB2YXIgYSA9IDE3MzI1ODQxOTM7CgkgIHZhciBiID0gLTI3MTczMzg3OTsKCSAgdmFyIGMgPSAtMTczMjU4NDE5NDsKCSAgdmFyIGQgPSAyNzE3MzM4Nzg7CgoJICBmb3IgKHZhciBpID0gMDsgaSA8IHgubGVuZ3RoOyBpICs9IDE2KSB7CgkgICAgdmFyIG9sZGEgPSBhOwoJICAgIHZhciBvbGRiID0gYjsKCSAgICB2YXIgb2xkYyA9IGM7CgkgICAgdmFyIG9sZGQgPSBkOwoJICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2ldLCA3LCAtNjgwODc2OTM2KTsKCSAgICBkID0gbWQ1ZmYoZCwgYSwgYiwgYywgeFtpICsgMV0sIDEyLCAtMzg5NTY0NTg2KTsKCSAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgMl0sIDE3LCA2MDYxMDU4MTkpOwoJICAgIGIgPSBtZDVmZihiLCBjLCBkLCBhLCB4W2kgKyAzXSwgMjIsIC0xMDQ0NTI1MzMwKTsKCSAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpICsgNF0sIDcsIC0xNzY0MTg4OTcpOwoJICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyA1XSwgMTIsIDEyMDAwODA0MjYpOwoJICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyA2XSwgMTcsIC0xNDczMjMxMzQxKTsKCSAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgN10sIDIyLCAtNDU3MDU5ODMpOwoJICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2kgKyA4XSwgNywgMTc3MDAzNTQxNik7CgkgICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDldLCAxMiwgLTE5NTg0MTQ0MTcpOwoJICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyAxMF0sIDE3LCAtNDIwNjMpOwoJICAgIGIgPSBtZDVmZihiLCBjLCBkLCBhLCB4W2kgKyAxMV0sIDIyLCAtMTk5MDQwNDE2Mik7CgkgICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaSArIDEyXSwgNywgMTgwNDYwMzY4Mik7CgkgICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDEzXSwgMTIsIC00MDM0MTEwMSk7CgkgICAgYyA9IG1kNWZmKGMsIGQsIGEsIGIsIHhbaSArIDE0XSwgMTcsIC0xNTAyMDAyMjkwKTsKCSAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgMTVdLCAyMiwgMTIzNjUzNTMyOSk7CgkgICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDFdLCA1LCAtMTY1Nzk2NTEwKTsKCSAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgNl0sIDksIC0xMDY5NTAxNjMyKTsKCSAgICBjID0gbWQ1Z2coYywgZCwgYSwgYiwgeFtpICsgMTFdLCAxNCwgNjQzNzE3NzEzKTsKCSAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpXSwgMjAsIC0zNzM4OTczMDIpOwoJICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyA1XSwgNSwgLTcwMTU1ODY5MSk7CgkgICAgZCA9IG1kNWdnKGQsIGEsIGIsIGMsIHhbaSArIDEwXSwgOSwgMzgwMTYwODMpOwoJICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAxNV0sIDE0LCAtNjYwNDc4MzM1KTsKCSAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpICsgNF0sIDIwLCAtNDA1NTM3ODQ4KTsKCSAgICBhID0gbWQ1Z2coYSwgYiwgYywgZCwgeFtpICsgOV0sIDUsIDU2ODQ0NjQzOCk7CgkgICAgZCA9IG1kNWdnKGQsIGEsIGIsIGMsIHhbaSArIDE0XSwgOSwgLTEwMTk4MDM2OTApOwoJICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAzXSwgMTQsIC0xODczNjM5NjEpOwoJICAgIGIgPSBtZDVnZyhiLCBjLCBkLCBhLCB4W2kgKyA4XSwgMjAsIDExNjM1MzE1MDEpOwoJICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyAxM10sIDUsIC0xNDQ0NjgxNDY3KTsKCSAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgMl0sIDksIC01MTQwMzc4NCk7CgkgICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDddLCAxNCwgMTczNTMyODQ3Myk7CgkgICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaSArIDEyXSwgMjAsIC0xOTI2NjA3NzM0KTsKCSAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgNV0sIDQsIC0zNzg1NTgpOwoJICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2kgKyA4XSwgMTEsIC0yMDIyNTc0NDYzKTsKCSAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgMTFdLCAxNiwgMTgzOTAzMDU2Mik7CgkgICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDE0XSwgMjMsIC0zNTMwOTU1Nik7CgkgICAgYSA9IG1kNWhoKGEsIGIsIGMsIGQsIHhbaSArIDFdLCA0LCAtMTUzMDk5MjA2MCk7CgkgICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaSArIDRdLCAxMSwgMTI3Mjg5MzM1Myk7CgkgICAgYyA9IG1kNWhoKGMsIGQsIGEsIGIsIHhbaSArIDddLCAxNiwgLTE1NTQ5NzYzMik7CgkgICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDEwXSwgMjMsIC0xMDk0NzMwNjQwKTsKCSAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgMTNdLCA0LCA2ODEyNzkxNzQpOwoJICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2ldLCAxMSwgLTM1ODUzNzIyMik7CgkgICAgYyA9IG1kNWhoKGMsIGQsIGEsIGIsIHhbaSArIDNdLCAxNiwgLTcyMjUyMTk3OSk7CgkgICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDZdLCAyMywgNzYwMjkxODkpOwoJICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyA5XSwgNCwgLTY0MDM2NDQ4Nyk7CgkgICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaSArIDEyXSwgMTEsIC00MjE4MTU4MzUpOwoJICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyAxNV0sIDE2LCA1MzA3NDI1MjApOwoJICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyAyXSwgMjMsIC05OTUzMzg2NTEpOwoJICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2ldLCA2LCAtMTk4NjMwODQ0KTsKCSAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgN10sIDEwLCAxMTI2ODkxNDE1KTsKCSAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMTRdLCAxNSwgLTE0MTYzNTQ5MDUpOwoJICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyA1XSwgMjEsIC01NzQzNDA1NSk7CgkgICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDEyXSwgNiwgMTcwMDQ4NTU3MSk7CgkgICAgZCA9IG1kNWlpKGQsIGEsIGIsIGMsIHhbaSArIDNdLCAxMCwgLTE4OTQ5ODY2MDYpOwoJICAgIGMgPSBtZDVpaShjLCBkLCBhLCBiLCB4W2kgKyAxMF0sIDE1LCAtMTA1MTUyMyk7CgkgICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDFdLCAyMSwgLTIwNTQ5MjI3OTkpOwoJICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2kgKyA4XSwgNiwgMTg3MzMxMzM1OSk7CgkgICAgZCA9IG1kNWlpKGQsIGEsIGIsIGMsIHhbaSArIDE1XSwgMTAsIC0zMDYxMTc0NCk7CgkgICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDZdLCAxNSwgLTE1NjAxOTgzODApOwoJICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyAxM10sIDIxLCAxMzA5MTUxNjQ5KTsKCSAgICBhID0gbWQ1aWkoYSwgYiwgYywgZCwgeFtpICsgNF0sIDYsIC0xNDU1MjMwNzApOwoJICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyAxMV0sIDEwLCAtMTEyMDIxMDM3OSk7CgkgICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDJdLCAxNSwgNzE4Nzg3MjU5KTsKCSAgICBiID0gbWQ1aWkoYiwgYywgZCwgYSwgeFtpICsgOV0sIDIxLCAtMzQzNDg1NTUxKTsKCSAgICBhID0gc2FmZUFkZChhLCBvbGRhKTsKCSAgICBiID0gc2FmZUFkZChiLCBvbGRiKTsKCSAgICBjID0gc2FmZUFkZChjLCBvbGRjKTsKCSAgICBkID0gc2FmZUFkZChkLCBvbGRkKTsKCSAgfQoKCSAgcmV0dXJuIFthLCBiLCBjLCBkXTsKCX0KCS8qCgkgKiBDb252ZXJ0IGFuIGFycmF5IGJ5dGVzIHRvIGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMKCSAqIENoYXJhY3RlcnMgPjI1NSBoYXZlIHRoZWlyIGhpZ2gtYnl0ZSBzaWxlbnRseSBpZ25vcmVkLgoJICovCgoKCWZ1bmN0aW9uIGJ5dGVzVG9Xb3JkcyhpbnB1dCkgewoJICBpZiAoaW5wdXQubGVuZ3RoID09PSAwKSB7CgkgICAgcmV0dXJuIFtdOwoJICB9CgoJICB2YXIgbGVuZ3RoOCA9IGlucHV0Lmxlbmd0aCAqIDg7CgkgIHZhciBvdXRwdXQgPSBuZXcgVWludDMyQXJyYXkoZ2V0T3V0cHV0TGVuZ3RoKGxlbmd0aDgpKTsKCgkgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoODsgaSArPSA4KSB7CgkgICAgb3V0cHV0W2kgPj4gNV0gfD0gKGlucHV0W2kgLyA4XSAmIDB4ZmYpIDw8IGkgJSAzMjsKCSAgfQoKCSAgcmV0dXJuIG91dHB1dDsKCX0KCS8qCgkgKiBBZGQgaW50ZWdlcnMsIHdyYXBwaW5nIGF0IDJeMzIuIFRoaXMgdXNlcyAxNi1iaXQgb3BlcmF0aW9ucyBpbnRlcm5hbGx5CgkgKiB0byB3b3JrIGFyb3VuZCBidWdzIGluIHNvbWUgSlMgaW50ZXJwcmV0ZXJzLgoJICovCgoKCWZ1bmN0aW9uIHNhZmVBZGQoeCwgeSkgewoJICB2YXIgbHN3ID0gKHggJiAweGZmZmYpICsgKHkgJiAweGZmZmYpOwoJICB2YXIgbXN3ID0gKHggPj4gMTYpICsgKHkgPj4gMTYpICsgKGxzdyA+PiAxNik7CgkgIHJldHVybiBtc3cgPDwgMTYgfCBsc3cgJiAweGZmZmY7Cgl9CgkvKgoJICogQml0d2lzZSByb3RhdGUgYSAzMi1iaXQgbnVtYmVyIHRvIHRoZSBsZWZ0LgoJICovCgoKCWZ1bmN0aW9uIGJpdFJvdGF0ZUxlZnQobnVtLCBjbnQpIHsKCSAgcmV0dXJuIG51bSA8PCBjbnQgfCBudW0gPj4+IDMyIC0gY250OwoJfQoJLyoKCSAqIFRoZXNlIGZ1bmN0aW9ucyBpbXBsZW1lbnQgdGhlIGZvdXIgYmFzaWMgb3BlcmF0aW9ucyB0aGUgYWxnb3JpdGhtIHVzZXMuCgkgKi8KCgoJZnVuY3Rpb24gbWQ1Y21uKHEsIGEsIGIsIHgsIHMsIHQpIHsKCSAgcmV0dXJuIHNhZmVBZGQoYml0Um90YXRlTGVmdChzYWZlQWRkKHNhZmVBZGQoYSwgcSksIHNhZmVBZGQoeCwgdCkpLCBzKSwgYik7Cgl9CgoJZnVuY3Rpb24gbWQ1ZmYoYSwgYiwgYywgZCwgeCwgcywgdCkgewoJICByZXR1cm4gbWQ1Y21uKGIgJiBjIHwgfmIgJiBkLCBhLCBiLCB4LCBzLCB0KTsKCX0KCglmdW5jdGlvbiBtZDVnZyhhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CgkgIHJldHVybiBtZDVjbW4oYiAmIGQgfCBjICYgfmQsIGEsIGIsIHgsIHMsIHQpOwoJfQoKCWZ1bmN0aW9uIG1kNWhoKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKCSAgcmV0dXJuIG1kNWNtbihiIF4gYyBeIGQsIGEsIGIsIHgsIHMsIHQpOwoJfQoKCWZ1bmN0aW9uIG1kNWlpKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKCSAgcmV0dXJuIG1kNWNtbihjIF4gKGIgfCB+ZCksIGEsIGIsIHgsIHMsIHQpOwoJfQoKCXZhciB2MyA9IHYzNSgndjMnLCAweDMwLCBtZDUpOwoKCWZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CgkgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICB2YXIgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBybmcpKCk7IC8vIFBlciA0LjQsIHNldCBiaXRzIGZvciB2ZXJzaW9uIGFuZCBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAKCgkgIHJuZHNbNl0gPSBybmRzWzZdICYgMHgwZiB8IDB4NDA7CgkgIHJuZHNbOF0gPSBybmRzWzhdICYgMHgzZiB8IDB4ODA7IC8vIENvcHkgYnl0ZXMgdG8gYnVmZmVyLCBpZiBwcm92aWRlZAoKCSAgaWYgKGJ1ZikgewoJICAgIG9mZnNldCA9IG9mZnNldCB8fCAwOwoKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IDE2OyArK2kpIHsKCSAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9IHJuZHNbaV07CgkgICAgfQoKCSAgICByZXR1cm4gYnVmOwoJICB9CgoJICByZXR1cm4gc3RyaW5naWZ5KHJuZHMpOwoJfQoKCS8vIEFkYXB0ZWQgZnJvbSBDaHJpcyBWZW5lc3MnIFNIQTEgY29kZSBhdAoJLy8gaHR0cDovL3d3dy5tb3ZhYmxlLXR5cGUuY28udWsvc2NyaXB0cy9zaGExLmh0bWwKCWZ1bmN0aW9uIGYocywgeCwgeSwgeikgewoJICBzd2l0Y2ggKHMpIHsKCSAgICBjYXNlIDA6CgkgICAgICByZXR1cm4geCAmIHkgXiB+eCAmIHo7CgoJICAgIGNhc2UgMToKCSAgICAgIHJldHVybiB4IF4geSBeIHo7CgoJICAgIGNhc2UgMjoKCSAgICAgIHJldHVybiB4ICYgeSBeIHggJiB6IF4geSAmIHo7CgoJICAgIGNhc2UgMzoKCSAgICAgIHJldHVybiB4IF4geSBeIHo7CgkgIH0KCX0KCglmdW5jdGlvbiBST1RMKHgsIG4pIHsKCSAgcmV0dXJuIHggPDwgbiB8IHggPj4+IDMyIC0gbjsKCX0KCglmdW5jdGlvbiBzaGExKGJ5dGVzKSB7CgkgIHZhciBLID0gWzB4NWE4Mjc5OTksIDB4NmVkOWViYTEsIDB4OGYxYmJjZGMsIDB4Y2E2MmMxZDZdOwoJICB2YXIgSCA9IFsweDY3NDUyMzAxLCAweGVmY2RhYjg5LCAweDk4YmFkY2ZlLCAweDEwMzI1NDc2LCAweGMzZDJlMWYwXTsKCgkgIGlmICh0eXBlb2YgYnl0ZXMgPT09ICdzdHJpbmcnKSB7CgkgICAgdmFyIG1zZyA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChieXRlcykpOyAvLyBVVEY4IGVzY2FwZQoKCSAgICBieXRlcyA9IFtdOwoKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1zZy5sZW5ndGg7ICsraSkgewoJICAgICAgYnl0ZXMucHVzaChtc2cuY2hhckNvZGVBdChpKSk7CgkgICAgfQoJICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KGJ5dGVzKSkgewoJICAgIC8vIENvbnZlcnQgQXJyYXktbGlrZSB0byBBcnJheQoJICAgIGJ5dGVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYnl0ZXMpOwoJICB9CgoJICBieXRlcy5wdXNoKDB4ODApOwoJICB2YXIgbCA9IGJ5dGVzLmxlbmd0aCAvIDQgKyAyOwoJICB2YXIgTiA9IE1hdGguY2VpbChsIC8gMTYpOwoJICB2YXIgTSA9IG5ldyBBcnJheShOKTsKCgkgIGZvciAodmFyIF9pID0gMDsgX2kgPCBOOyArK19pKSB7CgkgICAgdmFyIGFyciA9IG5ldyBVaW50MzJBcnJheSgxNik7CgoJICAgIGZvciAodmFyIGogPSAwOyBqIDwgMTY7ICsraikgewoJICAgICAgYXJyW2pdID0gYnl0ZXNbX2kgKiA2NCArIGogKiA0XSA8PCAyNCB8IGJ5dGVzW19pICogNjQgKyBqICogNCArIDFdIDw8IDE2IHwgYnl0ZXNbX2kgKiA2NCArIGogKiA0ICsgMl0gPDwgOCB8IGJ5dGVzW19pICogNjQgKyBqICogNCArIDNdOwoJICAgIH0KCgkgICAgTVtfaV0gPSBhcnI7CgkgIH0KCgkgIE1bTiAtIDFdWzE0XSA9IChieXRlcy5sZW5ndGggLSAxKSAqIDggLyBNYXRoLnBvdygyLCAzMik7CgkgIE1bTiAtIDFdWzE0XSA9IE1hdGguZmxvb3IoTVtOIC0gMV1bMTRdKTsKCSAgTVtOIC0gMV1bMTVdID0gKGJ5dGVzLmxlbmd0aCAtIDEpICogOCAmIDB4ZmZmZmZmZmY7CgoJICBmb3IgKHZhciBfaTIgPSAwOyBfaTIgPCBOOyArK19pMikgewoJICAgIHZhciBXID0gbmV3IFVpbnQzMkFycmF5KDgwKTsKCgkgICAgZm9yICh2YXIgdCA9IDA7IHQgPCAxNjsgKyt0KSB7CgkgICAgICBXW3RdID0gTVtfaTJdW3RdOwoJICAgIH0KCgkgICAgZm9yICh2YXIgX3QgPSAxNjsgX3QgPCA4MDsgKytfdCkgewoJICAgICAgV1tfdF0gPSBST1RMKFdbX3QgLSAzXSBeIFdbX3QgLSA4XSBeIFdbX3QgLSAxNF0gXiBXW190IC0gMTZdLCAxKTsKCSAgICB9CgoJICAgIHZhciBhID0gSFswXTsKCSAgICB2YXIgYiA9IEhbMV07CgkgICAgdmFyIGMgPSBIWzJdOwoJICAgIHZhciBkID0gSFszXTsKCSAgICB2YXIgZSA9IEhbNF07CgoJICAgIGZvciAodmFyIF90MiA9IDA7IF90MiA8IDgwOyArK190MikgewoJICAgICAgdmFyIHMgPSBNYXRoLmZsb29yKF90MiAvIDIwKTsKCSAgICAgIHZhciBUID0gUk9UTChhLCA1KSArIGYocywgYiwgYywgZCkgKyBlICsgS1tzXSArIFdbX3QyXSA+Pj4gMDsKCSAgICAgIGUgPSBkOwoJICAgICAgZCA9IGM7CgkgICAgICBjID0gUk9UTChiLCAzMCkgPj4+IDA7CgkgICAgICBiID0gYTsKCSAgICAgIGEgPSBUOwoJICAgIH0KCgkgICAgSFswXSA9IEhbMF0gKyBhID4+PiAwOwoJICAgIEhbMV0gPSBIWzFdICsgYiA+Pj4gMDsKCSAgICBIWzJdID0gSFsyXSArIGMgPj4+IDA7CgkgICAgSFszXSA9IEhbM10gKyBkID4+PiAwOwoJICAgIEhbNF0gPSBIWzRdICsgZSA+Pj4gMDsKCSAgfQoKCSAgcmV0dXJuIFtIWzBdID4+IDI0ICYgMHhmZiwgSFswXSA+PiAxNiAmIDB4ZmYsIEhbMF0gPj4gOCAmIDB4ZmYsIEhbMF0gJiAweGZmLCBIWzFdID4+IDI0ICYgMHhmZiwgSFsxXSA+PiAxNiAmIDB4ZmYsIEhbMV0gPj4gOCAmIDB4ZmYsIEhbMV0gJiAweGZmLCBIWzJdID4+IDI0ICYgMHhmZiwgSFsyXSA+PiAxNiAmIDB4ZmYsIEhbMl0gPj4gOCAmIDB4ZmYsIEhbMl0gJiAweGZmLCBIWzNdID4+IDI0ICYgMHhmZiwgSFszXSA+PiAxNiAmIDB4ZmYsIEhbM10gPj4gOCAmIDB4ZmYsIEhbM10gJiAweGZmLCBIWzRdID4+IDI0ICYgMHhmZiwgSFs0XSA+PiAxNiAmIDB4ZmYsIEhbNF0gPj4gOCAmIDB4ZmYsIEhbNF0gJiAweGZmXTsKCX0KCgl2YXIgdjUgPSB2MzUoJ3Y1JywgMHg1MCwgc2hhMSk7CgoJdmFyIG5pbCA9ICcwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDAnOwoKCWZ1bmN0aW9uIHZlcnNpb24odXVpZCkgewoJICBpZiAoIXZhbGlkYXRlKHV1aWQpKSB7CgkgICAgdGhyb3cgVHlwZUVycm9yKCdJbnZhbGlkIFVVSUQnKTsKCSAgfQoKCSAgcmV0dXJuIHBhcnNlSW50KHV1aWQuc3Vic3RyKDE0LCAxKSwgMTYpOwoJfQoKCXZhciBlc21Ccm93c2VyID0gLyojX19QVVJFX18qL09iamVjdC5mcmVlemUoewoJCV9fcHJvdG9fXzogbnVsbCwKCQlOSUw6IG5pbCwKCQlwYXJzZTogcGFyc2UsCgkJc3RyaW5naWZ5OiBzdHJpbmdpZnksCgkJdjE6IHYxLAoJCXYzOiB2MywKCQl2NDogdjQsCgkJdjU6IHY1LAoJCXZhbGlkYXRlOiB2YWxpZGF0ZSwKCQl2ZXJzaW9uOiB2ZXJzaW9uCgl9KTsKCgl2YXIgcmVxdWlyZSQkMCA9IC8qQF9fUFVSRV9fKi9nZXRBdWdtZW50ZWROYW1lc3BhY2UoZXNtQnJvd3Nlcik7CgoJdmFyIGdlbmVyYXRlUmVxdWVzdF8xOwoJdmFyIGhhc1JlcXVpcmVkR2VuZXJhdGVSZXF1ZXN0OwoKCWZ1bmN0aW9uIHJlcXVpcmVHZW5lcmF0ZVJlcXVlc3QgKCkgewoJCWlmIChoYXNSZXF1aXJlZEdlbmVyYXRlUmVxdWVzdCkgcmV0dXJuIGdlbmVyYXRlUmVxdWVzdF8xOwoJCWhhc1JlcXVpcmVkR2VuZXJhdGVSZXF1ZXN0ID0gMTsKCgkJY29uc3QgdXVpZCA9IHJlcXVpcmUkJDAudjQ7CgoJCS8qKgoJCSAqICBHZW5lcmF0ZXMgYSBKU09OLVJQQyAxLjAgb3IgMi4wIHJlcXVlc3QKCQkgKiAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCBOYW1lIG9mIG1ldGhvZCB0byBjYWxsCgkJICogIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBwYXJhbXMgQXJyYXkgb2YgcGFyYW1ldGVycyBwYXNzZWQgdG8gdGhlIG1ldGhvZCBhcyBzcGVjaWZpZWQsIG9yIGFuIG9iamVjdCBvZiBwYXJhbWV0ZXIgbmFtZXMgYW5kIGNvcnJlc3BvbmRpbmcgdmFsdWUKCQkgKiAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfG51bGx9IFtpZF0gUmVxdWVzdCBJRCBjYW4gYmUgYSBzdHJpbmcsIG51bWJlciwgbnVsbCBmb3IgZXhwbGljaXQgbm90aWZpY2F0aW9uIG9yIGxlZnQgb3V0IGZvciBhdXRvbWF0aWMgZ2VuZXJhdGlvbgoJCSAqICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdCgkJICogIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy52ZXJzaW9uPTJdIEpTT04tUlBDIHZlcnNpb24gdG8gdXNlICgxIG9yIDIpCgkJICogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMubm90aWZpY2F0aW9uSWROdWxsPWZhbHNlXSBXaGVuIHRydWUsIHZlcnNpb24gMiByZXF1ZXN0cyB3aWxsIHNldCBpZCB0byBudWxsIGluc3RlYWQgb2Ygb21pdHRpbmcgaXQKCQkgKiAgQHBhcmFtIHtGdW5jdGlvbn0gW29wdGlvbnMuZ2VuZXJhdG9yXSBQYXNzZWQgdGhlIHJlcXVlc3QsIGFuZCB0aGUgb3B0aW9ucyBvYmplY3QgYW5kIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHJlcXVlc3QgSUQKCQkgKiAgQHRocm93cyB7VHlwZUVycm9yfSBJZiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIGludmFsaWQKCQkgKiAgQHJldHVybiB7T2JqZWN0fSBBIEpTT04tUlBDIDEuMCBvciAyLjAgcmVxdWVzdAoJCSAqICBAbWVtYmVyT2YgVXRpbHMKCQkgKi8KCQljb25zdCBnZW5lcmF0ZVJlcXVlc3QgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgaWQsIG9wdGlvbnMpIHsKCQkgIGlmKHR5cGVvZiBtZXRob2QgIT09ICdzdHJpbmcnKSB7CgkJICAgIHRocm93IG5ldyBUeXBlRXJyb3IobWV0aG9kICsgJyBtdXN0IGJlIGEgc3RyaW5nJyk7CgkJICB9CgoJCSAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgoJCSAgLy8gY2hlY2sgdmFsaWQgdmVyc2lvbiBwcm92aWRlZAoJCSAgY29uc3QgdmVyc2lvbiA9IHR5cGVvZiBvcHRpb25zLnZlcnNpb24gPT09ICdudW1iZXInID8gb3B0aW9ucy52ZXJzaW9uIDogMjsKCQkgIGlmICh2ZXJzaW9uICE9PSAxICYmIHZlcnNpb24gIT09IDIpIHsKCQkgICAgdGhyb3cgbmV3IFR5cGVFcnJvcih2ZXJzaW9uICsgJyBtdXN0IGJlIDEgb3IgMicpOwoJCSAgfQoKCQkgIGNvbnN0IHJlcXVlc3QgPSB7CgkJICAgIG1ldGhvZDogbWV0aG9kCgkJICB9OwoKCQkgIGlmKHZlcnNpb24gPT09IDIpIHsKCQkgICAgcmVxdWVzdC5qc29ucnBjID0gJzIuMCc7CgkJICB9CgoJCSAgaWYocGFyYW1zKSB7CgkJICAgIC8vIHBhcmFtcyBnaXZlbiwgYnV0IGludmFsaWQ/CgkJICAgIGlmKHR5cGVvZiBwYXJhbXMgIT09ICdvYmplY3QnICYmICFBcnJheS5pc0FycmF5KHBhcmFtcykpIHsKCQkgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKHBhcmFtcyArICcgbXVzdCBiZSBhbiBvYmplY3QsIGFycmF5IG9yIG9taXR0ZWQnKTsKCQkgICAgfQoJCSAgICByZXF1ZXN0LnBhcmFtcyA9IHBhcmFtczsKCQkgIH0KCgkJICAvLyBpZiBpZCB3YXMgbGVmdCBvdXQsIGdlbmVyYXRlIG9uZSAobnVsbCBtZWFucyBleHBsaWNpdCBub3RpZmljYXRpb24pCgkJICBpZih0eXBlb2YoaWQpID09PSAndW5kZWZpbmVkJykgewoJCSAgICBjb25zdCBnZW5lcmF0b3IgPSB0eXBlb2Ygb3B0aW9ucy5nZW5lcmF0b3IgPT09ICdmdW5jdGlvbicgPyBvcHRpb25zLmdlbmVyYXRvciA6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdXVpZCgpOyB9OwoJCSAgICByZXF1ZXN0LmlkID0gZ2VuZXJhdG9yKHJlcXVlc3QsIG9wdGlvbnMpOwoJCSAgfSBlbHNlIGlmICh2ZXJzaW9uID09PSAyICYmIGlkID09PSBudWxsKSB7CgkJICAgIC8vIHdlIGhhdmUgYSB2ZXJzaW9uIDIgbm90aWZpY2F0aW9uCgkJICAgIGlmIChvcHRpb25zLm5vdGlmaWNhdGlvbklkTnVsbCkgewoJCSAgICAgIHJlcXVlc3QuaWQgPSBudWxsOyAvLyBpZCB3aWxsIG5vdCBiZSBzZXQgYXQgYWxsIHVubGVzcyBvcHRpb24gcHJvdmlkZWQKCQkgICAgfQoJCSAgfSBlbHNlIHsKCQkgICAgcmVxdWVzdC5pZCA9IGlkOwoJCSAgfQoKCQkgIHJldHVybiByZXF1ZXN0OwoJCX07CgoJCWdlbmVyYXRlUmVxdWVzdF8xID0gZ2VuZXJhdGVSZXF1ZXN0OwoJCXJldHVybiBnZW5lcmF0ZVJlcXVlc3RfMTsKCX0KCgl2YXIgYnJvd3NlcjsKCXZhciBoYXNSZXF1aXJlZEJyb3dzZXI7CgoJZnVuY3Rpb24gcmVxdWlyZUJyb3dzZXIgKCkgewoJCWlmIChoYXNSZXF1aXJlZEJyb3dzZXIpIHJldHVybiBicm93c2VyOwoJCWhhc1JlcXVpcmVkQnJvd3NlciA9IDE7CgoJCWNvbnN0IHV1aWQgPSByZXF1aXJlJCQwLnY0OwoJCWNvbnN0IGdlbmVyYXRlUmVxdWVzdCA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUdlbmVyYXRlUmVxdWVzdCgpOwoKCQkvKioKCQkgKiBDb25zdHJ1Y3RvciBmb3IgYSBKYXlzb24gQnJvd3NlciBDbGllbnQgdGhhdCBkb2VzIG5vdCBkZXBlbmQgYW55IG5vZGUuanMgY29yZSBsaWJyYXJpZXMKCQkgKiBAY2xhc3MgQ2xpZW50QnJvd3NlcgoJCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxTZXJ2ZXIgTWV0aG9kIHRoYXQgY2FsbHMgdGhlIHNlcnZlciwgcmVjZWl2ZXMgdGhlIHN0cmluZ2lmaWVkIHJlcXVlc3QgYW5kIGEgcmVndWxhciBub2RlLXN0eWxlIGNhbGxiYWNrCgkJICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXQoJCSAqIEBwYXJhbSB7RnVuY3Rpb259IFtvcHRpb25zLnJldml2ZXJdIFJldml2ZXIgZnVuY3Rpb24gZm9yIEpTT04KCQkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbb3B0aW9ucy5yZXBsYWNlcl0gUmVwbGFjZXIgZnVuY3Rpb24gZm9yIEpTT04KCQkgKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMudmVyc2lvbj0yXSBKU09OLVJQQyB2ZXJzaW9uIHRvIHVzZSAoMXwyKQoJCSAqIEBwYXJhbSB7RnVuY3Rpb259IFtvcHRpb25zLmdlbmVyYXRvcl0gRnVuY3Rpb24gdG8gdXNlIGZvciBnZW5lcmF0aW5nIHJlcXVlc3QgSURzCgkJICogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMubm90aWZpY2F0aW9uSWROdWxsPWZhbHNlXSBXaGVuIHRydWUsIHZlcnNpb24gMiByZXF1ZXN0cyB3aWxsIHNldCBpZCB0byBudWxsIGluc3RlYWQgb2Ygb21pdHRpbmcgaXQKCQkgKiBAcmV0dXJuIHtDbGllbnRCcm93c2VyfQoJCSAqLwoJCWNvbnN0IENsaWVudEJyb3dzZXIgPSBmdW5jdGlvbihjYWxsU2VydmVyLCBvcHRpb25zKSB7CgkJICBpZighKHRoaXMgaW5zdGFuY2VvZiBDbGllbnRCcm93c2VyKSkgewoJCSAgICByZXR1cm4gbmV3IENsaWVudEJyb3dzZXIoY2FsbFNlcnZlciwgb3B0aW9ucyk7CgkJICB9CgoJCSAgaWYgKCFvcHRpb25zKSB7CgkJICAgIG9wdGlvbnMgPSB7fTsKCQkgIH0KCgkJICB0aGlzLm9wdGlvbnMgPSB7CgkJICAgIHJldml2ZXI6IHR5cGVvZiBvcHRpb25zLnJldml2ZXIgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5yZXZpdmVyIDogbnVsbCwKCQkgICAgcmVwbGFjZXI6IHR5cGVvZiBvcHRpb25zLnJlcGxhY2VyICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMucmVwbGFjZXIgOiBudWxsLAoJCSAgICBnZW5lcmF0b3I6IHR5cGVvZiBvcHRpb25zLmdlbmVyYXRvciAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmdlbmVyYXRvciA6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdXVpZCgpOyB9LAoJCSAgICB2ZXJzaW9uOiB0eXBlb2Ygb3B0aW9ucy52ZXJzaW9uICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMudmVyc2lvbiA6IDIsCgkJICAgIG5vdGlmaWNhdGlvbklkTnVsbDogdHlwZW9mIG9wdGlvbnMubm90aWZpY2F0aW9uSWROdWxsID09PSAnYm9vbGVhbicgPyBvcHRpb25zLm5vdGlmaWNhdGlvbklkTnVsbCA6IGZhbHNlLAoJCSAgfTsKCgkJICB0aGlzLmNhbGxTZXJ2ZXIgPSBjYWxsU2VydmVyOwoJCX07CgoJCWJyb3dzZXIgPSBDbGllbnRCcm93c2VyOwoKCQkvKioKCQkgKiAgQ3JlYXRlcyBhIHJlcXVlc3QgYW5kIGRpc3BhdGNoZXMgaXQgaWYgZ2l2ZW4gYSBjYWxsYmFjay4KCQkgKiAgQHBhcmFtIHtTdHJpbmd8QXJyYXl9IG1ldGhvZCBBIGJhdGNoIHJlcXVlc3QgaWYgcGFzc2VkIGFuIEFycmF5LCBvciBhIG1ldGhvZCBuYW1lIGlmIHBhc3NlZCBhIFN0cmluZwoJCSAqICBAcGFyYW0ge0FycmF5fE9iamVjdH0gW3BhcmFtc10gUGFyYW1ldGVycyBmb3IgdGhlIG1ldGhvZAoJCSAqICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IFtpZF0gT3B0aW9uYWwgaWQuIElmIHVuZGVmaW5lZCBhbiBpZCB3aWxsIGJlIGdlbmVyYXRlZC4gSWYgbnVsbCBpdCBjcmVhdGVzIGEgbm90aWZpY2F0aW9uIHJlcXVlc3QKCQkgKiAgQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBSZXF1ZXN0IGNhbGxiYWNrLiBJZiBzcGVjaWZpZWQsIGV4ZWN1dGVzIHRoZSByZXF1ZXN0IHJhdGhlciB0aGFuIG9ubHkgcmV0dXJuaW5nIGl0LgoJCSAqICBAdGhyb3dzIHtUeXBlRXJyb3J9IEludmFsaWQgcGFyYW1ldGVycwoJCSAqICBAcmV0dXJuIHtPYmplY3R9IEpTT04tUlBDIDEuMCBvciAyLjAgY29tcGF0aWJsZSByZXF1ZXN0CgkJICovCgkJQ2xpZW50QnJvd3Nlci5wcm90b3R5cGUucmVxdWVzdCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBpZCwgY2FsbGJhY2spIHsKCQkgIGNvbnN0IHNlbGYgPSB0aGlzOwoJCSAgbGV0IHJlcXVlc3QgPSBudWxsOwoKCQkgIC8vIGlzIHRoaXMgYSBiYXRjaCByZXF1ZXN0PwoJCSAgY29uc3QgaXNCYXRjaCA9IEFycmF5LmlzQXJyYXkobWV0aG9kKSAmJiB0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nOwoKCQkgIGlmICh0aGlzLm9wdGlvbnMudmVyc2lvbiA9PT0gMSAmJiBpc0JhdGNoKSB7CgkJICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0pTT04tUlBDIDEuMCBkb2VzIG5vdCBzdXBwb3J0IGJhdGNoaW5nJyk7CgkJICB9CgoJCSAgLy8gaXMgdGhpcyBhIHJhdyByZXF1ZXN0PwoJCSAgY29uc3QgaXNSYXcgPSAhaXNCYXRjaCAmJiBtZXRob2QgJiYgdHlwZW9mIG1ldGhvZCA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJzsKCgkJICBpZihpc0JhdGNoIHx8IGlzUmF3KSB7CgkJICAgIGNhbGxiYWNrID0gcGFyYW1zOwoJCSAgICByZXF1ZXN0ID0gbWV0aG9kOwoJCSAgfSBlbHNlIHsKCQkgICAgaWYodHlwZW9mIGlkID09PSAnZnVuY3Rpb24nKSB7CgkJICAgICAgY2FsbGJhY2sgPSBpZDsKCQkgICAgICAvLyBzcGVjaWZpY2FsbHkgdW5kZWZpbmVkIGJlY2F1c2UgIm51bGwiIGlzIGEgbm90aWZpY2F0aW9uIHJlcXVlc3QKCQkgICAgICBpZCA9IHVuZGVmaW5lZDsKCQkgICAgfQoKCQkgICAgY29uc3QgaGFzQ2FsbGJhY2sgPSB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbic7CgoJCSAgICB0cnkgewoJCSAgICAgIHJlcXVlc3QgPSBnZW5lcmF0ZVJlcXVlc3QobWV0aG9kLCBwYXJhbXMsIGlkLCB7CgkJICAgICAgICBnZW5lcmF0b3I6IHRoaXMub3B0aW9ucy5nZW5lcmF0b3IsCgkJICAgICAgICB2ZXJzaW9uOiB0aGlzLm9wdGlvbnMudmVyc2lvbiwKCQkgICAgICAgIG5vdGlmaWNhdGlvbklkTnVsbDogdGhpcy5vcHRpb25zLm5vdGlmaWNhdGlvbklkTnVsbCwKCQkgICAgICB9KTsKCQkgICAgfSBjYXRjaChlcnIpIHsKCQkgICAgICBpZihoYXNDYWxsYmFjaykgewoJCSAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CgkJICAgICAgfQoJCSAgICAgIHRocm93IGVycjsKCQkgICAgfQoKCQkgICAgLy8gbm8gY2FsbGJhY2sgbWVhbnMgd2Ugc2hvdWxkIGp1c3QgcmV0dXJuIGEgcmF3IHJlcXVlc3QKCQkgICAgaWYoIWhhc0NhbGxiYWNrKSB7CgkJICAgICAgcmV0dXJuIHJlcXVlc3Q7CgkJICAgIH0KCgkJICB9CgoJCSAgbGV0IG1lc3NhZ2U7CgkJICB0cnkgewoJCSAgICBtZXNzYWdlID0gSlNPTi5zdHJpbmdpZnkocmVxdWVzdCwgdGhpcy5vcHRpb25zLnJlcGxhY2VyKTsKCQkgIH0gY2F0Y2goZXJyKSB7CgkJICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwoJCSAgfQoKCQkgIHRoaXMuY2FsbFNlcnZlcihtZXNzYWdlLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7CgkJICAgIHNlbGYuX3BhcnNlUmVzcG9uc2UoZXJyLCByZXNwb25zZSwgY2FsbGJhY2spOwoJCSAgfSk7CgoJCSAgLy8gYWx3YXlzIHJldHVybiB0aGUgcmF3IHJlcXVlc3QKCQkgIHJldHVybiByZXF1ZXN0OwoJCX07CgoJCS8qKgoJCSAqIFBhcnNlcyBhIHJlc3BvbnNlIGZyb20gYSBzZXJ2ZXIKCQkgKiBAcGFyYW0ge09iamVjdH0gZXJyIEVycm9yIHRvIHBhc3Mgb24gdGhhdCBpcyB1bnJlbGF0ZWQgdG8gdGhlIGFjdHVhbCByZXNwb25zZQoJCSAqIEBwYXJhbSB7U3RyaW5nfSByZXNwb25zZVRleHQgSlNPTi1SUEMgMS4wIG9yIDIuMCByZXNwb25zZQoJCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIENhbGxiYWNrIHRoYXQgd2lsbCByZWNlaXZlIGRpZmZlcmVudCBhcmd1bWVudHMgZGVwZW5kaW5nIG9uIHRoZSBhbW91bnQgb2YgcGFyYW1ldGVycwoJCSAqIEBwcml2YXRlCgkJICovCgkJQ2xpZW50QnJvd3Nlci5wcm90b3R5cGUuX3BhcnNlUmVzcG9uc2UgPSBmdW5jdGlvbihlcnIsIHJlc3BvbnNlVGV4dCwgY2FsbGJhY2spIHsKCQkgIGlmKGVycikgewoJCSAgICBjYWxsYmFjayhlcnIpOwoJCSAgICByZXR1cm47CgkJICB9CgoJCSAgaWYoIXJlc3BvbnNlVGV4dCkgewoJCSAgICAvLyBlbXB0eSByZXNwb25zZSB0ZXh0LCBhc3N1bWUgdGhhdCBpcyBjb3JyZWN0IGJlY2F1c2UgaXQgY291bGQgYmUgYQoJCSAgICAvLyBub3RpZmljYXRpb24gd2hpY2ggamF5c29uIGRvZXMgbm90IGdpdmUgYW55IGJvZHkgZm9yCgkJICAgIHJldHVybiBjYWxsYmFjaygpOwoJCSAgfQoKCQkgIGxldCByZXNwb25zZTsKCQkgIHRyeSB7CgkJICAgIHJlc3BvbnNlID0gSlNPTi5wYXJzZShyZXNwb25zZVRleHQsIHRoaXMub3B0aW9ucy5yZXZpdmVyKTsKCQkgIH0gY2F0Y2goZXJyKSB7CgkJICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwoJCSAgfQoKCQkgIGlmKGNhbGxiYWNrLmxlbmd0aCA9PT0gMykgewoJCSAgICAvLyBpZiBjYWxsYmFjayBsZW5ndGggaXMgMywgd2Ugc3BsaXQgY2FsbGJhY2sgYXJndW1lbnRzIG9uIGVycm9yIGFuZCByZXNwb25zZQoKCQkgICAgLy8gaXMgYmF0Y2ggcmVzcG9uc2U/CgkJICAgIGlmKEFycmF5LmlzQXJyYXkocmVzcG9uc2UpKSB7CgoJCSAgICAgIC8vIG5lY2Nlc2FyeSB0byBzcGxpdCBzdHJpY3RseSBvbiB2YWxpZGl0eSBhY2NvcmRpbmcgdG8gc3BlYyBoZXJlCgkJICAgICAgY29uc3QgaXNFcnJvciA9IGZ1bmN0aW9uKHJlcykgewoJCSAgICAgICAgcmV0dXJuIHR5cGVvZiByZXMuZXJyb3IgIT09ICd1bmRlZmluZWQnOwoJCSAgICAgIH07CgoJCSAgICAgIGNvbnN0IGlzTm90RXJyb3IgPSBmdW5jdGlvbiAocmVzKSB7CgkJICAgICAgICByZXR1cm4gIWlzRXJyb3IocmVzKTsKCQkgICAgICB9OwoKCQkgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgcmVzcG9uc2UuZmlsdGVyKGlzRXJyb3IpLCByZXNwb25zZS5maWx0ZXIoaXNOb3RFcnJvcikpOwoJCSAgICAKCQkgICAgfSBlbHNlIHsKCgkJICAgICAgLy8gc3BsaXQgcmVnYXJkbGVzcyBvZiB2YWxpZGl0eQoJCSAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCByZXNwb25zZS5lcnJvciwgcmVzcG9uc2UucmVzdWx0KTsKCQkgICAgCgkJICAgIH0KCQkgIAoJCSAgfQoKCQkgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTsKCQl9OwoJCXJldHVybiBicm93c2VyOwoJfQoKCXZhciBicm93c2VyRXhwb3J0cyA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUJyb3dzZXIoKTsKCXZhciBScGNDbGllbnQgPSAvKkBfX1BVUkVfXyovZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMoYnJvd3NlckV4cG9ydHMpOwoKCWNvbnN0IE1JTklNVU1fU0xPVF9QRVJfRVBPQ0ggPSAzMjsKCgkvLyBSZXR1cm5zIHRoZSBudW1iZXIgb2YgdHJhaWxpbmcgemVyb3MgaW4gdGhlIGJpbmFyeSByZXByZXNlbnRhdGlvbiBvZiBzZWxmLgoJZnVuY3Rpb24gdHJhaWxpbmdaZXJvcyhuKSB7CgkgIGxldCB0cmFpbGluZ1plcm9zID0gMDsKCSAgd2hpbGUgKG4gPiAxKSB7CgkgICAgbiAvPSAyOwoJICAgIHRyYWlsaW5nWmVyb3MrKzsKCSAgfQoJICByZXR1cm4gdHJhaWxpbmdaZXJvczsKCX0KCgkvLyBSZXR1cm5zIHRoZSBzbWFsbGVzdCBwb3dlciBvZiB0d28gZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIG4KCWZ1bmN0aW9uIG5leHRQb3dlck9mVHdvKG4pIHsKCSAgaWYgKG4gPT09IDApIHJldHVybiAxOwoJICBuLS07CgkgIG4gfD0gbiA+PiAxOwoJICBuIHw9IG4gPj4gMjsKCSAgbiB8PSBuID4+IDQ7CgkgIG4gfD0gbiA+PiA4OwoJICBuIHw9IG4gPj4gMTY7CgkgIG4gfD0gbiA+PiAzMjsKCSAgcmV0dXJuIG4gKyAxOwoJfQoKCS8qKgoJICogRXBvY2ggc2NoZWR1bGUKCSAqIChzZWUgaHR0cHM6Ly9kb2NzLnNvbGFuYS5jb20vdGVybWlub2xvZ3kjZXBvY2gpCgkgKiBDYW4gYmUgcmV0cmlldmVkIHdpdGggdGhlIHtAbGluayBDb25uZWN0aW9uLmdldEVwb2NoU2NoZWR1bGV9IG1ldGhvZAoJICovCgljbGFzcyBFcG9jaFNjaGVkdWxlIHsKCSAgY29uc3RydWN0b3Ioc2xvdHNQZXJFcG9jaCwgbGVhZGVyU2NoZWR1bGVTbG90T2Zmc2V0LCB3YXJtdXAsIGZpcnN0Tm9ybWFsRXBvY2gsIGZpcnN0Tm9ybWFsU2xvdCkgewoJICAgIC8qKiBUaGUgbWF4aW11bSBudW1iZXIgb2Ygc2xvdHMgaW4gZWFjaCBlcG9jaCAqLwoJICAgIHRoaXMuc2xvdHNQZXJFcG9jaCA9IHZvaWQgMDsKCSAgICAvKiogVGhlIG51bWJlciBvZiBzbG90cyBiZWZvcmUgYmVnaW5uaW5nIG9mIGFuIGVwb2NoIHRvIGNhbGN1bGF0ZSBhIGxlYWRlciBzY2hlZHVsZSBmb3IgdGhhdCBlcG9jaCAqLwoJICAgIHRoaXMubGVhZGVyU2NoZWR1bGVTbG90T2Zmc2V0ID0gdm9pZCAwOwoJICAgIC8qKiBJbmRpY2F0ZXMgd2hldGhlciBlcG9jaHMgc3RhcnQgc2hvcnQgYW5kIGdyb3cgKi8KCSAgICB0aGlzLndhcm11cCA9IHZvaWQgMDsKCSAgICAvKiogVGhlIGZpcnN0IGVwb2NoIHdpdGggYHNsb3RzUGVyRXBvY2hgIHNsb3RzICovCgkgICAgdGhpcy5maXJzdE5vcm1hbEVwb2NoID0gdm9pZCAwOwoJICAgIC8qKiBUaGUgZmlyc3Qgc2xvdCBvZiBgZmlyc3ROb3JtYWxFcG9jaGAgKi8KCSAgICB0aGlzLmZpcnN0Tm9ybWFsU2xvdCA9IHZvaWQgMDsKCSAgICB0aGlzLnNsb3RzUGVyRXBvY2ggPSBzbG90c1BlckVwb2NoOwoJICAgIHRoaXMubGVhZGVyU2NoZWR1bGVTbG90T2Zmc2V0ID0gbGVhZGVyU2NoZWR1bGVTbG90T2Zmc2V0OwoJICAgIHRoaXMud2FybXVwID0gd2FybXVwOwoJICAgIHRoaXMuZmlyc3ROb3JtYWxFcG9jaCA9IGZpcnN0Tm9ybWFsRXBvY2g7CgkgICAgdGhpcy5maXJzdE5vcm1hbFNsb3QgPSBmaXJzdE5vcm1hbFNsb3Q7CgkgIH0KCSAgZ2V0RXBvY2goc2xvdCkgewoJICAgIHJldHVybiB0aGlzLmdldEVwb2NoQW5kU2xvdEluZGV4KHNsb3QpWzBdOwoJICB9CgkgIGdldEVwb2NoQW5kU2xvdEluZGV4KHNsb3QpIHsKCSAgICBpZiAoc2xvdCA8IHRoaXMuZmlyc3ROb3JtYWxTbG90KSB7CgkgICAgICBjb25zdCBlcG9jaCA9IHRyYWlsaW5nWmVyb3MobmV4dFBvd2VyT2ZUd28oc2xvdCArIE1JTklNVU1fU0xPVF9QRVJfRVBPQ0ggKyAxKSkgLSB0cmFpbGluZ1plcm9zKE1JTklNVU1fU0xPVF9QRVJfRVBPQ0gpIC0gMTsKCSAgICAgIGNvbnN0IGVwb2NoTGVuID0gdGhpcy5nZXRTbG90c0luRXBvY2goZXBvY2gpOwoJICAgICAgY29uc3Qgc2xvdEluZGV4ID0gc2xvdCAtIChlcG9jaExlbiAtIE1JTklNVU1fU0xPVF9QRVJfRVBPQ0gpOwoJICAgICAgcmV0dXJuIFtlcG9jaCwgc2xvdEluZGV4XTsKCSAgICB9IGVsc2UgewoJICAgICAgY29uc3Qgbm9ybWFsU2xvdEluZGV4ID0gc2xvdCAtIHRoaXMuZmlyc3ROb3JtYWxTbG90OwoJICAgICAgY29uc3Qgbm9ybWFsRXBvY2hJbmRleCA9IE1hdGguZmxvb3Iobm9ybWFsU2xvdEluZGV4IC8gdGhpcy5zbG90c1BlckVwb2NoKTsKCSAgICAgIGNvbnN0IGVwb2NoID0gdGhpcy5maXJzdE5vcm1hbEVwb2NoICsgbm9ybWFsRXBvY2hJbmRleDsKCSAgICAgIGNvbnN0IHNsb3RJbmRleCA9IG5vcm1hbFNsb3RJbmRleCAlIHRoaXMuc2xvdHNQZXJFcG9jaDsKCSAgICAgIHJldHVybiBbZXBvY2gsIHNsb3RJbmRleF07CgkgICAgfQoJICB9CgkgIGdldEZpcnN0U2xvdEluRXBvY2goZXBvY2gpIHsKCSAgICBpZiAoZXBvY2ggPD0gdGhpcy5maXJzdE5vcm1hbEVwb2NoKSB7CgkgICAgICByZXR1cm4gKE1hdGgucG93KDIsIGVwb2NoKSAtIDEpICogTUlOSU1VTV9TTE9UX1BFUl9FUE9DSDsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIChlcG9jaCAtIHRoaXMuZmlyc3ROb3JtYWxFcG9jaCkgKiB0aGlzLnNsb3RzUGVyRXBvY2ggKyB0aGlzLmZpcnN0Tm9ybWFsU2xvdDsKCSAgICB9CgkgIH0KCSAgZ2V0TGFzdFNsb3RJbkVwb2NoKGVwb2NoKSB7CgkgICAgcmV0dXJuIHRoaXMuZ2V0Rmlyc3RTbG90SW5FcG9jaChlcG9jaCkgKyB0aGlzLmdldFNsb3RzSW5FcG9jaChlcG9jaCkgLSAxOwoJICB9CgkgIGdldFNsb3RzSW5FcG9jaChlcG9jaCkgewoJICAgIGlmIChlcG9jaCA8IHRoaXMuZmlyc3ROb3JtYWxFcG9jaCkgewoJICAgICAgcmV0dXJuIE1hdGgucG93KDIsIGVwb2NoICsgdHJhaWxpbmdaZXJvcyhNSU5JTVVNX1NMT1RfUEVSX0VQT0NIKSk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiB0aGlzLnNsb3RzUGVyRXBvY2g7CgkgICAgfQoJICB9Cgl9CgoJdmFyIGZldGNoSW1wbCA9IGdsb2JhbFRoaXMuZmV0Y2g7CgoJdmFyIGV2ZW50ZW1pdHRlcjMgPSB7ZXhwb3J0czoge319OwoKCXZhciBoYXNSZXF1aXJlZEV2ZW50ZW1pdHRlcjM7CgoJZnVuY3Rpb24gcmVxdWlyZUV2ZW50ZW1pdHRlcjMgKCkgewoJCWlmIChoYXNSZXF1aXJlZEV2ZW50ZW1pdHRlcjMpIHJldHVybiBldmVudGVtaXR0ZXIzLmV4cG9ydHM7CgkJaGFzUmVxdWlyZWRFdmVudGVtaXR0ZXIzID0gMTsKCQkoZnVuY3Rpb24gKG1vZHVsZSkgewoKCQkJdmFyIGhhcyA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkKCQkJICAsIHByZWZpeCA9ICd+JzsKCgkJCS8qKgoJCQkgKiBDb25zdHJ1Y3RvciB0byBjcmVhdGUgYSBzdG9yYWdlIGZvciBvdXIgYEVFYCBvYmplY3RzLgoJCQkgKiBBbiBgRXZlbnRzYCBpbnN0YW5jZSBpcyBhIHBsYWluIG9iamVjdCB3aG9zZSBwcm9wZXJ0aWVzIGFyZSBldmVudCBuYW1lcy4KCQkJICoKCQkJICogQGNvbnN0cnVjdG9yCgkJCSAqIEBwcml2YXRlCgkJCSAqLwoJCQlmdW5jdGlvbiBFdmVudHMoKSB7fQoKCQkJLy8KCQkJLy8gV2UgdHJ5IHRvIG5vdCBpbmhlcml0IGZyb20gYE9iamVjdC5wcm90b3R5cGVgLiBJbiBzb21lIGVuZ2luZXMgY3JlYXRpbmcgYW4KCQkJLy8gaW5zdGFuY2UgaW4gdGhpcyB3YXkgaXMgZmFzdGVyIHRoYW4gY2FsbGluZyBgT2JqZWN0LmNyZWF0ZShudWxsKWAgZGlyZWN0bHkuCgkJCS8vIElmIGBPYmplY3QuY3JlYXRlKG51bGwpYCBpcyBub3Qgc3VwcG9ydGVkIHdlIHByZWZpeCB0aGUgZXZlbnQgbmFtZXMgd2l0aCBhCgkJCS8vIGNoYXJhY3RlciB0byBtYWtlIHN1cmUgdGhhdCB0aGUgYnVpbHQtaW4gb2JqZWN0IHByb3BlcnRpZXMgYXJlIG5vdAoJCQkvLyBvdmVycmlkZGVuIG9yIHVzZWQgYXMgYW4gYXR0YWNrIHZlY3Rvci4KCQkJLy8KCQkJaWYgKE9iamVjdC5jcmVhdGUpIHsKCQkJICBFdmVudHMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCgkJCSAgLy8KCQkJICAvLyBUaGlzIGhhY2sgaXMgbmVlZGVkIGJlY2F1c2UgdGhlIGBfX3Byb3RvX19gIHByb3BlcnR5IGlzIHN0aWxsIGluaGVyaXRlZCBpbgoJCQkgIC8vIHNvbWUgb2xkIGJyb3dzZXJzIGxpa2UgQW5kcm9pZCA0LCBpUGhvbmUgNS4xLCBPcGVyYSAxMSBhbmQgU2FmYXJpIDUuCgkJCSAgLy8KCQkJICBpZiAoIW5ldyBFdmVudHMoKS5fX3Byb3RvX18pIHByZWZpeCA9IGZhbHNlOwoJCQl9CgoJCQkvKioKCQkJICogUmVwcmVzZW50YXRpb24gb2YgYSBzaW5nbGUgZXZlbnQgbGlzdGVuZXIuCgkJCSAqCgkJCSAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBsaXN0ZW5lciBmdW5jdGlvbi4KCQkJICogQHBhcmFtIHsqfSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGludm9rZSB0aGUgbGlzdGVuZXIgd2l0aC4KCQkJICogQHBhcmFtIHtCb29sZWFufSBbb25jZT1mYWxzZV0gU3BlY2lmeSBpZiB0aGUgbGlzdGVuZXIgaXMgYSBvbmUtdGltZSBsaXN0ZW5lci4KCQkJICogQGNvbnN0cnVjdG9yCgkJCSAqIEBwcml2YXRlCgkJCSAqLwoJCQlmdW5jdGlvbiBFRShmbiwgY29udGV4dCwgb25jZSkgewoJCQkgIHRoaXMuZm4gPSBmbjsKCQkJICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwoJCQkgIHRoaXMub25jZSA9IG9uY2UgfHwgZmFsc2U7CgkJCX0KCgkJCS8qKgoJCQkgKiBBZGQgYSBsaXN0ZW5lciBmb3IgYSBnaXZlbiBldmVudC4KCQkJICoKCQkJICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IGVtaXR0ZXIgUmVmZXJlbmNlIHRvIHRoZSBgRXZlbnRFbWl0dGVyYCBpbnN0YW5jZS4KCQkJICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLgoJCQkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgbGlzdGVuZXIgZnVuY3Rpb24uCgkJCSAqIEBwYXJhbSB7Kn0gY29udGV4dCBUaGUgY29udGV4dCB0byBpbnZva2UgdGhlIGxpc3RlbmVyIHdpdGguCgkJCSAqIEBwYXJhbSB7Qm9vbGVhbn0gb25jZSBTcGVjaWZ5IGlmIHRoZSBsaXN0ZW5lciBpcyBhIG9uZS10aW1lIGxpc3RlbmVyLgoJCQkgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfQoJCQkgKiBAcHJpdmF0ZQoJCQkgKi8KCQkJZnVuY3Rpb24gYWRkTGlzdGVuZXIoZW1pdHRlciwgZXZlbnQsIGZuLCBjb250ZXh0LCBvbmNlKSB7CgkJCSAgaWYgKHR5cGVvZiBmbiAhPT0gJ2Z1bmN0aW9uJykgewoJCQkgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlIGxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoJCQkgIH0KCgkJCSAgdmFyIGxpc3RlbmVyID0gbmV3IEVFKGZuLCBjb250ZXh0IHx8IGVtaXR0ZXIsIG9uY2UpCgkJCSAgICAsIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CgoJCQkgIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0pIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gbGlzdGVuZXIsIGVtaXR0ZXIuX2V2ZW50c0NvdW50Kys7CgkJCSAgZWxzZSBpZiAoIWVtaXR0ZXIuX2V2ZW50c1tldnRdLmZuKSBlbWl0dGVyLl9ldmVudHNbZXZ0XS5wdXNoKGxpc3RlbmVyKTsKCQkJICBlbHNlIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gW2VtaXR0ZXIuX2V2ZW50c1tldnRdLCBsaXN0ZW5lcl07CgoJCQkgIHJldHVybiBlbWl0dGVyOwoJCQl9CgoJCQkvKioKCQkJICogQ2xlYXIgZXZlbnQgYnkgbmFtZS4KCQkJICoKCQkJICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IGVtaXR0ZXIgUmVmZXJlbmNlIHRvIHRoZSBgRXZlbnRFbWl0dGVyYCBpbnN0YW5jZS4KCQkJICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2dCBUaGUgRXZlbnQgbmFtZS4KCQkJICogQHByaXZhdGUKCQkJICovCgkJCWZ1bmN0aW9uIGNsZWFyRXZlbnQoZW1pdHRlciwgZXZ0KSB7CgkJCSAgaWYgKC0tZW1pdHRlci5fZXZlbnRzQ291bnQgPT09IDApIGVtaXR0ZXIuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTsKCQkJICBlbHNlIGRlbGV0ZSBlbWl0dGVyLl9ldmVudHNbZXZ0XTsKCQkJfQoKCQkJLyoqCgkJCSAqIE1pbmltYWwgYEV2ZW50RW1pdHRlcmAgaW50ZXJmYWNlIHRoYXQgaXMgbW9sZGVkIGFnYWluc3QgdGhlIE5vZGUuanMKCQkJICogYEV2ZW50RW1pdHRlcmAgaW50ZXJmYWNlLgoJCQkgKgoJCQkgKiBAY29uc3RydWN0b3IKCQkJICogQHB1YmxpYwoJCQkgKi8KCQkJZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewoJCQkgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTsKCQkJICB0aGlzLl9ldmVudHNDb3VudCA9IDA7CgkJCX0KCgkJCS8qKgoJCQkgKiBSZXR1cm4gYW4gYXJyYXkgbGlzdGluZyB0aGUgZXZlbnRzIGZvciB3aGljaCB0aGUgZW1pdHRlciBoYXMgcmVnaXN0ZXJlZAoJCQkgKiBsaXN0ZW5lcnMuCgkJCSAqCgkJCSAqIEByZXR1cm5zIHtBcnJheX0KCQkJICogQHB1YmxpYwoJCQkgKi8KCQkJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5ldmVudE5hbWVzID0gZnVuY3Rpb24gZXZlbnROYW1lcygpIHsKCQkJICB2YXIgbmFtZXMgPSBbXQoJCQkgICAgLCBldmVudHMKCQkJICAgICwgbmFtZTsKCgkJCSAgaWYgKHRoaXMuX2V2ZW50c0NvdW50ID09PSAwKSByZXR1cm4gbmFtZXM7CgoJCQkgIGZvciAobmFtZSBpbiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzKSkgewoJCQkgICAgaWYgKGhhcy5jYWxsKGV2ZW50cywgbmFtZSkpIG5hbWVzLnB1c2gocHJlZml4ID8gbmFtZS5zbGljZSgxKSA6IG5hbWUpOwoJCQkgIH0KCgkJCSAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKCQkJICAgIHJldHVybiBuYW1lcy5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhldmVudHMpKTsKCQkJICB9CgoJCQkgIHJldHVybiBuYW1lczsKCQkJfTsKCgkJCS8qKgoJCQkgKiBSZXR1cm4gdGhlIGxpc3RlbmVycyByZWdpc3RlcmVkIGZvciBhIGdpdmVuIGV2ZW50LgoJCQkgKgoJCQkgKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuCgkJCSAqIEByZXR1cm5zIHtBcnJheX0gVGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXJzLgoJCQkgKiBAcHVibGljCgkJCSAqLwoJCQlFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVycyA9IGZ1bmN0aW9uIGxpc3RlbmVycyhldmVudCkgewoJCQkgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50CgkJCSAgICAsIGhhbmRsZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07CgoJCQkgIGlmICghaGFuZGxlcnMpIHJldHVybiBbXTsKCQkJICBpZiAoaGFuZGxlcnMuZm4pIHJldHVybiBbaGFuZGxlcnMuZm5dOwoKCQkJICBmb3IgKHZhciBpID0gMCwgbCA9IGhhbmRsZXJzLmxlbmd0aCwgZWUgPSBuZXcgQXJyYXkobCk7IGkgPCBsOyBpKyspIHsKCQkJICAgIGVlW2ldID0gaGFuZGxlcnNbaV0uZm47CgkJCSAgfQoKCQkJICByZXR1cm4gZWU7CgkJCX07CgoJCQkvKioKCQkJICogUmV0dXJuIHRoZSBudW1iZXIgb2YgbGlzdGVuZXJzIGxpc3RlbmluZyB0byBhIGdpdmVuIGV2ZW50LgoJCQkgKgoJCQkgKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuCgkJCSAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBudW1iZXIgb2YgbGlzdGVuZXJzLgoJCQkgKiBAcHVibGljCgkJCSAqLwoJCQlFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGV2ZW50KSB7CgkJCSAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQKCQkJICAgICwgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07CgoJCQkgIGlmICghbGlzdGVuZXJzKSByZXR1cm4gMDsKCQkJICBpZiAobGlzdGVuZXJzLmZuKSByZXR1cm4gMTsKCQkJICByZXR1cm4gbGlzdGVuZXJzLmxlbmd0aDsKCQkJfTsKCgkJCS8qKgoJCQkgKiBDYWxscyBlYWNoIG9mIHRoZSBsaXN0ZW5lcnMgcmVnaXN0ZXJlZCBmb3IgYSBnaXZlbiBldmVudC4KCQkJICoKCQkJICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLgoJCQkgKiBAcmV0dXJucyB7Qm9vbGVhbn0gYHRydWVgIGlmIHRoZSBldmVudCBoYWQgbGlzdGVuZXJzLCBlbHNlIGBmYWxzZWAuCgkJCSAqIEBwdWJsaWMKCQkJICovCgkJCUV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIGExLCBhMiwgYTMsIGE0LCBhNSkgewoJCQkgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50OwoKCQkJICBpZiAoIXRoaXMuX2V2ZW50c1tldnRdKSByZXR1cm4gZmFsc2U7CgoJCQkgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XQoJCQkgICAgLCBsZW4gPSBhcmd1bWVudHMubGVuZ3RoCgkJCSAgICAsIGFyZ3MKCQkJICAgICwgaTsKCgkJCSAgaWYgKGxpc3RlbmVycy5mbikgewoJCQkgICAgaWYgKGxpc3RlbmVycy5vbmNlKSB0aGlzLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcnMuZm4sIHVuZGVmaW5lZCwgdHJ1ZSk7CgoJCQkgICAgc3dpdGNoIChsZW4pIHsKCQkJICAgICAgY2FzZSAxOiByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQpLCB0cnVlOwoJCQkgICAgICBjYXNlIDI6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEpLCB0cnVlOwoJCQkgICAgICBjYXNlIDM6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyKSwgdHJ1ZTsKCQkJICAgICAgY2FzZSA0OiByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMpLCB0cnVlOwoJCQkgICAgICBjYXNlIDU6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMywgYTQpLCB0cnVlOwoJCQkgICAgICBjYXNlIDY6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMywgYTQsIGE1KSwgdHJ1ZTsKCQkJICAgIH0KCgkJCSAgICBmb3IgKGkgPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtMSk7IGkgPCBsZW47IGkrKykgewoJCQkgICAgICBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKCQkJICAgIH0KCgkJCSAgICBsaXN0ZW5lcnMuZm4uYXBwbHkobGlzdGVuZXJzLmNvbnRleHQsIGFyZ3MpOwoJCQkgIH0gZWxzZSB7CgkJCSAgICB2YXIgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aAoJCQkgICAgICAsIGo7CgoJCQkgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCSAgICAgIGlmIChsaXN0ZW5lcnNbaV0ub25jZSkgdGhpcy5yZW1vdmVMaXN0ZW5lcihldmVudCwgbGlzdGVuZXJzW2ldLmZuLCB1bmRlZmluZWQsIHRydWUpOwoKCQkJICAgICAgc3dpdGNoIChsZW4pIHsKCQkJICAgICAgICBjYXNlIDE6IGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0KTsgYnJlYWs7CgkJCSAgICAgICAgY2FzZSAyOiBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEpOyBicmVhazsKCQkJICAgICAgICBjYXNlIDM6IGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIpOyBicmVhazsKCQkJICAgICAgICBjYXNlIDQ6IGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIsIGEzKTsgYnJlYWs7CgkJCSAgICAgICAgZGVmYXVsdDoKCQkJICAgICAgICAgIGlmICghYXJncykgZm9yIChqID0gMSwgYXJncyA9IG5ldyBBcnJheShsZW4gLTEpOyBqIDwgbGVuOyBqKyspIHsKCQkJICAgICAgICAgICAgYXJnc1tqIC0gMV0gPSBhcmd1bWVudHNbal07CgkJCSAgICAgICAgICB9CgoJCQkgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmFwcGx5KGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhcmdzKTsKCQkJICAgICAgfQoJCQkgICAgfQoJCQkgIH0KCgkJCSAgcmV0dXJuIHRydWU7CgkJCX07CgoJCQkvKioKCQkJICogQWRkIGEgbGlzdGVuZXIgZm9yIGEgZ2l2ZW4gZXZlbnQuCgkJCSAqCgkJCSAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS4KCQkJICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uLgoJCQkgKiBAcGFyYW0geyp9IFtjb250ZXh0PXRoaXNdIFRoZSBjb250ZXh0IHRvIGludm9rZSB0aGUgbGlzdGVuZXIgd2l0aC4KCQkJICogQHJldHVybnMge0V2ZW50RW1pdHRlcn0gYHRoaXNgLgoJCQkgKiBAcHVibGljCgkJCSAqLwoJCQlFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gZnVuY3Rpb24gb24oZXZlbnQsIGZuLCBjb250ZXh0KSB7CgkJCSAgcmV0dXJuIGFkZExpc3RlbmVyKHRoaXMsIGV2ZW50LCBmbiwgY29udGV4dCwgZmFsc2UpOwoJCQl9OwoKCQkJLyoqCgkJCSAqIEFkZCBhIG9uZS10aW1lIGxpc3RlbmVyIGZvciBhIGdpdmVuIGV2ZW50LgoJCQkgKgoJCQkgKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuCgkJCSAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBsaXN0ZW5lciBmdW5jdGlvbi4KCQkJICogQHBhcmFtIHsqfSBbY29udGV4dD10aGlzXSBUaGUgY29udGV4dCB0byBpbnZva2UgdGhlIGxpc3RlbmVyIHdpdGguCgkJCSAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9IGB0aGlzYC4KCQkJICogQHB1YmxpYwoJCQkgKi8KCQkJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gb25jZShldmVudCwgZm4sIGNvbnRleHQpIHsKCQkJICByZXR1cm4gYWRkTGlzdGVuZXIodGhpcywgZXZlbnQsIGZuLCBjb250ZXh0LCB0cnVlKTsKCQkJfTsKCgkJCS8qKgoJCQkgKiBSZW1vdmUgdGhlIGxpc3RlbmVycyBvZiBhIGdpdmVuIGV2ZW50LgoJCQkgKgoJCQkgKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuCgkJCSAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIE9ubHkgcmVtb3ZlIHRoZSBsaXN0ZW5lcnMgdGhhdCBtYXRjaCB0aGlzIGZ1bmN0aW9uLgoJCQkgKiBAcGFyYW0geyp9IGNvbnRleHQgT25seSByZW1vdmUgdGhlIGxpc3RlbmVycyB0aGF0IGhhdmUgdGhpcyBjb250ZXh0LgoJCQkgKiBAcGFyYW0ge0Jvb2xlYW59IG9uY2UgT25seSByZW1vdmUgb25lLXRpbWUgbGlzdGVuZXJzLgoJCQkgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfSBgdGhpc2AuCgkJCSAqIEBwdWJsaWMKCQkJICovCgkJCUV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldmVudCwgZm4sIGNvbnRleHQsIG9uY2UpIHsKCQkJICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKCgkJCSAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIHRoaXM7CgkJCSAgaWYgKCFmbikgewoJCQkgICAgY2xlYXJFdmVudCh0aGlzLCBldnQpOwoJCQkgICAgcmV0dXJuIHRoaXM7CgkJCSAgfQoKCQkJICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07CgoJCQkgIGlmIChsaXN0ZW5lcnMuZm4pIHsKCQkJICAgIGlmICgKCQkJICAgICAgbGlzdGVuZXJzLmZuID09PSBmbiAmJgoJCQkgICAgICAoIW9uY2UgfHwgbGlzdGVuZXJzLm9uY2UpICYmCgkJCSAgICAgICghY29udGV4dCB8fCBsaXN0ZW5lcnMuY29udGV4dCA9PT0gY29udGV4dCkKCQkJICAgICkgewoJCQkgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CgkJCSAgICB9CgkJCSAgfSBlbHNlIHsKCQkJICAgIGZvciAodmFyIGkgPSAwLCBldmVudHMgPSBbXSwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCSAgICAgIGlmICgKCQkJICAgICAgICBsaXN0ZW5lcnNbaV0uZm4gIT09IGZuIHx8CgkJCSAgICAgICAgKG9uY2UgJiYgIWxpc3RlbmVyc1tpXS5vbmNlKSB8fAoJCQkgICAgICAgIChjb250ZXh0ICYmIGxpc3RlbmVyc1tpXS5jb250ZXh0ICE9PSBjb250ZXh0KQoJCQkgICAgICApIHsKCQkJICAgICAgICBldmVudHMucHVzaChsaXN0ZW5lcnNbaV0pOwoJCQkgICAgICB9CgkJCSAgICB9CgoJCQkgICAgLy8KCQkJICAgIC8vIFJlc2V0IHRoZSBhcnJheSwgb3IgcmVtb3ZlIGl0IGNvbXBsZXRlbHkgaWYgd2UgaGF2ZSBubyBtb3JlIGxpc3RlbmVycy4KCQkJICAgIC8vCgkJCSAgICBpZiAoZXZlbnRzLmxlbmd0aCkgdGhpcy5fZXZlbnRzW2V2dF0gPSBldmVudHMubGVuZ3RoID09PSAxID8gZXZlbnRzWzBdIDogZXZlbnRzOwoJCQkgICAgZWxzZSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CgkJCSAgfQoKCQkJICByZXR1cm4gdGhpczsKCQkJfTsKCgkJCS8qKgoJCQkgKiBSZW1vdmUgYWxsIGxpc3RlbmVycywgb3IgdGhvc2Ugb2YgdGhlIHNwZWNpZmllZCBldmVudC4KCQkJICoKCQkJICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IFtldmVudF0gVGhlIGV2ZW50IG5hbWUuCgkJCSAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9IGB0aGlzYC4KCQkJICogQHB1YmxpYwoJCQkgKi8KCQkJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnQpIHsKCQkJICB2YXIgZXZ0OwoKCQkJICBpZiAoZXZlbnQpIHsKCQkJICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CgkJCSAgICBpZiAodGhpcy5fZXZlbnRzW2V2dF0pIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKCQkJICB9IGVsc2UgewoJCQkgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwoJCQkgICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwOwoJCQkgIH0KCgkJCSAgcmV0dXJuIHRoaXM7CgkJCX07CgoJCQkvLwoJCQkvLyBBbGlhcyBtZXRob2RzIG5hbWVzIGJlY2F1c2UgcGVvcGxlIHJvbGwgbGlrZSB0aGF0LgoJCQkvLwoJCQlFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9mZiA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXI7CgkJCUV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uOwoKCQkJLy8KCQkJLy8gRXhwb3NlIHRoZSBwcmVmaXguCgkJCS8vCgkJCUV2ZW50RW1pdHRlci5wcmVmaXhlZCA9IHByZWZpeDsKCgkJCS8vCgkJCS8vIEFsbG93IGBFdmVudEVtaXR0ZXJgIHRvIGJlIGltcG9ydGVkIGFzIG1vZHVsZSBuYW1lc3BhY2UuCgkJCS8vCgkJCUV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXI7CgoJCQkvLwoJCQkvLyBFeHBvc2UgdGhlIG1vZHVsZS4KCQkJLy8KCQkJewoJCQkgIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyOwoJCQl9IAoJCX0gKGV2ZW50ZW1pdHRlcjMpKTsKCQlyZXR1cm4gZXZlbnRlbWl0dGVyMy5leHBvcnRzOwoJfQoKCXZhciBldmVudGVtaXR0ZXIzRXhwb3J0cyA9IC8qQF9fUFVSRV9fKi8gcmVxdWlyZUV2ZW50ZW1pdHRlcjMoKTsKCXZhciBFdmVudEVtaXR0ZXIgPSAvKkBfX1BVUkVfXyovZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMoZXZlbnRlbWl0dGVyM0V4cG9ydHMpOwoKCS8vIG5vZGVfbW9kdWxlcy9lc2J1aWxkLXBsdWdpbi1wb2x5ZmlsbC1ub2RlL3BvbHlmaWxscy9idWZmZXIuanMKCXZhciBXZWJTb2NrZXRCcm93c2VySW1wbCA9IGNsYXNzIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKCSAgc29ja2V0OwoJICAvKiogSW5zdGFudGlhdGUgYSBXZWJTb2NrZXQgY2xhc3MKCSAgKiBAY29uc3RydWN0b3IKCSAgKiBAcGFyYW0ge1N0cmluZ30gYWRkcmVzcyAtIHVybCB0byBhIHdlYnNvY2tldCBzZXJ2ZXIKCSAgKiBAcGFyYW0geyhPYmplY3QpfSBvcHRpb25zIC0gd2Vic29ja2V0IG9wdGlvbnMKCSAgKiBAcGFyYW0geyhTdHJpbmd8QXJyYXkpfSBwcm90b2NvbHMgLSBhIGxpc3Qgb2YgcHJvdG9jb2xzCgkgICogQHJldHVybiB7V2ViU29ja2V0QnJvd3NlckltcGx9IC0gcmV0dXJucyBhIFdlYlNvY2tldCBpbnN0YW5jZQoJICAqLwoJICBjb25zdHJ1Y3RvcihhZGRyZXNzLCBvcHRpb25zLCBwcm90b2NvbHMpIHsKCSAgICBzdXBlcigpOwoJICAgIHRoaXMuc29ja2V0ID0gbmV3IHdpbmRvdy5XZWJTb2NrZXQoYWRkcmVzcywgcHJvdG9jb2xzKTsKCSAgICB0aGlzLnNvY2tldC5vbm9wZW4gPSAoKSA9PiB0aGlzLmVtaXQoIm9wZW4iKTsKCSAgICB0aGlzLnNvY2tldC5vbm1lc3NhZ2UgPSAoZXZlbnQpID0+IHRoaXMuZW1pdCgibWVzc2FnZSIsIGV2ZW50LmRhdGEpOwoJICAgIHRoaXMuc29ja2V0Lm9uZXJyb3IgPSAoZXJyb3IpID0+IHRoaXMuZW1pdCgiZXJyb3IiLCBlcnJvcik7CgkgICAgdGhpcy5zb2NrZXQub25jbG9zZSA9IChldmVudCkgPT4gewoJICAgICAgdGhpcy5lbWl0KCJjbG9zZSIsIGV2ZW50LmNvZGUsIGV2ZW50LnJlYXNvbik7CgkgICAgfTsKCSAgfQoJICAvKioKCSAgKiBTZW5kcyBkYXRhIHRocm91Z2ggYSB3ZWJzb2NrZXQgY29ubmVjdGlvbgoJICAqIEBtZXRob2QKCSAgKiBAcGFyYW0geyhTdHJpbmd8T2JqZWN0KX0gZGF0YSAtIGRhdGEgdG8gYmUgc2VudCB2aWEgd2Vic29ja2V0CgkgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNPckNhbGxiYWNrIC0gd3Mgb3B0aW9ucwoJICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIC0gYSBjYWxsYmFjayBjYWxsZWQgb25jZSB0aGUgZGF0YSBpcyBzZW50CgkgICogQHJldHVybiB7VW5kZWZpbmVkfQoJICAqLwoJICBzZW5kKGRhdGEsIG9wdGlvbnNPckNhbGxiYWNrLCBjYWxsYmFjaykgewoJICAgIGNvbnN0IGNiID0gY2FsbGJhY2sgfHwgb3B0aW9uc09yQ2FsbGJhY2s7CgkgICAgdHJ5IHsKCSAgICAgIHRoaXMuc29ja2V0LnNlbmQoZGF0YSk7CgkgICAgICBjYigpOwoJICAgIH0gY2F0Y2ggKGVycm9yKSB7CgkgICAgICBjYihlcnJvcik7CgkgICAgfQoJICB9CgkgIC8qKgoJICAqIENsb3NlcyBhbiB1bmRlcmx5aW5nIHNvY2tldAoJICAqIEBtZXRob2QKCSAgKiBAcGFyYW0ge051bWJlcn0gY29kZSAtIHN0YXR1cyBjb2RlIGV4cGxhaW5pbmcgd2h5IHRoZSBjb25uZWN0aW9uIGlzIGJlaW5nIGNsb3NlZAoJICAqIEBwYXJhbSB7U3RyaW5nfSByZWFzb24gLSBhIGRlc2NyaXB0aW9uIHdoeSB0aGUgY29ubmVjdGlvbiBpcyBjbG9zaW5nCgkgICogQHJldHVybiB7VW5kZWZpbmVkfQoJICAqIEB0aHJvd3Mge0Vycm9yfQoJICAqLwoJICBjbG9zZShjb2RlLCByZWFzb24pIHsKCSAgICB0aGlzLnNvY2tldC5jbG9zZShjb2RlLCByZWFzb24pOwoJICB9CgkgIGFkZEV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIsIG9wdGlvbnMpIHsKCSAgICB0aGlzLnNvY2tldC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCBvcHRpb25zKTsKCSAgfQoJfTsKCWZ1bmN0aW9uIFdlYlNvY2tldChhZGRyZXNzLCBvcHRpb25zKSB7CgkgIHJldHVybiBuZXcgV2ViU29ja2V0QnJvd3NlckltcGwoYWRkcmVzcywgb3B0aW9ucyk7Cgl9CgoJLy8gc3JjL2xpYi91dGlscy50cwoJdmFyIERlZmF1bHREYXRhUGFjayA9IGNsYXNzIHsKCSAgZW5jb2RlKHZhbHVlKSB7CgkgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKCSAgfQoJICBkZWNvZGUodmFsdWUpIHsKCSAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CgkgIH0KCX07CgoJLy8gc3JjL2xpYi9jbGllbnQudHMKCXZhciBDb21tb25DbGllbnQgPSBjbGFzcyBleHRlbmRzIEV2ZW50RW1pdHRlciB7CgkgIGFkZHJlc3M7CgkgIHJwY19pZDsKCSAgcXVldWU7CgkgIG9wdGlvbnM7CgkgIGF1dG9jb25uZWN0OwoJICByZWFkeTsKCSAgcmVjb25uZWN0OwoJICByZWNvbm5lY3RfdGltZXJfaWQ7CgkgIHJlY29ubmVjdF9pbnRlcnZhbDsKCSAgbWF4X3JlY29ubmVjdHM7CgkgIHJlc3Rfb3B0aW9uczsKCSAgY3VycmVudF9yZWNvbm5lY3RzOwoJICBnZW5lcmF0ZV9yZXF1ZXN0X2lkOwoJICBzb2NrZXQ7CgkgIHdlYlNvY2tldEZhY3Rvcnk7CgkgIGRhdGFQYWNrOwoJICAvKioKCSAgKiBJbnN0YW50aWF0ZSBhIENsaWVudCBjbGFzcy4KCSAgKiBAY29uc3RydWN0b3IKCSAgKiBAcGFyYW0ge3dlYlNvY2tldEZhY3Rvcnl9IHdlYlNvY2tldEZhY3RvcnkgLSBmYWN0b3J5IG1ldGhvZCBmb3IgV2ViU29ja2V0CgkgICogQHBhcmFtIHtTdHJpbmd9IGFkZHJlc3MgLSB1cmwgdG8gYSB3ZWJzb2NrZXQgc2VydmVyCgkgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSB3cyBvcHRpb25zIG9iamVjdCB3aXRoIHJlY29ubmVjdCBwYXJhbWV0ZXJzCgkgICogQHBhcmFtIHtGdW5jdGlvbn0gZ2VuZXJhdGVfcmVxdWVzdF9pZCAtIGN1c3RvbSBnZW5lcmF0aW9uIHJlcXVlc3QgSWQKCSAgKiBAcGFyYW0ge0RhdGFQYWNrfSBkYXRhUGFjayAtIGRhdGEgcGFjayBjb250YWlucyBlbmNvZGVyIGFuZCBkZWNvZGVyCgkgICogQHJldHVybiB7Q29tbW9uQ2xpZW50fQoJICAqLwoJICBjb25zdHJ1Y3Rvcih3ZWJTb2NrZXRGYWN0b3J5LCBhZGRyZXNzID0gIndzOi8vbG9jYWxob3N0OjgwODAiLCB7CgkgICAgYXV0b2Nvbm5lY3QgPSB0cnVlLAoJICAgIHJlY29ubmVjdCA9IHRydWUsCgkgICAgcmVjb25uZWN0X2ludGVydmFsID0gMWUzLAoJICAgIG1heF9yZWNvbm5lY3RzID0gNSwKCSAgICAuLi5yZXN0X29wdGlvbnMKCSAgfSA9IHt9LCBnZW5lcmF0ZV9yZXF1ZXN0X2lkLCBkYXRhUGFjaykgewoJICAgIHN1cGVyKCk7CgkgICAgdGhpcy53ZWJTb2NrZXRGYWN0b3J5ID0gd2ViU29ja2V0RmFjdG9yeTsKCSAgICB0aGlzLnF1ZXVlID0ge307CgkgICAgdGhpcy5ycGNfaWQgPSAwOwoJICAgIHRoaXMuYWRkcmVzcyA9IGFkZHJlc3M7CgkgICAgdGhpcy5hdXRvY29ubmVjdCA9IGF1dG9jb25uZWN0OwoJICAgIHRoaXMucmVhZHkgPSBmYWxzZTsKCSAgICB0aGlzLnJlY29ubmVjdCA9IHJlY29ubmVjdDsKCSAgICB0aGlzLnJlY29ubmVjdF90aW1lcl9pZCA9IHZvaWQgMDsKCSAgICB0aGlzLnJlY29ubmVjdF9pbnRlcnZhbCA9IHJlY29ubmVjdF9pbnRlcnZhbDsKCSAgICB0aGlzLm1heF9yZWNvbm5lY3RzID0gbWF4X3JlY29ubmVjdHM7CgkgICAgdGhpcy5yZXN0X29wdGlvbnMgPSByZXN0X29wdGlvbnM7CgkgICAgdGhpcy5jdXJyZW50X3JlY29ubmVjdHMgPSAwOwoJICAgIHRoaXMuZ2VuZXJhdGVfcmVxdWVzdF9pZCA9IGdlbmVyYXRlX3JlcXVlc3RfaWQgfHwgKCgpID0+ICsrdGhpcy5ycGNfaWQpOwoJICAgIGlmICghZGF0YVBhY2spIHRoaXMuZGF0YVBhY2sgPSBuZXcgRGVmYXVsdERhdGFQYWNrKCk7CgkgICAgZWxzZSB0aGlzLmRhdGFQYWNrID0gZGF0YVBhY2s7CgkgICAgaWYgKHRoaXMuYXV0b2Nvbm5lY3QpCgkgICAgICB0aGlzLl9jb25uZWN0KHRoaXMuYWRkcmVzcywgewoJICAgICAgICBhdXRvY29ubmVjdDogdGhpcy5hdXRvY29ubmVjdCwKCSAgICAgICAgcmVjb25uZWN0OiB0aGlzLnJlY29ubmVjdCwKCSAgICAgICAgcmVjb25uZWN0X2ludGVydmFsOiB0aGlzLnJlY29ubmVjdF9pbnRlcnZhbCwKCSAgICAgICAgbWF4X3JlY29ubmVjdHM6IHRoaXMubWF4X3JlY29ubmVjdHMsCgkgICAgICAgIC4uLnRoaXMucmVzdF9vcHRpb25zCgkgICAgICB9KTsKCSAgfQoJICAvKioKCSAgKiBDb25uZWN0cyB0byBhIGRlZmluZWQgc2VydmVyIGlmIG5vdCBjb25uZWN0ZWQgYWxyZWFkeS4KCSAgKiBAbWV0aG9kCgkgICogQHJldHVybiB7VW5kZWZpbmVkfQoJICAqLwoJICBjb25uZWN0KCkgewoJICAgIGlmICh0aGlzLnNvY2tldCkgcmV0dXJuOwoJICAgIHRoaXMuX2Nvbm5lY3QodGhpcy5hZGRyZXNzLCB7CgkgICAgICBhdXRvY29ubmVjdDogdGhpcy5hdXRvY29ubmVjdCwKCSAgICAgIHJlY29ubmVjdDogdGhpcy5yZWNvbm5lY3QsCgkgICAgICByZWNvbm5lY3RfaW50ZXJ2YWw6IHRoaXMucmVjb25uZWN0X2ludGVydmFsLAoJICAgICAgbWF4X3JlY29ubmVjdHM6IHRoaXMubWF4X3JlY29ubmVjdHMsCgkgICAgICAuLi50aGlzLnJlc3Rfb3B0aW9ucwoJICAgIH0pOwoJICB9CgkgIC8qKgoJICAqIENhbGxzIGEgcmVnaXN0ZXJlZCBSUEMgbWV0aG9kIG9uIHNlcnZlci4KCSAgKiBAbWV0aG9kCgkgICogQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCAtIFJQQyBtZXRob2QgbmFtZQoJICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fSBwYXJhbXMgLSBvcHRpb25hbCBtZXRob2QgcGFyYW1ldGVycwoJICAqIEBwYXJhbSB7TnVtYmVyfSB0aW1lb3V0IC0gUlBDIHJlcGx5IHRpbWVvdXQgdmFsdWUKCSAgKiBAcGFyYW0ge09iamVjdH0gd3Nfb3B0cyAtIG9wdGlvbnMgcGFzc2VkIHRvIHdzCgkgICogQHJldHVybiB7UHJvbWlzZX0KCSAgKi8KCSAgY2FsbChtZXRob2QsIHBhcmFtcywgdGltZW91dCwgd3Nfb3B0cykgewoJICAgIGlmICghd3Nfb3B0cyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIHRpbWVvdXQpIHsKCSAgICAgIHdzX29wdHMgPSB0aW1lb3V0OwoJICAgICAgdGltZW91dCA9IG51bGw7CgkgICAgfQoJICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkgICAgICBpZiAoIXRoaXMucmVhZHkpIHJldHVybiByZWplY3QobmV3IEVycm9yKCJzb2NrZXQgbm90IHJlYWR5IikpOwoJICAgICAgY29uc3QgcnBjX2lkID0gdGhpcy5nZW5lcmF0ZV9yZXF1ZXN0X2lkKG1ldGhvZCwgcGFyYW1zKTsKCSAgICAgIGNvbnN0IG1lc3NhZ2UgPSB7CgkgICAgICAgIGpzb25ycGM6ICIyLjAiLAoJICAgICAgICBtZXRob2QsCgkgICAgICAgIHBhcmFtczogcGFyYW1zIHx8IHZvaWQgMCwKCSAgICAgICAgaWQ6IHJwY19pZAoJICAgICAgfTsKCSAgICAgIHRoaXMuc29ja2V0LnNlbmQodGhpcy5kYXRhUGFjay5lbmNvZGUobWVzc2FnZSksIHdzX29wdHMsIChlcnJvcikgPT4gewoJICAgICAgICBpZiAoZXJyb3IpIHJldHVybiByZWplY3QoZXJyb3IpOwoJICAgICAgICB0aGlzLnF1ZXVlW3JwY19pZF0gPSB7IHByb21pc2U6IFtyZXNvbHZlLCByZWplY3RdIH07CgkgICAgICAgIGlmICh0aW1lb3V0KSB7CgkgICAgICAgICAgdGhpcy5xdWV1ZVtycGNfaWRdLnRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKCSAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnF1ZXVlW3JwY19pZF07CgkgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCJyZXBseSB0aW1lb3V0IikpOwoJICAgICAgICAgIH0sIHRpbWVvdXQpOwoJICAgICAgICB9CgkgICAgICB9KTsKCSAgICB9KTsKCSAgfQoJICAvKioKCSAgKiBMb2dpbnMgd2l0aCB0aGUgb3RoZXIgc2lkZSBvZiB0aGUgY29ubmVjdGlvbi4KCSAgKiBAbWV0aG9kCgkgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyAtIExvZ2luIGNyZWRlbnRpYWxzIG9iamVjdAoJICAqIEByZXR1cm4ge1Byb21pc2V9CgkgICovCgkgIGFzeW5jIGxvZ2luKHBhcmFtcykgewoJICAgIGNvbnN0IHJlc3AgPSBhd2FpdCB0aGlzLmNhbGwoInJwYy5sb2dpbiIsIHBhcmFtcyk7CgkgICAgaWYgKCFyZXNwKSB0aHJvdyBuZXcgRXJyb3IoImF1dGhlbnRpY2F0aW9uIGZhaWxlZCIpOwoJICAgIHJldHVybiByZXNwOwoJICB9CgkgIC8qKgoJICAqIEZldGNoZXMgYSBsaXN0IG9mIGNsaWVudCdzIG1ldGhvZHMgcmVnaXN0ZXJlZCBvbiBzZXJ2ZXIuCgkgICogQG1ldGhvZAoJICAqIEByZXR1cm4ge0FycmF5fQoJICAqLwoJICBhc3luYyBsaXN0TWV0aG9kcygpIHsKCSAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCJfX2xpc3RNZXRob2RzIik7CgkgIH0KCSAgLyoqCgkgICogU2VuZHMgYSBKU09OLVJQQyAyLjAgbm90aWZpY2F0aW9uIHRvIHNlcnZlci4KCSAgKiBAbWV0aG9kCgkgICogQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCAtIFJQQyBtZXRob2QgbmFtZQoJICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgLSBvcHRpb25hbCBtZXRob2QgcGFyYW1ldGVycwoJICAqIEByZXR1cm4ge1Byb21pc2V9CgkgICovCgkgIG5vdGlmeShtZXRob2QsIHBhcmFtcykgewoJICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkgICAgICBpZiAoIXRoaXMucmVhZHkpIHJldHVybiByZWplY3QobmV3IEVycm9yKCJzb2NrZXQgbm90IHJlYWR5IikpOwoJICAgICAgY29uc3QgbWVzc2FnZSA9IHsKCSAgICAgICAganNvbnJwYzogIjIuMCIsCgkgICAgICAgIG1ldGhvZCwKCSAgICAgICAgcGFyYW1zCgkgICAgICB9OwoJICAgICAgdGhpcy5zb2NrZXQuc2VuZCh0aGlzLmRhdGFQYWNrLmVuY29kZShtZXNzYWdlKSwgKGVycm9yKSA9PiB7CgkgICAgICAgIGlmIChlcnJvcikgcmV0dXJuIHJlamVjdChlcnJvcik7CgkgICAgICAgIHJlc29sdmUoKTsKCSAgICAgIH0pOwoJICAgIH0pOwoJICB9CgkgIC8qKgoJICAqIFN1YnNjcmliZXMgZm9yIGEgZGVmaW5lZCBldmVudC4KCSAgKiBAbWV0aG9kCgkgICogQHBhcmFtIHtTdHJpbmd8QXJyYXl9IGV2ZW50IC0gZXZlbnQgbmFtZQoJICAqIEByZXR1cm4ge1VuZGVmaW5lZH0KCSAgKiBAdGhyb3dzIHtFcnJvcn0KCSAgKi8KCSAgYXN5bmMgc3Vic2NyaWJlKGV2ZW50KSB7CgkgICAgaWYgKHR5cGVvZiBldmVudCA9PT0gInN0cmluZyIpIGV2ZW50ID0gW2V2ZW50XTsKCSAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNhbGwoInJwYy5vbiIsIGV2ZW50KTsKCSAgICBpZiAodHlwZW9mIGV2ZW50ID09PSAic3RyaW5nIiAmJiByZXN1bHRbZXZlbnRdICE9PSAib2siKQoJICAgICAgdGhyb3cgbmV3IEVycm9yKAoJICAgICAgICAiRmFpbGVkIHN1YnNjcmliaW5nIHRvIGFuIGV2ZW50ICciICsgZXZlbnQgKyAiJyB3aXRoOiAiICsgcmVzdWx0W2V2ZW50XQoJICAgICAgKTsKCSAgICByZXR1cm4gcmVzdWx0OwoJICB9CgkgIC8qKgoJICAqIFVuc3Vic2NyaWJlcyBmcm9tIGEgZGVmaW5lZCBldmVudC4KCSAgKiBAbWV0aG9kCgkgICogQHBhcmFtIHtTdHJpbmd8QXJyYXl9IGV2ZW50IC0gZXZlbnQgbmFtZQoJICAqIEByZXR1cm4ge1VuZGVmaW5lZH0KCSAgKiBAdGhyb3dzIHtFcnJvcn0KCSAgKi8KCSAgYXN5bmMgdW5zdWJzY3JpYmUoZXZlbnQpIHsKCSAgICBpZiAodHlwZW9mIGV2ZW50ID09PSAic3RyaW5nIikgZXZlbnQgPSBbZXZlbnRdOwoJICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2FsbCgicnBjLm9mZiIsIGV2ZW50KTsKCSAgICBpZiAodHlwZW9mIGV2ZW50ID09PSAic3RyaW5nIiAmJiByZXN1bHRbZXZlbnRdICE9PSAib2siKQoJICAgICAgdGhyb3cgbmV3IEVycm9yKCJGYWlsZWQgdW5zdWJzY3JpYmluZyBmcm9tIGFuIGV2ZW50IHdpdGg6ICIgKyByZXN1bHQpOwoJICAgIHJldHVybiByZXN1bHQ7CgkgIH0KCSAgLyoqCgkgICogQ2xvc2VzIGEgV2ViU29ja2V0IGNvbm5lY3Rpb24gZ3JhY2VmdWxseS4KCSAgKiBAbWV0aG9kCgkgICogQHBhcmFtIHtOdW1iZXJ9IGNvZGUgLSBzb2NrZXQgY2xvc2UgY29kZQoJICAqIEBwYXJhbSB7U3RyaW5nfSBkYXRhIC0gb3B0aW9uYWwgZGF0YSB0byBiZSBzZW50IGJlZm9yZSBjbG9zaW5nCgkgICogQHJldHVybiB7VW5kZWZpbmVkfQoJICAqLwoJICBjbG9zZShjb2RlLCBkYXRhKSB7CgkgICAgdGhpcy5zb2NrZXQuY2xvc2UoY29kZSB8fCAxZTMsIGRhdGEpOwoJICB9CgkgIC8qKgoJICAqIEVuYWJsZSAvIGRpc2FibGUgYXV0b21hdGljIHJlY29ubmVjdGlvbi4KCSAgKiBAbWV0aG9kCgkgICogQHBhcmFtIHtCb29sZWFufSByZWNvbm5lY3QgLSBlbmFibGUgLyBkaXNhYmxlIHJlY29ubmVjdGlvbgoJICAqIEByZXR1cm4ge1VuZGVmaW5lZH0KCSAgKi8KCSAgc2V0QXV0b1JlY29ubmVjdChyZWNvbm5lY3QpIHsKCSAgICB0aGlzLnJlY29ubmVjdCA9IHJlY29ubmVjdDsKCSAgfQoJICAvKioKCSAgKiBTZXQgdGhlIGludGVydmFsIGJldHdlZW4gcmVjb25uZWN0aW9uIGF0dGVtcHRzLgoJICAqIEBtZXRob2QKCSAgKiBAcGFyYW0ge051bWJlcn0gaW50ZXJ2YWwgLSByZWNvbm5lY3Rpb24gaW50ZXJ2YWwgaW4gbWlsbGlzZWNvbmRzCgkgICogQHJldHVybiB7VW5kZWZpbmVkfQoJICAqLwoJICBzZXRSZWNvbm5lY3RJbnRlcnZhbChpbnRlcnZhbCkgewoJICAgIHRoaXMucmVjb25uZWN0X2ludGVydmFsID0gaW50ZXJ2YWw7CgkgIH0KCSAgLyoqCgkgICogU2V0IHRoZSBtYXhpbXVtIG51bWJlciBvZiByZWNvbm5lY3Rpb24gYXR0ZW1wdHMuCgkgICogQG1ldGhvZAoJICAqIEBwYXJhbSB7TnVtYmVyfSBtYXhfcmVjb25uZWN0cyAtIG1heGltdW0gcmVjb25uZWN0aW9uIGF0dGVtcHRzCgkgICogQHJldHVybiB7VW5kZWZpbmVkfQoJICAqLwoJICBzZXRNYXhSZWNvbm5lY3RzKG1heF9yZWNvbm5lY3RzKSB7CgkgICAgdGhpcy5tYXhfcmVjb25uZWN0cyA9IG1heF9yZWNvbm5lY3RzOwoJICB9CgkgIC8qKgoJICAqIENvbm5lY3Rpb24vTWVzc2FnZSBoYW5kbGVyLgoJICAqIEBtZXRob2QKCSAgKiBAcHJpdmF0ZQoJICAqIEBwYXJhbSB7U3RyaW5nfSBhZGRyZXNzIC0gV2ViU29ja2V0IEFQSSBhZGRyZXNzCgkgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSB3cyBvcHRpb25zIG9iamVjdAoJICAqIEByZXR1cm4ge1VuZGVmaW5lZH0KCSAgKi8KCSAgX2Nvbm5lY3QoYWRkcmVzcywgb3B0aW9ucykgewoJICAgIGNsZWFyVGltZW91dCh0aGlzLnJlY29ubmVjdF90aW1lcl9pZCk7CgkgICAgdGhpcy5zb2NrZXQgPSB0aGlzLndlYlNvY2tldEZhY3RvcnkoYWRkcmVzcywgb3B0aW9ucyk7CgkgICAgdGhpcy5zb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcigib3BlbiIsICgpID0+IHsKCSAgICAgIHRoaXMucmVhZHkgPSB0cnVlOwoJICAgICAgdGhpcy5lbWl0KCJvcGVuIik7CgkgICAgICB0aGlzLmN1cnJlbnRfcmVjb25uZWN0cyA9IDA7CgkgICAgfSk7CgkgICAgdGhpcy5zb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsICh7IGRhdGE6IG1lc3NhZ2UgfSkgPT4gewoJICAgICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikKCSAgICAgICAgbWVzc2FnZSA9IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20obWVzc2FnZSkudG9TdHJpbmcoKTsKCSAgICAgIHRyeSB7CgkgICAgICAgIG1lc3NhZ2UgPSB0aGlzLmRhdGFQYWNrLmRlY29kZShtZXNzYWdlKTsKCSAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CgkgICAgICAgIHJldHVybjsKCSAgICAgIH0KCSAgICAgIGlmIChtZXNzYWdlLm5vdGlmaWNhdGlvbiAmJiB0aGlzLmxpc3RlbmVycyhtZXNzYWdlLm5vdGlmaWNhdGlvbikubGVuZ3RoKSB7CgkgICAgICAgIGlmICghT2JqZWN0LmtleXMobWVzc2FnZS5wYXJhbXMpLmxlbmd0aCkKCSAgICAgICAgICByZXR1cm4gdGhpcy5lbWl0KG1lc3NhZ2Uubm90aWZpY2F0aW9uKTsKCSAgICAgICAgY29uc3QgYXJncyA9IFttZXNzYWdlLm5vdGlmaWNhdGlvbl07CgkgICAgICAgIGlmIChtZXNzYWdlLnBhcmFtcy5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KSBhcmdzLnB1c2gobWVzc2FnZS5wYXJhbXMpOwoJICAgICAgICBlbHNlCgkgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtZXNzYWdlLnBhcmFtcy5sZW5ndGg7IGkrKykKCSAgICAgICAgICAgIGFyZ3MucHVzaChtZXNzYWdlLnBhcmFtc1tpXSk7CgkgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHsKCSAgICAgICAgICB0aGlzLmVtaXQuYXBwbHkodGhpcywgYXJncyk7CgkgICAgICAgIH0pOwoJICAgICAgfQoJICAgICAgaWYgKCF0aGlzLnF1ZXVlW21lc3NhZ2UuaWRdKSB7CgkgICAgICAgIGlmIChtZXNzYWdlLm1ldGhvZCkgewoJICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHsKCSAgICAgICAgICAgIHRoaXMuZW1pdChtZXNzYWdlLm1ldGhvZCwgbWVzc2FnZT8ucGFyYW1zKTsKCSAgICAgICAgICB9KTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm47CgkgICAgICB9CgkgICAgICBpZiAoImVycm9yIiBpbiBtZXNzYWdlID09PSAicmVzdWx0IiBpbiBtZXNzYWdlKQoJICAgICAgICB0aGlzLnF1ZXVlW21lc3NhZ2UuaWRdLnByb21pc2VbMV0oCgkgICAgICAgICAgbmV3IEVycm9yKAoJICAgICAgICAgICAgJ1NlcnZlciByZXNwb25zZSBtYWxmb3JtZWQuIFJlc3BvbnNlIG11c3QgaW5jbHVkZSBlaXRoZXIgInJlc3VsdCIgb3IgImVycm9yIiwgYnV0IG5vdCBib3RoLicKCSAgICAgICAgICApCgkgICAgICAgICk7CgkgICAgICBpZiAodGhpcy5xdWV1ZVttZXNzYWdlLmlkXS50aW1lb3V0KQoJICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5xdWV1ZVttZXNzYWdlLmlkXS50aW1lb3V0KTsKCSAgICAgIGlmIChtZXNzYWdlLmVycm9yKSB0aGlzLnF1ZXVlW21lc3NhZ2UuaWRdLnByb21pc2VbMV0obWVzc2FnZS5lcnJvcik7CgkgICAgICBlbHNlIHRoaXMucXVldWVbbWVzc2FnZS5pZF0ucHJvbWlzZVswXShtZXNzYWdlLnJlc3VsdCk7CgkgICAgICBkZWxldGUgdGhpcy5xdWV1ZVttZXNzYWdlLmlkXTsKCSAgICB9KTsKCSAgICB0aGlzLnNvY2tldC5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIChlcnJvcikgPT4gdGhpcy5lbWl0KCJlcnJvciIsIGVycm9yKSk7CgkgICAgdGhpcy5zb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcigiY2xvc2UiLCAoeyBjb2RlLCByZWFzb24gfSkgPT4gewoJICAgICAgaWYgKHRoaXMucmVhZHkpCgkgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5lbWl0KCJjbG9zZSIsIGNvZGUsIHJlYXNvbiksIDApOwoJICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlOwoJICAgICAgdGhpcy5zb2NrZXQgPSB2b2lkIDA7CgkgICAgICBpZiAoY29kZSA9PT0gMWUzKSByZXR1cm47CgkgICAgICB0aGlzLmN1cnJlbnRfcmVjb25uZWN0cysrOwoJICAgICAgaWYgKHRoaXMucmVjb25uZWN0ICYmICh0aGlzLm1heF9yZWNvbm5lY3RzID4gdGhpcy5jdXJyZW50X3JlY29ubmVjdHMgfHwgdGhpcy5tYXhfcmVjb25uZWN0cyA9PT0gMCkpCgkgICAgICAgIHRoaXMucmVjb25uZWN0X3RpbWVyX2lkID0gc2V0VGltZW91dCgKCSAgICAgICAgICAoKSA9PiB0aGlzLl9jb25uZWN0KGFkZHJlc3MsIG9wdGlvbnMpLAoJICAgICAgICAgIHRoaXMucmVjb25uZWN0X2ludGVydmFsCgkgICAgICAgICk7CgkgICAgfSk7CgkgIH0KCX07CgoJY2xhc3MgUnBjV2ViU29ja2V0Q2xpZW50IGV4dGVuZHMgQ29tbW9uQ2xpZW50IHsKCSAgY29uc3RydWN0b3IoYWRkcmVzcywgb3B0aW9ucywgZ2VuZXJhdGVfcmVxdWVzdF9pZCkgewoJICAgIGNvbnN0IHdlYlNvY2tldEZhY3RvcnkgPSB1cmwgPT4gewoJICAgICAgY29uc3QgcnBjID0gV2ViU29ja2V0KHVybCwgewoJICAgICAgICBhdXRvY29ubmVjdDogdHJ1ZSwKCSAgICAgICAgbWF4X3JlY29ubmVjdHM6IDUsCgkgICAgICAgIHJlY29ubmVjdDogdHJ1ZSwKCSAgICAgICAgcmVjb25uZWN0X2ludGVydmFsOiAxMDAwLAoJICAgICAgICAuLi5vcHRpb25zCgkgICAgICB9KTsKCSAgICAgIGlmICgnc29ja2V0JyBpbiBycGMpIHsKCSAgICAgICAgdGhpcy51bmRlcmx5aW5nU29ja2V0ID0gcnBjLnNvY2tldDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRoaXMudW5kZXJseWluZ1NvY2tldCA9IHJwYzsKCSAgICAgIH0KCSAgICAgIHJldHVybiBycGM7CgkgICAgfTsKCSAgICBzdXBlcih3ZWJTb2NrZXRGYWN0b3J5LCBhZGRyZXNzLCBvcHRpb25zLCBnZW5lcmF0ZV9yZXF1ZXN0X2lkKTsKCSAgICB0aGlzLnVuZGVybHlpbmdTb2NrZXQgPSB2b2lkIDA7CgkgIH0KCSAgY2FsbCguLi5hcmdzKSB7CgkgICAgY29uc3QgcmVhZHlTdGF0ZSA9IHRoaXMudW5kZXJseWluZ1NvY2tldD8ucmVhZHlTdGF0ZTsKCSAgICBpZiAocmVhZHlTdGF0ZSA9PT0gMSAvKiBXZWJTb2NrZXQuT1BFTiAqLykgewoJICAgICAgcmV0dXJuIHN1cGVyLmNhbGwoLi4uYXJncyk7CgkgICAgfQoJICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ1RyaWVkIHRvIGNhbGwgYSBKU09OLVJQQyBtZXRob2QgYCcgKyBhcmdzWzBdICsgJ2AgYnV0IHRoZSBzb2NrZXQgd2FzIG5vdCBgQ09OTkVDVElOR2Agb3IgYE9QRU5gIChgcmVhZHlTdGF0ZWAgd2FzICcgKyByZWFkeVN0YXRlICsgJyknKSk7CgkgIH0KCSAgbm90aWZ5KC4uLmFyZ3MpIHsKCSAgICBjb25zdCByZWFkeVN0YXRlID0gdGhpcy51bmRlcmx5aW5nU29ja2V0Py5yZWFkeVN0YXRlOwoJICAgIGlmIChyZWFkeVN0YXRlID09PSAxIC8qIFdlYlNvY2tldC5PUEVOICovKSB7CgkgICAgICByZXR1cm4gc3VwZXIubm90aWZ5KC4uLmFyZ3MpOwoJICAgIH0KCSAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdUcmllZCB0byBzZW5kIGEgSlNPTi1SUEMgbm90aWZpY2F0aW9uIGAnICsgYXJnc1swXSArICdgIGJ1dCB0aGUgc29ja2V0IHdhcyBub3QgYENPTk5FQ1RJTkdgIG9yIGBPUEVOYCAoYHJlYWR5U3RhdGVgIHdhcyAnICsgcmVhZHlTdGF0ZSArICcpJykpOwoJICB9Cgl9CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoKCS8qKgoJICogRGVjb2RlIGFjY291bnQgZGF0YSBidWZmZXIgdXNpbmcgYW4gQWNjb3VudFR5cGUKCSAqIEBpbnRlcm5hbAoJICovCglmdW5jdGlvbiBkZWNvZGVEYXRhKHR5cGUsIGRhdGEpIHsKCSAgbGV0IGRlY29kZWQ7CgkgIHRyeSB7CgkgICAgZGVjb2RlZCA9IHR5cGUubGF5b3V0LmRlY29kZShkYXRhKTsKCSAgfSBjYXRjaCAoZXJyKSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGluc3RydWN0aW9uOyAnICsgZXJyKTsKCSAgfQoJICBpZiAoZGVjb2RlZC50eXBlSW5kZXggIT09IHR5cGUuaW5kZXgpIHsKCSAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgYWNjb3VudCBkYXRhOyBhY2NvdW50IHR5cGUgbWlzbWF0Y2ggJHtkZWNvZGVkLnR5cGVJbmRleH0gIT0gJHt0eXBlLmluZGV4fWApOwoJICB9CgkgIHJldHVybiBkZWNvZGVkOwoJfQoKCS8vLyBUaGUgc2VyaWFsaXplZCBzaXplIG9mIGxvb2t1cCB0YWJsZSBtZXRhZGF0YQoJY29uc3QgTE9PS1VQX1RBQkxFX01FVEFfU0laRSA9IDU2OwoJY2xhc3MgQWRkcmVzc0xvb2t1cFRhYmxlQWNjb3VudCB7CgkgIGNvbnN0cnVjdG9yKGFyZ3MpIHsKCSAgICB0aGlzLmtleSA9IHZvaWQgMDsKCSAgICB0aGlzLnN0YXRlID0gdm9pZCAwOwoJICAgIHRoaXMua2V5ID0gYXJncy5rZXk7CgkgICAgdGhpcy5zdGF0ZSA9IGFyZ3Muc3RhdGU7CgkgIH0KCSAgaXNBY3RpdmUoKSB7CgkgICAgY29uc3QgVTY0X01BWCA9IEJpZ0ludCgnMHhmZmZmZmZmZmZmZmZmZmZmJyk7CgkgICAgcmV0dXJuIHRoaXMuc3RhdGUuZGVhY3RpdmF0aW9uU2xvdCA9PT0gVTY0X01BWDsKCSAgfQoJICBzdGF0aWMgZGVzZXJpYWxpemUoYWNjb3VudERhdGEpIHsKCSAgICBjb25zdCBtZXRhID0gZGVjb2RlRGF0YShMb29rdXBUYWJsZU1ldGFMYXlvdXQsIGFjY291bnREYXRhKTsKCSAgICBjb25zdCBzZXJpYWxpemVkQWRkcmVzc2VzTGVuID0gYWNjb3VudERhdGEubGVuZ3RoIC0gTE9PS1VQX1RBQkxFX01FVEFfU0laRTsKCSAgICBhc3NlcnQkMShzZXJpYWxpemVkQWRkcmVzc2VzTGVuID49IDAsICdsb29rdXAgdGFibGUgaXMgaW52YWxpZCcpOwoJICAgIGFzc2VydCQxKHNlcmlhbGl6ZWRBZGRyZXNzZXNMZW4gJSAzMiA9PT0gMCwgJ2xvb2t1cCB0YWJsZSBpcyBpbnZhbGlkJyk7CgkgICAgY29uc3QgbnVtU2VyaWFsaXplZEFkZHJlc3NlcyA9IHNlcmlhbGl6ZWRBZGRyZXNzZXNMZW4gLyAzMjsKCSAgICBjb25zdCB7CgkgICAgICBhZGRyZXNzZXMKCSAgICB9ID0gTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMuc2VxKHB1YmxpY0tleSgpLCBudW1TZXJpYWxpemVkQWRkcmVzc2VzLCAnYWRkcmVzc2VzJyldKS5kZWNvZGUoYWNjb3VudERhdGEuc2xpY2UoTE9PS1VQX1RBQkxFX01FVEFfU0laRSkpOwoJICAgIHJldHVybiB7CgkgICAgICBkZWFjdGl2YXRpb25TbG90OiBtZXRhLmRlYWN0aXZhdGlvblNsb3QsCgkgICAgICBsYXN0RXh0ZW5kZWRTbG90OiBtZXRhLmxhc3RFeHRlbmRlZFNsb3QsCgkgICAgICBsYXN0RXh0ZW5kZWRTbG90U3RhcnRJbmRleDogbWV0YS5sYXN0RXh0ZW5kZWRTdGFydEluZGV4LAoJICAgICAgYXV0aG9yaXR5OiBtZXRhLmF1dGhvcml0eS5sZW5ndGggIT09IDAgPyBuZXcgUHVibGljS2V5KG1ldGEuYXV0aG9yaXR5WzBdKSA6IHVuZGVmaW5lZCwKCSAgICAgIGFkZHJlc3NlczogYWRkcmVzc2VzLm1hcChhZGRyZXNzID0+IG5ldyBQdWJsaWNLZXkoYWRkcmVzcykpCgkgICAgfTsKCSAgfQoJfQoJY29uc3QgTG9va3VwVGFibGVNZXRhTGF5b3V0ID0gewoJICBpbmRleDogMSwKCSAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ3R5cGVJbmRleCcpLCB1NjQoJ2RlYWN0aXZhdGlvblNsb3QnKSwgTGF5b3V0RXhwb3J0cy5udTY0KCdsYXN0RXh0ZW5kZWRTbG90JyksIExheW91dEV4cG9ydHMudTgoJ2xhc3RFeHRlbmRlZFN0YXJ0SW5kZXgnKSwgTGF5b3V0RXhwb3J0cy51OCgpLAoJICAvLyBvcHRpb24KCSAgTGF5b3V0RXhwb3J0cy5zZXEocHVibGljS2V5KCksIExheW91dEV4cG9ydHMub2Zmc2V0KExheW91dEV4cG9ydHMudTgoKSwgLTEpLCAnYXV0aG9yaXR5JyldKQoJfTsKCgljb25zdCBVUkxfUkUgPSAvXlteOl0rOlwvXC8oW146W10rfFxbW15cXV0rXF0pKDpcZCspPyguKikvaTsKCWZ1bmN0aW9uIG1ha2VXZWJzb2NrZXRVcmwoZW5kcG9pbnQpIHsKCSAgY29uc3QgbWF0Y2hlcyA9IGVuZHBvaW50Lm1hdGNoKFVSTF9SRSk7CgkgIGlmIChtYXRjaGVzID09IG51bGwpIHsKCSAgICB0aHJvdyBUeXBlRXJyb3IoYEZhaWxlZCB0byB2YWxpZGF0ZSBlbmRwb2ludCBVUkwgXGAke2VuZHBvaW50fVxgYCk7CgkgIH0KCSAgY29uc3QgW18sCgkgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzCgkgIGhvc3Rpc2gsIHBvcnRXaXRoQ29sb24sIHJlc3RdID0gbWF0Y2hlczsKCSAgY29uc3QgcHJvdG9jb2wgPSBlbmRwb2ludC5zdGFydHNXaXRoKCdodHRwczonKSA/ICd3c3M6JyA6ICd3czonOwoJICBjb25zdCBzdGFydFBvcnQgPSBwb3J0V2l0aENvbG9uID09IG51bGwgPyBudWxsIDogcGFyc2VJbnQocG9ydFdpdGhDb2xvbi5zbGljZSgxKSwgMTApOwoJICBjb25zdCB3ZWJzb2NrZXRQb3J0ID0KCSAgLy8gT25seSBzaGlmdCB0aGUgcG9ydCBieSArMSBhcyBhIGNvbnZlbnRpb24gZm9yIHdzKHMpIG9ubHkgaWYgZ2l2ZW4gZW5kcG9pbnQKCSAgLy8gaXMgZXhwbGljaXRseSBzcGVjaWZ5aW5nIHRoZSBlbmRwb2ludCBwb3J0IChIVFRQLWJhc2VkIFJQQyksIGFzc3VtaW5nCgkgIC8vIHdlJ3JlIGRpcmVjdGx5IHRyeWluZyB0byBjb25uZWN0IHRvIGFnYXZlLXZhbGlkYXRvcidzIHdzIGxpc3RlbmluZyBwb3J0LgoJICAvLyBXaGVuIHRoZSBlbmRwb2ludCBvbWl0cyB0aGUgcG9ydCwgd2UncmUgY29ubmVjdGluZyB0byB0aGUgcHJvdG9jb2wKCSAgLy8gZGVmYXVsdCBwb3J0czogaHR0cCg4MCkgb3IgaHR0cHMoNDQzKSBhbmQgaXQncyBhc3N1bWVkIHdlJ3JlIGJlaGluZCBhIHJldmVyc2UKCSAgLy8gcHJveHkgd2hpY2ggbWFuYWdlcyBXZWJTb2NrZXQgdXBncmFkZSBhbmQgYmFja2VuZCBwb3J0IHJlZGlyZWN0aW9uLgoJICBzdGFydFBvcnQgPT0gbnVsbCA/ICcnIDogYDoke3N0YXJ0UG9ydCArIDF9YDsKCSAgcmV0dXJuIGAke3Byb3RvY29sfS8vJHtob3N0aXNofSR7d2Vic29ja2V0UG9ydH0ke3Jlc3R9YDsKCX0KCgljb25zdCBQdWJsaWNLZXlGcm9tU3RyaW5nID0gY29lcmNlKGluc3RhbmNlKFB1YmxpY0tleSksIHN0cmluZygpLCB2YWx1ZSA9PiBuZXcgUHVibGljS2V5KHZhbHVlKSk7Cgljb25zdCBSYXdBY2NvdW50RGF0YVJlc3VsdCA9IHR1cGxlKFtzdHJpbmcoKSwgbGl0ZXJhbCgnYmFzZTY0JyldKTsKCWNvbnN0IEJ1ZmZlckZyb21SYXdBY2NvdW50RGF0YSA9IGNvZXJjZShpbnN0YW5jZShidWZmZXJFeHBvcnRzLkJ1ZmZlciksIFJhd0FjY291bnREYXRhUmVzdWx0LCB2YWx1ZSA9PiBidWZmZXJFeHBvcnRzLkJ1ZmZlci5mcm9tKHZhbHVlWzBdLCAnYmFzZTY0JykpOwoKCS8qKgoJICogQXR0ZW1wdCB0byB1c2UgYSByZWNlbnQgYmxvY2toYXNoIGZvciB1cCB0byAzMCBzZWNvbmRzCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgQkxPQ0tIQVNIX0NBQ0hFX1RJTUVPVVRfTVMgPSAzMCAqIDEwMDA7CgoJLyoqCgkgKiBIQUNLLgoJICogQ29waWVkIGZyb20gcnBjLXdlYnNvY2tldHMvZGlzdC9saWIvY2xpZW50LgoJICogT3RoZXJ3aXNlLCBgeWFybiBidWlsZGAgZmFpbHMgd2l0aDoKCSAqIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL3N0ZXZlbHVzY2hlci9jMDU3ZWNhODFkNDc5ZWY3MDVjZGI1MzE2MmY5OTcxZAoJICovCgoJLyoqIEBpbnRlcm5hbCAqLwoJLyoqIEBpbnRlcm5hbCAqLwoJLyoqIEBpbnRlcm5hbCAqLwoJLyoqIEBpbnRlcm5hbCAqLwoKCS8qKiBAaW50ZXJuYWwgKi8KCS8qKgoJICogQGludGVybmFsCgkgKiBFdmVyeSBzdWJzY3JpcHRpb24gY29udGFpbnMgdGhlIGFyZ3MgdXNlZCB0byBvcGVuIHRoZSBzdWJzY3JpcHRpb24gd2l0aAoJICogdGhlIHNlcnZlciwgYW5kIGEgbGlzdCBvZiBjYWxsZXJzIGludGVyZXN0ZWQgaW4gbm90aWZpY2F0aW9ucy4KCSAqLwoKCS8qKgoJICogQGludGVybmFsCgkgKiBBIHN1YnNjcmlwdGlvbiBtYXkgYmUgaW4gdmFyaW91cyBzdGF0ZXMgb2YgY29ubmVjdGVkbmVzcy4gT25seSB3aGVuIGl0IGlzCgkgKiBmdWxseSBjb25uZWN0ZWQgd2lsbCBpdCBoYXZlIGEgc2VydmVyIHN1YnNjcmlwdGlvbiBpZCBhc3NvY2lhdGVkIHdpdGggaXQuCgkgKiBUaGlzIGlkIGNhbiBiZSByZXR1cm5lZCB0byB0aGUgc2VydmVyIHRvIHVuc3Vic2NyaWJlIHRoZSBjbGllbnQgZW50aXJlbHkuCgkgKi8KCgkvKioKCSAqIEEgdHlwZSB0aGF0IGVuY2Fwc3VsYXRlcyBhIHN1YnNjcmlwdGlvbidzIFJQQyBtZXRob2QKCSAqIG5hbWVzIGFuZCBub3RpZmljYXRpb24gKGNhbGxiYWNrKSBzaWduYXR1cmUuCgkgKi8KCgkvKioKCSAqIEBpbnRlcm5hbAoJICogVXRpbGl0eSB0eXBlIHRoYXQga2VlcHMgdGFnZ2VkIHVuaW9ucyBpbnRhY3Qgd2hpbGUgb21pdHRpbmcgcHJvcGVydGllcy4KCSAqLwoKCS8qKgoJICogQGludGVybmFsCgkgKiBUaGlzIHR5cGUgcmVwcmVzZW50cyBhIHNpbmdsZSBzdWJzY3JpYmFibGUgJ3RvcGljLicgSXQncyBtYWRlIHVwIG9mOgoJICoKCSAqIC0gVGhlIGFyZ3MgdXNlZCB0byBvcGVuIHRoZSBzdWJzY3JpcHRpb24gd2l0aCB0aGUgc2VydmVyLAoJICogLSBUaGUgc3RhdGUgb2YgdGhlIHN1YnNjcmlwdGlvbiwgaW4gdGVybXMgb2YgaXRzIGNvbm5lY3RlZG5lc3MsIGFuZAoJICogLSBUaGUgc2V0IG9mIGNhbGxiYWNrcyB0byBjYWxsIHdoZW4gdGhlIHNlcnZlciBwdWJsaXNoZXMgbm90aWZpY2F0aW9ucwoJICoKCSAqIFRoaXMgcmVjb3JkIGdldHMgaW5kZXhlZCBieSBgU3Vic2NyaXB0aW9uQ29uZmlnSGFzaGAgYW5kIGlzIHVzZWQgdG8KCSAqIHNldCB1cCBzdWJzY3JpcHRpb25zLCBmYW4gb3V0IG5vdGlmaWNhdGlvbnMsIGFuZCB0cmFjayBzdWJzY3JpcHRpb24gc3RhdGUuCgkgKi8KCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCgoJLyoqCgkgKiBFeHRyYSBjb250ZXh0dWFsIGluZm9ybWF0aW9uIGZvciBSUEMgcmVzcG9uc2VzCgkgKi8KCgkvKioKCSAqIE9wdGlvbnMgZm9yIHNlbmRpbmcgdHJhbnNhY3Rpb25zCgkgKi8KCgkvKioKCSAqIE9wdGlvbnMgZm9yIGNvbmZpcm1pbmcgdHJhbnNhY3Rpb25zCgkgKi8KCgkvKioKCSAqIE9wdGlvbnMgZm9yIGdldENvbmZpcm1lZFNpZ25hdHVyZXNGb3JBZGRyZXNzMgoJICovCgoJLyoqCgkgKiBPcHRpb25zIGZvciBnZXRTaWduYXR1cmVzRm9yQWRkcmVzcwoJICovCgoJLyoqCgkgKiBSUEMgUmVzcG9uc2Ugd2l0aCBleHRyYSBjb250ZXh0dWFsIGluZm9ybWF0aW9uCgkgKi8KCgkvKioKCSAqIEEgc3RyYXRlZ3kgZm9yIGNvbmZpcm1pbmcgdHJhbnNhY3Rpb25zIHRoYXQgdXNlcyB0aGUgbGFzdCB2YWxpZAoJICogYmxvY2sgaGVpZ2h0IGZvciBhIGdpdmVuIGJsb2NraGFzaCB0byBjaGVjayBmb3IgdHJhbnNhY3Rpb24gZXhwaXJhdGlvbi4KCSAqLwoKCS8qKgoJICogQSBzdHJhdGVneSBmb3IgY29uZmlybWluZyBkdXJhYmxlIG5vbmNlIHRyYW5zYWN0aW9ucy4KCSAqLwoKCS8qKgoJICogUHJvcGVydGllcyBzaGFyZWQgYnkgYWxsIHRyYW5zYWN0aW9uIGNvbmZpcm1hdGlvbiBzdHJhdGVnaWVzCgkgKi8KCgkvKioKCSAqIFRoaXMgdHlwZSByZXByZXNlbnRzIGFsbCB0cmFuc2FjdGlvbiBjb25maXJtYXRpb24gc3RyYXRlZ2llcwoJICovCgoJLyogQGludGVybmFsICovCglmdW5jdGlvbiBhc3NlcnRFbmRwb2ludFVybChwdXRhdGl2ZVVybCkgewoJICBpZiAoL15odHRwcz86Ly50ZXN0KHB1dGF0aXZlVXJsKSA9PT0gZmFsc2UpIHsKCSAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdFbmRwb2ludCBVUkwgbXVzdCBzdGFydCB3aXRoIGBodHRwOmAgb3IgYGh0dHBzOmAuJyk7CgkgIH0KCSAgcmV0dXJuIHB1dGF0aXZlVXJsOwoJfQoKCS8qKiBAaW50ZXJuYWwgKi8KCWZ1bmN0aW9uIGV4dHJhY3RDb21taXRtZW50RnJvbUNvbmZpZyhjb21taXRtZW50T3JDb25maWcpIHsKCSAgbGV0IGNvbW1pdG1lbnQ7CgkgIGxldCBjb25maWc7CgkgIGlmICh0eXBlb2YgY29tbWl0bWVudE9yQ29uZmlnID09PSAnc3RyaW5nJykgewoJICAgIGNvbW1pdG1lbnQgPSBjb21taXRtZW50T3JDb25maWc7CgkgIH0gZWxzZSBpZiAoY29tbWl0bWVudE9yQ29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudDogc3BlY2lmaWVkQ29tbWl0bWVudCwKCSAgICAgIC4uLnNwZWNpZmllZENvbmZpZwoJICAgIH0gPSBjb21taXRtZW50T3JDb25maWc7CgkgICAgY29tbWl0bWVudCA9IHNwZWNpZmllZENvbW1pdG1lbnQ7CgkgICAgY29uZmlnID0gc3BlY2lmaWVkQ29uZmlnOwoJICB9CgkgIHJldHVybiB7CgkgICAgY29tbWl0bWVudCwKCSAgICBjb25maWcKCSAgfTsKCX0KCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCglmdW5jdGlvbiBhcHBseURlZmF1bHRNZW1jbXBFbmNvZGluZ1RvRmlsdGVycyhmaWx0ZXJzKSB7CgkgIHJldHVybiBmaWx0ZXJzLm1hcChmaWx0ZXIgPT4gJ21lbWNtcCcgaW4gZmlsdGVyID8gewoJICAgIC4uLmZpbHRlciwKCSAgICBtZW1jbXA6IHsKCSAgICAgIC4uLmZpbHRlci5tZW1jbXAsCgkgICAgICBlbmNvZGluZzogZmlsdGVyLm1lbWNtcC5lbmNvZGluZyA/PyAnYmFzZTU4JwoJICAgIH0KCSAgfSA6IGZpbHRlcik7Cgl9CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJZnVuY3Rpb24gY3JlYXRlUnBjUmVzdWx0KHJlc3VsdCkgewoJICByZXR1cm4gdW5pb24oW3R5cGUoewoJICAgIGpzb25ycGM6IGxpdGVyYWwoJzIuMCcpLAoJICAgIGlkOiBzdHJpbmcoKSwKCSAgICByZXN1bHQKCSAgfSksIHR5cGUoewoJICAgIGpzb25ycGM6IGxpdGVyYWwoJzIuMCcpLAoJICAgIGlkOiBzdHJpbmcoKSwKCSAgICBlcnJvcjogdHlwZSh7CgkgICAgICBjb2RlOiB1bmtub3duKCksCgkgICAgICBtZXNzYWdlOiBzdHJpbmcoKSwKCSAgICAgIGRhdGE6IG9wdGlvbmFsKGFueSgpKQoJICAgIH0pCgkgIH0pXSk7Cgl9Cgljb25zdCBVbmtub3duUnBjUmVzdWx0ID0gY3JlYXRlUnBjUmVzdWx0KHVua25vd24oKSk7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJZnVuY3Rpb24ganNvblJwY1Jlc3VsdChzY2hlbWEpIHsKCSAgcmV0dXJuIGNvZXJjZShjcmVhdGVScGNSZXN1bHQoc2NoZW1hKSwgVW5rbm93blJwY1Jlc3VsdCwgdmFsdWUgPT4gewoJICAgIGlmICgnZXJyb3InIGluIHZhbHVlKSB7CgkgICAgICByZXR1cm4gdmFsdWU7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiB7CgkgICAgICAgIC4uLnZhbHVlLAoJICAgICAgICByZXN1bHQ6IGNyZWF0ZSh2YWx1ZS5yZXN1bHQsIHNjaGVtYSkKCSAgICAgIH07CgkgICAgfQoJICB9KTsKCX0KCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCglmdW5jdGlvbiBqc29uUnBjUmVzdWx0QW5kQ29udGV4dCh2YWx1ZSkgewoJICByZXR1cm4ganNvblJwY1Jlc3VsdCh0eXBlKHsKCSAgICBjb250ZXh0OiB0eXBlKHsKCSAgICAgIHNsb3Q6IG51bWJlcigpCgkgICAgfSksCgkgICAgdmFsdWUKCSAgfSkpOwoJfQoKCS8qKgoJICogQGludGVybmFsCgkgKi8KCWZ1bmN0aW9uIG5vdGlmaWNhdGlvblJlc3VsdEFuZENvbnRleHQodmFsdWUpIHsKCSAgcmV0dXJuIHR5cGUoewoJICAgIGNvbnRleHQ6IHR5cGUoewoJICAgICAgc2xvdDogbnVtYmVyKCkKCSAgICB9KSwKCSAgICB2YWx1ZQoJICB9KTsKCX0KCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCglmdW5jdGlvbiB2ZXJzaW9uZWRNZXNzYWdlRnJvbVJlc3BvbnNlKHZlcnNpb24sIHJlc3BvbnNlKSB7CgkgIGlmICh2ZXJzaW9uID09PSAwKSB7CgkgICAgcmV0dXJuIG5ldyBNZXNzYWdlVjAoewoJICAgICAgaGVhZGVyOiByZXNwb25zZS5oZWFkZXIsCgkgICAgICBzdGF0aWNBY2NvdW50S2V5czogcmVzcG9uc2UuYWNjb3VudEtleXMubWFwKGFjY291bnRLZXkgPT4gbmV3IFB1YmxpY0tleShhY2NvdW50S2V5KSksCgkgICAgICByZWNlbnRCbG9ja2hhc2g6IHJlc3BvbnNlLnJlY2VudEJsb2NraGFzaCwKCSAgICAgIGNvbXBpbGVkSW5zdHJ1Y3Rpb25zOiByZXNwb25zZS5pbnN0cnVjdGlvbnMubWFwKGl4ID0+ICh7CgkgICAgICAgIHByb2dyYW1JZEluZGV4OiBpeC5wcm9ncmFtSWRJbmRleCwKCSAgICAgICAgYWNjb3VudEtleUluZGV4ZXM6IGl4LmFjY291bnRzLAoJICAgICAgICBkYXRhOiBiczU4LmRlY29kZShpeC5kYXRhKQoJICAgICAgfSkpLAoJICAgICAgYWRkcmVzc1RhYmxlTG9va3VwczogcmVzcG9uc2UuYWRkcmVzc1RhYmxlTG9va3VwcwoJICAgIH0pOwoJICB9IGVsc2UgewoJICAgIHJldHVybiBuZXcgTWVzc2FnZShyZXNwb25zZSk7CgkgIH0KCX0KCgkvKioKCSAqIFRoZSBsZXZlbCBvZiBjb21taXRtZW50IGRlc2lyZWQgd2hlbiBxdWVyeWluZyBzdGF0ZQoJICogPHByZT4KCSAqICAgJ3Byb2Nlc3NlZCc6IFF1ZXJ5IHRoZSBtb3N0IHJlY2VudCBibG9jayB3aGljaCBoYXMgcmVhY2hlZCAxIGNvbmZpcm1hdGlvbiBieSB0aGUgY29ubmVjdGVkIG5vZGUKCSAqICAgJ2NvbmZpcm1lZCc6IFF1ZXJ5IHRoZSBtb3N0IHJlY2VudCBibG9jayB3aGljaCBoYXMgcmVhY2hlZCAxIGNvbmZpcm1hdGlvbiBieSB0aGUgY2x1c3RlcgoJICogICAnZmluYWxpemVkJzogUXVlcnkgdGhlIG1vc3QgcmVjZW50IGJsb2NrIHdoaWNoIGhhcyBiZWVuIGZpbmFsaXplZCBieSB0aGUgY2x1c3RlcgoJICogPC9wcmU+CgkgKi8KCgkvLyBEZXByZWNhdGVkIGFzIG9mIHYxLjUuNQoKCS8qKgoJICogQSBzdWJzZXQgb2YgQ29tbWl0bWVudCBsZXZlbHMsIHdoaWNoIGFyZSBhdCBsZWFzdCBvcHRpbWlzdGljYWxseSBjb25maXJtZWQKCSAqIDxwcmU+CgkgKiAgICdjb25maXJtZWQnOiBRdWVyeSB0aGUgbW9zdCByZWNlbnQgYmxvY2sgd2hpY2ggaGFzIHJlYWNoZWQgMSBjb25maXJtYXRpb24gYnkgdGhlIGNsdXN0ZXIKCSAqICAgJ2ZpbmFsaXplZCc6IFF1ZXJ5IHRoZSBtb3N0IHJlY2VudCBibG9jayB3aGljaCBoYXMgYmVlbiBmaW5hbGl6ZWQgYnkgdGhlIGNsdXN0ZXIKCSAqIDwvcHJlPgoJICovCgoJLyoqCgkgKiBGaWx0ZXIgZm9yIGxhcmdlc3QgYWNjb3VudHMgcXVlcnkKCSAqIDxwcmU+CgkgKiAgICdjaXJjdWxhdGluZyc6ICAgIFJldHVybiB0aGUgbGFyZ2VzdCBhY2NvdW50cyB0aGF0IGFyZSBwYXJ0IG9mIHRoZSBjaXJjdWxhdGluZyBzdXBwbHkKCSAqICAgJ25vbkNpcmN1bGF0aW5nJzogUmV0dXJuIHRoZSBsYXJnZXN0IGFjY291bnRzIHRoYXQgYXJlIG5vdCBwYXJ0IG9mIHRoZSBjaXJjdWxhdGluZyBzdXBwbHkKCSAqIDwvcHJlPgoJICovCgoJLyoqCgkgKiBDb25maWd1cmF0aW9uIG9iamVjdCBmb3IgY2hhbmdpbmcgYGdldEFjY291bnRJbmZvYCBxdWVyeSBiZWhhdmlvcgoJICovCgoJLyoqCgkgKiBDb25maWd1cmF0aW9uIG9iamVjdCBmb3IgY2hhbmdpbmcgYGdldEJhbGFuY2VgIHF1ZXJ5IGJlaGF2aW9yCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBjaGFuZ2luZyBgZ2V0QmxvY2tgIHF1ZXJ5IGJlaGF2aW9yCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBjaGFuZ2luZyBgZ2V0QmxvY2tgIHF1ZXJ5IGJlaGF2aW9yCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBjaGFuZ2luZyBgZ2V0U3Rha2VNaW5pbXVtRGVsZWdhdGlvbmAgcXVlcnkgYmVoYXZpb3IKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGNoYW5naW5nIGBnZXRCbG9ja0hlaWdodGAgcXVlcnkgYmVoYXZpb3IKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGNoYW5naW5nIGBnZXRFcG9jaEluZm9gIHF1ZXJ5IGJlaGF2aW9yCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBjaGFuZ2luZyBgZ2V0SW5mbGF0aW9uUmV3YXJkYCBxdWVyeSBiZWhhdmlvcgoJICovCgoJLyoqCgkgKiBDb25maWd1cmF0aW9uIG9iamVjdCBmb3IgY2hhbmdpbmcgYGdldExhdGVzdEJsb2NraGFzaGAgcXVlcnkgYmVoYXZpb3IKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGNoYW5naW5nIGBpc0Jsb2NraGFzaFZhbGlkYCBxdWVyeSBiZWhhdmlvcgoJICovCgoJLyoqCgkgKiBDb25maWd1cmF0aW9uIG9iamVjdCBmb3IgY2hhbmdpbmcgYGdldFNsb3RgIHF1ZXJ5IGJlaGF2aW9yCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBjaGFuZ2luZyBgZ2V0U2xvdExlYWRlcmAgcXVlcnkgYmVoYXZpb3IKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGNoYW5naW5nIGBnZXRUcmFuc2FjdGlvbmAgcXVlcnkgYmVoYXZpb3IKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGNoYW5naW5nIGBnZXRUcmFuc2FjdGlvbmAgcXVlcnkgYmVoYXZpb3IKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGNoYW5naW5nIGBnZXRMYXJnZXN0QWNjb3VudHNgIHF1ZXJ5IGJlaGF2aW9yCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBjaGFuZ2luZyBgZ2V0U3VwcGx5YCByZXF1ZXN0IGJlaGF2aW9yCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBjaGFuZ2luZyBxdWVyeSBiZWhhdmlvcgoJICovCgoJLyoqCgkgKiBJbmZvcm1hdGlvbiBkZXNjcmliaW5nIGEgY2x1c3RlciBub2RlCgkgKi8KCgkvKioKCSAqIEluZm9ybWF0aW9uIGRlc2NyaWJpbmcgYSB2b3RlIGFjY291bnQKCSAqLwoKCS8qKgoJICogQSBjb2xsZWN0aW9uIG9mIGNsdXN0ZXIgdm90ZSBhY2NvdW50cwoJICovCgoJLyoqCgkgKiBOZXR3b3JrIEluZmxhdGlvbgoJICogKHNlZSBodHRwczovL2RvY3Muc29sYW5hLmNvbS9pbXBsZW1lbnRlZC1wcm9wb3NhbHMvZWRfb3ZlcnZpZXcpCgkgKi8KCgljb25zdCBHZXRJbmZsYXRpb25Hb3Zlcm5vclJlc3VsdCA9IHR5cGUoewoJICBmb3VuZGF0aW9uOiBudW1iZXIoKSwKCSAgZm91bmRhdGlvblRlcm06IG51bWJlcigpLAoJICBpbml0aWFsOiBudW1iZXIoKSwKCSAgdGFwZXI6IG51bWJlcigpLAoJICB0ZXJtaW5hbDogbnVtYmVyKCkKCX0pOwoKCS8qKgoJICogVGhlIGluZmxhdGlvbiByZXdhcmQgZm9yIGFuIGVwb2NoCgkgKi8KCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldEluZmxhdGlvblJld2FyZCIgbWVzc2FnZQoJICovCgljb25zdCBHZXRJbmZsYXRpb25SZXdhcmRSZXN1bHQgPSBqc29uUnBjUmVzdWx0KGFycmF5KG51bGxhYmxlKHR5cGUoewoJICBlcG9jaDogbnVtYmVyKCksCgkgIGVmZmVjdGl2ZVNsb3Q6IG51bWJlcigpLAoJICBhbW91bnQ6IG51bWJlcigpLAoJICBwb3N0QmFsYW5jZTogbnVtYmVyKCksCgkgIGNvbW1pc3Npb246IG9wdGlvbmFsKG51bGxhYmxlKG51bWJlcigpKSkKCX0pKSkpOwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGNoYW5naW5nIGBnZXRSZWNlbnRQcmlvcml0aXphdGlvbkZlZXNgIHF1ZXJ5IGJlaGF2aW9yCgkgKi8KCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldFJlY2VudFByaW9yaXRpemF0aW9uRmVlcyIgbWVzc2FnZQoJICovCgljb25zdCBHZXRSZWNlbnRQcmlvcml0aXphdGlvbkZlZXNSZXN1bHQgPSBhcnJheSh0eXBlKHsKCSAgc2xvdDogbnVtYmVyKCksCgkgIHByaW9yaXRpemF0aW9uRmVlOiBudW1iZXIoKQoJfSkpOwoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJnZXRJbmZsYXRpb25SYXRlIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldEluZmxhdGlvblJhdGVSZXN1bHQgPSB0eXBlKHsKCSAgdG90YWw6IG51bWJlcigpLAoJICB2YWxpZGF0b3I6IG51bWJlcigpLAoJICBmb3VuZGF0aW9uOiBudW1iZXIoKSwKCSAgZXBvY2g6IG51bWJlcigpCgl9KTsKCgkvKioKCSAqIEluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IGVwb2NoCgkgKi8KCgljb25zdCBHZXRFcG9jaEluZm9SZXN1bHQgPSB0eXBlKHsKCSAgZXBvY2g6IG51bWJlcigpLAoJICBzbG90SW5kZXg6IG51bWJlcigpLAoJICBzbG90c0luRXBvY2g6IG51bWJlcigpLAoJICBhYnNvbHV0ZVNsb3Q6IG51bWJlcigpLAoJICBibG9ja0hlaWdodDogb3B0aW9uYWwobnVtYmVyKCkpLAoJICB0cmFuc2FjdGlvbkNvdW50OiBvcHRpb25hbChudW1iZXIoKSkKCX0pOwoJY29uc3QgR2V0RXBvY2hTY2hlZHVsZVJlc3VsdCA9IHR5cGUoewoJICBzbG90c1BlckVwb2NoOiBudW1iZXIoKSwKCSAgbGVhZGVyU2NoZWR1bGVTbG90T2Zmc2V0OiBudW1iZXIoKSwKCSAgd2FybXVwOiBib29sZWFuKCksCgkgIGZpcnN0Tm9ybWFsRXBvY2g6IG51bWJlcigpLAoJICBmaXJzdE5vcm1hbFNsb3Q6IG51bWJlcigpCgl9KTsKCgkvKioKCSAqIExlYWRlciBzY2hlZHVsZQoJICogKHNlZSBodHRwczovL2RvY3Muc29sYW5hLmNvbS90ZXJtaW5vbG9neSNsZWFkZXItc2NoZWR1bGUpCgkgKi8KCgljb25zdCBHZXRMZWFkZXJTY2hlZHVsZVJlc3VsdCA9IHJlY29yZChzdHJpbmcoKSwgYXJyYXkobnVtYmVyKCkpKTsKCgkvKioKCSAqIFRyYW5zYWN0aW9uIGVycm9yIG9yIG51bGwKCSAqLwoJY29uc3QgVHJhbnNhY3Rpb25FcnJvclJlc3VsdCA9IG51bGxhYmxlKHVuaW9uKFt0eXBlKHt9KSwgc3RyaW5nKCldKSk7CgoJLyoqCgkgKiBTaWduYXR1cmUgc3RhdHVzIGZvciBhIHRyYW5zYWN0aW9uCgkgKi8KCWNvbnN0IFNpZ25hdHVyZVN0YXR1c1Jlc3VsdCA9IHR5cGUoewoJICBlcnI6IFRyYW5zYWN0aW9uRXJyb3JSZXN1bHQKCX0pOwoKCS8qKgoJICogVHJhbnNhY3Rpb24gc2lnbmF0dXJlIHJlY2VpdmVkIG5vdGlmaWNhdGlvbgoJICovCgljb25zdCBTaWduYXR1cmVSZWNlaXZlZFJlc3VsdCA9IGxpdGVyYWwoJ3JlY2VpdmVkU2lnbmF0dXJlJyk7CgoJLyoqCgkgKiBWZXJzaW9uIGluZm8gZm9yIGEgbm9kZQoJICovCgoJY29uc3QgVmVyc2lvblJlc3VsdCA9IHR5cGUoewoJICAnc29sYW5hLWNvcmUnOiBzdHJpbmcoKSwKCSAgJ2ZlYXR1cmUtc2V0Jzogb3B0aW9uYWwobnVtYmVyKCkpCgl9KTsKCWNvbnN0IFBhcnNlZEluc3RydWN0aW9uU3RydWN0ID0gdHlwZSh7CgkgIHByb2dyYW06IHN0cmluZygpLAoJICBwcm9ncmFtSWQ6IFB1YmxpY0tleUZyb21TdHJpbmcsCgkgIHBhcnNlZDogdW5rbm93bigpCgl9KTsKCWNvbnN0IFBhcnRpYWxseURlY29kZWRJbnN0cnVjdGlvblN0cnVjdCA9IHR5cGUoewoJICBwcm9ncmFtSWQ6IFB1YmxpY0tleUZyb21TdHJpbmcsCgkgIGFjY291bnRzOiBhcnJheShQdWJsaWNLZXlGcm9tU3RyaW5nKSwKCSAgZGF0YTogc3RyaW5nKCkKCX0pOwoJY29uc3QgU2ltdWxhdGVkVHJhbnNhY3Rpb25SZXNwb25zZVN0cnVjdCA9IGpzb25ScGNSZXN1bHRBbmRDb250ZXh0KHR5cGUoewoJICBlcnI6IG51bGxhYmxlKHVuaW9uKFt0eXBlKHt9KSwgc3RyaW5nKCldKSksCgkgIGxvZ3M6IG51bGxhYmxlKGFycmF5KHN0cmluZygpKSksCgkgIGFjY291bnRzOiBvcHRpb25hbChudWxsYWJsZShhcnJheShudWxsYWJsZSh0eXBlKHsKCSAgICBleGVjdXRhYmxlOiBib29sZWFuKCksCgkgICAgb3duZXI6IHN0cmluZygpLAoJICAgIGxhbXBvcnRzOiBudW1iZXIoKSwKCSAgICBkYXRhOiBhcnJheShzdHJpbmcoKSksCgkgICAgcmVudEVwb2NoOiBvcHRpb25hbChudW1iZXIoKSkKCSAgfSkpKSkpLAoJICB1bml0c0NvbnN1bWVkOiBvcHRpb25hbChudW1iZXIoKSksCgkgIHJldHVybkRhdGE6IG9wdGlvbmFsKG51bGxhYmxlKHR5cGUoewoJICAgIHByb2dyYW1JZDogc3RyaW5nKCksCgkgICAgZGF0YTogdHVwbGUoW3N0cmluZygpLCBsaXRlcmFsKCdiYXNlNjQnKV0pCgkgIH0pKSksCgkgIGlubmVySW5zdHJ1Y3Rpb25zOiBvcHRpb25hbChudWxsYWJsZShhcnJheSh0eXBlKHsKCSAgICBpbmRleDogbnVtYmVyKCksCgkgICAgaW5zdHJ1Y3Rpb25zOiBhcnJheSh1bmlvbihbUGFyc2VkSW5zdHJ1Y3Rpb25TdHJ1Y3QsIFBhcnRpYWxseURlY29kZWRJbnN0cnVjdGlvblN0cnVjdF0pKQoJICB9KSkpKQoJfSkpOwoKCS8qKgoJICogTWV0YWRhdGEgZm9yIGEgcGFyc2VkIGNvbmZpcm1lZCB0cmFuc2FjdGlvbiBvbiB0aGUgbGVkZ2VyCgkgKgoJICogQGRlcHJlY2F0ZWQgRGVwcmVjYXRlZCBzaW5jZSBSUEMgdjEuOC4wLiBQbGVhc2UgdXNlIHtAbGluayBQYXJzZWRUcmFuc2FjdGlvbk1ldGF9IGluc3RlYWQuCgkgKi8KCgkvKioKCSAqIENvbGxlY3Rpb24gb2YgYWRkcmVzc2VzIGxvYWRlZCBieSBhIHRyYW5zYWN0aW9uIHVzaW5nIGFkZHJlc3MgdGFibGUgbG9va3VwcwoJICovCgoJLyoqCgkgKiBNZXRhZGF0YSBmb3IgYSBwYXJzZWQgdHJhbnNhY3Rpb24gb24gdGhlIGxlZGdlcgoJICovCgoJLyoqCgkgKiBNZXRhZGF0YSBmb3IgYSBjb25maXJtZWQgdHJhbnNhY3Rpb24gb24gdGhlIGxlZGdlcgoJICovCgoJLyoqCgkgKiBBIHByb2Nlc3NlZCB0cmFuc2FjdGlvbiBmcm9tIHRoZSBSUEMgQVBJCgkgKi8KCgkvKioKCSAqIEEgcHJvY2Vzc2VkIHRyYW5zYWN0aW9uIGZyb20gdGhlIFJQQyBBUEkKCSAqLwoKCS8qKgoJICogQSBwcm9jZXNzZWQgdHJhbnNhY3Rpb24gbWVzc2FnZSBmcm9tIHRoZSBSUEMgQVBJCgkgKi8KCgkvKioKCSAqIEEgY29uZmlybWVkIHRyYW5zYWN0aW9uIG9uIHRoZSBsZWRnZXIKCSAqCgkgKiBAZGVwcmVjYXRlZCBEZXByZWNhdGVkIHNpbmNlIFJQQyB2MS44LjAuCgkgKi8KCgkvKioKCSAqIEEgcGFydGlhbGx5IGRlY29kZWQgdHJhbnNhY3Rpb24gaW5zdHJ1Y3Rpb24KCSAqLwoKCS8qKgoJICogQSBwYXJzZWQgdHJhbnNhY3Rpb24gbWVzc2FnZSBhY2NvdW50CgkgKi8KCgkvKioKCSAqIEEgcGFyc2VkIHRyYW5zYWN0aW9uIGluc3RydWN0aW9uCgkgKi8KCgkvKioKCSAqIEEgcGFyc2VkIGFkZHJlc3MgdGFibGUgbG9va3VwCgkgKi8KCgkvKioKCSAqIEEgcGFyc2VkIHRyYW5zYWN0aW9uIG1lc3NhZ2UKCSAqLwoKCS8qKgoJICogQSBwYXJzZWQgdHJhbnNhY3Rpb24KCSAqLwoKCS8qKgoJICogQSBwYXJzZWQgYW5kIGNvbmZpcm1lZCB0cmFuc2FjdGlvbiBvbiB0aGUgbGVkZ2VyCgkgKgoJICogQGRlcHJlY2F0ZWQgRGVwcmVjYXRlZCBzaW5jZSBSUEMgdjEuOC4wLiBQbGVhc2UgdXNlIHtAbGluayBQYXJzZWRUcmFuc2FjdGlvbldpdGhNZXRhfSBpbnN0ZWFkLgoJICovCgoJLyoqCgkgKiBBIHBhcnNlZCB0cmFuc2FjdGlvbiBvbiB0aGUgbGVkZ2VyIHdpdGggbWV0YQoJICovCgoJLyoqCgkgKiBBIHByb2Nlc3NlZCBibG9jayBmZXRjaGVkIGZyb20gdGhlIFJQQyBBUEkKCSAqLwoKCS8qKgoJICogQSBwcm9jZXNzZWQgYmxvY2sgZmV0Y2hlZCBmcm9tIHRoZSBSUEMgQVBJIHdoZXJlIHRoZSBgdHJhbnNhY3Rpb25EZXRhaWxzYCBtb2RlIGlzIGBhY2NvdW50c2AKCSAqLwoKCS8qKgoJICogQSBwcm9jZXNzZWQgYmxvY2sgZmV0Y2hlZCBmcm9tIHRoZSBSUEMgQVBJIHdoZXJlIHRoZSBgdHJhbnNhY3Rpb25EZXRhaWxzYCBtb2RlIGlzIGBub25lYAoJICovCgoJLyoqCgkgKiBBIGJsb2NrIHdpdGggcGFyc2VkIHRyYW5zYWN0aW9ucwoJICovCgoJLyoqCgkgKiBBIGJsb2NrIHdpdGggcGFyc2VkIHRyYW5zYWN0aW9ucyB3aGVyZSB0aGUgYHRyYW5zYWN0aW9uRGV0YWlsc2AgbW9kZSBpcyBgYWNjb3VudHNgCgkgKi8KCgkvKioKCSAqIEEgYmxvY2sgd2l0aCBwYXJzZWQgdHJhbnNhY3Rpb25zIHdoZXJlIHRoZSBgdHJhbnNhY3Rpb25EZXRhaWxzYCBtb2RlIGlzIGBub25lYAoJICovCgoJLyoqCgkgKiBBIHByb2Nlc3NlZCBibG9jayBmZXRjaGVkIGZyb20gdGhlIFJQQyBBUEkKCSAqLwoKCS8qKgoJICogQSBwcm9jZXNzZWQgYmxvY2sgZmV0Y2hlZCBmcm9tIHRoZSBSUEMgQVBJIHdoZXJlIHRoZSBgdHJhbnNhY3Rpb25EZXRhaWxzYCBtb2RlIGlzIGBhY2NvdW50c2AKCSAqLwoKCS8qKgoJICogQSBwcm9jZXNzZWQgYmxvY2sgZmV0Y2hlZCBmcm9tIHRoZSBSUEMgQVBJIHdoZXJlIHRoZSBgdHJhbnNhY3Rpb25EZXRhaWxzYCBtb2RlIGlzIGBub25lYAoJICovCgoJLyoqCgkgKiBBIGNvbmZpcm1lZCBibG9jayBvbiB0aGUgbGVkZ2VyCgkgKgoJICogQGRlcHJlY2F0ZWQgRGVwcmVjYXRlZCBzaW5jZSBSUEMgdjEuOC4wLgoJICovCgoJLyoqCgkgKiBBIEJsb2NrIG9uIHRoZSBsZWRnZXIgd2l0aCBzaWduYXR1cmVzIG9ubHkKCSAqLwoKCS8qKgoJICogcmVjZW50IGJsb2NrIHByb2R1Y3Rpb24gaW5mb3JtYXRpb24KCSAqLwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0QmxvY2tQcm9kdWN0aW9uIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEJsb2NrUHJvZHVjdGlvblJlc3BvbnNlU3RydWN0ID0ganNvblJwY1Jlc3VsdEFuZENvbnRleHQodHlwZSh7CgkgIGJ5SWRlbnRpdHk6IHJlY29yZChzdHJpbmcoKSwgYXJyYXkobnVtYmVyKCkpKSwKCSAgcmFuZ2U6IHR5cGUoewoJICAgIGZpcnN0U2xvdDogbnVtYmVyKCksCgkgICAgbGFzdFNsb3Q6IG51bWJlcigpCgkgIH0pCgl9KSk7CgoJLyoqCgkgKiBBIHBlcmZvcm1hbmNlIHNhbXBsZQoJICovCgoJZnVuY3Rpb24gY3JlYXRlUnBjQ2xpZW50KHVybCwgaHR0cEhlYWRlcnMsIGN1c3RvbUZldGNoLCBmZXRjaE1pZGRsZXdhcmUsIGRpc2FibGVSZXRyeU9uUmF0ZUxpbWl0LCBodHRwQWdlbnQpIHsKCSAgY29uc3QgZmV0Y2ggPSBjdXN0b21GZXRjaCA/IGN1c3RvbUZldGNoIDogZmV0Y2hJbXBsOwoJICBsZXQgYWdlbnQ7CgkgIHsKCSAgICBpZiAoaHR0cEFnZW50ICE9IG51bGwpIHsKCSAgICAgIGNvbnNvbGUud2FybignWW91IGhhdmUgc3VwcGxpZWQgYW4gYGh0dHBBZ2VudGAgd2hlbiBjcmVhdGluZyBhIGBDb25uZWN0aW9uYCBpbiBhIGJyb3dzZXIgZW52aXJvbm1lbnQuJyArICdJdCBoYXMgYmVlbiBpZ25vcmVkOyBgaHR0cEFnZW50YCBpcyBvbmx5IHVzZWQgaW4gTm9kZSBlbnZpcm9ubWVudHMuJyk7CgkgICAgfQoJICB9CgkgIGxldCBmZXRjaFdpdGhNaWRkbGV3YXJlOwoJICBpZiAoZmV0Y2hNaWRkbGV3YXJlKSB7CgkgICAgZmV0Y2hXaXRoTWlkZGxld2FyZSA9IGFzeW5jIChpbmZvLCBpbml0KSA9PiB7CgkgICAgICBjb25zdCBtb2RpZmllZEZldGNoQXJncyA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCSAgICAgICAgdHJ5IHsKCSAgICAgICAgICBmZXRjaE1pZGRsZXdhcmUoaW5mbywgaW5pdCwgKG1vZGlmaWVkSW5mbywgbW9kaWZpZWRJbml0KSA9PiByZXNvbHZlKFttb2RpZmllZEluZm8sIG1vZGlmaWVkSW5pdF0pKTsKCSAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKCSAgICAgICAgICByZWplY3QoZXJyb3IpOwoJICAgICAgICB9CgkgICAgICB9KTsKCSAgICAgIHJldHVybiBhd2FpdCBmZXRjaCguLi5tb2RpZmllZEZldGNoQXJncyk7CgkgICAgfTsKCSAgfQoJICBjb25zdCBjbGllbnRCcm93c2VyID0gbmV3IFJwY0NsaWVudChhc3luYyAocmVxdWVzdCwgY2FsbGJhY2spID0+IHsKCSAgICBjb25zdCBvcHRpb25zID0gewoJICAgICAgbWV0aG9kOiAnUE9TVCcsCgkgICAgICBib2R5OiByZXF1ZXN0LAoJICAgICAgYWdlbnQsCgkgICAgICBoZWFkZXJzOiBPYmplY3QuYXNzaWduKHsKCSAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJwoJICAgICAgfSwgaHR0cEhlYWRlcnMgfHwge30sIENPTU1PTl9IVFRQX0hFQURFUlMpCgkgICAgfTsKCSAgICB0cnkgewoJICAgICAgbGV0IHRvb19tYW55X3JlcXVlc3RzX3JldHJpZXMgPSA1OwoJICAgICAgbGV0IHJlczsKCSAgICAgIGxldCB3YWl0VGltZSA9IDUwMDsKCSAgICAgIGZvciAoOzspIHsKCSAgICAgICAgaWYgKGZldGNoV2l0aE1pZGRsZXdhcmUpIHsKCSAgICAgICAgICByZXMgPSBhd2FpdCBmZXRjaFdpdGhNaWRkbGV3YXJlKHVybCwgb3B0aW9ucyk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgcmVzID0gYXdhaXQgZmV0Y2godXJsLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgICBpZiAocmVzLnN0YXR1cyAhPT0gNDI5IC8qIFRvbyBtYW55IHJlcXVlc3RzICovKSB7CgkgICAgICAgICAgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKGRpc2FibGVSZXRyeU9uUmF0ZUxpbWl0ID09PSB0cnVlKSB7CgkgICAgICAgICAgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgICAgdG9vX21hbnlfcmVxdWVzdHNfcmV0cmllcyAtPSAxOwoJICAgICAgICBpZiAodG9vX21hbnlfcmVxdWVzdHNfcmV0cmllcyA9PT0gMCkgewoJICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9CgkgICAgICAgIGNvbnNvbGUuZXJyb3IoYFNlcnZlciByZXNwb25kZWQgd2l0aCAke3Jlcy5zdGF0dXN9ICR7cmVzLnN0YXR1c1RleHR9LiAgUmV0cnlpbmcgYWZ0ZXIgJHt3YWl0VGltZX1tcyBkZWxheS4uLmApOwoJICAgICAgICBhd2FpdCBzbGVlcCh3YWl0VGltZSk7CgkgICAgICAgIHdhaXRUaW1lICo9IDI7CgkgICAgICB9CgkgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgcmVzLnRleHQoKTsKCSAgICAgIGlmIChyZXMub2spIHsKCSAgICAgICAgY2FsbGJhY2sobnVsbCwgdGV4dCk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoYCR7cmVzLnN0YXR1c30gJHtyZXMuc3RhdHVzVGV4dH06ICR7dGV4dH1gKSk7CgkgICAgICB9CgkgICAgfSBjYXRjaCAoZXJyKSB7CgkgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IpIGNhbGxiYWNrKGVycik7CgkgICAgfQoJICB9LCB7fSk7CgkgIHJldHVybiBjbGllbnRCcm93c2VyOwoJfQoJZnVuY3Rpb24gY3JlYXRlUnBjUmVxdWVzdChjbGllbnQpIHsKCSAgcmV0dXJuIChtZXRob2QsIGFyZ3MpID0+IHsKCSAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJICAgICAgY2xpZW50LnJlcXVlc3QobWV0aG9kLCBhcmdzLCAoZXJyLCByZXNwb25zZSkgPT4gewoJICAgICAgICBpZiAoZXJyKSB7CgkgICAgICAgICAgcmVqZWN0KGVycik7CgkgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIHJlc29sdmUocmVzcG9uc2UpOwoJICAgICAgfSk7CgkgICAgfSk7CgkgIH07Cgl9CglmdW5jdGlvbiBjcmVhdGVScGNCYXRjaFJlcXVlc3QoY2xpZW50KSB7CgkgIHJldHVybiByZXF1ZXN0cyA9PiB7CgkgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCSAgICAgIC8vIERvIG5vdGhpbmcgaWYgcmVxdWVzdHMgaXMgZW1wdHkKCSAgICAgIGlmIChyZXF1ZXN0cy5sZW5ndGggPT09IDApIHJlc29sdmUoW10pOwoJICAgICAgY29uc3QgYmF0Y2ggPSByZXF1ZXN0cy5tYXAocGFyYW1zID0+IHsKCSAgICAgICAgcmV0dXJuIGNsaWVudC5yZXF1ZXN0KHBhcmFtcy5tZXRob2ROYW1lLCBwYXJhbXMuYXJncyk7CgkgICAgICB9KTsKCSAgICAgIGNsaWVudC5yZXF1ZXN0KGJhdGNoLCAoZXJyLCByZXNwb25zZSkgPT4gewoJICAgICAgICBpZiAoZXJyKSB7CgkgICAgICAgICAgcmVqZWN0KGVycik7CgkgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIHJlc29sdmUocmVzcG9uc2UpOwoJICAgICAgfSk7CgkgICAgfSk7CgkgIH07Cgl9CgoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJnZXRJbmZsYXRpb25Hb3Zlcm5vciIgbWVzc2FnZQoJICovCgljb25zdCBHZXRJbmZsYXRpb25Hb3Zlcm5vclJwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHQoR2V0SW5mbGF0aW9uR292ZXJub3JSZXN1bHQpOwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0SW5mbGF0aW9uUmF0ZSIgbWVzc2FnZQoJICovCgljb25zdCBHZXRJbmZsYXRpb25SYXRlUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChHZXRJbmZsYXRpb25SYXRlUmVzdWx0KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldFJlY2VudFByaW9yaXRpemF0aW9uRmVlcyIgbWVzc2FnZQoJICovCgljb25zdCBHZXRSZWNlbnRQcmlvcml0aXphdGlvbkZlZXNScGNSZXN1bHQgPSBqc29uUnBjUmVzdWx0KEdldFJlY2VudFByaW9yaXRpemF0aW9uRmVlc1Jlc3VsdCk7CgoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJnZXRFcG9jaEluZm8iIG1lc3NhZ2UKCSAqLwoJY29uc3QgR2V0RXBvY2hJbmZvUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChHZXRFcG9jaEluZm9SZXN1bHQpOwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0RXBvY2hTY2hlZHVsZSIgbWVzc2FnZQoJICovCgljb25zdCBHZXRFcG9jaFNjaGVkdWxlUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChHZXRFcG9jaFNjaGVkdWxlUmVzdWx0KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldExlYWRlclNjaGVkdWxlIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldExlYWRlclNjaGVkdWxlUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChHZXRMZWFkZXJTY2hlZHVsZVJlc3VsdCk7CgoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJtaW5pbXVtTGVkZ2VyU2xvdCIgYW5kICJnZXRGaXJzdEF2YWlsYWJsZUJsb2NrIiBtZXNzYWdlcwoJICovCgljb25zdCBTbG90UnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChudW1iZXIoKSk7CgoJLyoqCgkgKiBTdXBwbHkKCSAqLwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0U3VwcGx5IiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldFN1cHBseVJwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHRBbmRDb250ZXh0KHR5cGUoewoJICB0b3RhbDogbnVtYmVyKCksCgkgIGNpcmN1bGF0aW5nOiBudW1iZXIoKSwKCSAgbm9uQ2lyY3VsYXRpbmc6IG51bWJlcigpLAoJICBub25DaXJjdWxhdGluZ0FjY291bnRzOiBhcnJheShQdWJsaWNLZXlGcm9tU3RyaW5nKQoJfSkpOwoKCS8qKgoJICogVG9rZW4gYW1vdW50IG9iamVjdCB3aGljaCByZXR1cm5zIGEgdG9rZW4gYW1vdW50IGluIGRpZmZlcmVudCBmb3JtYXRzCgkgKiBmb3IgdmFyaW91cyBjbGllbnQgdXNlIGNhc2VzLgoJICovCgoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyBzdHJ1Y3R1cmUgZm9yIHRva2VuIGFtb3VudHMKCSAqLwoJY29uc3QgVG9rZW5BbW91bnRSZXN1bHQgPSB0eXBlKHsKCSAgYW1vdW50OiBzdHJpbmcoKSwKCSAgdWlBbW91bnQ6IG51bGxhYmxlKG51bWJlcigpKSwKCSAgZGVjaW1hbHM6IG51bWJlcigpLAoJICB1aUFtb3VudFN0cmluZzogb3B0aW9uYWwoc3RyaW5nKCkpCgl9KTsKCgkvKioKCSAqIFRva2VuIGFkZHJlc3MgYW5kIGJhbGFuY2UuCgkgKi8KCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldFRva2VuTGFyZ2VzdEFjY291bnRzIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldFRva2VuTGFyZ2VzdEFjY291bnRzUmVzdWx0ID0ganNvblJwY1Jlc3VsdEFuZENvbnRleHQoYXJyYXkodHlwZSh7CgkgIGFkZHJlc3M6IFB1YmxpY0tleUZyb21TdHJpbmcsCgkgIGFtb3VudDogc3RyaW5nKCksCgkgIHVpQW1vdW50OiBudWxsYWJsZShudW1iZXIoKSksCgkgIGRlY2ltYWxzOiBudW1iZXIoKSwKCSAgdWlBbW91bnRTdHJpbmc6IG9wdGlvbmFsKHN0cmluZygpKQoJfSkpKTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldFRva2VuQWNjb3VudHNCeU93bmVyIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldFRva2VuQWNjb3VudHNCeU93bmVyID0ganNvblJwY1Jlc3VsdEFuZENvbnRleHQoYXJyYXkodHlwZSh7CgkgIHB1YmtleTogUHVibGljS2V5RnJvbVN0cmluZywKCSAgYWNjb3VudDogdHlwZSh7CgkgICAgZXhlY3V0YWJsZTogYm9vbGVhbigpLAoJICAgIG93bmVyOiBQdWJsaWNLZXlGcm9tU3RyaW5nLAoJICAgIGxhbXBvcnRzOiBudW1iZXIoKSwKCSAgICBkYXRhOiBCdWZmZXJGcm9tUmF3QWNjb3VudERhdGEsCgkgICAgcmVudEVwb2NoOiBudW1iZXIoKQoJICB9KQoJfSkpKTsKCWNvbnN0IFBhcnNlZEFjY291bnREYXRhUmVzdWx0ID0gdHlwZSh7CgkgIHByb2dyYW06IHN0cmluZygpLAoJICBwYXJzZWQ6IHVua25vd24oKSwKCSAgc3BhY2U6IG51bWJlcigpCgl9KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldFRva2VuQWNjb3VudHNCeU93bmVyIiBtZXNzYWdlIHdpdGggcGFyc2VkIGRhdGEKCSAqLwoJY29uc3QgR2V0UGFyc2VkVG9rZW5BY2NvdW50c0J5T3duZXIgPSBqc29uUnBjUmVzdWx0QW5kQ29udGV4dChhcnJheSh0eXBlKHsKCSAgcHVia2V5OiBQdWJsaWNLZXlGcm9tU3RyaW5nLAoJICBhY2NvdW50OiB0eXBlKHsKCSAgICBleGVjdXRhYmxlOiBib29sZWFuKCksCgkgICAgb3duZXI6IFB1YmxpY0tleUZyb21TdHJpbmcsCgkgICAgbGFtcG9ydHM6IG51bWJlcigpLAoJICAgIGRhdGE6IFBhcnNlZEFjY291bnREYXRhUmVzdWx0LAoJICAgIHJlbnRFcG9jaDogbnVtYmVyKCkKCSAgfSkKCX0pKSk7CgoJLyoqCgkgKiBQYWlyIG9mIGFuIGFjY291bnQgYWRkcmVzcyBhbmQgaXRzIGJhbGFuY2UKCSAqLwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0TGFyZ2VzdEFjY291bnRzIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldExhcmdlc3RBY2NvdW50c1JwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHRBbmRDb250ZXh0KGFycmF5KHR5cGUoewoJICBsYW1wb3J0czogbnVtYmVyKCksCgkgIGFkZHJlc3M6IFB1YmxpY0tleUZyb21TdHJpbmcKCX0pKSk7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgQWNjb3VudEluZm9SZXN1bHQgPSB0eXBlKHsKCSAgZXhlY3V0YWJsZTogYm9vbGVhbigpLAoJICBvd25lcjogUHVibGljS2V5RnJvbVN0cmluZywKCSAgbGFtcG9ydHM6IG51bWJlcigpLAoJICBkYXRhOiBCdWZmZXJGcm9tUmF3QWNjb3VudERhdGEsCgkgIHJlbnRFcG9jaDogbnVtYmVyKCkKCX0pOwoKCS8qKgoJICogQGludGVybmFsCgkgKi8KCWNvbnN0IEtleWVkQWNjb3VudEluZm9SZXN1bHQgPSB0eXBlKHsKCSAgcHVia2V5OiBQdWJsaWNLZXlGcm9tU3RyaW5nLAoJICBhY2NvdW50OiBBY2NvdW50SW5mb1Jlc3VsdAoJfSk7Cgljb25zdCBQYXJzZWRPclJhd0FjY291bnREYXRhID0gY29lcmNlKHVuaW9uKFtpbnN0YW5jZShidWZmZXJFeHBvcnRzLkJ1ZmZlciksIFBhcnNlZEFjY291bnREYXRhUmVzdWx0XSksIHVuaW9uKFtSYXdBY2NvdW50RGF0YVJlc3VsdCwgUGFyc2VkQWNjb3VudERhdGFSZXN1bHRdKSwgdmFsdWUgPT4gewoJICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKCSAgICByZXR1cm4gY3JlYXRlKHZhbHVlLCBCdWZmZXJGcm9tUmF3QWNjb3VudERhdGEpOwoJICB9IGVsc2UgewoJICAgIHJldHVybiB2YWx1ZTsKCSAgfQoJfSk7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgUGFyc2VkQWNjb3VudEluZm9SZXN1bHQgPSB0eXBlKHsKCSAgZXhlY3V0YWJsZTogYm9vbGVhbigpLAoJICBvd25lcjogUHVibGljS2V5RnJvbVN0cmluZywKCSAgbGFtcG9ydHM6IG51bWJlcigpLAoJICBkYXRhOiBQYXJzZWRPclJhd0FjY291bnREYXRhLAoJICByZW50RXBvY2g6IG51bWJlcigpCgl9KTsKCWNvbnN0IEtleWVkUGFyc2VkQWNjb3VudEluZm9SZXN1bHQgPSB0eXBlKHsKCSAgcHVia2V5OiBQdWJsaWNLZXlGcm9tU3RyaW5nLAoJICBhY2NvdW50OiBQYXJzZWRBY2NvdW50SW5mb1Jlc3VsdAoJfSk7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgU3Rha2VBY3RpdmF0aW9uUmVzdWx0ID0gdHlwZSh7CgkgIHN0YXRlOiB1bmlvbihbbGl0ZXJhbCgnYWN0aXZlJyksIGxpdGVyYWwoJ2luYWN0aXZlJyksIGxpdGVyYWwoJ2FjdGl2YXRpbmcnKSwgbGl0ZXJhbCgnZGVhY3RpdmF0aW5nJyldKSwKCSAgYWN0aXZlOiBudW1iZXIoKSwKCSAgaW5hY3RpdmU6IG51bWJlcigpCgl9KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldENvbmZpcm1lZFNpZ25hdHVyZXNGb3JBZGRyZXNzMiIgbWVzc2FnZQoJICovCgoJY29uc3QgR2V0Q29uZmlybWVkU2lnbmF0dXJlc0ZvckFkZHJlc3MyUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChhcnJheSh0eXBlKHsKCSAgc2lnbmF0dXJlOiBzdHJpbmcoKSwKCSAgc2xvdDogbnVtYmVyKCksCgkgIGVycjogVHJhbnNhY3Rpb25FcnJvclJlc3VsdCwKCSAgbWVtbzogbnVsbGFibGUoc3RyaW5nKCkpLAoJICBibG9ja1RpbWU6IG9wdGlvbmFsKG51bGxhYmxlKG51bWJlcigpKSkKCX0pKSk7CgoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJnZXRTaWduYXR1cmVzRm9yQWRkcmVzcyIgbWVzc2FnZQoJICovCgljb25zdCBHZXRTaWduYXR1cmVzRm9yQWRkcmVzc1JwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHQoYXJyYXkodHlwZSh7CgkgIHNpZ25hdHVyZTogc3RyaW5nKCksCgkgIHNsb3Q6IG51bWJlcigpLAoJICBlcnI6IFRyYW5zYWN0aW9uRXJyb3JSZXN1bHQsCgkgIG1lbW86IG51bGxhYmxlKHN0cmluZygpKSwKCSAgYmxvY2tUaW1lOiBvcHRpb25hbChudWxsYWJsZShudW1iZXIoKSkpCgl9KSkpOwoKCS8qKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImFjY291bnROb3RpZmljYXRpb24iIG1lc3NhZ2UKCSAqLwoJY29uc3QgQWNjb3VudE5vdGlmaWNhdGlvblJlc3VsdCA9IHR5cGUoewoJICBzdWJzY3JpcHRpb246IG51bWJlcigpLAoJICByZXN1bHQ6IG5vdGlmaWNhdGlvblJlc3VsdEFuZENvbnRleHQoQWNjb3VudEluZm9SZXN1bHQpCgl9KTsKCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCgljb25zdCBQcm9ncmFtQWNjb3VudEluZm9SZXN1bHQgPSB0eXBlKHsKCSAgcHVia2V5OiBQdWJsaWNLZXlGcm9tU3RyaW5nLAoJICBhY2NvdW50OiBBY2NvdW50SW5mb1Jlc3VsdAoJfSk7CgoJLyoqKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAicHJvZ3JhbU5vdGlmaWNhdGlvbiIgbWVzc2FnZQoJICovCgljb25zdCBQcm9ncmFtQWNjb3VudE5vdGlmaWNhdGlvblJlc3VsdCA9IHR5cGUoewoJICBzdWJzY3JpcHRpb246IG51bWJlcigpLAoJICByZXN1bHQ6IG5vdGlmaWNhdGlvblJlc3VsdEFuZENvbnRleHQoUHJvZ3JhbUFjY291bnRJbmZvUmVzdWx0KQoJfSk7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgU2xvdEluZm9SZXN1bHQgPSB0eXBlKHsKCSAgcGFyZW50OiBudW1iZXIoKSwKCSAgc2xvdDogbnVtYmVyKCksCgkgIHJvb3Q6IG51bWJlcigpCgl9KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgInNsb3ROb3RpZmljYXRpb24iIG1lc3NhZ2UKCSAqLwoJY29uc3QgU2xvdE5vdGlmaWNhdGlvblJlc3VsdCA9IHR5cGUoewoJICBzdWJzY3JpcHRpb246IG51bWJlcigpLAoJICByZXN1bHQ6IFNsb3RJbmZvUmVzdWx0Cgl9KTsKCgkvKioKCSAqIFNsb3QgdXBkYXRlcyB3aGljaCBjYW4gYmUgdXNlZCBmb3IgdHJhY2tpbmcgdGhlIGxpdmUgcHJvZ3Jlc3Mgb2YgYSBjbHVzdGVyLgoJICogLSBgImZpcnN0U2hyZWRSZWNlaXZlZCJgOiBjb25uZWN0ZWQgbm9kZSByZWNlaXZlZCB0aGUgZmlyc3Qgc2hyZWQgb2YgYSBibG9jay4KCSAqIEluZGljYXRlcyB0aGF0IGEgbmV3IGJsb2NrIHRoYXQgaXMgYmVpbmcgcHJvZHVjZWQuCgkgKiAtIGAiY29tcGxldGVkImA6IGNvbm5lY3RlZCBub2RlIGhhcyByZWNlaXZlZCBhbGwgc2hyZWRzIG9mIGEgYmxvY2suIEluZGljYXRlcwoJICogYSBibG9jayB3YXMgcmVjZW50bHkgcHJvZHVjZWQuCgkgKiAtIGAib3B0aW1pc3RpY0NvbmZpcm1hdGlvbiJgOiBibG9jayB3YXMgb3B0aW1pc3RpY2FsbHkgY29uZmlybWVkIGJ5IHRoZQoJICogY2x1c3Rlci4gSXQgaXMgbm90IGd1YXJhbnRlZWQgdGhhdCBhbiBvcHRpbWlzdGljIGNvbmZpcm1hdGlvbiBub3RpZmljYXRpb24KCSAqIHdpbGwgYmUgc2VudCBmb3IgZXZlcnkgZmluYWxpemVkIGJsb2Nrcy4KCSAqIC0gYCJyb290ImA6IHRoZSBjb25uZWN0ZWQgbm9kZSByb290ZWQgdGhpcyBibG9jay4KCSAqIC0gYCJjcmVhdGVkQmFuayJgOiB0aGUgY29ubmVjdGVkIG5vZGUgaGFzIHN0YXJ0ZWQgdmFsaWRhdGluZyB0aGlzIGJsb2NrLgoJICogLSBgImZyb3plbiJgOiB0aGUgY29ubmVjdGVkIG5vZGUgaGFzIHZhbGlkYXRlZCB0aGlzIGJsb2NrLgoJICogLSBgImRlYWQiYDogdGhlIGNvbm5lY3RlZCBub2RlIGZhaWxlZCB0byB2YWxpZGF0ZSB0aGlzIGJsb2NrLgoJICovCgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgU2xvdFVwZGF0ZVJlc3VsdCA9IHVuaW9uKFt0eXBlKHsKCSAgdHlwZTogdW5pb24oW2xpdGVyYWwoJ2ZpcnN0U2hyZWRSZWNlaXZlZCcpLCBsaXRlcmFsKCdjb21wbGV0ZWQnKSwgbGl0ZXJhbCgnb3B0aW1pc3RpY0NvbmZpcm1hdGlvbicpLCBsaXRlcmFsKCdyb290JyldKSwKCSAgc2xvdDogbnVtYmVyKCksCgkgIHRpbWVzdGFtcDogbnVtYmVyKCkKCX0pLCB0eXBlKHsKCSAgdHlwZTogbGl0ZXJhbCgnY3JlYXRlZEJhbmsnKSwKCSAgcGFyZW50OiBudW1iZXIoKSwKCSAgc2xvdDogbnVtYmVyKCksCgkgIHRpbWVzdGFtcDogbnVtYmVyKCkKCX0pLCB0eXBlKHsKCSAgdHlwZTogbGl0ZXJhbCgnZnJvemVuJyksCgkgIHNsb3Q6IG51bWJlcigpLAoJICB0aW1lc3RhbXA6IG51bWJlcigpLAoJICBzdGF0czogdHlwZSh7CgkgICAgbnVtVHJhbnNhY3Rpb25FbnRyaWVzOiBudW1iZXIoKSwKCSAgICBudW1TdWNjZXNzZnVsVHJhbnNhY3Rpb25zOiBudW1iZXIoKSwKCSAgICBudW1GYWlsZWRUcmFuc2FjdGlvbnM6IG51bWJlcigpLAoJICAgIG1heFRyYW5zYWN0aW9uc1BlckVudHJ5OiBudW1iZXIoKQoJICB9KQoJfSksIHR5cGUoewoJICB0eXBlOiBsaXRlcmFsKCdkZWFkJyksCgkgIHNsb3Q6IG51bWJlcigpLAoJICB0aW1lc3RhbXA6IG51bWJlcigpLAoJICBlcnI6IHN0cmluZygpCgl9KV0pOwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAic2xvdHNVcGRhdGVzTm90aWZpY2F0aW9uIiBtZXNzYWdlCgkgKi8KCWNvbnN0IFNsb3RVcGRhdGVOb3RpZmljYXRpb25SZXN1bHQgPSB0eXBlKHsKCSAgc3Vic2NyaXB0aW9uOiBudW1iZXIoKSwKCSAgcmVzdWx0OiBTbG90VXBkYXRlUmVzdWx0Cgl9KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgInNpZ25hdHVyZU5vdGlmaWNhdGlvbiIgbWVzc2FnZQoJICovCgljb25zdCBTaWduYXR1cmVOb3RpZmljYXRpb25SZXN1bHQgPSB0eXBlKHsKCSAgc3Vic2NyaXB0aW9uOiBudW1iZXIoKSwKCSAgcmVzdWx0OiBub3RpZmljYXRpb25SZXN1bHRBbmRDb250ZXh0KHVuaW9uKFtTaWduYXR1cmVTdGF0dXNSZXN1bHQsIFNpZ25hdHVyZVJlY2VpdmVkUmVzdWx0XSkpCgl9KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgInJvb3ROb3RpZmljYXRpb24iIG1lc3NhZ2UKCSAqLwoJY29uc3QgUm9vdE5vdGlmaWNhdGlvblJlc3VsdCA9IHR5cGUoewoJICBzdWJzY3JpcHRpb246IG51bWJlcigpLAoJICByZXN1bHQ6IG51bWJlcigpCgl9KTsKCWNvbnN0IENvbnRhY3RJbmZvUmVzdWx0ID0gdHlwZSh7CgkgIHB1YmtleTogc3RyaW5nKCksCgkgIGdvc3NpcDogbnVsbGFibGUoc3RyaW5nKCkpLAoJICB0cHU6IG51bGxhYmxlKHN0cmluZygpKSwKCSAgcnBjOiBudWxsYWJsZShzdHJpbmcoKSksCgkgIHZlcnNpb246IG51bGxhYmxlKHN0cmluZygpKQoJfSk7Cgljb25zdCBWb3RlQWNjb3VudEluZm9SZXN1bHQgPSB0eXBlKHsKCSAgdm90ZVB1YmtleTogc3RyaW5nKCksCgkgIG5vZGVQdWJrZXk6IHN0cmluZygpLAoJICBhY3RpdmF0ZWRTdGFrZTogbnVtYmVyKCksCgkgIGVwb2NoVm90ZUFjY291bnQ6IGJvb2xlYW4oKSwKCSAgZXBvY2hDcmVkaXRzOiBhcnJheSh0dXBsZShbbnVtYmVyKCksIG51bWJlcigpLCBudW1iZXIoKV0pKSwKCSAgY29tbWlzc2lvbjogbnVtYmVyKCksCgkgIGxhc3RWb3RlOiBudW1iZXIoKSwKCSAgcm9vdFNsb3Q6IG51bGxhYmxlKG51bWJlcigpKQoJfSk7CgoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJnZXRWb3RlQWNjb3VudHMiIG1lc3NhZ2UKCSAqLwoJY29uc3QgR2V0Vm90ZUFjY291bnRzID0ganNvblJwY1Jlc3VsdCh0eXBlKHsKCSAgY3VycmVudDogYXJyYXkoVm90ZUFjY291bnRJbmZvUmVzdWx0KSwKCSAgZGVsaW5xdWVudDogYXJyYXkoVm90ZUFjY291bnRJbmZvUmVzdWx0KQoJfSkpOwoJY29uc3QgQ29uZmlybWF0aW9uU3RhdHVzID0gdW5pb24oW2xpdGVyYWwoJ3Byb2Nlc3NlZCcpLCBsaXRlcmFsKCdjb25maXJtZWQnKSwgbGl0ZXJhbCgnZmluYWxpemVkJyldKTsKCWNvbnN0IFNpZ25hdHVyZVN0YXR1c1Jlc3BvbnNlID0gdHlwZSh7CgkgIHNsb3Q6IG51bWJlcigpLAoJICBjb25maXJtYXRpb25zOiBudWxsYWJsZShudW1iZXIoKSksCgkgIGVycjogVHJhbnNhY3Rpb25FcnJvclJlc3VsdCwKCSAgY29uZmlybWF0aW9uU3RhdHVzOiBvcHRpb25hbChDb25maXJtYXRpb25TdGF0dXMpCgl9KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldFNpZ25hdHVyZVN0YXR1c2VzIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldFNpZ25hdHVyZVN0YXR1c2VzUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdEFuZENvbnRleHQoYXJyYXkobnVsbGFibGUoU2lnbmF0dXJlU3RhdHVzUmVzcG9uc2UpKSk7CgoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJnZXRNaW5pbXVtQmFsYW5jZUZvclJlbnRFeGVtcHRpb24iIG1lc3NhZ2UKCSAqLwoJY29uc3QgR2V0TWluaW11bUJhbGFuY2VGb3JSZW50RXhlbXB0aW9uUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChudW1iZXIoKSk7Cgljb25zdCBBZGRyZXNzVGFibGVMb29rdXBTdHJ1Y3QgPSB0eXBlKHsKCSAgYWNjb3VudEtleTogUHVibGljS2V5RnJvbVN0cmluZywKCSAgd3JpdGFibGVJbmRleGVzOiBhcnJheShudW1iZXIoKSksCgkgIHJlYWRvbmx5SW5kZXhlczogYXJyYXkobnVtYmVyKCkpCgl9KTsKCWNvbnN0IENvbmZpcm1lZFRyYW5zYWN0aW9uUmVzdWx0ID0gdHlwZSh7CgkgIHNpZ25hdHVyZXM6IGFycmF5KHN0cmluZygpKSwKCSAgbWVzc2FnZTogdHlwZSh7CgkgICAgYWNjb3VudEtleXM6IGFycmF5KHN0cmluZygpKSwKCSAgICBoZWFkZXI6IHR5cGUoewoJICAgICAgbnVtUmVxdWlyZWRTaWduYXR1cmVzOiBudW1iZXIoKSwKCSAgICAgIG51bVJlYWRvbmx5U2lnbmVkQWNjb3VudHM6IG51bWJlcigpLAoJICAgICAgbnVtUmVhZG9ubHlVbnNpZ25lZEFjY291bnRzOiBudW1iZXIoKQoJICAgIH0pLAoJICAgIGluc3RydWN0aW9uczogYXJyYXkodHlwZSh7CgkgICAgICBhY2NvdW50czogYXJyYXkobnVtYmVyKCkpLAoJICAgICAgZGF0YTogc3RyaW5nKCksCgkgICAgICBwcm9ncmFtSWRJbmRleDogbnVtYmVyKCkKCSAgICB9KSksCgkgICAgcmVjZW50QmxvY2toYXNoOiBzdHJpbmcoKSwKCSAgICBhZGRyZXNzVGFibGVMb29rdXBzOiBvcHRpb25hbChhcnJheShBZGRyZXNzVGFibGVMb29rdXBTdHJ1Y3QpKQoJICB9KQoJfSk7Cgljb25zdCBBbm5vdGF0ZWRBY2NvdW50S2V5ID0gdHlwZSh7CgkgIHB1YmtleTogUHVibGljS2V5RnJvbVN0cmluZywKCSAgc2lnbmVyOiBib29sZWFuKCksCgkgIHdyaXRhYmxlOiBib29sZWFuKCksCgkgIHNvdXJjZTogb3B0aW9uYWwodW5pb24oW2xpdGVyYWwoJ3RyYW5zYWN0aW9uJyksIGxpdGVyYWwoJ2xvb2t1cFRhYmxlJyldKSkKCX0pOwoJY29uc3QgQ29uZmlybWVkVHJhbnNhY3Rpb25BY2NvdW50c01vZGVSZXN1bHQgPSB0eXBlKHsKCSAgYWNjb3VudEtleXM6IGFycmF5KEFubm90YXRlZEFjY291bnRLZXkpLAoJICBzaWduYXR1cmVzOiBhcnJheShzdHJpbmcoKSkKCX0pOwoJY29uc3QgUGFyc2VkSW5zdHJ1Y3Rpb25SZXN1bHQgPSB0eXBlKHsKCSAgcGFyc2VkOiB1bmtub3duKCksCgkgIHByb2dyYW06IHN0cmluZygpLAoJICBwcm9ncmFtSWQ6IFB1YmxpY0tleUZyb21TdHJpbmcKCX0pOwoJY29uc3QgUmF3SW5zdHJ1Y3Rpb25SZXN1bHQgPSB0eXBlKHsKCSAgYWNjb3VudHM6IGFycmF5KFB1YmxpY0tleUZyb21TdHJpbmcpLAoJICBkYXRhOiBzdHJpbmcoKSwKCSAgcHJvZ3JhbUlkOiBQdWJsaWNLZXlGcm9tU3RyaW5nCgl9KTsKCWNvbnN0IEluc3RydWN0aW9uUmVzdWx0ID0gdW5pb24oW1Jhd0luc3RydWN0aW9uUmVzdWx0LCBQYXJzZWRJbnN0cnVjdGlvblJlc3VsdF0pOwoJY29uc3QgVW5rbm93bkluc3RydWN0aW9uUmVzdWx0ID0gdW5pb24oW3R5cGUoewoJICBwYXJzZWQ6IHVua25vd24oKSwKCSAgcHJvZ3JhbTogc3RyaW5nKCksCgkgIHByb2dyYW1JZDogc3RyaW5nKCkKCX0pLCB0eXBlKHsKCSAgYWNjb3VudHM6IGFycmF5KHN0cmluZygpKSwKCSAgZGF0YTogc3RyaW5nKCksCgkgIHByb2dyYW1JZDogc3RyaW5nKCkKCX0pXSk7Cgljb25zdCBQYXJzZWRPclJhd0luc3RydWN0aW9uID0gY29lcmNlKEluc3RydWN0aW9uUmVzdWx0LCBVbmtub3duSW5zdHJ1Y3Rpb25SZXN1bHQsIHZhbHVlID0+IHsKCSAgaWYgKCdhY2NvdW50cycgaW4gdmFsdWUpIHsKCSAgICByZXR1cm4gY3JlYXRlKHZhbHVlLCBSYXdJbnN0cnVjdGlvblJlc3VsdCk7CgkgIH0gZWxzZSB7CgkgICAgcmV0dXJuIGNyZWF0ZSh2YWx1ZSwgUGFyc2VkSW5zdHJ1Y3Rpb25SZXN1bHQpOwoJICB9Cgl9KTsKCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCgljb25zdCBQYXJzZWRDb25maXJtZWRUcmFuc2FjdGlvblJlc3VsdCA9IHR5cGUoewoJICBzaWduYXR1cmVzOiBhcnJheShzdHJpbmcoKSksCgkgIG1lc3NhZ2U6IHR5cGUoewoJICAgIGFjY291bnRLZXlzOiBhcnJheShBbm5vdGF0ZWRBY2NvdW50S2V5KSwKCSAgICBpbnN0cnVjdGlvbnM6IGFycmF5KFBhcnNlZE9yUmF3SW5zdHJ1Y3Rpb24pLAoJICAgIHJlY2VudEJsb2NraGFzaDogc3RyaW5nKCksCgkgICAgYWRkcmVzc1RhYmxlTG9va3Vwczogb3B0aW9uYWwobnVsbGFibGUoYXJyYXkoQWRkcmVzc1RhYmxlTG9va3VwU3RydWN0KSkpCgkgIH0pCgl9KTsKCWNvbnN0IFRva2VuQmFsYW5jZVJlc3VsdCA9IHR5cGUoewoJICBhY2NvdW50SW5kZXg6IG51bWJlcigpLAoJICBtaW50OiBzdHJpbmcoKSwKCSAgb3duZXI6IG9wdGlvbmFsKHN0cmluZygpKSwKCSAgcHJvZ3JhbUlkOiBvcHRpb25hbChzdHJpbmcoKSksCgkgIHVpVG9rZW5BbW91bnQ6IFRva2VuQW1vdW50UmVzdWx0Cgl9KTsKCWNvbnN0IExvYWRlZEFkZHJlc3Nlc1Jlc3VsdCA9IHR5cGUoewoJICB3cml0YWJsZTogYXJyYXkoUHVibGljS2V5RnJvbVN0cmluZyksCgkgIHJlYWRvbmx5OiBhcnJheShQdWJsaWNLZXlGcm9tU3RyaW5nKQoJfSk7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgQ29uZmlybWVkVHJhbnNhY3Rpb25NZXRhUmVzdWx0ID0gdHlwZSh7CgkgIGVycjogVHJhbnNhY3Rpb25FcnJvclJlc3VsdCwKCSAgZmVlOiBudW1iZXIoKSwKCSAgaW5uZXJJbnN0cnVjdGlvbnM6IG9wdGlvbmFsKG51bGxhYmxlKGFycmF5KHR5cGUoewoJICAgIGluZGV4OiBudW1iZXIoKSwKCSAgICBpbnN0cnVjdGlvbnM6IGFycmF5KHR5cGUoewoJICAgICAgYWNjb3VudHM6IGFycmF5KG51bWJlcigpKSwKCSAgICAgIGRhdGE6IHN0cmluZygpLAoJICAgICAgcHJvZ3JhbUlkSW5kZXg6IG51bWJlcigpCgkgICAgfSkpCgkgIH0pKSkpLAoJICBwcmVCYWxhbmNlczogYXJyYXkobnVtYmVyKCkpLAoJICBwb3N0QmFsYW5jZXM6IGFycmF5KG51bWJlcigpKSwKCSAgbG9nTWVzc2FnZXM6IG9wdGlvbmFsKG51bGxhYmxlKGFycmF5KHN0cmluZygpKSkpLAoJICBwcmVUb2tlbkJhbGFuY2VzOiBvcHRpb25hbChudWxsYWJsZShhcnJheShUb2tlbkJhbGFuY2VSZXN1bHQpKSksCgkgIHBvc3RUb2tlbkJhbGFuY2VzOiBvcHRpb25hbChudWxsYWJsZShhcnJheShUb2tlbkJhbGFuY2VSZXN1bHQpKSksCgkgIGxvYWRlZEFkZHJlc3Nlczogb3B0aW9uYWwoTG9hZGVkQWRkcmVzc2VzUmVzdWx0KSwKCSAgY29tcHV0ZVVuaXRzQ29uc3VtZWQ6IG9wdGlvbmFsKG51bWJlcigpKQoJfSk7CgoJLyoqCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgUGFyc2VkQ29uZmlybWVkVHJhbnNhY3Rpb25NZXRhUmVzdWx0ID0gdHlwZSh7CgkgIGVycjogVHJhbnNhY3Rpb25FcnJvclJlc3VsdCwKCSAgZmVlOiBudW1iZXIoKSwKCSAgaW5uZXJJbnN0cnVjdGlvbnM6IG9wdGlvbmFsKG51bGxhYmxlKGFycmF5KHR5cGUoewoJICAgIGluZGV4OiBudW1iZXIoKSwKCSAgICBpbnN0cnVjdGlvbnM6IGFycmF5KFBhcnNlZE9yUmF3SW5zdHJ1Y3Rpb24pCgkgIH0pKSkpLAoJICBwcmVCYWxhbmNlczogYXJyYXkobnVtYmVyKCkpLAoJICBwb3N0QmFsYW5jZXM6IGFycmF5KG51bWJlcigpKSwKCSAgbG9nTWVzc2FnZXM6IG9wdGlvbmFsKG51bGxhYmxlKGFycmF5KHN0cmluZygpKSkpLAoJICBwcmVUb2tlbkJhbGFuY2VzOiBvcHRpb25hbChudWxsYWJsZShhcnJheShUb2tlbkJhbGFuY2VSZXN1bHQpKSksCgkgIHBvc3RUb2tlbkJhbGFuY2VzOiBvcHRpb25hbChudWxsYWJsZShhcnJheShUb2tlbkJhbGFuY2VSZXN1bHQpKSksCgkgIGxvYWRlZEFkZHJlc3Nlczogb3B0aW9uYWwoTG9hZGVkQWRkcmVzc2VzUmVzdWx0KSwKCSAgY29tcHV0ZVVuaXRzQ29uc3VtZWQ6IG9wdGlvbmFsKG51bWJlcigpKQoJfSk7Cgljb25zdCBUcmFuc2FjdGlvblZlcnNpb25TdHJ1Y3QgPSB1bmlvbihbbGl0ZXJhbCgwKSwgbGl0ZXJhbCgnbGVnYWN5JyldKTsKCgkvKiogQGludGVybmFsICovCgljb25zdCBSZXdhcmRzUmVzdWx0ID0gdHlwZSh7CgkgIHB1YmtleTogc3RyaW5nKCksCgkgIGxhbXBvcnRzOiBudW1iZXIoKSwKCSAgcG9zdEJhbGFuY2U6IG51bGxhYmxlKG51bWJlcigpKSwKCSAgcmV3YXJkVHlwZTogbnVsbGFibGUoc3RyaW5nKCkpLAoJICBjb21taXNzaW9uOiBvcHRpb25hbChudWxsYWJsZShudW1iZXIoKSkpCgl9KTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldEJsb2NrIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldEJsb2NrUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChudWxsYWJsZSh0eXBlKHsKCSAgYmxvY2toYXNoOiBzdHJpbmcoKSwKCSAgcHJldmlvdXNCbG9ja2hhc2g6IHN0cmluZygpLAoJICBwYXJlbnRTbG90OiBudW1iZXIoKSwKCSAgdHJhbnNhY3Rpb25zOiBhcnJheSh0eXBlKHsKCSAgICB0cmFuc2FjdGlvbjogQ29uZmlybWVkVHJhbnNhY3Rpb25SZXN1bHQsCgkgICAgbWV0YTogbnVsbGFibGUoQ29uZmlybWVkVHJhbnNhY3Rpb25NZXRhUmVzdWx0KSwKCSAgICB2ZXJzaW9uOiBvcHRpb25hbChUcmFuc2FjdGlvblZlcnNpb25TdHJ1Y3QpCgkgIH0pKSwKCSAgcmV3YXJkczogb3B0aW9uYWwoYXJyYXkoUmV3YXJkc1Jlc3VsdCkpLAoJICBibG9ja1RpbWU6IG51bGxhYmxlKG51bWJlcigpKSwKCSAgYmxvY2tIZWlnaHQ6IG51bGxhYmxlKG51bWJlcigpKQoJfSkpKTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldEJsb2NrIiBtZXNzYWdlIHdoZW4gYHRyYW5zYWN0aW9uRGV0YWlsc2AgaXMgYG5vbmVgCgkgKi8KCWNvbnN0IEdldE5vbmVNb2RlQmxvY2tScGNSZXN1bHQgPSBqc29uUnBjUmVzdWx0KG51bGxhYmxlKHR5cGUoewoJICBibG9ja2hhc2g6IHN0cmluZygpLAoJICBwcmV2aW91c0Jsb2NraGFzaDogc3RyaW5nKCksCgkgIHBhcmVudFNsb3Q6IG51bWJlcigpLAoJICByZXdhcmRzOiBvcHRpb25hbChhcnJheShSZXdhcmRzUmVzdWx0KSksCgkgIGJsb2NrVGltZTogbnVsbGFibGUobnVtYmVyKCkpLAoJICBibG9ja0hlaWdodDogbnVsbGFibGUobnVtYmVyKCkpCgl9KSkpOwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0QmxvY2siIG1lc3NhZ2Ugd2hlbiBgdHJhbnNhY3Rpb25EZXRhaWxzYCBpcyBgYWNjb3VudHNgCgkgKi8KCWNvbnN0IEdldEFjY291bnRzTW9kZUJsb2NrUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChudWxsYWJsZSh0eXBlKHsKCSAgYmxvY2toYXNoOiBzdHJpbmcoKSwKCSAgcHJldmlvdXNCbG9ja2hhc2g6IHN0cmluZygpLAoJICBwYXJlbnRTbG90OiBudW1iZXIoKSwKCSAgdHJhbnNhY3Rpb25zOiBhcnJheSh0eXBlKHsKCSAgICB0cmFuc2FjdGlvbjogQ29uZmlybWVkVHJhbnNhY3Rpb25BY2NvdW50c01vZGVSZXN1bHQsCgkgICAgbWV0YTogbnVsbGFibGUoQ29uZmlybWVkVHJhbnNhY3Rpb25NZXRhUmVzdWx0KSwKCSAgICB2ZXJzaW9uOiBvcHRpb25hbChUcmFuc2FjdGlvblZlcnNpb25TdHJ1Y3QpCgkgIH0pKSwKCSAgcmV3YXJkczogb3B0aW9uYWwoYXJyYXkoUmV3YXJkc1Jlc3VsdCkpLAoJICBibG9ja1RpbWU6IG51bGxhYmxlKG51bWJlcigpKSwKCSAgYmxvY2tIZWlnaHQ6IG51bGxhYmxlKG51bWJlcigpKQoJfSkpKTsKCgkvKioKCSAqIEV4cGVjdGVkIHBhcnNlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJnZXRCbG9jayIgbWVzc2FnZQoJICovCgljb25zdCBHZXRQYXJzZWRCbG9ja1JwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHQobnVsbGFibGUodHlwZSh7CgkgIGJsb2NraGFzaDogc3RyaW5nKCksCgkgIHByZXZpb3VzQmxvY2toYXNoOiBzdHJpbmcoKSwKCSAgcGFyZW50U2xvdDogbnVtYmVyKCksCgkgIHRyYW5zYWN0aW9uczogYXJyYXkodHlwZSh7CgkgICAgdHJhbnNhY3Rpb246IFBhcnNlZENvbmZpcm1lZFRyYW5zYWN0aW9uUmVzdWx0LAoJICAgIG1ldGE6IG51bGxhYmxlKFBhcnNlZENvbmZpcm1lZFRyYW5zYWN0aW9uTWV0YVJlc3VsdCksCgkgICAgdmVyc2lvbjogb3B0aW9uYWwoVHJhbnNhY3Rpb25WZXJzaW9uU3RydWN0KQoJICB9KSksCgkgIHJld2FyZHM6IG9wdGlvbmFsKGFycmF5KFJld2FyZHNSZXN1bHQpKSwKCSAgYmxvY2tUaW1lOiBudWxsYWJsZShudW1iZXIoKSksCgkgIGJsb2NrSGVpZ2h0OiBudWxsYWJsZShudW1iZXIoKSkKCX0pKSk7CgoJLyoqCgkgKiBFeHBlY3RlZCBwYXJzZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0QmxvY2siIG1lc3NhZ2UgIHdoZW4gYHRyYW5zYWN0aW9uRGV0YWlsc2AgaXMgYGFjY291bnRzYAoJICovCgljb25zdCBHZXRQYXJzZWRBY2NvdW50c01vZGVCbG9ja1JwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHQobnVsbGFibGUodHlwZSh7CgkgIGJsb2NraGFzaDogc3RyaW5nKCksCgkgIHByZXZpb3VzQmxvY2toYXNoOiBzdHJpbmcoKSwKCSAgcGFyZW50U2xvdDogbnVtYmVyKCksCgkgIHRyYW5zYWN0aW9uczogYXJyYXkodHlwZSh7CgkgICAgdHJhbnNhY3Rpb246IENvbmZpcm1lZFRyYW5zYWN0aW9uQWNjb3VudHNNb2RlUmVzdWx0LAoJICAgIG1ldGE6IG51bGxhYmxlKFBhcnNlZENvbmZpcm1lZFRyYW5zYWN0aW9uTWV0YVJlc3VsdCksCgkgICAgdmVyc2lvbjogb3B0aW9uYWwoVHJhbnNhY3Rpb25WZXJzaW9uU3RydWN0KQoJICB9KSksCgkgIHJld2FyZHM6IG9wdGlvbmFsKGFycmF5KFJld2FyZHNSZXN1bHQpKSwKCSAgYmxvY2tUaW1lOiBudWxsYWJsZShudW1iZXIoKSksCgkgIGJsb2NrSGVpZ2h0OiBudWxsYWJsZShudW1iZXIoKSkKCX0pKSk7CgoJLyoqCgkgKiBFeHBlY3RlZCBwYXJzZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0QmxvY2siIG1lc3NhZ2UgIHdoZW4gYHRyYW5zYWN0aW9uRGV0YWlsc2AgaXMgYG5vbmVgCgkgKi8KCWNvbnN0IEdldFBhcnNlZE5vbmVNb2RlQmxvY2tScGNSZXN1bHQgPSBqc29uUnBjUmVzdWx0KG51bGxhYmxlKHR5cGUoewoJICBibG9ja2hhc2g6IHN0cmluZygpLAoJICBwcmV2aW91c0Jsb2NraGFzaDogc3RyaW5nKCksCgkgIHBhcmVudFNsb3Q6IG51bWJlcigpLAoJICByZXdhcmRzOiBvcHRpb25hbChhcnJheShSZXdhcmRzUmVzdWx0KSksCgkgIGJsb2NrVGltZTogbnVsbGFibGUobnVtYmVyKCkpLAoJICBibG9ja0hlaWdodDogbnVsbGFibGUobnVtYmVyKCkpCgl9KSkpOwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0Q29uZmlybWVkQmxvY2siIG1lc3NhZ2UKCSAqCgkgKiBAZGVwcmVjYXRlZCBEZXByZWNhdGVkIHNpbmNlIFJQQyB2MS44LjAuIFBsZWFzZSB1c2Uge0BsaW5rIEdldEJsb2NrUnBjUmVzdWx0fSBpbnN0ZWFkLgoJICovCgljb25zdCBHZXRDb25maXJtZWRCbG9ja1JwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHQobnVsbGFibGUodHlwZSh7CgkgIGJsb2NraGFzaDogc3RyaW5nKCksCgkgIHByZXZpb3VzQmxvY2toYXNoOiBzdHJpbmcoKSwKCSAgcGFyZW50U2xvdDogbnVtYmVyKCksCgkgIHRyYW5zYWN0aW9uczogYXJyYXkodHlwZSh7CgkgICAgdHJhbnNhY3Rpb246IENvbmZpcm1lZFRyYW5zYWN0aW9uUmVzdWx0LAoJICAgIG1ldGE6IG51bGxhYmxlKENvbmZpcm1lZFRyYW5zYWN0aW9uTWV0YVJlc3VsdCkKCSAgfSkpLAoJICByZXdhcmRzOiBvcHRpb25hbChhcnJheShSZXdhcmRzUmVzdWx0KSksCgkgIGJsb2NrVGltZTogbnVsbGFibGUobnVtYmVyKCkpCgl9KSkpOwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0QmxvY2siIG1lc3NhZ2UKCSAqLwoJY29uc3QgR2V0QmxvY2tTaWduYXR1cmVzUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChudWxsYWJsZSh0eXBlKHsKCSAgYmxvY2toYXNoOiBzdHJpbmcoKSwKCSAgcHJldmlvdXNCbG9ja2hhc2g6IHN0cmluZygpLAoJICBwYXJlbnRTbG90OiBudW1iZXIoKSwKCSAgc2lnbmF0dXJlczogYXJyYXkoc3RyaW5nKCkpLAoJICBibG9ja1RpbWU6IG51bGxhYmxlKG51bWJlcigpKQoJfSkpKTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldFRyYW5zYWN0aW9uIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldFRyYW5zYWN0aW9uUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChudWxsYWJsZSh0eXBlKHsKCSAgc2xvdDogbnVtYmVyKCksCgkgIG1ldGE6IG51bGxhYmxlKENvbmZpcm1lZFRyYW5zYWN0aW9uTWV0YVJlc3VsdCksCgkgIGJsb2NrVGltZTogb3B0aW9uYWwobnVsbGFibGUobnVtYmVyKCkpKSwKCSAgdHJhbnNhY3Rpb246IENvbmZpcm1lZFRyYW5zYWN0aW9uUmVzdWx0LAoJICB2ZXJzaW9uOiBvcHRpb25hbChUcmFuc2FjdGlvblZlcnNpb25TdHJ1Y3QpCgl9KSkpOwoKCS8qKgoJICogRXhwZWN0ZWQgcGFyc2VkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImdldFRyYW5zYWN0aW9uIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldFBhcnNlZFRyYW5zYWN0aW9uUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChudWxsYWJsZSh0eXBlKHsKCSAgc2xvdDogbnVtYmVyKCksCgkgIHRyYW5zYWN0aW9uOiBQYXJzZWRDb25maXJtZWRUcmFuc2FjdGlvblJlc3VsdCwKCSAgbWV0YTogbnVsbGFibGUoUGFyc2VkQ29uZmlybWVkVHJhbnNhY3Rpb25NZXRhUmVzdWx0KSwKCSAgYmxvY2tUaW1lOiBvcHRpb25hbChudWxsYWJsZShudW1iZXIoKSkpLAoJICB2ZXJzaW9uOiBvcHRpb25hbChUcmFuc2FjdGlvblZlcnNpb25TdHJ1Y3QpCgl9KSkpOwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAiZ2V0TGF0ZXN0QmxvY2toYXNoIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldExhdGVzdEJsb2NraGFzaFJwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHRBbmRDb250ZXh0KHR5cGUoewoJICBibG9ja2hhc2g6IHN0cmluZygpLAoJICBsYXN0VmFsaWRCbG9ja0hlaWdodDogbnVtYmVyKCkKCX0pKTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImlzQmxvY2toYXNoVmFsaWQiIG1lc3NhZ2UKCSAqLwoJY29uc3QgSXNCbG9ja2hhc2hWYWxpZFJwY1Jlc3VsdCA9IGpzb25ScGNSZXN1bHRBbmRDb250ZXh0KGJvb2xlYW4oKSk7Cgljb25zdCBQZXJmU2FtcGxlUmVzdWx0ID0gdHlwZSh7CgkgIHNsb3Q6IG51bWJlcigpLAoJICBudW1UcmFuc2FjdGlvbnM6IG51bWJlcigpLAoJICBudW1TbG90czogbnVtYmVyKCksCgkgIHNhbXBsZVBlcmlvZFNlY3M6IG51bWJlcigpCgl9KTsKCgkvKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yICJnZXRSZWNlbnRQZXJmb3JtYW5jZVNhbXBsZXMiIG1lc3NhZ2UKCSAqLwoJY29uc3QgR2V0UmVjZW50UGVyZm9ybWFuY2VTYW1wbGVzUnBjUmVzdWx0ID0ganNvblJwY1Jlc3VsdChhcnJheShQZXJmU2FtcGxlUmVzdWx0KSk7CgoJLyoqCgkgKiBFeHBlY3RlZCBKU09OIFJQQyByZXNwb25zZSBmb3IgdGhlICJnZXRGZWVDYWxjdWxhdG9yRm9yQmxvY2toYXNoIiBtZXNzYWdlCgkgKi8KCWNvbnN0IEdldEZlZUNhbGN1bGF0b3JScGNSZXN1bHQgPSBqc29uUnBjUmVzdWx0QW5kQ29udGV4dChudWxsYWJsZSh0eXBlKHsKCSAgZmVlQ2FsY3VsYXRvcjogdHlwZSh7CgkgICAgbGFtcG9ydHNQZXJTaWduYXR1cmU6IG51bWJlcigpCgkgIH0pCgl9KSkpOwoKCS8qKgoJICogRXhwZWN0ZWQgSlNPTiBSUEMgcmVzcG9uc2UgZm9yIHRoZSAicmVxdWVzdEFpcmRyb3AiIG1lc3NhZ2UKCSAqLwoJY29uc3QgUmVxdWVzdEFpcmRyb3BScGNSZXN1bHQgPSBqc29uUnBjUmVzdWx0KHN0cmluZygpKTsKCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgInNlbmRUcmFuc2FjdGlvbiIgbWVzc2FnZQoJICovCgljb25zdCBTZW5kVHJhbnNhY3Rpb25ScGNSZXN1bHQgPSBqc29uUnBjUmVzdWx0KHN0cmluZygpKTsKCgkvKioKCSAqIEluZm9ybWF0aW9uIGFib3V0IHRoZSBsYXRlc3Qgc2xvdCBiZWluZyBwcm9jZXNzZWQgYnkgYSBub2RlCgkgKi8KCgkvKioKCSAqIFBhcnNlZCBhY2NvdW50IGRhdGEKCSAqLwoKCS8qKgoJICogU3Rha2UgQWN0aXZhdGlvbiBkYXRhCgkgKi8KCgkvKioKCSAqIERhdGEgc2xpY2UgYXJndW1lbnQgZm9yIGdldFByb2dyYW1BY2NvdW50cwoJICovCgoJLyoqCgkgKiBNZW1vcnkgY29tcGFyaXNvbiBmaWx0ZXIgZm9yIGdldFByb2dyYW1BY2NvdW50cwoJICovCgoJLyoqCgkgKiBEYXRhIHNpemUgY29tcGFyaXNvbiBmaWx0ZXIgZm9yIGdldFByb2dyYW1BY2NvdW50cwoJICovCgoJLyoqCgkgKiBBIGZpbHRlciBvYmplY3QgZm9yIGdldFByb2dyYW1BY2NvdW50cwoJICovCgoJLyoqCgkgKiBDb25maWd1cmF0aW9uIG9iamVjdCBmb3IgZ2V0UHJvZ3JhbUFjY291bnRzIHJlcXVlc3RzCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBnZXRQYXJzZWRQcm9ncmFtQWNjb3VudHMKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGdldE11bHRpcGxlQWNjb3VudHMKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGBnZXRTdGFrZUFjdGl2YXRpb25gCgkgKi8KCgkvKioKCSAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBgZ2V0U3Rha2VBY3RpdmF0aW9uYAoJICovCgoJLyoqCgkgKiBDb25maWd1cmF0aW9uIG9iamVjdCBmb3IgYGdldFN0YWtlQWN0aXZhdGlvbmAKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGBnZXROb25jZWAKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGBnZXROb25jZUFuZENvbnRleHRgCgkgKi8KCgkvKioKCSAqIEluZm9ybWF0aW9uIGRlc2NyaWJpbmcgYW4gYWNjb3VudAoJICovCgoJLyoqCgkgKiBBY2NvdW50IGluZm9ybWF0aW9uIGlkZW50aWZpZWQgYnkgcHVia2V5CgkgKi8KCgkvKioKCSAqIENhbGxiYWNrIGZ1bmN0aW9uIGZvciBhY2NvdW50IGNoYW5nZSBub3RpZmljYXRpb25zCgkgKi8KCgkvKioKCSAqIENhbGxiYWNrIGZ1bmN0aW9uIGZvciBwcm9ncmFtIGFjY291bnQgY2hhbmdlIG5vdGlmaWNhdGlvbnMKCSAqLwoKCS8qKgoJICogQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIHNsb3QgY2hhbmdlIG5vdGlmaWNhdGlvbnMKCSAqLwoKCS8qKgoJICogQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIHNsb3QgdXBkYXRlIG5vdGlmaWNhdGlvbnMKCSAqLwoKCS8qKgoJICogQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIHNpZ25hdHVyZSBzdGF0dXMgbm90aWZpY2F0aW9ucwoJICovCgoJLyoqCgkgKiBTaWduYXR1cmUgc3RhdHVzIG5vdGlmaWNhdGlvbiB3aXRoIHRyYW5zYWN0aW9uIHJlc3VsdAoJICovCgoJLyoqCgkgKiBTaWduYXR1cmUgcmVjZWl2ZWQgbm90aWZpY2F0aW9uCgkgKi8KCgkvKioKCSAqIENhbGxiYWNrIGZ1bmN0aW9uIGZvciBzaWduYXR1cmUgbm90aWZpY2F0aW9ucwoJICovCgoJLyoqCgkgKiBTaWduYXR1cmUgc3Vic2NyaXB0aW9uIG9wdGlvbnMKCSAqLwoKCS8qKgoJICogQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIHJvb3QgY2hhbmdlIG5vdGlmaWNhdGlvbnMKCSAqLwoKCS8qKgoJICogQGludGVybmFsCgkgKi8KCWNvbnN0IExvZ3NSZXN1bHQgPSB0eXBlKHsKCSAgZXJyOiBUcmFuc2FjdGlvbkVycm9yUmVzdWx0LAoJICBsb2dzOiBhcnJheShzdHJpbmcoKSksCgkgIHNpZ25hdHVyZTogc3RyaW5nKCkKCX0pOwoKCS8qKgoJICogTG9ncyByZXN1bHQuCgkgKi8KCgkvKioKCSAqIEV4cGVjdGVkIEpTT04gUlBDIHJlc3BvbnNlIGZvciB0aGUgImxvZ3NOb3RpZmljYXRpb24iIG1lc3NhZ2UuCgkgKi8KCWNvbnN0IExvZ3NOb3RpZmljYXRpb25SZXN1bHQgPSB0eXBlKHsKCSAgcmVzdWx0OiBub3RpZmljYXRpb25SZXN1bHRBbmRDb250ZXh0KExvZ3NSZXN1bHQpLAoJICBzdWJzY3JpcHRpb246IG51bWJlcigpCgl9KTsKCgkvKioKCSAqIEZpbHRlciBmb3IgbG9nIHN1YnNjcmlwdGlvbnMuCgkgKi8KCgkvKioKCSAqIENhbGxiYWNrIGZ1bmN0aW9uIGZvciBsb2cgbm90aWZpY2F0aW9ucy4KCSAqLwoKCS8qKgoJICogU2lnbmF0dXJlIHJlc3VsdAoJICovCgoJLyoqCgkgKiBUcmFuc2FjdGlvbiBlcnJvcgoJICovCgoJLyoqCgkgKiBUcmFuc2FjdGlvbiBjb25maXJtYXRpb24gc3RhdHVzCgkgKiA8cHJlPgoJICogICAncHJvY2Vzc2VkJzogVHJhbnNhY3Rpb24gbGFuZGVkIGluIGEgYmxvY2sgd2hpY2ggaGFzIHJlYWNoZWQgMSBjb25maXJtYXRpb24gYnkgdGhlIGNvbm5lY3RlZCBub2RlCgkgKiAgICdjb25maXJtZWQnOiBUcmFuc2FjdGlvbiBsYW5kZWQgaW4gYSBibG9jayB3aGljaCBoYXMgcmVhY2hlZCAxIGNvbmZpcm1hdGlvbiBieSB0aGUgY2x1c3RlcgoJICogICAnZmluYWxpemVkJzogVHJhbnNhY3Rpb24gbGFuZGVkIGluIGEgYmxvY2sgd2hpY2ggaGFzIGJlZW4gZmluYWxpemVkIGJ5IHRoZSBjbHVzdGVyCgkgKiA8L3ByZT4KCSAqLwoKCS8qKgoJICogU2lnbmF0dXJlIHN0YXR1cwoJICovCgoJLyoqCgkgKiBBIGNvbmZpcm1lZCBzaWduYXR1cmUgd2l0aCBpdHMgc3RhdHVzCgkgKi8KCgkvKioKCSAqIEFuIG9iamVjdCBkZWZpbmluZyBoZWFkZXJzIHRvIGJlIHBhc3NlZCB0byB0aGUgUlBDIHNlcnZlcgoJICovCgoJLyoqCgkgKiBUaGUgdHlwZSBvZiB0aGUgSmF2YVNjcmlwdCBgZmV0Y2goKWAgQVBJCgkgKi8KCgkvKioKCSAqIEEgY2FsbGJhY2sgdXNlZCB0byBhdWdtZW50IHRoZSBvdXRnb2luZyBIVFRQIHJlcXVlc3QKCSAqLwoKCS8qKgoJICogQ29uZmlndXJhdGlvbiBmb3IgaW5zdGFudGlhdGluZyBhIENvbm5lY3Rpb24KCSAqLwoKCS8qKiBAaW50ZXJuYWwgKi8KCWNvbnN0IENPTU1PTl9IVFRQX0hFQURFUlMgPSB7CgkgICdzb2xhbmEtY2xpZW50JzogYGpzLyR7IjEuMC4wLW1haW50ZW5hbmNlIn1gCgl9OwoKCS8qKgoJICogQSBjb25uZWN0aW9uIHRvIGEgZnVsbG5vZGUgSlNPTiBSUEMgZW5kcG9pbnQKCSAqLwoJY2xhc3MgQ29ubmVjdGlvbiB7CgkgIC8qKgoJICAgKiBFc3RhYmxpc2ggYSBKU09OIFJQQyBjb25uZWN0aW9uCgkgICAqCgkgICAqIEBwYXJhbSBlbmRwb2ludCBVUkwgdG8gdGhlIGZ1bGxub2RlIEpTT04gUlBDIGVuZHBvaW50CgkgICAqIEBwYXJhbSBjb21taXRtZW50T3JDb25maWcgb3B0aW9uYWwgZGVmYXVsdCBjb21taXRtZW50IGxldmVsIG9yIG9wdGlvbmFsIENvbm5lY3Rpb25Db25maWcgY29uZmlndXJhdGlvbiBvYmplY3QKCSAgICovCgkgIGNvbnN0cnVjdG9yKGVuZHBvaW50LCBfY29tbWl0bWVudE9yQ29uZmlnKSB7CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX2NvbW1pdG1lbnQgPSB2b2lkIDA7CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX2NvbmZpcm1UcmFuc2FjdGlvbkluaXRpYWxUaW1lb3V0ID0gdm9pZCAwOwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9ycGNFbmRwb2ludCA9IHZvaWQgMDsKCSAgICAvKiogQGludGVybmFsICovCgkgICAgdGhpcy5fcnBjV3NFbmRwb2ludCA9IHZvaWQgMDsKCSAgICAvKiogQGludGVybmFsICovCgkgICAgdGhpcy5fcnBjQ2xpZW50ID0gdm9pZCAwOwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9ycGNSZXF1ZXN0ID0gdm9pZCAwOwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9ycGNCYXRjaFJlcXVlc3QgPSB2b2lkIDA7CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldCA9IHZvaWQgMDsKCSAgICAvKiogQGludGVybmFsICovCgkgICAgdGhpcy5fcnBjV2ViU29ja2V0Q29ubmVjdGVkID0gZmFsc2U7CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldEhlYXJ0YmVhdCA9IG51bGw7CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldElkbGVUaW1lb3V0ID0gbnVsbDsKCSAgICAvKiogQGludGVybmFsCgkgICAgICogQSBudW1iZXIgdGhhdCB3ZSBpbmNyZW1lbnQgZXZlcnkgdGltZSBhbiBhY3RpdmUgY29ubmVjdGlvbiBjbG9zZXMuCgkgICAgICogVXNlZCB0byBkZXRlcm1pbmUgd2hldGhlciB0aGUgc2FtZSBzb2NrZXQgY29ubmVjdGlvbiB0aGF0IHdhcyBvcGVuCgkgICAgICogd2hlbiBhbiBhc3luYyBvcGVyYXRpb24gc3RhcnRlZCBpcyB0aGUgc2FtZSBvbmUgdGhhdCdzIGFjdGl2ZSB3aGVuCgkgICAgICogaXRzIGNvbnRpbnVhdGlvbiBmaXJlcy4KCSAgICAgKgoJICAgICAqLwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldEdlbmVyYXRpb24gPSAwOwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9kaXNhYmxlQmxvY2toYXNoQ2FjaGluZyA9IGZhbHNlOwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9wb2xsaW5nQmxvY2toYXNoID0gZmFsc2U7CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX2Jsb2NraGFzaEluZm8gPSB7CgkgICAgICBsYXRlc3RCbG9ja2hhc2g6IG51bGwsCgkgICAgICBsYXN0RmV0Y2g6IDAsCgkgICAgICB0cmFuc2FjdGlvblNpZ25hdHVyZXM6IFtdLAoJICAgICAgc2ltdWxhdGVkU2lnbmF0dXJlczogW10KCSAgICB9OwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9uZXh0Q2xpZW50U3Vic2NyaXB0aW9uSWQgPSAwOwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9zdWJzY3JpcHRpb25EaXNwb3NlRnVuY3Rpb25zQnlDbGllbnRTdWJzY3JpcHRpb25JZCA9IHt9OwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9zdWJzY3JpcHRpb25IYXNoQnlDbGllbnRTdWJzY3JpcHRpb25JZCA9IHt9OwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9zdWJzY3JpcHRpb25TdGF0ZUNoYW5nZUNhbGxiYWNrc0J5SGFzaCA9IHt9OwoJICAgIC8qKiBAaW50ZXJuYWwgKi8KCSAgICB0aGlzLl9zdWJzY3JpcHRpb25DYWxsYmFja3NCeVNlcnZlclN1YnNjcmlwdGlvbklkID0ge307CgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNCeUhhc2ggPSB7fTsKCSAgICAvKioKCSAgICAgKiBTcGVjaWFsIGNhc2UuCgkgICAgICogQWZ0ZXIgYSBzaWduYXR1cmUgaXMgcHJvY2Vzc2VkLCBSUENzIGF1dG9tYXRpY2FsbHkgZGlzcG9zZSBvZiB0aGUKCSAgICAgKiBzdWJzY3JpcHRpb24gb24gdGhlIHNlcnZlciBzaWRlLiBXZSBuZWVkIHRvIHRyYWNrIHdoaWNoIG9mIHRoZXNlCgkgICAgICogc3Vic2NyaXB0aW9ucyBoYXZlIGJlZW4gZGlzcG9zZWQgaW4gc3VjaCBhIHdheSwgc28gdGhhdCB3ZSBrbm93CgkgICAgICogd2hldGhlciB0aGUgY2xpZW50IGlzIGRlYWxpbmcgd2l0aCBhIG5vdC15ZXQtcHJvY2Vzc2VkIHNpZ25hdHVyZQoJICAgICAqIChpbiB3aGljaCBjYXNlIHdlIG11c3QgdGVhciBkb3duIHRoZSBzZXJ2ZXIgc3Vic2NyaXB0aW9uKSBvciBhbgoJICAgICAqIGFscmVhZHktcHJvY2Vzc2VkIHNpZ25hdHVyZSAoaW4gd2hpY2ggY2FzZSB0aGUgY2xpZW50IGNhbiBzaW1wbHkKCSAgICAgKiBjbGVhciBvdXQgdGhlIHN1YnNjcmlwdGlvbiBsb2NhbGx5IHdpdGhvdXQgdGVsbGluZyB0aGUgc2VydmVyKS4KCSAgICAgKgoJICAgICAqIE5PVEU6IFRoZXJlIGlzIGEgcHJvcG9zYWwgdG8gZWxpbWluYXRlIHRoaXMgc3BlY2lhbCBjYXNlLCBoZXJlOgoJICAgICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9zb2xhbmEtbGFicy9zb2xhbmEvaXNzdWVzLzE4ODkyCgkgICAgICovCgkgICAgLyoqIEBpbnRlcm5hbCAqLwoJICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNBdXRvRGlzcG9zZWRCeVJwYyA9IG5ldyBTZXQoKTsKCSAgICAvKgoJICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgYmxvY2sgaGVpZ2h0IG9mIHRoZSBub2RlCgkgICAgICovCgkgICAgdGhpcy5nZXRCbG9ja0hlaWdodCA9ICgoKSA9PiB7CgkgICAgICBjb25zdCByZXF1ZXN0UHJvbWlzZXMgPSB7fTsKCSAgICAgIHJldHVybiBhc3luYyBjb21taXRtZW50T3JDb25maWcgPT4gewoJICAgICAgICBjb25zdCB7CgkgICAgICAgICAgY29tbWl0bWVudCwKCSAgICAgICAgICBjb25maWcKCSAgICAgICAgfSA9IGV4dHJhY3RDb21taXRtZW50RnJvbUNvbmZpZyhjb21taXRtZW50T3JDb25maWcpOwoJICAgICAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtdLCBjb21taXRtZW50LCB1bmRlZmluZWQgLyogZW5jb2RpbmcgKi8sIGNvbmZpZyk7CgkgICAgICAgIGNvbnN0IHJlcXVlc3RIYXNoID0gZmFzdFN0YWJsZVN0cmluZ2lmeShhcmdzKTsKCSAgICAgICAgcmVxdWVzdFByb21pc2VzW3JlcXVlc3RIYXNoXSA9IHJlcXVlc3RQcm9taXNlc1tyZXF1ZXN0SGFzaF0gPz8gKGFzeW5jICgpID0+IHsKCSAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0QmxvY2tIZWlnaHQnLCBhcmdzKTsKCSAgICAgICAgICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIGpzb25ScGNSZXN1bHQobnVtYmVyKCkpKTsKCSAgICAgICAgICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgICAgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgYmxvY2sgaGVpZ2h0IGluZm9ybWF0aW9uJyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgZGVsZXRlIHJlcXVlc3RQcm9taXNlc1tyZXF1ZXN0SGFzaF07CgkgICAgICAgICAgfQoJICAgICAgICB9KSgpOwoJICAgICAgICByZXR1cm4gYXdhaXQgcmVxdWVzdFByb21pc2VzW3JlcXVlc3RIYXNoXTsKCSAgICAgIH07CgkgICAgfSkoKTsKCSAgICBsZXQgd3NFbmRwb2ludDsKCSAgICBsZXQgaHR0cEhlYWRlcnM7CgkgICAgbGV0IGZldGNoOwoJICAgIGxldCBmZXRjaE1pZGRsZXdhcmU7CgkgICAgbGV0IGRpc2FibGVSZXRyeU9uUmF0ZUxpbWl0OwoJICAgIGxldCBodHRwQWdlbnQ7CgkgICAgaWYgKF9jb21taXRtZW50T3JDb25maWcgJiYgdHlwZW9mIF9jb21taXRtZW50T3JDb25maWcgPT09ICdzdHJpbmcnKSB7CgkgICAgICB0aGlzLl9jb21taXRtZW50ID0gX2NvbW1pdG1lbnRPckNvbmZpZzsKCSAgICB9IGVsc2UgaWYgKF9jb21taXRtZW50T3JDb25maWcpIHsKCSAgICAgIHRoaXMuX2NvbW1pdG1lbnQgPSBfY29tbWl0bWVudE9yQ29uZmlnLmNvbW1pdG1lbnQ7CgkgICAgICB0aGlzLl9jb25maXJtVHJhbnNhY3Rpb25Jbml0aWFsVGltZW91dCA9IF9jb21taXRtZW50T3JDb25maWcuY29uZmlybVRyYW5zYWN0aW9uSW5pdGlhbFRpbWVvdXQ7CgkgICAgICB3c0VuZHBvaW50ID0gX2NvbW1pdG1lbnRPckNvbmZpZy53c0VuZHBvaW50OwoJICAgICAgaHR0cEhlYWRlcnMgPSBfY29tbWl0bWVudE9yQ29uZmlnLmh0dHBIZWFkZXJzOwoJICAgICAgZmV0Y2ggPSBfY29tbWl0bWVudE9yQ29uZmlnLmZldGNoOwoJICAgICAgZmV0Y2hNaWRkbGV3YXJlID0gX2NvbW1pdG1lbnRPckNvbmZpZy5mZXRjaE1pZGRsZXdhcmU7CgkgICAgICBkaXNhYmxlUmV0cnlPblJhdGVMaW1pdCA9IF9jb21taXRtZW50T3JDb25maWcuZGlzYWJsZVJldHJ5T25SYXRlTGltaXQ7CgkgICAgICBodHRwQWdlbnQgPSBfY29tbWl0bWVudE9yQ29uZmlnLmh0dHBBZ2VudDsKCSAgICB9CgkgICAgdGhpcy5fcnBjRW5kcG9pbnQgPSBhc3NlcnRFbmRwb2ludFVybChlbmRwb2ludCk7CgkgICAgdGhpcy5fcnBjV3NFbmRwb2ludCA9IHdzRW5kcG9pbnQgfHwgbWFrZVdlYnNvY2tldFVybChlbmRwb2ludCk7CgkgICAgdGhpcy5fcnBjQ2xpZW50ID0gY3JlYXRlUnBjQ2xpZW50KGVuZHBvaW50LCBodHRwSGVhZGVycywgZmV0Y2gsIGZldGNoTWlkZGxld2FyZSwgZGlzYWJsZVJldHJ5T25SYXRlTGltaXQsIGh0dHBBZ2VudCk7CgkgICAgdGhpcy5fcnBjUmVxdWVzdCA9IGNyZWF0ZVJwY1JlcXVlc3QodGhpcy5fcnBjQ2xpZW50KTsKCSAgICB0aGlzLl9ycGNCYXRjaFJlcXVlc3QgPSBjcmVhdGVScGNCYXRjaFJlcXVlc3QodGhpcy5fcnBjQ2xpZW50KTsKCSAgICB0aGlzLl9ycGNXZWJTb2NrZXQgPSBuZXcgUnBjV2ViU29ja2V0Q2xpZW50KHRoaXMuX3JwY1dzRW5kcG9pbnQsIHsKCSAgICAgIGF1dG9jb25uZWN0OiBmYWxzZSwKCSAgICAgIG1heF9yZWNvbm5lY3RzOiBJbmZpbml0eQoJICAgIH0pOwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldC5vbignb3BlbicsIHRoaXMuX3dzT25PcGVuLmJpbmQodGhpcykpOwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldC5vbignZXJyb3InLCB0aGlzLl93c09uRXJyb3IuYmluZCh0aGlzKSk7CgkgICAgdGhpcy5fcnBjV2ViU29ja2V0Lm9uKCdjbG9zZScsIHRoaXMuX3dzT25DbG9zZS5iaW5kKHRoaXMpKTsKCSAgICB0aGlzLl9ycGNXZWJTb2NrZXQub24oJ2FjY291bnROb3RpZmljYXRpb24nLCB0aGlzLl93c09uQWNjb3VudE5vdGlmaWNhdGlvbi5iaW5kKHRoaXMpKTsKCSAgICB0aGlzLl9ycGNXZWJTb2NrZXQub24oJ3Byb2dyYW1Ob3RpZmljYXRpb24nLCB0aGlzLl93c09uUHJvZ3JhbUFjY291bnROb3RpZmljYXRpb24uYmluZCh0aGlzKSk7CgkgICAgdGhpcy5fcnBjV2ViU29ja2V0Lm9uKCdzbG90Tm90aWZpY2F0aW9uJywgdGhpcy5fd3NPblNsb3ROb3RpZmljYXRpb24uYmluZCh0aGlzKSk7CgkgICAgdGhpcy5fcnBjV2ViU29ja2V0Lm9uKCdzbG90c1VwZGF0ZXNOb3RpZmljYXRpb24nLCB0aGlzLl93c09uU2xvdFVwZGF0ZXNOb3RpZmljYXRpb24uYmluZCh0aGlzKSk7CgkgICAgdGhpcy5fcnBjV2ViU29ja2V0Lm9uKCdzaWduYXR1cmVOb3RpZmljYXRpb24nLCB0aGlzLl93c09uU2lnbmF0dXJlTm90aWZpY2F0aW9uLmJpbmQodGhpcykpOwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldC5vbigncm9vdE5vdGlmaWNhdGlvbicsIHRoaXMuX3dzT25Sb290Tm90aWZpY2F0aW9uLmJpbmQodGhpcykpOwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldC5vbignbG9nc05vdGlmaWNhdGlvbicsIHRoaXMuX3dzT25Mb2dzTm90aWZpY2F0aW9uLmJpbmQodGhpcykpOwoJICB9CgoJICAvKioKCSAgICogVGhlIGRlZmF1bHQgY29tbWl0bWVudCB1c2VkIGZvciByZXF1ZXN0cwoJICAgKi8KCSAgZ2V0IGNvbW1pdG1lbnQoKSB7CgkgICAgcmV0dXJuIHRoaXMuX2NvbW1pdG1lbnQ7CgkgIH0KCgkgIC8qKgoJICAgKiBUaGUgUlBDIGVuZHBvaW50CgkgICAqLwoJICBnZXQgcnBjRW5kcG9pbnQoKSB7CgkgICAgcmV0dXJuIHRoaXMuX3JwY0VuZHBvaW50OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIGJhbGFuY2UgZm9yIHRoZSBzcGVjaWZpZWQgcHVibGljIGtleSwgcmV0dXJuIHdpdGggY29udGV4dAoJICAgKi8KCSAgYXN5bmMgZ2V0QmFsYW5jZUFuZENvbnRleHQocHVibGljS2V5LCBjb21taXRtZW50T3JDb25maWcpIHsKCSAgICAvKiogQGludGVybmFsICovCgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtwdWJsaWNLZXkudG9CYXNlNTgoKV0sIGNvbW1pdG1lbnQsIHVuZGVmaW5lZCAvKiBlbmNvZGluZyAqLywgY29uZmlnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRCYWxhbmNlJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdEFuZENvbnRleHQobnVtYmVyKCkpKTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCBgZmFpbGVkIHRvIGdldCBiYWxhbmNlIGZvciAke3B1YmxpY0tleS50b0Jhc2U1OCgpfWApOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBiYWxhbmNlIGZvciB0aGUgc3BlY2lmaWVkIHB1YmxpYyBrZXkKCSAgICovCgkgIGFzeW5jIGdldEJhbGFuY2UocHVibGljS2V5LCBjb21taXRtZW50T3JDb25maWcpIHsKCSAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRCYWxhbmNlQW5kQ29udGV4dChwdWJsaWNLZXksIGNvbW1pdG1lbnRPckNvbmZpZykudGhlbih4ID0+IHgudmFsdWUpLmNhdGNoKGUgPT4gewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gZ2V0IGJhbGFuY2Ugb2YgYWNjb3VudCAnICsgcHVibGljS2V5LnRvQmFzZTU4KCkgKyAnOiAnICsgZSk7CgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgZXN0aW1hdGVkIHByb2R1Y3Rpb24gdGltZSBvZiBhIGJsb2NrCgkgICAqLwoJICBhc3luYyBnZXRCbG9ja1RpbWUoc2xvdCkgewoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldEJsb2NrVGltZScsIFtzbG90XSk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdChudWxsYWJsZShudW1iZXIoKSkpKTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCBgZmFpbGVkIHRvIGdldCBibG9jayB0aW1lIGZvciBzbG90ICR7c2xvdH1gKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgbG93ZXN0IHNsb3QgdGhhdCB0aGUgbm9kZSBoYXMgaW5mb3JtYXRpb24gYWJvdXQgaW4gaXRzIGxlZGdlci4KCSAgICogVGhpcyB2YWx1ZSBtYXkgaW5jcmVhc2Ugb3ZlciB0aW1lIGlmIHRoZSBub2RlIGlzIGNvbmZpZ3VyZWQgdG8gcHVyZ2Ugb2xkZXIgbGVkZ2VyIGRhdGEKCSAgICovCgkgIGFzeW5jIGdldE1pbmltdW1MZWRnZXJTbG90KCkgewoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ21pbmltdW1MZWRnZXJTbG90JywgW10pOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIGpzb25ScGNSZXN1bHQobnVtYmVyKCkpKTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBtaW5pbXVtIGxlZGdlciBzbG90Jyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIHNsb3Qgb2YgdGhlIGxvd2VzdCBjb25maXJtZWQgYmxvY2sgdGhhdCBoYXMgbm90IGJlZW4gcHVyZ2VkIGZyb20gdGhlIGxlZGdlcgoJICAgKi8KCSAgYXN5bmMgZ2V0Rmlyc3RBdmFpbGFibGVCbG9jaygpIHsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRGaXJzdEF2YWlsYWJsZUJsb2NrJywgW10pOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIFNsb3RScGNSZXN1bHQpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IGZpcnN0IGF2YWlsYWJsZSBibG9jaycpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IHN1cHBseQoJICAgKi8KCSAgYXN5bmMgZ2V0U3VwcGx5KGNvbmZpZykgewoJICAgIGxldCBjb25maWdBcmcgPSB7fTsKCSAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsKCSAgICAgIGNvbmZpZ0FyZyA9IHsKCSAgICAgICAgY29tbWl0bWVudDogY29uZmlnCgkgICAgICB9OwoJICAgIH0gZWxzZSBpZiAoY29uZmlnKSB7CgkgICAgICBjb25maWdBcmcgPSB7CgkgICAgICAgIC4uLmNvbmZpZywKCSAgICAgICAgY29tbWl0bWVudDogY29uZmlnICYmIGNvbmZpZy5jb21taXRtZW50IHx8IHRoaXMuY29tbWl0bWVudAoJICAgICAgfTsKCSAgICB9IGVsc2UgewoJICAgICAgY29uZmlnQXJnID0gewoJICAgICAgICBjb21taXRtZW50OiB0aGlzLmNvbW1pdG1lbnQKCSAgICAgIH07CgkgICAgfQoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFN1cHBseScsIFtjb25maWdBcmddKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRTdXBwbHlScGNSZXN1bHQpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IHN1cHBseScpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBjdXJyZW50IHN1cHBseSBvZiBhIHRva2VuIG1pbnQKCSAgICovCgkgIGFzeW5jIGdldFRva2VuU3VwcGx5KHRva2VuTWludEFkZHJlc3MsIGNvbW1pdG1lbnQpIHsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFt0b2tlbk1pbnRBZGRyZXNzLnRvQmFzZTU4KCldLCBjb21taXRtZW50KTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRUb2tlblN1cHBseScsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIGpzb25ScGNSZXN1bHRBbmRDb250ZXh0KFRva2VuQW1vdW50UmVzdWx0KSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgdG9rZW4gc3VwcGx5Jyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIGN1cnJlbnQgYmFsYW5jZSBvZiBhIHRva2VuIGFjY291bnQKCSAgICovCgkgIGFzeW5jIGdldFRva2VuQWNjb3VudEJhbGFuY2UodG9rZW5BZGRyZXNzLCBjb21taXRtZW50KSB7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbdG9rZW5BZGRyZXNzLnRvQmFzZTU4KCldLCBjb21taXRtZW50KTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRUb2tlbkFjY291bnRCYWxhbmNlJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdEFuZENvbnRleHQoVG9rZW5BbW91bnRSZXN1bHQpKTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCB0b2tlbiBhY2NvdW50IGJhbGFuY2UnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBhbGwgdGhlIHRva2VuIGFjY291bnRzIG93bmVkIGJ5IHRoZSBzcGVjaWZpZWQgYWNjb3VudAoJICAgKgoJICAgKiBAcmV0dXJuIHtQcm9taXNlPFJwY1Jlc3BvbnNlQW5kQ29udGV4dDxHZXRQcm9ncmFtQWNjb3VudHNSZXNwb25zZT59CgkgICAqLwoJICBhc3luYyBnZXRUb2tlbkFjY291bnRzQnlPd25lcihvd25lckFkZHJlc3MsIGZpbHRlciwgY29tbWl0bWVudE9yQ29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBsZXQgX2FyZ3MgPSBbb3duZXJBZGRyZXNzLnRvQmFzZTU4KCldOwoJICAgIGlmICgnbWludCcgaW4gZmlsdGVyKSB7CgkgICAgICBfYXJncy5wdXNoKHsKCSAgICAgICAgbWludDogZmlsdGVyLm1pbnQudG9CYXNlNTgoKQoJICAgICAgfSk7CgkgICAgfSBlbHNlIHsKCSAgICAgIF9hcmdzLnB1c2goewoJICAgICAgICBwcm9ncmFtSWQ6IGZpbHRlci5wcm9ncmFtSWQudG9CYXNlNTgoKQoJICAgICAgfSk7CgkgICAgfQoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoX2FyZ3MsIGNvbW1pdG1lbnQsICdiYXNlNjQnLCBjb25maWcpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFRva2VuQWNjb3VudHNCeU93bmVyJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0VG9rZW5BY2NvdW50c0J5T3duZXIpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsIGBmYWlsZWQgdG8gZ2V0IHRva2VuIGFjY291bnRzIG93bmVkIGJ5IGFjY291bnQgJHtvd25lckFkZHJlc3MudG9CYXNlNTgoKX1gKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBwYXJzZWQgdG9rZW4gYWNjb3VudHMgb3duZWQgYnkgdGhlIHNwZWNpZmllZCBhY2NvdW50CgkgICAqCgkgICAqIEByZXR1cm4ge1Byb21pc2U8UnBjUmVzcG9uc2VBbmRDb250ZXh0PEFycmF5PHtwdWJrZXk6IFB1YmxpY0tleSwgYWNjb3VudDogQWNjb3VudEluZm88UGFyc2VkQWNjb3VudERhdGE+fT4+Pn0KCSAgICovCgkgIGFzeW5jIGdldFBhcnNlZFRva2VuQWNjb3VudHNCeU93bmVyKG93bmVyQWRkcmVzcywgZmlsdGVyLCBjb21taXRtZW50KSB7CgkgICAgbGV0IF9hcmdzID0gW293bmVyQWRkcmVzcy50b0Jhc2U1OCgpXTsKCSAgICBpZiAoJ21pbnQnIGluIGZpbHRlcikgewoJICAgICAgX2FyZ3MucHVzaCh7CgkgICAgICAgIG1pbnQ6IGZpbHRlci5taW50LnRvQmFzZTU4KCkKCSAgICAgIH0pOwoJICAgIH0gZWxzZSB7CgkgICAgICBfYXJncy5wdXNoKHsKCSAgICAgICAgcHJvZ3JhbUlkOiBmaWx0ZXIucHJvZ3JhbUlkLnRvQmFzZTU4KCkKCSAgICAgIH0pOwoJICAgIH0KCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKF9hcmdzLCBjb21taXRtZW50LCAnanNvblBhcnNlZCcpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFRva2VuQWNjb3VudHNCeU93bmVyJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0UGFyc2VkVG9rZW5BY2NvdW50c0J5T3duZXIpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsIGBmYWlsZWQgdG8gZ2V0IHRva2VuIGFjY291bnRzIG93bmVkIGJ5IGFjY291bnQgJHtvd25lckFkZHJlc3MudG9CYXNlNTgoKX1gKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgMjAgbGFyZ2VzdCBhY2NvdW50cyB3aXRoIHRoZWlyIGN1cnJlbnQgYmFsYW5jZXMKCSAgICovCgkgIGFzeW5jIGdldExhcmdlc3RBY2NvdW50cyhjb25maWcpIHsKCSAgICBjb25zdCBhcmcgPSB7CgkgICAgICAuLi5jb25maWcsCgkgICAgICBjb21taXRtZW50OiBjb25maWcgJiYgY29uZmlnLmNvbW1pdG1lbnQgfHwgdGhpcy5jb21taXRtZW50CgkgICAgfTsKCSAgICBjb25zdCBhcmdzID0gYXJnLmZpbHRlciB8fCBhcmcuY29tbWl0bWVudCA/IFthcmddIDogW107CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0TGFyZ2VzdEFjY291bnRzJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0TGFyZ2VzdEFjY291bnRzUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBsYXJnZXN0IGFjY291bnRzJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIDIwIGxhcmdlc3QgdG9rZW4gYWNjb3VudHMgd2l0aCB0aGVpciBjdXJyZW50IGJhbGFuY2VzCgkgICAqIGZvciBhIGdpdmVuIG1pbnQuCgkgICAqLwoJICBhc3luYyBnZXRUb2tlbkxhcmdlc3RBY2NvdW50cyhtaW50QWRkcmVzcywgY29tbWl0bWVudCkgewoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW21pbnRBZGRyZXNzLnRvQmFzZTU4KCldLCBjb21taXRtZW50KTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRUb2tlbkxhcmdlc3RBY2NvdW50cycsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldFRva2VuTGFyZ2VzdEFjY291bnRzUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCB0b2tlbiBsYXJnZXN0IGFjY291bnRzJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggYWxsIHRoZSBhY2NvdW50IGluZm8gZm9yIHRoZSBzcGVjaWZpZWQgcHVibGljIGtleSwgcmV0dXJuIHdpdGggY29udGV4dAoJICAgKi8KCSAgYXN5bmMgZ2V0QWNjb3VudEluZm9BbmRDb250ZXh0KHB1YmxpY0tleSwgY29tbWl0bWVudE9yQ29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtwdWJsaWNLZXkudG9CYXNlNTgoKV0sIGNvbW1pdG1lbnQsICdiYXNlNjQnLCBjb25maWcpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldEFjY291bnRJbmZvJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdEFuZENvbnRleHQobnVsbGFibGUoQWNjb3VudEluZm9SZXN1bHQpKSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgYGZhaWxlZCB0byBnZXQgaW5mbyBhYm91dCBhY2NvdW50ICR7cHVibGljS2V5LnRvQmFzZTU4KCl9YCk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggcGFyc2VkIGFjY291bnQgaW5mbyBmb3IgdGhlIHNwZWNpZmllZCBwdWJsaWMga2V5CgkgICAqLwoJICBhc3luYyBnZXRQYXJzZWRBY2NvdW50SW5mbyhwdWJsaWNLZXksIGNvbW1pdG1lbnRPckNvbmZpZykgewoJICAgIGNvbnN0IHsKCSAgICAgIGNvbW1pdG1lbnQsCgkgICAgICBjb25maWcKCSAgICB9ID0gZXh0cmFjdENvbW1pdG1lbnRGcm9tQ29uZmlnKGNvbW1pdG1lbnRPckNvbmZpZyk7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbcHVibGljS2V5LnRvQmFzZTU4KCldLCBjb21taXRtZW50LCAnanNvblBhcnNlZCcsIGNvbmZpZyk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0QWNjb3VudEluZm8nLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0QW5kQ29udGV4dChudWxsYWJsZShQYXJzZWRBY2NvdW50SW5mb1Jlc3VsdCkpKTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCBgZmFpbGVkIHRvIGdldCBpbmZvIGFib3V0IGFjY291bnQgJHtwdWJsaWNLZXkudG9CYXNlNTgoKX1gKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBhbGwgdGhlIGFjY291bnQgaW5mbyBmb3IgdGhlIHNwZWNpZmllZCBwdWJsaWMga2V5CgkgICAqLwoJICBhc3luYyBnZXRBY2NvdW50SW5mbyhwdWJsaWNLZXksIGNvbW1pdG1lbnRPckNvbmZpZykgewoJICAgIHRyeSB7CgkgICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmdldEFjY291bnRJbmZvQW5kQ29udGV4dChwdWJsaWNLZXksIGNvbW1pdG1lbnRPckNvbmZpZyk7CgkgICAgICByZXR1cm4gcmVzLnZhbHVlOwoJICAgIH0gY2F0Y2ggKGUpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGdldCBpbmZvIGFib3V0IGFjY291bnQgJyArIHB1YmxpY0tleS50b0Jhc2U1OCgpICsgJzogJyArIGUpOwoJICAgIH0KCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIGFsbCB0aGUgYWNjb3VudCBpbmZvIGZvciBtdWx0aXBsZSBhY2NvdW50cyBzcGVjaWZpZWQgYnkgYW4gYXJyYXkgb2YgcHVibGljIGtleXMsIHJldHVybiB3aXRoIGNvbnRleHQKCSAgICovCgkgIGFzeW5jIGdldE11bHRpcGxlUGFyc2VkQWNjb3VudHMocHVibGljS2V5cywgcmF3Q29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcocmF3Q29uZmlnKTsKCSAgICBjb25zdCBrZXlzID0gcHVibGljS2V5cy5tYXAoa2V5ID0+IGtleS50b0Jhc2U1OCgpKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtrZXlzXSwgY29tbWl0bWVudCwgJ2pzb25QYXJzZWQnLCBjb25maWcpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldE11bHRpcGxlQWNjb3VudHMnLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0QW5kQ29udGV4dChhcnJheShudWxsYWJsZShQYXJzZWRBY2NvdW50SW5mb1Jlc3VsdCkpKSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgYGZhaWxlZCB0byBnZXQgaW5mbyBmb3IgYWNjb3VudHMgJHtrZXlzfWApOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIGFsbCB0aGUgYWNjb3VudCBpbmZvIGZvciBtdWx0aXBsZSBhY2NvdW50cyBzcGVjaWZpZWQgYnkgYW4gYXJyYXkgb2YgcHVibGljIGtleXMsIHJldHVybiB3aXRoIGNvbnRleHQKCSAgICovCgkgIGFzeW5jIGdldE11bHRpcGxlQWNjb3VudHNJbmZvQW5kQ29udGV4dChwdWJsaWNLZXlzLCBjb21taXRtZW50T3JDb25maWcpIHsKCSAgICBjb25zdCB7CgkgICAgICBjb21taXRtZW50LAoJICAgICAgY29uZmlnCgkgICAgfSA9IGV4dHJhY3RDb21taXRtZW50RnJvbUNvbmZpZyhjb21taXRtZW50T3JDb25maWcpOwoJICAgIGNvbnN0IGtleXMgPSBwdWJsaWNLZXlzLm1hcChrZXkgPT4ga2V5LnRvQmFzZTU4KCkpOwoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW2tleXNdLCBjb21taXRtZW50LCAnYmFzZTY0JywgY29uZmlnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRNdWx0aXBsZUFjY291bnRzJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdEFuZENvbnRleHQoYXJyYXkobnVsbGFibGUoQWNjb3VudEluZm9SZXN1bHQpKSkpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsIGBmYWlsZWQgdG8gZ2V0IGluZm8gZm9yIGFjY291bnRzICR7a2V5c31gKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBhbGwgdGhlIGFjY291bnQgaW5mbyBmb3IgbXVsdGlwbGUgYWNjb3VudHMgc3BlY2lmaWVkIGJ5IGFuIGFycmF5IG9mIHB1YmxpYyBrZXlzCgkgICAqLwoJICBhc3luYyBnZXRNdWx0aXBsZUFjY291bnRzSW5mbyhwdWJsaWNLZXlzLCBjb21taXRtZW50T3JDb25maWcpIHsKCSAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmdldE11bHRpcGxlQWNjb3VudHNJbmZvQW5kQ29udGV4dChwdWJsaWNLZXlzLCBjb21taXRtZW50T3JDb25maWcpOwoJICAgIHJldHVybiByZXMudmFsdWU7CgkgIH0KCgkgIC8qKgoJICAgKiBSZXR1cm5zIGVwb2NoIGFjdGl2YXRpb24gaW5mb3JtYXRpb24gZm9yIGEgc3Rha2UgYWNjb3VudCB0aGF0IGhhcyBiZWVuIGRlbGVnYXRlZAoJICAgKgoJICAgKiBAZGVwcmVjYXRlZCBEZXByZWNhdGVkIHNpbmNlIFJQQyB2MS4xODsgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHZlcnNpb24uCgkgICAqLwoJICBhc3luYyBnZXRTdGFrZUFjdGl2YXRpb24ocHVibGljS2V5LCBjb21taXRtZW50T3JDb25maWcsIGVwb2NoKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtwdWJsaWNLZXkudG9CYXNlNTgoKV0sIGNvbW1pdG1lbnQsIHVuZGVmaW5lZCAvKiBlbmNvZGluZyAqLywgewoJICAgICAgLi4uY29uZmlnLAoJICAgICAgZXBvY2g6IGVwb2NoICE9IG51bGwgPyBlcG9jaCA6IGNvbmZpZz8uZXBvY2gKCSAgICB9KTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRTdGFrZUFjdGl2YXRpb24nLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0KFN0YWtlQWN0aXZhdGlvblJlc3VsdCkpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsIGBmYWlsZWQgdG8gZ2V0IFN0YWtlIEFjdGl2YXRpb24gJHtwdWJsaWNLZXkudG9CYXNlNTgoKX1gKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBhbGwgdGhlIGFjY291bnRzIG93bmVkIGJ5IHRoZSBzcGVjaWZpZWQgcHJvZ3JhbSBpZAoJICAgKgoJICAgKiBAcmV0dXJuIHtQcm9taXNlPEFycmF5PHtwdWJrZXk6IFB1YmxpY0tleSwgYWNjb3VudDogQWNjb3VudEluZm88QnVmZmVyPn0+Pn0KCSAgICovCgoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgkgIGFzeW5jIGdldFByb2dyYW1BY2NvdW50cyhwcm9ncmFtSWQsIGNvbmZpZ09yQ29tbWl0bWVudCkgewoJICAgIGNvbnN0IHsKCSAgICAgIGNvbW1pdG1lbnQsCgkgICAgICBjb25maWcKCSAgICB9ID0gZXh0cmFjdENvbW1pdG1lbnRGcm9tQ29uZmlnKGNvbmZpZ09yQ29tbWl0bWVudCk7CgkgICAgY29uc3QgewoJICAgICAgZW5jb2RpbmcsCgkgICAgICAuLi5jb25maWdXaXRob3V0RW5jb2RpbmcKCSAgICB9ID0gY29uZmlnIHx8IHt9OwoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW3Byb2dyYW1JZC50b0Jhc2U1OCgpXSwgY29tbWl0bWVudCwgZW5jb2RpbmcgfHwgJ2Jhc2U2NCcsIHsKCSAgICAgIC4uLmNvbmZpZ1dpdGhvdXRFbmNvZGluZywKCSAgICAgIC4uLihjb25maWdXaXRob3V0RW5jb2RpbmcuZmlsdGVycyA/IHsKCSAgICAgICAgZmlsdGVyczogYXBwbHlEZWZhdWx0TWVtY21wRW5jb2RpbmdUb0ZpbHRlcnMoY29uZmlnV2l0aG91dEVuY29kaW5nLmZpbHRlcnMpCgkgICAgICB9IDogbnVsbCkKCSAgICB9KTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRQcm9ncmFtQWNjb3VudHMnLCBhcmdzKTsKCSAgICBjb25zdCBiYXNlU2NoZW1hID0gYXJyYXkoS2V5ZWRBY2NvdW50SW5mb1Jlc3VsdCk7CgkgICAgY29uc3QgcmVzID0gY29uZmlnV2l0aG91dEVuY29kaW5nLndpdGhDb250ZXh0ID09PSB0cnVlID8gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdEFuZENvbnRleHQoYmFzZVNjaGVtYSkpIDogY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdChiYXNlU2NoZW1hKSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgYGZhaWxlZCB0byBnZXQgYWNjb3VudHMgb3duZWQgYnkgcHJvZ3JhbSAke3Byb2dyYW1JZC50b0Jhc2U1OCgpfWApOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIGFuZCBwYXJzZSBhbGwgdGhlIGFjY291bnRzIG93bmVkIGJ5IHRoZSBzcGVjaWZpZWQgcHJvZ3JhbSBpZAoJICAgKgoJICAgKiBAcmV0dXJuIHtQcm9taXNlPEFycmF5PHtwdWJrZXk6IFB1YmxpY0tleSwgYWNjb3VudDogQWNjb3VudEluZm88QnVmZmVyIHwgUGFyc2VkQWNjb3VudERhdGE+fT4+fQoJICAgKi8KCSAgYXN5bmMgZ2V0UGFyc2VkUHJvZ3JhbUFjY291bnRzKHByb2dyYW1JZCwgY29uZmlnT3JDb21taXRtZW50KSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29uZmlnT3JDb21taXRtZW50KTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtwcm9ncmFtSWQudG9CYXNlNTgoKV0sIGNvbW1pdG1lbnQsICdqc29uUGFyc2VkJywgY29uZmlnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRQcm9ncmFtQWNjb3VudHMnLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0KGFycmF5KEtleWVkUGFyc2VkQWNjb3VudEluZm9SZXN1bHQpKSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgYGZhaWxlZCB0byBnZXQgYWNjb3VudHMgb3duZWQgYnkgcHJvZ3JhbSAke3Byb2dyYW1JZC50b0Jhc2U1OCgpfWApOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqIEBkZXByZWNhdGVkIEluc3RlYWQsIGNhbGwgYGNvbmZpcm1UcmFuc2FjdGlvbmAgYW5kIHBhc3MgaW4ge0BsaW5rIFRyYW5zYWN0aW9uQ29uZmlybWF0aW9uU3RyYXRlZ3l9ICovCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCSAgYXN5bmMgY29uZmlybVRyYW5zYWN0aW9uKHN0cmF0ZWd5LCBjb21taXRtZW50KSB7CgkgICAgbGV0IHJhd1NpZ25hdHVyZTsKCSAgICBpZiAodHlwZW9mIHN0cmF0ZWd5ID09ICdzdHJpbmcnKSB7CgkgICAgICByYXdTaWduYXR1cmUgPSBzdHJhdGVneTsKCSAgICB9IGVsc2UgewoJICAgICAgY29uc3QgY29uZmlnID0gc3RyYXRlZ3k7CgkgICAgICBpZiAoY29uZmlnLmFib3J0U2lnbmFsPy5hYm9ydGVkKSB7CgkgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChjb25maWcuYWJvcnRTaWduYWwucmVhc29uKTsKCSAgICAgIH0KCSAgICAgIHJhd1NpZ25hdHVyZSA9IGNvbmZpZy5zaWduYXR1cmU7CgkgICAgfQoJICAgIGxldCBkZWNvZGVkU2lnbmF0dXJlOwoJICAgIHRyeSB7CgkgICAgICBkZWNvZGVkU2lnbmF0dXJlID0gYnM1OC5kZWNvZGUocmF3U2lnbmF0dXJlKTsKCSAgICB9IGNhdGNoIChlcnIpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignc2lnbmF0dXJlIG11c3QgYmUgYmFzZTU4IGVuY29kZWQ6ICcgKyByYXdTaWduYXR1cmUpOwoJICAgIH0KCSAgICBhc3NlcnQkMShkZWNvZGVkU2lnbmF0dXJlLmxlbmd0aCA9PT0gNjQsICdzaWduYXR1cmUgaGFzIGludmFsaWQgbGVuZ3RoJyk7CgkgICAgaWYgKHR5cGVvZiBzdHJhdGVneSA9PT0gJ3N0cmluZycpIHsKCSAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNvbmZpcm1UcmFuc2FjdGlvblVzaW5nTGVnYWN5VGltZW91dFN0cmF0ZWd5KHsKCSAgICAgICAgY29tbWl0bWVudDogY29tbWl0bWVudCB8fCB0aGlzLmNvbW1pdG1lbnQsCgkgICAgICAgIHNpZ25hdHVyZTogcmF3U2lnbmF0dXJlCgkgICAgICB9KTsKCSAgICB9IGVsc2UgaWYgKCdsYXN0VmFsaWRCbG9ja0hlaWdodCcgaW4gc3RyYXRlZ3kpIHsKCSAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNvbmZpcm1UcmFuc2FjdGlvblVzaW5nQmxvY2tIZWlnaHRFeGNlZWRhbmNlU3RyYXRlZ3koewoJICAgICAgICBjb21taXRtZW50OiBjb21taXRtZW50IHx8IHRoaXMuY29tbWl0bWVudCwKCSAgICAgICAgc3RyYXRlZ3kKCSAgICAgIH0pOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4gYXdhaXQgdGhpcy5jb25maXJtVHJhbnNhY3Rpb25Vc2luZ0R1cmFibGVOb25jZVN0cmF0ZWd5KHsKCSAgICAgICAgY29tbWl0bWVudDogY29tbWl0bWVudCB8fCB0aGlzLmNvbW1pdG1lbnQsCgkgICAgICAgIHN0cmF0ZWd5CgkgICAgICB9KTsKCSAgICB9CgkgIH0KCSAgZ2V0Q2FuY2VsbGF0aW9uUHJvbWlzZShzaWduYWwpIHsKCSAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4gewoJICAgICAgaWYgKHNpZ25hbCA9PSBudWxsKSB7CgkgICAgICAgIHJldHVybjsKCSAgICAgIH0KCSAgICAgIGlmIChzaWduYWwuYWJvcnRlZCkgewoJICAgICAgICByZWplY3Qoc2lnbmFsLnJlYXNvbik7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCAoKSA9PiB7CgkgICAgICAgICAgcmVqZWN0KHNpZ25hbC5yZWFzb24pOwoJICAgICAgICB9KTsKCSAgICAgIH0KCSAgICB9KTsKCSAgfQoJICBnZXRUcmFuc2FjdGlvbkNvbmZpcm1hdGlvblByb21pc2UoewoJICAgIGNvbW1pdG1lbnQsCgkgICAgc2lnbmF0dXJlCgkgIH0pIHsKCSAgICBsZXQgc2lnbmF0dXJlU3Vic2NyaXB0aW9uSWQ7CgkgICAgbGV0IGRpc3Bvc2VTaWduYXR1cmVTdWJzY3JpcHRpb25TdGF0ZUNoYW5nZU9ic2VydmVyOwoJICAgIGxldCBkb25lID0gZmFsc2U7CgkgICAgY29uc3QgY29uZmlybWF0aW9uUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCSAgICAgIHRyeSB7CgkgICAgICAgIHNpZ25hdHVyZVN1YnNjcmlwdGlvbklkID0gdGhpcy5vblNpZ25hdHVyZShzaWduYXR1cmUsIChyZXN1bHQsIGNvbnRleHQpID0+IHsKCSAgICAgICAgICBzaWduYXR1cmVTdWJzY3JpcHRpb25JZCA9IHVuZGVmaW5lZDsKCSAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHsKCSAgICAgICAgICAgIGNvbnRleHQsCgkgICAgICAgICAgICB2YWx1ZTogcmVzdWx0CgkgICAgICAgICAgfTsKCSAgICAgICAgICByZXNvbHZlKHsKCSAgICAgICAgICAgIF9fdHlwZTogVHJhbnNhY3Rpb25TdGF0dXMuUFJPQ0VTU0VELAoJICAgICAgICAgICAgcmVzcG9uc2UKCSAgICAgICAgICB9KTsKCSAgICAgICAgfSwgY29tbWl0bWVudCk7CgkgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvblNldHVwUHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmVTdWJzY3JpcHRpb25TZXR1cCA9PiB7CgkgICAgICAgICAgaWYgKHNpZ25hdHVyZVN1YnNjcmlwdGlvbklkID09IG51bGwpIHsKCSAgICAgICAgICAgIHJlc29sdmVTdWJzY3JpcHRpb25TZXR1cCgpOwoJICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBkaXNwb3NlU2lnbmF0dXJlU3Vic2NyaXB0aW9uU3RhdGVDaGFuZ2VPYnNlcnZlciA9IHRoaXMuX29uU3Vic2NyaXB0aW9uU3RhdGVDaGFuZ2Uoc2lnbmF0dXJlU3Vic2NyaXB0aW9uSWQsIG5leHRTdGF0ZSA9PiB7CgkgICAgICAgICAgICAgIGlmIChuZXh0U3RhdGUgPT09ICdzdWJzY3JpYmVkJykgewoJICAgICAgICAgICAgICAgIHJlc29sdmVTdWJzY3JpcHRpb25TZXR1cCgpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgICAgICAoYXN5bmMgKCkgPT4gewoJICAgICAgICAgIGF3YWl0IHN1YnNjcmlwdGlvblNldHVwUHJvbWlzZTsKCSAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwoJICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5nZXRTaWduYXR1cmVTdGF0dXMoc2lnbmF0dXJlKTsKCSAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwoJICAgICAgICAgIGlmIChyZXNwb25zZSA9PSBudWxsKSB7CgkgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgfQoJICAgICAgICAgIGNvbnN0IHsKCSAgICAgICAgICAgIGNvbnRleHQsCgkgICAgICAgICAgICB2YWx1ZQoJICAgICAgICAgIH0gPSByZXNwb25zZTsKCSAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAodmFsdWU/LmVycikgewoJICAgICAgICAgICAgcmVqZWN0KHZhbHVlLmVycik7CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHN3aXRjaCAoY29tbWl0bWVudCkgewoJICAgICAgICAgICAgICBjYXNlICdjb25maXJtZWQnOgoJICAgICAgICAgICAgICBjYXNlICdzaW5nbGUnOgoJICAgICAgICAgICAgICBjYXNlICdzaW5nbGVHb3NzaXAnOgoJICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5jb25maXJtYXRpb25TdGF0dXMgPT09ICdwcm9jZXNzZWQnKSB7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgY2FzZSAnZmluYWxpemVkJzoKCSAgICAgICAgICAgICAgY2FzZSAnbWF4JzoKCSAgICAgICAgICAgICAgY2FzZSAncm9vdCc6CgkgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLmNvbmZpcm1hdGlvblN0YXR1cyA9PT0gJ3Byb2Nlc3NlZCcgfHwgdmFsdWUuY29uZmlybWF0aW9uU3RhdHVzID09PSAnY29uZmlybWVkJykgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIC8vIGV4aGF1c3QgZW51bXMgdG8gZW5zdXJlIGZ1bGwgY292ZXJhZ2UKCSAgICAgICAgICAgICAgY2FzZSAncHJvY2Vzc2VkJzoKCSAgICAgICAgICAgICAgY2FzZSAncmVjZW50JzoKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGRvbmUgPSB0cnVlOwoJICAgICAgICAgICAgcmVzb2x2ZSh7CgkgICAgICAgICAgICAgIF9fdHlwZTogVHJhbnNhY3Rpb25TdGF0dXMuUFJPQ0VTU0VELAoJICAgICAgICAgICAgICByZXNwb25zZTogewoJICAgICAgICAgICAgICAgIGNvbnRleHQsCgkgICAgICAgICAgICAgICAgdmFsdWUKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgfQoJICAgICAgICB9KSgpOwoJICAgICAgfSBjYXRjaCAoZXJyKSB7CgkgICAgICAgIHJlamVjdChlcnIpOwoJICAgICAgfQoJICAgIH0pOwoJICAgIGNvbnN0IGFib3J0Q29uZmlybWF0aW9uID0gKCkgPT4gewoJICAgICAgaWYgKGRpc3Bvc2VTaWduYXR1cmVTdWJzY3JpcHRpb25TdGF0ZUNoYW5nZU9ic2VydmVyKSB7CgkgICAgICAgIGRpc3Bvc2VTaWduYXR1cmVTdWJzY3JpcHRpb25TdGF0ZUNoYW5nZU9ic2VydmVyKCk7CgkgICAgICAgIGRpc3Bvc2VTaWduYXR1cmVTdWJzY3JpcHRpb25TdGF0ZUNoYW5nZU9ic2VydmVyID0gdW5kZWZpbmVkOwoJICAgICAgfQoJICAgICAgaWYgKHNpZ25hdHVyZVN1YnNjcmlwdGlvbklkICE9IG51bGwpIHsKCSAgICAgICAgdGhpcy5yZW1vdmVTaWduYXR1cmVMaXN0ZW5lcihzaWduYXR1cmVTdWJzY3JpcHRpb25JZCk7CgkgICAgICAgIHNpZ25hdHVyZVN1YnNjcmlwdGlvbklkID0gdW5kZWZpbmVkOwoJICAgICAgfQoJICAgIH07CgkgICAgcmV0dXJuIHsKCSAgICAgIGFib3J0Q29uZmlybWF0aW9uLAoJICAgICAgY29uZmlybWF0aW9uUHJvbWlzZQoJICAgIH07CgkgIH0KCSAgYXN5bmMgY29uZmlybVRyYW5zYWN0aW9uVXNpbmdCbG9ja0hlaWdodEV4Y2VlZGFuY2VTdHJhdGVneSh7CgkgICAgY29tbWl0bWVudCwKCSAgICBzdHJhdGVneTogewoJICAgICAgYWJvcnRTaWduYWwsCgkgICAgICBsYXN0VmFsaWRCbG9ja0hlaWdodCwKCSAgICAgIHNpZ25hdHVyZQoJICAgIH0KCSAgfSkgewoJICAgIGxldCBkb25lID0gZmFsc2U7CgkgICAgY29uc3QgZXhwaXJ5UHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gewoJICAgICAgY29uc3QgY2hlY2tCbG9ja0hlaWdodCA9IGFzeW5jICgpID0+IHsKCSAgICAgICAgdHJ5IHsKCSAgICAgICAgICBjb25zdCBibG9ja0hlaWdodCA9IGF3YWl0IHRoaXMuZ2V0QmxvY2tIZWlnaHQoY29tbWl0bWVudCk7CgkgICAgICAgICAgcmV0dXJuIGJsb2NrSGVpZ2h0OwoJICAgICAgICB9IGNhdGNoIChfZSkgewoJICAgICAgICAgIHJldHVybiAtMTsKCSAgICAgICAgfQoJICAgICAgfTsKCSAgICAgIChhc3luYyAoKSA9PiB7CgkgICAgICAgIGxldCBjdXJyZW50QmxvY2tIZWlnaHQgPSBhd2FpdCBjaGVja0Jsb2NrSGVpZ2h0KCk7CgkgICAgICAgIGlmIChkb25lKSByZXR1cm47CgkgICAgICAgIHdoaWxlIChjdXJyZW50QmxvY2tIZWlnaHQgPD0gbGFzdFZhbGlkQmxvY2tIZWlnaHQpIHsKCSAgICAgICAgICBhd2FpdCBzbGVlcCgxMDAwKTsKCSAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwoJICAgICAgICAgIGN1cnJlbnRCbG9ja0hlaWdodCA9IGF3YWl0IGNoZWNrQmxvY2tIZWlnaHQoKTsKCSAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIHJlc29sdmUoewoJICAgICAgICAgIF9fdHlwZTogVHJhbnNhY3Rpb25TdGF0dXMuQkxPQ0tIRUlHSFRfRVhDRUVERUQKCSAgICAgICAgfSk7CgkgICAgICB9KSgpOwoJICAgIH0pOwoJICAgIGNvbnN0IHsKCSAgICAgIGFib3J0Q29uZmlybWF0aW9uLAoJICAgICAgY29uZmlybWF0aW9uUHJvbWlzZQoJICAgIH0gPSB0aGlzLmdldFRyYW5zYWN0aW9uQ29uZmlybWF0aW9uUHJvbWlzZSh7CgkgICAgICBjb21taXRtZW50LAoJICAgICAgc2lnbmF0dXJlCgkgICAgfSk7CgkgICAgY29uc3QgY2FuY2VsbGF0aW9uUHJvbWlzZSA9IHRoaXMuZ2V0Q2FuY2VsbGF0aW9uUHJvbWlzZShhYm9ydFNpZ25hbCk7CgkgICAgbGV0IHJlc3VsdDsKCSAgICB0cnkgewoJICAgICAgY29uc3Qgb3V0Y29tZSA9IGF3YWl0IFByb21pc2UucmFjZShbY2FuY2VsbGF0aW9uUHJvbWlzZSwgY29uZmlybWF0aW9uUHJvbWlzZSwgZXhwaXJ5UHJvbWlzZV0pOwoJICAgICAgaWYgKG91dGNvbWUuX190eXBlID09PSBUcmFuc2FjdGlvblN0YXR1cy5QUk9DRVNTRUQpIHsKCSAgICAgICAgcmVzdWx0ID0gb3V0Y29tZS5yZXNwb25zZTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRocm93IG5ldyBUcmFuc2FjdGlvbkV4cGlyZWRCbG9ja2hlaWdodEV4Y2VlZGVkRXJyb3Ioc2lnbmF0dXJlKTsKCSAgICAgIH0KCSAgICB9IGZpbmFsbHkgewoJICAgICAgZG9uZSA9IHRydWU7CgkgICAgICBhYm9ydENvbmZpcm1hdGlvbigpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0OwoJICB9CgkgIGFzeW5jIGNvbmZpcm1UcmFuc2FjdGlvblVzaW5nRHVyYWJsZU5vbmNlU3RyYXRlZ3koewoJICAgIGNvbW1pdG1lbnQsCgkgICAgc3RyYXRlZ3k6IHsKCSAgICAgIGFib3J0U2lnbmFsLAoJICAgICAgbWluQ29udGV4dFNsb3QsCgkgICAgICBub25jZUFjY291bnRQdWJrZXksCgkgICAgICBub25jZVZhbHVlLAoJICAgICAgc2lnbmF0dXJlCgkgICAgfQoJICB9KSB7CgkgICAgbGV0IGRvbmUgPSBmYWxzZTsKCSAgICBjb25zdCBleHBpcnlQcm9taXNlID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7CgkgICAgICBsZXQgY3VycmVudE5vbmNlVmFsdWUgPSBub25jZVZhbHVlOwoJICAgICAgbGV0IGxhc3RDaGVja2VkU2xvdCA9IG51bGw7CgkgICAgICBjb25zdCBnZXRDdXJyZW50Tm9uY2VWYWx1ZSA9IGFzeW5jICgpID0+IHsKCSAgICAgICAgdHJ5IHsKCSAgICAgICAgICBjb25zdCB7CgkgICAgICAgICAgICBjb250ZXh0LAoJICAgICAgICAgICAgdmFsdWU6IG5vbmNlQWNjb3VudAoJICAgICAgICAgIH0gPSBhd2FpdCB0aGlzLmdldE5vbmNlQW5kQ29udGV4dChub25jZUFjY291bnRQdWJrZXksIHsKCSAgICAgICAgICAgIGNvbW1pdG1lbnQsCgkgICAgICAgICAgICBtaW5Db250ZXh0U2xvdAoJICAgICAgICAgIH0pOwoJICAgICAgICAgIGxhc3RDaGVja2VkU2xvdCA9IGNvbnRleHQuc2xvdDsKCSAgICAgICAgICByZXR1cm4gbm9uY2VBY2NvdW50Py5ub25jZTsKCSAgICAgICAgfSBjYXRjaCAoZSkgewoJICAgICAgICAgIC8vIElmIGZvciB3aGF0ZXZlciByZWFzb24gd2UgY2FuJ3QgcmVhY2gvcmVhZCB0aGUgbm9uY2UKCSAgICAgICAgICAvLyBhY2NvdW50LCBqdXN0IGtlZXAgdXNpbmcgdGhlIGxhc3Qta25vd24gdmFsdWUuCgkgICAgICAgICAgcmV0dXJuIGN1cnJlbnROb25jZVZhbHVlOwoJICAgICAgICB9CgkgICAgICB9OwoJICAgICAgKGFzeW5jICgpID0+IHsKCSAgICAgICAgY3VycmVudE5vbmNlVmFsdWUgPSBhd2FpdCBnZXRDdXJyZW50Tm9uY2VWYWx1ZSgpOwoJICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwoJICAgICAgICB3aGlsZSAodHJ1ZSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnN0YW50LWNvbmRpdGlvbgoJICAgICAgICApIHsKCSAgICAgICAgICBpZiAobm9uY2VWYWx1ZSAhPT0gY3VycmVudE5vbmNlVmFsdWUpIHsKCSAgICAgICAgICAgIHJlc29sdmUoewoJICAgICAgICAgICAgICBfX3R5cGU6IFRyYW5zYWN0aW9uU3RhdHVzLk5PTkNFX0lOVkFMSUQsCgkgICAgICAgICAgICAgIHNsb3RJbldoaWNoTm9uY2VEaWRBZHZhbmNlOiBsYXN0Q2hlY2tlZFNsb3QKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgIH0KCSAgICAgICAgICBhd2FpdCBzbGVlcCgyMDAwKTsKCSAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwoJICAgICAgICAgIGN1cnJlbnROb25jZVZhbHVlID0gYXdhaXQgZ2V0Q3VycmVudE5vbmNlVmFsdWUoKTsKCSAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICB9KSgpOwoJICAgIH0pOwoJICAgIGNvbnN0IHsKCSAgICAgIGFib3J0Q29uZmlybWF0aW9uLAoJICAgICAgY29uZmlybWF0aW9uUHJvbWlzZQoJICAgIH0gPSB0aGlzLmdldFRyYW5zYWN0aW9uQ29uZmlybWF0aW9uUHJvbWlzZSh7CgkgICAgICBjb21taXRtZW50LAoJICAgICAgc2lnbmF0dXJlCgkgICAgfSk7CgkgICAgY29uc3QgY2FuY2VsbGF0aW9uUHJvbWlzZSA9IHRoaXMuZ2V0Q2FuY2VsbGF0aW9uUHJvbWlzZShhYm9ydFNpZ25hbCk7CgkgICAgbGV0IHJlc3VsdDsKCSAgICB0cnkgewoJICAgICAgY29uc3Qgb3V0Y29tZSA9IGF3YWl0IFByb21pc2UucmFjZShbY2FuY2VsbGF0aW9uUHJvbWlzZSwgY29uZmlybWF0aW9uUHJvbWlzZSwgZXhwaXJ5UHJvbWlzZV0pOwoJICAgICAgaWYgKG91dGNvbWUuX190eXBlID09PSBUcmFuc2FjdGlvblN0YXR1cy5QUk9DRVNTRUQpIHsKCSAgICAgICAgcmVzdWx0ID0gb3V0Y29tZS5yZXNwb25zZTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIC8vIERvdWJsZSBjaGVjayB0aGF0IHRoZSB0cmFuc2FjdGlvbiBpcyBpbmRlZWQgdW5jb25maXJtZWQuCgkgICAgICAgIGxldCBzaWduYXR1cmVTdGF0dXM7CgkgICAgICAgIHdoaWxlICh0cnVlIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc3RhbnQtY29uZGl0aW9uCgkgICAgICAgICkgewoJICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IHRoaXMuZ2V0U2lnbmF0dXJlU3RhdHVzKHNpZ25hdHVyZSk7CgkgICAgICAgICAgaWYgKHN0YXR1cyA9PSBudWxsKSB7CgkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKHN0YXR1cy5jb250ZXh0LnNsb3QgPCAob3V0Y29tZS5zbG90SW5XaGljaE5vbmNlRGlkQWR2YW5jZSA/PyBtaW5Db250ZXh0U2xvdCkpIHsKCSAgICAgICAgICAgIGF3YWl0IHNsZWVwKDQwMCk7CgkgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAgc2lnbmF0dXJlU3RhdHVzID0gc3RhdHVzOwoJICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9CgkgICAgICAgIGlmIChzaWduYXR1cmVTdGF0dXM/LnZhbHVlKSB7CgkgICAgICAgICAgY29uc3QgY29tbWl0bWVudEZvclN0YXR1cyA9IGNvbW1pdG1lbnQgfHwgJ2ZpbmFsaXplZCc7CgkgICAgICAgICAgY29uc3QgewoJICAgICAgICAgICAgY29uZmlybWF0aW9uU3RhdHVzCgkgICAgICAgICAgfSA9IHNpZ25hdHVyZVN0YXR1cy52YWx1ZTsKCSAgICAgICAgICBzd2l0Y2ggKGNvbW1pdG1lbnRGb3JTdGF0dXMpIHsKCSAgICAgICAgICAgIGNhc2UgJ3Byb2Nlc3NlZCc6CgkgICAgICAgICAgICBjYXNlICdyZWNlbnQnOgoJICAgICAgICAgICAgICBpZiAoY29uZmlybWF0aW9uU3RhdHVzICE9PSAncHJvY2Vzc2VkJyAmJiBjb25maXJtYXRpb25TdGF0dXMgIT09ICdjb25maXJtZWQnICYmIGNvbmZpcm1hdGlvblN0YXR1cyAhPT0gJ2ZpbmFsaXplZCcpIHsKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHJhbnNhY3Rpb25FeHBpcmVkTm9uY2VJbnZhbGlkRXJyb3Ioc2lnbmF0dXJlKTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIGNhc2UgJ2NvbmZpcm1lZCc6CgkgICAgICAgICAgICBjYXNlICdzaW5nbGUnOgoJICAgICAgICAgICAgY2FzZSAnc2luZ2xlR29zc2lwJzoKCSAgICAgICAgICAgICAgaWYgKGNvbmZpcm1hdGlvblN0YXR1cyAhPT0gJ2NvbmZpcm1lZCcgJiYgY29uZmlybWF0aW9uU3RhdHVzICE9PSAnZmluYWxpemVkJykgewoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBUcmFuc2FjdGlvbkV4cGlyZWROb25jZUludmFsaWRFcnJvcihzaWduYXR1cmUpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgY2FzZSAnZmluYWxpemVkJzoKCSAgICAgICAgICAgIGNhc2UgJ21heCc6CgkgICAgICAgICAgICBjYXNlICdyb290JzoKCSAgICAgICAgICAgICAgaWYgKGNvbmZpcm1hdGlvblN0YXR1cyAhPT0gJ2ZpbmFsaXplZCcpIHsKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHJhbnNhY3Rpb25FeHBpcmVkTm9uY2VJbnZhbGlkRXJyb3Ioc2lnbmF0dXJlKTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgIC8vIEV4aGF1c3RpdmUgc3dpdGNoLgoJICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzCgkgICAgICAgICAgICAgIChfID0+IHt9KShjb21taXRtZW50Rm9yU3RhdHVzKTsKCSAgICAgICAgICB9CgkgICAgICAgICAgcmVzdWx0ID0gewoJICAgICAgICAgICAgY29udGV4dDogc2lnbmF0dXJlU3RhdHVzLmNvbnRleHQsCgkgICAgICAgICAgICB2YWx1ZTogewoJICAgICAgICAgICAgICBlcnI6IHNpZ25hdHVyZVN0YXR1cy52YWx1ZS5lcnIKCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9OwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIHRocm93IG5ldyBUcmFuc2FjdGlvbkV4cGlyZWROb25jZUludmFsaWRFcnJvcihzaWduYXR1cmUpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBmaW5hbGx5IHsKCSAgICAgIGRvbmUgPSB0cnVlOwoJICAgICAgYWJvcnRDb25maXJtYXRpb24oKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfQoJICBhc3luYyBjb25maXJtVHJhbnNhY3Rpb25Vc2luZ0xlZ2FjeVRpbWVvdXRTdHJhdGVneSh7CgkgICAgY29tbWl0bWVudCwKCSAgICBzaWduYXR1cmUKCSAgfSkgewoJICAgIGxldCB0aW1lb3V0SWQ7CgkgICAgY29uc3QgZXhwaXJ5UHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gewoJICAgICAgbGV0IHRpbWVvdXRNcyA9IHRoaXMuX2NvbmZpcm1UcmFuc2FjdGlvbkluaXRpYWxUaW1lb3V0IHx8IDYwICogMTAwMDsKCSAgICAgIHN3aXRjaCAoY29tbWl0bWVudCkgewoJICAgICAgICBjYXNlICdwcm9jZXNzZWQnOgoJICAgICAgICBjYXNlICdyZWNlbnQnOgoJICAgICAgICBjYXNlICdzaW5nbGUnOgoJICAgICAgICBjYXNlICdjb25maXJtZWQnOgoJICAgICAgICBjYXNlICdzaW5nbGVHb3NzaXAnOgoJICAgICAgICAgIHsKCSAgICAgICAgICAgIHRpbWVvdXRNcyA9IHRoaXMuX2NvbmZpcm1UcmFuc2FjdGlvbkluaXRpYWxUaW1lb3V0IHx8IDMwICogMTAwMDsKCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gcmVzb2x2ZSh7CgkgICAgICAgIF9fdHlwZTogVHJhbnNhY3Rpb25TdGF0dXMuVElNRURfT1VULAoJICAgICAgICB0aW1lb3V0TXMKCSAgICAgIH0pLCB0aW1lb3V0TXMpOwoJICAgIH0pOwoJICAgIGNvbnN0IHsKCSAgICAgIGFib3J0Q29uZmlybWF0aW9uLAoJICAgICAgY29uZmlybWF0aW9uUHJvbWlzZQoJICAgIH0gPSB0aGlzLmdldFRyYW5zYWN0aW9uQ29uZmlybWF0aW9uUHJvbWlzZSh7CgkgICAgICBjb21taXRtZW50LAoJICAgICAgc2lnbmF0dXJlCgkgICAgfSk7CgkgICAgbGV0IHJlc3VsdDsKCSAgICB0cnkgewoJICAgICAgY29uc3Qgb3V0Y29tZSA9IGF3YWl0IFByb21pc2UucmFjZShbY29uZmlybWF0aW9uUHJvbWlzZSwgZXhwaXJ5UHJvbWlzZV0pOwoJICAgICAgaWYgKG91dGNvbWUuX190eXBlID09PSBUcmFuc2FjdGlvblN0YXR1cy5QUk9DRVNTRUQpIHsKCSAgICAgICAgcmVzdWx0ID0gb3V0Y29tZS5yZXNwb25zZTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRocm93IG5ldyBUcmFuc2FjdGlvbkV4cGlyZWRUaW1lb3V0RXJyb3Ioc2lnbmF0dXJlLCBvdXRjb21lLnRpbWVvdXRNcyAvIDEwMDApOwoJICAgICAgfQoJICAgIH0gZmluYWxseSB7CgkgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKCSAgICAgIGFib3J0Q29uZmlybWF0aW9uKCk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBSZXR1cm4gdGhlIGxpc3Qgb2Ygbm9kZXMgdGhhdCBhcmUgY3VycmVudGx5IHBhcnRpY2lwYXRpbmcgaW4gdGhlIGNsdXN0ZXIKCSAgICovCgkgIGFzeW5jIGdldENsdXN0ZXJOb2RlcygpIHsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRDbHVzdGVyTm9kZXMnLCBbXSk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdChhcnJheShDb250YWN0SW5mb1Jlc3VsdCkpKTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBjbHVzdGVyIG5vZGVzJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogUmV0dXJuIHRoZSBsaXN0IG9mIG5vZGVzIHRoYXQgYXJlIGN1cnJlbnRseSBwYXJ0aWNpcGF0aW5nIGluIHRoZSBjbHVzdGVyCgkgICAqLwoJICBhc3luYyBnZXRWb3RlQWNjb3VudHMoY29tbWl0bWVudCkgewoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW10sIGNvbW1pdG1lbnQpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFZvdGVBY2NvdW50cycsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldFZvdGVBY2NvdW50cyk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgdm90ZSBhY2NvdW50cycpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBjdXJyZW50IHNsb3QgdGhhdCB0aGUgbm9kZSBpcyBwcm9jZXNzaW5nCgkgICAqLwoJICBhc3luYyBnZXRTbG90KGNvbW1pdG1lbnRPckNvbmZpZykgewoJICAgIGNvbnN0IHsKCSAgICAgIGNvbW1pdG1lbnQsCgkgICAgICBjb25maWcKCSAgICB9ID0gZXh0cmFjdENvbW1pdG1lbnRGcm9tQ29uZmlnKGNvbW1pdG1lbnRPckNvbmZpZyk7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbXSwgY29tbWl0bWVudCwgdW5kZWZpbmVkIC8qIGVuY29kaW5nICovLCBjb25maWcpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFNsb3QnLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0KG51bWJlcigpKSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgc2xvdCcpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBjdXJyZW50IHNsb3QgbGVhZGVyIG9mIHRoZSBjbHVzdGVyCgkgICAqLwoJICBhc3luYyBnZXRTbG90TGVhZGVyKGNvbW1pdG1lbnRPckNvbmZpZykgewoJICAgIGNvbnN0IHsKCSAgICAgIGNvbW1pdG1lbnQsCgkgICAgICBjb25maWcKCSAgICB9ID0gZXh0cmFjdENvbW1pdG1lbnRGcm9tQ29uZmlnKGNvbW1pdG1lbnRPckNvbmZpZyk7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbXSwgY29tbWl0bWVudCwgdW5kZWZpbmVkIC8qIGVuY29kaW5nICovLCBjb25maWcpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFNsb3RMZWFkZXInLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0KHN0cmluZygpKSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgc2xvdCBsZWFkZXInKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBgbGltaXRgIG51bWJlciBvZiBzbG90IGxlYWRlcnMgc3RhcnRpbmcgZnJvbSBgc3RhcnRTbG90YAoJICAgKgoJICAgKiBAcGFyYW0gc3RhcnRTbG90IGZldGNoIHNsb3QgbGVhZGVycyBzdGFydGluZyBmcm9tIHRoaXMgc2xvdAoJICAgKiBAcGFyYW0gbGltaXQgbnVtYmVyIG9mIHNsb3QgbGVhZGVycyB0byByZXR1cm4KCSAgICovCgkgIGFzeW5jIGdldFNsb3RMZWFkZXJzKHN0YXJ0U2xvdCwgbGltaXQpIHsKCSAgICBjb25zdCBhcmdzID0gW3N0YXJ0U2xvdCwgbGltaXRdOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFNsb3RMZWFkZXJzJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdChhcnJheShQdWJsaWNLZXlGcm9tU3RyaW5nKSkpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IHNsb3QgbGVhZGVycycpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBjdXJyZW50IHN0YXR1cyBvZiBhIHNpZ25hdHVyZQoJICAgKi8KCSAgYXN5bmMgZ2V0U2lnbmF0dXJlU3RhdHVzKHNpZ25hdHVyZSwgY29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29udGV4dCwKCSAgICAgIHZhbHVlOiB2YWx1ZXMKCSAgICB9ID0gYXdhaXQgdGhpcy5nZXRTaWduYXR1cmVTdGF0dXNlcyhbc2lnbmF0dXJlXSwgY29uZmlnKTsKCSAgICBhc3NlcnQkMSh2YWx1ZXMubGVuZ3RoID09PSAxKTsKCSAgICBjb25zdCB2YWx1ZSA9IHZhbHVlc1swXTsKCSAgICByZXR1cm4gewoJICAgICAgY29udGV4dCwKCSAgICAgIHZhbHVlCgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBjdXJyZW50IHN0YXR1c2VzIG9mIGEgYmF0Y2ggb2Ygc2lnbmF0dXJlcwoJICAgKi8KCSAgYXN5bmMgZ2V0U2lnbmF0dXJlU3RhdHVzZXMoc2lnbmF0dXJlcywgY29uZmlnKSB7CgkgICAgY29uc3QgcGFyYW1zID0gW3NpZ25hdHVyZXNdOwoJICAgIGlmIChjb25maWcpIHsKCSAgICAgIHBhcmFtcy5wdXNoKGNvbmZpZyk7CgkgICAgfQoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFNpZ25hdHVyZVN0YXR1c2VzJywgcGFyYW1zKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRTaWduYXR1cmVTdGF0dXNlc1JwY1Jlc3VsdCk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgc2lnbmF0dXJlIHN0YXR1cycpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBjdXJyZW50IHRyYW5zYWN0aW9uIGNvdW50IG9mIHRoZSBjbHVzdGVyCgkgICAqLwoJICBhc3luYyBnZXRUcmFuc2FjdGlvbkNvdW50KGNvbW1pdG1lbnRPckNvbmZpZykgewoJICAgIGNvbnN0IHsKCSAgICAgIGNvbW1pdG1lbnQsCgkgICAgICBjb25maWcKCSAgICB9ID0gZXh0cmFjdENvbW1pdG1lbnRGcm9tQ29uZmlnKGNvbW1pdG1lbnRPckNvbmZpZyk7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbXSwgY29tbWl0bWVudCwgdW5kZWZpbmVkIC8qIGVuY29kaW5nICovLCBjb25maWcpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFRyYW5zYWN0aW9uQ291bnQnLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0KG51bWJlcigpKSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgdHJhbnNhY3Rpb24gY291bnQnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgY3VycmVudCB0b3RhbCBjdXJyZW5jeSBzdXBwbHkgb2YgdGhlIGNsdXN0ZXIgaW4gbGFtcG9ydHMKCSAgICoKCSAgICogQGRlcHJlY2F0ZWQgRGVwcmVjYXRlZCBzaW5jZSBSUEMgdjEuMi44LiBQbGVhc2UgdXNlIHtAbGluayBnZXRTdXBwbHl9IGluc3RlYWQuCgkgICAqLwoJICBhc3luYyBnZXRUb3RhbFN1cHBseShjb21taXRtZW50KSB7CgkgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5nZXRTdXBwbHkoewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGV4Y2x1ZGVOb25DaXJjdWxhdGluZ0FjY291bnRzTGlzdDogdHJ1ZQoJICAgIH0pOwoJICAgIHJldHVybiByZXN1bHQudmFsdWUudG90YWw7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgY2x1c3RlciBJbmZsYXRpb25Hb3Zlcm5vciBwYXJhbWV0ZXJzCgkgICAqLwoJICBhc3luYyBnZXRJbmZsYXRpb25Hb3Zlcm5vcihjb21taXRtZW50KSB7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbXSwgY29tbWl0bWVudCk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0SW5mbGF0aW9uR292ZXJub3InLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRJbmZsYXRpb25Hb3Zlcm5vclJwY1Jlc3VsdCk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgaW5mbGF0aW9uJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIGluZmxhdGlvbiByZXdhcmQgZm9yIGEgbGlzdCBvZiBhZGRyZXNzZXMgZm9yIGFuIGVwb2NoCgkgICAqLwoJICBhc3luYyBnZXRJbmZsYXRpb25SZXdhcmQoYWRkcmVzc2VzLCBlcG9jaCwgY29tbWl0bWVudE9yQ29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFthZGRyZXNzZXMubWFwKHB1YmtleSA9PiBwdWJrZXkudG9CYXNlNTgoKSldLCBjb21taXRtZW50LCB1bmRlZmluZWQgLyogZW5jb2RpbmcgKi8sIHsKCSAgICAgIC4uLmNvbmZpZywKCSAgICAgIGVwb2NoOiBlcG9jaCAhPSBudWxsID8gZXBvY2ggOiBjb25maWc/LmVwb2NoCgkgICAgfSk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0SW5mbGF0aW9uUmV3YXJkJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0SW5mbGF0aW9uUmV3YXJkUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBpbmZsYXRpb24gcmV3YXJkJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIHNwZWNpZmljIGluZmxhdGlvbiB2YWx1ZXMgZm9yIHRoZSBjdXJyZW50IGVwb2NoCgkgICAqLwoJICBhc3luYyBnZXRJbmZsYXRpb25SYXRlKCkgewoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldEluZmxhdGlvblJhdGUnLCBbXSk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0SW5mbGF0aW9uUmF0ZVJwY1Jlc3VsdCk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgaW5mbGF0aW9uIHJhdGUnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgRXBvY2ggSW5mbyBwYXJhbWV0ZXJzCgkgICAqLwoJICBhc3luYyBnZXRFcG9jaEluZm8oY29tbWl0bWVudE9yQ29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtdLCBjb21taXRtZW50LCB1bmRlZmluZWQgLyogZW5jb2RpbmcgKi8sIGNvbmZpZyk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0RXBvY2hJbmZvJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0RXBvY2hJbmZvUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBlcG9jaCBpbmZvJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIEVwb2NoIFNjaGVkdWxlIHBhcmFtZXRlcnMKCSAgICovCgkgIGFzeW5jIGdldEVwb2NoU2NoZWR1bGUoKSB7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0RXBvY2hTY2hlZHVsZScsIFtdKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRFcG9jaFNjaGVkdWxlUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBlcG9jaCBzY2hlZHVsZScpOwoJICAgIH0KCSAgICBjb25zdCBlcG9jaFNjaGVkdWxlID0gcmVzLnJlc3VsdDsKCSAgICByZXR1cm4gbmV3IEVwb2NoU2NoZWR1bGUoZXBvY2hTY2hlZHVsZS5zbG90c1BlckVwb2NoLCBlcG9jaFNjaGVkdWxlLmxlYWRlclNjaGVkdWxlU2xvdE9mZnNldCwgZXBvY2hTY2hlZHVsZS53YXJtdXAsIGVwb2NoU2NoZWR1bGUuZmlyc3ROb3JtYWxFcG9jaCwgZXBvY2hTY2hlZHVsZS5maXJzdE5vcm1hbFNsb3QpOwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIGxlYWRlciBzY2hlZHVsZSBmb3IgdGhlIGN1cnJlbnQgZXBvY2gKCSAgICogQHJldHVybiB7UHJvbWlzZTxScGNSZXNwb25zZUFuZENvbnRleHQ8TGVhZGVyU2NoZWR1bGU+Pn0KCSAgICovCgkgIGFzeW5jIGdldExlYWRlclNjaGVkdWxlKCkgewoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldExlYWRlclNjaGVkdWxlJywgW10pOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldExlYWRlclNjaGVkdWxlUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBsZWFkZXIgc2NoZWR1bGUnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgbWluaW11bSBiYWxhbmNlIG5lZWRlZCB0byBleGVtcHQgYW4gYWNjb3VudCBvZiBgZGF0YUxlbmd0aGAKCSAgICogc2l6ZSBmcm9tIHJlbnQKCSAgICovCgkgIGFzeW5jIGdldE1pbmltdW1CYWxhbmNlRm9yUmVudEV4ZW1wdGlvbihkYXRhTGVuZ3RoLCBjb21taXRtZW50KSB7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbZGF0YUxlbmd0aF0sIGNvbW1pdG1lbnQpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldE1pbmltdW1CYWxhbmNlRm9yUmVudEV4ZW1wdGlvbicsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldE1pbmltdW1CYWxhbmNlRm9yUmVudEV4ZW1wdGlvblJwY1Jlc3VsdCk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICBjb25zb2xlLndhcm4oJ1VuYWJsZSB0byBmZXRjaCBtaW5pbXVtIGJhbGFuY2UgZm9yIHJlbnQgZXhlbXB0aW9uJyk7CgkgICAgICByZXR1cm4gMDsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBhIHJlY2VudCBibG9ja2hhc2ggZnJvbSB0aGUgY2x1c3RlciwgcmV0dXJuIHdpdGggY29udGV4dAoJICAgKiBAcmV0dXJuIHtQcm9taXNlPFJwY1Jlc3BvbnNlQW5kQ29udGV4dDx7YmxvY2toYXNoOiBCbG9ja2hhc2gsIGZlZUNhbGN1bGF0b3I6IEZlZUNhbGN1bGF0b3J9Pj59CgkgICAqCgkgICAqIEBkZXByZWNhdGVkIERlcHJlY2F0ZWQgc2luY2UgUlBDIHYxLjkuMC4gUGxlYXNlIHVzZSB7QGxpbmsgZ2V0TGF0ZXN0QmxvY2toYXNofSBpbnN0ZWFkLgoJICAgKi8KCSAgYXN5bmMgZ2V0UmVjZW50QmxvY2toYXNoQW5kQ29udGV4dChjb21taXRtZW50KSB7CgkgICAgY29uc3QgewoJICAgICAgY29udGV4dCwKCSAgICAgIHZhbHVlOiB7CgkgICAgICAgIGJsb2NraGFzaAoJICAgICAgfQoJICAgIH0gPSBhd2FpdCB0aGlzLmdldExhdGVzdEJsb2NraGFzaEFuZENvbnRleHQoY29tbWl0bWVudCk7CgkgICAgY29uc3QgZmVlQ2FsY3VsYXRvciA9IHsKCSAgICAgIGdldCBsYW1wb3J0c1BlclNpZ25hdHVyZSgpIHsKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgY2FwYWJpbGl0eSB0byBmZXRjaCBgbGFtcG9ydHNQZXJTaWduYXR1cmVgIHVzaW5nIHRoZSBgZ2V0UmVjZW50QmxvY2toYXNoYCBBUEkgaXMgJyArICdubyBsb25nZXIgb2ZmZXJlZCBieSB0aGUgbmV0d29yay4gVXNlIHRoZSBgZ2V0RmVlRm9yTWVzc2FnZWAgQVBJIHRvIG9idGFpbiB0aGUgZmVlICcgKyAnZm9yIGEgZ2l2ZW4gbWVzc2FnZS4nKTsKCSAgICAgIH0sCgkgICAgICB0b0pTT04oKSB7CgkgICAgICAgIHJldHVybiB7fTsKCSAgICAgIH0KCSAgICB9OwoJICAgIHJldHVybiB7CgkgICAgICBjb250ZXh0LAoJICAgICAgdmFsdWU6IHsKCSAgICAgICAgYmxvY2toYXNoLAoJICAgICAgICBmZWVDYWxjdWxhdG9yCgkgICAgICB9CgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHJlY2VudCBwZXJmb3JtYW5jZSBzYW1wbGVzCgkgICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8UGVyZlNhbXBsZT4+fQoJICAgKi8KCSAgYXN5bmMgZ2V0UmVjZW50UGVyZm9ybWFuY2VTYW1wbGVzKGxpbWl0KSB7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0UmVjZW50UGVyZm9ybWFuY2VTYW1wbGVzJywgbGltaXQgPyBbbGltaXRdIDogW10pOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldFJlY2VudFBlcmZvcm1hbmNlU2FtcGxlc1JwY1Jlc3VsdCk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgcmVjZW50IHBlcmZvcm1hbmNlIHNhbXBsZXMnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgZmVlIGNhbGN1bGF0b3IgZm9yIGEgcmVjZW50IGJsb2NraGFzaCBmcm9tIHRoZSBjbHVzdGVyLCByZXR1cm4gd2l0aCBjb250ZXh0CgkgICAqCgkgICAqIEBkZXByZWNhdGVkIERlcHJlY2F0ZWQgc2luY2UgUlBDIHYxLjkuMC4gUGxlYXNlIHVzZSB7QGxpbmsgZ2V0RmVlRm9yTWVzc2FnZX0gaW5zdGVhZC4KCSAgICovCgkgIGFzeW5jIGdldEZlZUNhbGN1bGF0b3JGb3JCbG9ja2hhc2goYmxvY2toYXNoLCBjb21taXRtZW50KSB7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbYmxvY2toYXNoXSwgY29tbWl0bWVudCk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0RmVlQ2FsY3VsYXRvckZvckJsb2NraGFzaCcsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldEZlZUNhbGN1bGF0b3JScGNSZXN1bHQpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IGZlZSBjYWxjdWxhdG9yJyk7CgkgICAgfQoJICAgIGNvbnN0IHsKCSAgICAgIGNvbnRleHQsCgkgICAgICB2YWx1ZQoJICAgIH0gPSByZXMucmVzdWx0OwoJICAgIHJldHVybiB7CgkgICAgICBjb250ZXh0LAoJICAgICAgdmFsdWU6IHZhbHVlICE9PSBudWxsID8gdmFsdWUuZmVlQ2FsY3VsYXRvciA6IG51bGwKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIGZlZSBmb3IgYSBtZXNzYWdlIGZyb20gdGhlIGNsdXN0ZXIsIHJldHVybiB3aXRoIGNvbnRleHQKCSAgICovCgkgIGFzeW5jIGdldEZlZUZvck1lc3NhZ2UobWVzc2FnZSwgY29tbWl0bWVudCkgewoJICAgIGNvbnN0IHdpcmVNZXNzYWdlID0gdG9CdWZmZXIobWVzc2FnZS5zZXJpYWxpemUoKSkudG9TdHJpbmcoJ2Jhc2U2NCcpOwoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW3dpcmVNZXNzYWdlXSwgY29tbWl0bWVudCk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0RmVlRm9yTWVzc2FnZScsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIGpzb25ScGNSZXN1bHRBbmRDb250ZXh0KG51bGxhYmxlKG51bWJlcigpKSkpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IGZlZSBmb3IgbWVzc2FnZScpOwoJICAgIH0KCSAgICBpZiAocmVzLnJlc3VsdCA9PT0gbnVsbCkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGJsb2NraGFzaCcpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIGEgbGlzdCBvZiBwcmlvcml0aXphdGlvbiBmZWVzIGZyb20gcmVjZW50IGJsb2Nrcy4KCSAgICovCgkgIGFzeW5jIGdldFJlY2VudFByaW9yaXRpemF0aW9uRmVlcyhjb25maWcpIHsKCSAgICBjb25zdCBhY2NvdW50cyA9IGNvbmZpZz8ubG9ja2VkV3JpdGFibGVBY2NvdW50cz8ubWFwKGtleSA9PiBrZXkudG9CYXNlNTgoKSk7CgkgICAgY29uc3QgYXJncyA9IGFjY291bnRzPy5sZW5ndGggPyBbYWNjb3VudHNdIDogW107CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0UmVjZW50UHJpb3JpdGl6YXRpb25GZWVzJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0UmVjZW50UHJpb3JpdGl6YXRpb25GZWVzUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCByZWNlbnQgcHJpb3JpdGl6YXRpb24gZmVlcycpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoJICAvKioKCSAgICogRmV0Y2ggYSByZWNlbnQgYmxvY2toYXNoIGZyb20gdGhlIGNsdXN0ZXIKCSAgICogQHJldHVybiB7UHJvbWlzZTx7YmxvY2toYXNoOiBCbG9ja2hhc2gsIGZlZUNhbGN1bGF0b3I6IEZlZUNhbGN1bGF0b3J9Pn0KCSAgICoKCSAgICogQGRlcHJlY2F0ZWQgRGVwcmVjYXRlZCBzaW5jZSBSUEMgdjEuOC4wLiBQbGVhc2UgdXNlIHtAbGluayBnZXRMYXRlc3RCbG9ja2hhc2h9IGluc3RlYWQuCgkgICAqLwoJICBhc3luYyBnZXRSZWNlbnRCbG9ja2hhc2goY29tbWl0bWVudCkgewoJICAgIHRyeSB7CgkgICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmdldFJlY2VudEJsb2NraGFzaEFuZENvbnRleHQoY29tbWl0bWVudCk7CgkgICAgICByZXR1cm4gcmVzLnZhbHVlOwoJICAgIH0gY2F0Y2ggKGUpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGdldCByZWNlbnQgYmxvY2toYXNoOiAnICsgZSk7CgkgICAgfQoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIGxhdGVzdCBibG9ja2hhc2ggZnJvbSB0aGUgY2x1c3RlcgoJICAgKiBAcmV0dXJuIHtQcm9taXNlPEJsb2NraGFzaFdpdGhFeHBpcnlCbG9ja0hlaWdodD59CgkgICAqLwoJICBhc3luYyBnZXRMYXRlc3RCbG9ja2hhc2goY29tbWl0bWVudE9yQ29uZmlnKSB7CgkgICAgdHJ5IHsKCSAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZ2V0TGF0ZXN0QmxvY2toYXNoQW5kQ29udGV4dChjb21taXRtZW50T3JDb25maWcpOwoJICAgICAgcmV0dXJuIHJlcy52YWx1ZTsKCSAgICB9IGNhdGNoIChlKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byBnZXQgcmVjZW50IGJsb2NraGFzaDogJyArIGUpOwoJICAgIH0KCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBsYXRlc3QgYmxvY2toYXNoIGZyb20gdGhlIGNsdXN0ZXIKCSAgICogQHJldHVybiB7UHJvbWlzZTxCbG9ja2hhc2hXaXRoRXhwaXJ5QmxvY2tIZWlnaHQ+fQoJICAgKi8KCSAgYXN5bmMgZ2V0TGF0ZXN0QmxvY2toYXNoQW5kQ29udGV4dChjb21taXRtZW50T3JDb25maWcpIHsKCSAgICBjb25zdCB7CgkgICAgICBjb21taXRtZW50LAoJICAgICAgY29uZmlnCgkgICAgfSA9IGV4dHJhY3RDb21taXRtZW50RnJvbUNvbmZpZyhjb21taXRtZW50T3JDb25maWcpOwoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW10sIGNvbW1pdG1lbnQsIHVuZGVmaW5lZCAvKiBlbmNvZGluZyAqLywgY29uZmlnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRMYXRlc3RCbG9ja2hhc2gnLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRMYXRlc3RCbG9ja2hhc2hScGNSZXN1bHQpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IGxhdGVzdCBibG9ja2hhc2gnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBSZXR1cm5zIHdoZXRoZXIgYSBibG9ja2hhc2ggaXMgc3RpbGwgdmFsaWQgb3Igbm90CgkgICAqLwoJICBhc3luYyBpc0Jsb2NraGFzaFZhbGlkKGJsb2NraGFzaCwgcmF3Q29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcocmF3Q29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtibG9ja2hhc2hdLCBjb21taXRtZW50LCB1bmRlZmluZWQgLyogZW5jb2RpbmcgKi8sIGNvbmZpZyk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnaXNCbG9ja2hhc2hWYWxpZCcsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIElzQmxvY2toYXNoVmFsaWRScGNSZXN1bHQpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZGV0ZXJtaW5lIGlmIHRoZSBibG9ja2hhc2ggYCcgKyBibG9ja2hhc2ggKyAnYGlzIHZhbGlkJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIG5vZGUgdmVyc2lvbgoJICAgKi8KCSAgYXN5bmMgZ2V0VmVyc2lvbigpIHsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRWZXJzaW9uJywgW10pOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIGpzb25ScGNSZXN1bHQoVmVyc2lvblJlc3VsdCkpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IHZlcnNpb24nKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0aGUgZ2VuZXNpcyBoYXNoCgkgICAqLwoJICBhc3luYyBnZXRHZW5lc2lzSGFzaCgpIHsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRHZW5lc2lzSGFzaCcsIFtdKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0KHN0cmluZygpKSk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgZ2VuZXNpcyBoYXNoJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggYSBwcm9jZXNzZWQgYmxvY2sgZnJvbSB0aGUgY2x1c3Rlci4KCSAgICoKCSAgICogQGRlcHJlY2F0ZWQgSW5zdGVhZCwgY2FsbCBgZ2V0QmxvY2tgIHVzaW5nIGEgYEdldFZlcnNpb25lZEJsb2NrQ29uZmlnYCBieQoJICAgKiBzZXR0aW5nIHRoZSBgbWF4U3VwcG9ydGVkVHJhbnNhY3Rpb25WZXJzaW9uYCBwcm9wZXJ0eS4KCSAgICovCgoJICAvKioKCSAgICogQGRlcHJlY2F0ZWQgSW5zdGVhZCwgY2FsbCBgZ2V0QmxvY2tgIHVzaW5nIGEgYEdldFZlcnNpb25lZEJsb2NrQ29uZmlnYCBieQoJICAgKiBzZXR0aW5nIHRoZSBgbWF4U3VwcG9ydGVkVHJhbnNhY3Rpb25WZXJzaW9uYCBwcm9wZXJ0eS4KCSAgICovCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCgkgIC8qKgoJICAgKiBAZGVwcmVjYXRlZCBJbnN0ZWFkLCBjYWxsIGBnZXRCbG9ja2AgdXNpbmcgYSBgR2V0VmVyc2lvbmVkQmxvY2tDb25maWdgIGJ5CgkgICAqIHNldHRpbmcgdGhlIGBtYXhTdXBwb3J0ZWRUcmFuc2FjdGlvblZlcnNpb25gIHByb3BlcnR5LgoJICAgKi8KCSAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGUtY2xhc3MtbWVtYmVycwoKCSAgLyoqCgkgICAqIEZldGNoIGEgcHJvY2Vzc2VkIGJsb2NrIGZyb20gdGhlIGNsdXN0ZXIuCgkgICAqLwoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgoJICAvKioKCSAgICogRmV0Y2ggYSBwcm9jZXNzZWQgYmxvY2sgZnJvbSB0aGUgY2x1c3Rlci4KCSAgICovCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCSAgYXN5bmMgZ2V0QmxvY2soc2xvdCwgcmF3Q29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcocmF3Q29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChbc2xvdF0sIGNvbW1pdG1lbnQsIHVuZGVmaW5lZCAvKiBlbmNvZGluZyAqLywgY29uZmlnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRCbG9jaycsIGFyZ3MpOwoJICAgIHRyeSB7CgkgICAgICBzd2l0Y2ggKGNvbmZpZz8udHJhbnNhY3Rpb25EZXRhaWxzKSB7CgkgICAgICAgIGNhc2UgJ2FjY291bnRzJzoKCSAgICAgICAgICB7CgkgICAgICAgICAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRBY2NvdW50c01vZGVCbG9ja1JwY1Jlc3VsdCk7CgkgICAgICAgICAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgICAgICAgICAgdGhyb3cgcmVzLmVycm9yOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgICAgICAgICAgfQoJICAgICAgICBjYXNlICdub25lJzoKCSAgICAgICAgICB7CgkgICAgICAgICAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXROb25lTW9kZUJsb2NrUnBjUmVzdWx0KTsKCSAgICAgICAgICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgICAgICAgICB0aHJvdyByZXMuZXJyb3I7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgICAgICAgICB9CgkgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgewoJICAgICAgICAgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0QmxvY2tScGNSZXN1bHQpOwoJICAgICAgICAgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICAgICAgICAgIHRocm93IHJlcy5lcnJvcjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGNvbnN0IHsKCSAgICAgICAgICAgICAgcmVzdWx0CgkgICAgICAgICAgICB9ID0gcmVzOwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdCA/IHsKCSAgICAgICAgICAgICAgLi4ucmVzdWx0LAoJICAgICAgICAgICAgICB0cmFuc2FjdGlvbnM6IHJlc3VsdC50cmFuc2FjdGlvbnMubWFwKCh7CgkgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb24sCgkgICAgICAgICAgICAgICAgbWV0YSwKCSAgICAgICAgICAgICAgICB2ZXJzaW9uCgkgICAgICAgICAgICAgIH0pID0+ICh7CgkgICAgICAgICAgICAgICAgbWV0YSwKCSAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbjogewoJICAgICAgICAgICAgICAgICAgLi4udHJhbnNhY3Rpb24sCgkgICAgICAgICAgICAgICAgICBtZXNzYWdlOiB2ZXJzaW9uZWRNZXNzYWdlRnJvbVJlc3BvbnNlKHZlcnNpb24sIHRyYW5zYWN0aW9uLm1lc3NhZ2UpCgkgICAgICAgICAgICAgICAgfSwKCSAgICAgICAgICAgICAgICB2ZXJzaW9uCgkgICAgICAgICAgICAgIH0pKQoJICAgICAgICAgICAgfSA6IG51bGw7CgkgICAgICAgICAgfQoJICAgICAgfQoJICAgIH0gY2F0Y2ggKGUpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IoZSwgJ2ZhaWxlZCB0byBnZXQgY29uZmlybWVkIGJsb2NrJyk7CgkgICAgfQoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggcGFyc2VkIHRyYW5zYWN0aW9uIGRldGFpbHMgZm9yIGEgY29uZmlybWVkIG9yIGZpbmFsaXplZCBibG9jawoJICAgKi8KCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCSAgYXN5bmMgZ2V0UGFyc2VkQmxvY2soc2xvdCwgcmF3Q29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcocmF3Q29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChbc2xvdF0sIGNvbW1pdG1lbnQsICdqc29uUGFyc2VkJywgY29uZmlnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRCbG9jaycsIGFyZ3MpOwoJICAgIHRyeSB7CgkgICAgICBzd2l0Y2ggKGNvbmZpZz8udHJhbnNhY3Rpb25EZXRhaWxzKSB7CgkgICAgICAgIGNhc2UgJ2FjY291bnRzJzoKCSAgICAgICAgICB7CgkgICAgICAgICAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRQYXJzZWRBY2NvdW50c01vZGVCbG9ja1JwY1Jlc3VsdCk7CgkgICAgICAgICAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgICAgICAgICAgdGhyb3cgcmVzLmVycm9yOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgICAgICAgICAgfQoJICAgICAgICBjYXNlICdub25lJzoKCSAgICAgICAgICB7CgkgICAgICAgICAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRQYXJzZWROb25lTW9kZUJsb2NrUnBjUmVzdWx0KTsKCSAgICAgICAgICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgICAgICAgICB0aHJvdyByZXMuZXJyb3I7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgICAgICAgICB9CgkgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgewoJICAgICAgICAgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0UGFyc2VkQmxvY2tScGNSZXN1bHQpOwoJICAgICAgICAgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICAgICAgICAgIHRocm93IHJlcy5lcnJvcjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiByZXMucmVzdWx0OwoJICAgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGNhdGNoIChlKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKGUsICdmYWlsZWQgdG8gZ2V0IGJsb2NrJyk7CgkgICAgfQoJICB9CgkgIC8qCgkgICAqIFJldHVybnMgcmVjZW50IGJsb2NrIHByb2R1Y3Rpb24gaW5mb3JtYXRpb24gZnJvbSB0aGUgY3VycmVudCBvciBwcmV2aW91cyBlcG9jaAoJICAgKi8KCSAgYXN5bmMgZ2V0QmxvY2tQcm9kdWN0aW9uKGNvbmZpZ09yQ29tbWl0bWVudCkgewoJICAgIGxldCBleHRyYTsKCSAgICBsZXQgY29tbWl0bWVudDsKCSAgICBpZiAodHlwZW9mIGNvbmZpZ09yQ29tbWl0bWVudCA9PT0gJ3N0cmluZycpIHsKCSAgICAgIGNvbW1pdG1lbnQgPSBjb25maWdPckNvbW1pdG1lbnQ7CgkgICAgfSBlbHNlIGlmIChjb25maWdPckNvbW1pdG1lbnQpIHsKCSAgICAgIGNvbnN0IHsKCSAgICAgICAgY29tbWl0bWVudDogYywKCSAgICAgICAgLi4ucmVzdAoJICAgICAgfSA9IGNvbmZpZ09yQ29tbWl0bWVudDsKCSAgICAgIGNvbW1pdG1lbnQgPSBjOwoJICAgICAgZXh0cmEgPSByZXN0OwoJICAgIH0KCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtdLCBjb21taXRtZW50LCAnYmFzZTY0JywgZXh0cmEpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldEJsb2NrUHJvZHVjdGlvbicsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEJsb2NrUHJvZHVjdGlvblJlc3BvbnNlU3RydWN0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBibG9jayBwcm9kdWN0aW9uIGluZm9ybWF0aW9uJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggYSBjb25maXJtZWQgb3IgZmluYWxpemVkIHRyYW5zYWN0aW9uIGZyb20gdGhlIGNsdXN0ZXIuCgkgICAqCgkgICAqIEBkZXByZWNhdGVkIEluc3RlYWQsIGNhbGwgYGdldFRyYW5zYWN0aW9uYCB1c2luZyBhCgkgICAqIGBHZXRWZXJzaW9uZWRUcmFuc2FjdGlvbkNvbmZpZ2AgYnkgc2V0dGluZyB0aGUKCSAgICogYG1heFN1cHBvcnRlZFRyYW5zYWN0aW9uVmVyc2lvbmAgcHJvcGVydHkuCgkgICAqLwoKCSAgLyoqCgkgICAqIEZldGNoIGEgY29uZmlybWVkIG9yIGZpbmFsaXplZCB0cmFuc2FjdGlvbiBmcm9tIHRoZSBjbHVzdGVyLgoJICAgKi8KCSAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGUtY2xhc3MtbWVtYmVycwoKCSAgLyoqCgkgICAqIEZldGNoIGEgY29uZmlybWVkIG9yIGZpbmFsaXplZCB0cmFuc2FjdGlvbiBmcm9tIHRoZSBjbHVzdGVyLgoJICAgKi8KCSAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGUtY2xhc3MtbWVtYmVycwoJICBhc3luYyBnZXRUcmFuc2FjdGlvbihzaWduYXR1cmUsIHJhd0NvbmZpZykgewoJICAgIGNvbnN0IHsKCSAgICAgIGNvbW1pdG1lbnQsCgkgICAgICBjb25maWcKCSAgICB9ID0gZXh0cmFjdENvbW1pdG1lbnRGcm9tQ29uZmlnKHJhd0NvbmZpZyk7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJnc0F0TGVhc3RDb25maXJtZWQoW3NpZ25hdHVyZV0sIGNvbW1pdG1lbnQsIHVuZGVmaW5lZCAvKiBlbmNvZGluZyAqLywgY29uZmlnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRUcmFuc2FjdGlvbicsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldFRyYW5zYWN0aW9uUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCB0cmFuc2FjdGlvbicpOwoJICAgIH0KCSAgICBjb25zdCByZXN1bHQgPSByZXMucmVzdWx0OwoJICAgIGlmICghcmVzdWx0KSByZXR1cm4gcmVzdWx0OwoJICAgIHJldHVybiB7CgkgICAgICAuLi5yZXN1bHQsCgkgICAgICB0cmFuc2FjdGlvbjogewoJICAgICAgICAuLi5yZXN1bHQudHJhbnNhY3Rpb24sCgkgICAgICAgIG1lc3NhZ2U6IHZlcnNpb25lZE1lc3NhZ2VGcm9tUmVzcG9uc2UocmVzdWx0LnZlcnNpb24sIHJlc3VsdC50cmFuc2FjdGlvbi5tZXNzYWdlKQoJICAgICAgfQoJICAgIH07CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBwYXJzZWQgdHJhbnNhY3Rpb24gZGV0YWlscyBmb3IgYSBjb25maXJtZWQgb3IgZmluYWxpemVkIHRyYW5zYWN0aW9uCgkgICAqLwoJICBhc3luYyBnZXRQYXJzZWRUcmFuc2FjdGlvbihzaWduYXR1cmUsIGNvbW1pdG1lbnRPckNvbmZpZykgewoJICAgIGNvbnN0IHsKCSAgICAgIGNvbW1pdG1lbnQsCgkgICAgICBjb25maWcKCSAgICB9ID0gZXh0cmFjdENvbW1pdG1lbnRGcm9tQ29uZmlnKGNvbW1pdG1lbnRPckNvbmZpZyk7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJnc0F0TGVhc3RDb25maXJtZWQoW3NpZ25hdHVyZV0sIGNvbW1pdG1lbnQsICdqc29uUGFyc2VkJywgY29uZmlnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRUcmFuc2FjdGlvbicsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldFBhcnNlZFRyYW5zYWN0aW9uUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCB0cmFuc2FjdGlvbicpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHBhcnNlZCB0cmFuc2FjdGlvbiBkZXRhaWxzIGZvciBhIGJhdGNoIG9mIGNvbmZpcm1lZCB0cmFuc2FjdGlvbnMKCSAgICovCgkgIGFzeW5jIGdldFBhcnNlZFRyYW5zYWN0aW9ucyhzaWduYXR1cmVzLCBjb21taXRtZW50T3JDb25maWcpIHsKCSAgICBjb25zdCB7CgkgICAgICBjb21taXRtZW50LAoJICAgICAgY29uZmlnCgkgICAgfSA9IGV4dHJhY3RDb21taXRtZW50RnJvbUNvbmZpZyhjb21taXRtZW50T3JDb25maWcpOwoJICAgIGNvbnN0IGJhdGNoID0gc2lnbmF0dXJlcy5tYXAoc2lnbmF0dXJlID0+IHsKCSAgICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3NBdExlYXN0Q29uZmlybWVkKFtzaWduYXR1cmVdLCBjb21taXRtZW50LCAnanNvblBhcnNlZCcsIGNvbmZpZyk7CgkgICAgICByZXR1cm4gewoJICAgICAgICBtZXRob2ROYW1lOiAnZ2V0VHJhbnNhY3Rpb24nLAoJICAgICAgICBhcmdzCgkgICAgICB9OwoJICAgIH0pOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY0JhdGNoUmVxdWVzdChiYXRjaCk7CgkgICAgY29uc3QgcmVzID0gdW5zYWZlUmVzLm1hcCh1bnNhZmVSZXMgPT4gewoJICAgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0UGFyc2VkVHJhbnNhY3Rpb25ScGNSZXN1bHQpOwoJICAgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCB0cmFuc2FjdGlvbnMnKTsKCSAgICAgIH0KCSAgICAgIHJldHVybiByZXMucmVzdWx0OwoJICAgIH0pOwoJICAgIHJldHVybiByZXM7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCB0cmFuc2FjdGlvbiBkZXRhaWxzIGZvciBhIGJhdGNoIG9mIGNvbmZpcm1lZCB0cmFuc2FjdGlvbnMuCgkgICAqIFNpbWlsYXIgdG8ge0BsaW5rIGdldFBhcnNlZFRyYW5zYWN0aW9uc30gYnV0IHJldHVybnMgYSB7QGxpbmsgVHJhbnNhY3Rpb25SZXNwb25zZX0uCgkgICAqCgkgICAqIEBkZXByZWNhdGVkIEluc3RlYWQsIGNhbGwgYGdldFRyYW5zYWN0aW9uc2AgdXNpbmcgYQoJICAgKiBgR2V0VmVyc2lvbmVkVHJhbnNhY3Rpb25Db25maWdgIGJ5IHNldHRpbmcgdGhlCgkgICAqIGBtYXhTdXBwb3J0ZWRUcmFuc2FjdGlvblZlcnNpb25gIHByb3BlcnR5LgoJICAgKi8KCgkgIC8qKgoJICAgKiBGZXRjaCB0cmFuc2FjdGlvbiBkZXRhaWxzIGZvciBhIGJhdGNoIG9mIGNvbmZpcm1lZCB0cmFuc2FjdGlvbnMuCgkgICAqIFNpbWlsYXIgdG8ge0BsaW5rIGdldFBhcnNlZFRyYW5zYWN0aW9uc30gYnV0IHJldHVybnMgYSB7QGxpbmsKCSAgICogVmVyc2lvbmVkVHJhbnNhY3Rpb25SZXNwb25zZX0uCgkgICAqLwoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgoJICAvKioKCSAgICogRmV0Y2ggdHJhbnNhY3Rpb24gZGV0YWlscyBmb3IgYSBiYXRjaCBvZiBjb25maXJtZWQgdHJhbnNhY3Rpb25zLgoJICAgKiBTaW1pbGFyIHRvIHtAbGluayBnZXRQYXJzZWRUcmFuc2FjdGlvbnN9IGJ1dCByZXR1cm5zIGEge0BsaW5rCgkgICAqIFZlcnNpb25lZFRyYW5zYWN0aW9uUmVzcG9uc2V9LgoJICAgKi8KCSAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGUtY2xhc3MtbWVtYmVycwoJICBhc3luYyBnZXRUcmFuc2FjdGlvbnMoc2lnbmF0dXJlcywgY29tbWl0bWVudE9yQ29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBjb25zdCBiYXRjaCA9IHNpZ25hdHVyZXMubWFwKHNpZ25hdHVyZSA9PiB7CgkgICAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChbc2lnbmF0dXJlXSwgY29tbWl0bWVudCwgdW5kZWZpbmVkIC8qIGVuY29kaW5nICovLCBjb25maWcpOwoJICAgICAgcmV0dXJuIHsKCSAgICAgICAgbWV0aG9kTmFtZTogJ2dldFRyYW5zYWN0aW9uJywKCSAgICAgICAgYXJncwoJICAgICAgfTsKCSAgICB9KTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNCYXRjaFJlcXVlc3QoYmF0Y2gpOwoJICAgIGNvbnN0IHJlcyA9IHVuc2FmZVJlcy5tYXAodW5zYWZlUmVzID0+IHsKCSAgICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldFRyYW5zYWN0aW9uUnBjUmVzdWx0KTsKCSAgICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgdHJhbnNhY3Rpb25zJyk7CgkgICAgICB9CgkgICAgICBjb25zdCByZXN1bHQgPSByZXMucmVzdWx0OwoJICAgICAgaWYgKCFyZXN1bHQpIHJldHVybiByZXN1bHQ7CgkgICAgICByZXR1cm4gewoJICAgICAgICAuLi5yZXN1bHQsCgkgICAgICAgIHRyYW5zYWN0aW9uOiB7CgkgICAgICAgICAgLi4ucmVzdWx0LnRyYW5zYWN0aW9uLAoJICAgICAgICAgIG1lc3NhZ2U6IHZlcnNpb25lZE1lc3NhZ2VGcm9tUmVzcG9uc2UocmVzdWx0LnZlcnNpb24sIHJlc3VsdC50cmFuc2FjdGlvbi5tZXNzYWdlKQoJICAgICAgICB9CgkgICAgICB9OwoJICAgIH0pOwoJICAgIHJldHVybiByZXM7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBhIGxpc3Qgb2YgVHJhbnNhY3Rpb25zIGFuZCB0cmFuc2FjdGlvbiBzdGF0dXNlcyBmcm9tIHRoZSBjbHVzdGVyCgkgICAqIGZvciBhIGNvbmZpcm1lZCBibG9jay4KCSAgICoKCSAgICogQGRlcHJlY2F0ZWQgRGVwcmVjYXRlZCBzaW5jZSBSUEMgdjEuNy4wLiBQbGVhc2UgdXNlIHtAbGluayBnZXRCbG9ja30gaW5zdGVhZC4KCSAgICovCgkgIGFzeW5jIGdldENvbmZpcm1lZEJsb2NrKHNsb3QsIGNvbW1pdG1lbnQpIHsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChbc2xvdF0sIGNvbW1pdG1lbnQpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldEJsb2NrJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0Q29uZmlybWVkQmxvY2tScGNSZXN1bHQpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IGNvbmZpcm1lZCBibG9jaycpOwoJICAgIH0KCSAgICBjb25zdCByZXN1bHQgPSByZXMucmVzdWx0OwoJICAgIGlmICghcmVzdWx0KSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbmZpcm1lZCBibG9jayAnICsgc2xvdCArICcgbm90IGZvdW5kJyk7CgkgICAgfQoJICAgIGNvbnN0IGJsb2NrID0gewoJICAgICAgLi4ucmVzdWx0LAoJICAgICAgdHJhbnNhY3Rpb25zOiByZXN1bHQudHJhbnNhY3Rpb25zLm1hcCgoewoJICAgICAgICB0cmFuc2FjdGlvbiwKCSAgICAgICAgbWV0YQoJICAgICAgfSkgPT4gewoJICAgICAgICBjb25zdCBtZXNzYWdlID0gbmV3IE1lc3NhZ2UodHJhbnNhY3Rpb24ubWVzc2FnZSk7CgkgICAgICAgIHJldHVybiB7CgkgICAgICAgICAgbWV0YSwKCSAgICAgICAgICB0cmFuc2FjdGlvbjogewoJICAgICAgICAgICAgLi4udHJhbnNhY3Rpb24sCgkgICAgICAgICAgICBtZXNzYWdlCgkgICAgICAgICAgfQoJICAgICAgICB9OwoJICAgICAgfSkKCSAgICB9OwoJICAgIHJldHVybiB7CgkgICAgICAuLi5ibG9jaywKCSAgICAgIHRyYW5zYWN0aW9uczogYmxvY2sudHJhbnNhY3Rpb25zLm1hcCgoewoJICAgICAgICB0cmFuc2FjdGlvbiwKCSAgICAgICAgbWV0YQoJICAgICAgfSkgPT4gewoJICAgICAgICByZXR1cm4gewoJICAgICAgICAgIG1ldGEsCgkgICAgICAgICAgdHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uLnBvcHVsYXRlKHRyYW5zYWN0aW9uLm1lc3NhZ2UsIHRyYW5zYWN0aW9uLnNpZ25hdHVyZXMpCgkgICAgICAgIH07CgkgICAgICB9KQoJICAgIH07CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBjb25maXJtZWQgYmxvY2tzIGJldHdlZW4gdHdvIHNsb3RzCgkgICAqLwoJICBhc3luYyBnZXRCbG9ja3Moc3RhcnRTbG90LCBlbmRTbG90LCBjb21taXRtZW50KSB7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJnc0F0TGVhc3RDb25maXJtZWQoZW5kU2xvdCAhPT0gdW5kZWZpbmVkID8gW3N0YXJ0U2xvdCwgZW5kU2xvdF0gOiBbc3RhcnRTbG90XSwgY29tbWl0bWVudCk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0QmxvY2tzJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywganNvblJwY1Jlc3VsdChhcnJheShudW1iZXIoKSkpKTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBibG9ja3MnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBhIGxpc3Qgb2YgU2lnbmF0dXJlcyBmcm9tIHRoZSBjbHVzdGVyIGZvciBhIGJsb2NrLCBleGNsdWRpbmcgcmV3YXJkcwoJICAgKi8KCSAgYXN5bmMgZ2V0QmxvY2tTaWduYXR1cmVzKHNsb3QsIGNvbW1pdG1lbnQpIHsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChbc2xvdF0sIGNvbW1pdG1lbnQsIHVuZGVmaW5lZCwgewoJICAgICAgdHJhbnNhY3Rpb25EZXRhaWxzOiAnc2lnbmF0dXJlcycsCgkgICAgICByZXdhcmRzOiBmYWxzZQoJICAgIH0pOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldEJsb2NrJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgR2V0QmxvY2tTaWduYXR1cmVzUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBibG9jaycpOwoJICAgIH0KCSAgICBjb25zdCByZXN1bHQgPSByZXMucmVzdWx0OwoJICAgIGlmICghcmVzdWx0KSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Jsb2NrICcgKyBzbG90ICsgJyBub3QgZm91bmQnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIGEgbGlzdCBvZiBTaWduYXR1cmVzIGZyb20gdGhlIGNsdXN0ZXIgZm9yIGEgY29uZmlybWVkIGJsb2NrLCBleGNsdWRpbmcgcmV3YXJkcwoJICAgKgoJICAgKiBAZGVwcmVjYXRlZCBEZXByZWNhdGVkIHNpbmNlIFJQQyB2MS43LjAuIFBsZWFzZSB1c2Uge0BsaW5rIGdldEJsb2NrU2lnbmF0dXJlc30gaW5zdGVhZC4KCSAgICovCgkgIGFzeW5jIGdldENvbmZpcm1lZEJsb2NrU2lnbmF0dXJlcyhzbG90LCBjb21taXRtZW50KSB7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJnc0F0TGVhc3RDb25maXJtZWQoW3Nsb3RdLCBjb21taXRtZW50LCB1bmRlZmluZWQsIHsKCSAgICAgIHRyYW5zYWN0aW9uRGV0YWlsczogJ3NpZ25hdHVyZXMnLAoJICAgICAgcmV3YXJkczogZmFsc2UKCSAgICB9KTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRCbG9jaycsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldEJsb2NrU2lnbmF0dXJlc1JwY1Jlc3VsdCk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgY29uZmlybWVkIGJsb2NrJyk7CgkgICAgfQoJICAgIGNvbnN0IHJlc3VsdCA9IHJlcy5yZXN1bHQ7CgkgICAgaWYgKCFyZXN1bHQpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignQ29uZmlybWVkIGJsb2NrICcgKyBzbG90ICsgJyBub3QgZm91bmQnKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIGEgdHJhbnNhY3Rpb24gZGV0YWlscyBmb3IgYSBjb25maXJtZWQgdHJhbnNhY3Rpb24KCSAgICoKCSAgICogQGRlcHJlY2F0ZWQgRGVwcmVjYXRlZCBzaW5jZSBSUEMgdjEuNy4wLiBQbGVhc2UgdXNlIHtAbGluayBnZXRUcmFuc2FjdGlvbn0gaW5zdGVhZC4KCSAgICovCgkgIGFzeW5jIGdldENvbmZpcm1lZFRyYW5zYWN0aW9uKHNpZ25hdHVyZSwgY29tbWl0bWVudCkgewoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3NBdExlYXN0Q29uZmlybWVkKFtzaWduYXR1cmVdLCBjb21taXRtZW50KTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRUcmFuc2FjdGlvbicsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldFRyYW5zYWN0aW9uUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCB0cmFuc2FjdGlvbicpOwoJICAgIH0KCSAgICBjb25zdCByZXN1bHQgPSByZXMucmVzdWx0OwoJICAgIGlmICghcmVzdWx0KSByZXR1cm4gcmVzdWx0OwoJICAgIGNvbnN0IG1lc3NhZ2UgPSBuZXcgTWVzc2FnZShyZXN1bHQudHJhbnNhY3Rpb24ubWVzc2FnZSk7CgkgICAgY29uc3Qgc2lnbmF0dXJlcyA9IHJlc3VsdC50cmFuc2FjdGlvbi5zaWduYXR1cmVzOwoJICAgIHJldHVybiB7CgkgICAgICAuLi5yZXN1bHQsCgkgICAgICB0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24ucG9wdWxhdGUobWVzc2FnZSwgc2lnbmF0dXJlcykKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggcGFyc2VkIHRyYW5zYWN0aW9uIGRldGFpbHMgZm9yIGEgY29uZmlybWVkIHRyYW5zYWN0aW9uCgkgICAqCgkgICAqIEBkZXByZWNhdGVkIERlcHJlY2F0ZWQgc2luY2UgUlBDIHYxLjcuMC4gUGxlYXNlIHVzZSB7QGxpbmsgZ2V0UGFyc2VkVHJhbnNhY3Rpb259IGluc3RlYWQuCgkgICAqLwoJICBhc3luYyBnZXRQYXJzZWRDb25maXJtZWRUcmFuc2FjdGlvbihzaWduYXR1cmUsIGNvbW1pdG1lbnQpIHsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChbc2lnbmF0dXJlXSwgY29tbWl0bWVudCwgJ2pzb25QYXJzZWQnKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRUcmFuc2FjdGlvbicsIGFyZ3MpOwoJICAgIGNvbnN0IHJlcyA9IGNyZWF0ZSh1bnNhZmVSZXMsIEdldFBhcnNlZFRyYW5zYWN0aW9uUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIHRocm93IG5ldyBTb2xhbmFKU09OUlBDRXJyb3IocmVzLmVycm9yLCAnZmFpbGVkIHRvIGdldCBjb25maXJtZWQgdHJhbnNhY3Rpb24nKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBwYXJzZWQgdHJhbnNhY3Rpb24gZGV0YWlscyBmb3IgYSBiYXRjaCBvZiBjb25maXJtZWQgdHJhbnNhY3Rpb25zCgkgICAqCgkgICAqIEBkZXByZWNhdGVkIERlcHJlY2F0ZWQgc2luY2UgUlBDIHYxLjcuMC4gUGxlYXNlIHVzZSB7QGxpbmsgZ2V0UGFyc2VkVHJhbnNhY3Rpb25zfSBpbnN0ZWFkLgoJICAgKi8KCSAgYXN5bmMgZ2V0UGFyc2VkQ29uZmlybWVkVHJhbnNhY3Rpb25zKHNpZ25hdHVyZXMsIGNvbW1pdG1lbnQpIHsKCSAgICBjb25zdCBiYXRjaCA9IHNpZ25hdHVyZXMubWFwKHNpZ25hdHVyZSA9PiB7CgkgICAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChbc2lnbmF0dXJlXSwgY29tbWl0bWVudCwgJ2pzb25QYXJzZWQnKTsKCSAgICAgIHJldHVybiB7CgkgICAgICAgIG1ldGhvZE5hbWU6ICdnZXRUcmFuc2FjdGlvbicsCgkgICAgICAgIGFyZ3MKCSAgICAgIH07CgkgICAgfSk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjQmF0Y2hSZXF1ZXN0KGJhdGNoKTsKCSAgICBjb25zdCByZXMgPSB1bnNhZmVSZXMubWFwKHVuc2FmZVJlcyA9PiB7CgkgICAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRQYXJzZWRUcmFuc2FjdGlvblJwY1Jlc3VsdCk7CgkgICAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IGNvbmZpcm1lZCB0cmFuc2FjdGlvbnMnKTsKCSAgICAgIH0KCSAgICAgIHJldHVybiByZXMucmVzdWx0OwoJICAgIH0pOwoJICAgIHJldHVybiByZXM7CgkgIH0KCgkgIC8qKgoJICAgKiBGZXRjaCBhIGxpc3Qgb2YgYWxsIHRoZSBjb25maXJtZWQgc2lnbmF0dXJlcyBmb3IgdHJhbnNhY3Rpb25zIGludm9sdmluZyBhbiBhZGRyZXNzCgkgICAqIHdpdGhpbiBhIHNwZWNpZmllZCBzbG90IHJhbmdlLiBNYXggcmFuZ2UgYWxsb3dlZCBpcyAxMCwwMDAgc2xvdHMuCgkgICAqCgkgICAqIEBkZXByZWNhdGVkIERlcHJlY2F0ZWQgc2luY2UgUlBDIHYxLjMuIFBsZWFzZSB1c2Uge0BsaW5rIGdldENvbmZpcm1lZFNpZ25hdHVyZXNGb3JBZGRyZXNzMn0gaW5zdGVhZC4KCSAgICoKCSAgICogQHBhcmFtIGFkZHJlc3MgcXVlcmllZCBhZGRyZXNzCgkgICAqIEBwYXJhbSBzdGFydFNsb3Qgc3RhcnQgc2xvdCwgaW5jbHVzaXZlCgkgICAqIEBwYXJhbSBlbmRTbG90IGVuZCBzbG90LCBpbmNsdXNpdmUKCSAgICovCgkgIGFzeW5jIGdldENvbmZpcm1lZFNpZ25hdHVyZXNGb3JBZGRyZXNzKGFkZHJlc3MsIHN0YXJ0U2xvdCwgZW5kU2xvdCkgewoJICAgIGxldCBvcHRpb25zID0ge307CgkgICAgbGV0IGZpcnN0QXZhaWxhYmxlQmxvY2sgPSBhd2FpdCB0aGlzLmdldEZpcnN0QXZhaWxhYmxlQmxvY2soKTsKCSAgICB3aGlsZSAoISgndW50aWwnIGluIG9wdGlvbnMpKSB7CgkgICAgICBzdGFydFNsb3QtLTsKCSAgICAgIGlmIChzdGFydFNsb3QgPD0gMCB8fCBzdGFydFNsb3QgPCBmaXJzdEF2YWlsYWJsZUJsb2NrKSB7CgkgICAgICAgIGJyZWFrOwoJICAgICAgfQoJICAgICAgdHJ5IHsKCSAgICAgICAgY29uc3QgYmxvY2sgPSBhd2FpdCB0aGlzLmdldENvbmZpcm1lZEJsb2NrU2lnbmF0dXJlcyhzdGFydFNsb3QsICdmaW5hbGl6ZWQnKTsKCSAgICAgICAgaWYgKGJsb2NrLnNpZ25hdHVyZXMubGVuZ3RoID4gMCkgewoJICAgICAgICAgIG9wdGlvbnMudW50aWwgPSBibG9jay5zaWduYXR1cmVzW2Jsb2NrLnNpZ25hdHVyZXMubGVuZ3RoIC0gMV0udG9TdHJpbmcoKTsKCSAgICAgICAgfQoJICAgICAgfSBjYXRjaCAoZXJyKSB7CgkgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnIubWVzc2FnZS5pbmNsdWRlcygnc2tpcHBlZCcpKSB7CgkgICAgICAgICAgY29udGludWU7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgdGhyb3cgZXJyOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIGxldCBoaWdoZXN0Q29uZmlybWVkUm9vdCA9IGF3YWl0IHRoaXMuZ2V0U2xvdCgnZmluYWxpemVkJyk7CgkgICAgd2hpbGUgKCEoJ2JlZm9yZScgaW4gb3B0aW9ucykpIHsKCSAgICAgIGVuZFNsb3QrKzsKCSAgICAgIGlmIChlbmRTbG90ID4gaGlnaGVzdENvbmZpcm1lZFJvb3QpIHsKCSAgICAgICAgYnJlYWs7CgkgICAgICB9CgkgICAgICB0cnkgewoJICAgICAgICBjb25zdCBibG9jayA9IGF3YWl0IHRoaXMuZ2V0Q29uZmlybWVkQmxvY2tTaWduYXR1cmVzKGVuZFNsb3QpOwoJICAgICAgICBpZiAoYmxvY2suc2lnbmF0dXJlcy5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgb3B0aW9ucy5iZWZvcmUgPSBibG9jay5zaWduYXR1cmVzW2Jsb2NrLnNpZ25hdHVyZXMubGVuZ3RoIC0gMV0udG9TdHJpbmcoKTsKCSAgICAgICAgfQoJICAgICAgfSBjYXRjaCAoZXJyKSB7CgkgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnIubWVzc2FnZS5pbmNsdWRlcygnc2tpcHBlZCcpKSB7CgkgICAgICAgICAgY29udGludWU7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgdGhyb3cgZXJyOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIGNvbnN0IGNvbmZpcm1lZFNpZ25hdHVyZUluZm8gPSBhd2FpdCB0aGlzLmdldENvbmZpcm1lZFNpZ25hdHVyZXNGb3JBZGRyZXNzMihhZGRyZXNzLCBvcHRpb25zKTsKCSAgICByZXR1cm4gY29uZmlybWVkU2lnbmF0dXJlSW5mby5tYXAoaW5mbyA9PiBpbmZvLnNpZ25hdHVyZSk7CgkgIH0KCgkgIC8qKgoJICAgKiBSZXR1cm5zIGNvbmZpcm1lZCBzaWduYXR1cmVzIGZvciB0cmFuc2FjdGlvbnMgaW52b2x2aW5nIGFuCgkgICAqIGFkZHJlc3MgYmFja3dhcmRzIGluIHRpbWUgZnJvbSB0aGUgcHJvdmlkZWQgc2lnbmF0dXJlIG9yIG1vc3QgcmVjZW50IGNvbmZpcm1lZCBibG9jawoJICAgKgoJICAgKiBAZGVwcmVjYXRlZCBEZXByZWNhdGVkIHNpbmNlIFJQQyB2MS43LjAuIFBsZWFzZSB1c2Uge0BsaW5rIGdldFNpZ25hdHVyZXNGb3JBZGRyZXNzfSBpbnN0ZWFkLgoJICAgKi8KCSAgYXN5bmMgZ2V0Q29uZmlybWVkU2lnbmF0dXJlc0ZvckFkZHJlc3MyKGFkZHJlc3MsIG9wdGlvbnMsIGNvbW1pdG1lbnQpIHsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChbYWRkcmVzcy50b0Jhc2U1OCgpXSwgY29tbWl0bWVudCwgdW5kZWZpbmVkLCBvcHRpb25zKTsKCSAgICBjb25zdCB1bnNhZmVSZXMgPSBhd2FpdCB0aGlzLl9ycGNSZXF1ZXN0KCdnZXRDb25maXJtZWRTaWduYXR1cmVzRm9yQWRkcmVzczInLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRDb25maXJtZWRTaWduYXR1cmVzRm9yQWRkcmVzczJScGNSZXN1bHQpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsICdmYWlsZWQgdG8gZ2V0IGNvbmZpcm1lZCBzaWduYXR1cmVzIGZvciBhZGRyZXNzJyk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogUmV0dXJucyBjb25maXJtZWQgc2lnbmF0dXJlcyBmb3IgdHJhbnNhY3Rpb25zIGludm9sdmluZyBhbgoJICAgKiBhZGRyZXNzIGJhY2t3YXJkcyBpbiB0aW1lIGZyb20gdGhlIHByb3ZpZGVkIHNpZ25hdHVyZSBvciBtb3N0IHJlY2VudCBjb25maXJtZWQgYmxvY2sKCSAgICoKCSAgICoKCSAgICogQHBhcmFtIGFkZHJlc3MgcXVlcmllZCBhZGRyZXNzCgkgICAqIEBwYXJhbSBvcHRpb25zCgkgICAqLwoJICBhc3luYyBnZXRTaWduYXR1cmVzRm9yQWRkcmVzcyhhZGRyZXNzLCBvcHRpb25zLCBjb21taXRtZW50KSB7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJnc0F0TGVhc3RDb25maXJtZWQoW2FkZHJlc3MudG9CYXNlNTgoKV0sIGNvbW1pdG1lbnQsIHVuZGVmaW5lZCwgb3B0aW9ucyk7CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnZ2V0U2lnbmF0dXJlc0ZvckFkZHJlc3MnLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBHZXRTaWduYXR1cmVzRm9yQWRkcmVzc1JwY1Jlc3VsdCk7CgkgICAgaWYgKCdlcnJvcicgaW4gcmVzKSB7CgkgICAgICB0aHJvdyBuZXcgU29sYW5hSlNPTlJQQ0Vycm9yKHJlcy5lcnJvciwgJ2ZhaWxlZCB0byBnZXQgc2lnbmF0dXJlcyBmb3IgYWRkcmVzcycpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoJICBhc3luYyBnZXRBZGRyZXNzTG9va3VwVGFibGUoYWNjb3VudEtleSwgY29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29udGV4dCwKCSAgICAgIHZhbHVlOiBhY2NvdW50SW5mbwoJICAgIH0gPSBhd2FpdCB0aGlzLmdldEFjY291bnRJbmZvQW5kQ29udGV4dChhY2NvdW50S2V5LCBjb25maWcpOwoJICAgIGxldCB2YWx1ZSA9IG51bGw7CgkgICAgaWYgKGFjY291bnRJbmZvICE9PSBudWxsKSB7CgkgICAgICB2YWx1ZSA9IG5ldyBBZGRyZXNzTG9va3VwVGFibGVBY2NvdW50KHsKCSAgICAgICAga2V5OiBhY2NvdW50S2V5LAoJICAgICAgICBzdGF0ZTogQWRkcmVzc0xvb2t1cFRhYmxlQWNjb3VudC5kZXNlcmlhbGl6ZShhY2NvdW50SW5mby5kYXRhKQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiB7CgkgICAgICBjb250ZXh0LAoJICAgICAgdmFsdWUKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRmV0Y2ggdGhlIGNvbnRlbnRzIG9mIGEgTm9uY2UgYWNjb3VudCBmcm9tIHRoZSBjbHVzdGVyLCByZXR1cm4gd2l0aCBjb250ZXh0CgkgICAqLwoJICBhc3luYyBnZXROb25jZUFuZENvbnRleHQobm9uY2VBY2NvdW50LCBjb21taXRtZW50T3JDb25maWcpIHsKCSAgICBjb25zdCB7CgkgICAgICBjb250ZXh0LAoJICAgICAgdmFsdWU6IGFjY291bnRJbmZvCgkgICAgfSA9IGF3YWl0IHRoaXMuZ2V0QWNjb3VudEluZm9BbmRDb250ZXh0KG5vbmNlQWNjb3VudCwgY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBsZXQgdmFsdWUgPSBudWxsOwoJICAgIGlmIChhY2NvdW50SW5mbyAhPT0gbnVsbCkgewoJICAgICAgdmFsdWUgPSBOb25jZUFjY291bnQuZnJvbUFjY291bnREYXRhKGFjY291bnRJbmZvLmRhdGEpOwoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgY29udGV4dCwKCSAgICAgIHZhbHVlCgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIEZldGNoIHRoZSBjb250ZW50cyBvZiBhIE5vbmNlIGFjY291bnQgZnJvbSB0aGUgY2x1c3RlcgoJICAgKi8KCSAgYXN5bmMgZ2V0Tm9uY2Uobm9uY2VBY2NvdW50LCBjb21taXRtZW50T3JDb25maWcpIHsKCSAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXROb25jZUFuZENvbnRleHQobm9uY2VBY2NvdW50LCBjb21taXRtZW50T3JDb25maWcpLnRoZW4oeCA9PiB4LnZhbHVlKS5jYXRjaChlID0+IHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGdldCBub25jZSBmb3IgYWNjb3VudCAnICsgbm9uY2VBY2NvdW50LnRvQmFzZTU4KCkgKyAnOiAnICsgZSk7CgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBSZXF1ZXN0IGFuIGFsbG9jYXRpb24gb2YgbGFtcG9ydHMgdG8gdGhlIHNwZWNpZmllZCBhZGRyZXNzCgkgICAqCgkgICAqIGBgYHR5cGVzY3JpcHQKCSAgICogaW1wb3J0IHsgQ29ubmVjdGlvbiwgUHVibGljS2V5LCBMQU1QT1JUU19QRVJfU09MIH0gZnJvbSAiQHNvbGFuYS93ZWIzLmpzIjsKCSAgICoKCSAgICogKGFzeW5jICgpID0+IHsKCSAgICogICBjb25zdCBjb25uZWN0aW9uID0gbmV3IENvbm5lY3Rpb24oImh0dHBzOi8vYXBpLnRlc3RuZXQuc29sYW5hLmNvbSIsICJjb25maXJtZWQiKTsKCSAgICogICBjb25zdCBteUFkZHJlc3MgPSBuZXcgUHVibGljS2V5KCIybnIxYkhGVDg2Vzl0R255dm1ZVzR2Y0hLc1FCM3NWUWZuZGRhc3o0a0V4TSIpOwoJICAgKiAgIGNvbnN0IHNpZ25hdHVyZSA9IGF3YWl0IGNvbm5lY3Rpb24ucmVxdWVzdEFpcmRyb3AobXlBZGRyZXNzLCBMQU1QT1JUU19QRVJfU09MKTsKCSAgICogICBhd2FpdCBjb25uZWN0aW9uLmNvbmZpcm1UcmFuc2FjdGlvbihzaWduYXR1cmUpOwoJICAgKiB9KSgpOwoJICAgKiBgYGAKCSAgICovCgkgIGFzeW5jIHJlcXVlc3RBaXJkcm9wKHRvLCBsYW1wb3J0cykgewoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ3JlcXVlc3RBaXJkcm9wJywgW3RvLnRvQmFzZTU4KCksIGxhbXBvcnRzXSk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgUmVxdWVzdEFpcmRyb3BScGNSZXN1bHQpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsIGBhaXJkcm9wIHRvICR7dG8udG9CYXNlNTgoKX0gZmFpbGVkYCk7CgkgICAgfQoJICAgIHJldHVybiByZXMucmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBhc3luYyBfYmxvY2toYXNoV2l0aEV4cGlyeUJsb2NrSGVpZ2h0KGRpc2FibGVDYWNoZSkgewoJICAgIGlmICghZGlzYWJsZUNhY2hlKSB7CgkgICAgICAvLyBXYWl0IGZvciBwb2xsaW5nIHRvIGZpbmlzaAoJICAgICAgd2hpbGUgKHRoaXMuX3BvbGxpbmdCbG9ja2hhc2gpIHsKCSAgICAgICAgYXdhaXQgc2xlZXAoMTAwKTsKCSAgICAgIH0KCSAgICAgIGNvbnN0IHRpbWVTaW5jZUZldGNoID0gRGF0ZS5ub3coKSAtIHRoaXMuX2Jsb2NraGFzaEluZm8ubGFzdEZldGNoOwoJICAgICAgY29uc3QgZXhwaXJlZCA9IHRpbWVTaW5jZUZldGNoID49IEJMT0NLSEFTSF9DQUNIRV9USU1FT1VUX01TOwoJICAgICAgaWYgKHRoaXMuX2Jsb2NraGFzaEluZm8ubGF0ZXN0QmxvY2toYXNoICE9PSBudWxsICYmICFleHBpcmVkKSB7CgkgICAgICAgIHJldHVybiB0aGlzLl9ibG9ja2hhc2hJbmZvLmxhdGVzdEJsb2NraGFzaDsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3BvbGxOZXdCbG9ja2hhc2goKTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgYXN5bmMgX3BvbGxOZXdCbG9ja2hhc2goKSB7CgkgICAgdGhpcy5fcG9sbGluZ0Jsb2NraGFzaCA9IHRydWU7CgkgICAgdHJ5IHsKCSAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7CgkgICAgICBjb25zdCBjYWNoZWRMYXRlc3RCbG9ja2hhc2ggPSB0aGlzLl9ibG9ja2hhc2hJbmZvLmxhdGVzdEJsb2NraGFzaDsKCSAgICAgIGNvbnN0IGNhY2hlZEJsb2NraGFzaCA9IGNhY2hlZExhdGVzdEJsb2NraGFzaCA/IGNhY2hlZExhdGVzdEJsb2NraGFzaC5ibG9ja2hhc2ggOiBudWxsOwoJICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1MDsgaSsrKSB7CgkgICAgICAgIGNvbnN0IGxhdGVzdEJsb2NraGFzaCA9IGF3YWl0IHRoaXMuZ2V0TGF0ZXN0QmxvY2toYXNoKCdmaW5hbGl6ZWQnKTsKCSAgICAgICAgaWYgKGNhY2hlZEJsb2NraGFzaCAhPT0gbGF0ZXN0QmxvY2toYXNoLmJsb2NraGFzaCkgewoJICAgICAgICAgIHRoaXMuX2Jsb2NraGFzaEluZm8gPSB7CgkgICAgICAgICAgICBsYXRlc3RCbG9ja2hhc2gsCgkgICAgICAgICAgICBsYXN0RmV0Y2g6IERhdGUubm93KCksCgkgICAgICAgICAgICB0cmFuc2FjdGlvblNpZ25hdHVyZXM6IFtdLAoJICAgICAgICAgICAgc2ltdWxhdGVkU2lnbmF0dXJlczogW10KCSAgICAgICAgICB9OwoJICAgICAgICAgIHJldHVybiBsYXRlc3RCbG9ja2hhc2g7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFNsZWVwIGZvciBhcHByb3hpbWF0ZWx5IGhhbGYgYSBzbG90CgkgICAgICAgIGF3YWl0IHNsZWVwKE1TX1BFUl9TTE9UIC8gMik7CgkgICAgICB9CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBvYnRhaW4gYSBuZXcgYmxvY2toYXNoIGFmdGVyICR7RGF0ZS5ub3coKSAtIHN0YXJ0VGltZX1tc2ApOwoJICAgIH0gZmluYWxseSB7CgkgICAgICB0aGlzLl9wb2xsaW5nQmxvY2toYXNoID0gZmFsc2U7CgkgICAgfQoJICB9CgoJICAvKioKCSAgICogZ2V0IHRoZSBzdGFrZSBtaW5pbXVtIGRlbGVnYXRpb24KCSAgICovCgkgIGFzeW5jIGdldFN0YWtlTWluaW11bURlbGVnYXRpb24oY29uZmlnKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZzogY29uZmlnQXJnCgkgICAgfSA9IGV4dHJhY3RDb21taXRtZW50RnJvbUNvbmZpZyhjb25maWcpOwoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW10sIGNvbW1pdG1lbnQsICdiYXNlNjQnLCBjb25maWdBcmcpOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ2dldFN0YWtlTWluaW11bURlbGVnYXRpb24nLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBqc29uUnBjUmVzdWx0QW5kQ29udGV4dChudW1iZXIoKSkpOwoJICAgIGlmICgnZXJyb3InIGluIHJlcykgewoJICAgICAgdGhyb3cgbmV3IFNvbGFuYUpTT05SUENFcnJvcihyZXMuZXJyb3IsIGBmYWlsZWQgdG8gZ2V0IHN0YWtlIG1pbmltdW0gZGVsZWdhdGlvbmApOwoJICAgIH0KCSAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgfQoKCSAgLyoqCgkgICAqIFNpbXVsYXRlIGEgdHJhbnNhY3Rpb24KCSAgICoKCSAgICogQGRlcHJlY2F0ZWQgSW5zdGVhZCwgY2FsbCB7QGxpbmsgc2ltdWxhdGVUcmFuc2FjdGlvbn0gd2l0aCB7QGxpbmsKCSAgICogVmVyc2lvbmVkVHJhbnNhY3Rpb259IGFuZCB7QGxpbmsgU2ltdWxhdGVUcmFuc2FjdGlvbkNvbmZpZ30gcGFyYW1ldGVycwoJICAgKi8KCgkgIC8qKgoJICAgKiBTaW11bGF0ZSBhIHRyYW5zYWN0aW9uCgkgICAqLwoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgoJICAvKioKCSAgICogU2ltdWxhdGUgYSB0cmFuc2FjdGlvbgoJICAgKi8KCSAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGUtY2xhc3MtbWVtYmVycwoJICBhc3luYyBzaW11bGF0ZVRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uT3JNZXNzYWdlLCBjb25maWdPclNpZ25lcnMsIGluY2x1ZGVBY2NvdW50cykgewoJICAgIGlmICgnbWVzc2FnZScgaW4gdHJhbnNhY3Rpb25Pck1lc3NhZ2UpIHsKCSAgICAgIGNvbnN0IHZlcnNpb25lZFR4ID0gdHJhbnNhY3Rpb25Pck1lc3NhZ2U7CgkgICAgICBjb25zdCB3aXJlVHJhbnNhY3Rpb24gPSB2ZXJzaW9uZWRUeC5zZXJpYWxpemUoKTsKCSAgICAgIGNvbnN0IGVuY29kZWRUcmFuc2FjdGlvbiA9IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20od2lyZVRyYW5zYWN0aW9uKS50b1N0cmluZygnYmFzZTY0Jyk7CgkgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb25maWdPclNpZ25lcnMpIHx8IGluY2x1ZGVBY2NvdW50cyAhPT0gdW5kZWZpbmVkKSB7CgkgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBhcmd1bWVudHMnKTsKCSAgICAgIH0KCSAgICAgIGNvbnN0IGNvbmZpZyA9IGNvbmZpZ09yU2lnbmVycyB8fCB7fTsKCSAgICAgIGNvbmZpZy5lbmNvZGluZyA9ICdiYXNlNjQnOwoJICAgICAgaWYgKCEoJ2NvbW1pdG1lbnQnIGluIGNvbmZpZykpIHsKCSAgICAgICAgY29uZmlnLmNvbW1pdG1lbnQgPSB0aGlzLmNvbW1pdG1lbnQ7CgkgICAgICB9CgkgICAgICBpZiAoY29uZmlnT3JTaWduZXJzICYmIHR5cGVvZiBjb25maWdPclNpZ25lcnMgPT09ICdvYmplY3QnICYmICdpbm5lckluc3RydWN0aW9ucycgaW4gY29uZmlnT3JTaWduZXJzKSB7CgkgICAgICAgIGNvbmZpZy5pbm5lckluc3RydWN0aW9ucyA9IGNvbmZpZ09yU2lnbmVycy5pbm5lckluc3RydWN0aW9uczsKCSAgICAgIH0KCSAgICAgIGNvbnN0IGFyZ3MgPSBbZW5jb2RlZFRyYW5zYWN0aW9uLCBjb25maWddOwoJICAgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnc2ltdWxhdGVUcmFuc2FjdGlvbicsIGFyZ3MpOwoJICAgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgU2ltdWxhdGVkVHJhbnNhY3Rpb25SZXNwb25zZVN0cnVjdCk7CgkgICAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gc2ltdWxhdGUgdHJhbnNhY3Rpb246ICcgKyByZXMuZXJyb3IubWVzc2FnZSk7CgkgICAgICB9CgkgICAgICByZXR1cm4gcmVzLnJlc3VsdDsKCSAgICB9CgkgICAgbGV0IHRyYW5zYWN0aW9uOwoJICAgIGlmICh0cmFuc2FjdGlvbk9yTWVzc2FnZSBpbnN0YW5jZW9mIFRyYW5zYWN0aW9uKSB7CgkgICAgICBsZXQgb3JpZ2luYWxUeCA9IHRyYW5zYWN0aW9uT3JNZXNzYWdlOwoJICAgICAgdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKTsKCSAgICAgIHRyYW5zYWN0aW9uLmZlZVBheWVyID0gb3JpZ2luYWxUeC5mZWVQYXllcjsKCSAgICAgIHRyYW5zYWN0aW9uLmluc3RydWN0aW9ucyA9IHRyYW5zYWN0aW9uT3JNZXNzYWdlLmluc3RydWN0aW9uczsKCSAgICAgIHRyYW5zYWN0aW9uLm5vbmNlSW5mbyA9IG9yaWdpbmFsVHgubm9uY2VJbmZvOwoJICAgICAgdHJhbnNhY3Rpb24uc2lnbmF0dXJlcyA9IG9yaWdpbmFsVHguc2lnbmF0dXJlczsKCSAgICB9IGVsc2UgewoJICAgICAgdHJhbnNhY3Rpb24gPSBUcmFuc2FjdGlvbi5wb3B1bGF0ZSh0cmFuc2FjdGlvbk9yTWVzc2FnZSk7CgkgICAgICAvLyBIQUNLOiB0aGlzIGZ1bmN0aW9uIHJlbGllcyBvbiBtdXRhdGluZyB0aGUgcG9wdWxhdGVkIHRyYW5zYWN0aW9uCgkgICAgICB0cmFuc2FjdGlvbi5fbWVzc2FnZSA9IHRyYW5zYWN0aW9uLl9qc29uID0gdW5kZWZpbmVkOwoJICAgIH0KCSAgICBpZiAoY29uZmlnT3JTaWduZXJzICE9PSB1bmRlZmluZWQgJiYgIUFycmF5LmlzQXJyYXkoY29uZmlnT3JTaWduZXJzKSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGFyZ3VtZW50cycpOwoJICAgIH0KCSAgICBjb25zdCBzaWduZXJzID0gY29uZmlnT3JTaWduZXJzOwoJICAgIGlmICh0cmFuc2FjdGlvbi5ub25jZUluZm8gJiYgc2lnbmVycykgewoJICAgICAgdHJhbnNhY3Rpb24uc2lnbiguLi5zaWduZXJzKTsKCSAgICB9IGVsc2UgewoJICAgICAgbGV0IGRpc2FibGVDYWNoZSA9IHRoaXMuX2Rpc2FibGVCbG9ja2hhc2hDYWNoaW5nOwoJICAgICAgZm9yICg7OykgewoJICAgICAgICBjb25zdCBsYXRlc3RCbG9ja2hhc2ggPSBhd2FpdCB0aGlzLl9ibG9ja2hhc2hXaXRoRXhwaXJ5QmxvY2tIZWlnaHQoZGlzYWJsZUNhY2hlKTsKCSAgICAgICAgdHJhbnNhY3Rpb24ubGFzdFZhbGlkQmxvY2tIZWlnaHQgPSBsYXRlc3RCbG9ja2hhc2gubGFzdFZhbGlkQmxvY2tIZWlnaHQ7CgkgICAgICAgIHRyYW5zYWN0aW9uLnJlY2VudEJsb2NraGFzaCA9IGxhdGVzdEJsb2NraGFzaC5ibG9ja2hhc2g7CgkgICAgICAgIGlmICghc2lnbmVycykgYnJlYWs7CgkgICAgICAgIHRyYW5zYWN0aW9uLnNpZ24oLi4uc2lnbmVycyk7CgkgICAgICAgIGlmICghdHJhbnNhY3Rpb24uc2lnbmF0dXJlKSB7CgkgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCchc2lnbmF0dXJlJyk7IC8vIHNob3VsZCBuZXZlciBoYXBwZW4KCSAgICAgICAgfQoJICAgICAgICBjb25zdCBzaWduYXR1cmUgPSB0cmFuc2FjdGlvbi5zaWduYXR1cmUudG9TdHJpbmcoJ2Jhc2U2NCcpOwoJICAgICAgICBpZiAoIXRoaXMuX2Jsb2NraGFzaEluZm8uc2ltdWxhdGVkU2lnbmF0dXJlcy5pbmNsdWRlcyhzaWduYXR1cmUpICYmICF0aGlzLl9ibG9ja2hhc2hJbmZvLnRyYW5zYWN0aW9uU2lnbmF0dXJlcy5pbmNsdWRlcyhzaWduYXR1cmUpKSB7CgkgICAgICAgICAgLy8gVGhlIHNpZ25hdHVyZSBvZiB0aGlzIHRyYW5zYWN0aW9uIGhhcyBub3QgYmVlbiBzZWVuIGJlZm9yZSB3aXRoIHRoZQoJICAgICAgICAgIC8vIGN1cnJlbnQgcmVjZW50QmxvY2toYXNoLCBhbGwgZG9uZS4gTGV0J3MgYnJlYWsKCSAgICAgICAgICB0aGlzLl9ibG9ja2hhc2hJbmZvLnNpbXVsYXRlZFNpZ25hdHVyZXMucHVzaChzaWduYXR1cmUpOwoJICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIC8vIFRoaXMgdHJhbnNhY3Rpb24gd291bGQgYmUgdHJlYXRlZCBhcyBkdXBsaWNhdGUgKGl0cyBkZXJpdmVkIHNpZ25hdHVyZQoJICAgICAgICAgIC8vIG1hdGNoZWQgdG8gb25lIG9mIGFscmVhZHkgcmVjb3JkZWQgc2lnbmF0dXJlcykuCgkgICAgICAgICAgLy8gU28sIHdlIG11c3QgZmV0Y2ggYSBuZXcgYmxvY2toYXNoIGZvciBhIGRpZmZlcmVudCBzaWduYXR1cmUgYnkgZGlzYWJsaW5nCgkgICAgICAgICAgLy8gb3VyIGNhY2hlIG5vdCB0byB3YWl0IGZvciB0aGUgY2FjaGUgZXhwaXJhdGlvbiAoQkxPQ0tIQVNIX0NBQ0hFX1RJTUVPVVRfTVMpLgoJICAgICAgICAgIGRpc2FibGVDYWNoZSA9IHRydWU7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgY29uc3QgbWVzc2FnZSA9IHRyYW5zYWN0aW9uLl9jb21waWxlKCk7CgkgICAgY29uc3Qgc2lnbkRhdGEgPSBtZXNzYWdlLnNlcmlhbGl6ZSgpOwoJICAgIGNvbnN0IHdpcmVUcmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9uLl9zZXJpYWxpemUoc2lnbkRhdGEpOwoJICAgIGNvbnN0IGVuY29kZWRUcmFuc2FjdGlvbiA9IHdpcmVUcmFuc2FjdGlvbi50b1N0cmluZygnYmFzZTY0Jyk7CgkgICAgY29uc3QgY29uZmlnID0gewoJICAgICAgZW5jb2Rpbmc6ICdiYXNlNjQnLAoJICAgICAgY29tbWl0bWVudDogdGhpcy5jb21taXRtZW50CgkgICAgfTsKCSAgICBpZiAoaW5jbHVkZUFjY291bnRzKSB7CgkgICAgICBjb25zdCBhZGRyZXNzZXMgPSAoQXJyYXkuaXNBcnJheShpbmNsdWRlQWNjb3VudHMpID8gaW5jbHVkZUFjY291bnRzIDogbWVzc2FnZS5ub25Qcm9ncmFtSWRzKCkpLm1hcChrZXkgPT4ga2V5LnRvQmFzZTU4KCkpOwoJICAgICAgY29uZmlnWydhY2NvdW50cyddID0gewoJICAgICAgICBlbmNvZGluZzogJ2Jhc2U2NCcsCgkgICAgICAgIGFkZHJlc3NlcwoJICAgICAgfTsKCSAgICB9CgkgICAgaWYgKHNpZ25lcnMpIHsKCSAgICAgIGNvbmZpZy5zaWdWZXJpZnkgPSB0cnVlOwoJICAgIH0KCSAgICBpZiAoY29uZmlnT3JTaWduZXJzICYmIHR5cGVvZiBjb25maWdPclNpZ25lcnMgPT09ICdvYmplY3QnICYmICdpbm5lckluc3RydWN0aW9ucycgaW4gY29uZmlnT3JTaWduZXJzKSB7CgkgICAgICBjb25maWcuaW5uZXJJbnN0cnVjdGlvbnMgPSBjb25maWdPclNpZ25lcnMuaW5uZXJJbnN0cnVjdGlvbnM7CgkgICAgfQoJICAgIGNvbnN0IGFyZ3MgPSBbZW5jb2RlZFRyYW5zYWN0aW9uLCBjb25maWddOwoJICAgIGNvbnN0IHVuc2FmZVJlcyA9IGF3YWl0IHRoaXMuX3JwY1JlcXVlc3QoJ3NpbXVsYXRlVHJhbnNhY3Rpb24nLCBhcmdzKTsKCSAgICBjb25zdCByZXMgPSBjcmVhdGUodW5zYWZlUmVzLCBTaW11bGF0ZWRUcmFuc2FjdGlvblJlc3BvbnNlU3RydWN0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIGxldCBsb2dzOwoJICAgICAgaWYgKCdkYXRhJyBpbiByZXMuZXJyb3IpIHsKCSAgICAgICAgbG9ncyA9IHJlcy5lcnJvci5kYXRhLmxvZ3M7CgkgICAgICAgIGlmIChsb2dzICYmIEFycmF5LmlzQXJyYXkobG9ncykpIHsKCSAgICAgICAgICBjb25zdCB0cmFjZUluZGVudCA9ICdcbiAgICAnOwoJICAgICAgICAgIGNvbnN0IGxvZ1RyYWNlID0gdHJhY2VJbmRlbnQgKyBsb2dzLmpvaW4odHJhY2VJbmRlbnQpOwoJICAgICAgICAgIGNvbnNvbGUuZXJyb3IocmVzLmVycm9yLm1lc3NhZ2UsIGxvZ1RyYWNlKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgdGhyb3cgbmV3IFNlbmRUcmFuc2FjdGlvbkVycm9yKHsKCSAgICAgICAgYWN0aW9uOiAnc2ltdWxhdGUnLAoJICAgICAgICBzaWduYXR1cmU6ICcnLAoJICAgICAgICB0cmFuc2FjdGlvbk1lc3NhZ2U6IHJlcy5lcnJvci5tZXNzYWdlLAoJICAgICAgICBsb2dzOiBsb2dzCgkgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBTaWduIGFuZCBzZW5kIGEgdHJhbnNhY3Rpb24KCSAgICoKCSAgICogQGRlcHJlY2F0ZWQgSW5zdGVhZCwgY2FsbCB7QGxpbmsgc2VuZFRyYW5zYWN0aW9ufSB3aXRoIGEge0BsaW5rCgkgICAqIFZlcnNpb25lZFRyYW5zYWN0aW9ufQoJICAgKi8KCgkgIC8qKgoJICAgKiBTZW5kIGEgc2lnbmVkIHRyYW5zYWN0aW9uCgkgICAqLwoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgoJICAvKioKCSAgICogU2lnbiBhbmQgc2VuZCBhIHRyYW5zYWN0aW9uCgkgICAqLwoJICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZHVwZS1jbGFzcy1tZW1iZXJzCgkgIGFzeW5jIHNlbmRUcmFuc2FjdGlvbih0cmFuc2FjdGlvbiwgc2lnbmVyc09yT3B0aW9ucywgb3B0aW9ucykgewoJICAgIGlmICgndmVyc2lvbicgaW4gdHJhbnNhY3Rpb24pIHsKCSAgICAgIGlmIChzaWduZXJzT3JPcHRpb25zICYmIEFycmF5LmlzQXJyYXkoc2lnbmVyc09yT3B0aW9ucykpIHsKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGFyZ3VtZW50cycpOwoJICAgICAgfQoJICAgICAgY29uc3Qgd2lyZVRyYW5zYWN0aW9uID0gdHJhbnNhY3Rpb24uc2VyaWFsaXplKCk7CgkgICAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kUmF3VHJhbnNhY3Rpb24od2lyZVRyYW5zYWN0aW9uLCBzaWduZXJzT3JPcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKHNpZ25lcnNPck9wdGlvbnMgPT09IHVuZGVmaW5lZCB8fCAhQXJyYXkuaXNBcnJheShzaWduZXJzT3JPcHRpb25zKSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGFyZ3VtZW50cycpOwoJICAgIH0KCSAgICBjb25zdCBzaWduZXJzID0gc2lnbmVyc09yT3B0aW9uczsKCSAgICBpZiAodHJhbnNhY3Rpb24ubm9uY2VJbmZvKSB7CgkgICAgICB0cmFuc2FjdGlvbi5zaWduKC4uLnNpZ25lcnMpOwoJICAgIH0gZWxzZSB7CgkgICAgICBsZXQgZGlzYWJsZUNhY2hlID0gdGhpcy5fZGlzYWJsZUJsb2NraGFzaENhY2hpbmc7CgkgICAgICBmb3IgKDs7KSB7CgkgICAgICAgIGNvbnN0IGxhdGVzdEJsb2NraGFzaCA9IGF3YWl0IHRoaXMuX2Jsb2NraGFzaFdpdGhFeHBpcnlCbG9ja0hlaWdodChkaXNhYmxlQ2FjaGUpOwoJICAgICAgICB0cmFuc2FjdGlvbi5sYXN0VmFsaWRCbG9ja0hlaWdodCA9IGxhdGVzdEJsb2NraGFzaC5sYXN0VmFsaWRCbG9ja0hlaWdodDsKCSAgICAgICAgdHJhbnNhY3Rpb24ucmVjZW50QmxvY2toYXNoID0gbGF0ZXN0QmxvY2toYXNoLmJsb2NraGFzaDsKCSAgICAgICAgdHJhbnNhY3Rpb24uc2lnbiguLi5zaWduZXJzKTsKCSAgICAgICAgaWYgKCF0cmFuc2FjdGlvbi5zaWduYXR1cmUpIHsKCSAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyFzaWduYXR1cmUnKTsgLy8gc2hvdWxkIG5ldmVyIGhhcHBlbgoJICAgICAgICB9CgkgICAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHRyYW5zYWN0aW9uLnNpZ25hdHVyZS50b1N0cmluZygnYmFzZTY0Jyk7CgkgICAgICAgIGlmICghdGhpcy5fYmxvY2toYXNoSW5mby50cmFuc2FjdGlvblNpZ25hdHVyZXMuaW5jbHVkZXMoc2lnbmF0dXJlKSkgewoJICAgICAgICAgIC8vIFRoZSBzaWduYXR1cmUgb2YgdGhpcyB0cmFuc2FjdGlvbiBoYXMgbm90IGJlZW4gc2VlbiBiZWZvcmUgd2l0aCB0aGUKCSAgICAgICAgICAvLyBjdXJyZW50IHJlY2VudEJsb2NraGFzaCwgYWxsIGRvbmUuIExldCdzIGJyZWFrCgkgICAgICAgICAgdGhpcy5fYmxvY2toYXNoSW5mby50cmFuc2FjdGlvblNpZ25hdHVyZXMucHVzaChzaWduYXR1cmUpOwoJICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIC8vIFRoaXMgdHJhbnNhY3Rpb24gd291bGQgYmUgdHJlYXRlZCBhcyBkdXBsaWNhdGUgKGl0cyBkZXJpdmVkIHNpZ25hdHVyZQoJICAgICAgICAgIC8vIG1hdGNoZWQgdG8gb25lIG9mIGFscmVhZHkgcmVjb3JkZWQgc2lnbmF0dXJlcykuCgkgICAgICAgICAgLy8gU28sIHdlIG11c3QgZmV0Y2ggYSBuZXcgYmxvY2toYXNoIGZvciBhIGRpZmZlcmVudCBzaWduYXR1cmUgYnkgZGlzYWJsaW5nCgkgICAgICAgICAgLy8gb3VyIGNhY2hlIG5vdCB0byB3YWl0IGZvciB0aGUgY2FjaGUgZXhwaXJhdGlvbiAoQkxPQ0tIQVNIX0NBQ0hFX1RJTUVPVVRfTVMpLgoJICAgICAgICAgIGRpc2FibGVDYWNoZSA9IHRydWU7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgY29uc3Qgd2lyZVRyYW5zYWN0aW9uID0gdHJhbnNhY3Rpb24uc2VyaWFsaXplKCk7CgkgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFJhd1RyYW5zYWN0aW9uKHdpcmVUcmFuc2FjdGlvbiwgb3B0aW9ucyk7CgkgIH0KCgkgIC8qKgoJICAgKiBTZW5kIGEgdHJhbnNhY3Rpb24gdGhhdCBoYXMgYWxyZWFkeSBiZWVuIHNpZ25lZCBhbmQgc2VyaWFsaXplZCBpbnRvIHRoZQoJICAgKiB3aXJlIGZvcm1hdAoJICAgKi8KCSAgYXN5bmMgc2VuZFJhd1RyYW5zYWN0aW9uKHJhd1RyYW5zYWN0aW9uLCBvcHRpb25zKSB7CgkgICAgY29uc3QgZW5jb2RlZFRyYW5zYWN0aW9uID0gdG9CdWZmZXIocmF3VHJhbnNhY3Rpb24pLnRvU3RyaW5nKCdiYXNlNjQnKTsKCSAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnNlbmRFbmNvZGVkVHJhbnNhY3Rpb24oZW5jb2RlZFRyYW5zYWN0aW9uLCBvcHRpb25zKTsKCSAgICByZXR1cm4gcmVzdWx0OwoJICB9CgoJICAvKioKCSAgICogU2VuZCBhIHRyYW5zYWN0aW9uIHRoYXQgaGFzIGFscmVhZHkgYmVlbiBzaWduZWQsIHNlcmlhbGl6ZWQgaW50byB0aGUKCSAgICogd2lyZSBmb3JtYXQsIGFuZCBlbmNvZGVkIGFzIGEgYmFzZTY0IHN0cmluZwoJICAgKi8KCSAgYXN5bmMgc2VuZEVuY29kZWRUcmFuc2FjdGlvbihlbmNvZGVkVHJhbnNhY3Rpb24sIG9wdGlvbnMpIHsKCSAgICBjb25zdCBjb25maWcgPSB7CgkgICAgICBlbmNvZGluZzogJ2Jhc2U2NCcKCSAgICB9OwoJICAgIGNvbnN0IHNraXBQcmVmbGlnaHQgPSBvcHRpb25zICYmIG9wdGlvbnMuc2tpcFByZWZsaWdodDsKCSAgICBjb25zdCBwcmVmbGlnaHRDb21taXRtZW50ID0gc2tpcFByZWZsaWdodCA9PT0gdHJ1ZSA/ICdwcm9jZXNzZWQnIC8vIEZJWE1FIFJlbW92ZSB3aGVuIGh0dHBzOi8vZ2l0aHViLmNvbS9hbnphLXh5ei9hZ2F2ZS9wdWxsLzQ4MyBpcyBkZXBsb3llZC4KCSAgICA6IG9wdGlvbnMgJiYgb3B0aW9ucy5wcmVmbGlnaHRDb21taXRtZW50IHx8IHRoaXMuY29tbWl0bWVudDsKCSAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm1heFJldHJpZXMgIT0gbnVsbCkgewoJICAgICAgY29uZmlnLm1heFJldHJpZXMgPSBvcHRpb25zLm1heFJldHJpZXM7CgkgICAgfQoJICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMubWluQ29udGV4dFNsb3QgIT0gbnVsbCkgewoJICAgICAgY29uZmlnLm1pbkNvbnRleHRTbG90ID0gb3B0aW9ucy5taW5Db250ZXh0U2xvdDsKCSAgICB9CgkgICAgaWYgKHNraXBQcmVmbGlnaHQpIHsKCSAgICAgIGNvbmZpZy5za2lwUHJlZmxpZ2h0ID0gc2tpcFByZWZsaWdodDsKCSAgICB9CgkgICAgaWYgKHByZWZsaWdodENvbW1pdG1lbnQpIHsKCSAgICAgIGNvbmZpZy5wcmVmbGlnaHRDb21taXRtZW50ID0gcHJlZmxpZ2h0Q29tbWl0bWVudDsKCSAgICB9CgkgICAgY29uc3QgYXJncyA9IFtlbmNvZGVkVHJhbnNhY3Rpb24sIGNvbmZpZ107CgkgICAgY29uc3QgdW5zYWZlUmVzID0gYXdhaXQgdGhpcy5fcnBjUmVxdWVzdCgnc2VuZFRyYW5zYWN0aW9uJywgYXJncyk7CgkgICAgY29uc3QgcmVzID0gY3JlYXRlKHVuc2FmZVJlcywgU2VuZFRyYW5zYWN0aW9uUnBjUmVzdWx0KTsKCSAgICBpZiAoJ2Vycm9yJyBpbiByZXMpIHsKCSAgICAgIGxldCBsb2dzID0gdW5kZWZpbmVkOwoJICAgICAgaWYgKCdkYXRhJyBpbiByZXMuZXJyb3IpIHsKCSAgICAgICAgbG9ncyA9IHJlcy5lcnJvci5kYXRhLmxvZ3M7CgkgICAgICB9CgkgICAgICB0aHJvdyBuZXcgU2VuZFRyYW5zYWN0aW9uRXJyb3IoewoJICAgICAgICBhY3Rpb246IHNraXBQcmVmbGlnaHQgPyAnc2VuZCcgOiAnc2ltdWxhdGUnLAoJICAgICAgICBzaWduYXR1cmU6ICcnLAoJICAgICAgICB0cmFuc2FjdGlvbk1lc3NhZ2U6IHJlcy5lcnJvci5tZXNzYWdlLAoJICAgICAgICBsb2dzOiBsb2dzCgkgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIHJlcy5yZXN1bHQ7CgkgIH0KCgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIF93c09uT3BlbigpIHsKCSAgICB0aGlzLl9ycGNXZWJTb2NrZXRDb25uZWN0ZWQgPSB0cnVlOwoJICAgIHRoaXMuX3JwY1dlYlNvY2tldEhlYXJ0YmVhdCA9IHNldEludGVydmFsKCgpID0+IHsKCSAgICAgIC8vIFBpbmcgc2VydmVyIGV2ZXJ5IDVzIHRvIHByZXZlbnQgaWRsZSB0aW1lb3V0cwoJICAgICAgKGFzeW5jICgpID0+IHsKCSAgICAgICAgdHJ5IHsKCSAgICAgICAgICBhd2FpdCB0aGlzLl9ycGNXZWJTb2NrZXQubm90aWZ5KCdwaW5nJyk7CgkgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWVtcHR5CgkgICAgICAgIH0gY2F0Y2gge30KCSAgICAgIH0pKCk7CgkgICAgfSwgNTAwMCk7CgkgICAgdGhpcy5fdXBkYXRlU3Vic2NyaXB0aW9ucygpOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfd3NPbkVycm9yKGVycikgewoJICAgIHRoaXMuX3JwY1dlYlNvY2tldENvbm5lY3RlZCA9IGZhbHNlOwoJICAgIGNvbnNvbGUuZXJyb3IoJ3dzIGVycm9yOicsIGVyci5tZXNzYWdlKTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgX3dzT25DbG9zZShjb2RlKSB7CgkgICAgdGhpcy5fcnBjV2ViU29ja2V0Q29ubmVjdGVkID0gZmFsc2U7CgkgICAgdGhpcy5fcnBjV2ViU29ja2V0R2VuZXJhdGlvbiA9ICh0aGlzLl9ycGNXZWJTb2NrZXRHZW5lcmF0aW9uICsgMSkgJSBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUjsKCSAgICBpZiAodGhpcy5fcnBjV2ViU29ja2V0SWRsZVRpbWVvdXQpIHsKCSAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9ycGNXZWJTb2NrZXRJZGxlVGltZW91dCk7CgkgICAgICB0aGlzLl9ycGNXZWJTb2NrZXRJZGxlVGltZW91dCA9IG51bGw7CgkgICAgfQoJICAgIGlmICh0aGlzLl9ycGNXZWJTb2NrZXRIZWFydGJlYXQpIHsKCSAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fcnBjV2ViU29ja2V0SGVhcnRiZWF0KTsKCSAgICAgIHRoaXMuX3JwY1dlYlNvY2tldEhlYXJ0YmVhdCA9IG51bGw7CgkgICAgfQoJICAgIGlmIChjb2RlID09PSAxMDAwKSB7CgkgICAgICAvLyBleHBsaWNpdCBjbG9zZSwgY2hlY2sgaWYgYW55IHN1YnNjcmlwdGlvbnMgaGF2ZSBiZWVuIG1hZGUgc2luY2UgY2xvc2UKCSAgICAgIHRoaXMuX3VwZGF0ZVN1YnNjcmlwdGlvbnMoKTsKCSAgICAgIHJldHVybjsKCSAgICB9CgoJICAgIC8vIGltcGxpY2l0IGNsb3NlLCBwcmVwYXJlIHN1YnNjcmlwdGlvbnMgZm9yIGF1dG8tcmVjb25uZWN0CgkgICAgdGhpcy5fc3Vic2NyaXB0aW9uQ2FsbGJhY2tzQnlTZXJ2ZXJTdWJzY3JpcHRpb25JZCA9IHt9OwoJICAgIE9iamVjdC5lbnRyaWVzKHRoaXMuX3N1YnNjcmlwdGlvbnNCeUhhc2gpLmZvckVhY2goKFtoYXNoLCBzdWJzY3JpcHRpb25dKSA9PiB7CgkgICAgICB0aGlzLl9zZXRTdWJzY3JpcHRpb24oaGFzaCwgewoJICAgICAgICAuLi5zdWJzY3JpcHRpb24sCgkgICAgICAgIHN0YXRlOiAncGVuZGluZycKCSAgICAgIH0pOwoJICAgIH0pOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfc2V0U3Vic2NyaXB0aW9uKGhhc2gsIG5leHRTdWJzY3JpcHRpb24pIHsKCSAgICBjb25zdCBwcmV2U3RhdGUgPSB0aGlzLl9zdWJzY3JpcHRpb25zQnlIYXNoW2hhc2hdPy5zdGF0ZTsKCSAgICB0aGlzLl9zdWJzY3JpcHRpb25zQnlIYXNoW2hhc2hdID0gbmV4dFN1YnNjcmlwdGlvbjsKCSAgICBpZiAocHJldlN0YXRlICE9PSBuZXh0U3Vic2NyaXB0aW9uLnN0YXRlKSB7CgkgICAgICBjb25zdCBzdGF0ZUNoYW5nZUNhbGxiYWNrcyA9IHRoaXMuX3N1YnNjcmlwdGlvblN0YXRlQ2hhbmdlQ2FsbGJhY2tzQnlIYXNoW2hhc2hdOwoJICAgICAgaWYgKHN0YXRlQ2hhbmdlQ2FsbGJhY2tzKSB7CgkgICAgICAgIHN0YXRlQ2hhbmdlQ2FsbGJhY2tzLmZvckVhY2goY2IgPT4gewoJICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICBjYihuZXh0U3Vic2NyaXB0aW9uLnN0YXRlKTsKCSAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1lbXB0eQoJICAgICAgICAgIH0gY2F0Y2gge30KCSAgICAgICAgfSk7CgkgICAgICB9CgkgICAgfQoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfb25TdWJzY3JpcHRpb25TdGF0ZUNoYW5nZShjbGllbnRTdWJzY3JpcHRpb25JZCwgY2FsbGJhY2spIHsKCSAgICBjb25zdCBoYXNoID0gdGhpcy5fc3Vic2NyaXB0aW9uSGFzaEJ5Q2xpZW50U3Vic2NyaXB0aW9uSWRbY2xpZW50U3Vic2NyaXB0aW9uSWRdOwoJICAgIGlmIChoYXNoID09IG51bGwpIHsKCSAgICAgIHJldHVybiAoKSA9PiB7fTsKCSAgICB9CgkgICAgY29uc3Qgc3RhdGVDaGFuZ2VDYWxsYmFja3MgPSB0aGlzLl9zdWJzY3JpcHRpb25TdGF0ZUNoYW5nZUNhbGxiYWNrc0J5SGFzaFtoYXNoXSB8fD0gbmV3IFNldCgpOwoJICAgIHN0YXRlQ2hhbmdlQ2FsbGJhY2tzLmFkZChjYWxsYmFjayk7CgkgICAgcmV0dXJuICgpID0+IHsKCSAgICAgIHN0YXRlQ2hhbmdlQ2FsbGJhY2tzLmRlbGV0ZShjYWxsYmFjayk7CgkgICAgICBpZiAoc3RhdGVDaGFuZ2VDYWxsYmFja3Muc2l6ZSA9PT0gMCkgewoJICAgICAgICBkZWxldGUgdGhpcy5fc3Vic2NyaXB0aW9uU3RhdGVDaGFuZ2VDYWxsYmFja3NCeUhhc2hbaGFzaF07CgkgICAgICB9CgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgYXN5bmMgX3VwZGF0ZVN1YnNjcmlwdGlvbnMoKSB7CgkgICAgaWYgKE9iamVjdC5rZXlzKHRoaXMuX3N1YnNjcmlwdGlvbnNCeUhhc2gpLmxlbmd0aCA9PT0gMCkgewoJICAgICAgaWYgKHRoaXMuX3JwY1dlYlNvY2tldENvbm5lY3RlZCkgewoJICAgICAgICB0aGlzLl9ycGNXZWJTb2NrZXRDb25uZWN0ZWQgPSBmYWxzZTsKCSAgICAgICAgdGhpcy5fcnBjV2ViU29ja2V0SWRsZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKCSAgICAgICAgICB0aGlzLl9ycGNXZWJTb2NrZXRJZGxlVGltZW91dCA9IG51bGw7CgkgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgIHRoaXMuX3JwY1dlYlNvY2tldC5jbG9zZSgpOwoJICAgICAgICAgIH0gY2F0Y2ggKGVycikgewoJICAgICAgICAgICAgLy8gc3dhbGxvdyBlcnJvciBpZiBzb2NrZXQgaGFzIGFscmVhZHkgYmVlbiBjbG9zZWQuCgkgICAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IpIHsKCSAgICAgICAgICAgICAgY29uc29sZS5sb2coYEVycm9yIHdoZW4gY2xvc2luZyBzb2NrZXQgY29ubmVjdGlvbjogJHtlcnIubWVzc2FnZX1gKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9CgkgICAgICAgIH0sIDUwMCk7CgkgICAgICB9CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmICh0aGlzLl9ycGNXZWJTb2NrZXRJZGxlVGltZW91dCAhPT0gbnVsbCkgewoJICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3JwY1dlYlNvY2tldElkbGVUaW1lb3V0KTsKCSAgICAgIHRoaXMuX3JwY1dlYlNvY2tldElkbGVUaW1lb3V0ID0gbnVsbDsKCSAgICAgIHRoaXMuX3JwY1dlYlNvY2tldENvbm5lY3RlZCA9IHRydWU7CgkgICAgfQoJICAgIGlmICghdGhpcy5fcnBjV2ViU29ja2V0Q29ubmVjdGVkKSB7CgkgICAgICB0aGlzLl9ycGNXZWJTb2NrZXQuY29ubmVjdCgpOwoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBjb25zdCBhY3RpdmVXZWJTb2NrZXRHZW5lcmF0aW9uID0gdGhpcy5fcnBjV2ViU29ja2V0R2VuZXJhdGlvbjsKCSAgICBjb25zdCBpc0N1cnJlbnRDb25uZWN0aW9uU3RpbGxBY3RpdmUgPSAoKSA9PiB7CgkgICAgICByZXR1cm4gYWN0aXZlV2ViU29ja2V0R2VuZXJhdGlvbiA9PT0gdGhpcy5fcnBjV2ViU29ja2V0R2VuZXJhdGlvbjsKCSAgICB9OwoJICAgIGF3YWl0IFByb21pc2UuYWxsKAoJICAgIC8vIERvbid0IGJlIHRlbXB0ZWQgdG8gY2hhbmdlIHRoaXMgdG8gYE9iamVjdC5lbnRyaWVzYC4gV2UgY2FsbAoJICAgIC8vIGBfdXBkYXRlU3Vic2NyaXB0aW9uc2AgcmVjdXJzaXZlbHkgd2hlbiBwcm9jZXNzaW5nIHRoZSBzdGF0ZSwKCSAgICAvLyBzbyBpdCdzIGltcG9ydGFudCB0aGF0IHdlIGxvb2sgdXAgdGhlICpjdXJyZW50KiB2ZXJzaW9uIG9mCgkgICAgLy8gZWFjaCBzdWJzY3JpcHRpb24sIGV2ZXJ5IHRpbWUgd2UgcHJvY2VzcyBhIGhhc2guCgkgICAgT2JqZWN0LmtleXModGhpcy5fc3Vic2NyaXB0aW9uc0J5SGFzaCkubWFwKGFzeW5jIGhhc2ggPT4gewoJICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5fc3Vic2NyaXB0aW9uc0J5SGFzaFtoYXNoXTsKCSAgICAgIGlmIChzdWJzY3JpcHRpb24gPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAvLyBUaGlzIGVudHJ5IGhhcyBzaW5jZSBiZWVuIGRlbGV0ZWQuIFNraXAuCgkgICAgICAgIHJldHVybjsKCSAgICAgIH0KCSAgICAgIHN3aXRjaCAoc3Vic2NyaXB0aW9uLnN0YXRlKSB7CgkgICAgICAgIGNhc2UgJ3BlbmRpbmcnOgoJICAgICAgICBjYXNlICd1bnN1YnNjcmliZWQnOgoJICAgICAgICAgIGlmIChzdWJzY3JpcHRpb24uY2FsbGJhY2tzLnNpemUgPT09IDApIHsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogWW91IGNhbiBlbmQgdXAgaGVyZSB3aGVuOgoJICAgICAgICAgICAgICoKCSAgICAgICAgICAgICAqIC0gYSBzdWJzY3JpcHRpb24gaGFzIHJlY2VudGx5IHVuc3Vic2NyaWJlZAoJICAgICAgICAgICAgICogICB3aXRob3V0IGhhdmluZyBuZXcgY2FsbGJhY2tzIGFkZGVkIHRvIGl0CgkgICAgICAgICAgICAgKiAgIHdoaWxlIHRoZSB1bnN1YnNjcmliZSB3YXMgaW4gZmxpZ2h0LCBvcgoJICAgICAgICAgICAgICogLSB3aGVuIGEgcGVuZGluZyBzdWJzY3JpcHRpb24gaGFzIGl0cwoJICAgICAgICAgICAgICogICBsaXN0ZW5lcnMgcmVtb3ZlZCBiZWZvcmUgYSByZXF1ZXN0IHdhcwoJICAgICAgICAgICAgICogICBzZW50IHRvIHRoZSBzZXJ2ZXIuCgkgICAgICAgICAgICAgKgoJICAgICAgICAgICAgICogQmVpbmcgdGhhdCBub2JvZHkgaXMgaW50ZXJlc3RlZCBpbiB0aGlzCgkgICAgICAgICAgICAgKiBzdWJzY3JpcHRpb24gYW55IGxvbmdlciwgZGVsZXRlIGl0LgoJICAgICAgICAgICAgICovCgkgICAgICAgICAgICBkZWxldGUgdGhpcy5fc3Vic2NyaXB0aW9uc0J5SGFzaFtoYXNoXTsKCSAgICAgICAgICAgIGlmIChzdWJzY3JpcHRpb24uc3RhdGUgPT09ICd1bnN1YnNjcmliZWQnKSB7CgkgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpcHRpb25DYWxsYmFja3NCeVNlcnZlclN1YnNjcmlwdGlvbklkW3N1YnNjcmlwdGlvbi5zZXJ2ZXJTdWJzY3JpcHRpb25JZF07CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVTdWJzY3JpcHRpb25zKCk7CgkgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgfQoJICAgICAgICAgIGF3YWl0IChhc3luYyAoKSA9PiB7CgkgICAgICAgICAgICBjb25zdCB7CgkgICAgICAgICAgICAgIGFyZ3MsCgkgICAgICAgICAgICAgIG1ldGhvZAoJICAgICAgICAgICAgfSA9IHN1YnNjcmlwdGlvbjsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgIHRoaXMuX3NldFN1YnNjcmlwdGlvbihoYXNoLCB7CgkgICAgICAgICAgICAgICAgLi4uc3Vic2NyaXB0aW9uLAoJICAgICAgICAgICAgICAgIHN0YXRlOiAnc3Vic2NyaWJpbmcnCgkgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICBjb25zdCBzZXJ2ZXJTdWJzY3JpcHRpb25JZCA9IGF3YWl0IHRoaXMuX3JwY1dlYlNvY2tldC5jYWxsKG1ldGhvZCwgYXJncyk7CgkgICAgICAgICAgICAgIHRoaXMuX3NldFN1YnNjcmlwdGlvbihoYXNoLCB7CgkgICAgICAgICAgICAgICAgLi4uc3Vic2NyaXB0aW9uLAoJICAgICAgICAgICAgICAgIHNlcnZlclN1YnNjcmlwdGlvbklkLAoJICAgICAgICAgICAgICAgIHN0YXRlOiAnc3Vic2NyaWJlZCcKCSAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbkNhbGxiYWNrc0J5U2VydmVyU3Vic2NyaXB0aW9uSWRbc2VydmVyU3Vic2NyaXB0aW9uSWRdID0gc3Vic2NyaXB0aW9uLmNhbGxiYWNrczsKCSAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlU3Vic2NyaXB0aW9ucygpOwoJICAgICAgICAgICAgfSBjYXRjaCAoZSkgewoJICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBSZWNlaXZlZCAke2UgaW5zdGFuY2VvZiBFcnJvciA/ICcnIDogJ0pTT04tUlBDICd9ZXJyb3IgY2FsbGluZyBcYCR7bWV0aG9kfVxgYCwgewoJICAgICAgICAgICAgICAgIGFyZ3MsCgkgICAgICAgICAgICAgICAgZXJyb3I6IGUKCSAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgIGlmICghaXNDdXJyZW50Q29ubmVjdGlvblN0aWxsQWN0aXZlKCkpIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgLy8gVE9ETzogTWF5YmUgYWRkIGFuICdlcnJvcmVkJyBzdGF0ZSBvciBhIHJldHJ5IGxpbWl0PwoJICAgICAgICAgICAgICB0aGlzLl9zZXRTdWJzY3JpcHRpb24oaGFzaCwgewoJICAgICAgICAgICAgICAgIC4uLnN1YnNjcmlwdGlvbiwKCSAgICAgICAgICAgICAgICBzdGF0ZTogJ3BlbmRpbmcnCgkgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVTdWJzY3JpcHRpb25zKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfSkoKTsKCSAgICAgICAgICBicmVhazsKCSAgICAgICAgY2FzZSAnc3Vic2NyaWJlZCc6CgkgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5jYWxsYmFja3Muc2l6ZSA9PT0gMCkgewoJICAgICAgICAgICAgLy8gQnkgdGhlIHRpbWUgd2Ugc3VjY2Vzc2Z1bGx5IHNldCB1cCBhIHN1YnNjcmlwdGlvbgoJICAgICAgICAgICAgLy8gd2l0aCB0aGUgc2VydmVyLCB0aGUgY2xpZW50IHN0b3BwZWQgY2FyaW5nIGFib3V0IGl0LgoJICAgICAgICAgICAgLy8gVGVhciBpdCBkb3duIG5vdy4KCSAgICAgICAgICAgIGF3YWl0IChhc3luYyAoKSA9PiB7CgkgICAgICAgICAgICAgIGNvbnN0IHsKCSAgICAgICAgICAgICAgICBzZXJ2ZXJTdWJzY3JpcHRpb25JZCwKCSAgICAgICAgICAgICAgICB1bnN1YnNjcmliZU1ldGhvZAoJICAgICAgICAgICAgICB9ID0gc3Vic2NyaXB0aW9uOwoJICAgICAgICAgICAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9uc0F1dG9EaXNwb3NlZEJ5UnBjLmhhcyhzZXJ2ZXJTdWJzY3JpcHRpb25JZCkpIHsKCSAgICAgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAgICAgKiBTcGVjaWFsIGNhc2UuCgkgICAgICAgICAgICAgICAgICogSWYgd2UncmUgZGVhbGluZyB3aXRoIGEgc3Vic2NyaXB0aW9uIHRoYXQgaGFzIGJlZW4gYXV0by0KCSAgICAgICAgICAgICAgICAgKiBkaXNwb3NlZCBieSB0aGUgUlBDLCB0aGVuIHdlIGNhbiBza2lwIHRoZSBSUEMgY2FsbCB0bwoJICAgICAgICAgICAgICAgICAqIHRlYXIgZG93biB0aGUgc3Vic2NyaXB0aW9uIGhlcmUuCgkgICAgICAgICAgICAgICAgICoKCSAgICAgICAgICAgICAgICAgKiBOT1RFOiBUaGVyZSBpcyBhIHByb3Bvc2FsIHRvIGVsaW1pbmF0ZSB0aGlzIHNwZWNpYWwgY2FzZSwgaGVyZToKCSAgICAgICAgICAgICAgICAgKiBodHRwczovL2dpdGh1Yi5jb20vc29sYW5hLWxhYnMvc29sYW5hL2lzc3Vlcy8xODg5MgoJICAgICAgICAgICAgICAgICAqLwoJICAgICAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNBdXRvRGlzcG9zZWRCeVJwYy5kZWxldGUoc2VydmVyU3Vic2NyaXB0aW9uSWQpOwoJICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHRoaXMuX3NldFN1YnNjcmlwdGlvbihoYXNoLCB7CgkgICAgICAgICAgICAgICAgICAuLi5zdWJzY3JpcHRpb24sCgkgICAgICAgICAgICAgICAgICBzdGF0ZTogJ3Vuc3Vic2NyaWJpbmcnCgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgdGhpcy5fc2V0U3Vic2NyaXB0aW9uKGhhc2gsIHsKCSAgICAgICAgICAgICAgICAgIC4uLnN1YnNjcmlwdGlvbiwKCSAgICAgICAgICAgICAgICAgIHN0YXRlOiAndW5zdWJzY3JpYmluZycKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fcnBjV2ViU29ja2V0LmNhbGwodW5zdWJzY3JpYmVNZXRob2QsIFtzZXJ2ZXJTdWJzY3JpcHRpb25JZF0pOwoJICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKCSAgICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgRXJyb3IpIHsKCSAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgJHt1bnN1YnNjcmliZU1ldGhvZH0gZXJyb3I6YCwgZS5tZXNzYWdlKTsKCSAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgIGlmICghaXNDdXJyZW50Q29ubmVjdGlvblN0aWxsQWN0aXZlKCkpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgLy8gVE9ETzogTWF5YmUgYWRkIGFuICdlcnJvcmVkJyBzdGF0ZSBvciBhIHJldHJ5IGxpbWl0PwoJICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0U3Vic2NyaXB0aW9uKGhhc2gsIHsKCSAgICAgICAgICAgICAgICAgICAgLi4uc3Vic2NyaXB0aW9uLAoJICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ3N1YnNjcmliZWQnCgkgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZVN1YnNjcmlwdGlvbnMoKTsKCSAgICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgdGhpcy5fc2V0U3Vic2NyaXB0aW9uKGhhc2gsIHsKCSAgICAgICAgICAgICAgICAuLi5zdWJzY3JpcHRpb24sCgkgICAgICAgICAgICAgICAgc3RhdGU6ICd1bnN1YnNjcmliZWQnCgkgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVTdWJzY3JpcHRpb25zKCk7CgkgICAgICAgICAgICB9KSgpOwoJICAgICAgICAgIH0KCSAgICAgICAgICBicmVhazsKCSAgICAgIH0KCSAgICB9KSk7CgkgIH0KCgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIF9oYW5kbGVTZXJ2ZXJOb3RpZmljYXRpb24oc2VydmVyU3Vic2NyaXB0aW9uSWQsIGNhbGxiYWNrQXJncykgewoJICAgIGNvbnN0IGNhbGxiYWNrcyA9IHRoaXMuX3N1YnNjcmlwdGlvbkNhbGxiYWNrc0J5U2VydmVyU3Vic2NyaXB0aW9uSWRbc2VydmVyU3Vic2NyaXB0aW9uSWRdOwoJICAgIGlmIChjYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBjYWxsYmFja3MuZm9yRWFjaChjYiA9PiB7CgkgICAgICB0cnkgewoJICAgICAgICBjYigKCSAgICAgICAgLy8gSSBmYWlsZWQgdG8gZmluZCBhIHdheSB0byBjb252aW5jZSBUeXBlU2NyaXB0IHRoYXQgYGNiYCBpcyBvZiB0eXBlCgkgICAgICAgIC8vIGBUQ2FsbGJhY2tgIHdoaWNoIGlzIGNlcnRhaW5seSBjb21wYXRpYmxlIHdpdGggYFBhcmFtZXRlcnM8VENhbGxiYWNrPmAuCgkgICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L1R5cGVTY3JpcHQvaXNzdWVzLzQ3NjE1CgkgICAgICAgIC8vIEB0cy1pZ25vcmUKCSAgICAgICAgLi4uY2FsbGJhY2tBcmdzKTsKCSAgICAgIH0gY2F0Y2ggKGUpIHsKCSAgICAgICAgY29uc29sZS5lcnJvcihlKTsKCSAgICAgIH0KCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgX3dzT25BY2NvdW50Tm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbikgewoJICAgIGNvbnN0IHsKCSAgICAgIHJlc3VsdCwKCSAgICAgIHN1YnNjcmlwdGlvbgoJICAgIH0gPSBjcmVhdGUobm90aWZpY2F0aW9uLCBBY2NvdW50Tm90aWZpY2F0aW9uUmVzdWx0KTsKCSAgICB0aGlzLl9oYW5kbGVTZXJ2ZXJOb3RpZmljYXRpb24oc3Vic2NyaXB0aW9uLCBbcmVzdWx0LnZhbHVlLCByZXN1bHQuY29udGV4dF0pOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfbWFrZVN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb25Db25maWcsCgkgIC8qKgoJICAgKiBXaGVuIHByZXBhcmluZyBgYXJnc2AgZm9yIGEgY2FsbCB0byBgX21ha2VTdWJzY3JpcHRpb25gLCBiZSBzdXJlCgkgICAqIHRvIGNhcmVmdWxseSBhcHBseSBhIGRlZmF1bHQgYGNvbW1pdG1lbnRgIHByb3BlcnR5LCBpZiBuZWNlc3NhcnkuCgkgICAqCgkgICAqIC0gSWYgdGhlIHVzZXIgc3VwcGxpZWQgYSBgY29tbWl0bWVudGAgdXNlIHRoYXQuCgkgICAqIC0gT3RoZXJ3aXNlLCBpZiB0aGUgYENvbm5lY3Rpb246OmNvbW1pdG1lbnRgIGlzIHNldCwgdXNlIHRoYXQuCgkgICAqIC0gT3RoZXJ3aXNlLCBzZXQgaXQgdG8gdGhlIFJQQyBzZXJ2ZXIgZGVmYXVsdDogYGZpbmFsaXplZGAuCgkgICAqCgkgICAqIFRoaXMgaXMgZXh0cmVtZWx5IGltcG9ydGFudCB0byBlbnN1cmUgdGhhdCB0aGVzZSB0d28gZnVuZGFtZW50YWxseQoJICAgKiBpZGVudGljYWwgc3Vic2NyaXB0aW9ucyBwcm9kdWNlIHRoZSBzYW1lIGlkZW50aWZ5aW5nIGhhc2g6CgkgICAqCgkgICAqIC0gQSBzdWJzY3JpcHRpb24gbWFkZSB3aXRob3V0IHNwZWNpZnlpbmcgYSBjb21taXRtZW50LgoJICAgKiAtIEEgc3Vic2NyaXB0aW9uIG1hZGUgd2hlcmUgdGhlIGNvbW1pdG1lbnQgc3BlY2lmaWVkIGlzIHRoZSBzYW1lCgkgICAqICAgYXMgdGhlIGRlZmF1bHQgYXBwbGllZCB0byB0aGUgc3Vic2NyaXB0aW9uIGFib3ZlLgoJICAgKgoJICAgKiBFeGFtcGxlOyB0aGVzZSB0d28gc3Vic2NyaXB0aW9ucyBtdXN0IHByb2R1Y2UgdGhlIHNhbWUgaGFzaDoKCSAgICoKCSAgICogLSBBbiBgYWNjb3VudFN1YnNjcmliZWAgc3Vic2NyaXB0aW9uIGZvciBgJ1BVQktFWSdgCgkgICAqIC0gQW4gYGFjY291bnRTdWJzY3JpYmVgIHN1YnNjcmlwdGlvbiBmb3IgYCdQVUJLRVknYCB3aXRoIGNvbW1pdG1lbnQKCSAgICogICBgJ2ZpbmFsaXplZCdgLgoJICAgKgoJICAgKiBTZWUgdGhlICdtYWtpbmcgYSBzdWJzY3JpcHRpb24gd2l0aCBkZWZhdWx0ZWQgcGFyYW1zIG9taXR0ZWQnIHRlc3QKCSAgICogaW4gYGNvbm5lY3Rpb24tc3Vic2NyaXB0aW9ucy50c2AgZm9yIG1vcmUuCgkgICAqLwoJICBhcmdzKSB7CgkgICAgY29uc3QgY2xpZW50U3Vic2NyaXB0aW9uSWQgPSB0aGlzLl9uZXh0Q2xpZW50U3Vic2NyaXB0aW9uSWQrKzsKCSAgICBjb25zdCBoYXNoID0gZmFzdFN0YWJsZVN0cmluZ2lmeShbc3Vic2NyaXB0aW9uQ29uZmlnLm1ldGhvZCwgYXJnc10pOwoJICAgIGNvbnN0IGV4aXN0aW5nU3Vic2NyaXB0aW9uID0gdGhpcy5fc3Vic2NyaXB0aW9uc0J5SGFzaFtoYXNoXTsKCSAgICBpZiAoZXhpc3RpbmdTdWJzY3JpcHRpb24gPT09IHVuZGVmaW5lZCkgewoJICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uc0J5SGFzaFtoYXNoXSA9IHsKCSAgICAgICAgLi4uc3Vic2NyaXB0aW9uQ29uZmlnLAoJICAgICAgICBhcmdzLAoJICAgICAgICBjYWxsYmFja3M6IG5ldyBTZXQoW3N1YnNjcmlwdGlvbkNvbmZpZy5jYWxsYmFja10pLAoJICAgICAgICBzdGF0ZTogJ3BlbmRpbmcnCgkgICAgICB9OwoJICAgIH0gZWxzZSB7CgkgICAgICBleGlzdGluZ1N1YnNjcmlwdGlvbi5jYWxsYmFja3MuYWRkKHN1YnNjcmlwdGlvbkNvbmZpZy5jYWxsYmFjayk7CgkgICAgfQoJICAgIHRoaXMuX3N1YnNjcmlwdGlvbkhhc2hCeUNsaWVudFN1YnNjcmlwdGlvbklkW2NsaWVudFN1YnNjcmlwdGlvbklkXSA9IGhhc2g7CgkgICAgdGhpcy5fc3Vic2NyaXB0aW9uRGlzcG9zZUZ1bmN0aW9uc0J5Q2xpZW50U3Vic2NyaXB0aW9uSWRbY2xpZW50U3Vic2NyaXB0aW9uSWRdID0gYXN5bmMgKCkgPT4gewoJICAgICAgZGVsZXRlIHRoaXMuX3N1YnNjcmlwdGlvbkRpc3Bvc2VGdW5jdGlvbnNCeUNsaWVudFN1YnNjcmlwdGlvbklkW2NsaWVudFN1YnNjcmlwdGlvbklkXTsKCSAgICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpcHRpb25IYXNoQnlDbGllbnRTdWJzY3JpcHRpb25JZFtjbGllbnRTdWJzY3JpcHRpb25JZF07CgkgICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLl9zdWJzY3JpcHRpb25zQnlIYXNoW2hhc2hdOwoJICAgICAgYXNzZXJ0JDEoc3Vic2NyaXB0aW9uICE9PSB1bmRlZmluZWQsIGBDb3VsZCBub3QgZmluZCBhIFxgU3Vic2NyaXB0aW9uXGAgd2hlbiB0ZWFyaW5nIGRvd24gY2xpZW50IHN1YnNjcmlwdGlvbiAjJHtjbGllbnRTdWJzY3JpcHRpb25JZH1gKTsKCSAgICAgIHN1YnNjcmlwdGlvbi5jYWxsYmFja3MuZGVsZXRlKHN1YnNjcmlwdGlvbkNvbmZpZy5jYWxsYmFjayk7CgkgICAgICBhd2FpdCB0aGlzLl91cGRhdGVTdWJzY3JpcHRpb25zKCk7CgkgICAgfTsKCSAgICB0aGlzLl91cGRhdGVTdWJzY3JpcHRpb25zKCk7CgkgICAgcmV0dXJuIGNsaWVudFN1YnNjcmlwdGlvbklkOwoJICB9CgoJICAvKioKCSAgICogUmVnaXN0ZXIgYSBjYWxsYmFjayB0byBiZSBpbnZva2VkIHdoZW5ldmVyIHRoZSBzcGVjaWZpZWQgYWNjb3VudCBjaGFuZ2VzCgkgICAqCgkgICAqIEBwYXJhbSBwdWJsaWNLZXkgUHVibGljIGtleSBvZiB0aGUgYWNjb3VudCB0byBtb25pdG9yCgkgICAqIEBwYXJhbSBjYWxsYmFjayBGdW5jdGlvbiB0byBpbnZva2Ugd2hlbmV2ZXIgdGhlIGFjY291bnQgaXMgY2hhbmdlZAoJICAgKiBAcGFyYW0gY29uZmlnCgkgICAqIEByZXR1cm4gc3Vic2NyaXB0aW9uIGlkCgkgICAqLwoKCSAgLyoqIEBkZXByZWNhdGVkIEluc3RlYWQsIHBhc3MgaW4gYW4ge0BsaW5rIEFjY291bnRTdWJzY3JpcHRpb25Db25maWd9ICovCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCgkgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBlLWNsYXNzLW1lbWJlcnMKCSAgb25BY2NvdW50Q2hhbmdlKHB1YmxpY0tleSwgY2FsbGJhY2ssIGNvbW1pdG1lbnRPckNvbmZpZykgewoJICAgIGNvbnN0IHsKCSAgICAgIGNvbW1pdG1lbnQsCgkgICAgICBjb25maWcKCSAgICB9ID0gZXh0cmFjdENvbW1pdG1lbnRGcm9tQ29uZmlnKGNvbW1pdG1lbnRPckNvbmZpZyk7CgkgICAgY29uc3QgYXJncyA9IHRoaXMuX2J1aWxkQXJncyhbcHVibGljS2V5LnRvQmFzZTU4KCldLCBjb21taXRtZW50IHx8IHRoaXMuX2NvbW1pdG1lbnQgfHwgJ2ZpbmFsaXplZCcsCgkgICAgLy8gQXBwbHkgY29ubmVjdGlvbi9zZXJ2ZXIgZGVmYXVsdC4KCSAgICAnYmFzZTY0JywgY29uZmlnKTsKCSAgICByZXR1cm4gdGhpcy5fbWFrZVN1YnNjcmlwdGlvbih7CgkgICAgICBjYWxsYmFjaywKCSAgICAgIG1ldGhvZDogJ2FjY291bnRTdWJzY3JpYmUnLAoJICAgICAgdW5zdWJzY3JpYmVNZXRob2Q6ICdhY2NvdW50VW5zdWJzY3JpYmUnCgkgICAgfSwgYXJncyk7CgkgIH0KCgkgIC8qKgoJICAgKiBEZXJlZ2lzdGVyIGFuIGFjY291bnQgbm90aWZpY2F0aW9uIGNhbGxiYWNrCgkgICAqCgkgICAqIEBwYXJhbSBjbGllbnRTdWJzY3JpcHRpb25JZCBjbGllbnQgc3Vic2NyaXB0aW9uIGlkIHRvIGRlcmVnaXN0ZXIKCSAgICovCgkgIGFzeW5jIHJlbW92ZUFjY291bnRDaGFuZ2VMaXN0ZW5lcihjbGllbnRTdWJzY3JpcHRpb25JZCkgewoJICAgIGF3YWl0IHRoaXMuX3Vuc3Vic2NyaWJlQ2xpZW50U3Vic2NyaXB0aW9uKGNsaWVudFN1YnNjcmlwdGlvbklkLCAnYWNjb3VudCBjaGFuZ2UnKTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgX3dzT25Qcm9ncmFtQWNjb3VudE5vdGlmaWNhdGlvbihub3RpZmljYXRpb24pIHsKCSAgICBjb25zdCB7CgkgICAgICByZXN1bHQsCgkgICAgICBzdWJzY3JpcHRpb24KCSAgICB9ID0gY3JlYXRlKG5vdGlmaWNhdGlvbiwgUHJvZ3JhbUFjY291bnROb3RpZmljYXRpb25SZXN1bHQpOwoJICAgIHRoaXMuX2hhbmRsZVNlcnZlck5vdGlmaWNhdGlvbihzdWJzY3JpcHRpb24sIFt7CgkgICAgICBhY2NvdW50SWQ6IHJlc3VsdC52YWx1ZS5wdWJrZXksCgkgICAgICBhY2NvdW50SW5mbzogcmVzdWx0LnZhbHVlLmFjY291bnQKCSAgICB9LCByZXN1bHQuY29udGV4dF0pOwoJICB9CgoJICAvKioKCSAgICogUmVnaXN0ZXIgYSBjYWxsYmFjayB0byBiZSBpbnZva2VkIHdoZW5ldmVyIGFjY291bnRzIG93bmVkIGJ5IHRoZQoJICAgKiBzcGVjaWZpZWQgcHJvZ3JhbSBjaGFuZ2UKCSAgICoKCSAgICogQHBhcmFtIHByb2dyYW1JZCBQdWJsaWMga2V5IG9mIHRoZSBwcm9ncmFtIHRvIG1vbml0b3IKCSAgICogQHBhcmFtIGNhbGxiYWNrIEZ1bmN0aW9uIHRvIGludm9rZSB3aGVuZXZlciB0aGUgYWNjb3VudCBpcyBjaGFuZ2VkCgkgICAqIEBwYXJhbSBjb25maWcKCSAgICogQHJldHVybiBzdWJzY3JpcHRpb24gaWQKCSAgICovCgoJICAvKiogQGRlcHJlY2F0ZWQgSW5zdGVhZCwgcGFzcyBpbiBhIHtAbGluayBQcm9ncmFtQWNjb3VudFN1YnNjcmlwdGlvbkNvbmZpZ30gKi8KCSAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGUtY2xhc3MtbWVtYmVycwoKCSAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGUtY2xhc3MtbWVtYmVycwoJICBvblByb2dyYW1BY2NvdW50Q2hhbmdlKHByb2dyYW1JZCwgY2FsbGJhY2ssIGNvbW1pdG1lbnRPckNvbmZpZywgbWF5YmVGaWx0ZXJzKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIGNvbmZpZwoJICAgIH0gPSBleHRyYWN0Q29tbWl0bWVudEZyb21Db25maWcoY29tbWl0bWVudE9yQ29uZmlnKTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtwcm9ncmFtSWQudG9CYXNlNTgoKV0sIGNvbW1pdG1lbnQgfHwgdGhpcy5fY29tbWl0bWVudCB8fCAnZmluYWxpemVkJywKCSAgICAvLyBBcHBseSBjb25uZWN0aW9uL3NlcnZlciBkZWZhdWx0LgoJICAgICdiYXNlNjQnIC8qIGVuY29kaW5nICovLCBjb25maWcgPyBjb25maWcgOiBtYXliZUZpbHRlcnMgPyB7CgkgICAgICBmaWx0ZXJzOiBhcHBseURlZmF1bHRNZW1jbXBFbmNvZGluZ1RvRmlsdGVycyhtYXliZUZpbHRlcnMpCgkgICAgfSA6IHVuZGVmaW5lZCAvKiBleHRyYSAqLyk7CgkgICAgcmV0dXJuIHRoaXMuX21ha2VTdWJzY3JpcHRpb24oewoJICAgICAgY2FsbGJhY2ssCgkgICAgICBtZXRob2Q6ICdwcm9ncmFtU3Vic2NyaWJlJywKCSAgICAgIHVuc3Vic2NyaWJlTWV0aG9kOiAncHJvZ3JhbVVuc3Vic2NyaWJlJwoJICAgIH0sIGFyZ3MpOwoJICB9CgoJICAvKioKCSAgICogRGVyZWdpc3RlciBhbiBhY2NvdW50IG5vdGlmaWNhdGlvbiBjYWxsYmFjawoJICAgKgoJICAgKiBAcGFyYW0gY2xpZW50U3Vic2NyaXB0aW9uSWQgY2xpZW50IHN1YnNjcmlwdGlvbiBpZCB0byBkZXJlZ2lzdGVyCgkgICAqLwoJICBhc3luYyByZW1vdmVQcm9ncmFtQWNjb3VudENoYW5nZUxpc3RlbmVyKGNsaWVudFN1YnNjcmlwdGlvbklkKSB7CgkgICAgYXdhaXQgdGhpcy5fdW5zdWJzY3JpYmVDbGllbnRTdWJzY3JpcHRpb24oY2xpZW50U3Vic2NyaXB0aW9uSWQsICdwcm9ncmFtIGFjY291bnQgY2hhbmdlJyk7CgkgIH0KCgkgIC8qKgoJICAgKiBSZWdpc3RlcnMgYSBjYWxsYmFjayB0byBiZSBpbnZva2VkIHdoZW5ldmVyIGxvZ3MgYXJlIGVtaXR0ZWQuCgkgICAqLwoJICBvbkxvZ3MoZmlsdGVyLCBjYWxsYmFjaywgY29tbWl0bWVudCkgewoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW3R5cGVvZiBmaWx0ZXIgPT09ICdvYmplY3QnID8gewoJICAgICAgbWVudGlvbnM6IFtmaWx0ZXIudG9TdHJpbmcoKV0KCSAgICB9IDogZmlsdGVyXSwgY29tbWl0bWVudCB8fCB0aGlzLl9jb21taXRtZW50IHx8ICdmaW5hbGl6ZWQnIC8vIEFwcGx5IGNvbm5lY3Rpb24vc2VydmVyIGRlZmF1bHQuCgkgICAgKTsKCSAgICByZXR1cm4gdGhpcy5fbWFrZVN1YnNjcmlwdGlvbih7CgkgICAgICBjYWxsYmFjaywKCSAgICAgIG1ldGhvZDogJ2xvZ3NTdWJzY3JpYmUnLAoJICAgICAgdW5zdWJzY3JpYmVNZXRob2Q6ICdsb2dzVW5zdWJzY3JpYmUnCgkgICAgfSwgYXJncyk7CgkgIH0KCgkgIC8qKgoJICAgKiBEZXJlZ2lzdGVyIGEgbG9ncyBjYWxsYmFjay4KCSAgICoKCSAgICogQHBhcmFtIGNsaWVudFN1YnNjcmlwdGlvbklkIGNsaWVudCBzdWJzY3JpcHRpb24gaWQgdG8gZGVyZWdpc3Rlci4KCSAgICovCgkgIGFzeW5jIHJlbW92ZU9uTG9nc0xpc3RlbmVyKGNsaWVudFN1YnNjcmlwdGlvbklkKSB7CgkgICAgYXdhaXQgdGhpcy5fdW5zdWJzY3JpYmVDbGllbnRTdWJzY3JpcHRpb24oY2xpZW50U3Vic2NyaXB0aW9uSWQsICdsb2dzJyk7CgkgIH0KCgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIF93c09uTG9nc05vdGlmaWNhdGlvbihub3RpZmljYXRpb24pIHsKCSAgICBjb25zdCB7CgkgICAgICByZXN1bHQsCgkgICAgICBzdWJzY3JpcHRpb24KCSAgICB9ID0gY3JlYXRlKG5vdGlmaWNhdGlvbiwgTG9nc05vdGlmaWNhdGlvblJlc3VsdCk7CgkgICAgdGhpcy5faGFuZGxlU2VydmVyTm90aWZpY2F0aW9uKHN1YnNjcmlwdGlvbiwgW3Jlc3VsdC52YWx1ZSwgcmVzdWx0LmNvbnRleHRdKTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgX3dzT25TbG90Tm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbikgewoJICAgIGNvbnN0IHsKCSAgICAgIHJlc3VsdCwKCSAgICAgIHN1YnNjcmlwdGlvbgoJICAgIH0gPSBjcmVhdGUobm90aWZpY2F0aW9uLCBTbG90Tm90aWZpY2F0aW9uUmVzdWx0KTsKCSAgICB0aGlzLl9oYW5kbGVTZXJ2ZXJOb3RpZmljYXRpb24oc3Vic2NyaXB0aW9uLCBbcmVzdWx0XSk7CgkgIH0KCgkgIC8qKgoJICAgKiBSZWdpc3RlciBhIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgdXBvbiBzbG90IGNoYW5nZXMKCSAgICoKCSAgICogQHBhcmFtIGNhbGxiYWNrIEZ1bmN0aW9uIHRvIGludm9rZSB3aGVuZXZlciB0aGUgc2xvdCBjaGFuZ2VzCgkgICAqIEByZXR1cm4gc3Vic2NyaXB0aW9uIGlkCgkgICAqLwoJICBvblNsb3RDaGFuZ2UoY2FsbGJhY2spIHsKCSAgICByZXR1cm4gdGhpcy5fbWFrZVN1YnNjcmlwdGlvbih7CgkgICAgICBjYWxsYmFjaywKCSAgICAgIG1ldGhvZDogJ3Nsb3RTdWJzY3JpYmUnLAoJICAgICAgdW5zdWJzY3JpYmVNZXRob2Q6ICdzbG90VW5zdWJzY3JpYmUnCgkgICAgfSwgW10gLyogYXJncyAqLyk7CgkgIH0KCgkgIC8qKgoJICAgKiBEZXJlZ2lzdGVyIGEgc2xvdCBub3RpZmljYXRpb24gY2FsbGJhY2sKCSAgICoKCSAgICogQHBhcmFtIGNsaWVudFN1YnNjcmlwdGlvbklkIGNsaWVudCBzdWJzY3JpcHRpb24gaWQgdG8gZGVyZWdpc3RlcgoJICAgKi8KCSAgYXN5bmMgcmVtb3ZlU2xvdENoYW5nZUxpc3RlbmVyKGNsaWVudFN1YnNjcmlwdGlvbklkKSB7CgkgICAgYXdhaXQgdGhpcy5fdW5zdWJzY3JpYmVDbGllbnRTdWJzY3JpcHRpb24oY2xpZW50U3Vic2NyaXB0aW9uSWQsICdzbG90IGNoYW5nZScpOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfd3NPblNsb3RVcGRhdGVzTm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbikgewoJICAgIGNvbnN0IHsKCSAgICAgIHJlc3VsdCwKCSAgICAgIHN1YnNjcmlwdGlvbgoJICAgIH0gPSBjcmVhdGUobm90aWZpY2F0aW9uLCBTbG90VXBkYXRlTm90aWZpY2F0aW9uUmVzdWx0KTsKCSAgICB0aGlzLl9oYW5kbGVTZXJ2ZXJOb3RpZmljYXRpb24oc3Vic2NyaXB0aW9uLCBbcmVzdWx0XSk7CgkgIH0KCgkgIC8qKgoJICAgKiBSZWdpc3RlciBhIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgdXBvbiBzbG90IHVwZGF0ZXMuIHtAbGluayBTbG90VXBkYXRlfSdzCgkgICAqIG1heSBiZSB1c2VmdWwgdG8gdHJhY2sgbGl2ZSBwcm9ncmVzcyBvZiBhIGNsdXN0ZXIuCgkgICAqCgkgICAqIEBwYXJhbSBjYWxsYmFjayBGdW5jdGlvbiB0byBpbnZva2Ugd2hlbmV2ZXIgdGhlIHNsb3QgdXBkYXRlcwoJICAgKiBAcmV0dXJuIHN1YnNjcmlwdGlvbiBpZAoJICAgKi8KCSAgb25TbG90VXBkYXRlKGNhbGxiYWNrKSB7CgkgICAgcmV0dXJuIHRoaXMuX21ha2VTdWJzY3JpcHRpb24oewoJICAgICAgY2FsbGJhY2ssCgkgICAgICBtZXRob2Q6ICdzbG90c1VwZGF0ZXNTdWJzY3JpYmUnLAoJICAgICAgdW5zdWJzY3JpYmVNZXRob2Q6ICdzbG90c1VwZGF0ZXNVbnN1YnNjcmliZScKCSAgICB9LCBbXSAvKiBhcmdzICovKTsKCSAgfQoKCSAgLyoqCgkgICAqIERlcmVnaXN0ZXIgYSBzbG90IHVwZGF0ZSBub3RpZmljYXRpb24gY2FsbGJhY2sKCSAgICoKCSAgICogQHBhcmFtIGNsaWVudFN1YnNjcmlwdGlvbklkIGNsaWVudCBzdWJzY3JpcHRpb24gaWQgdG8gZGVyZWdpc3RlcgoJICAgKi8KCSAgYXN5bmMgcmVtb3ZlU2xvdFVwZGF0ZUxpc3RlbmVyKGNsaWVudFN1YnNjcmlwdGlvbklkKSB7CgkgICAgYXdhaXQgdGhpcy5fdW5zdWJzY3JpYmVDbGllbnRTdWJzY3JpcHRpb24oY2xpZW50U3Vic2NyaXB0aW9uSWQsICdzbG90IHVwZGF0ZScpOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoKCSAgYXN5bmMgX3Vuc3Vic2NyaWJlQ2xpZW50U3Vic2NyaXB0aW9uKGNsaWVudFN1YnNjcmlwdGlvbklkLCBzdWJzY3JpcHRpb25OYW1lKSB7CgkgICAgY29uc3QgZGlzcG9zZSA9IHRoaXMuX3N1YnNjcmlwdGlvbkRpc3Bvc2VGdW5jdGlvbnNCeUNsaWVudFN1YnNjcmlwdGlvbklkW2NsaWVudFN1YnNjcmlwdGlvbklkXTsKCSAgICBpZiAoZGlzcG9zZSkgewoJICAgICAgYXdhaXQgZGlzcG9zZSgpOwoJICAgIH0gZWxzZSB7CgkgICAgICBjb25zb2xlLndhcm4oJ0lnbm9yZWQgdW5zdWJzY3JpYmUgcmVxdWVzdCBiZWNhdXNlIGFuIGFjdGl2ZSBzdWJzY3JpcHRpb24gd2l0aCBpZCAnICsgYFxgJHtjbGllbnRTdWJzY3JpcHRpb25JZH1cYCBmb3IgJyR7c3Vic2NyaXB0aW9uTmFtZX0nIGV2ZW50cyBgICsgJ2NvdWxkIG5vdCBiZSBmb3VuZC4nKTsKCSAgICB9CgkgIH0KCSAgX2J1aWxkQXJncyhhcmdzLCBvdmVycmlkZSwgZW5jb2RpbmcsIGV4dHJhKSB7CgkgICAgY29uc3QgY29tbWl0bWVudCA9IG92ZXJyaWRlIHx8IHRoaXMuX2NvbW1pdG1lbnQ7CgkgICAgaWYgKGNvbW1pdG1lbnQgfHwgZW5jb2RpbmcgfHwgZXh0cmEpIHsKCSAgICAgIGxldCBvcHRpb25zID0ge307CgkgICAgICBpZiAoZW5jb2RpbmcpIHsKCSAgICAgICAgb3B0aW9ucy5lbmNvZGluZyA9IGVuY29kaW5nOwoJICAgICAgfQoJICAgICAgaWYgKGNvbW1pdG1lbnQpIHsKCSAgICAgICAgb3B0aW9ucy5jb21taXRtZW50ID0gY29tbWl0bWVudDsKCSAgICAgIH0KCSAgICAgIGlmIChleHRyYSkgewoJICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbihvcHRpb25zLCBleHRyYSk7CgkgICAgICB9CgkgICAgICBhcmdzLnB1c2gob3B0aW9ucyk7CgkgICAgfQoJICAgIHJldHVybiBhcmdzOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfYnVpbGRBcmdzQXRMZWFzdENvbmZpcm1lZChhcmdzLCBvdmVycmlkZSwgZW5jb2RpbmcsIGV4dHJhKSB7CgkgICAgY29uc3QgY29tbWl0bWVudCA9IG92ZXJyaWRlIHx8IHRoaXMuX2NvbW1pdG1lbnQ7CgkgICAgaWYgKGNvbW1pdG1lbnQgJiYgIVsnY29uZmlybWVkJywgJ2ZpbmFsaXplZCddLmluY2x1ZGVzKGNvbW1pdG1lbnQpKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzaW5nIENvbm5lY3Rpb24gd2l0aCBkZWZhdWx0IGNvbW1pdG1lbnQ6IGAnICsgdGhpcy5fY29tbWl0bWVudCArICdgLCBidXQgbWV0aG9kIHJlcXVpcmVzIGF0IGxlYXN0IGBjb25maXJtZWRgJyk7CgkgICAgfQoJICAgIHJldHVybiB0aGlzLl9idWlsZEFyZ3MoYXJncywgb3ZlcnJpZGUsIGVuY29kaW5nLCBleHRyYSk7CgkgIH0KCgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIF93c09uU2lnbmF0dXJlTm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbikgewoJICAgIGNvbnN0IHsKCSAgICAgIHJlc3VsdCwKCSAgICAgIHN1YnNjcmlwdGlvbgoJICAgIH0gPSBjcmVhdGUobm90aWZpY2F0aW9uLCBTaWduYXR1cmVOb3RpZmljYXRpb25SZXN1bHQpOwoJICAgIGlmIChyZXN1bHQudmFsdWUgIT09ICdyZWNlaXZlZFNpZ25hdHVyZScpIHsKCSAgICAgIC8qKgoJICAgICAgICogU3BlY2lhbCBjYXNlLgoJICAgICAgICogQWZ0ZXIgYSBzaWduYXR1cmUgaXMgcHJvY2Vzc2VkLCBSUENzIGF1dG9tYXRpY2FsbHkgZGlzcG9zZSBvZiB0aGUKCSAgICAgICAqIHN1YnNjcmlwdGlvbiBvbiB0aGUgc2VydmVyIHNpZGUuIFdlIG5lZWQgdG8gdHJhY2sgd2hpY2ggb2YgdGhlc2UKCSAgICAgICAqIHN1YnNjcmlwdGlvbnMgaGF2ZSBiZWVuIGRpc3Bvc2VkIGluIHN1Y2ggYSB3YXksIHNvIHRoYXQgd2Uga25vdwoJICAgICAgICogd2hldGhlciB0aGUgY2xpZW50IGlzIGRlYWxpbmcgd2l0aCBhIG5vdC15ZXQtcHJvY2Vzc2VkIHNpZ25hdHVyZQoJICAgICAgICogKGluIHdoaWNoIGNhc2Ugd2UgbXVzdCB0ZWFyIGRvd24gdGhlIHNlcnZlciBzdWJzY3JpcHRpb24pIG9yIGFuCgkgICAgICAgKiBhbHJlYWR5LXByb2Nlc3NlZCBzaWduYXR1cmUgKGluIHdoaWNoIGNhc2UgdGhlIGNsaWVudCBjYW4gc2ltcGx5CgkgICAgICAgKiBjbGVhciBvdXQgdGhlIHN1YnNjcmlwdGlvbiBsb2NhbGx5IHdpdGhvdXQgdGVsbGluZyB0aGUgc2VydmVyKS4KCSAgICAgICAqCgkgICAgICAgKiBOT1RFOiBUaGVyZSBpcyBhIHByb3Bvc2FsIHRvIGVsaW1pbmF0ZSB0aGlzIHNwZWNpYWwgY2FzZSwgaGVyZToKCSAgICAgICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9zb2xhbmEtbGFicy9zb2xhbmEvaXNzdWVzLzE4ODkyCgkgICAgICAgKi8KCSAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNBdXRvRGlzcG9zZWRCeVJwYy5hZGQoc3Vic2NyaXB0aW9uKTsKCSAgICB9CgkgICAgdGhpcy5faGFuZGxlU2VydmVyTm90aWZpY2F0aW9uKHN1YnNjcmlwdGlvbiwgcmVzdWx0LnZhbHVlID09PSAncmVjZWl2ZWRTaWduYXR1cmUnID8gW3sKCSAgICAgIHR5cGU6ICdyZWNlaXZlZCcKCSAgICB9LCByZXN1bHQuY29udGV4dF0gOiBbewoJICAgICAgdHlwZTogJ3N0YXR1cycsCgkgICAgICByZXN1bHQ6IHJlc3VsdC52YWx1ZQoJICAgIH0sIHJlc3VsdC5jb250ZXh0XSk7CgkgIH0KCgkgIC8qKgoJICAgKiBSZWdpc3RlciBhIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgdXBvbiBzaWduYXR1cmUgdXBkYXRlcwoJICAgKgoJICAgKiBAcGFyYW0gc2lnbmF0dXJlIFRyYW5zYWN0aW9uIHNpZ25hdHVyZSBzdHJpbmcgaW4gYmFzZSA1OAoJICAgKiBAcGFyYW0gY2FsbGJhY2sgRnVuY3Rpb24gdG8gaW52b2tlIG9uIHNpZ25hdHVyZSBub3RpZmljYXRpb25zCgkgICAqIEBwYXJhbSBjb21taXRtZW50IFNwZWNpZnkgdGhlIGNvbW1pdG1lbnQgbGV2ZWwgc2lnbmF0dXJlIG11c3QgcmVhY2ggYmVmb3JlIG5vdGlmaWNhdGlvbgoJICAgKiBAcmV0dXJuIHN1YnNjcmlwdGlvbiBpZAoJICAgKi8KCSAgb25TaWduYXR1cmUoc2lnbmF0dXJlLCBjYWxsYmFjaywgY29tbWl0bWVudCkgewoJICAgIGNvbnN0IGFyZ3MgPSB0aGlzLl9idWlsZEFyZ3MoW3NpZ25hdHVyZV0sIGNvbW1pdG1lbnQgfHwgdGhpcy5fY29tbWl0bWVudCB8fCAnZmluYWxpemVkJyAvLyBBcHBseSBjb25uZWN0aW9uL3NlcnZlciBkZWZhdWx0LgoJICAgICk7CgkgICAgY29uc3QgY2xpZW50U3Vic2NyaXB0aW9uSWQgPSB0aGlzLl9tYWtlU3Vic2NyaXB0aW9uKHsKCSAgICAgIGNhbGxiYWNrOiAobm90aWZpY2F0aW9uLCBjb250ZXh0KSA9PiB7CgkgICAgICAgIGlmIChub3RpZmljYXRpb24udHlwZSA9PT0gJ3N0YXR1cycpIHsKCSAgICAgICAgICBjYWxsYmFjayhub3RpZmljYXRpb24ucmVzdWx0LCBjb250ZXh0KTsKCSAgICAgICAgICAvLyBTaWduYXR1cmVzIHN1YnNjcmlwdGlvbnMgYXJlIGF1dG8tcmVtb3ZlZCBieSB0aGUgUlBDIHNlcnZpY2UKCSAgICAgICAgICAvLyBzbyBubyBuZWVkIHRvIGV4cGxpY2l0bHkgc2VuZCBhbiB1bnN1YnNjcmliZSBtZXNzYWdlLgoJICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICB0aGlzLnJlbW92ZVNpZ25hdHVyZUxpc3RlbmVyKGNsaWVudFN1YnNjcmlwdGlvbklkKTsKCSAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1lbXB0eQoJICAgICAgICAgIH0gY2F0Y2ggKF9lcnIpIHsKCSAgICAgICAgICAgIC8vIEFscmVhZHkgcmVtb3ZlZC4KCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgIH0sCgkgICAgICBtZXRob2Q6ICdzaWduYXR1cmVTdWJzY3JpYmUnLAoJICAgICAgdW5zdWJzY3JpYmVNZXRob2Q6ICdzaWduYXR1cmVVbnN1YnNjcmliZScKCSAgICB9LCBhcmdzKTsKCSAgICByZXR1cm4gY2xpZW50U3Vic2NyaXB0aW9uSWQ7CgkgIH0KCgkgIC8qKgoJICAgKiBSZWdpc3RlciBhIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgd2hlbiBhIHRyYW5zYWN0aW9uIGlzCgkgICAqIHJlY2VpdmVkIGFuZC9vciBwcm9jZXNzZWQuCgkgICAqCgkgICAqIEBwYXJhbSBzaWduYXR1cmUgVHJhbnNhY3Rpb24gc2lnbmF0dXJlIHN0cmluZyBpbiBiYXNlIDU4CgkgICAqIEBwYXJhbSBjYWxsYmFjayBGdW5jdGlvbiB0byBpbnZva2Ugb24gc2lnbmF0dXJlIG5vdGlmaWNhdGlvbnMKCSAgICogQHBhcmFtIG9wdGlvbnMgRW5hYmxlIHJlY2VpdmVkIG5vdGlmaWNhdGlvbnMgYW5kIHNldCB0aGUgY29tbWl0bWVudAoJICAgKiAgIGxldmVsIHRoYXQgc2lnbmF0dXJlIG11c3QgcmVhY2ggYmVmb3JlIG5vdGlmaWNhdGlvbgoJICAgKiBAcmV0dXJuIHN1YnNjcmlwdGlvbiBpZAoJICAgKi8KCSAgb25TaWduYXR1cmVXaXRoT3B0aW9ucyhzaWduYXR1cmUsIGNhbGxiYWNrLCBvcHRpb25zKSB7CgkgICAgY29uc3QgewoJICAgICAgY29tbWl0bWVudCwKCSAgICAgIC4uLmV4dHJhCgkgICAgfSA9IHsKCSAgICAgIC4uLm9wdGlvbnMsCgkgICAgICBjb21taXRtZW50OiBvcHRpb25zICYmIG9wdGlvbnMuY29tbWl0bWVudCB8fCB0aGlzLl9jb21taXRtZW50IHx8ICdmaW5hbGl6ZWQnIC8vIEFwcGx5IGNvbm5lY3Rpb24vc2VydmVyIGRlZmF1bHQuCgkgICAgfTsKCSAgICBjb25zdCBhcmdzID0gdGhpcy5fYnVpbGRBcmdzKFtzaWduYXR1cmVdLCBjb21taXRtZW50LCB1bmRlZmluZWQgLyogZW5jb2RpbmcgKi8sIGV4dHJhKTsKCSAgICBjb25zdCBjbGllbnRTdWJzY3JpcHRpb25JZCA9IHRoaXMuX21ha2VTdWJzY3JpcHRpb24oewoJICAgICAgY2FsbGJhY2s6IChub3RpZmljYXRpb24sIGNvbnRleHQpID0+IHsKCSAgICAgICAgY2FsbGJhY2sobm90aWZpY2F0aW9uLCBjb250ZXh0KTsKCSAgICAgICAgLy8gU2lnbmF0dXJlcyBzdWJzY3JpcHRpb25zIGFyZSBhdXRvLXJlbW92ZWQgYnkgdGhlIFJQQyBzZXJ2aWNlCgkgICAgICAgIC8vIHNvIG5vIG5lZWQgdG8gZXhwbGljaXRseSBzZW5kIGFuIHVuc3Vic2NyaWJlIG1lc3NhZ2UuCgkgICAgICAgIHRyeSB7CgkgICAgICAgICAgdGhpcy5yZW1vdmVTaWduYXR1cmVMaXN0ZW5lcihjbGllbnRTdWJzY3JpcHRpb25JZCk7CgkgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWVtcHR5CgkgICAgICAgIH0gY2F0Y2ggKF9lcnIpIHsKCSAgICAgICAgICAvLyBBbHJlYWR5IHJlbW92ZWQuCgkgICAgICAgIH0KCSAgICAgIH0sCgkgICAgICBtZXRob2Q6ICdzaWduYXR1cmVTdWJzY3JpYmUnLAoJICAgICAgdW5zdWJzY3JpYmVNZXRob2Q6ICdzaWduYXR1cmVVbnN1YnNjcmliZScKCSAgICB9LCBhcmdzKTsKCSAgICByZXR1cm4gY2xpZW50U3Vic2NyaXB0aW9uSWQ7CgkgIH0KCgkgIC8qKgoJICAgKiBEZXJlZ2lzdGVyIGEgc2lnbmF0dXJlIG5vdGlmaWNhdGlvbiBjYWxsYmFjawoJICAgKgoJICAgKiBAcGFyYW0gY2xpZW50U3Vic2NyaXB0aW9uSWQgY2xpZW50IHN1YnNjcmlwdGlvbiBpZCB0byBkZXJlZ2lzdGVyCgkgICAqLwoJICBhc3luYyByZW1vdmVTaWduYXR1cmVMaXN0ZW5lcihjbGllbnRTdWJzY3JpcHRpb25JZCkgewoJICAgIGF3YWl0IHRoaXMuX3Vuc3Vic2NyaWJlQ2xpZW50U3Vic2NyaXB0aW9uKGNsaWVudFN1YnNjcmlwdGlvbklkLCAnc2lnbmF0dXJlIHJlc3VsdCcpOwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBfd3NPblJvb3ROb3RpZmljYXRpb24obm90aWZpY2F0aW9uKSB7CgkgICAgY29uc3QgewoJICAgICAgcmVzdWx0LAoJICAgICAgc3Vic2NyaXB0aW9uCgkgICAgfSA9IGNyZWF0ZShub3RpZmljYXRpb24sIFJvb3ROb3RpZmljYXRpb25SZXN1bHQpOwoJICAgIHRoaXMuX2hhbmRsZVNlcnZlck5vdGlmaWNhdGlvbihzdWJzY3JpcHRpb24sIFtyZXN1bHRdKTsKCSAgfQoKCSAgLyoqCgkgICAqIFJlZ2lzdGVyIGEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCB1cG9uIHJvb3QgY2hhbmdlcwoJICAgKgoJICAgKiBAcGFyYW0gY2FsbGJhY2sgRnVuY3Rpb24gdG8gaW52b2tlIHdoZW5ldmVyIHRoZSByb290IGNoYW5nZXMKCSAgICogQHJldHVybiBzdWJzY3JpcHRpb24gaWQKCSAgICovCgkgIG9uUm9vdENoYW5nZShjYWxsYmFjaykgewoJICAgIHJldHVybiB0aGlzLl9tYWtlU3Vic2NyaXB0aW9uKHsKCSAgICAgIGNhbGxiYWNrLAoJICAgICAgbWV0aG9kOiAncm9vdFN1YnNjcmliZScsCgkgICAgICB1bnN1YnNjcmliZU1ldGhvZDogJ3Jvb3RVbnN1YnNjcmliZScKCSAgICB9LCBbXSAvKiBhcmdzICovKTsKCSAgfQoKCSAgLyoqCgkgICAqIERlcmVnaXN0ZXIgYSByb290IG5vdGlmaWNhdGlvbiBjYWxsYmFjawoJICAgKgoJICAgKiBAcGFyYW0gY2xpZW50U3Vic2NyaXB0aW9uSWQgY2xpZW50IHN1YnNjcmlwdGlvbiBpZCB0byBkZXJlZ2lzdGVyCgkgICAqLwoJICBhc3luYyByZW1vdmVSb290Q2hhbmdlTGlzdGVuZXIoY2xpZW50U3Vic2NyaXB0aW9uSWQpIHsKCSAgICBhd2FpdCB0aGlzLl91bnN1YnNjcmliZUNsaWVudFN1YnNjcmlwdGlvbihjbGllbnRTdWJzY3JpcHRpb25JZCwgJ3Jvb3QgY2hhbmdlJyk7CgkgIH0KCX0KCgkvKioKCSAqIEtleXBhaXIgc2lnbmVyIGludGVyZmFjZQoJICovCgoJLyoqCgkgKiBBbiBhY2NvdW50IGtleXBhaXIgdXNlZCBmb3Igc2lnbmluZyB0cmFuc2FjdGlvbnMuCgkgKi8KCWNsYXNzIEtleXBhaXIgewoJICAvKioKCSAgICogQ3JlYXRlIGEgbmV3IGtleXBhaXIgaW5zdGFuY2UuCgkgICAqIEdlbmVyYXRlIHJhbmRvbSBrZXlwYWlyIGlmIG5vIHtAbGluayBFZDI1NTE5S2V5cGFpcn0gaXMgcHJvdmlkZWQuCgkgICAqCgkgICAqIEBwYXJhbSB7RWQyNTUxOUtleXBhaXJ9IGtleXBhaXIgZWQyNTUxOSBrZXlwYWlyCgkgICAqLwoJICBjb25zdHJ1Y3RvcihrZXlwYWlyKSB7CgkgICAgdGhpcy5fa2V5cGFpciA9IHZvaWQgMDsKCSAgICB0aGlzLl9rZXlwYWlyID0ga2V5cGFpciA/PyBnZW5lcmF0ZUtleXBhaXIoKTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgbmV3IHJhbmRvbSBrZXlwYWlyCgkgICAqCgkgICAqIEByZXR1cm5zIHtLZXlwYWlyfSBLZXlwYWlyCgkgICAqLwoJICBzdGF0aWMgZ2VuZXJhdGUoKSB7CgkgICAgcmV0dXJuIG5ldyBLZXlwYWlyKGdlbmVyYXRlS2V5cGFpcigpKTsKCSAgfQoKCSAgLyoqCgkgICAqIENyZWF0ZSBhIGtleXBhaXIgZnJvbSBhIHJhdyBzZWNyZXQga2V5IGJ5dGUgYXJyYXkuCgkgICAqCgkgICAqIFRoaXMgbWV0aG9kIHNob3VsZCBvbmx5IGJlIHVzZWQgdG8gcmVjcmVhdGUgYSBrZXlwYWlyIGZyb20gYSBwcmV2aW91c2x5CgkgICAqIGdlbmVyYXRlZCBzZWNyZXQga2V5LiBHZW5lcmF0aW5nIGtleXBhaXJzIGZyb20gYSByYW5kb20gc2VlZCBzaG91bGQgYmUgZG9uZQoJICAgKiB3aXRoIHRoZSB7QGxpbmsgS2V5cGFpci5mcm9tU2VlZH0gbWV0aG9kLgoJICAgKgoJICAgKiBAdGhyb3dzIGVycm9yIGlmIHRoZSBwcm92aWRlZCBzZWNyZXQga2V5IGlzIGludmFsaWQgYW5kIHZhbGlkYXRpb24gaXMgbm90IHNraXBwZWQuCgkgICAqCgkgICAqIEBwYXJhbSBzZWNyZXRLZXkgc2VjcmV0IGtleSBieXRlIGFycmF5CgkgICAqIEBwYXJhbSBvcHRpb25zIHNraXAgc2VjcmV0IGtleSB2YWxpZGF0aW9uCgkgICAqCgkgICAqIEByZXR1cm5zIHtLZXlwYWlyfSBLZXlwYWlyCgkgICAqLwoJICBzdGF0aWMgZnJvbVNlY3JldEtleShzZWNyZXRLZXksIG9wdGlvbnMpIHsKCSAgICBpZiAoc2VjcmV0S2V5LmJ5dGVMZW5ndGggIT09IDY0KSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JhZCBzZWNyZXQga2V5IHNpemUnKTsKCSAgICB9CgkgICAgY29uc3QgcHVibGljS2V5ID0gc2VjcmV0S2V5LnNsaWNlKDMyLCA2NCk7CgkgICAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLnNraXBWYWxpZGF0aW9uKSB7CgkgICAgICBjb25zdCBwcml2YXRlU2NhbGFyID0gc2VjcmV0S2V5LnNsaWNlKDAsIDMyKTsKCSAgICAgIGNvbnN0IGNvbXB1dGVkUHVibGljS2V5ID0gZ2V0UHVibGljS2V5KHByaXZhdGVTY2FsYXIpOwoJICAgICAgZm9yIChsZXQgaWkgPSAwOyBpaSA8IDMyOyBpaSsrKSB7CgkgICAgICAgIGlmIChwdWJsaWNLZXlbaWldICE9PSBjb21wdXRlZFB1YmxpY0tleVtpaV0pIHsKCSAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb3ZpZGVkIHNlY3JldEtleSBpcyBpbnZhbGlkJyk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG5ldyBLZXlwYWlyKHsKCSAgICAgIHB1YmxpY0tleSwKCSAgICAgIHNlY3JldEtleQoJICAgIH0pOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYSBrZXlwYWlyIGZyb20gYSAzMiBieXRlIHNlZWQuCgkgICAqCgkgICAqIEBwYXJhbSBzZWVkIHNlZWQgYnl0ZSBhcnJheQoJICAgKgoJICAgKiBAcmV0dXJucyB7S2V5cGFpcn0gS2V5cGFpcgoJICAgKi8KCSAgc3RhdGljIGZyb21TZWVkKHNlZWQpIHsKCSAgICBjb25zdCBwdWJsaWNLZXkgPSBnZXRQdWJsaWNLZXkoc2VlZCk7CgkgICAgY29uc3Qgc2VjcmV0S2V5ID0gbmV3IFVpbnQ4QXJyYXkoNjQpOwoJICAgIHNlY3JldEtleS5zZXQoc2VlZCk7CgkgICAgc2VjcmV0S2V5LnNldChwdWJsaWNLZXksIDMyKTsKCSAgICByZXR1cm4gbmV3IEtleXBhaXIoewoJICAgICAgcHVibGljS2V5LAoJICAgICAgc2VjcmV0S2V5CgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBUaGUgcHVibGljIGtleSBmb3IgdGhpcyBrZXlwYWlyCgkgICAqCgkgICAqIEByZXR1cm5zIHtQdWJsaWNLZXl9IFB1YmxpY0tleQoJICAgKi8KCSAgZ2V0IHB1YmxpY0tleSgpIHsKCSAgICByZXR1cm4gbmV3IFB1YmxpY0tleSh0aGlzLl9rZXlwYWlyLnB1YmxpY0tleSk7CgkgIH0KCgkgIC8qKgoJICAgKiBUaGUgcmF3IHNlY3JldCBrZXkgZm9yIHRoaXMga2V5cGFpcgoJICAgKiBAcmV0dXJucyB7VWludDhBcnJheX0gU2VjcmV0IGtleSBpbiBhbiBhcnJheSBvZiBVaW50OCBieXRlcwoJICAgKi8KCSAgZ2V0IHNlY3JldEtleSgpIHsKCSAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkodGhpcy5fa2V5cGFpci5zZWNyZXRLZXkpOwoJICB9Cgl9CgoJLyoqCgkgKiBBbiBlbnVtZXJhdGlvbiBvZiB2YWxpZCBMb29rdXBUYWJsZUluc3RydWN0aW9uVHlwZSdzCgkgKi8KCgkvKioKCSAqIEFuIGVudW1lcmF0aW9uIG9mIHZhbGlkIGFkZHJlc3MgbG9va3VwIHRhYmxlIEluc3RydWN0aW9uVHlwZSdzCgkgKiBAaW50ZXJuYWwKCSAqLwoJY29uc3QgTE9PS1VQX1RBQkxFX0lOU1RSVUNUSU9OX0xBWU9VVFMgPSBPYmplY3QuZnJlZXplKHsKCSAgQ3JlYXRlTG9va3VwVGFibGU6IHsKCSAgICBpbmRleDogMCwKCSAgICBsYXlvdXQ6IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgdTY0KCdyZWNlbnRTbG90JyksIExheW91dEV4cG9ydHMudTgoJ2J1bXBTZWVkJyldKQoJICB9LAoJICBGcmVlemVMb29rdXBUYWJsZTogewoJICAgIGluZGV4OiAxLAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpXSkKCSAgfSwKCSAgRXh0ZW5kTG9va3VwVGFibGU6IHsKCSAgICBpbmRleDogMiwKCSAgICBsYXlvdXQ6IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgdTY0KCksIExheW91dEV4cG9ydHMuc2VxKHB1YmxpY0tleSgpLCBMYXlvdXRFeHBvcnRzLm9mZnNldChMYXlvdXRFeHBvcnRzLnUzMigpLCAtOCksICdhZGRyZXNzZXMnKV0pCgkgIH0sCgkgIERlYWN0aXZhdGVMb29rdXBUYWJsZTogewoJICAgIGluZGV4OiAzLAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpXSkKCSAgfSwKCSAgQ2xvc2VMb29rdXBUYWJsZTogewoJICAgIGluZGV4OiA0LAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpXSkKCSAgfQoJfSk7CgljbGFzcyBBZGRyZXNzTG9va3VwVGFibGVJbnN0cnVjdGlvbiB7CgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIGNvbnN0cnVjdG9yKCkge30KCSAgc3RhdGljIGRlY29kZUluc3RydWN0aW9uVHlwZShpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICBjb25zdCBpbnN0cnVjdGlvblR5cGVMYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKTsKCSAgICBjb25zdCBpbmRleCA9IGluc3RydWN0aW9uVHlwZUxheW91dC5kZWNvZGUoaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgbGV0IHR5cGU7CgkgICAgZm9yIChjb25zdCBbbGF5b3V0VHlwZSwgbGF5b3V0XSBvZiBPYmplY3QuZW50cmllcyhMT09LVVBfVEFCTEVfSU5TVFJVQ1RJT05fTEFZT1VUUykpIHsKCSAgICAgIGlmIChsYXlvdXQuaW5kZXggPT0gaW5kZXgpIHsKCSAgICAgICAgdHlwZSA9IGxheW91dFR5cGU7CgkgICAgICAgIGJyZWFrOwoJICAgICAgfQoJICAgIH0KCSAgICBpZiAoIXR5cGUpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBJbnN0cnVjdGlvbi4gU2hvdWxkIGJlIGEgTG9va3VwVGFibGUgSW5zdHJ1Y3Rpb24nKTsKCSAgICB9CgkgICAgcmV0dXJuIHR5cGU7CgkgIH0KCSAgc3RhdGljIGRlY29kZUNyZWF0ZUxvb2t1cFRhYmxlKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIHRoaXMuY2hlY2tLZXlzTGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDQpOwoJICAgIGNvbnN0IHsKCSAgICAgIHJlY2VudFNsb3QKCSAgICB9ID0gZGVjb2RlRGF0YSQxKExPT0tVUF9UQUJMRV9JTlNUUlVDVElPTl9MQVlPVVRTLkNyZWF0ZUxvb2t1cFRhYmxlLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgYXV0aG9yaXR5OiBpbnN0cnVjdGlvbi5rZXlzWzFdLnB1YmtleSwKCSAgICAgIHBheWVyOiBpbnN0cnVjdGlvbi5rZXlzWzJdLnB1YmtleSwKCSAgICAgIHJlY2VudFNsb3Q6IE51bWJlcihyZWNlbnRTbG90KQoJICAgIH07CgkgIH0KCSAgc3RhdGljIGRlY29kZUV4dGVuZExvb2t1cFRhYmxlKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIGlmIChpbnN0cnVjdGlvbi5rZXlzLmxlbmd0aCA8IDIpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBpbnN0cnVjdGlvbjsgZm91bmQgJHtpbnN0cnVjdGlvbi5rZXlzLmxlbmd0aH0ga2V5cywgZXhwZWN0ZWQgYXQgbGVhc3QgMmApOwoJICAgIH0KCSAgICBjb25zdCB7CgkgICAgICBhZGRyZXNzZXMKCSAgICB9ID0gZGVjb2RlRGF0YSQxKExPT0tVUF9UQUJMRV9JTlNUUlVDVElPTl9MQVlPVVRTLkV4dGVuZExvb2t1cFRhYmxlLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgbG9va3VwVGFibGU6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgYXV0aG9yaXR5OiBpbnN0cnVjdGlvbi5rZXlzWzFdLnB1YmtleSwKCSAgICAgIHBheWVyOiBpbnN0cnVjdGlvbi5rZXlzLmxlbmd0aCA+IDIgPyBpbnN0cnVjdGlvbi5rZXlzWzJdLnB1YmtleSA6IHVuZGVmaW5lZCwKCSAgICAgIGFkZHJlc3NlczogYWRkcmVzc2VzLm1hcChidWZmZXIgPT4gbmV3IFB1YmxpY0tleShidWZmZXIpKQoJICAgIH07CgkgIH0KCSAgc3RhdGljIGRlY29kZUNsb3NlTG9va3VwVGFibGUoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleXNMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMyk7CgkgICAgcmV0dXJuIHsKCSAgICAgIGxvb2t1cFRhYmxlOiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIGF1dGhvcml0eTogaW5zdHJ1Y3Rpb24ua2V5c1sxXS5wdWJrZXksCgkgICAgICByZWNpcGllbnQ6IGluc3RydWN0aW9uLmtleXNbMl0ucHVia2V5CgkgICAgfTsKCSAgfQoJICBzdGF0aWMgZGVjb2RlRnJlZXplTG9va3VwVGFibGUoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleXNMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMik7CgkgICAgcmV0dXJuIHsKCSAgICAgIGxvb2t1cFRhYmxlOiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIGF1dGhvcml0eTogaW5zdHJ1Y3Rpb24ua2V5c1sxXS5wdWJrZXkKCSAgICB9OwoJICB9CgkgIHN0YXRpYyBkZWNvZGVEZWFjdGl2YXRlTG9va3VwVGFibGUoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleXNMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMik7CgkgICAgcmV0dXJuIHsKCSAgICAgIGxvb2t1cFRhYmxlOiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIGF1dGhvcml0eTogaW5zdHJ1Y3Rpb24ua2V5c1sxXS5wdWJrZXkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBzdGF0aWMgY2hlY2tQcm9ncmFtSWQocHJvZ3JhbUlkKSB7CgkgICAgaWYgKCFwcm9ncmFtSWQuZXF1YWxzKEFkZHJlc3NMb29rdXBUYWJsZVByb2dyYW0ucHJvZ3JhbUlkKSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGluc3RydWN0aW9uOyBwcm9ncmFtSWQgaXMgbm90IEFkZHJlc3NMb29rdXBUYWJsZSBQcm9ncmFtJyk7CgkgICAgfQoJICB9CgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIHN0YXRpYyBjaGVja0tleXNMZW5ndGgoa2V5cywgZXhwZWN0ZWRMZW5ndGgpIHsKCSAgICBpZiAoa2V5cy5sZW5ndGggPCBleHBlY3RlZExlbmd0aCkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIGluc3RydWN0aW9uOyBmb3VuZCAke2tleXMubGVuZ3RofSBrZXlzLCBleHBlY3RlZCBhdCBsZWFzdCAke2V4cGVjdGVkTGVuZ3RofWApOwoJICAgIH0KCSAgfQoJfQoJY2xhc3MgQWRkcmVzc0xvb2t1cFRhYmxlUHJvZ3JhbSB7CgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIGNvbnN0cnVjdG9yKCkge30KCSAgc3RhdGljIGNyZWF0ZUxvb2t1cFRhYmxlKHBhcmFtcykgewoJICAgIGNvbnN0IFtsb29rdXBUYWJsZUFkZHJlc3MsIGJ1bXBTZWVkXSA9IFB1YmxpY0tleS5maW5kUHJvZ3JhbUFkZHJlc3NTeW5jKFtwYXJhbXMuYXV0aG9yaXR5LnRvQnVmZmVyKCksIGJyb3dzZXJFeHBvcnRzJDEudG9CdWZmZXJMRShCaWdJbnQocGFyYW1zLnJlY2VudFNsb3QpLCA4KV0sIHRoaXMucHJvZ3JhbUlkKTsKCSAgICBjb25zdCB0eXBlID0gTE9PS1VQX1RBQkxFX0lOU1RSVUNUSU9OX0xBWU9VVFMuQ3JlYXRlTG9va3VwVGFibGU7CgkgICAgY29uc3QgZGF0YSA9IGVuY29kZURhdGEodHlwZSwgewoJICAgICAgcmVjZW50U2xvdDogQmlnSW50KHBhcmFtcy5yZWNlbnRTbG90KSwKCSAgICAgIGJ1bXBTZWVkOiBidW1wU2VlZAoJICAgIH0pOwoJICAgIGNvbnN0IGtleXMgPSBbewoJICAgICAgcHVia2V5OiBsb29rdXBUYWJsZUFkZHJlc3MsCgkgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBwYXJhbXMuYXV0aG9yaXR5LAoJICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgIH0sIHsKCSAgICAgIHB1YmtleTogcGFyYW1zLnBheWVyLAoJICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBTeXN0ZW1Qcm9ncmFtLnByb2dyYW1JZCwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfV07CgkgICAgcmV0dXJuIFtuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAga2V5czoga2V5cywKCSAgICAgIGRhdGE6IGRhdGEKCSAgICB9KSwgbG9va3VwVGFibGVBZGRyZXNzXTsKCSAgfQoJICBzdGF0aWMgZnJlZXplTG9va3VwVGFibGUocGFyYW1zKSB7CgkgICAgY29uc3QgdHlwZSA9IExPT0tVUF9UQUJMRV9JTlNUUlVDVElPTl9MQVlPVVRTLkZyZWV6ZUxvb2t1cFRhYmxlOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUpOwoJICAgIGNvbnN0IGtleXMgPSBbewoJICAgICAgcHVia2V5OiBwYXJhbXMubG9va3VwVGFibGUsCgkgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBwYXJhbXMuYXV0aG9yaXR5LAoJICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgIH1dOwoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAga2V5czoga2V5cywKCSAgICAgIGRhdGE6IGRhdGEKCSAgICB9KTsKCSAgfQoJICBzdGF0aWMgZXh0ZW5kTG9va3VwVGFibGUocGFyYW1zKSB7CgkgICAgY29uc3QgdHlwZSA9IExPT0tVUF9UQUJMRV9JTlNUUlVDVElPTl9MQVlPVVRTLkV4dGVuZExvb2t1cFRhYmxlOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgIGFkZHJlc3NlczogcGFyYW1zLmFkZHJlc3Nlcy5tYXAoYWRkciA9PiBhZGRyLnRvQnl0ZXMoKSkKCSAgICB9KTsKCSAgICBjb25zdCBrZXlzID0gW3sKCSAgICAgIHB1YmtleTogcGFyYW1zLmxvb2t1cFRhYmxlLAoJICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgaXNXcml0YWJsZTogdHJ1ZQoJICAgIH0sIHsKCSAgICAgIHB1YmtleTogcGFyYW1zLmF1dGhvcml0eSwKCSAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICB9XTsKCSAgICBpZiAocGFyYW1zLnBheWVyKSB7CgkgICAgICBrZXlzLnB1c2goewoJICAgICAgICBwdWJrZXk6IHBhcmFtcy5wYXllciwKCSAgICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBTeXN0ZW1Qcm9ncmFtLnByb2dyYW1JZCwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAga2V5czoga2V5cywKCSAgICAgIGRhdGE6IGRhdGEKCSAgICB9KTsKCSAgfQoJICBzdGF0aWMgZGVhY3RpdmF0ZUxvb2t1cFRhYmxlKHBhcmFtcykgewoJICAgIGNvbnN0IHR5cGUgPSBMT09LVVBfVEFCTEVfSU5TVFJVQ1RJT05fTEFZT1VUUy5EZWFjdGl2YXRlTG9va3VwVGFibGU7CgkgICAgY29uc3QgZGF0YSA9IGVuY29kZURhdGEodHlwZSk7CgkgICAgY29uc3Qga2V5cyA9IFt7CgkgICAgICBwdWJrZXk6IHBhcmFtcy5sb29rdXBUYWJsZSwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICB9LCB7CgkgICAgICBwdWJrZXk6IHBhcmFtcy5hdXRob3JpdHksCgkgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfV07CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHsKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQsCgkgICAgICBrZXlzOiBrZXlzLAoJICAgICAgZGF0YTogZGF0YQoJICAgIH0pOwoJICB9CgkgIHN0YXRpYyBjbG9zZUxvb2t1cFRhYmxlKHBhcmFtcykgewoJICAgIGNvbnN0IHR5cGUgPSBMT09LVVBfVEFCTEVfSU5TVFJVQ1RJT05fTEFZT1VUUy5DbG9zZUxvb2t1cFRhYmxlOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUpOwoJICAgIGNvbnN0IGtleXMgPSBbewoJICAgICAgcHVia2V5OiBwYXJhbXMubG9va3VwVGFibGUsCgkgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBwYXJhbXMuYXV0aG9yaXR5LAoJICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgIH0sIHsKCSAgICAgIHB1YmtleTogcGFyYW1zLnJlY2lwaWVudCwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICB9XTsKCSAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24oewoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGtleXM6IGtleXMsCgkgICAgICBkYXRhOiBkYXRhCgkgICAgfSk7CgkgIH0KCX0KCUFkZHJlc3NMb29rdXBUYWJsZVByb2dyYW0ucHJvZ3JhbUlkID0gbmV3IFB1YmxpY0tleSgnQWRkcmVzc0xvb2t1cFRhYjFlMTExMTExMTExMTExMTExMTExMTExMTExMScpOwoKCS8qKgoJICogQ29tcHV0ZSBCdWRnZXQgSW5zdHJ1Y3Rpb24gY2xhc3MKCSAqLwoJY2xhc3MgQ29tcHV0ZUJ1ZGdldEluc3RydWN0aW9uIHsKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgY29uc3RydWN0b3IoKSB7fQoKCSAgLyoqCgkgICAqIERlY29kZSBhIGNvbXB1dGUgYnVkZ2V0IGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gdHlwZS4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVJbnN0cnVjdGlvblR5cGUoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgY29uc3QgaW5zdHJ1Y3Rpb25UeXBlTGF5b3V0ID0gTGF5b3V0RXhwb3J0cy51OCgnaW5zdHJ1Y3Rpb24nKTsKCSAgICBjb25zdCB0eXBlSW5kZXggPSBpbnN0cnVjdGlvblR5cGVMYXlvdXQuZGVjb2RlKGluc3RydWN0aW9uLmRhdGEpOwoJICAgIGxldCB0eXBlOwoJICAgIGZvciAoY29uc3QgW2l4VHlwZSwgbGF5b3V0XSBvZiBPYmplY3QuZW50cmllcyhDT01QVVRFX0JVREdFVF9JTlNUUlVDVElPTl9MQVlPVVRTKSkgewoJICAgICAgaWYgKGxheW91dC5pbmRleCA9PSB0eXBlSW5kZXgpIHsKCSAgICAgICAgdHlwZSA9IGl4VHlwZTsKCSAgICAgICAgYnJlYWs7CgkgICAgICB9CgkgICAgfQoJICAgIGlmICghdHlwZSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnN0cnVjdGlvbiB0eXBlIGluY29ycmVjdDsgbm90IGEgQ29tcHV0ZUJ1ZGdldEluc3RydWN0aW9uJyk7CgkgICAgfQoJICAgIHJldHVybiB0eXBlOwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIHJlcXVlc3QgdW5pdHMgY29tcHV0ZSBidWRnZXQgaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlUmVxdWVzdFVuaXRzKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIGNvbnN0IHsKCSAgICAgIHVuaXRzLAoJICAgICAgYWRkaXRpb25hbEZlZQoJICAgIH0gPSBkZWNvZGVEYXRhJDEoQ09NUFVURV9CVURHRVRfSU5TVFJVQ1RJT05fTEFZT1VUUy5SZXF1ZXN0VW5pdHMsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICB1bml0cywKCSAgICAgIGFkZGl0aW9uYWxGZWUKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIHJlcXVlc3QgaGVhcCBmcmFtZSBjb21wdXRlIGJ1ZGdldCBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVSZXF1ZXN0SGVhcEZyYW1lKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIGNvbnN0IHsKCSAgICAgIGJ5dGVzCgkgICAgfSA9IGRlY29kZURhdGEkMShDT01QVVRFX0JVREdFVF9JTlNUUlVDVElPTl9MQVlPVVRTLlJlcXVlc3RIZWFwRnJhbWUsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICBieXRlcwoJICAgIH07CgkgIH0KCgkgIC8qKgoJICAgKiBEZWNvZGUgc2V0IGNvbXB1dGUgdW5pdCBsaW1pdCBjb21wdXRlIGJ1ZGdldCBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVTZXRDb21wdXRlVW5pdExpbWl0KGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIGNvbnN0IHsKCSAgICAgIHVuaXRzCgkgICAgfSA9IGRlY29kZURhdGEkMShDT01QVVRFX0JVREdFVF9JTlNUUlVDVElPTl9MQVlPVVRTLlNldENvbXB1dGVVbml0TGltaXQsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICB1bml0cwoJICAgIH07CgkgIH0KCgkgIC8qKgoJICAgKiBEZWNvZGUgc2V0IGNvbXB1dGUgdW5pdCBwcmljZSBjb21wdXRlIGJ1ZGdldCBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVTZXRDb21wdXRlVW5pdFByaWNlKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIGNvbnN0IHsKCSAgICAgIG1pY3JvTGFtcG9ydHMKCSAgICB9ID0gZGVjb2RlRGF0YSQxKENPTVBVVEVfQlVER0VUX0lOU1RSVUNUSU9OX0xBWU9VVFMuU2V0Q29tcHV0ZVVuaXRQcmljZSwgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgcmV0dXJuIHsKCSAgICAgIG1pY3JvTGFtcG9ydHMKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBzdGF0aWMgY2hlY2tQcm9ncmFtSWQocHJvZ3JhbUlkKSB7CgkgICAgaWYgKCFwcm9ncmFtSWQuZXF1YWxzKENvbXB1dGVCdWRnZXRQcm9ncmFtLnByb2dyYW1JZCkpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBpbnN0cnVjdGlvbjsgcHJvZ3JhbUlkIGlzIG5vdCBDb21wdXRlQnVkZ2V0UHJvZ3JhbScpOwoJICAgIH0KCSAgfQoJfQoKCS8qKgoJICogQW4gZW51bWVyYXRpb24gb2YgdmFsaWQgQ29tcHV0ZUJ1ZGdldEluc3RydWN0aW9uVHlwZSdzCgkgKi8KCgkvKioKCSAqIFJlcXVlc3QgdW5pdHMgaW5zdHJ1Y3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIFJlcXVlc3QgaGVhcCBmcmFtZSBpbnN0cnVjdGlvbiBwYXJhbXMKCSAqLwoKCS8qKgoJICogU2V0IGNvbXB1dGUgdW5pdCBsaW1pdCBpbnN0cnVjdGlvbiBwYXJhbXMKCSAqLwoKCS8qKgoJICogU2V0IGNvbXB1dGUgdW5pdCBwcmljZSBpbnN0cnVjdGlvbiBwYXJhbXMKCSAqLwoKCS8qKgoJICogQW4gZW51bWVyYXRpb24gb2YgdmFsaWQgQ29tcHV0ZUJ1ZGdldCBJbnN0cnVjdGlvblR5cGUncwoJICogQGludGVybmFsCgkgKi8KCWNvbnN0IENPTVBVVEVfQlVER0VUX0lOU1RSVUNUSU9OX0xBWU9VVFMgPSBPYmplY3QuZnJlZXplKHsKCSAgUmVxdWVzdFVuaXRzOiB7CgkgICAgaW5kZXg6IDAsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51OCgnaW5zdHJ1Y3Rpb24nKSwgTGF5b3V0RXhwb3J0cy51MzIoJ3VuaXRzJyksIExheW91dEV4cG9ydHMudTMyKCdhZGRpdGlvbmFsRmVlJyldKQoJICB9LAoJICBSZXF1ZXN0SGVhcEZyYW1lOiB7CgkgICAgaW5kZXg6IDEsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51OCgnaW5zdHJ1Y3Rpb24nKSwgTGF5b3V0RXhwb3J0cy51MzIoJ2J5dGVzJyldKQoJICB9LAoJICBTZXRDb21wdXRlVW5pdExpbWl0OiB7CgkgICAgaW5kZXg6IDIsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51OCgnaW5zdHJ1Y3Rpb24nKSwgTGF5b3V0RXhwb3J0cy51MzIoJ3VuaXRzJyldKQoJICB9LAoJICBTZXRDb21wdXRlVW5pdFByaWNlOiB7CgkgICAgaW5kZXg6IDMsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51OCgnaW5zdHJ1Y3Rpb24nKSwgdTY0KCdtaWNyb0xhbXBvcnRzJyldKQoJICB9Cgl9KTsKCgkvKioKCSAqIEZhY3RvcnkgY2xhc3MgZm9yIHRyYW5zYWN0aW9uIGluc3RydWN0aW9ucyB0byBpbnRlcmFjdCB3aXRoIHRoZSBDb21wdXRlIEJ1ZGdldCBwcm9ncmFtCgkgKi8KCWNsYXNzIENvbXB1dGVCdWRnZXRQcm9ncmFtIHsKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgY29uc3RydWN0b3IoKSB7fQoKCSAgLyoqCgkgICAqIFB1YmxpYyBrZXkgdGhhdCBpZGVudGlmaWVzIHRoZSBDb21wdXRlIEJ1ZGdldCBwcm9ncmFtCgkgICAqLwoKCSAgLyoqCgkgICAqIEBkZXByZWNhdGVkIEluc3RlYWQsIGNhbGwge0BsaW5rIHNldENvbXB1dGVVbml0TGltaXR9IGFuZC9vciB7QGxpbmsgc2V0Q29tcHV0ZVVuaXRQcmljZX0KCSAgICovCgkgIHN0YXRpYyByZXF1ZXN0VW5pdHMocGFyYW1zKSB7CgkgICAgY29uc3QgdHlwZSA9IENPTVBVVEVfQlVER0VUX0lOU1RSVUNUSU9OX0xBWU9VVFMuUmVxdWVzdFVuaXRzOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHBhcmFtcyk7CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHsKCSAgICAgIGtleXM6IFtdLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoJICBzdGF0aWMgcmVxdWVzdEhlYXBGcmFtZShwYXJhbXMpIHsKCSAgICBjb25zdCB0eXBlID0gQ09NUFVURV9CVURHRVRfSU5TVFJVQ1RJT05fTEFZT1VUUy5SZXF1ZXN0SGVhcEZyYW1lOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHBhcmFtcyk7CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHsKCSAgICAgIGtleXM6IFtdLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoJICBzdGF0aWMgc2V0Q29tcHV0ZVVuaXRMaW1pdChwYXJhbXMpIHsKCSAgICBjb25zdCB0eXBlID0gQ09NUFVURV9CVURHRVRfSU5TVFJVQ1RJT05fTEFZT1VUUy5TZXRDb21wdXRlVW5pdExpbWl0OwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHBhcmFtcyk7CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHsKCSAgICAgIGtleXM6IFtdLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoJICBzdGF0aWMgc2V0Q29tcHV0ZVVuaXRQcmljZShwYXJhbXMpIHsKCSAgICBjb25zdCB0eXBlID0gQ09NUFVURV9CVURHRVRfSU5TVFJVQ1RJT05fTEFZT1VUUy5TZXRDb21wdXRlVW5pdFByaWNlOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgIG1pY3JvTGFtcG9ydHM6IEJpZ0ludChwYXJhbXMubWljcm9MYW1wb3J0cykKCSAgICB9KTsKCSAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24oewoJICAgICAga2V5czogW10sCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAgZGF0YQoJICAgIH0pOwoJICB9Cgl9CglDb21wdXRlQnVkZ2V0UHJvZ3JhbS5wcm9ncmFtSWQgPSBuZXcgUHVibGljS2V5KCdDb21wdXRlQnVkZ2V0MTExMTExMTExMTExMTExMTExMTExMTExMTExMTExJyk7CgoJY29uc3QgUFJJVkFURV9LRVlfQllURVMkMSA9IDY0OwoJY29uc3QgUFVCTElDX0tFWV9CWVRFUyQxID0gMzI7Cgljb25zdCBTSUdOQVRVUkVfQllURVMgPSA2NDsKCgkvKioKCSAqIFBhcmFtcyBmb3IgY3JlYXRpbmcgYW4gZWQyNTUxOSBpbnN0cnVjdGlvbiB1c2luZyBhIHB1YmxpYyBrZXkKCSAqLwoKCS8qKgoJICogUGFyYW1zIGZvciBjcmVhdGluZyBhbiBlZDI1NTE5IGluc3RydWN0aW9uIHVzaW5nIGEgcHJpdmF0ZSBrZXkKCSAqLwoKCWNvbnN0IEVEMjU1MTlfSU5TVFJVQ1RJT05fTEFZT1VUID0gTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTgoJ251bVNpZ25hdHVyZXMnKSwgTGF5b3V0RXhwb3J0cy51OCgncGFkZGluZycpLCBMYXlvdXRFeHBvcnRzLnUxNignc2lnbmF0dXJlT2Zmc2V0JyksIExheW91dEV4cG9ydHMudTE2KCdzaWduYXR1cmVJbnN0cnVjdGlvbkluZGV4JyksIExheW91dEV4cG9ydHMudTE2KCdwdWJsaWNLZXlPZmZzZXQnKSwgTGF5b3V0RXhwb3J0cy51MTYoJ3B1YmxpY0tleUluc3RydWN0aW9uSW5kZXgnKSwgTGF5b3V0RXhwb3J0cy51MTYoJ21lc3NhZ2VEYXRhT2Zmc2V0JyksIExheW91dEV4cG9ydHMudTE2KCdtZXNzYWdlRGF0YVNpemUnKSwgTGF5b3V0RXhwb3J0cy51MTYoJ21lc3NhZ2VJbnN0cnVjdGlvbkluZGV4JyldKTsKCWNsYXNzIEVkMjU1MTlQcm9ncmFtIHsKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgY29uc3RydWN0b3IoKSB7fQoKCSAgLyoqCgkgICAqIFB1YmxpYyBrZXkgdGhhdCBpZGVudGlmaWVzIHRoZSBlZDI1NTE5IHByb2dyYW0KCSAgICovCgoJICAvKioKCSAgICogQ3JlYXRlIGFuIGVkMjU1MTkgaW5zdHJ1Y3Rpb24gd2l0aCBhIHB1YmxpYyBrZXkgYW5kIHNpZ25hdHVyZS4gVGhlCgkgICAqIHB1YmxpYyBrZXkgbXVzdCBiZSBhIGJ1ZmZlciB0aGF0IGlzIDMyIGJ5dGVzIGxvbmcsIGFuZCB0aGUgc2lnbmF0dXJlCgkgICAqIG11c3QgYmUgYSBidWZmZXIgb2YgNjQgYnl0ZXMuCgkgICAqLwoJICBzdGF0aWMgY3JlYXRlSW5zdHJ1Y3Rpb25XaXRoUHVibGljS2V5KHBhcmFtcykgewoJICAgIGNvbnN0IHsKCSAgICAgIHB1YmxpY0tleSwKCSAgICAgIG1lc3NhZ2UsCgkgICAgICBzaWduYXR1cmUsCgkgICAgICBpbnN0cnVjdGlvbkluZGV4CgkgICAgfSA9IHBhcmFtczsKCSAgICBhc3NlcnQkMShwdWJsaWNLZXkubGVuZ3RoID09PSBQVUJMSUNfS0VZX0JZVEVTJDEsIGBQdWJsaWMgS2V5IG11c3QgYmUgJHtQVUJMSUNfS0VZX0JZVEVTJDF9IGJ5dGVzIGJ1dCByZWNlaXZlZCAke3B1YmxpY0tleS5sZW5ndGh9IGJ5dGVzYCk7CgkgICAgYXNzZXJ0JDEoc2lnbmF0dXJlLmxlbmd0aCA9PT0gU0lHTkFUVVJFX0JZVEVTLCBgU2lnbmF0dXJlIG11c3QgYmUgJHtTSUdOQVRVUkVfQllURVN9IGJ5dGVzIGJ1dCByZWNlaXZlZCAke3NpZ25hdHVyZS5sZW5ndGh9IGJ5dGVzYCk7CgkgICAgY29uc3QgcHVibGljS2V5T2Zmc2V0ID0gRUQyNTUxOV9JTlNUUlVDVElPTl9MQVlPVVQuc3BhbjsKCSAgICBjb25zdCBzaWduYXR1cmVPZmZzZXQgPSBwdWJsaWNLZXlPZmZzZXQgKyBwdWJsaWNLZXkubGVuZ3RoOwoJICAgIGNvbnN0IG1lc3NhZ2VEYXRhT2Zmc2V0ID0gc2lnbmF0dXJlT2Zmc2V0ICsgc2lnbmF0dXJlLmxlbmd0aDsKCSAgICBjb25zdCBudW1TaWduYXR1cmVzID0gMTsKCSAgICBjb25zdCBpbnN0cnVjdGlvbkRhdGEgPSBidWZmZXJFeHBvcnRzLkJ1ZmZlci5hbGxvYyhtZXNzYWdlRGF0YU9mZnNldCArIG1lc3NhZ2UubGVuZ3RoKTsKCSAgICBjb25zdCBpbmRleCA9IGluc3RydWN0aW9uSW5kZXggPT0gbnVsbCA/IDB4ZmZmZiAvLyBBbiBpbmRleCBvZiBgdTE2OjpNQVhgIG1ha2VzIGl0IGRlZmF1bHQgdG8gdGhlIGN1cnJlbnQgaW5zdHJ1Y3Rpb24uCgkgICAgOiBpbnN0cnVjdGlvbkluZGV4OwoJICAgIEVEMjU1MTlfSU5TVFJVQ1RJT05fTEFZT1VULmVuY29kZSh7CgkgICAgICBudW1TaWduYXR1cmVzLAoJICAgICAgcGFkZGluZzogMCwKCSAgICAgIHNpZ25hdHVyZU9mZnNldCwKCSAgICAgIHNpZ25hdHVyZUluc3RydWN0aW9uSW5kZXg6IGluZGV4LAoJICAgICAgcHVibGljS2V5T2Zmc2V0LAoJICAgICAgcHVibGljS2V5SW5zdHJ1Y3Rpb25JbmRleDogaW5kZXgsCgkgICAgICBtZXNzYWdlRGF0YU9mZnNldCwKCSAgICAgIG1lc3NhZ2VEYXRhU2l6ZTogbWVzc2FnZS5sZW5ndGgsCgkgICAgICBtZXNzYWdlSW5zdHJ1Y3Rpb25JbmRleDogaW5kZXgKCSAgICB9LCBpbnN0cnVjdGlvbkRhdGEpOwoJICAgIGluc3RydWN0aW9uRGF0YS5maWxsKHB1YmxpY0tleSwgcHVibGljS2V5T2Zmc2V0KTsKCSAgICBpbnN0cnVjdGlvbkRhdGEuZmlsbChzaWduYXR1cmUsIHNpZ25hdHVyZU9mZnNldCk7CgkgICAgaW5zdHJ1Y3Rpb25EYXRhLmZpbGwobWVzc2FnZSwgbWVzc2FnZURhdGFPZmZzZXQpOwoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBrZXlzOiBbXSwKCSAgICAgIHByb2dyYW1JZDogRWQyNTUxOVByb2dyYW0ucHJvZ3JhbUlkLAoJICAgICAgZGF0YTogaW5zdHJ1Y3Rpb25EYXRhCgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBDcmVhdGUgYW4gZWQyNTUxOSBpbnN0cnVjdGlvbiB3aXRoIGEgcHJpdmF0ZSBrZXkuIFRoZSBwcml2YXRlIGtleQoJICAgKiBtdXN0IGJlIGEgYnVmZmVyIHRoYXQgaXMgNjQgYnl0ZXMgbG9uZy4KCSAgICovCgkgIHN0YXRpYyBjcmVhdGVJbnN0cnVjdGlvbldpdGhQcml2YXRlS2V5KHBhcmFtcykgewoJICAgIGNvbnN0IHsKCSAgICAgIHByaXZhdGVLZXksCgkgICAgICBtZXNzYWdlLAoJICAgICAgaW5zdHJ1Y3Rpb25JbmRleAoJICAgIH0gPSBwYXJhbXM7CgkgICAgYXNzZXJ0JDEocHJpdmF0ZUtleS5sZW5ndGggPT09IFBSSVZBVEVfS0VZX0JZVEVTJDEsIGBQcml2YXRlIGtleSBtdXN0IGJlICR7UFJJVkFURV9LRVlfQllURVMkMX0gYnl0ZXMgYnV0IHJlY2VpdmVkICR7cHJpdmF0ZUtleS5sZW5ndGh9IGJ5dGVzYCk7CgkgICAgdHJ5IHsKCSAgICAgIGNvbnN0IGtleXBhaXIgPSBLZXlwYWlyLmZyb21TZWNyZXRLZXkocHJpdmF0ZUtleSk7CgkgICAgICBjb25zdCBwdWJsaWNLZXkgPSBrZXlwYWlyLnB1YmxpY0tleS50b0J5dGVzKCk7CgkgICAgICBjb25zdCBzaWduYXR1cmUgPSBzaWduKG1lc3NhZ2UsIGtleXBhaXIuc2VjcmV0S2V5KTsKCSAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUluc3RydWN0aW9uV2l0aFB1YmxpY0tleSh7CgkgICAgICAgIHB1YmxpY0tleSwKCSAgICAgICAgbWVzc2FnZSwKCSAgICAgICAgc2lnbmF0dXJlLAoJICAgICAgICBpbnN0cnVjdGlvbkluZGV4CgkgICAgICB9KTsKCSAgICB9IGNhdGNoIChlcnJvcikgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvciBjcmVhdGluZyBpbnN0cnVjdGlvbjsgJHtlcnJvcn1gKTsKCSAgICB9CgkgIH0KCX0KCUVkMjU1MTlQcm9ncmFtLnByb2dyYW1JZCA9IG5ldyBQdWJsaWNLZXkoJ0VkMjU1MTlTaWdWZXJpZnkxMTExMTExMTExMTExMTExMTExMTExMTExMTEnKTsKCgljb25zdCBVMzJfTUFTSzY0ID0gLyogQF9fUFVSRV9fICovIEJpZ0ludCgyICoqIDMyIC0gMSk7Cgljb25zdCBfMzJuID0gLyogQF9fUFVSRV9fICovIEJpZ0ludCgzMik7CgkvLyBCaWdVaW50NjRBcnJheSBpcyB0b28gc2xvdyBhcyBwZXIgMjAyNCwgc28gd2UgaW1wbGVtZW50IGl0IHVzaW5nIFVpbnQzMkFycmF5LgoJLy8gVE9ETzogcmUtY2hlY2sgaHR0cHM6Ly9pc3N1ZXMuY2hyb21pdW0ub3JnL2lzc3Vlcy80MjIxMjU4OAoJZnVuY3Rpb24gZnJvbUJpZyhuLCBsZSA9IGZhbHNlKSB7CgkgICAgaWYgKGxlKQoJICAgICAgICByZXR1cm4geyBoOiBOdW1iZXIobiAmIFUzMl9NQVNLNjQpLCBsOiBOdW1iZXIoKG4gPj4gXzMybikgJiBVMzJfTUFTSzY0KSB9OwoJICAgIHJldHVybiB7IGg6IE51bWJlcigobiA+PiBfMzJuKSAmIFUzMl9NQVNLNjQpIHwgMCwgbDogTnVtYmVyKG4gJiBVMzJfTUFTSzY0KSB8IDAgfTsKCX0KCWZ1bmN0aW9uIHNwbGl0KGxzdCwgbGUgPSBmYWxzZSkgewoJICAgIGxldCBBaCA9IG5ldyBVaW50MzJBcnJheShsc3QubGVuZ3RoKTsKCSAgICBsZXQgQWwgPSBuZXcgVWludDMyQXJyYXkobHN0Lmxlbmd0aCk7CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsc3QubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgY29uc3QgeyBoLCBsIH0gPSBmcm9tQmlnKGxzdFtpXSwgbGUpOwoJICAgICAgICBbQWhbaV0sIEFsW2ldXSA9IFtoLCBsXTsKCSAgICB9CgkgICAgcmV0dXJuIFtBaCwgQWxdOwoJfQoJLy8gTGVmdCByb3RhdGUgZm9yIFNoaWZ0IGluIFsxLCAzMikKCWNvbnN0IHJvdGxTSCA9IChoLCBsLCBzKSA9PiAoaCA8PCBzKSB8IChsID4+PiAoMzIgLSBzKSk7Cgljb25zdCByb3RsU0wgPSAoaCwgbCwgcykgPT4gKGwgPDwgcykgfCAoaCA+Pj4gKDMyIC0gcykpOwoJLy8gTGVmdCByb3RhdGUgZm9yIFNoaWZ0IGluICgzMiwgNjQpLCBOT1RFOiAzMiBpcyBzcGVjaWFsIGNhc2UuCgljb25zdCByb3RsQkggPSAoaCwgbCwgcykgPT4gKGwgPDwgKHMgLSAzMikpIHwgKGggPj4+ICg2NCAtIHMpKTsKCWNvbnN0IHJvdGxCTCA9IChoLCBsLCBzKSA9PiAoaCA8PCAocyAtIDMyKSkgfCAobCA+Pj4gKDY0IC0gcykpOwoKCS8vIFNIQTMgKGtlY2NhaykgaXMgYmFzZWQgb24gYSBuZXcgZGVzaWduOiBiYXNpY2FsbHksIHRoZSBpbnRlcm5hbCBzdGF0ZSBpcyBiaWdnZXIgdGhhbiBvdXRwdXQgc2l6ZS4KCS8vIEl0J3MgY2FsbGVkIGEgc3BvbmdlIGZ1bmN0aW9uLgoJLy8gVmFyaW91cyBwZXIgcm91bmQgY29uc3RhbnRzIGNhbGN1bGF0aW9ucwoJY29uc3QgU0hBM19QSSA9IFtdOwoJY29uc3QgU0hBM19ST1RMID0gW107Cgljb25zdCBfU0hBM19JT1RBID0gW107Cgljb25zdCBfMG4kMSA9IC8qIEBfX1BVUkVfXyAqLyBCaWdJbnQoMCk7Cgljb25zdCBfMW4kMiA9IC8qIEBfX1BVUkVfXyAqLyBCaWdJbnQoMSk7Cgljb25zdCBfMm4kMSA9IC8qIEBfX1BVUkVfXyAqLyBCaWdJbnQoMik7Cgljb25zdCBfN24gPSAvKiBAX19QVVJFX18gKi8gQmlnSW50KDcpOwoJY29uc3QgXzI1Nm4gPSAvKiBAX19QVVJFX18gKi8gQmlnSW50KDI1Nik7Cgljb25zdCBfMHg3MW4gPSAvKiBAX19QVVJFX18gKi8gQmlnSW50KDB4NzEpOwoJZm9yIChsZXQgcm91bmQgPSAwLCBSID0gXzFuJDIsIHggPSAxLCB5ID0gMDsgcm91bmQgPCAyNDsgcm91bmQrKykgewoJICAgIC8vIFBpCgkgICAgW3gsIHldID0gW3ksICgyICogeCArIDMgKiB5KSAlIDVdOwoJICAgIFNIQTNfUEkucHVzaCgyICogKDUgKiB5ICsgeCkpOwoJICAgIC8vIFJvdGF0aW9uYWwKCSAgICBTSEEzX1JPVEwucHVzaCgoKChyb3VuZCArIDEpICogKHJvdW5kICsgMikpIC8gMikgJSA2NCk7CgkgICAgLy8gSW90YQoJICAgIGxldCB0ID0gXzBuJDE7CgkgICAgZm9yIChsZXQgaiA9IDA7IGogPCA3OyBqKyspIHsKCSAgICAgICAgUiA9ICgoUiA8PCBfMW4kMikgXiAoKFIgPj4gXzduKSAqIF8weDcxbikpICUgXzI1Nm47CgkgICAgICAgIGlmIChSICYgXzJuJDEpCgkgICAgICAgICAgICB0IF49IF8xbiQyIDw8ICgoXzFuJDIgPDwgLyogQF9fUFVSRV9fICovIEJpZ0ludChqKSkgLSBfMW4kMik7CgkgICAgfQoJICAgIF9TSEEzX0lPVEEucHVzaCh0KTsKCX0KCWNvbnN0IFtTSEEzX0lPVEFfSCwgU0hBM19JT1RBX0xdID0gLyogQF9fUFVSRV9fICovIHNwbGl0KF9TSEEzX0lPVEEsIHRydWUpOwoJLy8gTGVmdCByb3RhdGlvbiAod2l0aG91dCAwLCAzMiwgNjQpCgljb25zdCByb3RsSCA9IChoLCBsLCBzKSA9PiAocyA+IDMyID8gcm90bEJIKGgsIGwsIHMpIDogcm90bFNIKGgsIGwsIHMpKTsKCWNvbnN0IHJvdGxMID0gKGgsIGwsIHMpID0+IChzID4gMzIgPyByb3RsQkwoaCwgbCwgcykgOiByb3RsU0woaCwgbCwgcykpOwoJLy8gU2FtZSBhcyBrZWNjYWtmMTYwMCwgYnV0IGFsbG93cyB0byBza2lwIHNvbWUgcm91bmRzCglmdW5jdGlvbiBrZWNjYWtQKHMsIHJvdW5kcyA9IDI0KSB7CgkgICAgY29uc3QgQiA9IG5ldyBVaW50MzJBcnJheSg1ICogMik7CgkgICAgLy8gTk9URTogYWxsIGluZGljZXMgYXJlIHgyIHNpbmNlIHdlIHN0b3JlIHN0YXRlIGFzIHUzMiBpbnN0ZWFkIG9mIHU2NCAoYmlnaW50cyB0byBzbG93IGluIGpzKQoJICAgIGZvciAobGV0IHJvdW5kID0gMjQgLSByb3VuZHM7IHJvdW5kIDwgMjQ7IHJvdW5kKyspIHsKCSAgICAgICAgLy8gVGhldGEgzrgKCSAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCAxMDsgeCsrKQoJICAgICAgICAgICAgQlt4XSA9IHNbeF0gXiBzW3ggKyAxMF0gXiBzW3ggKyAyMF0gXiBzW3ggKyAzMF0gXiBzW3ggKyA0MF07CgkgICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgMTA7IHggKz0gMikgewoJICAgICAgICAgICAgY29uc3QgaWR4MSA9ICh4ICsgOCkgJSAxMDsKCSAgICAgICAgICAgIGNvbnN0IGlkeDAgPSAoeCArIDIpICUgMTA7CgkgICAgICAgICAgICBjb25zdCBCMCA9IEJbaWR4MF07CgkgICAgICAgICAgICBjb25zdCBCMSA9IEJbaWR4MCArIDFdOwoJICAgICAgICAgICAgY29uc3QgVGggPSByb3RsSChCMCwgQjEsIDEpIF4gQltpZHgxXTsKCSAgICAgICAgICAgIGNvbnN0IFRsID0gcm90bEwoQjAsIEIxLCAxKSBeIEJbaWR4MSArIDFdOwoJICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCA1MDsgeSArPSAxMCkgewoJICAgICAgICAgICAgICAgIHNbeCArIHldIF49IFRoOwoJICAgICAgICAgICAgICAgIHNbeCArIHkgKyAxXSBePSBUbDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICAvLyBSaG8gKM+BKSBhbmQgUGkgKM+AKQoJICAgICAgICBsZXQgY3VySCA9IHNbMl07CgkgICAgICAgIGxldCBjdXJMID0gc1szXTsKCSAgICAgICAgZm9yIChsZXQgdCA9IDA7IHQgPCAyNDsgdCsrKSB7CgkgICAgICAgICAgICBjb25zdCBzaGlmdCA9IFNIQTNfUk9UTFt0XTsKCSAgICAgICAgICAgIGNvbnN0IFRoID0gcm90bEgoY3VySCwgY3VyTCwgc2hpZnQpOwoJICAgICAgICAgICAgY29uc3QgVGwgPSByb3RsTChjdXJILCBjdXJMLCBzaGlmdCk7CgkgICAgICAgICAgICBjb25zdCBQSSA9IFNIQTNfUElbdF07CgkgICAgICAgICAgICBjdXJIID0gc1tQSV07CgkgICAgICAgICAgICBjdXJMID0gc1tQSSArIDFdOwoJICAgICAgICAgICAgc1tQSV0gPSBUaDsKCSAgICAgICAgICAgIHNbUEkgKyAxXSA9IFRsOwoJICAgICAgICB9CgkgICAgICAgIC8vIENoaSAoz4cpCgkgICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgNTA7IHkgKz0gMTApIHsKCSAgICAgICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgMTA7IHgrKykKCSAgICAgICAgICAgICAgICBCW3hdID0gc1t5ICsgeF07CgkgICAgICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IDEwOyB4KyspCgkgICAgICAgICAgICAgICAgc1t5ICsgeF0gXj0gfkJbKHggKyAyKSAlIDEwXSAmIEJbKHggKyA0KSAlIDEwXTsKCSAgICAgICAgfQoJICAgICAgICAvLyBJb3RhICjOuSkKCSAgICAgICAgc1swXSBePSBTSEEzX0lPVEFfSFtyb3VuZF07CgkgICAgICAgIHNbMV0gXj0gU0hBM19JT1RBX0xbcm91bmRdOwoJICAgIH0KCSAgICBCLmZpbGwoMCk7Cgl9CgljbGFzcyBLZWNjYWsgZXh0ZW5kcyBIYXNoIHsKCSAgICAvLyBOT1RFOiB3ZSBhY2NlcHQgYXJndW1lbnRzIGluIGJ5dGVzIGluc3RlYWQgb2YgYml0cyBoZXJlLgoJICAgIGNvbnN0cnVjdG9yKGJsb2NrTGVuLCBzdWZmaXgsIG91dHB1dExlbiwgZW5hYmxlWE9GID0gZmFsc2UsIHJvdW5kcyA9IDI0KSB7CgkgICAgICAgIHN1cGVyKCk7CgkgICAgICAgIHRoaXMuYmxvY2tMZW4gPSBibG9ja0xlbjsKCSAgICAgICAgdGhpcy5zdWZmaXggPSBzdWZmaXg7CgkgICAgICAgIHRoaXMub3V0cHV0TGVuID0gb3V0cHV0TGVuOwoJICAgICAgICB0aGlzLmVuYWJsZVhPRiA9IGVuYWJsZVhPRjsKCSAgICAgICAgdGhpcy5yb3VuZHMgPSByb3VuZHM7CgkgICAgICAgIHRoaXMucG9zID0gMDsKCSAgICAgICAgdGhpcy5wb3NPdXQgPSAwOwoJICAgICAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CgkgICAgICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2U7CgkgICAgICAgIC8vIENhbiBiZSBwYXNzZWQgZnJvbSB1c2VyIGFzIGRrTGVuCgkgICAgICAgIGFudW1iZXIob3V0cHV0TGVuKTsKCSAgICAgICAgLy8gMTYwMCA9IDV4NSBtYXRyaXggb2YgNjRiaXQuICAxNjAwIGJpdHMgPT09IDIwMCBieXRlcwoJICAgICAgICBpZiAoMCA+PSB0aGlzLmJsb2NrTGVuIHx8IHRoaXMuYmxvY2tMZW4gPj0gMjAwKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaGEzIHN1cHBvcnRzIG9ubHkga2VjY2FrLWYxNjAwIGZ1bmN0aW9uJyk7CgkgICAgICAgIHRoaXMuc3RhdGUgPSBuZXcgVWludDhBcnJheSgyMDApOwoJICAgICAgICB0aGlzLnN0YXRlMzIgPSB1MzIodGhpcy5zdGF0ZSk7CgkgICAgfQoJICAgIGtlY2NhaygpIHsKCSAgICAgICAgaWYgKCFpc0xFKQoJICAgICAgICAgICAgYnl0ZVN3YXAzMih0aGlzLnN0YXRlMzIpOwoJICAgICAgICBrZWNjYWtQKHRoaXMuc3RhdGUzMiwgdGhpcy5yb3VuZHMpOwoJICAgICAgICBpZiAoIWlzTEUpCgkgICAgICAgICAgICBieXRlU3dhcDMyKHRoaXMuc3RhdGUzMik7CgkgICAgICAgIHRoaXMucG9zT3V0ID0gMDsKCSAgICAgICAgdGhpcy5wb3MgPSAwOwoJICAgIH0KCSAgICB1cGRhdGUoZGF0YSkgewoJICAgICAgICBhZXhpc3RzKHRoaXMpOwoJICAgICAgICBjb25zdCB7IGJsb2NrTGVuLCBzdGF0ZSB9ID0gdGhpczsKCSAgICAgICAgZGF0YSA9IHRvQnl0ZXMoZGF0YSk7CgkgICAgICAgIGNvbnN0IGxlbiA9IGRhdGEubGVuZ3RoOwoJICAgICAgICBmb3IgKGxldCBwb3MgPSAwOyBwb3MgPCBsZW47KSB7CgkgICAgICAgICAgICBjb25zdCB0YWtlID0gTWF0aC5taW4oYmxvY2tMZW4gLSB0aGlzLnBvcywgbGVuIC0gcG9zKTsKCSAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFrZTsgaSsrKQoJICAgICAgICAgICAgICAgIHN0YXRlW3RoaXMucG9zKytdIF49IGRhdGFbcG9zKytdOwoJICAgICAgICAgICAgaWYgKHRoaXMucG9zID09PSBibG9ja0xlbikKCSAgICAgICAgICAgICAgICB0aGlzLmtlY2NhaygpOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB0aGlzOwoJICAgIH0KCSAgICBmaW5pc2goKSB7CgkgICAgICAgIGlmICh0aGlzLmZpbmlzaGVkKQoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKCSAgICAgICAgY29uc3QgeyBzdGF0ZSwgc3VmZml4LCBwb3MsIGJsb2NrTGVuIH0gPSB0aGlzOwoJICAgICAgICAvLyBEbyB0aGUgcGFkZGluZwoJICAgICAgICBzdGF0ZVtwb3NdIF49IHN1ZmZpeDsKCSAgICAgICAgaWYgKChzdWZmaXggJiAweDgwKSAhPT0gMCAmJiBwb3MgPT09IGJsb2NrTGVuIC0gMSkKCSAgICAgICAgICAgIHRoaXMua2VjY2FrKCk7CgkgICAgICAgIHN0YXRlW2Jsb2NrTGVuIC0gMV0gXj0gMHg4MDsKCSAgICAgICAgdGhpcy5rZWNjYWsoKTsKCSAgICB9CgkgICAgd3JpdGVJbnRvKG91dCkgewoJICAgICAgICBhZXhpc3RzKHRoaXMsIGZhbHNlKTsKCSAgICAgICAgYWJ5dGVzKG91dCk7CgkgICAgICAgIHRoaXMuZmluaXNoKCk7CgkgICAgICAgIGNvbnN0IGJ1ZmZlck91dCA9IHRoaXMuc3RhdGU7CgkgICAgICAgIGNvbnN0IHsgYmxvY2tMZW4gfSA9IHRoaXM7CgkgICAgICAgIGZvciAobGV0IHBvcyA9IDAsIGxlbiA9IG91dC5sZW5ndGg7IHBvcyA8IGxlbjspIHsKCSAgICAgICAgICAgIGlmICh0aGlzLnBvc091dCA+PSBibG9ja0xlbikKCSAgICAgICAgICAgICAgICB0aGlzLmtlY2NhaygpOwoJICAgICAgICAgICAgY29uc3QgdGFrZSA9IE1hdGgubWluKGJsb2NrTGVuIC0gdGhpcy5wb3NPdXQsIGxlbiAtIHBvcyk7CgkgICAgICAgICAgICBvdXQuc2V0KGJ1ZmZlck91dC5zdWJhcnJheSh0aGlzLnBvc091dCwgdGhpcy5wb3NPdXQgKyB0YWtlKSwgcG9zKTsKCSAgICAgICAgICAgIHRoaXMucG9zT3V0ICs9IHRha2U7CgkgICAgICAgICAgICBwb3MgKz0gdGFrZTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gb3V0OwoJICAgIH0KCSAgICB4b2ZJbnRvKG91dCkgewoJICAgICAgICAvLyBTaGEzL0tlY2NhayB1c2FnZSB3aXRoIFhPRiBpcyBwcm9iYWJseSBtaXN0YWtlLCBvbmx5IFNIQUtFIGluc3RhbmNlcyBjYW4gZG8gWE9GCgkgICAgICAgIGlmICghdGhpcy5lbmFibGVYT0YpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1hPRiBpcyBub3QgcG9zc2libGUgZm9yIHRoaXMgaW5zdGFuY2UnKTsKCSAgICAgICAgcmV0dXJuIHRoaXMud3JpdGVJbnRvKG91dCk7CgkgICAgfQoJICAgIHhvZihieXRlcykgewoJICAgICAgICBhbnVtYmVyKGJ5dGVzKTsKCSAgICAgICAgcmV0dXJuIHRoaXMueG9mSW50byhuZXcgVWludDhBcnJheShieXRlcykpOwoJICAgIH0KCSAgICBkaWdlc3RJbnRvKG91dCkgewoJICAgICAgICBhb3V0cHV0KG91dCwgdGhpcyk7CgkgICAgICAgIGlmICh0aGlzLmZpbmlzaGVkKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdkaWdlc3QoKSB3YXMgYWxyZWFkeSBjYWxsZWQnKTsKCSAgICAgICAgdGhpcy53cml0ZUludG8ob3V0KTsKCSAgICAgICAgdGhpcy5kZXN0cm95KCk7CgkgICAgICAgIHJldHVybiBvdXQ7CgkgICAgfQoJICAgIGRpZ2VzdCgpIHsKCSAgICAgICAgcmV0dXJuIHRoaXMuZGlnZXN0SW50byhuZXcgVWludDhBcnJheSh0aGlzLm91dHB1dExlbikpOwoJICAgIH0KCSAgICBkZXN0cm95KCkgewoJICAgICAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWU7CgkgICAgICAgIHRoaXMuc3RhdGUuZmlsbCgwKTsKCSAgICB9CgkgICAgX2Nsb25lSW50byh0bykgewoJICAgICAgICBjb25zdCB7IGJsb2NrTGVuLCBzdWZmaXgsIG91dHB1dExlbiwgcm91bmRzLCBlbmFibGVYT0YgfSA9IHRoaXM7CgkgICAgICAgIHRvIHx8ICh0byA9IG5ldyBLZWNjYWsoYmxvY2tMZW4sIHN1ZmZpeCwgb3V0cHV0TGVuLCBlbmFibGVYT0YsIHJvdW5kcykpOwoJICAgICAgICB0by5zdGF0ZTMyLnNldCh0aGlzLnN0YXRlMzIpOwoJICAgICAgICB0by5wb3MgPSB0aGlzLnBvczsKCSAgICAgICAgdG8ucG9zT3V0ID0gdGhpcy5wb3NPdXQ7CgkgICAgICAgIHRvLmZpbmlzaGVkID0gdGhpcy5maW5pc2hlZDsKCSAgICAgICAgdG8ucm91bmRzID0gcm91bmRzOwoJICAgICAgICAvLyBTdWZmaXggY2FuIGNoYW5nZSBpbiBjU0hBS0UKCSAgICAgICAgdG8uc3VmZml4ID0gc3VmZml4OwoJICAgICAgICB0by5vdXRwdXRMZW4gPSBvdXRwdXRMZW47CgkgICAgICAgIHRvLmVuYWJsZVhPRiA9IGVuYWJsZVhPRjsKCSAgICAgICAgdG8uZGVzdHJveWVkID0gdGhpcy5kZXN0cm95ZWQ7CgkgICAgICAgIHJldHVybiB0bzsKCSAgICB9Cgl9Cgljb25zdCBnZW4gPSAoc3VmZml4LCBibG9ja0xlbiwgb3V0cHV0TGVuKSA9PiB3cmFwQ29uc3RydWN0b3IoKCkgPT4gbmV3IEtlY2NhayhibG9ja0xlbiwgc3VmZml4LCBvdXRwdXRMZW4pKTsKCS8qKgoJICoga2VjY2FrLTI1NiBoYXNoIGZ1bmN0aW9uLiBEaWZmZXJlbnQgZnJvbSBTSEEzLTI1Ni4KCSAqIEBwYXJhbSBtZXNzYWdlIC0gdGhhdCB3b3VsZCBiZSBoYXNoZWQKCSAqLwoJY29uc3Qga2VjY2FrXzI1NiA9IC8qIEBfX1BVUkVfXyAqLyBnZW4oMHgwMSwgMTM2LCAyNTYgLyA4KTsKCgkvLyBTSEEyLTI1NiBuZWVkIHRvIHRyeSAyXjEyOCBoYXNoZXMgdG8gZXhlY3V0ZSBiaXJ0aGRheSBhdHRhY2suCgkvLyBCVEMgbmV0d29yayBpcyBkb2luZyAyXjcwIGhhc2hlcy9zZWMgKDJeOTUgaGFzaGVzL3llYXIpIGFzIHBlciBsYXRlIDIwMjQuCgkvLyBSb3VuZCBjb25zdGFudHM6CgkvLyBmaXJzdCAzMiBiaXRzIG9mIHRoZSBmcmFjdGlvbmFsIHBhcnRzIG9mIHRoZSBjdWJlIHJvb3RzIG9mIHRoZSBmaXJzdCA2NCBwcmltZXMgMi4uMzExKQoJLy8gcHJldHRpZXItaWdub3JlCgljb25zdCBTSEEyNTZfSyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVWludDMyQXJyYXkoWwoJICAgIDB4NDI4YTJmOTgsIDB4NzEzNzQ0OTEsIDB4YjVjMGZiY2YsIDB4ZTliNWRiYTUsIDB4Mzk1NmMyNWIsIDB4NTlmMTExZjEsIDB4OTIzZjgyYTQsIDB4YWIxYzVlZDUsCgkgICAgMHhkODA3YWE5OCwgMHgxMjgzNWIwMSwgMHgyNDMxODViZSwgMHg1NTBjN2RjMywgMHg3MmJlNWQ3NCwgMHg4MGRlYjFmZSwgMHg5YmRjMDZhNywgMHhjMTliZjE3NCwKCSAgICAweGU0OWI2OWMxLCAweGVmYmU0Nzg2LCAweDBmYzE5ZGM2LCAweDI0MGNhMWNjLCAweDJkZTkyYzZmLCAweDRhNzQ4NGFhLCAweDVjYjBhOWRjLCAweDc2Zjk4OGRhLAoJICAgIDB4OTgzZTUxNTIsIDB4YTgzMWM2NmQsIDB4YjAwMzI3YzgsIDB4YmY1OTdmYzcsIDB4YzZlMDBiZjMsIDB4ZDVhNzkxNDcsIDB4MDZjYTYzNTEsIDB4MTQyOTI5NjcsCgkgICAgMHgyN2I3MGE4NSwgMHgyZTFiMjEzOCwgMHg0ZDJjNmRmYywgMHg1MzM4MGQxMywgMHg2NTBhNzM1NCwgMHg3NjZhMGFiYiwgMHg4MWMyYzkyZSwgMHg5MjcyMmM4NSwKCSAgICAweGEyYmZlOGExLCAweGE4MWE2NjRiLCAweGMyNGI4YjcwLCAweGM3NmM1MWEzLCAweGQxOTJlODE5LCAweGQ2OTkwNjI0LCAweGY0MGUzNTg1LCAweDEwNmFhMDcwLAoJICAgIDB4MTlhNGMxMTYsIDB4MWUzNzZjMDgsIDB4Mjc0ODc3NGMsIDB4MzRiMGJjYjUsIDB4MzkxYzBjYjMsIDB4NGVkOGFhNGEsIDB4NWI5Y2NhNGYsIDB4NjgyZTZmZjMsCgkgICAgMHg3NDhmODJlZSwgMHg3OGE1NjM2ZiwgMHg4NGM4NzgxNCwgMHg4Y2M3MDIwOCwgMHg5MGJlZmZmYSwgMHhhNDUwNmNlYiwgMHhiZWY5YTNmNywgMHhjNjcxNzhmMgoJXSk7CgkvLyBJbml0aWFsIHN0YXRlOgoJLy8gZmlyc3QgMzIgYml0cyBvZiB0aGUgZnJhY3Rpb25hbCBwYXJ0cyBvZiB0aGUgc3F1YXJlIHJvb3RzIG9mIHRoZSBmaXJzdCA4IHByaW1lcyAyLi4xOQoJLy8gcHJldHRpZXItaWdub3JlCgljb25zdCBTSEEyNTZfSVYgPSAvKiBAX19QVVJFX18gKi8gbmV3IFVpbnQzMkFycmF5KFsKCSAgICAweDZhMDllNjY3LCAweGJiNjdhZTg1LCAweDNjNmVmMzcyLCAweGE1NGZmNTNhLCAweDUxMGU1MjdmLCAweDliMDU2ODhjLCAweDFmODNkOWFiLCAweDViZTBjZDE5CgldKTsKCS8vIFRlbXBvcmFyeSBidWZmZXIsIG5vdCB1c2VkIHRvIHN0b3JlIGFueXRoaW5nIGJldHdlZW4gcnVucwoJLy8gTmFtZWQgdGhpcyB3YXkgYmVjYXVzZSBpdCBtYXRjaGVzIHNwZWNpZmljYXRpb24uCgljb25zdCBTSEEyNTZfVyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVWludDMyQXJyYXkoNjQpOwoJY2xhc3MgU0hBMjU2IGV4dGVuZHMgSGFzaE1EJDEgewoJICAgIGNvbnN0cnVjdG9yKCkgewoJICAgICAgICBzdXBlcig2NCwgMzIsIDgsIGZhbHNlKTsKCSAgICAgICAgLy8gV2UgY2Fubm90IHVzZSBhcnJheSBoZXJlIHNpbmNlIGFycmF5IGFsbG93cyBpbmRleGluZyBieSB2YXJpYWJsZQoJICAgICAgICAvLyB3aGljaCBtZWFucyBvcHRpbWl6ZXIvY29tcGlsZXIgY2Fubm90IHVzZSByZWdpc3RlcnMuCgkgICAgICAgIHRoaXMuQSA9IFNIQTI1Nl9JVlswXSB8IDA7CgkgICAgICAgIHRoaXMuQiA9IFNIQTI1Nl9JVlsxXSB8IDA7CgkgICAgICAgIHRoaXMuQyA9IFNIQTI1Nl9JVlsyXSB8IDA7CgkgICAgICAgIHRoaXMuRCA9IFNIQTI1Nl9JVlszXSB8IDA7CgkgICAgICAgIHRoaXMuRSA9IFNIQTI1Nl9JVls0XSB8IDA7CgkgICAgICAgIHRoaXMuRiA9IFNIQTI1Nl9JVls1XSB8IDA7CgkgICAgICAgIHRoaXMuRyA9IFNIQTI1Nl9JVls2XSB8IDA7CgkgICAgICAgIHRoaXMuSCA9IFNIQTI1Nl9JVls3XSB8IDA7CgkgICAgfQoJICAgIGdldCgpIHsKCSAgICAgICAgY29uc3QgeyBBLCBCLCBDLCBELCBFLCBGLCBHLCBIIH0gPSB0aGlzOwoJICAgICAgICByZXR1cm4gW0EsIEIsIEMsIEQsIEUsIEYsIEcsIEhdOwoJICAgIH0KCSAgICAvLyBwcmV0dGllci1pZ25vcmUKCSAgICBzZXQoQSwgQiwgQywgRCwgRSwgRiwgRywgSCkgewoJICAgICAgICB0aGlzLkEgPSBBIHwgMDsKCSAgICAgICAgdGhpcy5CID0gQiB8IDA7CgkgICAgICAgIHRoaXMuQyA9IEMgfCAwOwoJICAgICAgICB0aGlzLkQgPSBEIHwgMDsKCSAgICAgICAgdGhpcy5FID0gRSB8IDA7CgkgICAgICAgIHRoaXMuRiA9IEYgfCAwOwoJICAgICAgICB0aGlzLkcgPSBHIHwgMDsKCSAgICAgICAgdGhpcy5IID0gSCB8IDA7CgkgICAgfQoJICAgIHByb2Nlc3Modmlldywgb2Zmc2V0KSB7CgkgICAgICAgIC8vIEV4dGVuZCB0aGUgZmlyc3QgMTYgd29yZHMgaW50byB0aGUgcmVtYWluaW5nIDQ4IHdvcmRzIHdbMTYuLjYzXSBvZiB0aGUgbWVzc2FnZSBzY2hlZHVsZSBhcnJheQoJICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyssIG9mZnNldCArPSA0KQoJICAgICAgICAgICAgU0hBMjU2X1dbaV0gPSB2aWV3LmdldFVpbnQzMihvZmZzZXQsIGZhbHNlKTsKCSAgICAgICAgZm9yIChsZXQgaSA9IDE2OyBpIDwgNjQ7IGkrKykgewoJICAgICAgICAgICAgY29uc3QgVzE1ID0gU0hBMjU2X1dbaSAtIDE1XTsKCSAgICAgICAgICAgIGNvbnN0IFcyID0gU0hBMjU2X1dbaSAtIDJdOwoJICAgICAgICAgICAgY29uc3QgczAgPSByb3RyJDEoVzE1LCA3KSBeIHJvdHIkMShXMTUsIDE4KSBeIChXMTUgPj4+IDMpOwoJICAgICAgICAgICAgY29uc3QgczEgPSByb3RyJDEoVzIsIDE3KSBeIHJvdHIkMShXMiwgMTkpIF4gKFcyID4+PiAxMCk7CgkgICAgICAgICAgICBTSEEyNTZfV1tpXSA9IChzMSArIFNIQTI1Nl9XW2kgLSA3XSArIHMwICsgU0hBMjU2X1dbaSAtIDE2XSkgfCAwOwoJICAgICAgICB9CgkgICAgICAgIC8vIENvbXByZXNzaW9uIGZ1bmN0aW9uIG1haW4gbG9vcCwgNjQgcm91bmRzCgkgICAgICAgIGxldCB7IEEsIEIsIEMsIEQsIEUsIEYsIEcsIEggfSA9IHRoaXM7CgkgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNjQ7IGkrKykgewoJICAgICAgICAgICAgY29uc3Qgc2lnbWExID0gcm90ciQxKEUsIDYpIF4gcm90ciQxKEUsIDExKSBeIHJvdHIkMShFLCAyNSk7CgkgICAgICAgICAgICBjb25zdCBUMSA9IChIICsgc2lnbWExICsgQ2hpJDEoRSwgRiwgRykgKyBTSEEyNTZfS1tpXSArIFNIQTI1Nl9XW2ldKSB8IDA7CgkgICAgICAgICAgICBjb25zdCBzaWdtYTAgPSByb3RyJDEoQSwgMikgXiByb3RyJDEoQSwgMTMpIF4gcm90ciQxKEEsIDIyKTsKCSAgICAgICAgICAgIGNvbnN0IFQyID0gKHNpZ21hMCArIE1haiQxKEEsIEIsIEMpKSB8IDA7CgkgICAgICAgICAgICBIID0gRzsKCSAgICAgICAgICAgIEcgPSBGOwoJICAgICAgICAgICAgRiA9IEU7CgkgICAgICAgICAgICBFID0gKEQgKyBUMSkgfCAwOwoJICAgICAgICAgICAgRCA9IEM7CgkgICAgICAgICAgICBDID0gQjsKCSAgICAgICAgICAgIEIgPSBBOwoJICAgICAgICAgICAgQSA9IChUMSArIFQyKSB8IDA7CgkgICAgICAgIH0KCSAgICAgICAgLy8gQWRkIHRoZSBjb21wcmVzc2VkIGNodW5rIHRvIHRoZSBjdXJyZW50IGhhc2ggdmFsdWUKCSAgICAgICAgQSA9IChBICsgdGhpcy5BKSB8IDA7CgkgICAgICAgIEIgPSAoQiArIHRoaXMuQikgfCAwOwoJICAgICAgICBDID0gKEMgKyB0aGlzLkMpIHwgMDsKCSAgICAgICAgRCA9IChEICsgdGhpcy5EKSB8IDA7CgkgICAgICAgIEUgPSAoRSArIHRoaXMuRSkgfCAwOwoJICAgICAgICBGID0gKEYgKyB0aGlzLkYpIHwgMDsKCSAgICAgICAgRyA9IChHICsgdGhpcy5HKSB8IDA7CgkgICAgICAgIEggPSAoSCArIHRoaXMuSCkgfCAwOwoJICAgICAgICB0aGlzLnNldChBLCBCLCBDLCBELCBFLCBGLCBHLCBIKTsKCSAgICB9CgkgICAgcm91bmRDbGVhbigpIHsKCSAgICAgICAgU0hBMjU2X1cuZmlsbCgwKTsKCSAgICB9CgkgICAgZGVzdHJveSgpIHsKCSAgICAgICAgdGhpcy5zZXQoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCk7CgkgICAgICAgIHRoaXMuYnVmZmVyLmZpbGwoMCk7CgkgICAgfQoJfQoJLyoqCgkgKiBTSEEyLTI1NiBoYXNoIGZ1bmN0aW9uCgkgKiBAcGFyYW0gbWVzc2FnZSAtIGRhdGEgdGhhdCB3b3VsZCBiZSBoYXNoZWQKCSAqLwoJY29uc3Qgc2hhMjU2ID0gLyogQF9fUFVSRV9fICovIHdyYXBDb25zdHJ1Y3RvciQxKCgpID0+IG5ldyBTSEEyNTYoKSk7CgoJLy8gSE1BQyAoUkZDIDIxMDQpCgljbGFzcyBITUFDIGV4dGVuZHMgSGFzaCQxIHsKCSAgICBjb25zdHJ1Y3RvcihoYXNoLCBfa2V5KSB7CgkgICAgICAgIHN1cGVyKCk7CgkgICAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKCSAgICAgICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZTsKCSAgICAgICAgYWhhc2goaGFzaCk7CgkgICAgICAgIGNvbnN0IGtleSA9IHRvQnl0ZXMkMShfa2V5KTsKCSAgICAgICAgdGhpcy5pSGFzaCA9IGhhc2guY3JlYXRlKCk7CgkgICAgICAgIGlmICh0eXBlb2YgdGhpcy5pSGFzaC51cGRhdGUgIT09ICdmdW5jdGlvbicpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4cGVjdGVkIGluc3RhbmNlIG9mIGNsYXNzIHdoaWNoIGV4dGVuZHMgdXRpbHMuSGFzaCcpOwoJICAgICAgICB0aGlzLmJsb2NrTGVuID0gdGhpcy5pSGFzaC5ibG9ja0xlbjsKCSAgICAgICAgdGhpcy5vdXRwdXRMZW4gPSB0aGlzLmlIYXNoLm91dHB1dExlbjsKCSAgICAgICAgY29uc3QgYmxvY2tMZW4gPSB0aGlzLmJsb2NrTGVuOwoJICAgICAgICBjb25zdCBwYWQgPSBuZXcgVWludDhBcnJheShibG9ja0xlbik7CgkgICAgICAgIC8vIGJsb2NrTGVuIGNhbiBiZSBiaWdnZXIgdGhhbiBvdXRwdXRMZW4KCSAgICAgICAgcGFkLnNldChrZXkubGVuZ3RoID4gYmxvY2tMZW4gPyBoYXNoLmNyZWF0ZSgpLnVwZGF0ZShrZXkpLmRpZ2VzdCgpIDoga2V5KTsKCSAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYWQubGVuZ3RoOyBpKyspCgkgICAgICAgICAgICBwYWRbaV0gXj0gMHgzNjsKCSAgICAgICAgdGhpcy5pSGFzaC51cGRhdGUocGFkKTsKCSAgICAgICAgLy8gQnkgZG9pbmcgdXBkYXRlIChwcm9jZXNzaW5nIG9mIGZpcnN0IGJsb2NrKSBvZiBvdXRlciBoYXNoIGhlcmUgd2UgY2FuIHJlLXVzZSBpdCBiZXR3ZWVuIG11bHRpcGxlIGNhbGxzIHZpYSBjbG9uZQoJICAgICAgICB0aGlzLm9IYXNoID0gaGFzaC5jcmVhdGUoKTsKCSAgICAgICAgLy8gVW5kbyBpbnRlcm5hbCBYT1IgJiYgYXBwbHkgb3V0ZXIgWE9SCgkgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFkLmxlbmd0aDsgaSsrKQoJICAgICAgICAgICAgcGFkW2ldIF49IDB4MzYgXiAweDVjOwoJICAgICAgICB0aGlzLm9IYXNoLnVwZGF0ZShwYWQpOwoJICAgICAgICBwYWQuZmlsbCgwKTsKCSAgICB9CgkgICAgdXBkYXRlKGJ1ZikgewoJICAgICAgICBhZXhpc3RzJDEodGhpcyk7CgkgICAgICAgIHRoaXMuaUhhc2gudXBkYXRlKGJ1Zik7CgkgICAgICAgIHJldHVybiB0aGlzOwoJICAgIH0KCSAgICBkaWdlc3RJbnRvKG91dCkgewoJICAgICAgICBhZXhpc3RzJDEodGhpcyk7CgkgICAgICAgIGFieXRlcyQyKG91dCwgdGhpcy5vdXRwdXRMZW4pOwoJICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKCSAgICAgICAgdGhpcy5pSGFzaC5kaWdlc3RJbnRvKG91dCk7CgkgICAgICAgIHRoaXMub0hhc2gudXBkYXRlKG91dCk7CgkgICAgICAgIHRoaXMub0hhc2guZGlnZXN0SW50byhvdXQpOwoJICAgICAgICB0aGlzLmRlc3Ryb3koKTsKCSAgICB9CgkgICAgZGlnZXN0KCkgewoJICAgICAgICBjb25zdCBvdXQgPSBuZXcgVWludDhBcnJheSh0aGlzLm9IYXNoLm91dHB1dExlbik7CgkgICAgICAgIHRoaXMuZGlnZXN0SW50byhvdXQpOwoJICAgICAgICByZXR1cm4gb3V0OwoJICAgIH0KCSAgICBfY2xvbmVJbnRvKHRvKSB7CgkgICAgICAgIC8vIENyZWF0ZSBuZXcgaW5zdGFuY2Ugd2l0aG91dCBjYWxsaW5nIGNvbnN0cnVjdG9yIHNpbmNlIGtleSBhbHJlYWR5IGluIHN0YXRlIGFuZCB3ZSBkb24ndCBrbm93IGl0LgoJICAgICAgICB0byB8fCAodG8gPSBPYmplY3QuY3JlYXRlKE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKSwge30pKTsKCSAgICAgICAgY29uc3QgeyBvSGFzaCwgaUhhc2gsIGZpbmlzaGVkLCBkZXN0cm95ZWQsIGJsb2NrTGVuLCBvdXRwdXRMZW4gfSA9IHRoaXM7CgkgICAgICAgIHRvID0gdG87CgkgICAgICAgIHRvLmZpbmlzaGVkID0gZmluaXNoZWQ7CgkgICAgICAgIHRvLmRlc3Ryb3llZCA9IGRlc3Ryb3llZDsKCSAgICAgICAgdG8uYmxvY2tMZW4gPSBibG9ja0xlbjsKCSAgICAgICAgdG8ub3V0cHV0TGVuID0gb3V0cHV0TGVuOwoJICAgICAgICB0by5vSGFzaCA9IG9IYXNoLl9jbG9uZUludG8odG8ub0hhc2gpOwoJICAgICAgICB0by5pSGFzaCA9IGlIYXNoLl9jbG9uZUludG8odG8uaUhhc2gpOwoJICAgICAgICByZXR1cm4gdG87CgkgICAgfQoJICAgIGRlc3Ryb3koKSB7CgkgICAgICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTsKCSAgICAgICAgdGhpcy5vSGFzaC5kZXN0cm95KCk7CgkgICAgICAgIHRoaXMuaUhhc2guZGVzdHJveSgpOwoJICAgIH0KCX0KCS8qKgoJICogSE1BQzogUkZDMjEwNCBtZXNzYWdlIGF1dGhlbnRpY2F0aW9uIGNvZGUuCgkgKiBAcGFyYW0gaGFzaCAtIGZ1bmN0aW9uIHRoYXQgd291bGQgYmUgdXNlZCBlLmcuIHNoYTI1NgoJICogQHBhcmFtIGtleSAtIG1lc3NhZ2Uga2V5CgkgKiBAcGFyYW0gbWVzc2FnZSAtIG1lc3NhZ2UgZGF0YQoJICogQGV4YW1wbGUKCSAqIGltcG9ydCB7IGhtYWMgfSBmcm9tICdAbm9ibGUvaGFzaGVzL2htYWMnOwoJICogaW1wb3J0IHsgc2hhMjU2IH0gZnJvbSAnQG5vYmxlL2hhc2hlcy9zaGEyJzsKCSAqIGNvbnN0IG1hYzEgPSBobWFjKHNoYTI1NiwgJ2tleScsICdtZXNzYWdlJyk7CgkgKi8KCWNvbnN0IGhtYWMgPSAoaGFzaCwga2V5LCBtZXNzYWdlKSA9PiBuZXcgSE1BQyhoYXNoLCBrZXkpLnVwZGF0ZShtZXNzYWdlKS5kaWdlc3QoKTsKCWhtYWMuY3JlYXRlID0gKGhhc2gsIGtleSkgPT4gbmV3IEhNQUMoaGFzaCwga2V5KTsKCgkvKiEgbm9ibGUtY3VydmVzIC0gTUlUIExpY2Vuc2UgKGMpIDIwMjIgUGF1bCBNaWxsZXIgKHBhdWxtaWxsci5jb20pICovCgkvLyBTaG9ydCBXZWllcnN0cmFzcyBjdXJ2ZS4gVGhlIGZvcm11bGEgaXM6IHnCsiA9IHjCsyArIGF4ICsgYgoJZnVuY3Rpb24gdmFsaWRhdGVTaWdWZXJPcHRzKG9wdHMpIHsKCSAgICBpZiAob3B0cy5sb3dTICE9PSB1bmRlZmluZWQpCgkgICAgICAgIGFib29sKCdsb3dTJywgb3B0cy5sb3dTKTsKCSAgICBpZiAob3B0cy5wcmVoYXNoICE9PSB1bmRlZmluZWQpCgkgICAgICAgIGFib29sKCdwcmVoYXNoJywgb3B0cy5wcmVoYXNoKTsKCX0KCWZ1bmN0aW9uIHZhbGlkYXRlUG9pbnRPcHRzKGN1cnZlKSB7CgkgICAgY29uc3Qgb3B0cyA9IHZhbGlkYXRlQmFzaWMoY3VydmUpOwoJICAgIHZhbGlkYXRlT2JqZWN0KG9wdHMsIHsKCSAgICAgICAgYTogJ2ZpZWxkJywKCSAgICAgICAgYjogJ2ZpZWxkJywKCSAgICB9LCB7CgkgICAgICAgIGFsbG93ZWRQcml2YXRlS2V5TGVuZ3RoczogJ2FycmF5JywKCSAgICAgICAgd3JhcFByaXZhdGVLZXk6ICdib29sZWFuJywKCSAgICAgICAgaXNUb3JzaW9uRnJlZTogJ2Z1bmN0aW9uJywKCSAgICAgICAgY2xlYXJDb2ZhY3RvcjogJ2Z1bmN0aW9uJywKCSAgICAgICAgYWxsb3dJbmZpbml0eVBvaW50OiAnYm9vbGVhbicsCgkgICAgICAgIGZyb21CeXRlczogJ2Z1bmN0aW9uJywKCSAgICAgICAgdG9CeXRlczogJ2Z1bmN0aW9uJywKCSAgICB9KTsKCSAgICBjb25zdCB7IGVuZG8sIEZwLCBhIH0gPSBvcHRzOwoJICAgIGlmIChlbmRvKSB7CgkgICAgICAgIGlmICghRnAuZXFsKGEsIEZwLlpFUk8pKSB7CgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgZW5kb21vcnBoaXNtLCBjYW4gb25seSBiZSBkZWZpbmVkIGZvciBLb2JsaXR6IGN1cnZlcyB0aGF0IGhhdmUgYT0wJyk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKHR5cGVvZiBlbmRvICE9PSAnb2JqZWN0JyB8fAoJICAgICAgICAgICAgdHlwZW9mIGVuZG8uYmV0YSAhPT0gJ2JpZ2ludCcgfHwKCSAgICAgICAgICAgIHR5cGVvZiBlbmRvLnNwbGl0U2NhbGFyICE9PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgZW5kb21vcnBoaXNtLCBleHBlY3RlZCBiZXRhOiBiaWdpbnQgYW5kIHNwbGl0U2NhbGFyOiBmdW5jdGlvbicpOwoJICAgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBPYmplY3QuZnJlZXplKHsgLi4ub3B0cyB9KTsKCX0KCWNvbnN0IHsgYnl0ZXNUb051bWJlckJFOiBiMm4sIGhleFRvQnl0ZXM6IGgyYiB9ID0gdXQ7CgkvKioKCSAqIEFTTi4xIERFUiBlbmNvZGluZyB1dGlsaXRpZXMuIEFTTiBpcyB2ZXJ5IGNvbXBsZXggJiBmcmFnaWxlLiBGb3JtYXQ6CgkgKgoJICogICAgIFsweDMwIChTRVFVRU5DRSksIGJ5dGVsZW5ndGgsIDB4MDIgKElOVEVHRVIpLCBpbnRMZW5ndGgsIFIsIDB4MDIgKElOVEVHRVIpLCBpbnRMZW5ndGgsIFNdCgkgKgoJICogRG9jczogaHR0cHM6Ly9sZXRzZW5jcnlwdC5vcmcvZG9jcy9hLXdhcm0td2VsY29tZS10by1hc24xLWFuZC1kZXIvLCBodHRwczovL2x1Y2EubnRvcC5vcmcvVGVhY2hpbmcvQXBwdW50aS9hc24xLmh0bWwKCSAqLwoJY29uc3QgREVSID0gewoJICAgIC8vIGFzbi4xIERFUiBlbmNvZGluZyB1dGlscwoJICAgIEVycjogY2xhc3MgREVSRXJyIGV4dGVuZHMgRXJyb3IgewoJICAgICAgICBjb25zdHJ1Y3RvcihtID0gJycpIHsKCSAgICAgICAgICAgIHN1cGVyKG0pOwoJICAgICAgICB9CgkgICAgfSwKCSAgICAvLyBCYXNpYyBidWlsZGluZyBibG9jayBpcyBUTFYgKFRhZy1MZW5ndGgtVmFsdWUpCgkgICAgX3RsdjogewoJICAgICAgICBlbmNvZGU6ICh0YWcsIGRhdGEpID0+IHsKCSAgICAgICAgICAgIGNvbnN0IHsgRXJyOiBFIH0gPSBERVI7CgkgICAgICAgICAgICBpZiAodGFnIDwgMCB8fCB0YWcgPiAyNTYpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEUoJ3Rsdi5lbmNvZGU6IHdyb25nIHRhZycpOwoJICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoICYgMSkKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRSgndGx2LmVuY29kZTogdW5wYWRkZWQgZGF0YScpOwoJICAgICAgICAgICAgY29uc3QgZGF0YUxlbiA9IGRhdGEubGVuZ3RoIC8gMjsKCSAgICAgICAgICAgIGNvbnN0IGxlbiA9IG51bWJlclRvSGV4VW5wYWRkZWQoZGF0YUxlbik7CgkgICAgICAgICAgICBpZiAoKGxlbi5sZW5ndGggLyAyKSAmIDEyOCkKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRSgndGx2LmVuY29kZTogbG9uZyBmb3JtIGxlbmd0aCB0b28gYmlnJyk7CgkgICAgICAgICAgICAvLyBsZW5ndGggb2YgbGVuZ3RoIHdpdGggbG9uZyBmb3JtIGZsYWcKCSAgICAgICAgICAgIGNvbnN0IGxlbkxlbiA9IGRhdGFMZW4gPiAxMjcgPyBudW1iZXJUb0hleFVucGFkZGVkKChsZW4ubGVuZ3RoIC8gMikgfCAxMjgpIDogJyc7CgkgICAgICAgICAgICBjb25zdCB0ID0gbnVtYmVyVG9IZXhVbnBhZGRlZCh0YWcpOwoJICAgICAgICAgICAgcmV0dXJuIHQgKyBsZW5MZW4gKyBsZW4gKyBkYXRhOwoJICAgICAgICB9LAoJICAgICAgICAvLyB2IC0gdmFsdWUsIGwgLSBsZWZ0IGJ5dGVzICh1bnBhcnNlZCkKCSAgICAgICAgZGVjb2RlKHRhZywgZGF0YSkgewoJICAgICAgICAgICAgY29uc3QgeyBFcnI6IEUgfSA9IERFUjsKCSAgICAgICAgICAgIGxldCBwb3MgPSAwOwoJICAgICAgICAgICAgaWYgKHRhZyA8IDAgfHwgdGFnID4gMjU2KQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFKCd0bHYuZW5jb2RlOiB3cm9uZyB0YWcnKTsKCSAgICAgICAgICAgIGlmIChkYXRhLmxlbmd0aCA8IDIgfHwgZGF0YVtwb3MrK10gIT09IHRhZykKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRSgndGx2LmRlY29kZTogd3JvbmcgdGx2Jyk7CgkgICAgICAgICAgICBjb25zdCBmaXJzdCA9IGRhdGFbcG9zKytdOwoJICAgICAgICAgICAgY29uc3QgaXNMb25nID0gISEoZmlyc3QgJiAxMjgpOyAvLyBGaXJzdCBiaXQgb2YgZmlyc3QgbGVuZ3RoIGJ5dGUgaXMgZmxhZyBmb3Igc2hvcnQvbG9uZyBmb3JtCgkgICAgICAgICAgICBsZXQgbGVuZ3RoID0gMDsKCSAgICAgICAgICAgIGlmICghaXNMb25nKQoJICAgICAgICAgICAgICAgIGxlbmd0aCA9IGZpcnN0OwoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gTG9uZyBmb3JtOiBbbG9uZ0ZsYWcoMWJpdCksIGxlbmd0aExlbmd0aCg3Yml0KSwgbGVuZ3RoIChCRSldCgkgICAgICAgICAgICAgICAgY29uc3QgbGVuTGVuID0gZmlyc3QgJiAxMjc7CgkgICAgICAgICAgICAgICAgaWYgKCFsZW5MZW4pCgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFKCd0bHYuZGVjb2RlKGxvbmcpOiBpbmRlZmluaXRlIGxlbmd0aCBub3Qgc3VwcG9ydGVkJyk7CgkgICAgICAgICAgICAgICAgaWYgKGxlbkxlbiA+IDQpCgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFKCd0bHYuZGVjb2RlKGxvbmcpOiBieXRlIGxlbmd0aCBpcyB0b28gYmlnJyk7IC8vIHRoaXMgd2lsbCBvdmVyZmxvdyB1MzIgaW4ganMKCSAgICAgICAgICAgICAgICBjb25zdCBsZW5ndGhCeXRlcyA9IGRhdGEuc3ViYXJyYXkocG9zLCBwb3MgKyBsZW5MZW4pOwoJICAgICAgICAgICAgICAgIGlmIChsZW5ndGhCeXRlcy5sZW5ndGggIT09IGxlbkxlbikKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEUoJ3Rsdi5kZWNvZGU6IGxlbmd0aCBieXRlcyBub3QgY29tcGxldGUnKTsKCSAgICAgICAgICAgICAgICBpZiAobGVuZ3RoQnl0ZXNbMF0gPT09IDApCgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFKCd0bHYuZGVjb2RlKGxvbmcpOiB6ZXJvIGxlZnRtb3N0IGJ5dGUnKTsKCSAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGIgb2YgbGVuZ3RoQnl0ZXMpCgkgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IChsZW5ndGggPDwgOCkgfCBiOwoJICAgICAgICAgICAgICAgIHBvcyArPSBsZW5MZW47CgkgICAgICAgICAgICAgICAgaWYgKGxlbmd0aCA8IDEyOCkKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEUoJ3Rsdi5kZWNvZGUobG9uZyk6IG5vdCBtaW5pbWFsIGVuY29kaW5nJyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBjb25zdCB2ID0gZGF0YS5zdWJhcnJheShwb3MsIHBvcyArIGxlbmd0aCk7CgkgICAgICAgICAgICBpZiAodi5sZW5ndGggIT09IGxlbmd0aCkKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRSgndGx2LmRlY29kZTogd3JvbmcgdmFsdWUgbGVuZ3RoJyk7CgkgICAgICAgICAgICByZXR1cm4geyB2LCBsOiBkYXRhLnN1YmFycmF5KHBvcyArIGxlbmd0aCkgfTsKCSAgICAgICAgfSwKCSAgICB9LAoJICAgIC8vIGh0dHBzOi8vY3J5cHRvLnN0YWNrZXhjaGFuZ2UuY29tL2EvNTc3MzQgTGVmdG1vc3QgYml0IG9mIGZpcnN0IGJ5dGUgaXMgJ25lZ2F0aXZlJyBmbGFnLAoJICAgIC8vIHNpbmNlIHdlIGFsd2F5cyB1c2UgcG9zaXRpdmUgaW50ZWdlcnMgaGVyZS4gSXQgbXVzdCBhbHdheXMgYmUgZW1wdHk6CgkgICAgLy8gLSBhZGQgemVybyBieXRlIGlmIGV4aXN0cwoJICAgIC8vIC0gaWYgbmV4dCBieXRlIGRvZXNuJ3QgaGF2ZSBhIGZsYWcsIGxlYWRpbmcgemVybyBpcyBub3QgYWxsb3dlZCAobWluaW1hbCBlbmNvZGluZykKCSAgICBfaW50OiB7CgkgICAgICAgIGVuY29kZShudW0pIHsKCSAgICAgICAgICAgIGNvbnN0IHsgRXJyOiBFIH0gPSBERVI7CgkgICAgICAgICAgICBpZiAobnVtIDwgXzBuKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFKCdpbnRlZ2VyOiBuZWdhdGl2ZSBpbnRlZ2VycyBhcmUgbm90IGFsbG93ZWQnKTsKCSAgICAgICAgICAgIGxldCBoZXggPSBudW1iZXJUb0hleFVucGFkZGVkKG51bSk7CgkgICAgICAgICAgICAvLyBQYWQgd2l0aCB6ZXJvIGJ5dGUgaWYgbmVnYXRpdmUgZmxhZyBpcyBwcmVzZW50CgkgICAgICAgICAgICBpZiAoTnVtYmVyLnBhcnNlSW50KGhleFswXSwgMTYpICYgMGIxMDAwKQoJICAgICAgICAgICAgICAgIGhleCA9ICcwMCcgKyBoZXg7CgkgICAgICAgICAgICBpZiAoaGV4Lmxlbmd0aCAmIDEpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEUoJ3VuZXhwZWN0ZWQgREVSIHBhcnNpbmcgYXNzZXJ0aW9uOiB1bnBhZGRlZCBoZXgnKTsKCSAgICAgICAgICAgIHJldHVybiBoZXg7CgkgICAgICAgIH0sCgkgICAgICAgIGRlY29kZShkYXRhKSB7CgkgICAgICAgICAgICBjb25zdCB7IEVycjogRSB9ID0gREVSOwoJICAgICAgICAgICAgaWYgKGRhdGFbMF0gJiAxMjgpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEUoJ2ludmFsaWQgc2lnbmF0dXJlIGludGVnZXI6IG5lZ2F0aXZlJyk7CgkgICAgICAgICAgICBpZiAoZGF0YVswXSA9PT0gMHgwMCAmJiAhKGRhdGFbMV0gJiAxMjgpKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFKCdpbnZhbGlkIHNpZ25hdHVyZSBpbnRlZ2VyOiB1bm5lY2Vzc2FyeSBsZWFkaW5nIHplcm8nKTsKCSAgICAgICAgICAgIHJldHVybiBiMm4oZGF0YSk7CgkgICAgICAgIH0sCgkgICAgfSwKCSAgICB0b1NpZyhoZXgpIHsKCSAgICAgICAgLy8gcGFyc2UgREVSIHNpZ25hdHVyZQoJICAgICAgICBjb25zdCB7IEVycjogRSwgX2ludDogaW50LCBfdGx2OiB0bHYgfSA9IERFUjsKCSAgICAgICAgY29uc3QgZGF0YSA9IHR5cGVvZiBoZXggPT09ICdzdHJpbmcnID8gaDJiKGhleCkgOiBoZXg7CgkgICAgICAgIGFieXRlcyQxKGRhdGEpOwoJICAgICAgICBjb25zdCB7IHY6IHNlcUJ5dGVzLCBsOiBzZXFMZWZ0Qnl0ZXMgfSA9IHRsdi5kZWNvZGUoMHgzMCwgZGF0YSk7CgkgICAgICAgIGlmIChzZXFMZWZ0Qnl0ZXMubGVuZ3RoKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEUoJ2ludmFsaWQgc2lnbmF0dXJlOiBsZWZ0IGJ5dGVzIGFmdGVyIHBhcnNpbmcnKTsKCSAgICAgICAgY29uc3QgeyB2OiByQnl0ZXMsIGw6IHJMZWZ0Qnl0ZXMgfSA9IHRsdi5kZWNvZGUoMHgwMiwgc2VxQnl0ZXMpOwoJICAgICAgICBjb25zdCB7IHY6IHNCeXRlcywgbDogc0xlZnRCeXRlcyB9ID0gdGx2LmRlY29kZSgweDAyLCByTGVmdEJ5dGVzKTsKCSAgICAgICAgaWYgKHNMZWZ0Qnl0ZXMubGVuZ3RoKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEUoJ2ludmFsaWQgc2lnbmF0dXJlOiBsZWZ0IGJ5dGVzIGFmdGVyIHBhcnNpbmcnKTsKCSAgICAgICAgcmV0dXJuIHsgcjogaW50LmRlY29kZShyQnl0ZXMpLCBzOiBpbnQuZGVjb2RlKHNCeXRlcykgfTsKCSAgICB9LAoJICAgIGhleEZyb21TaWcoc2lnKSB7CgkgICAgICAgIGNvbnN0IHsgX3RsdjogdGx2LCBfaW50OiBpbnQgfSA9IERFUjsKCSAgICAgICAgY29uc3QgcnMgPSB0bHYuZW5jb2RlKDB4MDIsIGludC5lbmNvZGUoc2lnLnIpKTsKCSAgICAgICAgY29uc3Qgc3MgPSB0bHYuZW5jb2RlKDB4MDIsIGludC5lbmNvZGUoc2lnLnMpKTsKCSAgICAgICAgY29uc3Qgc2VxID0gcnMgKyBzczsKCSAgICAgICAgcmV0dXJuIHRsdi5lbmNvZGUoMHgzMCwgc2VxKTsKCSAgICB9LAoJfTsKCS8vIEJlIGZyaWVuZGx5IHRvIGJhZCBFQ01BU2NyaXB0IHBhcnNlcnMgYnkgbm90IHVzaW5nIGJpZ2ludCBsaXRlcmFscwoJLy8gcHJldHRpZXItaWdub3JlCgljb25zdCBfMG4gPSBCaWdJbnQoMCksIF8xbiQxID0gQmlnSW50KDEpOyBCaWdJbnQoMik7IGNvbnN0IF8zbiA9IEJpZ0ludCgzKTsgQmlnSW50KDQpOwoJZnVuY3Rpb24gd2VpZXJzdHJhc3NQb2ludHMob3B0cykgewoJICAgIGNvbnN0IENVUlZFID0gdmFsaWRhdGVQb2ludE9wdHMob3B0cyk7CgkgICAgY29uc3QgeyBGcCB9ID0gQ1VSVkU7IC8vIEFsbCBjdXJ2ZXMgaGFzIHNhbWUgZmllbGQgLyBncm91cCBsZW5ndGggYXMgZm9yIG5vdywgYnV0IHRoZXkgY2FuIGRpZmZlcgoJICAgIGNvbnN0IEZuID0gRmllbGQoQ1VSVkUubiwgQ1VSVkUubkJpdExlbmd0aCk7CgkgICAgY29uc3QgdG9CeXRlcyA9IENVUlZFLnRvQnl0ZXMgfHwKCSAgICAgICAgKChfYywgcG9pbnQsIF9pc0NvbXByZXNzZWQpID0+IHsKCSAgICAgICAgICAgIGNvbnN0IGEgPSBwb2ludC50b0FmZmluZSgpOwoJICAgICAgICAgICAgcmV0dXJuIGNvbmNhdEJ5dGVzKFVpbnQ4QXJyYXkuZnJvbShbMHgwNF0pLCBGcC50b0J5dGVzKGEueCksIEZwLnRvQnl0ZXMoYS55KSk7CgkgICAgICAgIH0pOwoJICAgIGNvbnN0IGZyb21CeXRlcyA9IENVUlZFLmZyb21CeXRlcyB8fAoJICAgICAgICAoKGJ5dGVzKSA9PiB7CgkgICAgICAgICAgICAvLyBjb25zdCBoZWFkID0gYnl0ZXNbMF07CgkgICAgICAgICAgICBjb25zdCB0YWlsID0gYnl0ZXMuc3ViYXJyYXkoMSk7CgkgICAgICAgICAgICAvLyBpZiAoaGVhZCAhPT0gMHgwNCkgdGhyb3cgbmV3IEVycm9yKCdPbmx5IG5vbi1jb21wcmVzc2VkIGVuY29kaW5nIGlzIHN1cHBvcnRlZCcpOwoJICAgICAgICAgICAgY29uc3QgeCA9IEZwLmZyb21CeXRlcyh0YWlsLnN1YmFycmF5KDAsIEZwLkJZVEVTKSk7CgkgICAgICAgICAgICBjb25zdCB5ID0gRnAuZnJvbUJ5dGVzKHRhaWwuc3ViYXJyYXkoRnAuQllURVMsIDIgKiBGcC5CWVRFUykpOwoJICAgICAgICAgICAgcmV0dXJuIHsgeCwgeSB9OwoJICAgICAgICB9KTsKCSAgICAvKioKCSAgICAgKiB5wrIgPSB4wrMgKyBheCArIGI6IFNob3J0IHdlaWVyc3RyYXNzIGN1cnZlIGZvcm11bGEKCSAgICAgKiBAcmV0dXJucyB5wrIKCSAgICAgKi8KCSAgICBmdW5jdGlvbiB3ZWllcnN0cmFzc0VxdWF0aW9uKHgpIHsKCSAgICAgICAgY29uc3QgeyBhLCBiIH0gPSBDVVJWRTsKCSAgICAgICAgY29uc3QgeDIgPSBGcC5zcXIoeCk7IC8vIHggKiB4CgkgICAgICAgIGNvbnN0IHgzID0gRnAubXVsKHgyLCB4KTsgLy8geDIgKiB4CgkgICAgICAgIHJldHVybiBGcC5hZGQoRnAuYWRkKHgzLCBGcC5tdWwoeCwgYSkpLCBiKTsgLy8geDMgKyBhICogeCArIGIKCSAgICB9CgkgICAgLy8gVmFsaWRhdGUgd2hldGhlciB0aGUgcGFzc2VkIGN1cnZlIHBhcmFtcyBhcmUgdmFsaWQuCgkgICAgLy8gV2UgY2hlY2sgaWYgY3VydmUgZXF1YXRpb24gd29ya3MgZm9yIGdlbmVyYXRvciBwb2ludC4KCSAgICAvLyBgYXNzZXJ0VmFsaWRpdHkoKWAgd29uJ3Qgd29yazogYGlzVG9yc2lvbkZyZWUoKWAgaXMgbm90IGF2YWlsYWJsZSBhdCB0aGlzIHBvaW50IGluIGJsczEyLTM4MS4KCSAgICAvLyBQcm9qZWN0aXZlUG9pbnQgY2xhc3MgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIHlldC4KCSAgICBpZiAoIUZwLmVxbChGcC5zcXIoQ1VSVkUuR3kpLCB3ZWllcnN0cmFzc0VxdWF0aW9uKENVUlZFLkd4KSkpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcignYmFkIGdlbmVyYXRvciBwb2ludDogZXF1YXRpb24gbGVmdCAhPSByaWdodCcpOwoJICAgIC8vIFZhbGlkIGdyb3VwIGVsZW1lbnRzIHJlc2lkZSBpbiByYW5nZSAxLi5uLTEKCSAgICBmdW5jdGlvbiBpc1dpdGhpbkN1cnZlT3JkZXIobnVtKSB7CgkgICAgICAgIHJldHVybiBpblJhbmdlKG51bSwgXzFuJDEsIENVUlZFLm4pOwoJICAgIH0KCSAgICAvLyBWYWxpZGF0ZXMgaWYgcHJpdiBrZXkgaXMgdmFsaWQgYW5kIGNvbnZlcnRzIGl0IHRvIGJpZ2ludC4KCSAgICAvLyBTdXBwb3J0cyBvcHRpb25zIGFsbG93ZWRQcml2YXRlS2V5TGVuZ3RocyBhbmQgd3JhcFByaXZhdGVLZXkuCgkgICAgZnVuY3Rpb24gbm9ybVByaXZhdGVLZXlUb1NjYWxhcihrZXkpIHsKCSAgICAgICAgY29uc3QgeyBhbGxvd2VkUHJpdmF0ZUtleUxlbmd0aHM6IGxlbmd0aHMsIG5CeXRlTGVuZ3RoLCB3cmFwUHJpdmF0ZUtleSwgbjogTiB9ID0gQ1VSVkU7CgkgICAgICAgIGlmIChsZW5ndGhzICYmIHR5cGVvZiBrZXkgIT09ICdiaWdpbnQnKSB7CgkgICAgICAgICAgICBpZiAoaXNCeXRlcyQxKGtleSkpCgkgICAgICAgICAgICAgICAga2V5ID0gYnl0ZXNUb0hleChrZXkpOwoJICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRvIGhleCBzdHJpbmcsIHBhZC4gRS5nLiBQNTIxIHdvdWxkIG5vcm0gMTMwLTEzMiBjaGFyIGhleCB0byAxMzItY2hhciBieXRlcwoJICAgICAgICAgICAgaWYgKHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnIHx8ICFsZW5ndGhzLmluY2x1ZGVzKGtleS5sZW5ndGgpKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBwcml2YXRlIGtleScpOwoJICAgICAgICAgICAga2V5ID0ga2V5LnBhZFN0YXJ0KG5CeXRlTGVuZ3RoICogMiwgJzAnKTsKCSAgICAgICAgfQoJICAgICAgICBsZXQgbnVtOwoJICAgICAgICB0cnkgewoJICAgICAgICAgICAgbnVtID0KCSAgICAgICAgICAgICAgICB0eXBlb2Yga2V5ID09PSAnYmlnaW50JwoJICAgICAgICAgICAgICAgICAgICA/IGtleQoJICAgICAgICAgICAgICAgICAgICA6IGJ5dGVzVG9OdW1iZXJCRShlbnN1cmVCeXRlcygncHJpdmF0ZSBrZXknLCBrZXksIG5CeXRlTGVuZ3RoKSk7CgkgICAgICAgIH0KCSAgICAgICAgY2F0Y2ggKGVycm9yKSB7CgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgcHJpdmF0ZSBrZXksIGV4cGVjdGVkIGhleCBvciAnICsgbkJ5dGVMZW5ndGggKyAnIGJ5dGVzLCBnb3QgJyArIHR5cGVvZiBrZXkpOwoJICAgICAgICB9CgkgICAgICAgIGlmICh3cmFwUHJpdmF0ZUtleSkKCSAgICAgICAgICAgIG51bSA9IG1vZChudW0sIE4pOyAvLyBkaXNhYmxlZCBieSBkZWZhdWx0LCBlbmFibGVkIGZvciBCTFMKCSAgICAgICAgYUluUmFuZ2UoJ3ByaXZhdGUga2V5JywgbnVtLCBfMW4kMSwgTik7IC8vIG51bSBpbiByYW5nZSBbMS4uTi0xXQoJICAgICAgICByZXR1cm4gbnVtOwoJICAgIH0KCSAgICBmdW5jdGlvbiBhc3NlcnRQcmpQb2ludChvdGhlcikgewoJICAgICAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIFBvaW50KSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUHJvamVjdGl2ZVBvaW50IGV4cGVjdGVkJyk7CgkgICAgfQoJICAgIC8vIE1lbW9pemVkIHRvQWZmaW5lIC8gdmFsaWRpdHkgY2hlY2suIFRoZXkgYXJlIGhlYXZ5LiBQb2ludHMgYXJlIGltbXV0YWJsZS4KCSAgICAvLyBDb252ZXJ0cyBQcm9qZWN0aXZlIHBvaW50IHRvIGFmZmluZSAoeCwgeSkgY29vcmRpbmF0ZXMuCgkgICAgLy8gQ2FuIGFjY2VwdCBwcmVjb21wdXRlZCBaXi0xIC0gZm9yIGV4YW1wbGUsIGZyb20gaW52ZXJ0QmF0Y2guCgkgICAgLy8gKHgsIHksIHopIOKIiyAoeD14L3osIHk9eS96KQoJICAgIGNvbnN0IHRvQWZmaW5lTWVtbyA9IG1lbW9pemVkKChwLCBpeikgPT4gewoJICAgICAgICBjb25zdCB7IHB4OiB4LCBweTogeSwgcHo6IHogfSA9IHA7CgkgICAgICAgIC8vIEZhc3QtcGF0aCBmb3Igbm9ybWFsaXplZCBwb2ludHMKCSAgICAgICAgaWYgKEZwLmVxbCh6LCBGcC5PTkUpKQoJICAgICAgICAgICAgcmV0dXJuIHsgeCwgeSB9OwoJICAgICAgICBjb25zdCBpczAgPSBwLmlzMCgpOwoJICAgICAgICAvLyBJZiBpbnZaIHdhcyAwLCB3ZSByZXR1cm4gemVybyBwb2ludC4gSG93ZXZlciB3ZSBzdGlsbCB3YW50IHRvIGV4ZWN1dGUKCSAgICAgICAgLy8gYWxsIG9wZXJhdGlvbnMsIHNvIHdlIHJlcGxhY2UgaW52WiB3aXRoIGEgcmFuZG9tIG51bWJlciwgMS4KCSAgICAgICAgaWYgKGl6ID09IG51bGwpCgkgICAgICAgICAgICBpeiA9IGlzMCA/IEZwLk9ORSA6IEZwLmludih6KTsKCSAgICAgICAgY29uc3QgYXggPSBGcC5tdWwoeCwgaXopOwoJICAgICAgICBjb25zdCBheSA9IEZwLm11bCh5LCBpeik7CgkgICAgICAgIGNvbnN0IHp6ID0gRnAubXVsKHosIGl6KTsKCSAgICAgICAgaWYgKGlzMCkKCSAgICAgICAgICAgIHJldHVybiB7IHg6IEZwLlpFUk8sIHk6IEZwLlpFUk8gfTsKCSAgICAgICAgaWYgKCFGcC5lcWwoenosIEZwLk9ORSkpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludlogd2FzIGludmFsaWQnKTsKCSAgICAgICAgcmV0dXJuIHsgeDogYXgsIHk6IGF5IH07CgkgICAgfSk7CgkgICAgLy8gTk9URTogb24gZXhjZXB0aW9uIHRoaXMgd2lsbCBjcmFzaCAnY2FjaGVkJyBhbmQgbm8gdmFsdWUgd2lsbCBiZSBzZXQuCgkgICAgLy8gT3RoZXJ3aXNlIHRydWUgd2lsbCBiZSByZXR1cm4KCSAgICBjb25zdCBhc3NlcnRWYWxpZE1lbW8gPSBtZW1vaXplZCgocCkgPT4gewoJICAgICAgICBpZiAocC5pczAoKSkgewoJICAgICAgICAgICAgLy8gKDAsIDEsIDApIGFrYSBaRVJPIGlzIGludmFsaWQgaW4gbW9zdCBjb250ZXh0cy4KCSAgICAgICAgICAgIC8vIEluIEJMUywgWkVSTyBjYW4gYmUgc2VyaWFsaXplZCwgc28gd2UgYWxsb3cgaXQuCgkgICAgICAgICAgICAvLyAoMCwgMCwgMCkgaXMgaW52YWxpZCByZXByZXNlbnRhdGlvbiBvZiBaRVJPLgoJICAgICAgICAgICAgaWYgKENVUlZFLmFsbG93SW5maW5pdHlQb2ludCAmJiAhRnAuaXMwKHAucHkpKQoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYmFkIHBvaW50OiBaRVJPJyk7CgkgICAgICAgIH0KCSAgICAgICAgLy8gU29tZSAzcmQtcGFydHkgdGVzdCB2ZWN0b3JzIHJlcXVpcmUgZGlmZmVyZW50IHdvcmRpbmcgYmV0d2VlbiBoZXJlICYgYGZyb21Db21wcmVzc2VkSGV4YAoJICAgICAgICBjb25zdCB7IHgsIHkgfSA9IHAudG9BZmZpbmUoKTsKCSAgICAgICAgLy8gQ2hlY2sgaWYgeCwgeSBhcmUgdmFsaWQgZmllbGQgZWxlbWVudHMKCSAgICAgICAgaWYgKCFGcC5pc1ZhbGlkKHgpIHx8ICFGcC5pc1ZhbGlkKHkpKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdiYWQgcG9pbnQ6IHggb3IgeSBub3QgRkUnKTsKCSAgICAgICAgY29uc3QgbGVmdCA9IEZwLnNxcih5KTsgLy8gecKyCgkgICAgICAgIGNvbnN0IHJpZ2h0ID0gd2VpZXJzdHJhc3NFcXVhdGlvbih4KTsgLy8geMKzICsgYXggKyBiCgkgICAgICAgIGlmICghRnAuZXFsKGxlZnQsIHJpZ2h0KSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYmFkIHBvaW50OiBlcXVhdGlvbiBsZWZ0ICE9IHJpZ2h0Jyk7CgkgICAgICAgIGlmICghcC5pc1RvcnNpb25GcmVlKCkpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JhZCBwb2ludDogbm90IGluIHByaW1lLW9yZGVyIHN1Ymdyb3VwJyk7CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIH0pOwoJICAgIC8qKgoJICAgICAqIFByb2plY3RpdmUgUG9pbnQgd29ya3MgaW4gM2QgLyBwcm9qZWN0aXZlIChob21vZ2VuZW91cykgY29vcmRpbmF0ZXM6ICh4LCB5LCB6KSDiiIsgKHg9eC96LCB5PXkveikKCSAgICAgKiBEZWZhdWx0IFBvaW50IHdvcmtzIGluIDJkIC8gYWZmaW5lIGNvb3JkaW5hdGVzOiAoeCwgeSkKCSAgICAgKiBXZSdyZSBkb2luZyBjYWxjdWxhdGlvbnMgaW4gcHJvamVjdGl2ZSwgYmVjYXVzZSBpdHMgb3BlcmF0aW9ucyBkb24ndCByZXF1aXJlIGNvc3RseSBpbnZlcnNpb24uCgkgICAgICovCgkgICAgY2xhc3MgUG9pbnQgewoJICAgICAgICBjb25zdHJ1Y3RvcihweCwgcHksIHB6KSB7CgkgICAgICAgICAgICB0aGlzLnB4ID0gcHg7CgkgICAgICAgICAgICB0aGlzLnB5ID0gcHk7CgkgICAgICAgICAgICB0aGlzLnB6ID0gcHo7CgkgICAgICAgICAgICBpZiAocHggPT0gbnVsbCB8fCAhRnAuaXNWYWxpZChweCkpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd4IHJlcXVpcmVkJyk7CgkgICAgICAgICAgICBpZiAocHkgPT0gbnVsbCB8fCAhRnAuaXNWYWxpZChweSkpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd5IHJlcXVpcmVkJyk7CgkgICAgICAgICAgICBpZiAocHogPT0gbnVsbCB8fCAhRnAuaXNWYWxpZChweikpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd6IHJlcXVpcmVkJyk7CgkgICAgICAgICAgICBPYmplY3QuZnJlZXplKHRoaXMpOwoJICAgICAgICB9CgkgICAgICAgIC8vIERvZXMgbm90IHZhbGlkYXRlIGlmIHRoZSBwb2ludCBpcyBvbi1jdXJ2ZS4KCSAgICAgICAgLy8gVXNlIGZyb21IZXggaW5zdGVhZCwgb3IgY2FsbCBhc3NlcnRWYWxpZGl0eSgpIGxhdGVyLgoJICAgICAgICBzdGF0aWMgZnJvbUFmZmluZShwKSB7CgkgICAgICAgICAgICBjb25zdCB7IHgsIHkgfSA9IHAgfHwge307CgkgICAgICAgICAgICBpZiAoIXAgfHwgIUZwLmlzVmFsaWQoeCkgfHwgIUZwLmlzVmFsaWQoeSkpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGFmZmluZSBwb2ludCcpOwoJICAgICAgICAgICAgaWYgKHAgaW5zdGFuY2VvZiBQb2ludCkKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2plY3RpdmUgcG9pbnQgbm90IGFsbG93ZWQnKTsKCSAgICAgICAgICAgIGNvbnN0IGlzMCA9IChpKSA9PiBGcC5lcWwoaSwgRnAuWkVSTyk7CgkgICAgICAgICAgICAvLyBmcm9tQWZmaW5lKHg6MCwgeTowKSB3b3VsZCBwcm9kdWNlICh4OjAsIHk6MCwgejoxKSwgYnV0IHdlIG5lZWQgKHg6MCwgeToxLCB6OjApCgkgICAgICAgICAgICBpZiAoaXMwKHgpICYmIGlzMCh5KSkKCSAgICAgICAgICAgICAgICByZXR1cm4gUG9pbnQuWkVSTzsKCSAgICAgICAgICAgIHJldHVybiBuZXcgUG9pbnQoeCwgeSwgRnAuT05FKTsKCSAgICAgICAgfQoJICAgICAgICBnZXQgeCgpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLnRvQWZmaW5lKCkueDsKCSAgICAgICAgfQoJICAgICAgICBnZXQgeSgpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLnRvQWZmaW5lKCkueTsKCSAgICAgICAgfQoJICAgICAgICAvKioKCSAgICAgICAgICogVGFrZXMgYSBidW5jaCBvZiBQcm9qZWN0aXZlIFBvaW50cyBidXQgZXhlY3V0ZXMgb25seSBvbmUKCSAgICAgICAgICogaW52ZXJzaW9uIG9uIGFsbCBvZiB0aGVtLiBJbnZlcnNpb24gaXMgdmVyeSBzbG93IG9wZXJhdGlvbiwKCSAgICAgICAgICogc28gdGhpcyBpbXByb3ZlcyBwZXJmb3JtYW5jZSBtYXNzaXZlbHkuCgkgICAgICAgICAqIE9wdGltaXphdGlvbjogY29udmVydHMgYSBsaXN0IG9mIHByb2plY3RpdmUgcG9pbnRzIHRvIGEgbGlzdCBvZiBpZGVudGljYWwgcG9pbnRzIHdpdGggWj0xLgoJICAgICAgICAgKi8KCSAgICAgICAgc3RhdGljIG5vcm1hbGl6ZVoocG9pbnRzKSB7CgkgICAgICAgICAgICBjb25zdCB0b0ludiA9IEZwLmludmVydEJhdGNoKHBvaW50cy5tYXAoKHApID0+IHAucHopKTsKCSAgICAgICAgICAgIHJldHVybiBwb2ludHMubWFwKChwLCBpKSA9PiBwLnRvQWZmaW5lKHRvSW52W2ldKSkubWFwKFBvaW50LmZyb21BZmZpbmUpOwoJICAgICAgICB9CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDb252ZXJ0cyBoYXNoIHN0cmluZyBvciBVaW50OEFycmF5IHRvIFBvaW50LgoJICAgICAgICAgKiBAcGFyYW0gaGV4IHNob3J0L2xvbmcgRUNEU0EgaGV4CgkgICAgICAgICAqLwoJICAgICAgICBzdGF0aWMgZnJvbUhleChoZXgpIHsKCSAgICAgICAgICAgIGNvbnN0IFAgPSBQb2ludC5mcm9tQWZmaW5lKGZyb21CeXRlcyhlbnN1cmVCeXRlcygncG9pbnRIZXgnLCBoZXgpKSk7CgkgICAgICAgICAgICBQLmFzc2VydFZhbGlkaXR5KCk7CgkgICAgICAgICAgICByZXR1cm4gUDsKCSAgICAgICAgfQoJICAgICAgICAvLyBNdWx0aXBsaWVzIGdlbmVyYXRvciBwb2ludCBieSBwcml2YXRlS2V5LgoJICAgICAgICBzdGF0aWMgZnJvbVByaXZhdGVLZXkocHJpdmF0ZUtleSkgewoJICAgICAgICAgICAgcmV0dXJuIFBvaW50LkJBU0UubXVsdGlwbHkobm9ybVByaXZhdGVLZXlUb1NjYWxhcihwcml2YXRlS2V5KSk7CgkgICAgICAgIH0KCSAgICAgICAgLy8gTXVsdGlzY2FsYXIgTXVsdGlwbGljYXRpb24KCSAgICAgICAgc3RhdGljIG1zbShwb2ludHMsIHNjYWxhcnMpIHsKCSAgICAgICAgICAgIHJldHVybiBwaXBwZW5nZXIoUG9pbnQsIEZuLCBwb2ludHMsIHNjYWxhcnMpOwoJICAgICAgICB9CgkgICAgICAgIC8vICJQcml2YXRlIG1ldGhvZCIsIGRvbid0IHVzZSBpdCBkaXJlY3RseQoJICAgICAgICBfc2V0V2luZG93U2l6ZSh3aW5kb3dTaXplKSB7CgkgICAgICAgICAgICB3bmFmLnNldFdpbmRvd1NpemUodGhpcywgd2luZG93U2l6ZSk7CgkgICAgICAgIH0KCSAgICAgICAgLy8gQSBwb2ludCBvbiBjdXJ2ZSBpcyB2YWxpZCBpZiBpdCBjb25mb3JtcyB0byBlcXVhdGlvbi4KCSAgICAgICAgYXNzZXJ0VmFsaWRpdHkoKSB7CgkgICAgICAgICAgICBhc3NlcnRWYWxpZE1lbW8odGhpcyk7CgkgICAgICAgIH0KCSAgICAgICAgaGFzRXZlblkoKSB7CgkgICAgICAgICAgICBjb25zdCB7IHkgfSA9IHRoaXMudG9BZmZpbmUoKTsKCSAgICAgICAgICAgIGlmIChGcC5pc09kZCkKCSAgICAgICAgICAgICAgICByZXR1cm4gIUZwLmlzT2RkKHkpOwoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGaWVsZCBkb2Vzbid0IHN1cHBvcnQgaXNPZGQiKTsKCSAgICAgICAgfQoJICAgICAgICAvKioKCSAgICAgICAgICogQ29tcGFyZSBvbmUgcG9pbnQgdG8gYW5vdGhlci4KCSAgICAgICAgICovCgkgICAgICAgIGVxdWFscyhvdGhlcikgewoJICAgICAgICAgICAgYXNzZXJ0UHJqUG9pbnQob3RoZXIpOwoJICAgICAgICAgICAgY29uc3QgeyBweDogWDEsIHB5OiBZMSwgcHo6IFoxIH0gPSB0aGlzOwoJICAgICAgICAgICAgY29uc3QgeyBweDogWDIsIHB5OiBZMiwgcHo6IFoyIH0gPSBvdGhlcjsKCSAgICAgICAgICAgIGNvbnN0IFUxID0gRnAuZXFsKEZwLm11bChYMSwgWjIpLCBGcC5tdWwoWDIsIFoxKSk7CgkgICAgICAgICAgICBjb25zdCBVMiA9IEZwLmVxbChGcC5tdWwoWTEsIFoyKSwgRnAubXVsKFkyLCBaMSkpOwoJICAgICAgICAgICAgcmV0dXJuIFUxICYmIFUyOwoJICAgICAgICB9CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBGbGlwcyBwb2ludCB0byBvbmUgY29ycmVzcG9uZGluZyB0byAoeCwgLXkpIGluIEFmZmluZSBjb29yZGluYXRlcy4KCSAgICAgICAgICovCgkgICAgICAgIG5lZ2F0ZSgpIHsKCSAgICAgICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy5weCwgRnAubmVnKHRoaXMucHkpLCB0aGlzLnB6KTsKCSAgICAgICAgfQoJICAgICAgICAvLyBSZW5lcy1Db3N0ZWxsby1CYXRpbmEgZXhjZXB0aW9uLWZyZWUgZG91YmxpbmcgZm9ybXVsYS4KCSAgICAgICAgLy8gVGhlcmUgaXMgMzAlIGZhc3RlciBKYWNvYmlhbiBmb3JtdWxhLCBidXQgaXQgaXMgbm90IGNvbXBsZXRlLgoJICAgICAgICAvLyBodHRwczovL2VwcmludC5pYWNyLm9yZy8yMDE1LzEwNjAsIGFsZ29yaXRobSAzCgkgICAgICAgIC8vIENvc3Q6IDhNICsgM1MgKyAzKmEgKyAyKmIzICsgMTVhZGQuCgkgICAgICAgIGRvdWJsZSgpIHsKCSAgICAgICAgICAgIGNvbnN0IHsgYSwgYiB9ID0gQ1VSVkU7CgkgICAgICAgICAgICBjb25zdCBiMyA9IEZwLm11bChiLCBfM24pOwoJICAgICAgICAgICAgY29uc3QgeyBweDogWDEsIHB5OiBZMSwgcHo6IFoxIH0gPSB0aGlzOwoJICAgICAgICAgICAgbGV0IFgzID0gRnAuWkVSTywgWTMgPSBGcC5aRVJPLCBaMyA9IEZwLlpFUk87IC8vIHByZXR0aWVyLWlnbm9yZQoJICAgICAgICAgICAgbGV0IHQwID0gRnAubXVsKFgxLCBYMSk7IC8vIHN0ZXAgMQoJICAgICAgICAgICAgbGV0IHQxID0gRnAubXVsKFkxLCBZMSk7CgkgICAgICAgICAgICBsZXQgdDIgPSBGcC5tdWwoWjEsIFoxKTsKCSAgICAgICAgICAgIGxldCB0MyA9IEZwLm11bChYMSwgWTEpOwoJICAgICAgICAgICAgdDMgPSBGcC5hZGQodDMsIHQzKTsgLy8gc3RlcCA1CgkgICAgICAgICAgICBaMyA9IEZwLm11bChYMSwgWjEpOwoJICAgICAgICAgICAgWjMgPSBGcC5hZGQoWjMsIFozKTsKCSAgICAgICAgICAgIFgzID0gRnAubXVsKGEsIFozKTsKCSAgICAgICAgICAgIFkzID0gRnAubXVsKGIzLCB0Mik7CgkgICAgICAgICAgICBZMyA9IEZwLmFkZChYMywgWTMpOyAvLyBzdGVwIDEwCgkgICAgICAgICAgICBYMyA9IEZwLnN1Yih0MSwgWTMpOwoJICAgICAgICAgICAgWTMgPSBGcC5hZGQodDEsIFkzKTsKCSAgICAgICAgICAgIFkzID0gRnAubXVsKFgzLCBZMyk7CgkgICAgICAgICAgICBYMyA9IEZwLm11bCh0MywgWDMpOwoJICAgICAgICAgICAgWjMgPSBGcC5tdWwoYjMsIFozKTsgLy8gc3RlcCAxNQoJICAgICAgICAgICAgdDIgPSBGcC5tdWwoYSwgdDIpOwoJICAgICAgICAgICAgdDMgPSBGcC5zdWIodDAsIHQyKTsKCSAgICAgICAgICAgIHQzID0gRnAubXVsKGEsIHQzKTsKCSAgICAgICAgICAgIHQzID0gRnAuYWRkKHQzLCBaMyk7CgkgICAgICAgICAgICBaMyA9IEZwLmFkZCh0MCwgdDApOyAvLyBzdGVwIDIwCgkgICAgICAgICAgICB0MCA9IEZwLmFkZChaMywgdDApOwoJICAgICAgICAgICAgdDAgPSBGcC5hZGQodDAsIHQyKTsKCSAgICAgICAgICAgIHQwID0gRnAubXVsKHQwLCB0Myk7CgkgICAgICAgICAgICBZMyA9IEZwLmFkZChZMywgdDApOwoJICAgICAgICAgICAgdDIgPSBGcC5tdWwoWTEsIFoxKTsgLy8gc3RlcCAyNQoJICAgICAgICAgICAgdDIgPSBGcC5hZGQodDIsIHQyKTsKCSAgICAgICAgICAgIHQwID0gRnAubXVsKHQyLCB0Myk7CgkgICAgICAgICAgICBYMyA9IEZwLnN1YihYMywgdDApOwoJICAgICAgICAgICAgWjMgPSBGcC5tdWwodDIsIHQxKTsKCSAgICAgICAgICAgIFozID0gRnAuYWRkKFozLCBaMyk7IC8vIHN0ZXAgMzAKCSAgICAgICAgICAgIFozID0gRnAuYWRkKFozLCBaMyk7CgkgICAgICAgICAgICByZXR1cm4gbmV3IFBvaW50KFgzLCBZMywgWjMpOwoJICAgICAgICB9CgkgICAgICAgIC8vIFJlbmVzLUNvc3RlbGxvLUJhdGluYSBleGNlcHRpb24tZnJlZSBhZGRpdGlvbiBmb3JtdWxhLgoJICAgICAgICAvLyBUaGVyZSBpcyAzMCUgZmFzdGVyIEphY29iaWFuIGZvcm11bGEsIGJ1dCBpdCBpcyBub3QgY29tcGxldGUuCgkgICAgICAgIC8vIGh0dHBzOi8vZXByaW50LmlhY3Iub3JnLzIwMTUvMTA2MCwgYWxnb3JpdGhtIDEKCSAgICAgICAgLy8gQ29zdDogMTJNICsgMFMgKyAzKmEgKyAzKmIzICsgMjNhZGQuCgkgICAgICAgIGFkZChvdGhlcikgewoJICAgICAgICAgICAgYXNzZXJ0UHJqUG9pbnQob3RoZXIpOwoJICAgICAgICAgICAgY29uc3QgeyBweDogWDEsIHB5OiBZMSwgcHo6IFoxIH0gPSB0aGlzOwoJICAgICAgICAgICAgY29uc3QgeyBweDogWDIsIHB5OiBZMiwgcHo6IFoyIH0gPSBvdGhlcjsKCSAgICAgICAgICAgIGxldCBYMyA9IEZwLlpFUk8sIFkzID0gRnAuWkVSTywgWjMgPSBGcC5aRVJPOyAvLyBwcmV0dGllci1pZ25vcmUKCSAgICAgICAgICAgIGNvbnN0IGEgPSBDVVJWRS5hOwoJICAgICAgICAgICAgY29uc3QgYjMgPSBGcC5tdWwoQ1VSVkUuYiwgXzNuKTsKCSAgICAgICAgICAgIGxldCB0MCA9IEZwLm11bChYMSwgWDIpOyAvLyBzdGVwIDEKCSAgICAgICAgICAgIGxldCB0MSA9IEZwLm11bChZMSwgWTIpOwoJICAgICAgICAgICAgbGV0IHQyID0gRnAubXVsKFoxLCBaMik7CgkgICAgICAgICAgICBsZXQgdDMgPSBGcC5hZGQoWDEsIFkxKTsKCSAgICAgICAgICAgIGxldCB0NCA9IEZwLmFkZChYMiwgWTIpOyAvLyBzdGVwIDUKCSAgICAgICAgICAgIHQzID0gRnAubXVsKHQzLCB0NCk7CgkgICAgICAgICAgICB0NCA9IEZwLmFkZCh0MCwgdDEpOwoJICAgICAgICAgICAgdDMgPSBGcC5zdWIodDMsIHQ0KTsKCSAgICAgICAgICAgIHQ0ID0gRnAuYWRkKFgxLCBaMSk7CgkgICAgICAgICAgICBsZXQgdDUgPSBGcC5hZGQoWDIsIFoyKTsgLy8gc3RlcCAxMAoJICAgICAgICAgICAgdDQgPSBGcC5tdWwodDQsIHQ1KTsKCSAgICAgICAgICAgIHQ1ID0gRnAuYWRkKHQwLCB0Mik7CgkgICAgICAgICAgICB0NCA9IEZwLnN1Yih0NCwgdDUpOwoJICAgICAgICAgICAgdDUgPSBGcC5hZGQoWTEsIFoxKTsKCSAgICAgICAgICAgIFgzID0gRnAuYWRkKFkyLCBaMik7IC8vIHN0ZXAgMTUKCSAgICAgICAgICAgIHQ1ID0gRnAubXVsKHQ1LCBYMyk7CgkgICAgICAgICAgICBYMyA9IEZwLmFkZCh0MSwgdDIpOwoJICAgICAgICAgICAgdDUgPSBGcC5zdWIodDUsIFgzKTsKCSAgICAgICAgICAgIFozID0gRnAubXVsKGEsIHQ0KTsKCSAgICAgICAgICAgIFgzID0gRnAubXVsKGIzLCB0Mik7IC8vIHN0ZXAgMjAKCSAgICAgICAgICAgIFozID0gRnAuYWRkKFgzLCBaMyk7CgkgICAgICAgICAgICBYMyA9IEZwLnN1Yih0MSwgWjMpOwoJICAgICAgICAgICAgWjMgPSBGcC5hZGQodDEsIFozKTsKCSAgICAgICAgICAgIFkzID0gRnAubXVsKFgzLCBaMyk7CgkgICAgICAgICAgICB0MSA9IEZwLmFkZCh0MCwgdDApOyAvLyBzdGVwIDI1CgkgICAgICAgICAgICB0MSA9IEZwLmFkZCh0MSwgdDApOwoJICAgICAgICAgICAgdDIgPSBGcC5tdWwoYSwgdDIpOwoJICAgICAgICAgICAgdDQgPSBGcC5tdWwoYjMsIHQ0KTsKCSAgICAgICAgICAgIHQxID0gRnAuYWRkKHQxLCB0Mik7CgkgICAgICAgICAgICB0MiA9IEZwLnN1Yih0MCwgdDIpOyAvLyBzdGVwIDMwCgkgICAgICAgICAgICB0MiA9IEZwLm11bChhLCB0Mik7CgkgICAgICAgICAgICB0NCA9IEZwLmFkZCh0NCwgdDIpOwoJICAgICAgICAgICAgdDAgPSBGcC5tdWwodDEsIHQ0KTsKCSAgICAgICAgICAgIFkzID0gRnAuYWRkKFkzLCB0MCk7CgkgICAgICAgICAgICB0MCA9IEZwLm11bCh0NSwgdDQpOyAvLyBzdGVwIDM1CgkgICAgICAgICAgICBYMyA9IEZwLm11bCh0MywgWDMpOwoJICAgICAgICAgICAgWDMgPSBGcC5zdWIoWDMsIHQwKTsKCSAgICAgICAgICAgIHQwID0gRnAubXVsKHQzLCB0MSk7CgkgICAgICAgICAgICBaMyA9IEZwLm11bCh0NSwgWjMpOwoJICAgICAgICAgICAgWjMgPSBGcC5hZGQoWjMsIHQwKTsgLy8gc3RlcCA0MAoJICAgICAgICAgICAgcmV0dXJuIG5ldyBQb2ludChYMywgWTMsIFozKTsKCSAgICAgICAgfQoJICAgICAgICBzdWJ0cmFjdChvdGhlcikgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkKG90aGVyLm5lZ2F0ZSgpKTsKCSAgICAgICAgfQoJICAgICAgICBpczAoKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5lcXVhbHMoUG9pbnQuWkVSTyk7CgkgICAgICAgIH0KCSAgICAgICAgd05BRihuKSB7CgkgICAgICAgICAgICByZXR1cm4gd25hZi53TkFGQ2FjaGVkKHRoaXMsIG4sIFBvaW50Lm5vcm1hbGl6ZVopOwoJICAgICAgICB9CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBOb24tY29uc3RhbnQtdGltZSBtdWx0aXBsaWNhdGlvbi4gVXNlcyBkb3VibGUtYW5kLWFkZCBhbGdvcml0aG0uCgkgICAgICAgICAqIEl0J3MgZmFzdGVyLCBidXQgc2hvdWxkIG9ubHkgYmUgdXNlZCB3aGVuIHlvdSBkb24ndCBjYXJlIGFib3V0CgkgICAgICAgICAqIGFuIGV4cG9zZWQgcHJpdmF0ZSBrZXkgZS5nLiBzaWcgdmVyaWZpY2F0aW9uLCB3aGljaCB3b3JrcyBvdmVyICpwdWJsaWMqIGtleXMuCgkgICAgICAgICAqLwoJICAgICAgICBtdWx0aXBseVVuc2FmZShzYykgewoJICAgICAgICAgICAgY29uc3QgeyBlbmRvLCBuOiBOIH0gPSBDVVJWRTsKCSAgICAgICAgICAgIGFJblJhbmdlKCdzY2FsYXInLCBzYywgXzBuLCBOKTsKCSAgICAgICAgICAgIGNvbnN0IEkgPSBQb2ludC5aRVJPOwoJICAgICAgICAgICAgaWYgKHNjID09PSBfMG4pCgkgICAgICAgICAgICAgICAgcmV0dXJuIEk7CgkgICAgICAgICAgICBpZiAodGhpcy5pczAoKSB8fCBzYyA9PT0gXzFuJDEpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CgkgICAgICAgICAgICAvLyBDYXNlIGE6IG5vIGVuZG9tb3JwaGlzbS4gQ2FzZSBiOiBoYXMgcHJlY29tcHV0ZXMuCgkgICAgICAgICAgICBpZiAoIWVuZG8gfHwgd25hZi5oYXNQcmVjb21wdXRlcyh0aGlzKSkKCSAgICAgICAgICAgICAgICByZXR1cm4gd25hZi53TkFGQ2FjaGVkVW5zYWZlKHRoaXMsIHNjLCBQb2ludC5ub3JtYWxpemVaKTsKCSAgICAgICAgICAgIC8vIENhc2UgYzogZW5kb21vcnBoaXNtCgkgICAgICAgICAgICBsZXQgeyBrMW5lZywgazEsIGsybmVnLCBrMiB9ID0gZW5kby5zcGxpdFNjYWxhcihzYyk7CgkgICAgICAgICAgICBsZXQgazFwID0gSTsKCSAgICAgICAgICAgIGxldCBrMnAgPSBJOwoJICAgICAgICAgICAgbGV0IGQgPSB0aGlzOwoJICAgICAgICAgICAgd2hpbGUgKGsxID4gXzBuIHx8IGsyID4gXzBuKSB7CgkgICAgICAgICAgICAgICAgaWYgKGsxICYgXzFuJDEpCgkgICAgICAgICAgICAgICAgICAgIGsxcCA9IGsxcC5hZGQoZCk7CgkgICAgICAgICAgICAgICAgaWYgKGsyICYgXzFuJDEpCgkgICAgICAgICAgICAgICAgICAgIGsycCA9IGsycC5hZGQoZCk7CgkgICAgICAgICAgICAgICAgZCA9IGQuZG91YmxlKCk7CgkgICAgICAgICAgICAgICAgazEgPj49IF8xbiQxOwoJICAgICAgICAgICAgICAgIGsyID4+PSBfMW4kMTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChrMW5lZykKCSAgICAgICAgICAgICAgICBrMXAgPSBrMXAubmVnYXRlKCk7CgkgICAgICAgICAgICBpZiAoazJuZWcpCgkgICAgICAgICAgICAgICAgazJwID0gazJwLm5lZ2F0ZSgpOwoJICAgICAgICAgICAgazJwID0gbmV3IFBvaW50KEZwLm11bChrMnAucHgsIGVuZG8uYmV0YSksIGsycC5weSwgazJwLnB6KTsKCSAgICAgICAgICAgIHJldHVybiBrMXAuYWRkKGsycCk7CgkgICAgICAgIH0KCSAgICAgICAgLyoqCgkgICAgICAgICAqIENvbnN0YW50IHRpbWUgbXVsdGlwbGljYXRpb24uCgkgICAgICAgICAqIFVzZXMgd05BRiBtZXRob2QuIFdpbmRvd2VkIG1ldGhvZCBtYXkgYmUgMTAlIGZhc3RlciwKCSAgICAgICAgICogYnV0IHRha2VzIDJ4IGxvbmdlciB0byBnZW5lcmF0ZSBhbmQgY29uc3VtZXMgMnggbWVtb3J5LgoJICAgICAgICAgKiBVc2VzIHByZWNvbXB1dGVzIHdoZW4gYXZhaWxhYmxlLgoJICAgICAgICAgKiBVc2VzIGVuZG9tb3JwaGlzbSBmb3IgS29ibGl0eiBjdXJ2ZXMuCgkgICAgICAgICAqIEBwYXJhbSBzY2FsYXIgYnkgd2hpY2ggdGhlIHBvaW50IHdvdWxkIGJlIG11bHRpcGxpZWQKCSAgICAgICAgICogQHJldHVybnMgTmV3IHBvaW50CgkgICAgICAgICAqLwoJICAgICAgICBtdWx0aXBseShzY2FsYXIpIHsKCSAgICAgICAgICAgIGNvbnN0IHsgZW5kbywgbjogTiB9ID0gQ1VSVkU7CgkgICAgICAgICAgICBhSW5SYW5nZSgnc2NhbGFyJywgc2NhbGFyLCBfMW4kMSwgTik7CgkgICAgICAgICAgICBsZXQgcG9pbnQsIGZha2U7IC8vIEZha2UgcG9pbnQgaXMgdXNlZCB0byBjb25zdC10aW1lIG11bHQKCSAgICAgICAgICAgIGlmIChlbmRvKSB7CgkgICAgICAgICAgICAgICAgY29uc3QgeyBrMW5lZywgazEsIGsybmVnLCBrMiB9ID0gZW5kby5zcGxpdFNjYWxhcihzY2FsYXIpOwoJICAgICAgICAgICAgICAgIGxldCB7IHA6IGsxcCwgZjogZjFwIH0gPSB0aGlzLndOQUYoazEpOwoJICAgICAgICAgICAgICAgIGxldCB7IHA6IGsycCwgZjogZjJwIH0gPSB0aGlzLndOQUYoazIpOwoJICAgICAgICAgICAgICAgIGsxcCA9IHduYWYuY29uc3RUaW1lTmVnYXRlKGsxbmVnLCBrMXApOwoJICAgICAgICAgICAgICAgIGsycCA9IHduYWYuY29uc3RUaW1lTmVnYXRlKGsybmVnLCBrMnApOwoJICAgICAgICAgICAgICAgIGsycCA9IG5ldyBQb2ludChGcC5tdWwoazJwLnB4LCBlbmRvLmJldGEpLCBrMnAucHksIGsycC5weik7CgkgICAgICAgICAgICAgICAgcG9pbnQgPSBrMXAuYWRkKGsycCk7CgkgICAgICAgICAgICAgICAgZmFrZSA9IGYxcC5hZGQoZjJwKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgIGNvbnN0IHsgcCwgZiB9ID0gdGhpcy53TkFGKHNjYWxhcik7CgkgICAgICAgICAgICAgICAgcG9pbnQgPSBwOwoJICAgICAgICAgICAgICAgIGZha2UgPSBmOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLy8gTm9ybWFsaXplIGB6YCBmb3IgYm90aCBwb2ludHMsIGJ1dCByZXR1cm4gb25seSByZWFsIG9uZQoJICAgICAgICAgICAgcmV0dXJuIFBvaW50Lm5vcm1hbGl6ZVooW3BvaW50LCBmYWtlXSlbMF07CgkgICAgICAgIH0KCSAgICAgICAgLyoqCgkgICAgICAgICAqIEVmZmljaWVudGx5IGNhbGN1bGF0ZSBgYVAgKyBiUWAuIFVuc2FmZSwgY2FuIGV4cG9zZSBwcml2YXRlIGtleSwgaWYgdXNlZCBpbmNvcnJlY3RseS4KCSAgICAgICAgICogTm90IHVzaW5nIFN0cmF1c3MtU2hhbWlyIHRyaWNrOiBwcmVjb21wdXRhdGlvbiB0YWJsZXMgYXJlIGZhc3Rlci4KCSAgICAgICAgICogVGhlIHRyaWNrIGNvdWxkIGJlIHVzZWZ1bCBpZiBib3RoIFAgYW5kIFEgYXJlIG5vdCBHIChub3QgaW4gb3VyIGNhc2UpLgoJICAgICAgICAgKiBAcmV0dXJucyBub24temVybyBhZmZpbmUgcG9pbnQKCSAgICAgICAgICovCgkgICAgICAgIG11bHRpcGx5QW5kQWRkVW5zYWZlKFEsIGEsIGIpIHsKCSAgICAgICAgICAgIGNvbnN0IEcgPSBQb2ludC5CQVNFOyAvLyBObyBTdHJhdXNzLVNoYW1pciB0cmljazogd2UgaGF2ZSAxMCUgZmFzdGVyIEcgcHJlY29tcHV0ZXMKCSAgICAgICAgICAgIGNvbnN0IG11bCA9IChQLCBhIC8vIFNlbGVjdCBmYXN0ZXIgbXVsdGlwbHkoKSBtZXRob2QKCSAgICAgICAgICAgICkgPT4gKGEgPT09IF8wbiB8fCBhID09PSBfMW4kMSB8fCAhUC5lcXVhbHMoRykgPyBQLm11bHRpcGx5VW5zYWZlKGEpIDogUC5tdWx0aXBseShhKSk7CgkgICAgICAgICAgICBjb25zdCBzdW0gPSBtdWwodGhpcywgYSkuYWRkKG11bChRLCBiKSk7CgkgICAgICAgICAgICByZXR1cm4gc3VtLmlzMCgpID8gdW5kZWZpbmVkIDogc3VtOwoJICAgICAgICB9CgkgICAgICAgIC8vIENvbnZlcnRzIFByb2plY3RpdmUgcG9pbnQgdG8gYWZmaW5lICh4LCB5KSBjb29yZGluYXRlcy4KCSAgICAgICAgLy8gQ2FuIGFjY2VwdCBwcmVjb21wdXRlZCBaXi0xIC0gZm9yIGV4YW1wbGUsIGZyb20gaW52ZXJ0QmF0Y2guCgkgICAgICAgIC8vICh4LCB5LCB6KSDiiIsgKHg9eC96LCB5PXkveikKCSAgICAgICAgdG9BZmZpbmUoaXopIHsKCSAgICAgICAgICAgIHJldHVybiB0b0FmZmluZU1lbW8odGhpcywgaXopOwoJICAgICAgICB9CgkgICAgICAgIGlzVG9yc2lvbkZyZWUoKSB7CgkgICAgICAgICAgICBjb25zdCB7IGg6IGNvZmFjdG9yLCBpc1RvcnNpb25GcmVlIH0gPSBDVVJWRTsKCSAgICAgICAgICAgIGlmIChjb2ZhY3RvciA9PT0gXzFuJDEpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIE5vIHN1Ymdyb3VwcywgYWx3YXlzIHRvcnNpb24tZnJlZQoJICAgICAgICAgICAgaWYgKGlzVG9yc2lvbkZyZWUpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGlzVG9yc2lvbkZyZWUoUG9pbnQsIHRoaXMpOwoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpc1RvcnNpb25GcmVlKCkgaGFzIG5vdCBiZWVuIGRlY2xhcmVkIGZvciB0aGUgZWxsaXB0aWMgY3VydmUnKTsKCSAgICAgICAgfQoJICAgICAgICBjbGVhckNvZmFjdG9yKCkgewoJICAgICAgICAgICAgY29uc3QgeyBoOiBjb2ZhY3RvciwgY2xlYXJDb2ZhY3RvciB9ID0gQ1VSVkU7CgkgICAgICAgICAgICBpZiAoY29mYWN0b3IgPT09IF8xbiQxKQoJICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOyAvLyBGYXN0LXBhdGgKCSAgICAgICAgICAgIGlmIChjbGVhckNvZmFjdG9yKQoJICAgICAgICAgICAgICAgIHJldHVybiBjbGVhckNvZmFjdG9yKFBvaW50LCB0aGlzKTsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLm11bHRpcGx5VW5zYWZlKENVUlZFLmgpOwoJICAgICAgICB9CgkgICAgICAgIHRvUmF3Qnl0ZXMoaXNDb21wcmVzc2VkID0gdHJ1ZSkgewoJICAgICAgICAgICAgYWJvb2woJ2lzQ29tcHJlc3NlZCcsIGlzQ29tcHJlc3NlZCk7CgkgICAgICAgICAgICB0aGlzLmFzc2VydFZhbGlkaXR5KCk7CgkgICAgICAgICAgICByZXR1cm4gdG9CeXRlcyhQb2ludCwgdGhpcywgaXNDb21wcmVzc2VkKTsKCSAgICAgICAgfQoJICAgICAgICB0b0hleChpc0NvbXByZXNzZWQgPSB0cnVlKSB7CgkgICAgICAgICAgICBhYm9vbCgnaXNDb21wcmVzc2VkJywgaXNDb21wcmVzc2VkKTsKCSAgICAgICAgICAgIHJldHVybiBieXRlc1RvSGV4KHRoaXMudG9SYXdCeXRlcyhpc0NvbXByZXNzZWQpKTsKCSAgICAgICAgfQoJICAgIH0KCSAgICBQb2ludC5CQVNFID0gbmV3IFBvaW50KENVUlZFLkd4LCBDVVJWRS5HeSwgRnAuT05FKTsKCSAgICBQb2ludC5aRVJPID0gbmV3IFBvaW50KEZwLlpFUk8sIEZwLk9ORSwgRnAuWkVSTyk7CgkgICAgY29uc3QgX2JpdHMgPSBDVVJWRS5uQml0TGVuZ3RoOwoJICAgIGNvbnN0IHduYWYgPSB3TkFGKFBvaW50LCBDVVJWRS5lbmRvID8gTWF0aC5jZWlsKF9iaXRzIC8gMikgOiBfYml0cyk7CgkgICAgLy8gVmFsaWRhdGUgaWYgZ2VuZXJhdG9yIHBvaW50IGlzIG9uIGN1cnZlCgkgICAgcmV0dXJuIHsKCSAgICAgICAgQ1VSVkUsCgkgICAgICAgIFByb2plY3RpdmVQb2ludDogUG9pbnQsCgkgICAgICAgIG5vcm1Qcml2YXRlS2V5VG9TY2FsYXIsCgkgICAgICAgIHdlaWVyc3RyYXNzRXF1YXRpb24sCgkgICAgICAgIGlzV2l0aGluQ3VydmVPcmRlciwKCSAgICB9OwoJfQoJZnVuY3Rpb24gdmFsaWRhdGVPcHRzKGN1cnZlKSB7CgkgICAgY29uc3Qgb3B0cyA9IHZhbGlkYXRlQmFzaWMoY3VydmUpOwoJICAgIHZhbGlkYXRlT2JqZWN0KG9wdHMsIHsKCSAgICAgICAgaGFzaDogJ2hhc2gnLAoJICAgICAgICBobWFjOiAnZnVuY3Rpb24nLAoJICAgICAgICByYW5kb21CeXRlczogJ2Z1bmN0aW9uJywKCSAgICB9LCB7CgkgICAgICAgIGJpdHMyaW50OiAnZnVuY3Rpb24nLAoJICAgICAgICBiaXRzMmludF9tb2ROOiAnZnVuY3Rpb24nLAoJICAgICAgICBsb3dTOiAnYm9vbGVhbicsCgkgICAgfSk7CgkgICAgcmV0dXJuIE9iamVjdC5mcmVlemUoeyBsb3dTOiB0cnVlLCAuLi5vcHRzIH0pOwoJfQoJLyoqCgkgKiBDcmVhdGVzIHNob3J0IHdlaWVyc3RyYXNzIGN1cnZlIGFuZCBFQ0RTQSBzaWduYXR1cmUgbWV0aG9kcyBmb3IgaXQuCgkgKiBAZXhhbXBsZQoJICogaW1wb3J0IHsgRmllbGQgfSBmcm9tICdAbm9ibGUvY3VydmVzL2Fic3RyYWN0L21vZHVsYXInOwoJICogLy8gQmVmb3JlIHRoYXQsIGRlZmluZSBCaWdJbnQtczogYSwgYiwgcCwgbiwgR3gsIEd5CgkgKiBjb25zdCBjdXJ2ZSA9IHdlaWVyc3RyYXNzKHsgYSwgYiwgRnA6IEZpZWxkKHApLCBuLCBHeCwgR3ksIGg6IDFuIH0pCgkgKi8KCWZ1bmN0aW9uIHdlaWVyc3RyYXNzKGN1cnZlRGVmKSB7CgkgICAgY29uc3QgQ1VSVkUgPSB2YWxpZGF0ZU9wdHMoY3VydmVEZWYpOwoJICAgIGNvbnN0IHsgRnAsIG46IENVUlZFX09SREVSIH0gPSBDVVJWRTsKCSAgICBjb25zdCBjb21wcmVzc2VkTGVuID0gRnAuQllURVMgKyAxOyAvLyBlLmcuIDMzIGZvciAzMgoJICAgIGNvbnN0IHVuY29tcHJlc3NlZExlbiA9IDIgKiBGcC5CWVRFUyArIDE7IC8vIGUuZy4gNjUgZm9yIDMyCgkgICAgZnVuY3Rpb24gbW9kTihhKSB7CgkgICAgICAgIHJldHVybiBtb2QoYSwgQ1VSVkVfT1JERVIpOwoJICAgIH0KCSAgICBmdW5jdGlvbiBpbnZOKGEpIHsKCSAgICAgICAgcmV0dXJuIGludmVydChhLCBDVVJWRV9PUkRFUik7CgkgICAgfQoJICAgIGNvbnN0IHsgUHJvamVjdGl2ZVBvaW50OiBQb2ludCwgbm9ybVByaXZhdGVLZXlUb1NjYWxhciwgd2VpZXJzdHJhc3NFcXVhdGlvbiwgaXNXaXRoaW5DdXJ2ZU9yZGVyLCB9ID0gd2VpZXJzdHJhc3NQb2ludHMoewoJICAgICAgICAuLi5DVVJWRSwKCSAgICAgICAgdG9CeXRlcyhfYywgcG9pbnQsIGlzQ29tcHJlc3NlZCkgewoJICAgICAgICAgICAgY29uc3QgYSA9IHBvaW50LnRvQWZmaW5lKCk7CgkgICAgICAgICAgICBjb25zdCB4ID0gRnAudG9CeXRlcyhhLngpOwoJICAgICAgICAgICAgY29uc3QgY2F0ID0gY29uY2F0Qnl0ZXM7CgkgICAgICAgICAgICBhYm9vbCgnaXNDb21wcmVzc2VkJywgaXNDb21wcmVzc2VkKTsKCSAgICAgICAgICAgIGlmIChpc0NvbXByZXNzZWQpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gY2F0KFVpbnQ4QXJyYXkuZnJvbShbcG9pbnQuaGFzRXZlblkoKSA/IDB4MDIgOiAweDAzXSksIHgpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGNhdChVaW50OEFycmF5LmZyb20oWzB4MDRdKSwgeCwgRnAudG9CeXRlcyhhLnkpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCSAgICAgICAgZnJvbUJ5dGVzKGJ5dGVzKSB7CgkgICAgICAgICAgICBjb25zdCBsZW4gPSBieXRlcy5sZW5ndGg7CgkgICAgICAgICAgICBjb25zdCBoZWFkID0gYnl0ZXNbMF07CgkgICAgICAgICAgICBjb25zdCB0YWlsID0gYnl0ZXMuc3ViYXJyYXkoMSk7CgkgICAgICAgICAgICAvLyB0aGlzLmFzc2VydFZhbGlkaXR5KCkgaXMgZG9uZSBpbnNpZGUgb2YgZnJvbUhleAoJICAgICAgICAgICAgaWYgKGxlbiA9PT0gY29tcHJlc3NlZExlbiAmJiAoaGVhZCA9PT0gMHgwMiB8fCBoZWFkID09PSAweDAzKSkgewoJICAgICAgICAgICAgICAgIGNvbnN0IHggPSBieXRlc1RvTnVtYmVyQkUodGFpbCk7CgkgICAgICAgICAgICAgICAgaWYgKCFpblJhbmdlKHgsIF8xbiQxLCBGcC5PUkRFUikpCgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUG9pbnQgaXMgbm90IG9uIGN1cnZlJyk7CgkgICAgICAgICAgICAgICAgY29uc3QgeTIgPSB3ZWllcnN0cmFzc0VxdWF0aW9uKHgpOyAvLyB5wrIgPSB4wrMgKyBheCArIGIKCSAgICAgICAgICAgICAgICBsZXQgeTsKCSAgICAgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgICAgICB5ID0gRnAuc3FydCh5Mik7IC8vIHkgPSB5wrIgXiAocCsxKS80CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGNhdGNoIChzcXJ0RXJyb3IpIHsKCSAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3VmZml4ID0gc3FydEVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyAnOiAnICsgc3FydEVycm9yLm1lc3NhZ2UgOiAnJzsKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb2ludCBpcyBub3Qgb24gY3VydmUnICsgc3VmZml4KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY29uc3QgaXNZT2RkID0gKHkgJiBfMW4kMSkgPT09IF8xbiQxOwoJICAgICAgICAgICAgICAgIC8vIEVDRFNBCgkgICAgICAgICAgICAgICAgY29uc3QgaXNIZWFkT2RkID0gKGhlYWQgJiAxKSA9PT0gMTsKCSAgICAgICAgICAgICAgICBpZiAoaXNIZWFkT2RkICE9PSBpc1lPZGQpCgkgICAgICAgICAgICAgICAgICAgIHkgPSBGcC5uZWcoeSk7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHsgeCwgeSB9OwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZWxzZSBpZiAobGVuID09PSB1bmNvbXByZXNzZWRMZW4gJiYgaGVhZCA9PT0gMHgwNCkgewoJICAgICAgICAgICAgICAgIGNvbnN0IHggPSBGcC5mcm9tQnl0ZXModGFpbC5zdWJhcnJheSgwLCBGcC5CWVRFUykpOwoJICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBGcC5mcm9tQnl0ZXModGFpbC5zdWJhcnJheShGcC5CWVRFUywgMiAqIEZwLkJZVEVTKSk7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHsgeCwgeSB9OwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAgY29uc3QgY2wgPSBjb21wcmVzc2VkTGVuOwoJICAgICAgICAgICAgICAgIGNvbnN0IHVsID0gdW5jb21wcmVzc2VkTGVuOwoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBQb2ludCwgZXhwZWN0ZWQgbGVuZ3RoIG9mICcgKyBjbCArICcsIG9yIHVuY29tcHJlc3NlZCAnICsgdWwgKyAnLCBnb3QgJyArIGxlbik7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgkgICAgfSk7CgkgICAgY29uc3QgbnVtVG9OQnl0ZVN0ciA9IChudW0pID0+IGJ5dGVzVG9IZXgobnVtYmVyVG9CeXRlc0JFKG51bSwgQ1VSVkUubkJ5dGVMZW5ndGgpKTsKCSAgICBmdW5jdGlvbiBpc0JpZ2dlclRoYW5IYWxmT3JkZXIobnVtYmVyKSB7CgkgICAgICAgIGNvbnN0IEhBTEYgPSBDVVJWRV9PUkRFUiA+PiBfMW4kMTsKCSAgICAgICAgcmV0dXJuIG51bWJlciA+IEhBTEY7CgkgICAgfQoJICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVMocykgewoJICAgICAgICByZXR1cm4gaXNCaWdnZXJUaGFuSGFsZk9yZGVyKHMpID8gbW9kTigtcykgOiBzOwoJICAgIH0KCSAgICAvLyBzbGljZSBieXRlcyBudW0KCSAgICBjb25zdCBzbGNOdW0gPSAoYiwgZnJvbSwgdG8pID0+IGJ5dGVzVG9OdW1iZXJCRShiLnNsaWNlKGZyb20sIHRvKSk7CgkgICAgLyoqCgkgICAgICogRUNEU0Egc2lnbmF0dXJlIHdpdGggaXRzIChyLCBzKSBwcm9wZXJ0aWVzLiBTdXBwb3J0cyBERVIgJiBjb21wYWN0IHJlcHJlc2VudGF0aW9ucy4KCSAgICAgKi8KCSAgICBjbGFzcyBTaWduYXR1cmUgewoJICAgICAgICBjb25zdHJ1Y3RvcihyLCBzLCByZWNvdmVyeSkgewoJICAgICAgICAgICAgdGhpcy5yID0gcjsKCSAgICAgICAgICAgIHRoaXMucyA9IHM7CgkgICAgICAgICAgICB0aGlzLnJlY292ZXJ5ID0gcmVjb3Zlcnk7CgkgICAgICAgICAgICB0aGlzLmFzc2VydFZhbGlkaXR5KCk7CgkgICAgICAgIH0KCSAgICAgICAgLy8gcGFpciAoYnl0ZXMgb2YgciwgYnl0ZXMgb2YgcykKCSAgICAgICAgc3RhdGljIGZyb21Db21wYWN0KGhleCkgewoJICAgICAgICAgICAgY29uc3QgbCA9IENVUlZFLm5CeXRlTGVuZ3RoOwoJICAgICAgICAgICAgaGV4ID0gZW5zdXJlQnl0ZXMoJ2NvbXBhY3RTaWduYXR1cmUnLCBoZXgsIGwgKiAyKTsKCSAgICAgICAgICAgIHJldHVybiBuZXcgU2lnbmF0dXJlKHNsY051bShoZXgsIDAsIGwpLCBzbGNOdW0oaGV4LCBsLCAyICogbCkpOwoJICAgICAgICB9CgkgICAgICAgIC8vIERFUiBlbmNvZGVkIEVDRFNBIHNpZ25hdHVyZQoJICAgICAgICAvLyBodHRwczovL2JpdGNvaW4uc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzU3NjQ0L3doYXQtYXJlLXRoZS1wYXJ0cy1vZi1hLWJpdGNvaW4tdHJhbnNhY3Rpb24taW5wdXQtc2NyaXB0CgkgICAgICAgIHN0YXRpYyBmcm9tREVSKGhleCkgewoJICAgICAgICAgICAgY29uc3QgeyByLCBzIH0gPSBERVIudG9TaWcoZW5zdXJlQnl0ZXMoJ0RFUicsIGhleCkpOwoJICAgICAgICAgICAgcmV0dXJuIG5ldyBTaWduYXR1cmUociwgcyk7CgkgICAgICAgIH0KCSAgICAgICAgYXNzZXJ0VmFsaWRpdHkoKSB7CgkgICAgICAgICAgICBhSW5SYW5nZSgncicsIHRoaXMuciwgXzFuJDEsIENVUlZFX09SREVSKTsgLy8gciBpbiBbMS4uTl0KCSAgICAgICAgICAgIGFJblJhbmdlKCdzJywgdGhpcy5zLCBfMW4kMSwgQ1VSVkVfT1JERVIpOyAvLyBzIGluIFsxLi5OXQoJICAgICAgICB9CgkgICAgICAgIGFkZFJlY292ZXJ5Qml0KHJlY292ZXJ5KSB7CgkgICAgICAgICAgICByZXR1cm4gbmV3IFNpZ25hdHVyZSh0aGlzLnIsIHRoaXMucywgcmVjb3ZlcnkpOwoJICAgICAgICB9CgkgICAgICAgIHJlY292ZXJQdWJsaWNLZXkobXNnSGFzaCkgewoJICAgICAgICAgICAgY29uc3QgeyByLCBzLCByZWNvdmVyeTogcmVjIH0gPSB0aGlzOwoJICAgICAgICAgICAgY29uc3QgaCA9IGJpdHMyaW50X21vZE4oZW5zdXJlQnl0ZXMoJ21zZ0hhc2gnLCBtc2dIYXNoKSk7IC8vIFRydW5jYXRlIGhhc2gKCSAgICAgICAgICAgIGlmIChyZWMgPT0gbnVsbCB8fCAhWzAsIDEsIDIsIDNdLmluY2x1ZGVzKHJlYykpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdyZWNvdmVyeSBpZCBpbnZhbGlkJyk7CgkgICAgICAgICAgICBjb25zdCByYWRqID0gcmVjID09PSAyIHx8IHJlYyA9PT0gMyA/IHIgKyBDVVJWRS5uIDogcjsKCSAgICAgICAgICAgIGlmIChyYWRqID49IEZwLk9SREVSKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncmVjb3ZlcnkgaWQgMiBvciAzIGludmFsaWQnKTsKCSAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IChyZWMgJiAxKSA9PT0gMCA/ICcwMicgOiAnMDMnOwoJICAgICAgICAgICAgY29uc3QgUiA9IFBvaW50LmZyb21IZXgocHJlZml4ICsgbnVtVG9OQnl0ZVN0cihyYWRqKSk7CgkgICAgICAgICAgICBjb25zdCBpciA9IGludk4ocmFkaik7IC8vIHJeLTEKCSAgICAgICAgICAgIGNvbnN0IHUxID0gbW9kTigtaCAqIGlyKTsgLy8gLWhyXi0xCgkgICAgICAgICAgICBjb25zdCB1MiA9IG1vZE4ocyAqIGlyKTsgLy8gc3JeLTEKCSAgICAgICAgICAgIGNvbnN0IFEgPSBQb2ludC5CQVNFLm11bHRpcGx5QW5kQWRkVW5zYWZlKFIsIHUxLCB1Mik7IC8vIChzcl4tMSlSLShocl4tMSlHID0gLShocl4tMSlHICsgKHNyXi0xKQoJICAgICAgICAgICAgaWYgKCFRKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncG9pbnQgYXQgaW5maW5pZnknKTsgLy8gdW5zYWZlIGlzIGZpbmU6IG5vIHByaXYgZGF0YSBsZWFrZWQKCSAgICAgICAgICAgIFEuYXNzZXJ0VmFsaWRpdHkoKTsKCSAgICAgICAgICAgIHJldHVybiBROwoJICAgICAgICB9CgkgICAgICAgIC8vIFNpZ25hdHVyZXMgc2hvdWxkIGJlIGxvdy1zLCB0byBwcmV2ZW50IG1hbGxlYWJpbGl0eS4KCSAgICAgICAgaGFzSGlnaFMoKSB7CgkgICAgICAgICAgICByZXR1cm4gaXNCaWdnZXJUaGFuSGFsZk9yZGVyKHRoaXMucyk7CgkgICAgICAgIH0KCSAgICAgICAgbm9ybWFsaXplUygpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmhhc0hpZ2hTKCkgPyBuZXcgU2lnbmF0dXJlKHRoaXMuciwgbW9kTigtdGhpcy5zKSwgdGhpcy5yZWNvdmVyeSkgOiB0aGlzOwoJICAgICAgICB9CgkgICAgICAgIC8vIERFUi1lbmNvZGVkCgkgICAgICAgIHRvREVSUmF3Qnl0ZXMoKSB7CgkgICAgICAgICAgICByZXR1cm4gaGV4VG9CeXRlcyh0aGlzLnRvREVSSGV4KCkpOwoJICAgICAgICB9CgkgICAgICAgIHRvREVSSGV4KCkgewoJICAgICAgICAgICAgcmV0dXJuIERFUi5oZXhGcm9tU2lnKHsgcjogdGhpcy5yLCBzOiB0aGlzLnMgfSk7CgkgICAgICAgIH0KCSAgICAgICAgLy8gcGFkZGVkIGJ5dGVzIG9mIHIsIHRoZW4gcGFkZGVkIGJ5dGVzIG9mIHMKCSAgICAgICAgdG9Db21wYWN0UmF3Qnl0ZXMoKSB7CgkgICAgICAgICAgICByZXR1cm4gaGV4VG9CeXRlcyh0aGlzLnRvQ29tcGFjdEhleCgpKTsKCSAgICAgICAgfQoJICAgICAgICB0b0NvbXBhY3RIZXgoKSB7CgkgICAgICAgICAgICByZXR1cm4gbnVtVG9OQnl0ZVN0cih0aGlzLnIpICsgbnVtVG9OQnl0ZVN0cih0aGlzLnMpOwoJICAgICAgICB9CgkgICAgfQoJICAgIGNvbnN0IHV0aWxzID0gewoJICAgICAgICBpc1ZhbGlkUHJpdmF0ZUtleShwcml2YXRlS2V5KSB7CgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIG5vcm1Qcml2YXRlS2V5VG9TY2FsYXIocHJpdmF0ZUtleSk7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgkgICAgICAgIG5vcm1Qcml2YXRlS2V5VG9TY2FsYXI6IG5vcm1Qcml2YXRlS2V5VG9TY2FsYXIsCgkgICAgICAgIC8qKgoJICAgICAgICAgKiBQcm9kdWNlcyBjcnlwdG9ncmFwaGljYWxseSBzZWN1cmUgcHJpdmF0ZSBrZXkgZnJvbSByYW5kb20gb2Ygc2l6ZQoJICAgICAgICAgKiAoZ3JvdXBMZW4gKyBjZWlsKGdyb3VwTGVuIC8gMikpIHdpdGggbW9kdWxvIGJpYXMgYmVpbmcgbmVnbGlnaWJsZS4KCSAgICAgICAgICovCgkgICAgICAgIHJhbmRvbVByaXZhdGVLZXk6ICgpID0+IHsKCSAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdldE1pbkhhc2hMZW5ndGgoQ1VSVkUubik7CgkgICAgICAgICAgICByZXR1cm4gbWFwSGFzaFRvRmllbGQoQ1VSVkUucmFuZG9tQnl0ZXMobGVuZ3RoKSwgQ1VSVkUubik7CgkgICAgICAgIH0sCgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIHByZWNvbXB1dGUgdGFibGUgZm9yIGFuIGFyYml0cmFyeSBFQyBwb2ludC4gTWFrZXMgcG9pbnQgImNhY2hlZCIuCgkgICAgICAgICAqIEFsbG93cyB0byBtYXNzaXZlbHkgc3BlZWQtdXAgYHBvaW50Lm11bHRpcGx5KHNjYWxhcilgLgoJICAgICAgICAgKiBAcmV0dXJucyBjYWNoZWQgcG9pbnQKCSAgICAgICAgICogQGV4YW1wbGUKCSAgICAgICAgICogY29uc3QgZmFzdCA9IHV0aWxzLnByZWNvbXB1dGUoOCwgUHJvamVjdGl2ZVBvaW50LmZyb21IZXgoc29tZW9uZXNQdWJLZXkpKTsKCSAgICAgICAgICogZmFzdC5tdWx0aXBseShwcml2S2V5KTsgLy8gbXVjaCBmYXN0ZXIgRUNESCBub3cKCSAgICAgICAgICovCgkgICAgICAgIHByZWNvbXB1dGUod2luZG93U2l6ZSA9IDgsIHBvaW50ID0gUG9pbnQuQkFTRSkgewoJICAgICAgICAgICAgcG9pbnQuX3NldFdpbmRvd1NpemUod2luZG93U2l6ZSk7CgkgICAgICAgICAgICBwb2ludC5tdWx0aXBseShCaWdJbnQoMykpOyAvLyAzIGlzIGFyYml0cmFyeSwganVzdCBuZWVkIGFueSBudW1iZXIgaGVyZQoJICAgICAgICAgICAgcmV0dXJuIHBvaW50OwoJICAgICAgICB9LAoJICAgIH07CgkgICAgLyoqCgkgICAgICogQ29tcHV0ZXMgcHVibGljIGtleSBmb3IgYSBwcml2YXRlIGtleS4gQ2hlY2tzIGZvciB2YWxpZGl0eSBvZiB0aGUgcHJpdmF0ZSBrZXkuCgkgICAgICogQHBhcmFtIHByaXZhdGVLZXkgcHJpdmF0ZSBrZXkKCSAgICAgKiBAcGFyYW0gaXNDb21wcmVzc2VkIHdoZXRoZXIgdG8gcmV0dXJuIGNvbXBhY3QgKGRlZmF1bHQpLCBvciBmdWxsIGtleQoJICAgICAqIEByZXR1cm5zIFB1YmxpYyBrZXksIGZ1bGwgd2hlbiBpc0NvbXByZXNzZWQ9ZmFsc2U7IHNob3J0IHdoZW4gaXNDb21wcmVzc2VkPXRydWUKCSAgICAgKi8KCSAgICBmdW5jdGlvbiBnZXRQdWJsaWNLZXkocHJpdmF0ZUtleSwgaXNDb21wcmVzc2VkID0gdHJ1ZSkgewoJICAgICAgICByZXR1cm4gUG9pbnQuZnJvbVByaXZhdGVLZXkocHJpdmF0ZUtleSkudG9SYXdCeXRlcyhpc0NvbXByZXNzZWQpOwoJICAgIH0KCSAgICAvKioKCSAgICAgKiBRdWljayBhbmQgZGlydHkgY2hlY2sgZm9yIGl0ZW0gYmVpbmcgcHVibGljIGtleS4gRG9lcyBub3QgdmFsaWRhdGUgaGV4LCBvciBiZWluZyBvbi1jdXJ2ZS4KCSAgICAgKi8KCSAgICBmdW5jdGlvbiBpc1Byb2JQdWIoaXRlbSkgewoJICAgICAgICBjb25zdCBhcnIgPSBpc0J5dGVzJDEoaXRlbSk7CgkgICAgICAgIGNvbnN0IHN0ciA9IHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJzsKCSAgICAgICAgY29uc3QgbGVuID0gKGFyciB8fCBzdHIpICYmIGl0ZW0ubGVuZ3RoOwoJICAgICAgICBpZiAoYXJyKQoJICAgICAgICAgICAgcmV0dXJuIGxlbiA9PT0gY29tcHJlc3NlZExlbiB8fCBsZW4gPT09IHVuY29tcHJlc3NlZExlbjsKCSAgICAgICAgaWYgKHN0cikKCSAgICAgICAgICAgIHJldHVybiBsZW4gPT09IDIgKiBjb21wcmVzc2VkTGVuIHx8IGxlbiA9PT0gMiAqIHVuY29tcHJlc3NlZExlbjsKCSAgICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBQb2ludCkKCSAgICAgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfQoJICAgIC8qKgoJICAgICAqIEVDREggKEVsbGlwdGljIEN1cnZlIERpZmZpZSBIZWxsbWFuKS4KCSAgICAgKiBDb21wdXRlcyBzaGFyZWQgcHVibGljIGtleSBmcm9tIHByaXZhdGUga2V5IGFuZCBwdWJsaWMga2V5LgoJICAgICAqIENoZWNrczogMSkgcHJpdmF0ZSBrZXkgdmFsaWRpdHkgMikgc2hhcmVkIGtleSBpcyBvbi1jdXJ2ZS4KCSAgICAgKiBEb2VzIE5PVCBoYXNoIHRoZSByZXN1bHQuCgkgICAgICogQHBhcmFtIHByaXZhdGVBIHByaXZhdGUga2V5CgkgICAgICogQHBhcmFtIHB1YmxpY0IgZGlmZmVyZW50IHB1YmxpYyBrZXkKCSAgICAgKiBAcGFyYW0gaXNDb21wcmVzc2VkIHdoZXRoZXIgdG8gcmV0dXJuIGNvbXBhY3QgKGRlZmF1bHQpLCBvciBmdWxsIGtleQoJICAgICAqIEByZXR1cm5zIHNoYXJlZCBwdWJsaWMga2V5CgkgICAgICovCgkgICAgZnVuY3Rpb24gZ2V0U2hhcmVkU2VjcmV0KHByaXZhdGVBLCBwdWJsaWNCLCBpc0NvbXByZXNzZWQgPSB0cnVlKSB7CgkgICAgICAgIGlmIChpc1Byb2JQdWIocHJpdmF0ZUEpKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdmaXJzdCBhcmcgbXVzdCBiZSBwcml2YXRlIGtleScpOwoJICAgICAgICBpZiAoIWlzUHJvYlB1YihwdWJsaWNCKSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignc2Vjb25kIGFyZyBtdXN0IGJlIHB1YmxpYyBrZXknKTsKCSAgICAgICAgY29uc3QgYiA9IFBvaW50LmZyb21IZXgocHVibGljQik7IC8vIGNoZWNrIGZvciBiZWluZyBvbi1jdXJ2ZQoJICAgICAgICByZXR1cm4gYi5tdWx0aXBseShub3JtUHJpdmF0ZUtleVRvU2NhbGFyKHByaXZhdGVBKSkudG9SYXdCeXRlcyhpc0NvbXByZXNzZWQpOwoJICAgIH0KCSAgICAvLyBSRkM2OTc5OiBlbnN1cmUgRUNEU0EgbXNnIGlzIFggYnl0ZXMgYW5kIDwgTi4gUkZDIHN1Z2dlc3RzIG9wdGlvbmFsIHRydW5jYXRpbmcgdmlhIGJpdHMyb2N0ZXRzLgoJICAgIC8vIEZJUFMgMTg2LTQgNC42IHN1Z2dlc3RzIHRoZSBsZWZ0bW9zdCBtaW4obkJpdExlbiwgb3V0TGVuKSBiaXRzLCB3aGljaCBtYXRjaGVzIGJpdHMyaW50LgoJICAgIC8vIGJpdHMyaW50IGNhbiBwcm9kdWNlIHJlcz5OLCB3ZSBjYW4gZG8gbW9kKHJlcywgTikgc2luY2UgdGhlIGJpdExlbiBpcyB0aGUgc2FtZS4KCSAgICAvLyBpbnQyb2N0ZXRzIGNhbid0IGJlIHVzZWQ7IHBhZHMgc21hbGwgbXNncyB3aXRoIDA6IHVuYWNjZXB0YXRibGUgZm9yIHRydW5jIGFzIHBlciBSRkMgdmVjdG9ycwoJICAgIGNvbnN0IGJpdHMyaW50ID0gQ1VSVkUuYml0czJpbnQgfHwKCSAgICAgICAgZnVuY3Rpb24gKGJ5dGVzKSB7CgkgICAgICAgICAgICAvLyBPdXIgY3VzdG9tIGNoZWNrICJqdXN0IGluIGNhc2UiCgkgICAgICAgICAgICBpZiAoYnl0ZXMubGVuZ3RoID4gODE5MikKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lucHV0IGlzIHRvbyBsYXJnZScpOwoJICAgICAgICAgICAgLy8gRm9yIGN1cnZlcyB3aXRoIG5CaXRMZW5ndGggJSA4ICE9PSAwOiBiaXRzMm9jdGV0cyhiaXRzMm9jdGV0cyhtKSkgIT09IGJpdHMyb2N0ZXRzKG0pCgkgICAgICAgICAgICAvLyBmb3Igc29tZSBjYXNlcywgc2luY2UgYnl0ZXMubGVuZ3RoICogOCBpcyBub3QgYWN0dWFsIGJpdExlbmd0aC4KCSAgICAgICAgICAgIGNvbnN0IG51bSA9IGJ5dGVzVG9OdW1iZXJCRShieXRlcyk7IC8vIGNoZWNrIGZvciA9PSB1OCBkb25lIGhlcmUKCSAgICAgICAgICAgIGNvbnN0IGRlbHRhID0gYnl0ZXMubGVuZ3RoICogOCAtIENVUlZFLm5CaXRMZW5ndGg7IC8vIHRydW5jYXRlIHRvIG5CaXRMZW5ndGggbGVmdG1vc3QgYml0cwoJICAgICAgICAgICAgcmV0dXJuIGRlbHRhID4gMCA/IG51bSA+PiBCaWdJbnQoZGVsdGEpIDogbnVtOwoJICAgICAgICB9OwoJICAgIGNvbnN0IGJpdHMyaW50X21vZE4gPSBDVVJWRS5iaXRzMmludF9tb2ROIHx8CgkgICAgICAgIGZ1bmN0aW9uIChieXRlcykgewoJICAgICAgICAgICAgcmV0dXJuIG1vZE4oYml0czJpbnQoYnl0ZXMpKTsgLy8gY2FuJ3QgdXNlIGJ5dGVzVG9OdW1iZXJCRSBoZXJlCgkgICAgICAgIH07CgkgICAgLy8gTk9URTogcGFkcyBvdXRwdXQgd2l0aCB6ZXJvIGFzIHBlciBzcGVjCgkgICAgY29uc3QgT1JERVJfTUFTSyA9IGJpdE1hc2soQ1VSVkUubkJpdExlbmd0aCk7CgkgICAgLyoqCgkgICAgICogQ29udmVydHMgdG8gYnl0ZXMuIENoZWNrcyBpZiBudW0gaW4gYFswLi5PUkRFUl9NQVNLLTFdYCBlLmcuOiBgWzAuLjJeMjU2LTFdYC4KCSAgICAgKi8KCSAgICBmdW5jdGlvbiBpbnQyb2N0ZXRzKG51bSkgewoJICAgICAgICBhSW5SYW5nZSgnbnVtIDwgMl4nICsgQ1VSVkUubkJpdExlbmd0aCwgbnVtLCBfMG4sIE9SREVSX01BU0spOwoJICAgICAgICAvLyB3b3JrcyB3aXRoIG9yZGVyLCBjYW4gaGF2ZSBkaWZmZXJlbnQgc2l6ZSB0aGFuIG51bVRvRmllbGQhCgkgICAgICAgIHJldHVybiBudW1iZXJUb0J5dGVzQkUobnVtLCBDVVJWRS5uQnl0ZUxlbmd0aCk7CgkgICAgfQoJICAgIC8vIFN0ZXBzIEEsIEQgb2YgUkZDNjk3OSAzLjIKCSAgICAvLyBDcmVhdGVzIFJGQzY5Nzkgc2VlZDsgY29udmVydHMgbXNnL3ByaXZLZXkgdG8gbnVtYmVycy4KCSAgICAvLyBVc2VkIG9ubHkgaW4gc2lnbiwgbm90IGluIHZlcmlmeS4KCSAgICAvLyBOT1RFOiB3ZSBjYW5ub3QgYXNzdW1lIGhlcmUgdGhhdCBtc2dIYXNoIGhhcyBzYW1lIGFtb3VudCBvZiBieXRlcyBhcyBjdXJ2ZSBvcmRlciwKCSAgICAvLyB0aGlzIHdpbGwgYmUgaW52YWxpZCBhdCBsZWFzdCBmb3IgUDUyMS4gQWxzbyBpdCBjYW4gYmUgYmlnZ2VyIGZvciBQMjI0ICsgU0hBMjU2CgkgICAgZnVuY3Rpb24gcHJlcFNpZyhtc2dIYXNoLCBwcml2YXRlS2V5LCBvcHRzID0gZGVmYXVsdFNpZ09wdHMpIHsKCSAgICAgICAgaWYgKFsncmVjb3ZlcmVkJywgJ2Nhbm9uaWNhbCddLnNvbWUoKGspID0+IGsgaW4gb3B0cykpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NpZ24oKSBsZWdhY3kgb3B0aW9ucyBub3Qgc3VwcG9ydGVkJyk7CgkgICAgICAgIGNvbnN0IHsgaGFzaCwgcmFuZG9tQnl0ZXMgfSA9IENVUlZFOwoJICAgICAgICBsZXQgeyBsb3dTLCBwcmVoYXNoLCBleHRyYUVudHJvcHk6IGVudCB9ID0gb3B0czsgLy8gZ2VuZXJhdGVzIGxvdy1zIHNpZ3MgYnkgZGVmYXVsdAoJICAgICAgICBpZiAobG93UyA9PSBudWxsKQoJICAgICAgICAgICAgbG93UyA9IHRydWU7IC8vIFJGQzY5NzkgMy4yOiB3ZSBza2lwIHN0ZXAgQSwgYmVjYXVzZSB3ZSBhbHJlYWR5IHByb3ZpZGUgaGFzaAoJICAgICAgICBtc2dIYXNoID0gZW5zdXJlQnl0ZXMoJ21zZ0hhc2gnLCBtc2dIYXNoKTsKCSAgICAgICAgdmFsaWRhdGVTaWdWZXJPcHRzKG9wdHMpOwoJICAgICAgICBpZiAocHJlaGFzaCkKCSAgICAgICAgICAgIG1zZ0hhc2ggPSBlbnN1cmVCeXRlcygncHJlaGFzaGVkIG1zZ0hhc2gnLCBoYXNoKG1zZ0hhc2gpKTsKCSAgICAgICAgLy8gV2UgY2FuJ3QgbGF0ZXIgY2FsbCBiaXRzMm9jdGV0cywgc2luY2UgbmVzdGVkIGJpdHMyaW50IGlzIGJyb2tlbiBmb3IgY3VydmVzCgkgICAgICAgIC8vIHdpdGggbkJpdExlbmd0aCAlIDggIT09IDAuIEJlY2F1c2Ugb2YgdGhhdCwgd2UgdW53cmFwIGl0IGhlcmUgYXMgaW50Mm9jdGV0cyBjYWxsLgoJICAgICAgICAvLyBjb25zdCBiaXRzMm9jdGV0cyA9IChiaXRzKSA9PiBpbnQyb2N0ZXRzKGJpdHMyaW50X21vZE4oYml0cykpCgkgICAgICAgIGNvbnN0IGgxaW50ID0gYml0czJpbnRfbW9kTihtc2dIYXNoKTsKCSAgICAgICAgY29uc3QgZCA9IG5vcm1Qcml2YXRlS2V5VG9TY2FsYXIocHJpdmF0ZUtleSk7IC8vIHZhbGlkYXRlIHByaXZhdGUga2V5LCBjb252ZXJ0IHRvIGJpZ2ludAoJICAgICAgICBjb25zdCBzZWVkQXJncyA9IFtpbnQyb2N0ZXRzKGQpLCBpbnQyb2N0ZXRzKGgxaW50KV07CgkgICAgICAgIC8vIGV4dHJhRW50cm9weS4gUkZDNjk3OSAzLjY6IGFkZGl0aW9uYWwgaycgKG9wdGlvbmFsKS4KCSAgICAgICAgaWYgKGVudCAhPSBudWxsICYmIGVudCAhPT0gZmFsc2UpIHsKCSAgICAgICAgICAgIC8vIEsgPSBITUFDX0soViB8fCAweDAwIHx8IGludDJvY3RldHMoeCkgfHwgYml0czJvY3RldHMoaDEpIHx8IGsnKQoJICAgICAgICAgICAgY29uc3QgZSA9IGVudCA9PT0gdHJ1ZSA/IHJhbmRvbUJ5dGVzKEZwLkJZVEVTKSA6IGVudDsgLy8gZ2VuZXJhdGUgcmFuZG9tIGJ5dGVzIE9SIHBhc3MgYXMtaXMKCSAgICAgICAgICAgIHNlZWRBcmdzLnB1c2goZW5zdXJlQnl0ZXMoJ2V4dHJhRW50cm9weScsIGUpKTsgLy8gY2hlY2sgZm9yIGJlaW5nIGJ5dGVzCgkgICAgICAgIH0KCSAgICAgICAgY29uc3Qgc2VlZCA9IGNvbmNhdEJ5dGVzKC4uLnNlZWRBcmdzKTsgLy8gU3RlcCBEIG9mIFJGQzY5NzkgMy4yCgkgICAgICAgIGNvbnN0IG0gPSBoMWludDsgLy8gTk9URTogbm8gbmVlZCB0byBjYWxsIGJpdHMyaW50IHNlY29uZCB0aW1lIGhlcmUsIGl0IGlzIGluc2lkZSB0cnVuY2F0ZUhhc2ghCgkgICAgICAgIC8vIENvbnZlcnRzIHNpZ25hdHVyZSBwYXJhbXMgaW50byBwb2ludCB3IHIvcywgY2hlY2tzIHJlc3VsdCBmb3IgdmFsaWRpdHkuCgkgICAgICAgIGZ1bmN0aW9uIGsyc2lnKGtCeXRlcykgewoJICAgICAgICAgICAgLy8gUkZDIDY5NzkgU2VjdGlvbiAzLjIsIHN0ZXAgMzogayA9IGJpdHMyaW50KFQpCgkgICAgICAgICAgICBjb25zdCBrID0gYml0czJpbnQoa0J5dGVzKTsgLy8gQ2Fubm90IHVzZSBmaWVsZHMgbWV0aG9kcywgc2luY2UgaXQgaXMgZ3JvdXAgZWxlbWVudAoJICAgICAgICAgICAgaWYgKCFpc1dpdGhpbkN1cnZlT3JkZXIoaykpCgkgICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBJbXBvcnRhbnQ6IGFsbCBtb2QoKSBjYWxscyBoZXJlIG11c3QgYmUgZG9uZSBvdmVyIE4KCSAgICAgICAgICAgIGNvbnN0IGlrID0gaW52TihrKTsgLy8ga14tMSBtb2QgbgoJICAgICAgICAgICAgY29uc3QgcSA9IFBvaW50LkJBU0UubXVsdGlwbHkoaykudG9BZmZpbmUoKTsgLy8gcSA9IEdrCgkgICAgICAgICAgICBjb25zdCByID0gbW9kTihxLngpOyAvLyByID0gcS54IG1vZCBuCgkgICAgICAgICAgICBpZiAociA9PT0gXzBuKQoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIC8vIENhbiB1c2Ugc2NhbGFyIGJsaW5kaW5nIGJeLTEoYm0gKyBiZHIpIHdoZXJlIGIg4oiIIFsxLHHiiJIxXSBhY2NvcmRpbmcgdG8KCSAgICAgICAgICAgIC8vIGh0dHBzOi8vdGNoZXMuaWFjci5vcmcvaW5kZXgucGhwL1RDSEVTL2FydGljbGUvdmlldy83MzM3LzY1MDkuIFdlJ3ZlIGRlY2lkZWQgYWdhaW5zdCBpdDoKCSAgICAgICAgICAgIC8vIGEpIGRlcGVuZGVuY3kgb24gQ1NQUk5HIGIpIDE1JSBzbG93ZG93biBjKSBkb2Vzbid0IHJlYWxseSBoZWxwIHNpbmNlIGJpZ2ludHMgYXJlIG5vdCBDVAoJICAgICAgICAgICAgY29uc3QgcyA9IG1vZE4oaWsgKiBtb2ROKG0gKyByICogZCkpOyAvLyBOb3QgdXNpbmcgYmxpbmRpbmcgaGVyZQoJICAgICAgICAgICAgaWYgKHMgPT09IF8wbikKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICBsZXQgcmVjb3ZlcnkgPSAocS54ID09PSByID8gMCA6IDIpIHwgTnVtYmVyKHEueSAmIF8xbiQxKTsgLy8gcmVjb3ZlcnkgYml0ICgyIG9yIDMsIHdoZW4gcS54ID4gbikKCSAgICAgICAgICAgIGxldCBub3JtUyA9IHM7CgkgICAgICAgICAgICBpZiAobG93UyAmJiBpc0JpZ2dlclRoYW5IYWxmT3JkZXIocykpIHsKCSAgICAgICAgICAgICAgICBub3JtUyA9IG5vcm1hbGl6ZVMocyk7IC8vIGlmIGxvd1Mgd2FzIHBhc3NlZCwgZW5zdXJlIHMgaXMgYWx3YXlzCgkgICAgICAgICAgICAgICAgcmVjb3ZlcnkgXj0gMTsgLy8gLy8gaW4gdGhlIGJvdHRvbSBoYWxmIG9mIE4KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBuZXcgU2lnbmF0dXJlKHIsIG5vcm1TLCByZWNvdmVyeSk7IC8vIHVzZSBub3JtUywgbm90IHMKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4geyBzZWVkLCBrMnNpZyB9OwoJICAgIH0KCSAgICBjb25zdCBkZWZhdWx0U2lnT3B0cyA9IHsgbG93UzogQ1VSVkUubG93UywgcHJlaGFzaDogZmFsc2UgfTsKCSAgICBjb25zdCBkZWZhdWx0VmVyT3B0cyA9IHsgbG93UzogQ1VSVkUubG93UywgcHJlaGFzaDogZmFsc2UgfTsKCSAgICAvKioKCSAgICAgKiBTaWducyBtZXNzYWdlIGhhc2ggd2l0aCBhIHByaXZhdGUga2V5LgoJICAgICAqIGBgYAoJICAgICAqIHNpZ24obSwgZCwgaykgd2hlcmUKCSAgICAgKiAgICh4LCB5KSA9IEcgw5cgawoJICAgICAqICAgciA9IHggbW9kIG4KCSAgICAgKiAgIHMgPSAobSArIGRyKS9rIG1vZCBuCgkgICAgICogYGBgCgkgICAgICogQHBhcmFtIG1zZ0hhc2ggTk9UIG1lc3NhZ2UuIG1zZyBuZWVkcyB0byBiZSBoYXNoZWQgdG8gYG1zZ0hhc2hgLCBvciB1c2UgYHByZWhhc2hgLgoJICAgICAqIEBwYXJhbSBwcml2S2V5IHByaXZhdGUga2V5CgkgICAgICogQHBhcmFtIG9wdHMgbG93UyBmb3Igbm9uLW1hbGxlYWJsZSBzaWdzLiBleHRyYUVudHJvcHkgZm9yIG1peGluZyByYW5kb21uZXNzIGludG8gay4gcHJlaGFzaCB3aWxsIGhhc2ggZmlyc3QgYXJnLgoJICAgICAqIEByZXR1cm5zIHNpZ25hdHVyZSB3aXRoIHJlY292ZXJ5IHBhcmFtCgkgICAgICovCgkgICAgZnVuY3Rpb24gc2lnbihtc2dIYXNoLCBwcml2S2V5LCBvcHRzID0gZGVmYXVsdFNpZ09wdHMpIHsKCSAgICAgICAgY29uc3QgeyBzZWVkLCBrMnNpZyB9ID0gcHJlcFNpZyhtc2dIYXNoLCBwcml2S2V5LCBvcHRzKTsgLy8gU3RlcHMgQSwgRCBvZiBSRkM2OTc5IDMuMi4KCSAgICAgICAgY29uc3QgQyA9IENVUlZFOwoJICAgICAgICBjb25zdCBkcmJnID0gY3JlYXRlSG1hY0RyYmcoQy5oYXNoLm91dHB1dExlbiwgQy5uQnl0ZUxlbmd0aCwgQy5obWFjKTsKCSAgICAgICAgcmV0dXJuIGRyYmcoc2VlZCwgazJzaWcpOyAvLyBTdGVwcyBCLCBDLCBELCBFLCBGLCBHCgkgICAgfQoJICAgIC8vIEVuYWJsZSBwcmVjb21wdXRlcy4gU2xvd3MgZG93biBmaXJzdCBwdWJsaWNLZXkgY29tcHV0YXRpb24gYnkgMjBtcy4KCSAgICBQb2ludC5CQVNFLl9zZXRXaW5kb3dTaXplKDgpOwoJICAgIC8vIHV0aWxzLnByZWNvbXB1dGUoOCwgUHJvamVjdGl2ZVBvaW50LkJBU0UpCgkgICAgLyoqCgkgICAgICogVmVyaWZpZXMgYSBzaWduYXR1cmUgYWdhaW5zdCBtZXNzYWdlIGhhc2ggYW5kIHB1YmxpYyBrZXkuCgkgICAgICogUmVqZWN0cyBsb3dTIHNpZ25hdHVyZXMgYnkgZGVmYXVsdDogdG8gb3ZlcnJpZGUsCgkgICAgICogc3BlY2lmeSBvcHRpb24gYHtsb3dTOiBmYWxzZX1gLiBJbXBsZW1lbnRzIHNlY3Rpb24gNC4xLjQgZnJvbSBodHRwczovL3d3dy5zZWNnLm9yZy9zZWMxLXYyLnBkZjoKCSAgICAgKgoJICAgICAqIGBgYAoJICAgICAqIHZlcmlmeShyLCBzLCBoLCBQKSB3aGVyZQoJICAgICAqICAgVTEgPSBoc14tMSBtb2QgbgoJICAgICAqICAgVTIgPSByc14tMSBtb2QgbgoJICAgICAqICAgUiA9IFUx4ouFRyAtIFUy4ouFUAoJICAgICAqICAgbW9kKFIueCwgbikgPT0gcgoJICAgICAqIGBgYAoJICAgICAqLwoJICAgIGZ1bmN0aW9uIHZlcmlmeShzaWduYXR1cmUsIG1zZ0hhc2gsIHB1YmxpY0tleSwgb3B0cyA9IGRlZmF1bHRWZXJPcHRzKSB7CgkgICAgICAgIGNvbnN0IHNnID0gc2lnbmF0dXJlOwoJICAgICAgICBtc2dIYXNoID0gZW5zdXJlQnl0ZXMoJ21zZ0hhc2gnLCBtc2dIYXNoKTsKCSAgICAgICAgcHVibGljS2V5ID0gZW5zdXJlQnl0ZXMoJ3B1YmxpY0tleScsIHB1YmxpY0tleSk7CgkgICAgICAgIGNvbnN0IHsgbG93UywgcHJlaGFzaCwgZm9ybWF0IH0gPSBvcHRzOwoJICAgICAgICAvLyBWZXJpZnkgb3B0cywgZGVkdWNlIHNpZ25hdHVyZSBmb3JtYXQKCSAgICAgICAgdmFsaWRhdGVTaWdWZXJPcHRzKG9wdHMpOwoJICAgICAgICBpZiAoJ3N0cmljdCcgaW4gb3B0cykKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignb3B0aW9ucy5zdHJpY3Qgd2FzIHJlbmFtZWQgdG8gbG93UycpOwoJICAgICAgICBpZiAoZm9ybWF0ICE9PSB1bmRlZmluZWQgJiYgZm9ybWF0ICE9PSAnY29tcGFjdCcgJiYgZm9ybWF0ICE9PSAnZGVyJykKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZm9ybWF0IG11c3QgYmUgY29tcGFjdCBvciBkZXInKTsKCSAgICAgICAgY29uc3QgaXNIZXggPSB0eXBlb2Ygc2cgPT09ICdzdHJpbmcnIHx8IGlzQnl0ZXMkMShzZyk7CgkgICAgICAgIGNvbnN0IGlzT2JqID0gIWlzSGV4ICYmCgkgICAgICAgICAgICAhZm9ybWF0ICYmCgkgICAgICAgICAgICB0eXBlb2Ygc2cgPT09ICdvYmplY3QnICYmCgkgICAgICAgICAgICBzZyAhPT0gbnVsbCAmJgoJICAgICAgICAgICAgdHlwZW9mIHNnLnIgPT09ICdiaWdpbnQnICYmCgkgICAgICAgICAgICB0eXBlb2Ygc2cucyA9PT0gJ2JpZ2ludCc7CgkgICAgICAgIGlmICghaXNIZXggJiYgIWlzT2JqKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHNpZ25hdHVyZSwgZXhwZWN0ZWQgVWludDhBcnJheSwgaGV4IHN0cmluZyBvciBTaWduYXR1cmUgaW5zdGFuY2UnKTsKCSAgICAgICAgbGV0IF9zaWcgPSB1bmRlZmluZWQ7CgkgICAgICAgIGxldCBQOwoJICAgICAgICB0cnkgewoJICAgICAgICAgICAgaWYgKGlzT2JqKQoJICAgICAgICAgICAgICAgIF9zaWcgPSBuZXcgU2lnbmF0dXJlKHNnLnIsIHNnLnMpOwoJICAgICAgICAgICAgaWYgKGlzSGV4KSB7CgkgICAgICAgICAgICAgICAgLy8gU2lnbmF0dXJlIGNhbiBiZSByZXByZXNlbnRlZCBpbiAyIHdheXM6IGNvbXBhY3QgKDIqbkJ5dGVMZW5ndGgpICYgREVSICh2YXJpYWJsZS1sZW5ndGgpLgoJICAgICAgICAgICAgICAgIC8vIFNpbmNlIERFUiBjYW4gYWxzbyBiZSAyKm5CeXRlTGVuZ3RoIGJ5dGVzLCB3ZSBjaGVjayBmb3IgaXQgZmlyc3QuCgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdCAhPT0gJ2NvbXBhY3QnKQoJICAgICAgICAgICAgICAgICAgICAgICAgX3NpZyA9IFNpZ25hdHVyZS5mcm9tREVSKHNnKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY2F0Y2ggKGRlckVycm9yKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmICghKGRlckVycm9yIGluc3RhbmNlb2YgREVSLkVycikpCgkgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBkZXJFcnJvcjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKCFfc2lnICYmIGZvcm1hdCAhPT0gJ2RlcicpCgkgICAgICAgICAgICAgICAgICAgIF9zaWcgPSBTaWduYXR1cmUuZnJvbUNvbXBhY3Qoc2cpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgUCA9IFBvaW50LmZyb21IZXgocHVibGljS2V5KTsKCSAgICAgICAgfQoJICAgICAgICBjYXRjaCAoZXJyb3IpIHsKCSAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgfQoJICAgICAgICBpZiAoIV9zaWcpCgkgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIGlmIChsb3dTICYmIF9zaWcuaGFzSGlnaFMoKSkKCSAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgaWYgKHByZWhhc2gpCgkgICAgICAgICAgICBtc2dIYXNoID0gQ1VSVkUuaGFzaChtc2dIYXNoKTsKCSAgICAgICAgY29uc3QgeyByLCBzIH0gPSBfc2lnOwoJICAgICAgICBjb25zdCBoID0gYml0czJpbnRfbW9kTihtc2dIYXNoKTsgLy8gQ2Fubm90IHVzZSBmaWVsZHMgbWV0aG9kcywgc2luY2UgaXQgaXMgZ3JvdXAgZWxlbWVudAoJICAgICAgICBjb25zdCBpcyA9IGludk4ocyk7IC8vIHNeLTEKCSAgICAgICAgY29uc3QgdTEgPSBtb2ROKGggKiBpcyk7IC8vIHUxID0gaHNeLTEgbW9kIG4KCSAgICAgICAgY29uc3QgdTIgPSBtb2ROKHIgKiBpcyk7IC8vIHUyID0gcnNeLTEgbW9kIG4KCSAgICAgICAgY29uc3QgUiA9IFBvaW50LkJBU0UubXVsdGlwbHlBbmRBZGRVbnNhZmUoUCwgdTEsIHUyKT8udG9BZmZpbmUoKTsgLy8gUiA9IHUx4ouFRyArIHUy4ouFUAoJICAgICAgICBpZiAoIVIpCgkgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIGNvbnN0IHYgPSBtb2ROKFIueCk7CgkgICAgICAgIHJldHVybiB2ID09PSByOwoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgICBDVVJWRSwKCSAgICAgICAgZ2V0UHVibGljS2V5LAoJICAgICAgICBnZXRTaGFyZWRTZWNyZXQsCgkgICAgICAgIHNpZ24sCgkgICAgICAgIHZlcmlmeSwKCSAgICAgICAgUHJvamVjdGl2ZVBvaW50OiBQb2ludCwKCSAgICAgICAgU2lnbmF0dXJlLAoJICAgICAgICB1dGlscywKCSAgICB9OwoJfQoKCS8qISBub2JsZS1jdXJ2ZXMgLSBNSVQgTGljZW5zZSAoYykgMjAyMiBQYXVsIE1pbGxlciAocGF1bG1pbGxyLmNvbSkgKi8KCS8vIGNvbm5lY3RzIG5vYmxlLWN1cnZlcyB0byBub2JsZS1oYXNoZXMKCWZ1bmN0aW9uIGdldEhhc2goaGFzaCkgewoJICAgIHJldHVybiB7CgkgICAgICAgIGhhc2gsCgkgICAgICAgIGhtYWM6IChrZXksIC4uLm1zZ3MpID0+IGhtYWMoaGFzaCwga2V5LCBjb25jYXRCeXRlcyQxKC4uLm1zZ3MpKSwKCSAgICAgICAgcmFuZG9tQnl0ZXMsCgkgICAgfTsKCX0KCWZ1bmN0aW9uIGNyZWF0ZUN1cnZlKGN1cnZlRGVmLCBkZWZIYXNoKSB7CgkgICAgY29uc3QgY3JlYXRlID0gKGhhc2gpID0+IHdlaWVyc3RyYXNzKHsgLi4uY3VydmVEZWYsIC4uLmdldEhhc2goaGFzaCkgfSk7CgkgICAgcmV0dXJuIE9iamVjdC5mcmVlemUoeyAuLi5jcmVhdGUoZGVmSGFzaCksIGNyZWF0ZSB9KTsKCX0KCgkvKiEgbm9ibGUtY3VydmVzIC0gTUlUIExpY2Vuc2UgKGMpIDIwMjIgUGF1bCBNaWxsZXIgKHBhdWxtaWxsci5jb20pICovCgljb25zdCBzZWNwMjU2azFQID0gQmlnSW50KCcweGZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZlZmZmZmZjMmYnKTsKCWNvbnN0IHNlY3AyNTZrMU4gPSBCaWdJbnQoJzB4ZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmViYWFlZGNlNmFmNDhhMDNiYmZkMjVlOGNkMDM2NDE0MScpOwoJY29uc3QgXzFuID0gQmlnSW50KDEpOwoJY29uc3QgXzJuID0gQmlnSW50KDIpOwoJY29uc3QgZGl2TmVhcmVzdCA9IChhLCBiKSA9PiAoYSArIGIgLyBfMm4pIC8gYjsKCS8qKgoJICog4oiabiA9IG5eKChwKzEpLzQpIGZvciBmaWVsZHMgcCA9IDMgbW9kIDQuIFdlIHVud3JhcCB0aGUgbG9vcCBhbmQgbXVsdGlwbHkgYml0LWJ5LWJpdC4KCSAqIChQKzFuLzRuKS50b1N0cmluZygyKSB3b3VsZCBwcm9kdWNlIGJpdHMgWzIyM3ggMSwgMCwgMjJ4IDEsIDR4IDAsIDExLCAwMF0KCSAqLwoJZnVuY3Rpb24gc3FydE1vZCh5KSB7CgkgICAgY29uc3QgUCA9IHNlY3AyNTZrMVA7CgkgICAgLy8gcHJldHRpZXItaWdub3JlCgkgICAgY29uc3QgXzNuID0gQmlnSW50KDMpLCBfNm4gPSBCaWdJbnQoNiksIF8xMW4gPSBCaWdJbnQoMTEpLCBfMjJuID0gQmlnSW50KDIyKTsKCSAgICAvLyBwcmV0dGllci1pZ25vcmUKCSAgICBjb25zdCBfMjNuID0gQmlnSW50KDIzKSwgXzQ0biA9IEJpZ0ludCg0NCksIF84OG4gPSBCaWdJbnQoODgpOwoJICAgIGNvbnN0IGIyID0gKHkgKiB5ICogeSkgJSBQOyAvLyB4XjMsIDExCgkgICAgY29uc3QgYjMgPSAoYjIgKiBiMiAqIHkpICUgUDsgLy8geF43CgkgICAgY29uc3QgYjYgPSAocG93MihiMywgXzNuLCBQKSAqIGIzKSAlIFA7CgkgICAgY29uc3QgYjkgPSAocG93MihiNiwgXzNuLCBQKSAqIGIzKSAlIFA7CgkgICAgY29uc3QgYjExID0gKHBvdzIoYjksIF8ybiwgUCkgKiBiMikgJSBQOwoJICAgIGNvbnN0IGIyMiA9IChwb3cyKGIxMSwgXzExbiwgUCkgKiBiMTEpICUgUDsKCSAgICBjb25zdCBiNDQgPSAocG93MihiMjIsIF8yMm4sIFApICogYjIyKSAlIFA7CgkgICAgY29uc3QgYjg4ID0gKHBvdzIoYjQ0LCBfNDRuLCBQKSAqIGI0NCkgJSBQOwoJICAgIGNvbnN0IGIxNzYgPSAocG93MihiODgsIF84OG4sIFApICogYjg4KSAlIFA7CgkgICAgY29uc3QgYjIyMCA9IChwb3cyKGIxNzYsIF80NG4sIFApICogYjQ0KSAlIFA7CgkgICAgY29uc3QgYjIyMyA9IChwb3cyKGIyMjAsIF8zbiwgUCkgKiBiMykgJSBQOwoJICAgIGNvbnN0IHQxID0gKHBvdzIoYjIyMywgXzIzbiwgUCkgKiBiMjIpICUgUDsKCSAgICBjb25zdCB0MiA9IChwb3cyKHQxLCBfNm4sIFApICogYjIpICUgUDsKCSAgICBjb25zdCByb290ID0gcG93Mih0MiwgXzJuLCBQKTsKCSAgICBpZiAoIUZwazEuZXFsKEZwazEuc3FyKHJvb3QpLCB5KSkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzcXVhcmUgcm9vdCcpOwoJICAgIHJldHVybiByb290OwoJfQoJY29uc3QgRnBrMSA9IEZpZWxkKHNlY3AyNTZrMVAsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB7IHNxcnQ6IHNxcnRNb2QgfSk7CgkvKioKCSAqIHNlY3AyNTZrMSBzaG9ydCB3ZWllcnN0cmFzcyBjdXJ2ZSBhbmQgRUNEU0Egc2lnbmF0dXJlcyBvdmVyIGl0LgoJICovCgljb25zdCBzZWNwMjU2azEgPSBjcmVhdGVDdXJ2ZSh7CgkgICAgYTogQmlnSW50KDApLCAvLyBlcXVhdGlvbiBwYXJhbXM6IGEsIGIKCSAgICBiOiBCaWdJbnQoNyksIC8vIFNlZW0gdG8gYmUgcmlnaWQ6IGJpdGNvaW50YWxrLm9yZy9pbmRleC5waHA/dG9waWM9Mjg5Nzk1Lm1zZzMxODM5NzUjbXNnMzE4Mzk3NQoJICAgIEZwOiBGcGsxLCAvLyBGaWVsZCdzIHByaW1lOiAybioqMjU2biAtIDJuKiozMm4gLSAybioqOW4gLSAybioqOG4gLSAybioqN24gLSAybioqNm4gLSAybioqNG4gLSAxbgoJICAgIG46IHNlY3AyNTZrMU4sIC8vIEN1cnZlIG9yZGVyLCB0b3RhbCBjb3VudCBvZiB2YWxpZCBwb2ludHMgaW4gdGhlIGZpZWxkCgkgICAgLy8gQmFzZSBwb2ludCAoeCwgeSkgYWthIGdlbmVyYXRvciBwb2ludAoJICAgIEd4OiBCaWdJbnQoJzU1MDY2MjYzMDIyMjc3MzQzNjY5NTc4NzE4ODk1MTY4NTM0MzI2MjUwNjAzNDUzNzc3NTk0MTc1NTAwMTg3MzYwMzg5MTE2NzI5MjQwJyksCgkgICAgR3k6IEJpZ0ludCgnMzI2NzA1MTAwMjA3NTg4MTY5NzgwODMwODUxMzA1MDcwNDMxODQ0NzEyNzMzODA2NTkyNDMyNzU5Mzg5MDQzMzU3NTczMzc0ODI0MjQnKSwKCSAgICBoOiBCaWdJbnQoMSksIC8vIENvZmFjdG9yCgkgICAgbG93UzogdHJ1ZSwgLy8gQWxsb3cgb25seSBsb3ctUyBzaWduYXR1cmVzIGJ5IGRlZmF1bHQgaW4gc2lnbigpIGFuZCB2ZXJpZnkoKQoJICAgIC8qKgoJICAgICAqIHNlY3AyNTZrMSBiZWxvbmdzIHRvIEtvYmxpdHogY3VydmVzOiBpdCBoYXMgZWZmaWNpZW50bHkgY29tcHV0YWJsZSBlbmRvbW9ycGhpc20uCgkgICAgICogRW5kb21vcnBoaXNtIHVzZXMgMnggbGVzcyBSQU0sIHNwZWVkcyB1cCBwcmVjb21wdXRhdGlvbiBieSAyeCBhbmQgRUNESCAvIGtleSByZWNvdmVyeSBieSAyMCUuCgkgICAgICogRm9yIHByZWNvbXB1dGVkIHdOQUYgaXQgdHJhZGVzIG9mZiAxLzIgaW5pdCB0aW1lICYgMS8zIHJhbSBmb3IgMjAlIHBlcmYgaGl0LgoJICAgICAqIEV4cGxhbmF0aW9uOiBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9wYXVsbWlsbHIvZWI2NzA4MDY3OTNlODRkZjYyOGE3YzQzNGE4NzMwNjYKCSAgICAgKi8KCSAgICBlbmRvOiB7CgkgICAgICAgIGJldGE6IEJpZ0ludCgnMHg3YWU5NmEyYjY1N2MwNzEwNmU2NDQ3OWVhYzM0MzRlOTljZjA0OTc1MTJmNTg5OTVjMTM5NmMyODcxOTUwMWVlJyksCgkgICAgICAgIHNwbGl0U2NhbGFyOiAoaykgPT4gewoJICAgICAgICAgICAgY29uc3QgbiA9IHNlY3AyNTZrMU47CgkgICAgICAgICAgICBjb25zdCBhMSA9IEJpZ0ludCgnMHgzMDg2ZDIyMWE3ZDQ2YmNkZTg2YzkwZTQ5Mjg0ZWIxNScpOwoJICAgICAgICAgICAgY29uc3QgYjEgPSAtXzFuICogQmlnSW50KCcweGU0NDM3ZWQ2MDEwZTg4Mjg2ZjU0N2ZhOTBhYmZlNGMzJyk7CgkgICAgICAgICAgICBjb25zdCBhMiA9IEJpZ0ludCgnMHgxMTRjYTUwZjdhOGUyZjNmNjU3YzExMDhkOWQ0NGNmZDgnKTsKCSAgICAgICAgICAgIGNvbnN0IGIyID0gYTE7CgkgICAgICAgICAgICBjb25zdCBQT1dfMl8xMjggPSBCaWdJbnQoJzB4MTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwJyk7IC8vICgybioqMTI4bikudG9TdHJpbmcoMTYpCgkgICAgICAgICAgICBjb25zdCBjMSA9IGRpdk5lYXJlc3QoYjIgKiBrLCBuKTsKCSAgICAgICAgICAgIGNvbnN0IGMyID0gZGl2TmVhcmVzdCgtYjEgKiBrLCBuKTsKCSAgICAgICAgICAgIGxldCBrMSA9IG1vZChrIC0gYzEgKiBhMSAtIGMyICogYTIsIG4pOwoJICAgICAgICAgICAgbGV0IGsyID0gbW9kKC1jMSAqIGIxIC0gYzIgKiBiMiwgbik7CgkgICAgICAgICAgICBjb25zdCBrMW5lZyA9IGsxID4gUE9XXzJfMTI4OwoJICAgICAgICAgICAgY29uc3QgazJuZWcgPSBrMiA+IFBPV18yXzEyODsKCSAgICAgICAgICAgIGlmIChrMW5lZykKCSAgICAgICAgICAgICAgICBrMSA9IG4gLSBrMTsKCSAgICAgICAgICAgIGlmIChrMm5lZykKCSAgICAgICAgICAgICAgICBrMiA9IG4gLSBrMjsKCSAgICAgICAgICAgIGlmIChrMSA+IFBPV18yXzEyOCB8fCBrMiA+IFBPV18yXzEyOCkgewoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignc3BsaXRTY2FsYXI6IEVuZG9tb3JwaGlzbSBmYWlsZWQsIGs9JyArIGspOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHsgazFuZWcsIGsxLCBrMm5lZywgazIgfTsKCSAgICAgICAgfSwKCSAgICB9LAoJfSwgc2hhMjU2KTsKCS8vIFNjaG5vcnIgc2lnbmF0dXJlcyBhcmUgc3VwZXJpb3IgdG8gRUNEU0EgZnJvbSBhYm92ZS4gQmVsb3cgaXMgU2Nobm9yci1zcGVjaWZpYyBCSVAwMzQwIGNvZGUuCgkvLyBodHRwczovL2dpdGh1Yi5jb20vYml0Y29pbi9iaXBzL2Jsb2IvbWFzdGVyL2JpcC0wMzQwLm1lZGlhd2lraQoJQmlnSW50KDApOwoJc2VjcDI1NmsxLlByb2plY3RpdmVQb2ludDsKCgljb25zdCBlY2RzYVNpZ24gPSAobXNnSGFzaCwgcHJpdktleSkgPT4gewoJICBjb25zdCBzaWduYXR1cmUgPSBzZWNwMjU2azEuc2lnbihtc2dIYXNoLCBwcml2S2V5KTsKCSAgcmV0dXJuIFtzaWduYXR1cmUudG9Db21wYWN0UmF3Qnl0ZXMoKSwgc2lnbmF0dXJlLnJlY292ZXJ5XTsKCX07CglzZWNwMjU2azEudXRpbHMuaXNWYWxpZFByaXZhdGVLZXk7Cgljb25zdCBwdWJsaWNLZXlDcmVhdGUgPSBzZWNwMjU2azEuZ2V0UHVibGljS2V5OwoKCWNvbnN0IFBSSVZBVEVfS0VZX0JZVEVTID0gMzI7Cgljb25zdCBFVEhFUkVVTV9BRERSRVNTX0JZVEVTID0gMjA7Cgljb25zdCBQVUJMSUNfS0VZX0JZVEVTID0gNjQ7Cgljb25zdCBTSUdOQVRVUkVfT0ZGU0VUU19TRVJJQUxJWkVEX1NJWkUgPSAxMTsKCgkvKioKCSAqIFBhcmFtcyBmb3IgY3JlYXRpbmcgYW4gc2VjcDI1NmsxIGluc3RydWN0aW9uIHVzaW5nIGEgcHVibGljIGtleQoJICovCgoJLyoqCgkgKiBQYXJhbXMgZm9yIGNyZWF0aW5nIGFuIHNlY3AyNTZrMSBpbnN0cnVjdGlvbiB1c2luZyBhbiBFdGhlcmV1bSBhZGRyZXNzCgkgKi8KCgkvKioKCSAqIFBhcmFtcyBmb3IgY3JlYXRpbmcgYW4gc2VjcDI1NmsxIGluc3RydWN0aW9uIHVzaW5nIGEgcHJpdmF0ZSBrZXkKCSAqLwoKCWNvbnN0IFNFQ1AyNTZLMV9JTlNUUlVDVElPTl9MQVlPVVQgPSBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51OCgnbnVtU2lnbmF0dXJlcycpLCBMYXlvdXRFeHBvcnRzLnUxNignc2lnbmF0dXJlT2Zmc2V0JyksIExheW91dEV4cG9ydHMudTgoJ3NpZ25hdHVyZUluc3RydWN0aW9uSW5kZXgnKSwgTGF5b3V0RXhwb3J0cy51MTYoJ2V0aEFkZHJlc3NPZmZzZXQnKSwgTGF5b3V0RXhwb3J0cy51OCgnZXRoQWRkcmVzc0luc3RydWN0aW9uSW5kZXgnKSwgTGF5b3V0RXhwb3J0cy51MTYoJ21lc3NhZ2VEYXRhT2Zmc2V0JyksIExheW91dEV4cG9ydHMudTE2KCdtZXNzYWdlRGF0YVNpemUnKSwgTGF5b3V0RXhwb3J0cy51OCgnbWVzc2FnZUluc3RydWN0aW9uSW5kZXgnKSwgTGF5b3V0RXhwb3J0cy5ibG9iKDIwLCAnZXRoQWRkcmVzcycpLCBMYXlvdXRFeHBvcnRzLmJsb2IoNjQsICdzaWduYXR1cmUnKSwgTGF5b3V0RXhwb3J0cy51OCgncmVjb3ZlcnlJZCcpXSk7CgljbGFzcyBTZWNwMjU2azFQcm9ncmFtIHsKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgY29uc3RydWN0b3IoKSB7fQoKCSAgLyoqCgkgICAqIFB1YmxpYyBrZXkgdGhhdCBpZGVudGlmaWVzIHRoZSBzZWNwMjU2azEgcHJvZ3JhbQoJICAgKi8KCgkgIC8qKgoJICAgKiBDb25zdHJ1Y3QgYW4gRXRoZXJldW0gYWRkcmVzcyBmcm9tIGEgc2VjcDI1NmsxIHB1YmxpYyBrZXkgYnVmZmVyLgoJICAgKiBAcGFyYW0ge0J1ZmZlcn0gcHVibGljS2V5IGEgNjQgYnl0ZSBzZWNwMjU2azEgcHVibGljIGtleSBidWZmZXIKCSAgICovCgkgIHN0YXRpYyBwdWJsaWNLZXlUb0V0aEFkZHJlc3MocHVibGljS2V5KSB7CgkgICAgYXNzZXJ0JDEocHVibGljS2V5Lmxlbmd0aCA9PT0gUFVCTElDX0tFWV9CWVRFUywgYFB1YmxpYyBrZXkgbXVzdCBiZSAke1BVQkxJQ19LRVlfQllURVN9IGJ5dGVzIGJ1dCByZWNlaXZlZCAke3B1YmxpY0tleS5sZW5ndGh9IGJ5dGVzYCk7CgkgICAgdHJ5IHsKCSAgICAgIHJldHVybiBidWZmZXJFeHBvcnRzLkJ1ZmZlci5mcm9tKGtlY2Nha18yNTYodG9CdWZmZXIocHVibGljS2V5KSkpLnNsaWNlKC1FVEhFUkVVTV9BRERSRVNTX0JZVEVTKTsKCSAgICB9IGNhdGNoIChlcnJvcikgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvciBjb25zdHJ1Y3RpbmcgRXRoZXJldW0gYWRkcmVzczogJHtlcnJvcn1gKTsKCSAgICB9CgkgIH0KCgkgIC8qKgoJICAgKiBDcmVhdGUgYW4gc2VjcDI1NmsxIGluc3RydWN0aW9uIHdpdGggYSBwdWJsaWMga2V5LiBUaGUgcHVibGljIGtleQoJICAgKiBtdXN0IGJlIGEgYnVmZmVyIHRoYXQgaXMgNjQgYnl0ZXMgbG9uZy4KCSAgICovCgkgIHN0YXRpYyBjcmVhdGVJbnN0cnVjdGlvbldpdGhQdWJsaWNLZXkocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgcHVibGljS2V5LAoJICAgICAgbWVzc2FnZSwKCSAgICAgIHNpZ25hdHVyZSwKCSAgICAgIHJlY292ZXJ5SWQsCgkgICAgICBpbnN0cnVjdGlvbkluZGV4CgkgICAgfSA9IHBhcmFtczsKCSAgICByZXR1cm4gU2VjcDI1NmsxUHJvZ3JhbS5jcmVhdGVJbnN0cnVjdGlvbldpdGhFdGhBZGRyZXNzKHsKCSAgICAgIGV0aEFkZHJlc3M6IFNlY3AyNTZrMVByb2dyYW0ucHVibGljS2V5VG9FdGhBZGRyZXNzKHB1YmxpY0tleSksCgkgICAgICBtZXNzYWdlLAoJICAgICAgc2lnbmF0dXJlLAoJICAgICAgcmVjb3ZlcnlJZCwKCSAgICAgIGluc3RydWN0aW9uSW5kZXgKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIENyZWF0ZSBhbiBzZWNwMjU2azEgaW5zdHJ1Y3Rpb24gd2l0aCBhbiBFdGhlcmV1bSBhZGRyZXNzLiBUaGUgYWRkcmVzcwoJICAgKiBtdXN0IGJlIGEgaGV4IHN0cmluZyBvciBhIGJ1ZmZlciB0aGF0IGlzIDIwIGJ5dGVzIGxvbmcuCgkgICAqLwoJICBzdGF0aWMgY3JlYXRlSW5zdHJ1Y3Rpb25XaXRoRXRoQWRkcmVzcyhwYXJhbXMpIHsKCSAgICBjb25zdCB7CgkgICAgICBldGhBZGRyZXNzOiByYXdBZGRyZXNzLAoJICAgICAgbWVzc2FnZSwKCSAgICAgIHNpZ25hdHVyZSwKCSAgICAgIHJlY292ZXJ5SWQsCgkgICAgICBpbnN0cnVjdGlvbkluZGV4ID0gMAoJICAgIH0gPSBwYXJhbXM7CgkgICAgbGV0IGV0aEFkZHJlc3M7CgkgICAgaWYgKHR5cGVvZiByYXdBZGRyZXNzID09PSAnc3RyaW5nJykgewoJICAgICAgaWYgKHJhd0FkZHJlc3Muc3RhcnRzV2l0aCgnMHgnKSkgewoJICAgICAgICBldGhBZGRyZXNzID0gYnVmZmVyRXhwb3J0cy5CdWZmZXIuZnJvbShyYXdBZGRyZXNzLnN1YnN0cigyKSwgJ2hleCcpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgZXRoQWRkcmVzcyA9IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20ocmF3QWRkcmVzcywgJ2hleCcpOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICBldGhBZGRyZXNzID0gcmF3QWRkcmVzczsKCSAgICB9CgkgICAgYXNzZXJ0JDEoZXRoQWRkcmVzcy5sZW5ndGggPT09IEVUSEVSRVVNX0FERFJFU1NfQllURVMsIGBBZGRyZXNzIG11c3QgYmUgJHtFVEhFUkVVTV9BRERSRVNTX0JZVEVTfSBieXRlcyBidXQgcmVjZWl2ZWQgJHtldGhBZGRyZXNzLmxlbmd0aH0gYnl0ZXNgKTsKCSAgICBjb25zdCBkYXRhU3RhcnQgPSAxICsgU0lHTkFUVVJFX09GRlNFVFNfU0VSSUFMSVpFRF9TSVpFOwoJICAgIGNvbnN0IGV0aEFkZHJlc3NPZmZzZXQgPSBkYXRhU3RhcnQ7CgkgICAgY29uc3Qgc2lnbmF0dXJlT2Zmc2V0ID0gZGF0YVN0YXJ0ICsgZXRoQWRkcmVzcy5sZW5ndGg7CgkgICAgY29uc3QgbWVzc2FnZURhdGFPZmZzZXQgPSBzaWduYXR1cmVPZmZzZXQgKyBzaWduYXR1cmUubGVuZ3RoICsgMTsKCSAgICBjb25zdCBudW1TaWduYXR1cmVzID0gMTsKCSAgICBjb25zdCBpbnN0cnVjdGlvbkRhdGEgPSBidWZmZXJFeHBvcnRzLkJ1ZmZlci5hbGxvYyhTRUNQMjU2SzFfSU5TVFJVQ1RJT05fTEFZT1VULnNwYW4gKyBtZXNzYWdlLmxlbmd0aCk7CgkgICAgU0VDUDI1NksxX0lOU1RSVUNUSU9OX0xBWU9VVC5lbmNvZGUoewoJICAgICAgbnVtU2lnbmF0dXJlcywKCSAgICAgIHNpZ25hdHVyZU9mZnNldCwKCSAgICAgIHNpZ25hdHVyZUluc3RydWN0aW9uSW5kZXg6IGluc3RydWN0aW9uSW5kZXgsCgkgICAgICBldGhBZGRyZXNzT2Zmc2V0LAoJICAgICAgZXRoQWRkcmVzc0luc3RydWN0aW9uSW5kZXg6IGluc3RydWN0aW9uSW5kZXgsCgkgICAgICBtZXNzYWdlRGF0YU9mZnNldCwKCSAgICAgIG1lc3NhZ2VEYXRhU2l6ZTogbWVzc2FnZS5sZW5ndGgsCgkgICAgICBtZXNzYWdlSW5zdHJ1Y3Rpb25JbmRleDogaW5zdHJ1Y3Rpb25JbmRleCwKCSAgICAgIHNpZ25hdHVyZTogdG9CdWZmZXIoc2lnbmF0dXJlKSwKCSAgICAgIGV0aEFkZHJlc3M6IHRvQnVmZmVyKGV0aEFkZHJlc3MpLAoJICAgICAgcmVjb3ZlcnlJZAoJICAgIH0sIGluc3RydWN0aW9uRGF0YSk7CgkgICAgaW5zdHJ1Y3Rpb25EYXRhLmZpbGwodG9CdWZmZXIobWVzc2FnZSksIFNFQ1AyNTZLMV9JTlNUUlVDVElPTl9MQVlPVVQuc3Bhbik7CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbkluc3RydWN0aW9uKHsKCSAgICAgIGtleXM6IFtdLAoJICAgICAgcHJvZ3JhbUlkOiBTZWNwMjU2azFQcm9ncmFtLnByb2dyYW1JZCwKCSAgICAgIGRhdGE6IGluc3RydWN0aW9uRGF0YQoJICAgIH0pOwoJICB9CgoJICAvKioKCSAgICogQ3JlYXRlIGFuIHNlY3AyNTZrMSBpbnN0cnVjdGlvbiB3aXRoIGEgcHJpdmF0ZSBrZXkuIFRoZSBwcml2YXRlIGtleQoJICAgKiBtdXN0IGJlIGEgYnVmZmVyIHRoYXQgaXMgMzIgYnl0ZXMgbG9uZy4KCSAgICovCgkgIHN0YXRpYyBjcmVhdGVJbnN0cnVjdGlvbldpdGhQcml2YXRlS2V5KHBhcmFtcykgewoJICAgIGNvbnN0IHsKCSAgICAgIHByaXZhdGVLZXk6IHBrZXksCgkgICAgICBtZXNzYWdlLAoJICAgICAgaW5zdHJ1Y3Rpb25JbmRleAoJICAgIH0gPSBwYXJhbXM7CgkgICAgYXNzZXJ0JDEocGtleS5sZW5ndGggPT09IFBSSVZBVEVfS0VZX0JZVEVTLCBgUHJpdmF0ZSBrZXkgbXVzdCBiZSAke1BSSVZBVEVfS0VZX0JZVEVTfSBieXRlcyBidXQgcmVjZWl2ZWQgJHtwa2V5Lmxlbmd0aH0gYnl0ZXNgKTsKCSAgICB0cnkgewoJICAgICAgY29uc3QgcHJpdmF0ZUtleSA9IHRvQnVmZmVyKHBrZXkpOwoJICAgICAgY29uc3QgcHVibGljS2V5ID0gcHVibGljS2V5Q3JlYXRlKHByaXZhdGVLZXksIGZhbHNlIC8qIGlzQ29tcHJlc3NlZCAqLykuc2xpY2UoMSk7IC8vIHRocm93IGF3YXkgbGVhZGluZyBieXRlCgkgICAgICBjb25zdCBtZXNzYWdlSGFzaCA9IGJ1ZmZlckV4cG9ydHMuQnVmZmVyLmZyb20oa2VjY2FrXzI1Nih0b0J1ZmZlcihtZXNzYWdlKSkpOwoJICAgICAgY29uc3QgW3NpZ25hdHVyZSwgcmVjb3ZlcnlJZF0gPSBlY2RzYVNpZ24obWVzc2FnZUhhc2gsIHByaXZhdGVLZXkpOwoJICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlSW5zdHJ1Y3Rpb25XaXRoUHVibGljS2V5KHsKCSAgICAgICAgcHVibGljS2V5LAoJICAgICAgICBtZXNzYWdlLAoJICAgICAgICBzaWduYXR1cmUsCgkgICAgICAgIHJlY292ZXJ5SWQsCgkgICAgICAgIGluc3RydWN0aW9uSW5kZXgKCSAgICAgIH0pOwoJICAgIH0gY2F0Y2ggKGVycm9yKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVycm9yIGNyZWF0aW5nIGluc3RydWN0aW9uOyAke2Vycm9yfWApOwoJICAgIH0KCSAgfQoJfQoJU2VjcDI1NmsxUHJvZ3JhbS5wcm9ncmFtSWQgPSBuZXcgUHVibGljS2V5KCdLZWNjYWtTZWNwMjU2azExMTExMTExMTExMTExMTExMTExMTExMTExMTExJyk7CgoJdmFyIF9Mb2NrdXA7CgoJLyoqCgkgKiBBZGRyZXNzIG9mIHRoZSBzdGFrZSBjb25maWcgYWNjb3VudCB3aGljaCBjb25maWd1cmVzIHRoZSByYXRlCgkgKiBvZiBzdGFrZSB3YXJtdXAgYW5kIGNvb2xkb3duIGFzIHdlbGwgYXMgdGhlIHNsYXNoaW5nIHBlbmFsdHkuCgkgKi8KCWNvbnN0IFNUQUtFX0NPTkZJR19JRCA9IG5ldyBQdWJsaWNLZXkoJ1N0YWtlQ29uZmlnMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEnKTsKCgkvKioKCSAqIFN0YWtlIGFjY291bnQgYXV0aG9yaXR5IGluZm8KCSAqLwoJY2xhc3MgQXV0aG9yaXplZCB7CgkgIC8qKgoJICAgKiBDcmVhdGUgYSBuZXcgQXV0aG9yaXplZCBvYmplY3QKCSAgICogQHBhcmFtIHN0YWtlciB0aGUgc3Rha2UgYXV0aG9yaXR5CgkgICAqIEBwYXJhbSB3aXRoZHJhd2VyIHRoZSB3aXRoZHJhdyBhdXRob3JpdHkKCSAgICovCgkgIGNvbnN0cnVjdG9yKHN0YWtlciwgd2l0aGRyYXdlcikgewoJICAgIC8qKiBzdGFrZSBhdXRob3JpdHkgKi8KCSAgICB0aGlzLnN0YWtlciA9IHZvaWQgMDsKCSAgICAvKiogd2l0aGRyYXcgYXV0aG9yaXR5ICovCgkgICAgdGhpcy53aXRoZHJhd2VyID0gdm9pZCAwOwoJICAgIHRoaXMuc3Rha2VyID0gc3Rha2VyOwoJICAgIHRoaXMud2l0aGRyYXdlciA9IHdpdGhkcmF3ZXI7CgkgIH0KCX0KCS8qKgoJICogU3Rha2UgYWNjb3VudCBsb2NrdXAgaW5mbwoJICovCgljbGFzcyBMb2NrdXAgewoJICAvKioKCSAgICogQ3JlYXRlIGEgbmV3IExvY2t1cCBvYmplY3QKCSAgICovCgkgIGNvbnN0cnVjdG9yKHVuaXhUaW1lc3RhbXAsIGVwb2NoLCBjdXN0b2RpYW4pIHsKCSAgICAvKiogVW5peCB0aW1lc3RhbXAgb2YgbG9ja3VwIGV4cGlyYXRpb24gKi8KCSAgICB0aGlzLnVuaXhUaW1lc3RhbXAgPSB2b2lkIDA7CgkgICAgLyoqIEVwb2NoIG9mIGxvY2t1cCBleHBpcmF0aW9uICovCgkgICAgdGhpcy5lcG9jaCA9IHZvaWQgMDsKCSAgICAvKiogTG9ja3VwIGN1c3RvZGlhbiBhdXRob3JpdHkgKi8KCSAgICB0aGlzLmN1c3RvZGlhbiA9IHZvaWQgMDsKCSAgICB0aGlzLnVuaXhUaW1lc3RhbXAgPSB1bml4VGltZXN0YW1wOwoJICAgIHRoaXMuZXBvY2ggPSBlcG9jaDsKCSAgICB0aGlzLmN1c3RvZGlhbiA9IGN1c3RvZGlhbjsKCSAgfQoKCSAgLyoqCgkgICAqIERlZmF1bHQsIGluYWN0aXZlIExvY2t1cCB2YWx1ZQoJICAgKi8KCX0KCV9Mb2NrdXAgPSBMb2NrdXA7CglMb2NrdXAuZGVmYXVsdCA9IG5ldyBfTG9ja3VwKDAsIDAsIFB1YmxpY0tleS5kZWZhdWx0KTsKCS8qKgoJICogQ3JlYXRlIHN0YWtlIGFjY291bnQgdHJhbnNhY3Rpb24gcGFyYW1zCgkgKi8KCS8qKgoJICogQ3JlYXRlIHN0YWtlIGFjY291bnQgd2l0aCBzZWVkIHRyYW5zYWN0aW9uIHBhcmFtcwoJICovCgkvKioKCSAqIEluaXRpYWxpemUgc3Rha2UgaW5zdHJ1Y3Rpb24gcGFyYW1zCgkgKi8KCS8qKgoJICogRGVsZWdhdGUgc3Rha2UgaW5zdHJ1Y3Rpb24gcGFyYW1zCgkgKi8KCS8qKgoJICogQXV0aG9yaXplIHN0YWtlIGluc3RydWN0aW9uIHBhcmFtcwoJICovCgkvKioKCSAqIEF1dGhvcml6ZSBzdGFrZSBpbnN0cnVjdGlvbiBwYXJhbXMgdXNpbmcgYSBkZXJpdmVkIGtleQoJICovCgkvKioKCSAqIFNwbGl0IHN0YWtlIGluc3RydWN0aW9uIHBhcmFtcwoJICovCgkvKioKCSAqIFNwbGl0IHdpdGggc2VlZCB0cmFuc2FjdGlvbiBwYXJhbXMKCSAqLwoJLyoqCgkgKiBXaXRoZHJhdyBzdGFrZSBpbnN0cnVjdGlvbiBwYXJhbXMKCSAqLwoJLyoqCgkgKiBEZWFjdGl2YXRlIHN0YWtlIGluc3RydWN0aW9uIHBhcmFtcwoJICovCgkvKioKCSAqIE1lcmdlIHN0YWtlIGluc3RydWN0aW9uIHBhcmFtcwoJICovCgkvKioKCSAqIFN0YWtlIEluc3RydWN0aW9uIGNsYXNzCgkgKi8KCWNsYXNzIFN0YWtlSW5zdHJ1Y3Rpb24gewoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBjb25zdHJ1Y3RvcigpIHt9CgoJICAvKioKCSAgICogRGVjb2RlIGEgc3Rha2UgaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiB0eXBlLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZUluc3RydWN0aW9uVHlwZShpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICBjb25zdCBpbnN0cnVjdGlvblR5cGVMYXlvdXQgPSBMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKTsKCSAgICBjb25zdCB0eXBlSW5kZXggPSBpbnN0cnVjdGlvblR5cGVMYXlvdXQuZGVjb2RlKGluc3RydWN0aW9uLmRhdGEpOwoJICAgIGxldCB0eXBlOwoJICAgIGZvciAoY29uc3QgW2l4VHlwZSwgbGF5b3V0XSBvZiBPYmplY3QuZW50cmllcyhTVEFLRV9JTlNUUlVDVElPTl9MQVlPVVRTKSkgewoJICAgICAgaWYgKGxheW91dC5pbmRleCA9PSB0eXBlSW5kZXgpIHsKCSAgICAgICAgdHlwZSA9IGl4VHlwZTsKCSAgICAgICAgYnJlYWs7CgkgICAgICB9CgkgICAgfQoJICAgIGlmICghdHlwZSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnN0cnVjdGlvbiB0eXBlIGluY29ycmVjdDsgbm90IGEgU3Rha2VJbnN0cnVjdGlvbicpOwoJICAgIH0KCSAgICByZXR1cm4gdHlwZTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhIGluaXRpYWxpemUgc3Rha2UgaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlSW5pdGlhbGl6ZShpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICB0aGlzLmNoZWNrS2V5TGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDIpOwoJICAgIGNvbnN0IHsKCSAgICAgIGF1dGhvcml6ZWQsCgkgICAgICBsb2NrdXAKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuSW5pdGlhbGl6ZSwgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgcmV0dXJuIHsKCSAgICAgIHN0YWtlUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIGF1dGhvcml6ZWQ6IG5ldyBBdXRob3JpemVkKG5ldyBQdWJsaWNLZXkoYXV0aG9yaXplZC5zdGFrZXIpLCBuZXcgUHVibGljS2V5KGF1dGhvcml6ZWQud2l0aGRyYXdlcikpLAoJICAgICAgbG9ja3VwOiBuZXcgTG9ja3VwKGxvY2t1cC51bml4VGltZXN0YW1wLCBsb2NrdXAuZXBvY2gsIG5ldyBQdWJsaWNLZXkobG9ja3VwLmN1c3RvZGlhbikpCgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhIGRlbGVnYXRlIHN0YWtlIGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZURlbGVnYXRlKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIHRoaXMuY2hlY2tLZXlMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgNik7CgkgICAgZGVjb2RlRGF0YSQxKFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuRGVsZWdhdGUsIGluc3RydWN0aW9uLmRhdGEpOwoJICAgIHJldHVybiB7CgkgICAgICBzdGFrZVB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICB2b3RlUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzFdLnB1YmtleSwKCSAgICAgIGF1dGhvcml6ZWRQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbNV0ucHVia2V5CgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhbiBhdXRob3JpemUgc3Rha2UgaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlQXV0aG9yaXplKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIHRoaXMuY2hlY2tLZXlMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMyk7CgkgICAgY29uc3QgewoJICAgICAgbmV3QXV0aG9yaXplZCwKCSAgICAgIHN0YWtlQXV0aG9yaXphdGlvblR5cGUKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuQXV0aG9yaXplLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICBjb25zdCBvID0gewoJICAgICAgc3Rha2VQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgYXV0aG9yaXplZFB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1syXS5wdWJrZXksCgkgICAgICBuZXdBdXRob3JpemVkUHVia2V5OiBuZXcgUHVibGljS2V5KG5ld0F1dGhvcml6ZWQpLAoJICAgICAgc3Rha2VBdXRob3JpemF0aW9uVHlwZTogewoJICAgICAgICBpbmRleDogc3Rha2VBdXRob3JpemF0aW9uVHlwZQoJICAgICAgfQoJICAgIH07CgkgICAgaWYgKGluc3RydWN0aW9uLmtleXMubGVuZ3RoID4gMykgewoJICAgICAgby5jdXN0b2RpYW5QdWJrZXkgPSBpbnN0cnVjdGlvbi5rZXlzWzNdLnB1YmtleTsKCSAgICB9CgkgICAgcmV0dXJuIG87CgkgIH0KCgkgIC8qKgoJICAgKiBEZWNvZGUgYW4gYXV0aG9yaXplLXdpdGgtc2VlZCBzdGFrZSBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVBdXRob3JpemVXaXRoU2VlZChpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICB0aGlzLmNoZWNrS2V5TGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDIpOwoJICAgIGNvbnN0IHsKCSAgICAgIG5ld0F1dGhvcml6ZWQsCgkgICAgICBzdGFrZUF1dGhvcml6YXRpb25UeXBlLAoJICAgICAgYXV0aG9yaXR5U2VlZCwKCSAgICAgIGF1dGhvcml0eU93bmVyCgkgICAgfSA9IGRlY29kZURhdGEkMShTVEFLRV9JTlNUUlVDVElPTl9MQVlPVVRTLkF1dGhvcml6ZVdpdGhTZWVkLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICBjb25zdCBvID0gewoJICAgICAgc3Rha2VQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgYXV0aG9yaXR5QmFzZTogaW5zdHJ1Y3Rpb24ua2V5c1sxXS5wdWJrZXksCgkgICAgICBhdXRob3JpdHlTZWVkOiBhdXRob3JpdHlTZWVkLAoJICAgICAgYXV0aG9yaXR5T3duZXI6IG5ldyBQdWJsaWNLZXkoYXV0aG9yaXR5T3duZXIpLAoJICAgICAgbmV3QXV0aG9yaXplZFB1YmtleTogbmV3IFB1YmxpY0tleShuZXdBdXRob3JpemVkKSwKCSAgICAgIHN0YWtlQXV0aG9yaXphdGlvblR5cGU6IHsKCSAgICAgICAgaW5kZXg6IHN0YWtlQXV0aG9yaXphdGlvblR5cGUKCSAgICAgIH0KCSAgICB9OwoJICAgIGlmIChpbnN0cnVjdGlvbi5rZXlzLmxlbmd0aCA+IDMpIHsKCSAgICAgIG8uY3VzdG9kaWFuUHVia2V5ID0gaW5zdHJ1Y3Rpb24ua2V5c1szXS5wdWJrZXk7CgkgICAgfQoJICAgIHJldHVybiBvOwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGEgc3BsaXQgc3Rha2UgaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlU3BsaXQoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCAzKTsKCSAgICBjb25zdCB7CgkgICAgICBsYW1wb3J0cwoJICAgIH0gPSBkZWNvZGVEYXRhJDEoU1RBS0VfSU5TVFJVQ1RJT05fTEFZT1VUUy5TcGxpdCwgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgcmV0dXJuIHsKCSAgICAgIHN0YWtlUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIHNwbGl0U3Rha2VQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMV0ucHVia2V5LAoJICAgICAgYXV0aG9yaXplZFB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1syXS5wdWJrZXksCgkgICAgICBsYW1wb3J0cwoJICAgIH07CgkgIH0KCgkgIC8qKgoJICAgKiBEZWNvZGUgYSBtZXJnZSBzdGFrZSBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVNZXJnZShpbnN0cnVjdGlvbikgewoJICAgIHRoaXMuY2hlY2tQcm9ncmFtSWQoaW5zdHJ1Y3Rpb24ucHJvZ3JhbUlkKTsKCSAgICB0aGlzLmNoZWNrS2V5TGVuZ3RoKGluc3RydWN0aW9uLmtleXMsIDMpOwoJICAgIGRlY29kZURhdGEkMShTVEFLRV9JTlNUUlVDVElPTl9MQVlPVVRTLk1lcmdlLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgc3Rha2VQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgc291cmNlU3Rha2VQdWJLZXk6IGluc3RydWN0aW9uLmtleXNbMV0ucHVia2V5LAoJICAgICAgYXV0aG9yaXplZFB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1s0XS5wdWJrZXkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGEgd2l0aGRyYXcgc3Rha2UgaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlV2l0aGRyYXcoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCA1KTsKCSAgICBjb25zdCB7CgkgICAgICBsYW1wb3J0cwoJICAgIH0gPSBkZWNvZGVEYXRhJDEoU1RBS0VfSU5TVFJVQ1RJT05fTEFZT1VUUy5XaXRoZHJhdywgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgY29uc3QgbyA9IHsKCSAgICAgIHN0YWtlUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIHRvUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzFdLnB1YmtleSwKCSAgICAgIGF1dGhvcml6ZWRQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbNF0ucHVia2V5LAoJICAgICAgbGFtcG9ydHMKCSAgICB9OwoJICAgIGlmIChpbnN0cnVjdGlvbi5rZXlzLmxlbmd0aCA+IDUpIHsKCSAgICAgIG8uY3VzdG9kaWFuUHVia2V5ID0gaW5zdHJ1Y3Rpb24ua2V5c1s1XS5wdWJrZXk7CgkgICAgfQoJICAgIHJldHVybiBvOwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGEgZGVhY3RpdmF0ZSBzdGFrZSBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVEZWFjdGl2YXRlKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIHRoaXMuY2hlY2tLZXlMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMyk7CgkgICAgZGVjb2RlRGF0YSQxKFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuRGVhY3RpdmF0ZSwgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgcmV0dXJuIHsKCSAgICAgIHN0YWtlUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzBdLnB1YmtleSwKCSAgICAgIGF1dGhvcml6ZWRQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMl0ucHVia2V5CgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgc3RhdGljIGNoZWNrUHJvZ3JhbUlkKHByb2dyYW1JZCkgewoJICAgIGlmICghcHJvZ3JhbUlkLmVxdWFscyhTdGFrZVByb2dyYW0ucHJvZ3JhbUlkKSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGluc3RydWN0aW9uOyBwcm9ncmFtSWQgaXMgbm90IFN0YWtlUHJvZ3JhbScpOwoJICAgIH0KCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgc3RhdGljIGNoZWNrS2V5TGVuZ3RoKGtleXMsIGV4cGVjdGVkTGVuZ3RoKSB7CgkgICAgaWYgKGtleXMubGVuZ3RoIDwgZXhwZWN0ZWRMZW5ndGgpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBpbnN0cnVjdGlvbjsgZm91bmQgJHtrZXlzLmxlbmd0aH0ga2V5cywgZXhwZWN0ZWQgYXQgbGVhc3QgJHtleHBlY3RlZExlbmd0aH1gKTsKCSAgICB9CgkgIH0KCX0KCgkvKioKCSAqIEFuIGVudW1lcmF0aW9uIG9mIHZhbGlkIFN0YWtlSW5zdHJ1Y3Rpb25UeXBlJ3MKCSAqLwoKCS8qKgoJICogQW4gZW51bWVyYXRpb24gb2YgdmFsaWQgc3Rha2UgSW5zdHJ1Y3Rpb25UeXBlJ3MKCSAqIEBpbnRlcm5hbAoJICovCgljb25zdCBTVEFLRV9JTlNUUlVDVElPTl9MQVlPVVRTID0gT2JqZWN0LmZyZWV6ZSh7CgkgIEluaXRpYWxpemU6IHsKCSAgICBpbmRleDogMCwKCSAgICBsYXlvdXQ6IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgYXV0aG9yaXplZCgpLCBsb2NrdXAoKV0pCgkgIH0sCgkgIEF1dGhvcml6ZTogewoJICAgIGluZGV4OiAxLAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpLCBwdWJsaWNLZXkoJ25ld0F1dGhvcml6ZWQnKSwgTGF5b3V0RXhwb3J0cy51MzIoJ3N0YWtlQXV0aG9yaXphdGlvblR5cGUnKV0pCgkgIH0sCgkgIERlbGVnYXRlOiB7CgkgICAgaW5kZXg6IDIsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyldKQoJICB9LAoJICBTcGxpdDogewoJICAgIGluZGV4OiAzLAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpLCBMYXlvdXRFeHBvcnRzLm5zNjQoJ2xhbXBvcnRzJyldKQoJICB9LAoJICBXaXRoZHJhdzogewoJICAgIGluZGV4OiA0LAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpLCBMYXlvdXRFeHBvcnRzLm5zNjQoJ2xhbXBvcnRzJyldKQoJICB9LAoJICBEZWFjdGl2YXRlOiB7CgkgICAgaW5kZXg6IDUsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyldKQoJICB9LAoJICBNZXJnZTogewoJICAgIGluZGV4OiA3LAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpXSkKCSAgfSwKCSAgQXV0aG9yaXplV2l0aFNlZWQ6IHsKCSAgICBpbmRleDogOCwKCSAgICBsYXlvdXQ6IExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLnUzMignaW5zdHJ1Y3Rpb24nKSwgcHVibGljS2V5KCduZXdBdXRob3JpemVkJyksIExheW91dEV4cG9ydHMudTMyKCdzdGFrZUF1dGhvcml6YXRpb25UeXBlJyksIHJ1c3RTdHJpbmcoJ2F1dGhvcml0eVNlZWQnKSwgcHVibGljS2V5KCdhdXRob3JpdHlPd25lcicpXSkKCSAgfQoJfSk7CgoJLyoqCgkgKiBTdGFrZSBhdXRob3JpemF0aW9uIHR5cGUKCSAqLwoKCS8qKgoJICogQW4gZW51bWVyYXRpb24gb2YgdmFsaWQgU3Rha2VBdXRob3JpemF0aW9uTGF5b3V0J3MKCSAqLwoJY29uc3QgU3Rha2VBdXRob3JpemF0aW9uTGF5b3V0ID0gT2JqZWN0LmZyZWV6ZSh7CgkgIFN0YWtlcjogewoJICAgIGluZGV4OiAwCgkgIH0sCgkgIFdpdGhkcmF3ZXI6IHsKCSAgICBpbmRleDogMQoJICB9Cgl9KTsKCgkvKioKCSAqIEZhY3RvcnkgY2xhc3MgZm9yIHRyYW5zYWN0aW9ucyB0byBpbnRlcmFjdCB3aXRoIHRoZSBTdGFrZSBwcm9ncmFtCgkgKi8KCWNsYXNzIFN0YWtlUHJvZ3JhbSB7CgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIGNvbnN0cnVjdG9yKCkge30KCgkgIC8qKgoJICAgKiBQdWJsaWMga2V5IHRoYXQgaWRlbnRpZmllcyB0aGUgU3Rha2UgcHJvZ3JhbQoJICAgKi8KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhbiBJbml0aWFsaXplIGluc3RydWN0aW9uIHRvIGFkZCB0byBhIFN0YWtlIENyZWF0ZSB0cmFuc2FjdGlvbgoJICAgKi8KCSAgc3RhdGljIGluaXRpYWxpemUocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpemVkLAoJICAgICAgbG9ja3VwOiBtYXliZUxvY2t1cAoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgbG9ja3VwID0gbWF5YmVMb2NrdXAgfHwgTG9ja3VwLmRlZmF1bHQ7CgkgICAgY29uc3QgdHlwZSA9IFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuSW5pdGlhbGl6ZTsKCSAgICBjb25zdCBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICBhdXRob3JpemVkOiB7CgkgICAgICAgIHN0YWtlcjogdG9CdWZmZXIoYXV0aG9yaXplZC5zdGFrZXIudG9CdWZmZXIoKSksCgkgICAgICAgIHdpdGhkcmF3ZXI6IHRvQnVmZmVyKGF1dGhvcml6ZWQud2l0aGRyYXdlci50b0J1ZmZlcigpKQoJICAgICAgfSwKCSAgICAgIGxvY2t1cDogewoJICAgICAgICB1bml4VGltZXN0YW1wOiBsb2NrdXAudW5peFRpbWVzdGFtcCwKCSAgICAgICAgZXBvY2g6IGxvY2t1cC5lcG9jaCwKCSAgICAgICAgY3VzdG9kaWFuOiB0b0J1ZmZlcihsb2NrdXAuY3VzdG9kaWFuLnRvQnVmZmVyKCkpCgkgICAgICB9CgkgICAgfSk7CgkgICAgY29uc3QgaW5zdHJ1Y3Rpb25EYXRhID0gewoJICAgICAga2V5czogW3sKCSAgICAgICAgcHVia2V5OiBzdGFrZVB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogU1lTVkFSX1JFTlRfUFVCS0VZLAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9XSwKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQsCgkgICAgICBkYXRhCgkgICAgfTsKCSAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24oaW5zdHJ1Y3Rpb25EYXRhKTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgVHJhbnNhY3Rpb24gdGhhdCBjcmVhdGVzIGEgbmV3IFN0YWtlIGFjY291bnQgYXQKCSAgICogICBhbiBhZGRyZXNzIGdlbmVyYXRlZCB3aXRoIGBmcm9tYCwgYSBzZWVkLCBhbmQgdGhlIFN0YWtlIHByb2dyYW1JZAoJICAgKi8KCSAgc3RhdGljIGNyZWF0ZUFjY291bnRXaXRoU2VlZChwYXJhbXMpIHsKCSAgICBjb25zdCB0cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpOwoJICAgIHRyYW5zYWN0aW9uLmFkZChTeXN0ZW1Qcm9ncmFtLmNyZWF0ZUFjY291bnRXaXRoU2VlZCh7CgkgICAgICBmcm9tUHVia2V5OiBwYXJhbXMuZnJvbVB1YmtleSwKCSAgICAgIG5ld0FjY291bnRQdWJrZXk6IHBhcmFtcy5zdGFrZVB1YmtleSwKCSAgICAgIGJhc2VQdWJrZXk6IHBhcmFtcy5iYXNlUHVia2V5LAoJICAgICAgc2VlZDogcGFyYW1zLnNlZWQsCgkgICAgICBsYW1wb3J0czogcGFyYW1zLmxhbXBvcnRzLAoJICAgICAgc3BhY2U6IHRoaXMuc3BhY2UsCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkCgkgICAgfSkpOwoJICAgIGNvbnN0IHsKCSAgICAgIHN0YWtlUHVia2V5LAoJICAgICAgYXV0aG9yaXplZCwKCSAgICAgIGxvY2t1cAoJICAgIH0gPSBwYXJhbXM7CgkgICAgcmV0dXJuIHRyYW5zYWN0aW9uLmFkZCh0aGlzLmluaXRpYWxpemUoewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpemVkLAoJICAgICAgbG9ja3VwCgkgICAgfSkpOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYSBUcmFuc2FjdGlvbiB0aGF0IGNyZWF0ZXMgYSBuZXcgU3Rha2UgYWNjb3VudAoJICAgKi8KCSAgc3RhdGljIGNyZWF0ZUFjY291bnQocGFyYW1zKSB7CgkgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKTsKCSAgICB0cmFuc2FjdGlvbi5hZGQoU3lzdGVtUHJvZ3JhbS5jcmVhdGVBY2NvdW50KHsKCSAgICAgIGZyb21QdWJrZXk6IHBhcmFtcy5mcm9tUHVia2V5LAoJICAgICAgbmV3QWNjb3VudFB1YmtleTogcGFyYW1zLnN0YWtlUHVia2V5LAoJICAgICAgbGFtcG9ydHM6IHBhcmFtcy5sYW1wb3J0cywKCSAgICAgIHNwYWNlOiB0aGlzLnNwYWNlLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZAoJICAgIH0pKTsKCSAgICBjb25zdCB7CgkgICAgICBzdGFrZVB1YmtleSwKCSAgICAgIGF1dGhvcml6ZWQsCgkgICAgICBsb2NrdXAKCSAgICB9ID0gcGFyYW1zOwoJICAgIHJldHVybiB0cmFuc2FjdGlvbi5hZGQodGhpcy5pbml0aWFsaXplKHsKCSAgICAgIHN0YWtlUHVia2V5LAoJICAgICAgYXV0aG9yaXplZCwKCSAgICAgIGxvY2t1cAoJICAgIH0pKTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgVHJhbnNhY3Rpb24gdGhhdCBkZWxlZ2F0ZXMgU3Rha2UgdG9rZW5zIHRvIGEgdmFsaWRhdG9yCgkgICAqIFZvdGUgUHVibGljS2V5LiBUaGlzIHRyYW5zYWN0aW9uIGNhbiBhbHNvIGJlIHVzZWQgdG8gcmVkZWxlZ2F0ZSBTdGFrZQoJICAgKiB0byBhIG5ldyB2YWxpZGF0b3IgVm90ZSBQdWJsaWNLZXkuCgkgICAqLwoJICBzdGF0aWMgZGVsZWdhdGUocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5LAoJICAgICAgdm90ZVB1YmtleQoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgdHlwZSA9IFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuRGVsZWdhdGU7CgkgICAgY29uc3QgZGF0YSA9IGVuY29kZURhdGEodHlwZSk7CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbigpLmFkZCh7CgkgICAgICBrZXlzOiBbewoJICAgICAgICBwdWJrZXk6IHN0YWtlUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiB2b3RlUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogU1lTVkFSX0NMT0NLX1BVQktFWSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IFNZU1ZBUl9TVEFLRV9ISVNUT1JZX1BVQktFWSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IFNUQUtFX0NPTkZJR19JRCwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IGF1dGhvcml6ZWRQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfV0sCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAgZGF0YQoJICAgIH0pOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYSBUcmFuc2FjdGlvbiB0aGF0IGF1dGhvcml6ZXMgYSBuZXcgUHVibGljS2V5IGFzIFN0YWtlcgoJICAgKiBvciBXaXRoZHJhd2VyIG9uIHRoZSBTdGFrZSBhY2NvdW50LgoJICAgKi8KCSAgc3RhdGljIGF1dGhvcml6ZShwYXJhbXMpIHsKCSAgICBjb25zdCB7CgkgICAgICBzdGFrZVB1YmtleSwKCSAgICAgIGF1dGhvcml6ZWRQdWJrZXksCgkgICAgICBuZXdBdXRob3JpemVkUHVia2V5LAoJICAgICAgc3Rha2VBdXRob3JpemF0aW9uVHlwZSwKCSAgICAgIGN1c3RvZGlhblB1YmtleQoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgdHlwZSA9IFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuQXV0aG9yaXplOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgIG5ld0F1dGhvcml6ZWQ6IHRvQnVmZmVyKG5ld0F1dGhvcml6ZWRQdWJrZXkudG9CdWZmZXIoKSksCgkgICAgICBzdGFrZUF1dGhvcml6YXRpb25UeXBlOiBzdGFrZUF1dGhvcml6YXRpb25UeXBlLmluZGV4CgkgICAgfSk7CgkgICAgY29uc3Qga2V5cyA9IFt7CgkgICAgICBwdWJrZXk6IHN0YWtlUHVia2V5LAoJICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgaXNXcml0YWJsZTogdHJ1ZQoJICAgIH0sIHsKCSAgICAgIHB1YmtleTogU1lTVkFSX0NMT0NLX1BVQktFWSwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICB9LCB7CgkgICAgICBwdWJrZXk6IGF1dGhvcml6ZWRQdWJrZXksCgkgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfV07CgkgICAgaWYgKGN1c3RvZGlhblB1YmtleSkgewoJICAgICAga2V5cy5wdXNoKHsKCSAgICAgICAgcHVia2V5OiBjdXN0b2RpYW5QdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb24oKS5hZGQoewoJICAgICAga2V5cywKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQsCgkgICAgICBkYXRhCgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIFRyYW5zYWN0aW9uIHRoYXQgYXV0aG9yaXplcyBhIG5ldyBQdWJsaWNLZXkgYXMgU3Rha2VyCgkgICAqIG9yIFdpdGhkcmF3ZXIgb24gdGhlIFN0YWtlIGFjY291bnQuCgkgICAqLwoJICBzdGF0aWMgYXV0aG9yaXplV2l0aFNlZWQocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpdHlCYXNlLAoJICAgICAgYXV0aG9yaXR5U2VlZCwKCSAgICAgIGF1dGhvcml0eU93bmVyLAoJICAgICAgbmV3QXV0aG9yaXplZFB1YmtleSwKCSAgICAgIHN0YWtlQXV0aG9yaXphdGlvblR5cGUsCgkgICAgICBjdXN0b2RpYW5QdWJrZXkKCSAgICB9ID0gcGFyYW1zOwoJICAgIGNvbnN0IHR5cGUgPSBTVEFLRV9JTlNUUlVDVElPTl9MQVlPVVRTLkF1dGhvcml6ZVdpdGhTZWVkOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgIG5ld0F1dGhvcml6ZWQ6IHRvQnVmZmVyKG5ld0F1dGhvcml6ZWRQdWJrZXkudG9CdWZmZXIoKSksCgkgICAgICBzdGFrZUF1dGhvcml6YXRpb25UeXBlOiBzdGFrZUF1dGhvcml6YXRpb25UeXBlLmluZGV4LAoJICAgICAgYXV0aG9yaXR5U2VlZDogYXV0aG9yaXR5U2VlZCwKCSAgICAgIGF1dGhvcml0eU93bmVyOiB0b0J1ZmZlcihhdXRob3JpdHlPd25lci50b0J1ZmZlcigpKQoJICAgIH0pOwoJICAgIGNvbnN0IGtleXMgPSBbewoJICAgICAgcHVia2V5OiBzdGFrZVB1YmtleSwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICB9LCB7CgkgICAgICBwdWJrZXk6IGF1dGhvcml0eUJhc2UsCgkgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBTWVNWQVJfQ0xPQ0tfUFVCS0VZLAoJICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICB9XTsKCSAgICBpZiAoY3VzdG9kaWFuUHVia2V5KSB7CgkgICAgICBrZXlzLnB1c2goewoJICAgICAgICBwdWJrZXk6IGN1c3RvZGlhblB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbigpLmFkZCh7CgkgICAgICBrZXlzLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgc3RhdGljIHNwbGl0SW5zdHJ1Y3Rpb24ocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5LAoJICAgICAgc3BsaXRTdGFrZVB1YmtleSwKCSAgICAgIGxhbXBvcnRzCgkgICAgfSA9IHBhcmFtczsKCSAgICBjb25zdCB0eXBlID0gU1RBS0VfSU5TVFJVQ1RJT05fTEFZT1VUUy5TcGxpdDsKCSAgICBjb25zdCBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICBsYW1wb3J0cwoJICAgIH0pOwoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7CgkgICAgICBrZXlzOiBbewoJICAgICAgICBwdWJrZXk6IHN0YWtlUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBzcGxpdFN0YWtlUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBhdXRob3JpemVkUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgIH1dLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgVHJhbnNhY3Rpb24gdGhhdCBzcGxpdHMgU3Rha2UgdG9rZW5zIGludG8gYW5vdGhlciBzdGFrZSBhY2NvdW50CgkgICAqLwoJICBzdGF0aWMgc3BsaXQocGFyYW1zLAoJICAvLyBDb21wdXRlIHRoZSBjb3N0IG9mIGFsbG9jYXRpbmcgdGhlIG5ldyBzdGFrZSBhY2NvdW50IGluIGxhbXBvcnRzCgkgIHJlbnRFeGVtcHRSZXNlcnZlKSB7CgkgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKTsKCSAgICB0cmFuc2FjdGlvbi5hZGQoU3lzdGVtUHJvZ3JhbS5jcmVhdGVBY2NvdW50KHsKCSAgICAgIGZyb21QdWJrZXk6IHBhcmFtcy5hdXRob3JpemVkUHVia2V5LAoJICAgICAgbmV3QWNjb3VudFB1YmtleTogcGFyYW1zLnNwbGl0U3Rha2VQdWJrZXksCgkgICAgICBsYW1wb3J0czogcmVudEV4ZW1wdFJlc2VydmUsCgkgICAgICBzcGFjZTogdGhpcy5zcGFjZSwKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQKCSAgICB9KSk7CgkgICAgcmV0dXJuIHRyYW5zYWN0aW9uLmFkZCh0aGlzLnNwbGl0SW5zdHJ1Y3Rpb24ocGFyYW1zKSk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIFRyYW5zYWN0aW9uIHRoYXQgc3BsaXRzIFN0YWtlIHRva2VucyBpbnRvIGFub3RoZXIgYWNjb3VudAoJICAgKiBkZXJpdmVkIGZyb20gYSBiYXNlIHB1YmxpYyBrZXkgYW5kIHNlZWQKCSAgICovCgkgIHN0YXRpYyBzcGxpdFdpdGhTZWVkKHBhcmFtcywKCSAgLy8gSWYgdGhpcyBzdGFrZSBhY2NvdW50IGlzIG5ldywgY29tcHV0ZSB0aGUgY29zdCBvZiBhbGxvY2F0aW5nIGl0IGluIGxhbXBvcnRzCgkgIHJlbnRFeGVtcHRSZXNlcnZlKSB7CgkgICAgY29uc3QgewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5LAoJICAgICAgc3BsaXRTdGFrZVB1YmtleSwKCSAgICAgIGJhc2VQdWJrZXksCgkgICAgICBzZWVkLAoJICAgICAgbGFtcG9ydHMKCSAgICB9ID0gcGFyYW1zOwoJICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gbmV3IFRyYW5zYWN0aW9uKCk7CgkgICAgdHJhbnNhY3Rpb24uYWRkKFN5c3RlbVByb2dyYW0uYWxsb2NhdGUoewoJICAgICAgYWNjb3VudFB1YmtleTogc3BsaXRTdGFrZVB1YmtleSwKCSAgICAgIGJhc2VQdWJrZXksCgkgICAgICBzZWVkLAoJICAgICAgc3BhY2U6IHRoaXMuc3BhY2UsCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkCgkgICAgfSkpOwoJICAgIGlmIChyZW50RXhlbXB0UmVzZXJ2ZSAmJiByZW50RXhlbXB0UmVzZXJ2ZSA+IDApIHsKCSAgICAgIHRyYW5zYWN0aW9uLmFkZChTeXN0ZW1Qcm9ncmFtLnRyYW5zZmVyKHsKCSAgICAgICAgZnJvbVB1YmtleTogcGFyYW1zLmF1dGhvcml6ZWRQdWJrZXksCgkgICAgICAgIHRvUHVia2V5OiBzcGxpdFN0YWtlUHVia2V5LAoJICAgICAgICBsYW1wb3J0czogcmVudEV4ZW1wdFJlc2VydmUKCSAgICAgIH0pKTsKCSAgICB9CgkgICAgcmV0dXJuIHRyYW5zYWN0aW9uLmFkZCh0aGlzLnNwbGl0SW5zdHJ1Y3Rpb24oewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5LAoJICAgICAgc3BsaXRTdGFrZVB1YmtleSwKCSAgICAgIGxhbXBvcnRzCgkgICAgfSkpOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYSBUcmFuc2FjdGlvbiB0aGF0IG1lcmdlcyBTdGFrZSBhY2NvdW50cy4KCSAgICovCgkgIHN0YXRpYyBtZXJnZShwYXJhbXMpIHsKCSAgICBjb25zdCB7CgkgICAgICBzdGFrZVB1YmtleSwKCSAgICAgIHNvdXJjZVN0YWtlUHViS2V5LAoJICAgICAgYXV0aG9yaXplZFB1YmtleQoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgdHlwZSA9IFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuTWVyZ2U7CgkgICAgY29uc3QgZGF0YSA9IGVuY29kZURhdGEodHlwZSk7CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbigpLmFkZCh7CgkgICAgICBrZXlzOiBbewoJICAgICAgICBwdWJrZXk6IHN0YWtlUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBzb3VyY2VTdGFrZVB1YktleSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogU1lTVkFSX0NMT0NLX1BVQktFWSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IFNZU1ZBUl9TVEFLRV9ISVNUT1JZX1BVQktFWSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IGF1dGhvcml6ZWRQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfV0sCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAgZGF0YQoJICAgIH0pOwoJICB9CgoJICAvKioKCSAgICogR2VuZXJhdGUgYSBUcmFuc2FjdGlvbiB0aGF0IHdpdGhkcmF3cyBkZWFjdGl2YXRlZCBTdGFrZSB0b2tlbnMuCgkgICAqLwoJICBzdGF0aWMgd2l0aGRyYXcocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5LAoJICAgICAgdG9QdWJrZXksCgkgICAgICBsYW1wb3J0cywKCSAgICAgIGN1c3RvZGlhblB1YmtleQoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgdHlwZSA9IFNUQUtFX0lOU1RSVUNUSU9OX0xBWU9VVFMuV2l0aGRyYXc7CgkgICAgY29uc3QgZGF0YSA9IGVuY29kZURhdGEodHlwZSwgewoJICAgICAgbGFtcG9ydHMKCSAgICB9KTsKCSAgICBjb25zdCBrZXlzID0gW3sKCSAgICAgIHB1YmtleTogc3Rha2VQdWJrZXksCgkgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiB0b1B1YmtleSwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICB9LCB7CgkgICAgICBwdWJrZXk6IFNZU1ZBUl9DTE9DS19QVUJLRVksCgkgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgIH0sIHsKCSAgICAgIHB1YmtleTogU1lTVkFSX1NUQUtFX0hJU1RPUllfUFVCS0VZLAoJICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICB9LCB7CgkgICAgICBwdWJrZXk6IGF1dGhvcml6ZWRQdWJrZXksCgkgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfV07CgkgICAgaWYgKGN1c3RvZGlhblB1YmtleSkgewoJICAgICAga2V5cy5wdXNoKHsKCSAgICAgICAgcHVia2V5OiBjdXN0b2RpYW5QdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb24oKS5hZGQoewoJICAgICAga2V5cywKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQsCgkgICAgICBkYXRhCgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIFRyYW5zYWN0aW9uIHRoYXQgZGVhY3RpdmF0ZXMgU3Rha2UgdG9rZW5zLgoJICAgKi8KCSAgc3RhdGljIGRlYWN0aXZhdGUocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgc3Rha2VQdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5CgkgICAgfSA9IHBhcmFtczsKCSAgICBjb25zdCB0eXBlID0gU1RBS0VfSU5TVFJVQ1RJT05fTEFZT1VUUy5EZWFjdGl2YXRlOwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUpOwoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb24oKS5hZGQoewoJICAgICAga2V5czogW3sKCSAgICAgICAgcHVia2V5OiBzdGFrZVB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogU1lTVkFSX0NMT0NLX1BVQktFWSwKCSAgICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfSwgewoJICAgICAgICBwdWJrZXk6IGF1dGhvcml6ZWRQdWJrZXksCgkgICAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgICAgfV0sCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAgZGF0YQoJICAgIH0pOwoJICB9Cgl9CglTdGFrZVByb2dyYW0ucHJvZ3JhbUlkID0gbmV3IFB1YmxpY0tleSgnU3Rha2UxMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMScpOwoJLyoqCgkgKiBNYXggc3BhY2Ugb2YgYSBTdGFrZSBhY2NvdW50CgkgKgoJICogVGhpcyBpcyBnZW5lcmF0ZWQgZnJvbSB0aGUgc29sYW5hLXN0YWtlLXByb2dyYW0gU3Rha2VTdGF0ZSBzdHJ1Y3QgYXMKCSAqIGBTdGFrZVN0YXRlVjI6OnNpemVfb2YoKWA6CgkgKiBodHRwczovL2RvY3MucnMvc29sYW5hLXN0YWtlLXByb2dyYW0vbGF0ZXN0L3NvbGFuYV9zdGFrZV9wcm9ncmFtL3N0YWtlX3N0YXRlL2VudW0uU3Rha2VTdGF0ZVYyLmh0bWwKCSAqLwoJU3Rha2VQcm9ncmFtLnNwYWNlID0gMjAwOwoKCS8qKgoJICogVm90ZSBhY2NvdW50IGluZm8KCSAqLwoJY2xhc3MgVm90ZUluaXQgewoJICAvKiogWzAsIDEwMF0gKi8KCgkgIGNvbnN0cnVjdG9yKG5vZGVQdWJrZXksIGF1dGhvcml6ZWRWb3RlciwgYXV0aG9yaXplZFdpdGhkcmF3ZXIsIGNvbW1pc3Npb24pIHsKCSAgICB0aGlzLm5vZGVQdWJrZXkgPSB2b2lkIDA7CgkgICAgdGhpcy5hdXRob3JpemVkVm90ZXIgPSB2b2lkIDA7CgkgICAgdGhpcy5hdXRob3JpemVkV2l0aGRyYXdlciA9IHZvaWQgMDsKCSAgICB0aGlzLmNvbW1pc3Npb24gPSB2b2lkIDA7CgkgICAgdGhpcy5ub2RlUHVia2V5ID0gbm9kZVB1YmtleTsKCSAgICB0aGlzLmF1dGhvcml6ZWRWb3RlciA9IGF1dGhvcml6ZWRWb3RlcjsKCSAgICB0aGlzLmF1dGhvcml6ZWRXaXRoZHJhd2VyID0gYXV0aG9yaXplZFdpdGhkcmF3ZXI7CgkgICAgdGhpcy5jb21taXNzaW9uID0gY29tbWlzc2lvbjsKCSAgfQoJfQoKCS8qKgoJICogQ3JlYXRlIHZvdGUgYWNjb3VudCB0cmFuc2FjdGlvbiBwYXJhbXMKCSAqLwoKCS8qKgoJICogSW5pdGlhbGl6ZUFjY291bnQgaW5zdHJ1Y3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIEF1dGhvcml6ZSBpbnN0cnVjdGlvbiBwYXJhbXMKCSAqLwoKCS8qKgoJICogQXV0aG9yaXplV2l0aFNlZWQgaW5zdHJ1Y3Rpb24gcGFyYW1zCgkgKi8KCgkvKioKCSAqIFdpdGhkcmF3IGZyb20gdm90ZSBhY2NvdW50IHRyYW5zYWN0aW9uIHBhcmFtcwoJICovCgoJLyoqCgkgKiBVcGRhdGUgdmFsaWRhdG9yIGlkZW50aXR5IChub2RlIHB1YmtleSkgdm90ZSBhY2NvdW50IGluc3RydWN0aW9uIHBhcmFtcy4KCSAqLwoKCS8qKgoJICogVm90ZSBJbnN0cnVjdGlvbiBjbGFzcwoJICovCgljbGFzcyBWb3RlSW5zdHJ1Y3Rpb24gewoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBjb25zdHJ1Y3RvcigpIHt9CgoJICAvKioKCSAgICogRGVjb2RlIGEgdm90ZSBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHR5cGUuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlSW5zdHJ1Y3Rpb25UeXBlKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIGNvbnN0IGluc3RydWN0aW9uVHlwZUxheW91dCA9IExheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpOwoJICAgIGNvbnN0IHR5cGVJbmRleCA9IGluc3RydWN0aW9uVHlwZUxheW91dC5kZWNvZGUoaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgbGV0IHR5cGU7CgkgICAgZm9yIChjb25zdCBbaXhUeXBlLCBsYXlvdXRdIG9mIE9iamVjdC5lbnRyaWVzKFZPVEVfSU5TVFJVQ1RJT05fTEFZT1VUUykpIHsKCSAgICAgIGlmIChsYXlvdXQuaW5kZXggPT0gdHlwZUluZGV4KSB7CgkgICAgICAgIHR5cGUgPSBpeFR5cGU7CgkgICAgICAgIGJyZWFrOwoJICAgICAgfQoJICAgIH0KCSAgICBpZiAoIXR5cGUpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignSW5zdHJ1Y3Rpb24gdHlwZSBpbmNvcnJlY3Q7IG5vdCBhIFZvdGVJbnN0cnVjdGlvbicpOwoJICAgIH0KCSAgICByZXR1cm4gdHlwZTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhbiBpbml0aWFsaXplIHZvdGUgaW5zdHJ1Y3Rpb24gYW5kIHJldHJpZXZlIHRoZSBpbnN0cnVjdGlvbiBwYXJhbXMuCgkgICAqLwoJICBzdGF0aWMgZGVjb2RlSW5pdGlhbGl6ZUFjY291bnQoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCA0KTsKCSAgICBjb25zdCB7CgkgICAgICB2b3RlSW5pdAoJICAgIH0gPSBkZWNvZGVEYXRhJDEoVk9URV9JTlNUUlVDVElPTl9MQVlPVVRTLkluaXRpYWxpemVBY2NvdW50LCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgdm90ZVB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICBub2RlUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzNdLnB1YmtleSwKCSAgICAgIHZvdGVJbml0OiBuZXcgVm90ZUluaXQobmV3IFB1YmxpY0tleSh2b3RlSW5pdC5ub2RlUHVia2V5KSwgbmV3IFB1YmxpY0tleSh2b3RlSW5pdC5hdXRob3JpemVkVm90ZXIpLCBuZXcgUHVibGljS2V5KHZvdGVJbml0LmF1dGhvcml6ZWRXaXRoZHJhd2VyKSwgdm90ZUluaXQuY29tbWlzc2lvbikKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogRGVjb2RlIGFuIGF1dGhvcml6ZSBpbnN0cnVjdGlvbiBhbmQgcmV0cmlldmUgdGhlIGluc3RydWN0aW9uIHBhcmFtcy4KCSAgICovCgkgIHN0YXRpYyBkZWNvZGVBdXRob3JpemUoaW5zdHJ1Y3Rpb24pIHsKCSAgICB0aGlzLmNoZWNrUHJvZ3JhbUlkKGluc3RydWN0aW9uLnByb2dyYW1JZCk7CgkgICAgdGhpcy5jaGVja0tleUxlbmd0aChpbnN0cnVjdGlvbi5rZXlzLCAzKTsKCSAgICBjb25zdCB7CgkgICAgICBuZXdBdXRob3JpemVkLAoJICAgICAgdm90ZUF1dGhvcml6YXRpb25UeXBlCgkgICAgfSA9IGRlY29kZURhdGEkMShWT1RFX0lOU1RSVUNUSU9OX0xBWU9VVFMuQXV0aG9yaXplLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgdm90ZVB1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1swXS5wdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzJdLnB1YmtleSwKCSAgICAgIG5ld0F1dGhvcml6ZWRQdWJrZXk6IG5ldyBQdWJsaWNLZXkobmV3QXV0aG9yaXplZCksCgkgICAgICB2b3RlQXV0aG9yaXphdGlvblR5cGU6IHsKCSAgICAgICAgaW5kZXg6IHZvdGVBdXRob3JpemF0aW9uVHlwZQoJICAgICAgfQoJICAgIH07CgkgIH0KCgkgIC8qKgoJICAgKiBEZWNvZGUgYW4gYXV0aG9yaXplIGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZUF1dGhvcml6ZVdpdGhTZWVkKGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIHRoaXMuY2hlY2tLZXlMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMyk7CgkgICAgY29uc3QgewoJICAgICAgdm90ZUF1dGhvcml6ZVdpdGhTZWVkQXJnczogewoJICAgICAgICBjdXJyZW50QXV0aG9yaXR5RGVyaXZlZEtleU93bmVyUHVia2V5LAoJICAgICAgICBjdXJyZW50QXV0aG9yaXR5RGVyaXZlZEtleVNlZWQsCgkgICAgICAgIG5ld0F1dGhvcml6ZWQsCgkgICAgICAgIHZvdGVBdXRob3JpemF0aW9uVHlwZQoJICAgICAgfQoJICAgIH0gPSBkZWNvZGVEYXRhJDEoVk9URV9JTlNUUlVDVElPTl9MQVlPVVRTLkF1dGhvcml6ZVdpdGhTZWVkLCBpbnN0cnVjdGlvbi5kYXRhKTsKCSAgICByZXR1cm4gewoJICAgICAgY3VycmVudEF1dGhvcml0eURlcml2ZWRLZXlCYXNlUHVia2V5OiBpbnN0cnVjdGlvbi5rZXlzWzJdLnB1YmtleSwKCSAgICAgIGN1cnJlbnRBdXRob3JpdHlEZXJpdmVkS2V5T3duZXJQdWJrZXk6IG5ldyBQdWJsaWNLZXkoY3VycmVudEF1dGhvcml0eURlcml2ZWRLZXlPd25lclB1YmtleSksCgkgICAgICBjdXJyZW50QXV0aG9yaXR5RGVyaXZlZEtleVNlZWQ6IGN1cnJlbnRBdXRob3JpdHlEZXJpdmVkS2V5U2VlZCwKCSAgICAgIG5ld0F1dGhvcml6ZWRQdWJrZXk6IG5ldyBQdWJsaWNLZXkobmV3QXV0aG9yaXplZCksCgkgICAgICB2b3RlQXV0aG9yaXphdGlvblR5cGU6IHsKCSAgICAgICAgaW5kZXg6IHZvdGVBdXRob3JpemF0aW9uVHlwZQoJICAgICAgfSwKCSAgICAgIHZvdGVQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5CgkgICAgfTsKCSAgfQoKCSAgLyoqCgkgICAqIERlY29kZSBhIHdpdGhkcmF3IGluc3RydWN0aW9uIGFuZCByZXRyaWV2ZSB0aGUgaW5zdHJ1Y3Rpb24gcGFyYW1zLgoJICAgKi8KCSAgc3RhdGljIGRlY29kZVdpdGhkcmF3KGluc3RydWN0aW9uKSB7CgkgICAgdGhpcy5jaGVja1Byb2dyYW1JZChpbnN0cnVjdGlvbi5wcm9ncmFtSWQpOwoJICAgIHRoaXMuY2hlY2tLZXlMZW5ndGgoaW5zdHJ1Y3Rpb24ua2V5cywgMyk7CgkgICAgY29uc3QgewoJICAgICAgbGFtcG9ydHMKCSAgICB9ID0gZGVjb2RlRGF0YSQxKFZPVEVfSU5TVFJVQ1RJT05fTEFZT1VUUy5XaXRoZHJhdywgaW5zdHJ1Y3Rpb24uZGF0YSk7CgkgICAgcmV0dXJuIHsKCSAgICAgIHZvdGVQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMF0ucHVia2V5LAoJICAgICAgYXV0aG9yaXplZFdpdGhkcmF3ZXJQdWJrZXk6IGluc3RydWN0aW9uLmtleXNbMl0ucHVia2V5LAoJICAgICAgbGFtcG9ydHMsCgkgICAgICB0b1B1YmtleTogaW5zdHJ1Y3Rpb24ua2V5c1sxXS5wdWJrZXkKCSAgICB9OwoJICB9CgoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBzdGF0aWMgY2hlY2tQcm9ncmFtSWQocHJvZ3JhbUlkKSB7CgkgICAgaWYgKCFwcm9ncmFtSWQuZXF1YWxzKFZvdGVQcm9ncmFtLnByb2dyYW1JZCkpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBpbnN0cnVjdGlvbjsgcHJvZ3JhbUlkIGlzIG5vdCBWb3RlUHJvZ3JhbScpOwoJICAgIH0KCSAgfQoKCSAgLyoqCgkgICAqIEBpbnRlcm5hbAoJICAgKi8KCSAgc3RhdGljIGNoZWNrS2V5TGVuZ3RoKGtleXMsIGV4cGVjdGVkTGVuZ3RoKSB7CgkgICAgaWYgKGtleXMubGVuZ3RoIDwgZXhwZWN0ZWRMZW5ndGgpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBpbnN0cnVjdGlvbjsgZm91bmQgJHtrZXlzLmxlbmd0aH0ga2V5cywgZXhwZWN0ZWQgYXQgbGVhc3QgJHtleHBlY3RlZExlbmd0aH1gKTsKCSAgICB9CgkgIH0KCX0KCgkvKioKCSAqIEFuIGVudW1lcmF0aW9uIG9mIHZhbGlkIFZvdGVJbnN0cnVjdGlvblR5cGUncwoJICovCgoJLyoqIEBpbnRlcm5hbCAqLwoKCWNvbnN0IFZPVEVfSU5TVFJVQ1RJT05fTEFZT1VUUyA9IE9iamVjdC5mcmVlemUoewoJICBJbml0aWFsaXplQWNjb3VudDogewoJICAgIGluZGV4OiAwLAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpLCB2b3RlSW5pdCgpXSkKCSAgfSwKCSAgQXV0aG9yaXplOiB7CgkgICAgaW5kZXg6IDEsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyksIHB1YmxpY0tleSgnbmV3QXV0aG9yaXplZCcpLCBMYXlvdXRFeHBvcnRzLnUzMigndm90ZUF1dGhvcml6YXRpb25UeXBlJyldKQoJICB9LAoJICBXaXRoZHJhdzogewoJICAgIGluZGV4OiAzLAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpLCBMYXlvdXRFeHBvcnRzLm5zNjQoJ2xhbXBvcnRzJyldKQoJICB9LAoJICBVcGRhdGVWYWxpZGF0b3JJZGVudGl0eTogewoJICAgIGluZGV4OiA0LAoJICAgIGxheW91dDogTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMudTMyKCdpbnN0cnVjdGlvbicpXSkKCSAgfSwKCSAgQXV0aG9yaXplV2l0aFNlZWQ6IHsKCSAgICBpbmRleDogMTAsCgkgICAgbGF5b3V0OiBMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy51MzIoJ2luc3RydWN0aW9uJyksIHZvdGVBdXRob3JpemVXaXRoU2VlZEFyZ3MoKV0pCgkgIH0KCX0pOwoKCS8qKgoJICogVm90ZUF1dGhvcml6ZSB0eXBlCgkgKi8KCgkvKioKCSAqIEFuIGVudW1lcmF0aW9uIG9mIHZhbGlkIFZvdGVBdXRob3JpemF0aW9uIGxheW91dHMuCgkgKi8KCWNvbnN0IFZvdGVBdXRob3JpemF0aW9uTGF5b3V0ID0gT2JqZWN0LmZyZWV6ZSh7CgkgIFZvdGVyOiB7CgkgICAgaW5kZXg6IDAKCSAgfSwKCSAgV2l0aGRyYXdlcjogewoJICAgIGluZGV4OiAxCgkgIH0KCX0pOwoKCS8qKgoJICogRmFjdG9yeSBjbGFzcyBmb3IgdHJhbnNhY3Rpb25zIHRvIGludGVyYWN0IHdpdGggdGhlIFZvdGUgcHJvZ3JhbQoJICovCgljbGFzcyBWb3RlUHJvZ3JhbSB7CgkgIC8qKgoJICAgKiBAaW50ZXJuYWwKCSAgICovCgkgIGNvbnN0cnVjdG9yKCkge30KCgkgIC8qKgoJICAgKiBQdWJsaWMga2V5IHRoYXQgaWRlbnRpZmllcyB0aGUgVm90ZSBwcm9ncmFtCgkgICAqLwoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGFuIEluaXRpYWxpemUgaW5zdHJ1Y3Rpb24uCgkgICAqLwoJICBzdGF0aWMgaW5pdGlhbGl6ZUFjY291bnQocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgdm90ZVB1YmtleSwKCSAgICAgIG5vZGVQdWJrZXksCgkgICAgICB2b3RlSW5pdAoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgdHlwZSA9IFZPVEVfSU5TVFJVQ1RJT05fTEFZT1VUUy5Jbml0aWFsaXplQWNjb3VudDsKCSAgICBjb25zdCBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICB2b3RlSW5pdDogewoJICAgICAgICBub2RlUHVia2V5OiB0b0J1ZmZlcih2b3RlSW5pdC5ub2RlUHVia2V5LnRvQnVmZmVyKCkpLAoJICAgICAgICBhdXRob3JpemVkVm90ZXI6IHRvQnVmZmVyKHZvdGVJbml0LmF1dGhvcml6ZWRWb3Rlci50b0J1ZmZlcigpKSwKCSAgICAgICAgYXV0aG9yaXplZFdpdGhkcmF3ZXI6IHRvQnVmZmVyKHZvdGVJbml0LmF1dGhvcml6ZWRXaXRoZHJhd2VyLnRvQnVmZmVyKCkpLAoJICAgICAgICBjb21taXNzaW9uOiB2b3RlSW5pdC5jb21taXNzaW9uCgkgICAgICB9CgkgICAgfSk7CgkgICAgY29uc3QgaW5zdHJ1Y3Rpb25EYXRhID0gewoJICAgICAga2V5czogW3sKCSAgICAgICAgcHVia2V5OiB2b3RlUHVia2V5LAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBTWVNWQVJfUkVOVF9QVUJLRVksCgkgICAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICAgIH0sIHsKCSAgICAgICAgcHVia2V5OiBTWVNWQVJfQ0xPQ0tfUFVCS0VZLAoJICAgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9LCB7CgkgICAgICAgIHB1YmtleTogbm9kZVB1YmtleSwKCSAgICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgICB9XSwKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQsCgkgICAgICBkYXRhCgkgICAgfTsKCSAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24oaW5zdHJ1Y3Rpb25EYXRhKTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgdHJhbnNhY3Rpb24gdGhhdCBjcmVhdGVzIGEgbmV3IFZvdGUgYWNjb3VudC4KCSAgICovCgkgIHN0YXRpYyBjcmVhdGVBY2NvdW50KHBhcmFtcykgewoJICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gbmV3IFRyYW5zYWN0aW9uKCk7CgkgICAgdHJhbnNhY3Rpb24uYWRkKFN5c3RlbVByb2dyYW0uY3JlYXRlQWNjb3VudCh7CgkgICAgICBmcm9tUHVia2V5OiBwYXJhbXMuZnJvbVB1YmtleSwKCSAgICAgIG5ld0FjY291bnRQdWJrZXk6IHBhcmFtcy52b3RlUHVia2V5LAoJICAgICAgbGFtcG9ydHM6IHBhcmFtcy5sYW1wb3J0cywKCSAgICAgIHNwYWNlOiB0aGlzLnNwYWNlLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZAoJICAgIH0pKTsKCSAgICByZXR1cm4gdHJhbnNhY3Rpb24uYWRkKHRoaXMuaW5pdGlhbGl6ZUFjY291bnQoewoJICAgICAgdm90ZVB1YmtleTogcGFyYW1zLnZvdGVQdWJrZXksCgkgICAgICBub2RlUHVia2V5OiBwYXJhbXMudm90ZUluaXQubm9kZVB1YmtleSwKCSAgICAgIHZvdGVJbml0OiBwYXJhbXMudm90ZUluaXQKCSAgICB9KSk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIHRyYW5zYWN0aW9uIHRoYXQgYXV0aG9yaXplcyBhIG5ldyBWb3RlciBvciBXaXRoZHJhd2VyIG9uIHRoZSBWb3RlIGFjY291bnQuCgkgICAqLwoJICBzdGF0aWMgYXV0aG9yaXplKHBhcmFtcykgewoJICAgIGNvbnN0IHsKCSAgICAgIHZvdGVQdWJrZXksCgkgICAgICBhdXRob3JpemVkUHVia2V5LAoJICAgICAgbmV3QXV0aG9yaXplZFB1YmtleSwKCSAgICAgIHZvdGVBdXRob3JpemF0aW9uVHlwZQoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgdHlwZSA9IFZPVEVfSU5TVFJVQ1RJT05fTEFZT1VUUy5BdXRob3JpemU7CgkgICAgY29uc3QgZGF0YSA9IGVuY29kZURhdGEodHlwZSwgewoJICAgICAgbmV3QXV0aG9yaXplZDogdG9CdWZmZXIobmV3QXV0aG9yaXplZFB1YmtleS50b0J1ZmZlcigpKSwKCSAgICAgIHZvdGVBdXRob3JpemF0aW9uVHlwZTogdm90ZUF1dGhvcml6YXRpb25UeXBlLmluZGV4CgkgICAgfSk7CgkgICAgY29uc3Qga2V5cyA9IFt7CgkgICAgICBwdWJrZXk6IHZvdGVQdWJrZXksCgkgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBTWVNWQVJfQ0xPQ0tfUFVCS0VZLAoJICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICB9LCB7CgkgICAgICBwdWJrZXk6IGF1dGhvcml6ZWRQdWJrZXksCgkgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfV07CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbigpLmFkZCh7CgkgICAgICBrZXlzLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgdHJhbnNhY3Rpb24gdGhhdCBhdXRob3JpemVzIGEgbmV3IFZvdGVyIG9yIFdpdGhkcmF3ZXIgb24gdGhlIFZvdGUgYWNjb3VudAoJICAgKiB3aGVyZSB0aGUgY3VycmVudCBWb3RlciBvciBXaXRoZHJhd2VyIGF1dGhvcml0eSBpcyBhIGRlcml2ZWQga2V5LgoJICAgKi8KCSAgc3RhdGljIGF1dGhvcml6ZVdpdGhTZWVkKHBhcmFtcykgewoJICAgIGNvbnN0IHsKCSAgICAgIGN1cnJlbnRBdXRob3JpdHlEZXJpdmVkS2V5QmFzZVB1YmtleSwKCSAgICAgIGN1cnJlbnRBdXRob3JpdHlEZXJpdmVkS2V5T3duZXJQdWJrZXksCgkgICAgICBjdXJyZW50QXV0aG9yaXR5RGVyaXZlZEtleVNlZWQsCgkgICAgICBuZXdBdXRob3JpemVkUHVia2V5LAoJICAgICAgdm90ZUF1dGhvcml6YXRpb25UeXBlLAoJICAgICAgdm90ZVB1YmtleQoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgdHlwZSA9IFZPVEVfSU5TVFJVQ1RJT05fTEFZT1VUUy5BdXRob3JpemVXaXRoU2VlZDsKCSAgICBjb25zdCBkYXRhID0gZW5jb2RlRGF0YSh0eXBlLCB7CgkgICAgICB2b3RlQXV0aG9yaXplV2l0aFNlZWRBcmdzOiB7CgkgICAgICAgIGN1cnJlbnRBdXRob3JpdHlEZXJpdmVkS2V5T3duZXJQdWJrZXk6IHRvQnVmZmVyKGN1cnJlbnRBdXRob3JpdHlEZXJpdmVkS2V5T3duZXJQdWJrZXkudG9CdWZmZXIoKSksCgkgICAgICAgIGN1cnJlbnRBdXRob3JpdHlEZXJpdmVkS2V5U2VlZDogY3VycmVudEF1dGhvcml0eURlcml2ZWRLZXlTZWVkLAoJICAgICAgICBuZXdBdXRob3JpemVkOiB0b0J1ZmZlcihuZXdBdXRob3JpemVkUHVia2V5LnRvQnVmZmVyKCkpLAoJICAgICAgICB2b3RlQXV0aG9yaXphdGlvblR5cGU6IHZvdGVBdXRob3JpemF0aW9uVHlwZS5pbmRleAoJICAgICAgfQoJICAgIH0pOwoJICAgIGNvbnN0IGtleXMgPSBbewoJICAgICAgcHVia2V5OiB2b3RlUHVia2V5LAoJICAgICAgaXNTaWduZXI6IGZhbHNlLAoJICAgICAgaXNXcml0YWJsZTogdHJ1ZQoJICAgIH0sIHsKCSAgICAgIHB1YmtleTogU1lTVkFSX0NMT0NLX1BVQktFWSwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBjdXJyZW50QXV0aG9yaXR5RGVyaXZlZEtleUJhc2VQdWJrZXksCgkgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfV07CgkgICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbigpLmFkZCh7CgkgICAgICBrZXlzLAoJICAgICAgcHJvZ3JhbUlkOiB0aGlzLnByb2dyYW1JZCwKCSAgICAgIGRhdGEKCSAgICB9KTsKCSAgfQoKCSAgLyoqCgkgICAqIEdlbmVyYXRlIGEgdHJhbnNhY3Rpb24gdG8gd2l0aGRyYXcgZnJvbSBhIFZvdGUgYWNjb3VudC4KCSAgICovCgkgIHN0YXRpYyB3aXRoZHJhdyhwYXJhbXMpIHsKCSAgICBjb25zdCB7CgkgICAgICB2b3RlUHVia2V5LAoJICAgICAgYXV0aG9yaXplZFdpdGhkcmF3ZXJQdWJrZXksCgkgICAgICBsYW1wb3J0cywKCSAgICAgIHRvUHVia2V5CgkgICAgfSA9IHBhcmFtczsKCSAgICBjb25zdCB0eXBlID0gVk9URV9JTlNUUlVDVElPTl9MQVlPVVRTLldpdGhkcmF3OwoJICAgIGNvbnN0IGRhdGEgPSBlbmNvZGVEYXRhKHR5cGUsIHsKCSAgICAgIGxhbXBvcnRzCgkgICAgfSk7CgkgICAgY29uc3Qga2V5cyA9IFt7CgkgICAgICBwdWJrZXk6IHZvdGVQdWJrZXksCgkgICAgICBpc1NpZ25lcjogZmFsc2UsCgkgICAgICBpc1dyaXRhYmxlOiB0cnVlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiB0b1B1YmtleSwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICB9LCB7CgkgICAgICBwdWJrZXk6IGF1dGhvcml6ZWRXaXRoZHJhd2VyUHVia2V5LAoJICAgICAgaXNTaWduZXI6IHRydWUsCgkgICAgICBpc1dyaXRhYmxlOiBmYWxzZQoJICAgIH1dOwoJICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb24oKS5hZGQoewoJICAgICAga2V5cywKCSAgICAgIHByb2dyYW1JZDogdGhpcy5wcm9ncmFtSWQsCgkgICAgICBkYXRhCgkgICAgfSk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIHRyYW5zYWN0aW9uIHRvIHdpdGhkcmF3IHNhZmVseSBmcm9tIGEgVm90ZSBhY2NvdW50LgoJICAgKgoJICAgKiBUaGlzIGZ1bmN0aW9uIHdhcyBjcmVhdGVkIGFzIGEgc2FmZWd1YXJkIGZvciB2b3RlIGFjY291bnRzIHJ1bm5pbmcgdmFsaWRhdG9ycywgYHNhZmVXaXRoZHJhd2AKCSAgICogY2hlY2tzIHRoYXQgdGhlIHdpdGhkcmF3IGFtb3VudCB3aWxsIG5vdCBleGNlZWQgdGhlIHNwZWNpZmllZCBiYWxhbmNlIHdoaWxlIGxlYXZpbmcgZW5vdWdoIGxlZnQKCSAgICogdG8gY292ZXIgcmVudC4gSWYgeW91IHdpc2ggdG8gY2xvc2UgdGhlIHZvdGUgYWNjb3VudCBieSB3aXRoZHJhd2luZyB0aGUgZnVsbCBhbW91bnQsIGNhbGwgdGhlCgkgICAqIGB3aXRoZHJhd2AgbWV0aG9kIGRpcmVjdGx5LgoJICAgKi8KCSAgc3RhdGljIHNhZmVXaXRoZHJhdyhwYXJhbXMsIGN1cnJlbnRWb3RlQWNjb3VudEJhbGFuY2UsIHJlbnRFeGVtcHRNaW5pbXVtKSB7CgkgICAgaWYgKHBhcmFtcy5sYW1wb3J0cyA+IGN1cnJlbnRWb3RlQWNjb3VudEJhbGFuY2UgLSByZW50RXhlbXB0TWluaW11bSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCdXaXRoZHJhdyB3aWxsIGxlYXZlIHZvdGUgYWNjb3VudCB3aXRoIGluc3VmZmljaWVudCBmdW5kcy4nKTsKCSAgICB9CgkgICAgcmV0dXJuIFZvdGVQcm9ncmFtLndpdGhkcmF3KHBhcmFtcyk7CgkgIH0KCgkgIC8qKgoJICAgKiBHZW5lcmF0ZSBhIHRyYW5zYWN0aW9uIHRvIHVwZGF0ZSB0aGUgdmFsaWRhdG9yIGlkZW50aXR5IChub2RlIHB1YmtleSkgb2YgYSBWb3RlIGFjY291bnQuCgkgICAqLwoJICBzdGF0aWMgdXBkYXRlVmFsaWRhdG9ySWRlbnRpdHkocGFyYW1zKSB7CgkgICAgY29uc3QgewoJICAgICAgdm90ZVB1YmtleSwKCSAgICAgIGF1dGhvcml6ZWRXaXRoZHJhd2VyUHVia2V5LAoJICAgICAgbm9kZVB1YmtleQoJICAgIH0gPSBwYXJhbXM7CgkgICAgY29uc3QgdHlwZSA9IFZPVEVfSU5TVFJVQ1RJT05fTEFZT1VUUy5VcGRhdGVWYWxpZGF0b3JJZGVudGl0eTsKCSAgICBjb25zdCBkYXRhID0gZW5jb2RlRGF0YSh0eXBlKTsKCSAgICBjb25zdCBrZXlzID0gW3sKCSAgICAgIHB1YmtleTogdm90ZVB1YmtleSwKCSAgICAgIGlzU2lnbmVyOiBmYWxzZSwKCSAgICAgIGlzV3JpdGFibGU6IHRydWUKCSAgICB9LCB7CgkgICAgICBwdWJrZXk6IG5vZGVQdWJrZXksCgkgICAgICBpc1NpZ25lcjogdHJ1ZSwKCSAgICAgIGlzV3JpdGFibGU6IGZhbHNlCgkgICAgfSwgewoJICAgICAgcHVia2V5OiBhdXRob3JpemVkV2l0aGRyYXdlclB1YmtleSwKCSAgICAgIGlzU2lnbmVyOiB0cnVlLAoJICAgICAgaXNXcml0YWJsZTogZmFsc2UKCSAgICB9XTsKCSAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uKCkuYWRkKHsKCSAgICAgIGtleXMsCgkgICAgICBwcm9ncmFtSWQ6IHRoaXMucHJvZ3JhbUlkLAoJICAgICAgZGF0YQoJICAgIH0pOwoJICB9Cgl9CglWb3RlUHJvZ3JhbS5wcm9ncmFtSWQgPSBuZXcgUHVibGljS2V5KCdWb3RlMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExJyk7CgkvKioKCSAqIE1heCBzcGFjZSBvZiBhIFZvdGUgYWNjb3VudAoJICoKCSAqIFRoaXMgaXMgZ2VuZXJhdGVkIGZyb20gdGhlIHNvbGFuYS12b3RlLXByb2dyYW0gVm90ZVN0YXRlIHN0cnVjdCBhcwoJICogYFZvdGVTdGF0ZTo6c2l6ZV9vZigpYDoKCSAqIGh0dHBzOi8vZG9jcy5ycy9zb2xhbmEtdm90ZS1wcm9ncmFtLzEuOS41L3NvbGFuYV92b3RlX3Byb2dyYW0vdm90ZV9zdGF0ZS9zdHJ1Y3QuVm90ZVN0YXRlLmh0bWwjbWV0aG9kLnNpemVfb2YKCSAqCgkgKiBLRUVQIElOIFNZTkMgV0lUSCBgVm90ZVN0YXRlOjpzaXplX29mKClgIGluIGh0dHBzOi8vZ2l0aHViLmNvbS9zb2xhbmEtbGFicy9zb2xhbmEvYmxvYi9hNDc0Y2IyNGI5MjM4ZjVlZGNjOTgyZjY1YzBiMzdkNGExMDQ2ZjdlL3Nkay9wcm9ncmFtL3NyYy92b3RlL3N0YXRlL21vZC5ycyNMMzQwLUwzNDIKCSAqLwoJVm90ZVByb2dyYW0uc3BhY2UgPSAzNzYyOwoKCWNvbnN0IFZBTElEQVRPUl9JTkZPX0tFWSA9IG5ldyBQdWJsaWNLZXkoJ1ZhMWlkYXRvcjFuZm8xMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEnKTsKCgkvKioKCSAqIEBpbnRlcm5hbAoJICovCgoJLyoqCgkgKiBJbmZvIHVzZWQgdG8gaWRlbnRpdHkgdmFsaWRhdG9ycy4KCSAqLwoKCWNvbnN0IEluZm9TdHJpbmcgPSB0eXBlKHsKCSAgbmFtZTogc3RyaW5nKCksCgkgIHdlYnNpdGU6IG9wdGlvbmFsKHN0cmluZygpKSwKCSAgZGV0YWlsczogb3B0aW9uYWwoc3RyaW5nKCkpLAoJICBpY29uVXJsOiBvcHRpb25hbChzdHJpbmcoKSksCgkgIGtleWJhc2VVc2VybmFtZTogb3B0aW9uYWwoc3RyaW5nKCkpCgl9KTsKCgkvKioKCSAqIFZhbGlkYXRvckluZm8gY2xhc3MKCSAqLwoJY2xhc3MgVmFsaWRhdG9ySW5mbyB7CgkgIC8qKgoJICAgKiBDb25zdHJ1Y3QgYSB2YWxpZCBWYWxpZGF0b3JJbmZvCgkgICAqCgkgICAqIEBwYXJhbSBrZXkgdmFsaWRhdG9yIHB1YmxpYyBrZXkKCSAgICogQHBhcmFtIGluZm8gdmFsaWRhdG9yIGluZm9ybWF0aW9uCgkgICAqLwoJICBjb25zdHJ1Y3RvcihrZXksIGluZm8pIHsKCSAgICAvKioKCSAgICAgKiB2YWxpZGF0b3IgcHVibGljIGtleQoJICAgICAqLwoJICAgIHRoaXMua2V5ID0gdm9pZCAwOwoJICAgIC8qKgoJICAgICAqIHZhbGlkYXRvciBpbmZvcm1hdGlvbgoJICAgICAqLwoJICAgIHRoaXMuaW5mbyA9IHZvaWQgMDsKCSAgICB0aGlzLmtleSA9IGtleTsKCSAgICB0aGlzLmluZm8gPSBpbmZvOwoJICB9CgoJICAvKioKCSAgICogRGVzZXJpYWxpemUgVmFsaWRhdG9ySW5mbyBmcm9tIHRoZSBjb25maWcgYWNjb3VudCBkYXRhLiBFeGFjdGx5IHR3byBjb25maWcKCSAgICoga2V5cyBhcmUgcmVxdWlyZWQgaW4gdGhlIGRhdGEuCgkgICAqCgkgICAqIEBwYXJhbSBidWZmZXIgY29uZmlnIGFjY291bnQgZGF0YQoJICAgKiBAcmV0dXJuIG51bGwgaWYgaW5mbyB3YXMgbm90IGZvdW5kCgkgICAqLwoJICBzdGF0aWMgZnJvbUNvbmZpZ0RhdGEoYnVmZmVyKSB7CgkgICAgbGV0IGJ5dGVBcnJheSA9IFsuLi5idWZmZXJdOwoJICAgIGNvbnN0IGNvbmZpZ0tleUNvdW50ID0gZGVjb2RlTGVuZ3RoKGJ5dGVBcnJheSk7CgkgICAgaWYgKGNvbmZpZ0tleUNvdW50ICE9PSAyKSByZXR1cm4gbnVsbDsKCSAgICBjb25zdCBjb25maWdLZXlzID0gW107CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyOyBpKyspIHsKCSAgICAgIGNvbnN0IHB1YmxpY0tleSA9IG5ldyBQdWJsaWNLZXkoZ3VhcmRlZFNwbGljZShieXRlQXJyYXksIDAsIFBVQkxJQ19LRVlfTEVOR1RIKSk7CgkgICAgICBjb25zdCBpc1NpZ25lciA9IGd1YXJkZWRTaGlmdChieXRlQXJyYXkpID09PSAxOwoJICAgICAgY29uZmlnS2V5cy5wdXNoKHsKCSAgICAgICAgcHVibGljS2V5LAoJICAgICAgICBpc1NpZ25lcgoJICAgICAgfSk7CgkgICAgfQoJICAgIGlmIChjb25maWdLZXlzWzBdLnB1YmxpY0tleS5lcXVhbHMoVkFMSURBVE9SX0lORk9fS0VZKSkgewoJICAgICAgaWYgKGNvbmZpZ0tleXNbMV0uaXNTaWduZXIpIHsKCSAgICAgICAgY29uc3QgcmF3SW5mbyA9IHJ1c3RTdHJpbmcoKS5kZWNvZGUoYnVmZmVyRXhwb3J0cy5CdWZmZXIuZnJvbShieXRlQXJyYXkpKTsKCSAgICAgICAgY29uc3QgaW5mbyA9IEpTT04ucGFyc2UocmF3SW5mbyk7CgkgICAgICAgIGFzc2VydChpbmZvLCBJbmZvU3RyaW5nKTsKCSAgICAgICAgcmV0dXJuIG5ldyBWYWxpZGF0b3JJbmZvKGNvbmZpZ0tleXNbMV0ucHVibGljS2V5LCBpbmZvKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG51bGw7CgkgIH0KCX0KCgljb25zdCBWT1RFX1BST0dSQU1fSUQgPSBuZXcgUHVibGljS2V5KCdWb3RlMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExJyk7CgoJLyoqCgkgKiBIaXN0b3J5IG9mIGhvdyBtYW55IGNyZWRpdHMgZWFybmVkIGJ5IHRoZSBlbmQgb2YgZWFjaCBlcG9jaAoJICovCgoJLyoqCgkgKiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3NvbGFuYS1sYWJzL3NvbGFuYS9ibG9iLzhhMTJlZDAyOWNmYTM4ZDRhNDU0MDA5MTZjMjQ2M2ZiODJiYmVjOGMvcHJvZ3JhbXMvdm90ZV9hcGkvc3JjL3ZvdGVfc3RhdGUucnMjTDY4LUw4OAoJICoKCSAqIEBpbnRlcm5hbAoJICovCgljb25zdCBWb3RlQWNjb3VudExheW91dCA9IExheW91dEV4cG9ydHMuc3RydWN0KFtwdWJsaWNLZXkoJ25vZGVQdWJrZXknKSwgcHVibGljS2V5KCdhdXRob3JpemVkV2l0aGRyYXdlcicpLCBMYXlvdXRFeHBvcnRzLnU4KCdjb21taXNzaW9uJyksIExheW91dEV4cG9ydHMubnU2NCgpLAoJLy8gdm90ZXMubGVuZ3RoCglMYXlvdXRFeHBvcnRzLnNlcShMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy5udTY0KCdzbG90JyksIExheW91dEV4cG9ydHMudTMyKCdjb25maXJtYXRpb25Db3VudCcpXSksIExheW91dEV4cG9ydHMub2Zmc2V0KExheW91dEV4cG9ydHMudTMyKCksIC04KSwgJ3ZvdGVzJyksIExheW91dEV4cG9ydHMudTgoJ3Jvb3RTbG90VmFsaWQnKSwgTGF5b3V0RXhwb3J0cy5udTY0KCdyb290U2xvdCcpLCBMYXlvdXRFeHBvcnRzLm51NjQoKSwKCS8vIGF1dGhvcml6ZWRWb3RlcnMubGVuZ3RoCglMYXlvdXRFeHBvcnRzLnNlcShMYXlvdXRFeHBvcnRzLnN0cnVjdChbTGF5b3V0RXhwb3J0cy5udTY0KCdlcG9jaCcpLCBwdWJsaWNLZXkoJ2F1dGhvcml6ZWRWb3RlcicpXSksIExheW91dEV4cG9ydHMub2Zmc2V0KExheW91dEV4cG9ydHMudTMyKCksIC04KSwgJ2F1dGhvcml6ZWRWb3RlcnMnKSwgTGF5b3V0RXhwb3J0cy5zdHJ1Y3QoW0xheW91dEV4cG9ydHMuc2VxKExheW91dEV4cG9ydHMuc3RydWN0KFtwdWJsaWNLZXkoJ2F1dGhvcml6ZWRQdWJrZXknKSwgTGF5b3V0RXhwb3J0cy5udTY0KCdlcG9jaE9mTGFzdEF1dGhvcml6ZWRTd2l0Y2gnKSwgTGF5b3V0RXhwb3J0cy5udTY0KCd0YXJnZXRFcG9jaCcpXSksIDMyLCAnYnVmJyksIExheW91dEV4cG9ydHMubnU2NCgnaWR4JyksIExheW91dEV4cG9ydHMudTgoJ2lzRW1wdHknKV0sICdwcmlvclZvdGVycycpLCBMYXlvdXRFeHBvcnRzLm51NjQoKSwKCS8vIGVwb2NoQ3JlZGl0cy5sZW5ndGgKCUxheW91dEV4cG9ydHMuc2VxKExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLm51NjQoJ2Vwb2NoJyksIExheW91dEV4cG9ydHMubnU2NCgnY3JlZGl0cycpLCBMYXlvdXRFeHBvcnRzLm51NjQoJ3ByZXZDcmVkaXRzJyldKSwgTGF5b3V0RXhwb3J0cy5vZmZzZXQoTGF5b3V0RXhwb3J0cy51MzIoKSwgLTgpLCAnZXBvY2hDcmVkaXRzJyksIExheW91dEV4cG9ydHMuc3RydWN0KFtMYXlvdXRFeHBvcnRzLm51NjQoJ3Nsb3QnKSwgTGF5b3V0RXhwb3J0cy5udTY0KCd0aW1lc3RhbXAnKV0sICdsYXN0VGltZXN0YW1wJyldKTsKCS8qKgoJICogVm90ZUFjY291bnQgY2xhc3MKCSAqLwoJY2xhc3MgVm90ZUFjY291bnQgewoJICAvKioKCSAgICogQGludGVybmFsCgkgICAqLwoJICBjb25zdHJ1Y3RvcihhcmdzKSB7CgkgICAgdGhpcy5ub2RlUHVia2V5ID0gdm9pZCAwOwoJICAgIHRoaXMuYXV0aG9yaXplZFdpdGhkcmF3ZXIgPSB2b2lkIDA7CgkgICAgdGhpcy5jb21taXNzaW9uID0gdm9pZCAwOwoJICAgIHRoaXMucm9vdFNsb3QgPSB2b2lkIDA7CgkgICAgdGhpcy52b3RlcyA9IHZvaWQgMDsKCSAgICB0aGlzLmF1dGhvcml6ZWRWb3RlcnMgPSB2b2lkIDA7CgkgICAgdGhpcy5wcmlvclZvdGVycyA9IHZvaWQgMDsKCSAgICB0aGlzLmVwb2NoQ3JlZGl0cyA9IHZvaWQgMDsKCSAgICB0aGlzLmxhc3RUaW1lc3RhbXAgPSB2b2lkIDA7CgkgICAgdGhpcy5ub2RlUHVia2V5ID0gYXJncy5ub2RlUHVia2V5OwoJICAgIHRoaXMuYXV0aG9yaXplZFdpdGhkcmF3ZXIgPSBhcmdzLmF1dGhvcml6ZWRXaXRoZHJhd2VyOwoJICAgIHRoaXMuY29tbWlzc2lvbiA9IGFyZ3MuY29tbWlzc2lvbjsKCSAgICB0aGlzLnJvb3RTbG90ID0gYXJncy5yb290U2xvdDsKCSAgICB0aGlzLnZvdGVzID0gYXJncy52b3RlczsKCSAgICB0aGlzLmF1dGhvcml6ZWRWb3RlcnMgPSBhcmdzLmF1dGhvcml6ZWRWb3RlcnM7CgkgICAgdGhpcy5wcmlvclZvdGVycyA9IGFyZ3MucHJpb3JWb3RlcnM7CgkgICAgdGhpcy5lcG9jaENyZWRpdHMgPSBhcmdzLmVwb2NoQ3JlZGl0czsKCSAgICB0aGlzLmxhc3RUaW1lc3RhbXAgPSBhcmdzLmxhc3RUaW1lc3RhbXA7CgkgIH0KCgkgIC8qKgoJICAgKiBEZXNlcmlhbGl6ZSBWb3RlQWNjb3VudCBmcm9tIHRoZSBhY2NvdW50IGRhdGEuCgkgICAqCgkgICAqIEBwYXJhbSBidWZmZXIgYWNjb3VudCBkYXRhCgkgICAqIEByZXR1cm4gVm90ZUFjY291bnQKCSAgICovCgkgIHN0YXRpYyBmcm9tQWNjb3VudERhdGEoYnVmZmVyKSB7CgkgICAgY29uc3QgdmVyc2lvbk9mZnNldCA9IDQ7CgkgICAgY29uc3QgdmEgPSBWb3RlQWNjb3VudExheW91dC5kZWNvZGUodG9CdWZmZXIoYnVmZmVyKSwgdmVyc2lvbk9mZnNldCk7CgkgICAgbGV0IHJvb3RTbG90ID0gdmEucm9vdFNsb3Q7CgkgICAgaWYgKCF2YS5yb290U2xvdFZhbGlkKSB7CgkgICAgICByb290U2xvdCA9IG51bGw7CgkgICAgfQoJICAgIHJldHVybiBuZXcgVm90ZUFjY291bnQoewoJICAgICAgbm9kZVB1YmtleTogbmV3IFB1YmxpY0tleSh2YS5ub2RlUHVia2V5KSwKCSAgICAgIGF1dGhvcml6ZWRXaXRoZHJhd2VyOiBuZXcgUHVibGljS2V5KHZhLmF1dGhvcml6ZWRXaXRoZHJhd2VyKSwKCSAgICAgIGNvbW1pc3Npb246IHZhLmNvbW1pc3Npb24sCgkgICAgICB2b3RlczogdmEudm90ZXMsCgkgICAgICByb290U2xvdCwKCSAgICAgIGF1dGhvcml6ZWRWb3RlcnM6IHZhLmF1dGhvcml6ZWRWb3RlcnMubWFwKHBhcnNlQXV0aG9yaXplZFZvdGVyKSwKCSAgICAgIHByaW9yVm90ZXJzOiBnZXRQcmlvclZvdGVycyh2YS5wcmlvclZvdGVycyksCgkgICAgICBlcG9jaENyZWRpdHM6IHZhLmVwb2NoQ3JlZGl0cywKCSAgICAgIGxhc3RUaW1lc3RhbXA6IHZhLmxhc3RUaW1lc3RhbXAKCSAgICB9KTsKCSAgfQoJfQoJZnVuY3Rpb24gcGFyc2VBdXRob3JpemVkVm90ZXIoewoJICBhdXRob3JpemVkVm90ZXIsCgkgIGVwb2NoCgl9KSB7CgkgIHJldHVybiB7CgkgICAgZXBvY2gsCgkgICAgYXV0aG9yaXplZFZvdGVyOiBuZXcgUHVibGljS2V5KGF1dGhvcml6ZWRWb3RlcikKCSAgfTsKCX0KCWZ1bmN0aW9uIHBhcnNlUHJpb3JWb3RlcnMoewoJICBhdXRob3JpemVkUHVia2V5LAoJICBlcG9jaE9mTGFzdEF1dGhvcml6ZWRTd2l0Y2gsCgkgIHRhcmdldEVwb2NoCgl9KSB7CgkgIHJldHVybiB7CgkgICAgYXV0aG9yaXplZFB1YmtleTogbmV3IFB1YmxpY0tleShhdXRob3JpemVkUHVia2V5KSwKCSAgICBlcG9jaE9mTGFzdEF1dGhvcml6ZWRTd2l0Y2gsCgkgICAgdGFyZ2V0RXBvY2gKCSAgfTsKCX0KCWZ1bmN0aW9uIGdldFByaW9yVm90ZXJzKHsKCSAgYnVmLAoJICBpZHgsCgkgIGlzRW1wdHkKCX0pIHsKCSAgaWYgKGlzRW1wdHkpIHsKCSAgICByZXR1cm4gW107CgkgIH0KCSAgcmV0dXJuIFsuLi5idWYuc2xpY2UoaWR4ICsgMSkubWFwKHBhcnNlUHJpb3JWb3RlcnMpLCAuLi5idWYuc2xpY2UoMCwgaWR4KS5tYXAocGFyc2VQcmlvclZvdGVycyldOwoJfQoKCWNvbnN0IGVuZHBvaW50ID0gewoJICBodHRwOiB7CgkgICAgZGV2bmV0OiAnaHR0cDovL2FwaS5kZXZuZXQuc29sYW5hLmNvbScsCgkgICAgdGVzdG5ldDogJ2h0dHA6Ly9hcGkudGVzdG5ldC5zb2xhbmEuY29tJywKCSAgICAnbWFpbm5ldC1iZXRhJzogJ2h0dHA6Ly9hcGkubWFpbm5ldC1iZXRhLnNvbGFuYS5jb20vJwoJICB9LAoJICBodHRwczogewoJICAgIGRldm5ldDogJ2h0dHBzOi8vYXBpLmRldm5ldC5zb2xhbmEuY29tJywKCSAgICB0ZXN0bmV0OiAnaHR0cHM6Ly9hcGkudGVzdG5ldC5zb2xhbmEuY29tJywKCSAgICAnbWFpbm5ldC1iZXRhJzogJ2h0dHBzOi8vYXBpLm1haW5uZXQtYmV0YS5zb2xhbmEuY29tLycKCSAgfQoJfTsKCS8qKgoJICogUmV0cmlldmVzIHRoZSBSUEMgQVBJIFVSTCBmb3IgdGhlIHNwZWNpZmllZCBjbHVzdGVyCgkgKiBAcGFyYW0ge0NsdXN0ZXJ9IFtjbHVzdGVyPSJkZXZuZXQiXSAtIFRoZSBjbHVzdGVyIG5hbWUgb2YgdGhlIFJQQyBBUEkgVVJMIHRvIHVzZS4gUG9zc2libGUgb3B0aW9uczogJ2Rldm5ldCcgfCAndGVzdG5ldCcgfCAnbWFpbm5ldC1iZXRhJwoJICogQHBhcmFtIHtib29sZWFufSBbdGxzPSJodHRwIl0gLSBVc2UgVExTIHdoZW4gY29ubmVjdGluZyB0byBjbHVzdGVyLgoJICoKCSAqIEByZXR1cm5zIHtzdHJpbmd9IFVSTCBzdHJpbmcgb2YgdGhlIFJQQyBlbmRwb2ludAoJICovCglmdW5jdGlvbiBjbHVzdGVyQXBpVXJsKGNsdXN0ZXIsIHRscykgewoJICBjb25zdCBrZXkgPSB0bHMgPT09IGZhbHNlID8gJ2h0dHAnIDogJ2h0dHBzJzsKCSAgaWYgKCFjbHVzdGVyKSB7CgkgICAgcmV0dXJuIGVuZHBvaW50W2tleV1bJ2Rldm5ldCddOwoJICB9CgkgIGNvbnN0IHVybCA9IGVuZHBvaW50W2tleV1bY2x1c3Rlcl07CgkgIGlmICghdXJsKSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duICR7a2V5fSBjbHVzdGVyOiAke2NsdXN0ZXJ9YCk7CgkgIH0KCSAgcmV0dXJuIHVybDsKCX0KCgkvKioKCSAqIFNlbmQgYW5kIGNvbmZpcm0gYSByYXcgdHJhbnNhY3Rpb24KCSAqCgkgKiBJZiBgY29tbWl0bWVudGAgb3B0aW9uIGlzIG5vdCBzcGVjaWZpZWQsIGRlZmF1bHRzIHRvICdtYXgnIGNvbW1pdG1lbnQuCgkgKgoJICogQHBhcmFtIHtDb25uZWN0aW9ufSBjb25uZWN0aW9uCgkgKiBAcGFyYW0ge0J1ZmZlcn0gcmF3VHJhbnNhY3Rpb24KCSAqIEBwYXJhbSB7VHJhbnNhY3Rpb25Db25maXJtYXRpb25TdHJhdGVneX0gY29uZmlybWF0aW9uU3RyYXRlZ3kKCSAqIEBwYXJhbSB7Q29uZmlybU9wdGlvbnN9IFtvcHRpb25zXQoJICogQHJldHVybnMge1Byb21pc2U8VHJhbnNhY3Rpb25TaWduYXR1cmU+fQoJICovCgoJLyoqCgkgKiBAZGVwcmVjYXRlZCBDYWxsaW5nIGBzZW5kQW5kQ29uZmlybVJhd1RyYW5zYWN0aW9uKClgIHdpdGhvdXQgYSBgY29uZmlybWF0aW9uU3RyYXRlZ3lgCgkgKiBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbi4KCSAqLwoJLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlZGVjbGFyZQoKCS8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZWRlY2xhcmUKCWFzeW5jIGZ1bmN0aW9uIHNlbmRBbmRDb25maXJtUmF3VHJhbnNhY3Rpb24oY29ubmVjdGlvbiwgcmF3VHJhbnNhY3Rpb24sIGNvbmZpcm1hdGlvblN0cmF0ZWd5T3JDb25maXJtT3B0aW9ucywgbWF5YmVDb25maXJtT3B0aW9ucykgewoJICBsZXQgY29uZmlybWF0aW9uU3RyYXRlZ3k7CgkgIGxldCBvcHRpb25zOwoJICBpZiAoY29uZmlybWF0aW9uU3RyYXRlZ3lPckNvbmZpcm1PcHRpb25zICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChjb25maXJtYXRpb25TdHJhdGVneU9yQ29uZmlybU9wdGlvbnMsICdsYXN0VmFsaWRCbG9ja0hlaWdodCcpKSB7CgkgICAgY29uZmlybWF0aW9uU3RyYXRlZ3kgPSBjb25maXJtYXRpb25TdHJhdGVneU9yQ29uZmlybU9wdGlvbnM7CgkgICAgb3B0aW9ucyA9IG1heWJlQ29uZmlybU9wdGlvbnM7CgkgIH0gZWxzZSBpZiAoY29uZmlybWF0aW9uU3RyYXRlZ3lPckNvbmZpcm1PcHRpb25zICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChjb25maXJtYXRpb25TdHJhdGVneU9yQ29uZmlybU9wdGlvbnMsICdub25jZVZhbHVlJykpIHsKCSAgICBjb25maXJtYXRpb25TdHJhdGVneSA9IGNvbmZpcm1hdGlvblN0cmF0ZWd5T3JDb25maXJtT3B0aW9uczsKCSAgICBvcHRpb25zID0gbWF5YmVDb25maXJtT3B0aW9uczsKCSAgfSBlbHNlIHsKCSAgICBvcHRpb25zID0gY29uZmlybWF0aW9uU3RyYXRlZ3lPckNvbmZpcm1PcHRpb25zOwoJICB9CgkgIGNvbnN0IHNlbmRPcHRpb25zID0gb3B0aW9ucyAmJiB7CgkgICAgc2tpcFByZWZsaWdodDogb3B0aW9ucy5za2lwUHJlZmxpZ2h0LAoJICAgIHByZWZsaWdodENvbW1pdG1lbnQ6IG9wdGlvbnMucHJlZmxpZ2h0Q29tbWl0bWVudCB8fCBvcHRpb25zLmNvbW1pdG1lbnQsCgkgICAgbWluQ29udGV4dFNsb3Q6IG9wdGlvbnMubWluQ29udGV4dFNsb3QKCSAgfTsKCSAgY29uc3Qgc2lnbmF0dXJlID0gYXdhaXQgY29ubmVjdGlvbi5zZW5kUmF3VHJhbnNhY3Rpb24ocmF3VHJhbnNhY3Rpb24sIHNlbmRPcHRpb25zKTsKCSAgY29uc3QgY29tbWl0bWVudCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5jb21taXRtZW50OwoJICBjb25zdCBjb25maXJtYXRpb25Qcm9taXNlID0gY29uZmlybWF0aW9uU3RyYXRlZ3kgPyBjb25uZWN0aW9uLmNvbmZpcm1UcmFuc2FjdGlvbihjb25maXJtYXRpb25TdHJhdGVneSwgY29tbWl0bWVudCkgOiBjb25uZWN0aW9uLmNvbmZpcm1UcmFuc2FjdGlvbihzaWduYXR1cmUsIGNvbW1pdG1lbnQpOwoJICBjb25zdCBzdGF0dXMgPSAoYXdhaXQgY29uZmlybWF0aW9uUHJvbWlzZSkudmFsdWU7CgkgIGlmIChzdGF0dXMuZXJyKSB7CgkgICAgaWYgKHNpZ25hdHVyZSAhPSBudWxsKSB7CgkgICAgICB0aHJvdyBuZXcgU2VuZFRyYW5zYWN0aW9uRXJyb3IoewoJICAgICAgICBhY3Rpb246IHNlbmRPcHRpb25zPy5za2lwUHJlZmxpZ2h0ID8gJ3NlbmQnIDogJ3NpbXVsYXRlJywKCSAgICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmUsCgkgICAgICAgIHRyYW5zYWN0aW9uTWVzc2FnZTogYFN0YXR1czogKCR7SlNPTi5zdHJpbmdpZnkoc3RhdHVzKX0pYAoJICAgICAgfSk7CgkgICAgfQoJICAgIHRocm93IG5ldyBFcnJvcihgUmF3IHRyYW5zYWN0aW9uICR7c2lnbmF0dXJlfSBmYWlsZWQgKCR7SlNPTi5zdHJpbmdpZnkoc3RhdHVzKX0pYCk7CgkgIH0KCSAgcmV0dXJuIHNpZ25hdHVyZTsKCX0KCgkvKioKCSAqIFRoZXJlIGFyZSAxLWJpbGxpb24gbGFtcG9ydHMgaW4gb25lIFNPTAoJICovCgljb25zdCBMQU1QT1JUU19QRVJfU09MID0gMTAwMDAwMDAwMDsKCglleHBvcnRzLkFjY291bnQgPSBBY2NvdW50OwoJZXhwb3J0cy5BZGRyZXNzTG9va3VwVGFibGVBY2NvdW50ID0gQWRkcmVzc0xvb2t1cFRhYmxlQWNjb3VudDsKCWV4cG9ydHMuQWRkcmVzc0xvb2t1cFRhYmxlSW5zdHJ1Y3Rpb24gPSBBZGRyZXNzTG9va3VwVGFibGVJbnN0cnVjdGlvbjsKCWV4cG9ydHMuQWRkcmVzc0xvb2t1cFRhYmxlUHJvZ3JhbSA9IEFkZHJlc3NMb29rdXBUYWJsZVByb2dyYW07CglleHBvcnRzLkF1dGhvcml6ZWQgPSBBdXRob3JpemVkOwoJZXhwb3J0cy5CTE9DS0hBU0hfQ0FDSEVfVElNRU9VVF9NUyA9IEJMT0NLSEFTSF9DQUNIRV9USU1FT1VUX01TOwoJZXhwb3J0cy5CUEZfTE9BREVSX0RFUFJFQ0FURURfUFJPR1JBTV9JRCA9IEJQRl9MT0FERVJfREVQUkVDQVRFRF9QUk9HUkFNX0lEOwoJZXhwb3J0cy5CUEZfTE9BREVSX1BST0dSQU1fSUQgPSBCUEZfTE9BREVSX1BST0dSQU1fSUQ7CglleHBvcnRzLkJwZkxvYWRlciA9IEJwZkxvYWRlcjsKCWV4cG9ydHMuQ09NUFVURV9CVURHRVRfSU5TVFJVQ1RJT05fTEFZT1VUUyA9IENPTVBVVEVfQlVER0VUX0lOU1RSVUNUSU9OX0xBWU9VVFM7CglleHBvcnRzLkNvbXB1dGVCdWRnZXRJbnN0cnVjdGlvbiA9IENvbXB1dGVCdWRnZXRJbnN0cnVjdGlvbjsKCWV4cG9ydHMuQ29tcHV0ZUJ1ZGdldFByb2dyYW0gPSBDb21wdXRlQnVkZ2V0UHJvZ3JhbTsKCWV4cG9ydHMuQ29ubmVjdGlvbiA9IENvbm5lY3Rpb247CglleHBvcnRzLkVkMjU1MTlQcm9ncmFtID0gRWQyNTUxOVByb2dyYW07CglleHBvcnRzLkVudW0gPSBFbnVtOwoJZXhwb3J0cy5FcG9jaFNjaGVkdWxlID0gRXBvY2hTY2hlZHVsZTsKCWV4cG9ydHMuRmVlQ2FsY3VsYXRvckxheW91dCA9IEZlZUNhbGN1bGF0b3JMYXlvdXQ7CglleHBvcnRzLktleXBhaXIgPSBLZXlwYWlyOwoJZXhwb3J0cy5MQU1QT1JUU19QRVJfU09MID0gTEFNUE9SVFNfUEVSX1NPTDsKCWV4cG9ydHMuTE9PS1VQX1RBQkxFX0lOU1RSVUNUSU9OX0xBWU9VVFMgPSBMT09LVVBfVEFCTEVfSU5TVFJVQ1RJT05fTEFZT1VUUzsKCWV4cG9ydHMuTG9hZGVyID0gTG9hZGVyOwoJZXhwb3J0cy5Mb2NrdXAgPSBMb2NrdXA7CglleHBvcnRzLk1BWF9TRUVEX0xFTkdUSCA9IE1BWF9TRUVEX0xFTkdUSDsKCWV4cG9ydHMuTWVzc2FnZSA9IE1lc3NhZ2U7CglleHBvcnRzLk1lc3NhZ2VBY2NvdW50S2V5cyA9IE1lc3NhZ2VBY2NvdW50S2V5czsKCWV4cG9ydHMuTWVzc2FnZVYwID0gTWVzc2FnZVYwOwoJZXhwb3J0cy5OT05DRV9BQ0NPVU5UX0xFTkdUSCA9IE5PTkNFX0FDQ09VTlRfTEVOR1RIOwoJZXhwb3J0cy5Ob25jZUFjY291bnQgPSBOb25jZUFjY291bnQ7CglleHBvcnRzLlBBQ0tFVF9EQVRBX1NJWkUgPSBQQUNLRVRfREFUQV9TSVpFOwoJZXhwb3J0cy5QVUJMSUNfS0VZX0xFTkdUSCA9IFBVQkxJQ19LRVlfTEVOR1RIOwoJZXhwb3J0cy5QdWJsaWNLZXkgPSBQdWJsaWNLZXk7CglleHBvcnRzLlNJR05BVFVSRV9MRU5HVEhfSU5fQllURVMgPSBTSUdOQVRVUkVfTEVOR1RIX0lOX0JZVEVTOwoJZXhwb3J0cy5TT0xBTkFfU0NIRU1BID0gU09MQU5BX1NDSEVNQTsKCWV4cG9ydHMuU1RBS0VfQ09ORklHX0lEID0gU1RBS0VfQ09ORklHX0lEOwoJZXhwb3J0cy5TVEFLRV9JTlNUUlVDVElPTl9MQVlPVVRTID0gU1RBS0VfSU5TVFJVQ1RJT05fTEFZT1VUUzsKCWV4cG9ydHMuU1lTVEVNX0lOU1RSVUNUSU9OX0xBWU9VVFMgPSBTWVNURU1fSU5TVFJVQ1RJT05fTEFZT1VUUzsKCWV4cG9ydHMuU1lTVkFSX0NMT0NLX1BVQktFWSA9IFNZU1ZBUl9DTE9DS19QVUJLRVk7CglleHBvcnRzLlNZU1ZBUl9FUE9DSF9TQ0hFRFVMRV9QVUJLRVkgPSBTWVNWQVJfRVBPQ0hfU0NIRURVTEVfUFVCS0VZOwoJZXhwb3J0cy5TWVNWQVJfSU5TVFJVQ1RJT05TX1BVQktFWSA9IFNZU1ZBUl9JTlNUUlVDVElPTlNfUFVCS0VZOwoJZXhwb3J0cy5TWVNWQVJfUkVDRU5UX0JMT0NLSEFTSEVTX1BVQktFWSA9IFNZU1ZBUl9SRUNFTlRfQkxPQ0tIQVNIRVNfUFVCS0VZOwoJZXhwb3J0cy5TWVNWQVJfUkVOVF9QVUJLRVkgPSBTWVNWQVJfUkVOVF9QVUJLRVk7CglleHBvcnRzLlNZU1ZBUl9SRVdBUkRTX1BVQktFWSA9IFNZU1ZBUl9SRVdBUkRTX1BVQktFWTsKCWV4cG9ydHMuU1lTVkFSX1NMT1RfSEFTSEVTX1BVQktFWSA9IFNZU1ZBUl9TTE9UX0hBU0hFU19QVUJLRVk7CglleHBvcnRzLlNZU1ZBUl9TTE9UX0hJU1RPUllfUFVCS0VZID0gU1lTVkFSX1NMT1RfSElTVE9SWV9QVUJLRVk7CglleHBvcnRzLlNZU1ZBUl9TVEFLRV9ISVNUT1JZX1BVQktFWSA9IFNZU1ZBUl9TVEFLRV9ISVNUT1JZX1BVQktFWTsKCWV4cG9ydHMuU2VjcDI1NmsxUHJvZ3JhbSA9IFNlY3AyNTZrMVByb2dyYW07CglleHBvcnRzLlNlbmRUcmFuc2FjdGlvbkVycm9yID0gU2VuZFRyYW5zYWN0aW9uRXJyb3I7CglleHBvcnRzLlNvbGFuYUpTT05SUENFcnJvciA9IFNvbGFuYUpTT05SUENFcnJvcjsKCWV4cG9ydHMuU29sYW5hSlNPTlJQQ0Vycm9yQ29kZSA9IFNvbGFuYUpTT05SUENFcnJvckNvZGU7CglleHBvcnRzLlN0YWtlQXV0aG9yaXphdGlvbkxheW91dCA9IFN0YWtlQXV0aG9yaXphdGlvbkxheW91dDsKCWV4cG9ydHMuU3Rha2VJbnN0cnVjdGlvbiA9IFN0YWtlSW5zdHJ1Y3Rpb247CglleHBvcnRzLlN0YWtlUHJvZ3JhbSA9IFN0YWtlUHJvZ3JhbTsKCWV4cG9ydHMuU3RydWN0ID0gU3RydWN0JDE7CglleHBvcnRzLlN5c3RlbUluc3RydWN0aW9uID0gU3lzdGVtSW5zdHJ1Y3Rpb247CglleHBvcnRzLlN5c3RlbVByb2dyYW0gPSBTeXN0ZW1Qcm9ncmFtOwoJZXhwb3J0cy5UcmFuc2FjdGlvbiA9IFRyYW5zYWN0aW9uOwoJZXhwb3J0cy5UcmFuc2FjdGlvbkV4cGlyZWRCbG9ja2hlaWdodEV4Y2VlZGVkRXJyb3IgPSBUcmFuc2FjdGlvbkV4cGlyZWRCbG9ja2hlaWdodEV4Y2VlZGVkRXJyb3I7CglleHBvcnRzLlRyYW5zYWN0aW9uRXhwaXJlZE5vbmNlSW52YWxpZEVycm9yID0gVHJhbnNhY3Rpb25FeHBpcmVkTm9uY2VJbnZhbGlkRXJyb3I7CglleHBvcnRzLlRyYW5zYWN0aW9uRXhwaXJlZFRpbWVvdXRFcnJvciA9IFRyYW5zYWN0aW9uRXhwaXJlZFRpbWVvdXRFcnJvcjsKCWV4cG9ydHMuVHJhbnNhY3Rpb25JbnN0cnVjdGlvbiA9IFRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb247CglleHBvcnRzLlRyYW5zYWN0aW9uTWVzc2FnZSA9IFRyYW5zYWN0aW9uTWVzc2FnZTsKCWV4cG9ydHMuVHJhbnNhY3Rpb25TdGF0dXMgPSBUcmFuc2FjdGlvblN0YXR1czsKCWV4cG9ydHMuVkFMSURBVE9SX0lORk9fS0VZID0gVkFMSURBVE9SX0lORk9fS0VZOwoJZXhwb3J0cy5WRVJTSU9OX1BSRUZJWF9NQVNLID0gVkVSU0lPTl9QUkVGSVhfTUFTSzsKCWV4cG9ydHMuVk9URV9QUk9HUkFNX0lEID0gVk9URV9QUk9HUkFNX0lEOwoJZXhwb3J0cy5WYWxpZGF0b3JJbmZvID0gVmFsaWRhdG9ySW5mbzsKCWV4cG9ydHMuVmVyc2lvbmVkTWVzc2FnZSA9IFZlcnNpb25lZE1lc3NhZ2U7CglleHBvcnRzLlZlcnNpb25lZFRyYW5zYWN0aW9uID0gVmVyc2lvbmVkVHJhbnNhY3Rpb247CglleHBvcnRzLlZvdGVBY2NvdW50ID0gVm90ZUFjY291bnQ7CglleHBvcnRzLlZvdGVBdXRob3JpemF0aW9uTGF5b3V0ID0gVm90ZUF1dGhvcml6YXRpb25MYXlvdXQ7CglleHBvcnRzLlZvdGVJbml0ID0gVm90ZUluaXQ7CglleHBvcnRzLlZvdGVJbnN0cnVjdGlvbiA9IFZvdGVJbnN0cnVjdGlvbjsKCWV4cG9ydHMuVm90ZVByb2dyYW0gPSBWb3RlUHJvZ3JhbTsKCWV4cG9ydHMuY2x1c3RlckFwaVVybCA9IGNsdXN0ZXJBcGlVcmw7CglleHBvcnRzLnNlbmRBbmRDb25maXJtUmF3VHJhbnNhY3Rpb24gPSBzZW5kQW5kQ29uZmlybVJhd1RyYW5zYWN0aW9uOwoJZXhwb3J0cy5zZW5kQW5kQ29uZmlybVRyYW5zYWN0aW9uID0gc2VuZEFuZENvbmZpcm1UcmFuc2FjdGlvbjsKCglyZXR1cm4gZXhwb3J0czsKCn0pKHt9KTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW5kZXguaWlmZS5qcy5tYXAK"></script><script src="data:text/javascript;base64,LyohIEZvciBsaWNlbnNlIGluZm9ybWF0aW9uIHBsZWFzZSBzZWUgbnl4cGF5LXBheS1zZGsudW1kLmpzLkxJQ0VOU0UudHh0ICovCiFmdW5jdGlvbih0LGUpeyJvYmplY3QiPT10eXBlb2YgZXhwb3J0cyYmIm9iamVjdCI9PXR5cGVvZiBtb2R1bGU/bW9kdWxlLmV4cG9ydHM9ZShyZXF1aXJlKCJzb2xhbmFXZWIzIikpOiJmdW5jdGlvbiI9PXR5cGVvZiBkZWZpbmUmJmRlZmluZS5hbWQ/ZGVmaW5lKCJueXhwYXlQYXlTREsiLFsic29sYW5hV2ViMyJdLGUpOiJvYmplY3QiPT10eXBlb2YgZXhwb3J0cz9leHBvcnRzLm55eHBheVBheVNESz1lKHJlcXVpcmUoInNvbGFuYVdlYjMiKSk6dC5ueXhwYXlQYXlTREs9ZSh0LnNvbGFuYVdlYjMpfSh0aGlzLCh0PT4oKCk9Pnt2YXIgZT17MzplPT57InVzZSBzdHJpY3QiO2UuZXhwb3J0cz10fSwyNTE6KHQsZSk9PntlLnJlYWQ9ZnVuY3Rpb24odCxlLGkscixuKXt2YXIgbyxzLGg9OCpuLXItMSx1PSgxPDxoKS0xLGE9dT4+MSxsPS03LGY9aT9uLTE6MCxjPWk/LTE6MSxwPXRbZStmXTtmb3IoZis9YyxvPXAmKDE8PC1sKS0xLHA+Pj0tbCxsKz1oO2w+MDtvPTI1NipvK3RbZStmXSxmKz1jLGwtPTgpO2ZvcihzPW8mKDE8PC1sKS0xLG8+Pj0tbCxsKz1yO2w+MDtzPTI1NipzK3RbZStmXSxmKz1jLGwtPTgpO2lmKDA9PT1vKW89MS1hO2Vsc2V7aWYobz09PXUpcmV0dXJuIHM/TmFOOjEvMCoocD8tMToxKTtzKz1NYXRoLnBvdygyLHIpLG8tPWF9cmV0dXJuKHA/LTE6MSkqcypNYXRoLnBvdygyLG8tcil9LGUud3JpdGU9ZnVuY3Rpb24odCxlLGkscixuLG8pe3ZhciBzLGgsdSxhPTgqby1uLTEsbD0oMTw8YSktMSxmPWw+PjEsYz0yMz09PW4/TWF0aC5wb3coMiwtMjQpLU1hdGgucG93KDIsLTc3KTowLHA9cj8wOm8tMSxtPXI/MTotMSxkPWU8MHx8MD09PWUmJjEvZTwwPzE6MDtmb3IoZT1NYXRoLmFicyhlKSxpc05hTihlKXx8ZT09PTEvMD8oaD1pc05hTihlKT8xOjAscz1sKToocz1NYXRoLmZsb29yKE1hdGgubG9nKGUpL01hdGguTE4yKSxlKih1PU1hdGgucG93KDIsLXMpKTwxJiYocy0tLHUqPTIpLChlKz1zK2Y+PTE/Yy91OmMqTWF0aC5wb3coMiwxLWYpKSp1Pj0yJiYocysrLHUvPTIpLHMrZj49bD8oaD0wLHM9bCk6cytmPj0xPyhoPShlKnUtMSkqTWF0aC5wb3coMixuKSxzKz1mKTooaD1lKk1hdGgucG93KDIsZi0xKSpNYXRoLnBvdygyLG4pLHM9MCkpO24+PTg7dFtpK3BdPTI1NSZoLHArPW0saC89MjU2LG4tPTgpO2ZvcihzPXM8PG58aCxhKz1uO2E+MDt0W2krcF09MjU1JnMscCs9bSxzLz0yNTYsYS09OCk7dFtpK3AtbV18PTEyOCpkfX0sMjg3Oih0LGUsaSk9PnsidXNlIHN0cmljdCI7Y29uc3Qgcj1pKDUyNiksbj1pKDI1MSksbz0iZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiYiZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sLmZvcj9TeW1ib2wuZm9yKCJub2RlanMudXRpbC5pbnNwZWN0LmN1c3RvbSIpOm51bGw7ZS5ocD11LGUuSVM9NTA7Y29uc3Qgcz0yMTQ3NDgzNjQ3O2Z1bmN0aW9uIGgodCl7aWYodD5zKXRocm93IG5ldyBSYW5nZUVycm9yKCdUaGUgdmFsdWUgIicrdCsnIiBpcyBpbnZhbGlkIGZvciBvcHRpb24gInNpemUiJyk7Y29uc3QgZT1uZXcgVWludDhBcnJheSh0KTtyZXR1cm4gT2JqZWN0LnNldFByb3RvdHlwZU9mKGUsdS5wcm90b3R5cGUpLGV9ZnVuY3Rpb24gdSh0LGUsaSl7aWYoIm51bWJlciI9PXR5cGVvZiB0KXtpZigic3RyaW5nIj09dHlwZW9mIGUpdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlICJzdHJpbmciIGFyZ3VtZW50IG11c3QgYmUgb2YgdHlwZSBzdHJpbmcuIFJlY2VpdmVkIHR5cGUgbnVtYmVyJyk7cmV0dXJuIGYodCl9cmV0dXJuIGEodCxlLGkpfWZ1bmN0aW9uIGEodCxlLGkpe2lmKCJzdHJpbmciPT10eXBlb2YgdClyZXR1cm4gZnVuY3Rpb24odCxlKXtpZigic3RyaW5nIj09dHlwZW9mIGUmJiIiIT09ZXx8KGU9InV0ZjgiKSwhdS5pc0VuY29kaW5nKGUpKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZW5jb2Rpbmc6ICIrZSk7Y29uc3QgaT0wfGQodCxlKTtsZXQgcj1oKGkpO2NvbnN0IG49ci53cml0ZSh0LGUpO3JldHVybiBuIT09aSYmKHI9ci5zbGljZSgwLG4pKSxyfSh0LGUpO2lmKEFycmF5QnVmZmVyLmlzVmlldyh0KSlyZXR1cm4gZnVuY3Rpb24odCl7aWYoSCh0LFVpbnQ4QXJyYXkpKXtjb25zdCBlPW5ldyBVaW50OEFycmF5KHQpO3JldHVybiBwKGUuYnVmZmVyLGUuYnl0ZU9mZnNldCxlLmJ5dGVMZW5ndGgpfXJldHVybiBjKHQpfSh0KTtpZihudWxsPT10KXRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIG9uZSBvZiB0eXBlIHN0cmluZywgQnVmZmVyLCBBcnJheUJ1ZmZlciwgQXJyYXksIG9yIEFycmF5LWxpa2UgT2JqZWN0LiBSZWNlaXZlZCB0eXBlICIrdHlwZW9mIHQpO2lmKEgodCxBcnJheUJ1ZmZlcil8fHQmJkgodC5idWZmZXIsQXJyYXlCdWZmZXIpKXJldHVybiBwKHQsZSxpKTtpZigidW5kZWZpbmVkIiE9dHlwZW9mIFNoYXJlZEFycmF5QnVmZmVyJiYoSCh0LFNoYXJlZEFycmF5QnVmZmVyKXx8dCYmSCh0LmJ1ZmZlcixTaGFyZWRBcnJheUJ1ZmZlcikpKXJldHVybiBwKHQsZSxpKTtpZigibnVtYmVyIj09dHlwZW9mIHQpdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlICJ2YWx1ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgb2YgdHlwZSBudW1iZXIuIFJlY2VpdmVkIHR5cGUgbnVtYmVyJyk7Y29uc3Qgcj10LnZhbHVlT2YmJnQudmFsdWVPZigpO2lmKG51bGwhPXImJnIhPT10KXJldHVybiB1LmZyb20ocixlLGkpO2NvbnN0IG49ZnVuY3Rpb24odCl7aWYodS5pc0J1ZmZlcih0KSl7Y29uc3QgZT0wfG0odC5sZW5ndGgpLGk9aChlKTtyZXR1cm4gMD09PWkubGVuZ3RofHx0LmNvcHkoaSwwLDAsZSksaX1yZXR1cm4gdm9pZCAwIT09dC5sZW5ndGg/Im51bWJlciIhPXR5cGVvZiB0Lmxlbmd0aHx8Sih0Lmxlbmd0aCk/aCgwKTpjKHQpOiJCdWZmZXIiPT09dC50eXBlJiZBcnJheS5pc0FycmF5KHQuZGF0YSk/Yyh0LmRhdGEpOnZvaWQgMH0odCk7aWYobilyZXR1cm4gbjtpZigidW5kZWZpbmVkIiE9dHlwZW9mIFN5bWJvbCYmbnVsbCE9U3ltYm9sLnRvUHJpbWl0aXZlJiYiZnVuY3Rpb24iPT10eXBlb2YgdFtTeW1ib2wudG9QcmltaXRpdmVdKXJldHVybiB1LmZyb20odFtTeW1ib2wudG9QcmltaXRpdmVdKCJzdHJpbmciKSxlLGkpO3Rocm93IG5ldyBUeXBlRXJyb3IoIlRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIG9uZSBvZiB0eXBlIHN0cmluZywgQnVmZmVyLCBBcnJheUJ1ZmZlciwgQXJyYXksIG9yIEFycmF5LWxpa2UgT2JqZWN0LiBSZWNlaXZlZCB0eXBlICIrdHlwZW9mIHQpfWZ1bmN0aW9uIGwodCl7aWYoIm51bWJlciIhPXR5cGVvZiB0KXRocm93IG5ldyBUeXBlRXJyb3IoJyJzaXplIiBhcmd1bWVudCBtdXN0IGJlIG9mIHR5cGUgbnVtYmVyJyk7aWYodDwwKXRocm93IG5ldyBSYW5nZUVycm9yKCdUaGUgdmFsdWUgIicrdCsnIiBpcyBpbnZhbGlkIGZvciBvcHRpb24gInNpemUiJyl9ZnVuY3Rpb24gZih0KXtyZXR1cm4gbCh0KSxoKHQ8MD8wOjB8bSh0KSl9ZnVuY3Rpb24gYyh0KXtjb25zdCBlPXQubGVuZ3RoPDA/MDowfG0odC5sZW5ndGgpLGk9aChlKTtmb3IobGV0IHI9MDtyPGU7cis9MSlpW3JdPTI1NSZ0W3JdO3JldHVybiBpfWZ1bmN0aW9uIHAodCxlLGkpe2lmKGU8MHx8dC5ieXRlTGVuZ3RoPGUpdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJvZmZzZXQiIGlzIG91dHNpZGUgb2YgYnVmZmVyIGJvdW5kcycpO2lmKHQuYnl0ZUxlbmd0aDxlKyhpfHwwKSl0aHJvdyBuZXcgUmFuZ2VFcnJvcignImxlbmd0aCIgaXMgb3V0c2lkZSBvZiBidWZmZXIgYm91bmRzJyk7bGV0IHI7cmV0dXJuIHI9dm9pZCAwPT09ZSYmdm9pZCAwPT09aT9uZXcgVWludDhBcnJheSh0KTp2b2lkIDA9PT1pP25ldyBVaW50OEFycmF5KHQsZSk6bmV3IFVpbnQ4QXJyYXkodCxlLGkpLE9iamVjdC5zZXRQcm90b3R5cGVPZihyLHUucHJvdG90eXBlKSxyfWZ1bmN0aW9uIG0odCl7aWYodD49cyl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQXR0ZW1wdCB0byBhbGxvY2F0ZSBCdWZmZXIgbGFyZ2VyIHRoYW4gbWF4aW11bSBzaXplOiAweCIrcy50b1N0cmluZygxNikrIiBieXRlcyIpO3JldHVybiAwfHR9ZnVuY3Rpb24gZCh0LGUpe2lmKHUuaXNCdWZmZXIodCkpcmV0dXJuIHQubGVuZ3RoO2lmKEFycmF5QnVmZmVyLmlzVmlldyh0KXx8SCh0LEFycmF5QnVmZmVyKSlyZXR1cm4gdC5ieXRlTGVuZ3RoO2lmKCJzdHJpbmciIT10eXBlb2YgdCl0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgInN0cmluZyIgYXJndW1lbnQgbXVzdCBiZSBvbmUgb2YgdHlwZSBzdHJpbmcsIEJ1ZmZlciwgb3IgQXJyYXlCdWZmZXIuIFJlY2VpdmVkIHR5cGUgJyt0eXBlb2YgdCk7Y29uc3QgaT10Lmxlbmd0aCxyPWFyZ3VtZW50cy5sZW5ndGg+MiYmITA9PT1hcmd1bWVudHNbMl07aWYoIXImJjA9PT1pKXJldHVybiAwO2xldCBuPSExO2Zvcig7Oylzd2l0Y2goZSl7Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpyZXR1cm4gaTtjYXNlInV0ZjgiOmNhc2UidXRmLTgiOnJldHVybiBWKHQpLmxlbmd0aDtjYXNlInVjczIiOmNhc2UidWNzLTIiOmNhc2UidXRmMTZsZSI6Y2FzZSJ1dGYtMTZsZSI6cmV0dXJuIDIqaTtjYXNlImhleCI6cmV0dXJuIGk+Pj4xO2Nhc2UiYmFzZTY0IjpyZXR1cm4gRCh0KS5sZW5ndGg7ZGVmYXVsdDppZihuKXJldHVybiByPy0xOlYodCkubGVuZ3RoO2U9KCIiK2UpLnRvTG93ZXJDYXNlKCksbj0hMH19ZnVuY3Rpb24gZyh0LGUsaSl7bGV0IHI9ITE7aWYoKHZvaWQgMD09PWV8fGU8MCkmJihlPTApLGU+dGhpcy5sZW5ndGgpcmV0dXJuIiI7aWYoKHZvaWQgMD09PWl8fGk+dGhpcy5sZW5ndGgpJiYoaT10aGlzLmxlbmd0aCksaTw9MClyZXR1cm4iIjtpZigoaT4+Pj0wKTw9KGU+Pj49MCkpcmV0dXJuIiI7Zm9yKHR8fCh0PSJ1dGY4Iik7Oylzd2l0Y2godCl7Y2FzZSJoZXgiOnJldHVybiBSKHRoaXMsZSxpKTtjYXNlInV0ZjgiOmNhc2UidXRmLTgiOnJldHVybiBfKHRoaXMsZSxpKTtjYXNlImFzY2lpIjpyZXR1cm4gSSh0aGlzLGUsaSk7Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpyZXR1cm4gUyh0aGlzLGUsaSk7Y2FzZSJiYXNlNjQiOnJldHVybiBrKHRoaXMsZSxpKTtjYXNlInVjczIiOmNhc2UidWNzLTIiOmNhc2UidXRmMTZsZSI6Y2FzZSJ1dGYtMTZsZSI6cmV0dXJuIFUodGhpcyxlLGkpO2RlZmF1bHQ6aWYocil0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGVuY29kaW5nOiAiK3QpO3Q9KHQrIiIpLnRvTG93ZXJDYXNlKCkscj0hMH19ZnVuY3Rpb24geSh0LGUsaSl7Y29uc3Qgcj10W2VdO3RbZV09dFtpXSx0W2ldPXJ9ZnVuY3Rpb24gdyh0LGUsaSxyLG4pe2lmKDA9PT10Lmxlbmd0aClyZXR1cm4tMTtpZigic3RyaW5nIj09dHlwZW9mIGk/KHI9aSxpPTApOmk+MjE0NzQ4MzY0Nz9pPTIxNDc0ODM2NDc6aTwtMjE0NzQ4MzY0OCYmKGk9LTIxNDc0ODM2NDgpLEooaT0raSkmJihpPW4/MDp0Lmxlbmd0aC0xKSxpPDAmJihpPXQubGVuZ3RoK2kpLGk+PXQubGVuZ3RoKXtpZihuKXJldHVybi0xO2k9dC5sZW5ndGgtMX1lbHNlIGlmKGk8MCl7aWYoIW4pcmV0dXJuLTE7aT0wfWlmKCJzdHJpbmciPT10eXBlb2YgZSYmKGU9dS5mcm9tKGUscikpLHUuaXNCdWZmZXIoZSkpcmV0dXJuIDA9PT1lLmxlbmd0aD8tMTp2KHQsZSxpLHIsbik7aWYoIm51bWJlciI9PXR5cGVvZiBlKXJldHVybiBlJj0yNTUsImZ1bmN0aW9uIj09dHlwZW9mIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2Y/bj9VaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwodCxlLGkpOlVpbnQ4QXJyYXkucHJvdG90eXBlLmxhc3RJbmRleE9mLmNhbGwodCxlLGkpOnYodCxbZV0saSxyLG4pO3Rocm93IG5ldyBUeXBlRXJyb3IoInZhbCBtdXN0IGJlIHN0cmluZywgbnVtYmVyIG9yIEJ1ZmZlciIpfWZ1bmN0aW9uIHYodCxlLGkscixuKXtsZXQgbyxzPTEsaD10Lmxlbmd0aCx1PWUubGVuZ3RoO2lmKHZvaWQgMCE9PXImJigidWNzMiI9PT0ocj1TdHJpbmcocikudG9Mb3dlckNhc2UoKSl8fCJ1Y3MtMiI9PT1yfHwidXRmMTZsZSI9PT1yfHwidXRmLTE2bGUiPT09cikpe2lmKHQubGVuZ3RoPDJ8fGUubGVuZ3RoPDIpcmV0dXJuLTE7cz0yLGgvPTIsdS89MixpLz0yfWZ1bmN0aW9uIGEodCxlKXtyZXR1cm4gMT09PXM/dFtlXTp0LnJlYWRVSW50MTZCRShlKnMpfWlmKG4pe2xldCByPS0xO2ZvcihvPWk7bzxoO28rKylpZihhKHQsbyk9PT1hKGUsLTE9PT1yPzA6by1yKSl7aWYoLTE9PT1yJiYocj1vKSxvLXIrMT09PXUpcmV0dXJuIHIqc31lbHNlLTEhPT1yJiYoby09by1yKSxyPS0xfWVsc2UgZm9yKGkrdT5oJiYoaT1oLXUpLG89aTtvPj0wO28tLSl7bGV0IGk9ITA7Zm9yKGxldCByPTA7cjx1O3IrKylpZihhKHQsbytyKSE9PWEoZSxyKSl7aT0hMTticmVha31pZihpKXJldHVybiBvfXJldHVybi0xfWZ1bmN0aW9uIE0odCxlLGkscil7aT1OdW1iZXIoaSl8fDA7Y29uc3Qgbj10Lmxlbmd0aC1pO3I/KHI9TnVtYmVyKHIpKT5uJiYocj1uKTpyPW47Y29uc3Qgbz1lLmxlbmd0aDtsZXQgcztmb3Iocj5vLzImJihyPW8vMikscz0wO3M8cjsrK3Mpe2NvbnN0IHI9cGFyc2VJbnQoZS5zdWJzdHIoMipzLDIpLDE2KTtpZihKKHIpKXJldHVybiBzO3RbaStzXT1yfXJldHVybiBzfWZ1bmN0aW9uIGIodCxlLGkscil7cmV0dXJuIEcoVihlLHQubGVuZ3RoLWkpLHQsaSxyKX1mdW5jdGlvbiBBKHQsZSxpLHIpe3JldHVybiBHKGZ1bmN0aW9uKHQpe2NvbnN0IGU9W107Zm9yKGxldCBpPTA7aTx0Lmxlbmd0aDsrK2kpZS5wdXNoKDI1NSZ0LmNoYXJDb2RlQXQoaSkpO3JldHVybiBlfShlKSx0LGkscil9ZnVuY3Rpb24gQih0LGUsaSxyKXtyZXR1cm4gRyhEKGUpLHQsaSxyKX1mdW5jdGlvbiBFKHQsZSxpLHIpe3JldHVybiBHKGZ1bmN0aW9uKHQsZSl7bGV0IGkscixuO2NvbnN0IG89W107Zm9yKGxldCBzPTA7czx0Lmxlbmd0aCYmISgoZS09Mik8MCk7KytzKWk9dC5jaGFyQ29kZUF0KHMpLHI9aT4+OCxuPWklMjU2LG8ucHVzaChuKSxvLnB1c2gocik7cmV0dXJuIG99KGUsdC5sZW5ndGgtaSksdCxpLHIpfWZ1bmN0aW9uIGsodCxlLGkpe3JldHVybiAwPT09ZSYmaT09PXQubGVuZ3RoP3IuZnJvbUJ5dGVBcnJheSh0KTpyLmZyb21CeXRlQXJyYXkodC5zbGljZShlLGkpKX1mdW5jdGlvbiBfKHQsZSxpKXtpPU1hdGgubWluKHQubGVuZ3RoLGkpO2NvbnN0IHI9W107bGV0IG49ZTtmb3IoO248aTspe2NvbnN0IGU9dFtuXTtsZXQgbz1udWxsLHM9ZT4yMzk/NDplPjIyMz8zOmU+MTkxPzI6MTtpZihuK3M8PWkpe2xldCBpLHIsaCx1O3N3aXRjaChzKXtjYXNlIDE6ZTwxMjgmJihvPWUpO2JyZWFrO2Nhc2UgMjppPXRbbisxXSwxMjg9PSgxOTImaSkmJih1PSgzMSZlKTw8Nnw2MyZpLHU+MTI3JiYobz11KSk7YnJlYWs7Y2FzZSAzOmk9dFtuKzFdLHI9dFtuKzJdLDEyOD09KDE5MiZpKSYmMTI4PT0oMTkyJnIpJiYodT0oMTUmZSk8PDEyfCg2MyZpKTw8Nnw2MyZyLHU+MjA0NyYmKHU8NTUyOTZ8fHU+NTczNDMpJiYobz11KSk7YnJlYWs7Y2FzZSA0Omk9dFtuKzFdLHI9dFtuKzJdLGg9dFtuKzNdLDEyOD09KDE5MiZpKSYmMTI4PT0oMTkyJnIpJiYxMjg9PSgxOTImaCkmJih1PSgxNSZlKTw8MTh8KDYzJmkpPDwxMnwoNjMmcik8PDZ8NjMmaCx1PjY1NTM1JiZ1PDExMTQxMTImJihvPXUpKX19bnVsbD09PW8/KG89NjU1MzMscz0xKTpvPjY1NTM1JiYoby09NjU1MzYsci5wdXNoKG8+Pj4xMCYxMDIzfDU1Mjk2KSxvPTU2MzIwfDEwMjMmbyksci5wdXNoKG8pLG4rPXN9cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9dC5sZW5ndGg7aWYoZTw9VClyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsdCk7bGV0IGk9IiIscj0wO2Zvcig7cjxlOylpKz1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZyx0LnNsaWNlKHIscis9VCkpO3JldHVybiBpfShyKX11LlRZUEVEX0FSUkFZX1NVUFBPUlQ9ZnVuY3Rpb24oKXt0cnl7Y29uc3QgdD1uZXcgVWludDhBcnJheSgxKSxlPXtmb286ZnVuY3Rpb24oKXtyZXR1cm4gNDJ9fTtyZXR1cm4gT2JqZWN0LnNldFByb3RvdHlwZU9mKGUsVWludDhBcnJheS5wcm90b3R5cGUpLE9iamVjdC5zZXRQcm90b3R5cGVPZih0LGUpLDQyPT09dC5mb28oKX1jYXRjaCh0KXtyZXR1cm4hMX19KCksdS5UWVBFRF9BUlJBWV9TVVBQT1JUfHwidW5kZWZpbmVkIj09dHlwZW9mIGNvbnNvbGV8fCJmdW5jdGlvbiIhPXR5cGVvZiBjb25zb2xlLmVycm9yfHxjb25zb2xlLmVycm9yKCJUaGlzIGJyb3dzZXIgbGFja3MgdHlwZWQgYXJyYXkgKFVpbnQ4QXJyYXkpIHN1cHBvcnQgd2hpY2ggaXMgcmVxdWlyZWQgYnkgYGJ1ZmZlcmAgdjUueC4gVXNlIGBidWZmZXJgIHY0LnggaWYgeW91IHJlcXVpcmUgb2xkIGJyb3dzZXIgc3VwcG9ydC4iKSxPYmplY3QuZGVmaW5lUHJvcGVydHkodS5wcm90b3R5cGUsInBhcmVudCIse2VudW1lcmFibGU6ITAsZ2V0OmZ1bmN0aW9uKCl7aWYodS5pc0J1ZmZlcih0aGlzKSlyZXR1cm4gdGhpcy5idWZmZXJ9fSksT2JqZWN0LmRlZmluZVByb3BlcnR5KHUucHJvdG90eXBlLCJvZmZzZXQiLHtlbnVtZXJhYmxlOiEwLGdldDpmdW5jdGlvbigpe2lmKHUuaXNCdWZmZXIodGhpcykpcmV0dXJuIHRoaXMuYnl0ZU9mZnNldH19KSx1LnBvb2xTaXplPTgxOTIsdS5mcm9tPWZ1bmN0aW9uKHQsZSxpKXtyZXR1cm4gYSh0LGUsaSl9LE9iamVjdC5zZXRQcm90b3R5cGVPZih1LnByb3RvdHlwZSxVaW50OEFycmF5LnByb3RvdHlwZSksT2JqZWN0LnNldFByb3RvdHlwZU9mKHUsVWludDhBcnJheSksdS5hbGxvYz1mdW5jdGlvbih0LGUsaSl7cmV0dXJuIGZ1bmN0aW9uKHQsZSxpKXtyZXR1cm4gbCh0KSx0PD0wP2godCk6dm9pZCAwIT09ZT8ic3RyaW5nIj09dHlwZW9mIGk/aCh0KS5maWxsKGUsaSk6aCh0KS5maWxsKGUpOmgodCl9KHQsZSxpKX0sdS5hbGxvY1Vuc2FmZT1mdW5jdGlvbih0KXtyZXR1cm4gZih0KX0sdS5hbGxvY1Vuc2FmZVNsb3c9ZnVuY3Rpb24odCl7cmV0dXJuIGYodCl9LHUuaXNCdWZmZXI9ZnVuY3Rpb24odCl7cmV0dXJuIG51bGwhPXQmJiEwPT09dC5faXNCdWZmZXImJnQhPT11LnByb3RvdHlwZX0sdS5jb21wYXJlPWZ1bmN0aW9uKHQsZSl7aWYoSCh0LFVpbnQ4QXJyYXkpJiYodD11LmZyb20odCx0Lm9mZnNldCx0LmJ5dGVMZW5ndGgpKSxIKGUsVWludDhBcnJheSkmJihlPXUuZnJvbShlLGUub2Zmc2V0LGUuYnl0ZUxlbmd0aCkpLCF1LmlzQnVmZmVyKHQpfHwhdS5pc0J1ZmZlcihlKSl0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgImJ1ZjEiLCAiYnVmMiIgYXJndW1lbnRzIG11c3QgYmUgb25lIG9mIHR5cGUgQnVmZmVyIG9yIFVpbnQ4QXJyYXknKTtpZih0PT09ZSlyZXR1cm4gMDtsZXQgaT10Lmxlbmd0aCxyPWUubGVuZ3RoO2ZvcihsZXQgbj0wLG89TWF0aC5taW4oaSxyKTtuPG87KytuKWlmKHRbbl0hPT1lW25dKXtpPXRbbl0scj1lW25dO2JyZWFrfXJldHVybiBpPHI/LTE6cjxpPzE6MH0sdS5pc0VuY29kaW5nPWZ1bmN0aW9uKHQpe3N3aXRjaChTdHJpbmcodCkudG9Mb3dlckNhc2UoKSl7Y2FzZSJoZXgiOmNhc2UidXRmOCI6Y2FzZSJ1dGYtOCI6Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpjYXNlImJhc2U2NCI6Y2FzZSJ1Y3MyIjpjYXNlInVjcy0yIjpjYXNlInV0ZjE2bGUiOmNhc2UidXRmLTE2bGUiOnJldHVybiEwO2RlZmF1bHQ6cmV0dXJuITF9fSx1LmNvbmNhdD1mdW5jdGlvbih0LGUpe2lmKCFBcnJheS5pc0FycmF5KHQpKXRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKTtpZigwPT09dC5sZW5ndGgpcmV0dXJuIHUuYWxsb2MoMCk7bGV0IGk7aWYodm9pZCAwPT09ZSlmb3IoZT0wLGk9MDtpPHQubGVuZ3RoOysraSllKz10W2ldLmxlbmd0aDtjb25zdCByPXUuYWxsb2NVbnNhZmUoZSk7bGV0IG49MDtmb3IoaT0wO2k8dC5sZW5ndGg7KytpKXtsZXQgZT10W2ldO2lmKEgoZSxVaW50OEFycmF5KSluK2UubGVuZ3RoPnIubGVuZ3RoPyh1LmlzQnVmZmVyKGUpfHwoZT11LmZyb20oZSkpLGUuY29weShyLG4pKTpVaW50OEFycmF5LnByb3RvdHlwZS5zZXQuY2FsbChyLGUsbik7ZWxzZXtpZighdS5pc0J1ZmZlcihlKSl0aHJvdyBuZXcgVHlwZUVycm9yKCcibGlzdCIgYXJndW1lbnQgbXVzdCBiZSBhbiBBcnJheSBvZiBCdWZmZXJzJyk7ZS5jb3B5KHIsbil9bis9ZS5sZW5ndGh9cmV0dXJuIHJ9LHUuYnl0ZUxlbmd0aD1kLHUucHJvdG90eXBlLl9pc0J1ZmZlcj0hMCx1LnByb3RvdHlwZS5zd2FwMTY9ZnVuY3Rpb24oKXtjb25zdCB0PXRoaXMubGVuZ3RoO2lmKHQlMiE9MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMiKTtmb3IobGV0IGU9MDtlPHQ7ZSs9Mil5KHRoaXMsZSxlKzEpO3JldHVybiB0aGlzfSx1LnByb3RvdHlwZS5zd2FwMzI9ZnVuY3Rpb24oKXtjb25zdCB0PXRoaXMubGVuZ3RoO2lmKHQlNCE9MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDMyLWJpdHMiKTtmb3IobGV0IGU9MDtlPHQ7ZSs9NCl5KHRoaXMsZSxlKzMpLHkodGhpcyxlKzEsZSsyKTtyZXR1cm4gdGhpc30sdS5wcm90b3R5cGUuc3dhcDY0PWZ1bmN0aW9uKCl7Y29uc3QgdD10aGlzLmxlbmd0aDtpZih0JTghPTApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkJ1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA2NC1iaXRzIik7Zm9yKGxldCBlPTA7ZTx0O2UrPTgpeSh0aGlzLGUsZSs3KSx5KHRoaXMsZSsxLGUrNikseSh0aGlzLGUrMixlKzUpLHkodGhpcyxlKzMsZSs0KTtyZXR1cm4gdGhpc30sdS5wcm90b3R5cGUudG9TdHJpbmc9ZnVuY3Rpb24oKXtjb25zdCB0PXRoaXMubGVuZ3RoO3JldHVybiAwPT09dD8iIjowPT09YXJndW1lbnRzLmxlbmd0aD9fKHRoaXMsMCx0KTpnLmFwcGx5KHRoaXMsYXJndW1lbnRzKX0sdS5wcm90b3R5cGUudG9Mb2NhbGVTdHJpbmc9dS5wcm90b3R5cGUudG9TdHJpbmcsdS5wcm90b3R5cGUuZXF1YWxzPWZ1bmN0aW9uKHQpe2lmKCF1LmlzQnVmZmVyKHQpKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXIiKTtyZXR1cm4gdGhpcz09PXR8fDA9PT11LmNvbXBhcmUodGhpcyx0KX0sdS5wcm90b3R5cGUuaW5zcGVjdD1mdW5jdGlvbigpe2xldCB0PSIiO2NvbnN0IGk9ZS5JUztyZXR1cm4gdD10aGlzLnRvU3RyaW5nKCJoZXgiLDAsaSkucmVwbGFjZSgvKC57Mn0pL2csIiQxICIpLnRyaW0oKSx0aGlzLmxlbmd0aD5pJiYodCs9IiAuLi4gIiksIjxCdWZmZXIgIit0KyI+In0sbyYmKHUucHJvdG90eXBlW29dPXUucHJvdG90eXBlLmluc3BlY3QpLHUucHJvdG90eXBlLmNvbXBhcmU9ZnVuY3Rpb24odCxlLGkscixuKXtpZihIKHQsVWludDhBcnJheSkmJih0PXUuZnJvbSh0LHQub2Zmc2V0LHQuYnl0ZUxlbmd0aCkpLCF1LmlzQnVmZmVyKHQpKXRocm93IG5ldyBUeXBlRXJyb3IoJ1RoZSAidGFyZ2V0IiBhcmd1bWVudCBtdXN0IGJlIG9uZSBvZiB0eXBlIEJ1ZmZlciBvciBVaW50OEFycmF5LiBSZWNlaXZlZCB0eXBlICcrdHlwZW9mIHQpO2lmKHZvaWQgMD09PWUmJihlPTApLHZvaWQgMD09PWkmJihpPXQ/dC5sZW5ndGg6MCksdm9pZCAwPT09ciYmKHI9MCksdm9pZCAwPT09biYmKG49dGhpcy5sZW5ndGgpLGU8MHx8aT50Lmxlbmd0aHx8cjwwfHxuPnRoaXMubGVuZ3RoKXRocm93IG5ldyBSYW5nZUVycm9yKCJvdXQgb2YgcmFuZ2UgaW5kZXgiKTtpZihyPj1uJiZlPj1pKXJldHVybiAwO2lmKHI+PW4pcmV0dXJuLTE7aWYoZT49aSlyZXR1cm4gMTtpZih0aGlzPT09dClyZXR1cm4gMDtsZXQgbz0obj4+Pj0wKS0ocj4+Pj0wKSxzPShpPj4+PTApLShlPj4+PTApO2NvbnN0IGg9TWF0aC5taW4obyxzKSxhPXRoaXMuc2xpY2UocixuKSxsPXQuc2xpY2UoZSxpKTtmb3IobGV0IHQ9MDt0PGg7Kyt0KWlmKGFbdF0hPT1sW3RdKXtvPWFbdF0scz1sW3RdO2JyZWFrfXJldHVybiBvPHM/LTE6czxvPzE6MH0sdS5wcm90b3R5cGUuaW5jbHVkZXM9ZnVuY3Rpb24odCxlLGkpe3JldHVybi0xIT09dGhpcy5pbmRleE9mKHQsZSxpKX0sdS5wcm90b3R5cGUuaW5kZXhPZj1mdW5jdGlvbih0LGUsaSl7cmV0dXJuIHcodGhpcyx0LGUsaSwhMCl9LHUucHJvdG90eXBlLmxhc3RJbmRleE9mPWZ1bmN0aW9uKHQsZSxpKXtyZXR1cm4gdyh0aGlzLHQsZSxpLCExKX0sdS5wcm90b3R5cGUud3JpdGU9ZnVuY3Rpb24odCxlLGkscil7aWYodm9pZCAwPT09ZSlyPSJ1dGY4IixpPXRoaXMubGVuZ3RoLGU9MDtlbHNlIGlmKHZvaWQgMD09PWkmJiJzdHJpbmciPT10eXBlb2YgZSlyPWUsaT10aGlzLmxlbmd0aCxlPTA7ZWxzZXtpZighaXNGaW5pdGUoZSkpdGhyb3cgbmV3IEVycm9yKCJCdWZmZXIud3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0WywgbGVuZ3RoXSkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCIpO2U+Pj49MCxpc0Zpbml0ZShpKT8oaT4+Pj0wLHZvaWQgMD09PXImJihyPSJ1dGY4IikpOihyPWksaT12b2lkIDApfWNvbnN0IG49dGhpcy5sZW5ndGgtZTtpZigodm9pZCAwPT09aXx8aT5uKSYmKGk9biksdC5sZW5ndGg+MCYmKGk8MHx8ZTwwKXx8ZT50aGlzLmxlbmd0aCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMiKTtyfHwocj0idXRmOCIpO2xldCBvPSExO2Zvcig7Oylzd2l0Y2gocil7Y2FzZSJoZXgiOnJldHVybiBNKHRoaXMsdCxlLGkpO2Nhc2UidXRmOCI6Y2FzZSJ1dGYtOCI6cmV0dXJuIGIodGhpcyx0LGUsaSk7Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpyZXR1cm4gQSh0aGlzLHQsZSxpKTtjYXNlImJhc2U2NCI6cmV0dXJuIEIodGhpcyx0LGUsaSk7Y2FzZSJ1Y3MyIjpjYXNlInVjcy0yIjpjYXNlInV0ZjE2bGUiOmNhc2UidXRmLTE2bGUiOnJldHVybiBFKHRoaXMsdCxlLGkpO2RlZmF1bHQ6aWYobyl0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGVuY29kaW5nOiAiK3IpO3I9KCIiK3IpLnRvTG93ZXJDYXNlKCksbz0hMH19LHUucHJvdG90eXBlLnRvSlNPTj1mdW5jdGlvbigpe3JldHVybnt0eXBlOiJCdWZmZXIiLGRhdGE6QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5fYXJyfHx0aGlzLDApfX07Y29uc3QgVD00MDk2O2Z1bmN0aW9uIEkodCxlLGkpe2xldCByPSIiO2k9TWF0aC5taW4odC5sZW5ndGgsaSk7Zm9yKGxldCBuPWU7bjxpOysrbilyKz1TdHJpbmcuZnJvbUNoYXJDb2RlKDEyNyZ0W25dKTtyZXR1cm4gcn1mdW5jdGlvbiBTKHQsZSxpKXtsZXQgcj0iIjtpPU1hdGgubWluKHQubGVuZ3RoLGkpO2ZvcihsZXQgbj1lO248aTsrK24pcis9U3RyaW5nLmZyb21DaGFyQ29kZSh0W25dKTtyZXR1cm4gcn1mdW5jdGlvbiBSKHQsZSxpKXtjb25zdCByPXQubGVuZ3RoOyghZXx8ZTwwKSYmKGU9MCksKCFpfHxpPDB8fGk+cikmJihpPXIpO2xldCBuPSIiO2ZvcihsZXQgcj1lO3I8aTsrK3Ipbis9WVt0W3JdXTtyZXR1cm4gbn1mdW5jdGlvbiBVKHQsZSxpKXtjb25zdCByPXQuc2xpY2UoZSxpKTtsZXQgbj0iIjtmb3IobGV0IHQ9MDt0PHIubGVuZ3RoLTE7dCs9MiluKz1TdHJpbmcuZnJvbUNoYXJDb2RlKHJbdF0rMjU2KnJbdCsxXSk7cmV0dXJuIG59ZnVuY3Rpb24geCh0LGUsaSl7aWYodCUxIT0wfHx0PDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIm9mZnNldCBpcyBub3QgdWludCIpO2lmKHQrZT5pKXRocm93IG5ldyBSYW5nZUVycm9yKCJUcnlpbmcgdG8gYWNjZXNzIGJleW9uZCBidWZmZXIgbGVuZ3RoIil9ZnVuY3Rpb24gTCh0LGUsaSxyLG4sbyl7aWYoIXUuaXNCdWZmZXIodCkpdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpO2lmKGU+bnx8ZTxvKXRocm93IG5ldyBSYW5nZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IGlzIG91dCBvZiBib3VuZHMnKTtpZihpK3I+dC5sZW5ndGgpdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpfWZ1bmN0aW9uIE8odCxlLGkscixuKXtXKGUscixuLHQsaSw3KTtsZXQgbz1OdW1iZXIoZSZCaWdJbnQoNDI5NDk2NzI5NSkpO3RbaSsrXT1vLG8+Pj04LHRbaSsrXT1vLG8+Pj04LHRbaSsrXT1vLG8+Pj04LHRbaSsrXT1vO2xldCBzPU51bWJlcihlPj5CaWdJbnQoMzIpJkJpZ0ludCg0Mjk0OTY3Mjk1KSk7cmV0dXJuIHRbaSsrXT1zLHM+Pj04LHRbaSsrXT1zLHM+Pj04LHRbaSsrXT1zLHM+Pj04LHRbaSsrXT1zLGl9ZnVuY3Rpb24gUCh0LGUsaSxyLG4pe1coZSxyLG4sdCxpLDcpO2xldCBvPU51bWJlcihlJkJpZ0ludCg0Mjk0OTY3Mjk1KSk7dFtpKzddPW8sbz4+PTgsdFtpKzZdPW8sbz4+PTgsdFtpKzVdPW8sbz4+PTgsdFtpKzRdPW87bGV0IHM9TnVtYmVyKGU+PkJpZ0ludCgzMikmQmlnSW50KDQyOTQ5NjcyOTUpKTtyZXR1cm4gdFtpKzNdPXMscz4+PTgsdFtpKzJdPXMscz4+PTgsdFtpKzFdPXMscz4+PTgsdFtpXT1zLGkrOH1mdW5jdGlvbiBOKHQsZSxpLHIsbixvKXtpZihpK3I+dC5sZW5ndGgpdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpO2lmKGk8MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiSW5kZXggb3V0IG9mIHJhbmdlIil9ZnVuY3Rpb24gJCh0LGUsaSxyLG8pe3JldHVybiBlPStlLGk+Pj49MCxvfHxOKHQsMCxpLDQpLG4ud3JpdGUodCxlLGksciwyMyw0KSxpKzR9ZnVuY3Rpb24gQyh0LGUsaSxyLG8pe3JldHVybiBlPStlLGk+Pj49MCxvfHxOKHQsMCxpLDgpLG4ud3JpdGUodCxlLGksciw1Miw4KSxpKzh9dS5wcm90b3R5cGUuc2xpY2U9ZnVuY3Rpb24odCxlKXtjb25zdCBpPXRoaXMubGVuZ3RoOyh0PX5+dCk8MD8odCs9aSk8MCYmKHQ9MCk6dD5pJiYodD1pKSwoZT12b2lkIDA9PT1lP2k6fn5lKTwwPyhlKz1pKTwwJiYoZT0wKTplPmkmJihlPWkpLGU8dCYmKGU9dCk7Y29uc3Qgcj10aGlzLnN1YmFycmF5KHQsZSk7cmV0dXJuIE9iamVjdC5zZXRQcm90b3R5cGVPZihyLHUucHJvdG90eXBlKSxyfSx1LnByb3RvdHlwZS5yZWFkVWludExFPXUucHJvdG90eXBlLnJlYWRVSW50TEU9ZnVuY3Rpb24odCxlLGkpe3Q+Pj49MCxlPj4+PTAsaXx8eCh0LGUsdGhpcy5sZW5ndGgpO2xldCByPXRoaXNbdF0sbj0xLG89MDtmb3IoOysrbzxlJiYobio9MjU2KTspcis9dGhpc1t0K29dKm47cmV0dXJuIHJ9LHUucHJvdG90eXBlLnJlYWRVaW50QkU9dS5wcm90b3R5cGUucmVhZFVJbnRCRT1mdW5jdGlvbih0LGUsaSl7dD4+Pj0wLGU+Pj49MCxpfHx4KHQsZSx0aGlzLmxlbmd0aCk7bGV0IHI9dGhpc1t0Ky0tZV0sbj0xO2Zvcig7ZT4wJiYobio9MjU2KTspcis9dGhpc1t0Ky0tZV0qbjtyZXR1cm4gcn0sdS5wcm90b3R5cGUucmVhZFVpbnQ4PXUucHJvdG90eXBlLnJlYWRVSW50OD1mdW5jdGlvbih0LGUpe3JldHVybiB0Pj4+PTAsZXx8eCh0LDEsdGhpcy5sZW5ndGgpLHRoaXNbdF19LHUucHJvdG90eXBlLnJlYWRVaW50MTZMRT11LnByb3RvdHlwZS5yZWFkVUludDE2TEU9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdD4+Pj0wLGV8fHgodCwyLHRoaXMubGVuZ3RoKSx0aGlzW3RdfHRoaXNbdCsxXTw8OH0sdS5wcm90b3R5cGUucmVhZFVpbnQxNkJFPXUucHJvdG90eXBlLnJlYWRVSW50MTZCRT1mdW5jdGlvbih0LGUpe3JldHVybiB0Pj4+PTAsZXx8eCh0LDIsdGhpcy5sZW5ndGgpLHRoaXNbdF08PDh8dGhpc1t0KzFdfSx1LnByb3RvdHlwZS5yZWFkVWludDMyTEU9dS5wcm90b3R5cGUucmVhZFVJbnQzMkxFPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIHQ+Pj49MCxlfHx4KHQsNCx0aGlzLmxlbmd0aCksKHRoaXNbdF18dGhpc1t0KzFdPDw4fHRoaXNbdCsyXTw8MTYpKzE2Nzc3MjE2KnRoaXNbdCszXX0sdS5wcm90b3R5cGUucmVhZFVpbnQzMkJFPXUucHJvdG90eXBlLnJlYWRVSW50MzJCRT1mdW5jdGlvbih0LGUpe3JldHVybiB0Pj4+PTAsZXx8eCh0LDQsdGhpcy5sZW5ndGgpLDE2Nzc3MjE2KnRoaXNbdF0rKHRoaXNbdCsxXTw8MTZ8dGhpc1t0KzJdPDw4fHRoaXNbdCszXSl9LHUucHJvdG90eXBlLnJlYWRCaWdVSW50NjRMRT1RKChmdW5jdGlvbih0KXtLKHQ+Pj49MCwib2Zmc2V0Iik7Y29uc3QgZT10aGlzW3RdLGk9dGhpc1t0KzddO3ZvaWQgMCE9PWUmJnZvaWQgMCE9PWl8fEYodCx0aGlzLmxlbmd0aC04KTtjb25zdCByPWUrMjU2KnRoaXNbKyt0XSs2NTUzNip0aGlzWysrdF0rdGhpc1srK3RdKjIqKjI0LG49dGhpc1srK3RdKzI1Nip0aGlzWysrdF0rNjU1MzYqdGhpc1srK3RdK2kqMioqMjQ7cmV0dXJuIEJpZ0ludChyKSsoQmlnSW50KG4pPDxCaWdJbnQoMzIpKX0pKSx1LnByb3RvdHlwZS5yZWFkQmlnVUludDY0QkU9USgoZnVuY3Rpb24odCl7Syh0Pj4+PTAsIm9mZnNldCIpO2NvbnN0IGU9dGhpc1t0XSxpPXRoaXNbdCs3XTt2b2lkIDAhPT1lJiZ2b2lkIDAhPT1pfHxGKHQsdGhpcy5sZW5ndGgtOCk7Y29uc3Qgcj1lKjIqKjI0KzY1NTM2KnRoaXNbKyt0XSsyNTYqdGhpc1srK3RdK3RoaXNbKyt0XSxuPXRoaXNbKyt0XSoyKioyNCs2NTUzNip0aGlzWysrdF0rMjU2KnRoaXNbKyt0XStpO3JldHVybihCaWdJbnQocik8PEJpZ0ludCgzMikpK0JpZ0ludChuKX0pKSx1LnByb3RvdHlwZS5yZWFkSW50TEU9ZnVuY3Rpb24odCxlLGkpe3Q+Pj49MCxlPj4+PTAsaXx8eCh0LGUsdGhpcy5sZW5ndGgpO2xldCByPXRoaXNbdF0sbj0xLG89MDtmb3IoOysrbzxlJiYobio9MjU2KTspcis9dGhpc1t0K29dKm47cmV0dXJuIG4qPTEyOCxyPj1uJiYoci09TWF0aC5wb3coMiw4KmUpKSxyfSx1LnByb3RvdHlwZS5yZWFkSW50QkU9ZnVuY3Rpb24odCxlLGkpe3Q+Pj49MCxlPj4+PTAsaXx8eCh0LGUsdGhpcy5sZW5ndGgpO2xldCByPWUsbj0xLG89dGhpc1t0Ky0tcl07Zm9yKDtyPjAmJihuKj0yNTYpOylvKz10aGlzW3QrLS1yXSpuO3JldHVybiBuKj0xMjgsbz49biYmKG8tPU1hdGgucG93KDIsOCplKSksb30sdS5wcm90b3R5cGUucmVhZEludDg9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdD4+Pj0wLGV8fHgodCwxLHRoaXMubGVuZ3RoKSwxMjgmdGhpc1t0XT8tMSooMjU1LXRoaXNbdF0rMSk6dGhpc1t0XX0sdS5wcm90b3R5cGUucmVhZEludDE2TEU9ZnVuY3Rpb24odCxlKXt0Pj4+PTAsZXx8eCh0LDIsdGhpcy5sZW5ndGgpO2NvbnN0IGk9dGhpc1t0XXx0aGlzW3QrMV08PDg7cmV0dXJuIDMyNzY4Jmk/NDI5NDkwMTc2MHxpOml9LHUucHJvdG90eXBlLnJlYWRJbnQxNkJFPWZ1bmN0aW9uKHQsZSl7dD4+Pj0wLGV8fHgodCwyLHRoaXMubGVuZ3RoKTtjb25zdCBpPXRoaXNbdCsxXXx0aGlzW3RdPDw4O3JldHVybiAzMjc2OCZpPzQyOTQ5MDE3NjB8aTppfSx1LnByb3RvdHlwZS5yZWFkSW50MzJMRT1mdW5jdGlvbih0LGUpe3JldHVybiB0Pj4+PTAsZXx8eCh0LDQsdGhpcy5sZW5ndGgpLHRoaXNbdF18dGhpc1t0KzFdPDw4fHRoaXNbdCsyXTw8MTZ8dGhpc1t0KzNdPDwyNH0sdS5wcm90b3R5cGUucmVhZEludDMyQkU9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdD4+Pj0wLGV8fHgodCw0LHRoaXMubGVuZ3RoKSx0aGlzW3RdPDwyNHx0aGlzW3QrMV08PDE2fHRoaXNbdCsyXTw8OHx0aGlzW3QrM119LHUucHJvdG90eXBlLnJlYWRCaWdJbnQ2NExFPVEoKGZ1bmN0aW9uKHQpe0sodD4+Pj0wLCJvZmZzZXQiKTtjb25zdCBlPXRoaXNbdF0saT10aGlzW3QrN107dm9pZCAwIT09ZSYmdm9pZCAwIT09aXx8Rih0LHRoaXMubGVuZ3RoLTgpO2NvbnN0IHI9dGhpc1t0KzRdKzI1Nip0aGlzW3QrNV0rNjU1MzYqdGhpc1t0KzZdKyhpPDwyNCk7cmV0dXJuKEJpZ0ludChyKTw8QmlnSW50KDMyKSkrQmlnSW50KGUrMjU2KnRoaXNbKyt0XSs2NTUzNip0aGlzWysrdF0rdGhpc1srK3RdKjIqKjI0KX0pKSx1LnByb3RvdHlwZS5yZWFkQmlnSW50NjRCRT1RKChmdW5jdGlvbih0KXtLKHQ+Pj49MCwib2Zmc2V0Iik7Y29uc3QgZT10aGlzW3RdLGk9dGhpc1t0KzddO3ZvaWQgMCE9PWUmJnZvaWQgMCE9PWl8fEYodCx0aGlzLmxlbmd0aC04KTtjb25zdCByPShlPDwyNCkrNjU1MzYqdGhpc1srK3RdKzI1Nip0aGlzWysrdF0rdGhpc1srK3RdO3JldHVybihCaWdJbnQocik8PEJpZ0ludCgzMikpK0JpZ0ludCh0aGlzWysrdF0qMioqMjQrNjU1MzYqdGhpc1srK3RdKzI1Nip0aGlzWysrdF0raSl9KSksdS5wcm90b3R5cGUucmVhZEZsb2F0TEU9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdD4+Pj0wLGV8fHgodCw0LHRoaXMubGVuZ3RoKSxuLnJlYWQodGhpcyx0LCEwLDIzLDQpfSx1LnByb3RvdHlwZS5yZWFkRmxvYXRCRT1mdW5jdGlvbih0LGUpe3JldHVybiB0Pj4+PTAsZXx8eCh0LDQsdGhpcy5sZW5ndGgpLG4ucmVhZCh0aGlzLHQsITEsMjMsNCl9LHUucHJvdG90eXBlLnJlYWREb3VibGVMRT1mdW5jdGlvbih0LGUpe3JldHVybiB0Pj4+PTAsZXx8eCh0LDgsdGhpcy5sZW5ndGgpLG4ucmVhZCh0aGlzLHQsITAsNTIsOCl9LHUucHJvdG90eXBlLnJlYWREb3VibGVCRT1mdW5jdGlvbih0LGUpe3JldHVybiB0Pj4+PTAsZXx8eCh0LDgsdGhpcy5sZW5ndGgpLG4ucmVhZCh0aGlzLHQsITEsNTIsOCl9LHUucHJvdG90eXBlLndyaXRlVWludExFPXUucHJvdG90eXBlLndyaXRlVUludExFPWZ1bmN0aW9uKHQsZSxpLHIpe3Q9K3QsZT4+Pj0wLGk+Pj49MCxyfHxMKHRoaXMsdCxlLGksTWF0aC5wb3coMiw4KmkpLTEsMCk7bGV0IG49MSxvPTA7Zm9yKHRoaXNbZV09MjU1JnQ7KytvPGkmJihuKj0yNTYpOyl0aGlzW2Urb109dC9uJjI1NTtyZXR1cm4gZStpfSx1LnByb3RvdHlwZS53cml0ZVVpbnRCRT11LnByb3RvdHlwZS53cml0ZVVJbnRCRT1mdW5jdGlvbih0LGUsaSxyKXt0PSt0LGU+Pj49MCxpPj4+PTAscnx8TCh0aGlzLHQsZSxpLE1hdGgucG93KDIsOCppKS0xLDApO2xldCBuPWktMSxvPTE7Zm9yKHRoaXNbZStuXT0yNTUmdDstLW4+PTAmJihvKj0yNTYpOyl0aGlzW2Urbl09dC9vJjI1NTtyZXR1cm4gZStpfSx1LnByb3RvdHlwZS53cml0ZVVpbnQ4PXUucHJvdG90eXBlLndyaXRlVUludDg9ZnVuY3Rpb24odCxlLGkpe3JldHVybiB0PSt0LGU+Pj49MCxpfHxMKHRoaXMsdCxlLDEsMjU1LDApLHRoaXNbZV09MjU1JnQsZSsxfSx1LnByb3RvdHlwZS53cml0ZVVpbnQxNkxFPXUucHJvdG90eXBlLndyaXRlVUludDE2TEU9ZnVuY3Rpb24odCxlLGkpe3JldHVybiB0PSt0LGU+Pj49MCxpfHxMKHRoaXMsdCxlLDIsNjU1MzUsMCksdGhpc1tlXT0yNTUmdCx0aGlzW2UrMV09dD4+PjgsZSsyfSx1LnByb3RvdHlwZS53cml0ZVVpbnQxNkJFPXUucHJvdG90eXBlLndyaXRlVUludDE2QkU9ZnVuY3Rpb24odCxlLGkpe3JldHVybiB0PSt0LGU+Pj49MCxpfHxMKHRoaXMsdCxlLDIsNjU1MzUsMCksdGhpc1tlXT10Pj4+OCx0aGlzW2UrMV09MjU1JnQsZSsyfSx1LnByb3RvdHlwZS53cml0ZVVpbnQzMkxFPXUucHJvdG90eXBlLndyaXRlVUludDMyTEU9ZnVuY3Rpb24odCxlLGkpe3JldHVybiB0PSt0LGU+Pj49MCxpfHxMKHRoaXMsdCxlLDQsNDI5NDk2NzI5NSwwKSx0aGlzW2UrM109dD4+PjI0LHRoaXNbZSsyXT10Pj4+MTYsdGhpc1tlKzFdPXQ+Pj44LHRoaXNbZV09MjU1JnQsZSs0fSx1LnByb3RvdHlwZS53cml0ZVVpbnQzMkJFPXUucHJvdG90eXBlLndyaXRlVUludDMyQkU9ZnVuY3Rpb24odCxlLGkpe3JldHVybiB0PSt0LGU+Pj49MCxpfHxMKHRoaXMsdCxlLDQsNDI5NDk2NzI5NSwwKSx0aGlzW2VdPXQ+Pj4yNCx0aGlzW2UrMV09dD4+PjE2LHRoaXNbZSsyXT10Pj4+OCx0aGlzW2UrM109MjU1JnQsZSs0fSx1LnByb3RvdHlwZS53cml0ZUJpZ1VJbnQ2NExFPVEoKGZ1bmN0aW9uKHQsZT0wKXtyZXR1cm4gTyh0aGlzLHQsZSxCaWdJbnQoMCksQmlnSW50KCIweGZmZmZmZmZmZmZmZmZmZmYiKSl9KSksdS5wcm90b3R5cGUud3JpdGVCaWdVSW50NjRCRT1RKChmdW5jdGlvbih0LGU9MCl7cmV0dXJuIFAodGhpcyx0LGUsQmlnSW50KDApLEJpZ0ludCgiMHhmZmZmZmZmZmZmZmZmZmZmIikpfSkpLHUucHJvdG90eXBlLndyaXRlSW50TEU9ZnVuY3Rpb24odCxlLGkscil7aWYodD0rdCxlPj4+PTAsIXIpe2NvbnN0IHI9TWF0aC5wb3coMiw4KmktMSk7TCh0aGlzLHQsZSxpLHItMSwtcil9bGV0IG49MCxvPTEscz0wO2Zvcih0aGlzW2VdPTI1NSZ0OysrbjxpJiYobyo9MjU2KTspdDwwJiYwPT09cyYmMCE9PXRoaXNbZStuLTFdJiYocz0xKSx0aGlzW2Urbl09KHQvb3wwKS1zJjI1NTtyZXR1cm4gZStpfSx1LnByb3RvdHlwZS53cml0ZUludEJFPWZ1bmN0aW9uKHQsZSxpLHIpe2lmKHQ9K3QsZT4+Pj0wLCFyKXtjb25zdCByPU1hdGgucG93KDIsOCppLTEpO0wodGhpcyx0LGUsaSxyLTEsLXIpfWxldCBuPWktMSxvPTEscz0wO2Zvcih0aGlzW2Urbl09MjU1JnQ7LS1uPj0wJiYobyo9MjU2KTspdDwwJiYwPT09cyYmMCE9PXRoaXNbZStuKzFdJiYocz0xKSx0aGlzW2Urbl09KHQvb3wwKS1zJjI1NTtyZXR1cm4gZStpfSx1LnByb3RvdHlwZS53cml0ZUludDg9ZnVuY3Rpb24odCxlLGkpe3JldHVybiB0PSt0LGU+Pj49MCxpfHxMKHRoaXMsdCxlLDEsMTI3LC0xMjgpLHQ8MCYmKHQ9MjU1K3QrMSksdGhpc1tlXT0yNTUmdCxlKzF9LHUucHJvdG90eXBlLndyaXRlSW50MTZMRT1mdW5jdGlvbih0LGUsaSl7cmV0dXJuIHQ9K3QsZT4+Pj0wLGl8fEwodGhpcyx0LGUsMiwzMjc2NywtMzI3NjgpLHRoaXNbZV09MjU1JnQsdGhpc1tlKzFdPXQ+Pj44LGUrMn0sdS5wcm90b3R5cGUud3JpdGVJbnQxNkJFPWZ1bmN0aW9uKHQsZSxpKXtyZXR1cm4gdD0rdCxlPj4+PTAsaXx8TCh0aGlzLHQsZSwyLDMyNzY3LC0zMjc2OCksdGhpc1tlXT10Pj4+OCx0aGlzW2UrMV09MjU1JnQsZSsyfSx1LnByb3RvdHlwZS53cml0ZUludDMyTEU9ZnVuY3Rpb24odCxlLGkpe3JldHVybiB0PSt0LGU+Pj49MCxpfHxMKHRoaXMsdCxlLDQsMjE0NzQ4MzY0NywtMjE0NzQ4MzY0OCksdGhpc1tlXT0yNTUmdCx0aGlzW2UrMV09dD4+PjgsdGhpc1tlKzJdPXQ+Pj4xNix0aGlzW2UrM109dD4+PjI0LGUrNH0sdS5wcm90b3R5cGUud3JpdGVJbnQzMkJFPWZ1bmN0aW9uKHQsZSxpKXtyZXR1cm4gdD0rdCxlPj4+PTAsaXx8TCh0aGlzLHQsZSw0LDIxNDc0ODM2NDcsLTIxNDc0ODM2NDgpLHQ8MCYmKHQ9NDI5NDk2NzI5NSt0KzEpLHRoaXNbZV09dD4+PjI0LHRoaXNbZSsxXT10Pj4+MTYsdGhpc1tlKzJdPXQ+Pj44LHRoaXNbZSszXT0yNTUmdCxlKzR9LHUucHJvdG90eXBlLndyaXRlQmlnSW50NjRMRT1RKChmdW5jdGlvbih0LGU9MCl7cmV0dXJuIE8odGhpcyx0LGUsLUJpZ0ludCgiMHg4MDAwMDAwMDAwMDAwMDAwIiksQmlnSW50KCIweDdmZmZmZmZmZmZmZmZmZmYiKSl9KSksdS5wcm90b3R5cGUud3JpdGVCaWdJbnQ2NEJFPVEoKGZ1bmN0aW9uKHQsZT0wKXtyZXR1cm4gUCh0aGlzLHQsZSwtQmlnSW50KCIweDgwMDAwMDAwMDAwMDAwMDAiKSxCaWdJbnQoIjB4N2ZmZmZmZmZmZmZmZmZmZiIpKX0pKSx1LnByb3RvdHlwZS53cml0ZUZsb2F0TEU9ZnVuY3Rpb24odCxlLGkpe3JldHVybiAkKHRoaXMsdCxlLCEwLGkpfSx1LnByb3RvdHlwZS53cml0ZUZsb2F0QkU9ZnVuY3Rpb24odCxlLGkpe3JldHVybiAkKHRoaXMsdCxlLCExLGkpfSx1LnByb3RvdHlwZS53cml0ZURvdWJsZUxFPWZ1bmN0aW9uKHQsZSxpKXtyZXR1cm4gQyh0aGlzLHQsZSwhMCxpKX0sdS5wcm90b3R5cGUud3JpdGVEb3VibGVCRT1mdW5jdGlvbih0LGUsaSl7cmV0dXJuIEModGhpcyx0LGUsITEsaSl9LHUucHJvdG90eXBlLmNvcHk9ZnVuY3Rpb24odCxlLGkscil7aWYoIXUuaXNCdWZmZXIodCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiYXJndW1lbnQgc2hvdWxkIGJlIGEgQnVmZmVyIik7aWYoaXx8KGk9MCkscnx8MD09PXJ8fChyPXRoaXMubGVuZ3RoKSxlPj10Lmxlbmd0aCYmKGU9dC5sZW5ndGgpLGV8fChlPTApLHI+MCYmcjxpJiYocj1pKSxyPT09aSlyZXR1cm4gMDtpZigwPT09dC5sZW5ndGh8fDA9PT10aGlzLmxlbmd0aClyZXR1cm4gMDtpZihlPDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoInRhcmdldFN0YXJ0IG91dCBvZiBib3VuZHMiKTtpZihpPDB8fGk+PXRoaXMubGVuZ3RoKXRocm93IG5ldyBSYW5nZUVycm9yKCJJbmRleCBvdXQgb2YgcmFuZ2UiKTtpZihyPDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoInNvdXJjZUVuZCBvdXQgb2YgYm91bmRzIik7cj50aGlzLmxlbmd0aCYmKHI9dGhpcy5sZW5ndGgpLHQubGVuZ3RoLWU8ci1pJiYocj10Lmxlbmd0aC1lK2kpO2NvbnN0IG49ci1pO3JldHVybiB0aGlzPT09dCYmImZ1bmN0aW9uIj09dHlwZW9mIFVpbnQ4QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4/dGhpcy5jb3B5V2l0aGluKGUsaSxyKTpVaW50OEFycmF5LnByb3RvdHlwZS5zZXQuY2FsbCh0LHRoaXMuc3ViYXJyYXkoaSxyKSxlKSxufSx1LnByb3RvdHlwZS5maWxsPWZ1bmN0aW9uKHQsZSxpLHIpe2lmKCJzdHJpbmciPT10eXBlb2YgdCl7aWYoInN0cmluZyI9PXR5cGVvZiBlPyhyPWUsZT0wLGk9dGhpcy5sZW5ndGgpOiJzdHJpbmciPT10eXBlb2YgaSYmKHI9aSxpPXRoaXMubGVuZ3RoKSx2b2lkIDAhPT1yJiYic3RyaW5nIiE9dHlwZW9mIHIpdGhyb3cgbmV3IFR5cGVFcnJvcigiZW5jb2RpbmcgbXVzdCBiZSBhIHN0cmluZyIpO2lmKCJzdHJpbmciPT10eXBlb2YgciYmIXUuaXNFbmNvZGluZyhyKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGVuY29kaW5nOiAiK3IpO2lmKDE9PT10Lmxlbmd0aCl7Y29uc3QgZT10LmNoYXJDb2RlQXQoMCk7KCJ1dGY4Ij09PXImJmU8MTI4fHwibGF0aW4xIj09PXIpJiYodD1lKX19ZWxzZSJudW1iZXIiPT10eXBlb2YgdD90Jj0yNTU6ImJvb2xlYW4iPT10eXBlb2YgdCYmKHQ9TnVtYmVyKHQpKTtpZihlPDB8fHRoaXMubGVuZ3RoPGV8fHRoaXMubGVuZ3RoPGkpdGhyb3cgbmV3IFJhbmdlRXJyb3IoIk91dCBvZiByYW5nZSBpbmRleCIpO2lmKGk8PWUpcmV0dXJuIHRoaXM7bGV0IG47aWYoZT4+Pj0wLGk9dm9pZCAwPT09aT90aGlzLmxlbmd0aDppPj4+MCx0fHwodD0wKSwibnVtYmVyIj09dHlwZW9mIHQpZm9yKG49ZTtuPGk7KytuKXRoaXNbbl09dDtlbHNle2NvbnN0IG89dS5pc0J1ZmZlcih0KT90OnUuZnJvbSh0LHIpLHM9by5sZW5ndGg7aWYoMD09PXMpdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlIHZhbHVlICInK3QrJyIgaXMgaW52YWxpZCBmb3IgYXJndW1lbnQgInZhbHVlIicpO2ZvcihuPTA7bjxpLWU7KytuKXRoaXNbbitlXT1vW24lc119cmV0dXJuIHRoaXN9O2NvbnN0IGo9e307ZnVuY3Rpb24gcSh0LGUsaSl7alt0XT1jbGFzcyBleHRlbmRzIGl7Y29uc3RydWN0b3IoKXtzdXBlcigpLE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCJtZXNzYWdlIix7dmFsdWU6ZS5hcHBseSh0aGlzLGFyZ3VtZW50cyksd3JpdGFibGU6ITAsY29uZmlndXJhYmxlOiEwfSksdGhpcy5uYW1lPWAke3RoaXMubmFtZX0gWyR7dH1dYCx0aGlzLnN0YWNrLGRlbGV0ZSB0aGlzLm5hbWV9Z2V0IGNvZGUoKXtyZXR1cm4gdH1zZXQgY29kZSh0KXtPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywiY29kZSIse2NvbmZpZ3VyYWJsZTohMCxlbnVtZXJhYmxlOiEwLHZhbHVlOnQsd3JpdGFibGU6ITB9KX10b1N0cmluZygpe3JldHVybmAke3RoaXMubmFtZX0gWyR7dH1dOiAke3RoaXMubWVzc2FnZX1gfX19ZnVuY3Rpb24gWih0KXtsZXQgZT0iIixpPXQubGVuZ3RoO2NvbnN0IHI9Ii0iPT09dFswXT8xOjA7Zm9yKDtpPj1yKzQ7aS09MyllPWBfJHt0LnNsaWNlKGktMyxpKX0ke2V9YDtyZXR1cm5gJHt0LnNsaWNlKDAsaSl9JHtlfWB9ZnVuY3Rpb24gVyh0LGUsaSxyLG4sbyl7aWYodD5pfHx0PGUpe2NvbnN0IHI9ImJpZ2ludCI9PXR5cGVvZiBlPyJuIjoiIjtsZXQgbjt0aHJvdyBuPW8+Mz8wPT09ZXx8ZT09PUJpZ0ludCgwKT9gPj0gMCR7cn0gYW5kIDwgMiR7cn0gKiogJHs4KihvKzEpfSR7cn1gOmA+PSAtKDIke3J9ICoqICR7OCoobysxKS0xfSR7cn0pIGFuZCA8IDIgKiogJHs4KihvKzEpLTF9JHtyfWA6YD49ICR7ZX0ke3J9IGFuZCA8PSAke2l9JHtyfWAsbmV3IGouRVJSX09VVF9PRl9SQU5HRSgidmFsdWUiLG4sdCl9IWZ1bmN0aW9uKHQsZSxpKXtLKGUsIm9mZnNldCIpLHZvaWQgMCE9PXRbZV0mJnZvaWQgMCE9PXRbZStpXXx8RihlLHQubGVuZ3RoLShpKzEpKX0ocixuLG8pfWZ1bmN0aW9uIEsodCxlKXtpZigibnVtYmVyIiE9dHlwZW9mIHQpdGhyb3cgbmV3IGouRVJSX0lOVkFMSURfQVJHX1RZUEUoZSwibnVtYmVyIix0KX1mdW5jdGlvbiBGKHQsZSxpKXtpZihNYXRoLmZsb29yKHQpIT09dCl0aHJvdyBLKHQsaSksbmV3IGouRVJSX09VVF9PRl9SQU5HRShpfHwib2Zmc2V0IiwiYW4gaW50ZWdlciIsdCk7aWYoZTwwKXRocm93IG5ldyBqLkVSUl9CVUZGRVJfT1VUX09GX0JPVU5EUzt0aHJvdyBuZXcgai5FUlJfT1VUX09GX1JBTkdFKGl8fCJvZmZzZXQiLGA+PSAke2k/MTowfSBhbmQgPD0gJHtlfWAsdCl9cSgiRVJSX0JVRkZFUl9PVVRfT0ZfQk9VTkRTIiwoZnVuY3Rpb24odCl7cmV0dXJuIHQ/YCR7dH0gaXMgb3V0c2lkZSBvZiBidWZmZXIgYm91bmRzYDoiQXR0ZW1wdCB0byBhY2Nlc3MgbWVtb3J5IG91dHNpZGUgYnVmZmVyIGJvdW5kcyJ9KSxSYW5nZUVycm9yKSxxKCJFUlJfSU5WQUxJRF9BUkdfVFlQRSIsKGZ1bmN0aW9uKHQsZSl7cmV0dXJuYFRoZSAiJHt0fSIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIG51bWJlci4gUmVjZWl2ZWQgdHlwZSAke3R5cGVvZiBlfWB9KSxUeXBlRXJyb3IpLHEoIkVSUl9PVVRfT0ZfUkFOR0UiLChmdW5jdGlvbih0LGUsaSl7bGV0IHI9YFRoZSB2YWx1ZSBvZiAiJHt0fSIgaXMgb3V0IG9mIHJhbmdlLmAsbj1pO3JldHVybiBOdW1iZXIuaXNJbnRlZ2VyKGkpJiZNYXRoLmFicyhpKT4yKiozMj9uPVooU3RyaW5nKGkpKToiYmlnaW50Ij09dHlwZW9mIGkmJihuPVN0cmluZyhpKSwoaT5CaWdJbnQoMikqKkJpZ0ludCgzMil8fGk8LShCaWdJbnQoMikqKkJpZ0ludCgzMikpKSYmKG49WihuKSksbis9Im4iKSxyKz1gIEl0IG11c3QgYmUgJHtlfS4gUmVjZWl2ZWQgJHtufWAscn0pLFJhbmdlRXJyb3IpO2NvbnN0IHo9L1teKy8wLTlBLVphLXotX10vZztmdW5jdGlvbiBWKHQsZSl7bGV0IGk7ZT1lfHwxLzA7Y29uc3Qgcj10Lmxlbmd0aDtsZXQgbj1udWxsO2NvbnN0IG89W107Zm9yKGxldCBzPTA7czxyOysrcyl7aWYoaT10LmNoYXJDb2RlQXQocyksaT41NTI5NSYmaTw1NzM0NCl7aWYoIW4pe2lmKGk+NTYzMTkpeyhlLT0zKT4tMSYmby5wdXNoKDIzOSwxOTEsMTg5KTtjb250aW51ZX1pZihzKzE9PT1yKXsoZS09Myk+LTEmJm8ucHVzaCgyMzksMTkxLDE4OSk7Y29udGludWV9bj1pO2NvbnRpbnVlfWlmKGk8NTYzMjApeyhlLT0zKT4tMSYmby5wdXNoKDIzOSwxOTEsMTg5KSxuPWk7Y29udGludWV9aT02NTUzNisobi01NTI5Njw8MTB8aS01NjMyMCl9ZWxzZSBuJiYoZS09Myk+LTEmJm8ucHVzaCgyMzksMTkxLDE4OSk7aWYobj1udWxsLGk8MTI4KXtpZigoZS09MSk8MClicmVhaztvLnB1c2goaSl9ZWxzZSBpZihpPDIwNDgpe2lmKChlLT0yKTwwKWJyZWFrO28ucHVzaChpPj42fDE5Miw2MyZpfDEyOCl9ZWxzZSBpZihpPDY1NTM2KXtpZigoZS09Myk8MClicmVhaztvLnB1c2goaT4+MTJ8MjI0LGk+PjYmNjN8MTI4LDYzJml8MTI4KX1lbHNle2lmKCEoaTwxMTE0MTEyKSl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgY29kZSBwb2ludCIpO2lmKChlLT00KTwwKWJyZWFrO28ucHVzaChpPj4xOHwyNDAsaT4+MTImNjN8MTI4LGk+PjYmNjN8MTI4LDYzJml8MTI4KX19cmV0dXJuIG99ZnVuY3Rpb24gRCh0KXtyZXR1cm4gci50b0J5dGVBcnJheShmdW5jdGlvbih0KXtpZigodD0odD10LnNwbGl0KCI9IilbMF0pLnRyaW0oKS5yZXBsYWNlKHosIiIpKS5sZW5ndGg8MilyZXR1cm4iIjtmb3IoO3QubGVuZ3RoJTQhPTA7KXQrPSI9IjtyZXR1cm4gdH0odCkpfWZ1bmN0aW9uIEcodCxlLGkscil7bGV0IG47Zm9yKG49MDtuPHImJiEobitpPj1lLmxlbmd0aHx8bj49dC5sZW5ndGgpOysrbillW24raV09dFtuXTtyZXR1cm4gbn1mdW5jdGlvbiBIKHQsZSl7cmV0dXJuIHQgaW5zdGFuY2VvZiBlfHxudWxsIT10JiZudWxsIT10LmNvbnN0cnVjdG9yJiZudWxsIT10LmNvbnN0cnVjdG9yLm5hbWUmJnQuY29uc3RydWN0b3IubmFtZT09PWUubmFtZX1mdW5jdGlvbiBKKHQpe3JldHVybiB0IT10fWNvbnN0IFk9ZnVuY3Rpb24oKXtjb25zdCB0PSIwMTIzNDU2Nzg5YWJjZGVmIixlPW5ldyBBcnJheSgyNTYpO2ZvcihsZXQgaT0wO2k8MTY7KytpKXtjb25zdCByPTE2Kmk7Zm9yKGxldCBuPTA7bjwxNjsrK24pZVtyK25dPXRbaV0rdFtuXX1yZXR1cm4gZX0oKTtmdW5jdGlvbiBRKHQpe3JldHVybiJ1bmRlZmluZWQiPT10eXBlb2YgQmlnSW50P1g6dH1mdW5jdGlvbiBYKCl7dGhyb3cgbmV3IEVycm9yKCJCaWdJbnQgbm90IHN1cHBvcnRlZCIpfX0sNDA0OmZ1bmN0aW9uKHQsZSxpKXshZnVuY3Rpb24odCxlKXsidXNlIHN0cmljdCI7ZnVuY3Rpb24gcih0LGUpe2lmKCF0KXRocm93IG5ldyBFcnJvcihlfHwiQXNzZXJ0aW9uIGZhaWxlZCIpfWZ1bmN0aW9uIG4odCxlKXt0LnN1cGVyXz1lO3ZhciBpPWZ1bmN0aW9uKCl7fTtpLnByb3RvdHlwZT1lLnByb3RvdHlwZSx0LnByb3RvdHlwZT1uZXcgaSx0LnByb3RvdHlwZS5jb25zdHJ1Y3Rvcj10fWZ1bmN0aW9uIG8odCxlLGkpe2lmKG8uaXNCTih0KSlyZXR1cm4gdDt0aGlzLm5lZ2F0aXZlPTAsdGhpcy53b3Jkcz1udWxsLHRoaXMubGVuZ3RoPTAsdGhpcy5yZWQ9bnVsbCxudWxsIT09dCYmKCJsZSIhPT1lJiYiYmUiIT09ZXx8KGk9ZSxlPTEwKSx0aGlzLl9pbml0KHR8fDAsZXx8MTAsaXx8ImJlIikpfXZhciBzOyJvYmplY3QiPT10eXBlb2YgdD90LmV4cG9ydHM9bzplLkJOPW8sby5CTj1vLG8ud29yZFNpemU9MjY7dHJ5e3M9InVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJnZvaWQgMCE9PXdpbmRvdy5CdWZmZXI/d2luZG93LkJ1ZmZlcjppKDc5MCkuQnVmZmVyfWNhdGNoKHQpe31mdW5jdGlvbiBoKHQsZSl7dmFyIGk9dC5jaGFyQ29kZUF0KGUpO3JldHVybiBpPj00OCYmaTw9NTc/aS00ODppPj02NSYmaTw9NzA/aS01NTppPj05NyYmaTw9MTAyP2ktODc6dm9pZCByKCExLCJJbnZhbGlkIGNoYXJhY3RlciBpbiAiK3QpfWZ1bmN0aW9uIHUodCxlLGkpe3ZhciByPWgodCxpKTtyZXR1cm4gaS0xPj1lJiYocnw9aCh0LGktMSk8PDQpLHJ9ZnVuY3Rpb24gYSh0LGUsaSxuKXtmb3IodmFyIG89MCxzPTAsaD1NYXRoLm1pbih0Lmxlbmd0aCxpKSx1PWU7dTxoO3UrKyl7dmFyIGE9dC5jaGFyQ29kZUF0KHUpLTQ4O28qPW4scz1hPj00OT9hLTQ5KzEwOmE+PTE3P2EtMTcrMTA6YSxyKGE+PTAmJnM8biwiSW52YWxpZCBjaGFyYWN0ZXIiKSxvKz1zfXJldHVybiBvfWZ1bmN0aW9uIGwodCxlKXt0LndvcmRzPWUud29yZHMsdC5sZW5ndGg9ZS5sZW5ndGgsdC5uZWdhdGl2ZT1lLm5lZ2F0aXZlLHQucmVkPWUucmVkfWlmKG8uaXNCTj1mdW5jdGlvbih0KXtyZXR1cm4gdCBpbnN0YW5jZW9mIG98fG51bGwhPT10JiYib2JqZWN0Ij09dHlwZW9mIHQmJnQuY29uc3RydWN0b3Iud29yZFNpemU9PT1vLndvcmRTaXplJiZBcnJheS5pc0FycmF5KHQud29yZHMpfSxvLm1heD1mdW5jdGlvbih0LGUpe3JldHVybiB0LmNtcChlKT4wP3Q6ZX0sby5taW49ZnVuY3Rpb24odCxlKXtyZXR1cm4gdC5jbXAoZSk8MD90OmV9LG8ucHJvdG90eXBlLl9pbml0PWZ1bmN0aW9uKHQsZSxpKXtpZigibnVtYmVyIj09dHlwZW9mIHQpcmV0dXJuIHRoaXMuX2luaXROdW1iZXIodCxlLGkpO2lmKCJvYmplY3QiPT10eXBlb2YgdClyZXR1cm4gdGhpcy5faW5pdEFycmF5KHQsZSxpKTsiaGV4Ij09PWUmJihlPTE2KSxyKGU9PT0oMHxlKSYmZT49MiYmZTw9MzYpO3ZhciBuPTA7Ii0iPT09KHQ9dC50b1N0cmluZygpLnJlcGxhY2UoL1xzKy9nLCIiKSlbMF0mJihuKyssdGhpcy5uZWdhdGl2ZT0xKSxuPHQubGVuZ3RoJiYoMTY9PT1lP3RoaXMuX3BhcnNlSGV4KHQsbixpKToodGhpcy5fcGFyc2VCYXNlKHQsZSxuKSwibGUiPT09aSYmdGhpcy5faW5pdEFycmF5KHRoaXMudG9BcnJheSgpLGUsaSkpKX0sby5wcm90b3R5cGUuX2luaXROdW1iZXI9ZnVuY3Rpb24odCxlLGkpe3Q8MCYmKHRoaXMubmVnYXRpdmU9MSx0PS10KSx0PDY3MTA4ODY0Pyh0aGlzLndvcmRzPVs2NzEwODg2MyZ0XSx0aGlzLmxlbmd0aD0xKTp0PDQ1MDM1OTk2MjczNzA0OTY/KHRoaXMud29yZHM9WzY3MTA4ODYzJnQsdC82NzEwODg2NCY2NzEwODg2M10sdGhpcy5sZW5ndGg9Mik6KHIodDw5MDA3MTk5MjU0NzQwOTkyKSx0aGlzLndvcmRzPVs2NzEwODg2MyZ0LHQvNjcxMDg4NjQmNjcxMDg4NjMsMV0sdGhpcy5sZW5ndGg9MyksImxlIj09PWkmJnRoaXMuX2luaXRBcnJheSh0aGlzLnRvQXJyYXkoKSxlLGkpfSxvLnByb3RvdHlwZS5faW5pdEFycmF5PWZ1bmN0aW9uKHQsZSxpKXtpZihyKCJudW1iZXIiPT10eXBlb2YgdC5sZW5ndGgpLHQubGVuZ3RoPD0wKXJldHVybiB0aGlzLndvcmRzPVswXSx0aGlzLmxlbmd0aD0xLHRoaXM7dGhpcy5sZW5ndGg9TWF0aC5jZWlsKHQubGVuZ3RoLzMpLHRoaXMud29yZHM9bmV3IEFycmF5KHRoaXMubGVuZ3RoKTtmb3IodmFyIG49MDtuPHRoaXMubGVuZ3RoO24rKyl0aGlzLndvcmRzW25dPTA7dmFyIG8scyxoPTA7aWYoImJlIj09PWkpZm9yKG49dC5sZW5ndGgtMSxvPTA7bj49MDtuLT0zKXM9dFtuXXx0W24tMV08PDh8dFtuLTJdPDwxNix0aGlzLndvcmRzW29dfD1zPDxoJjY3MTA4ODYzLHRoaXMud29yZHNbbysxXT1zPj4+MjYtaCY2NzEwODg2MywoaCs9MjQpPj0yNiYmKGgtPTI2LG8rKyk7ZWxzZSBpZigibGUiPT09aSlmb3Iobj0wLG89MDtuPHQubGVuZ3RoO24rPTMpcz10W25dfHRbbisxXTw8OHx0W24rMl08PDE2LHRoaXMud29yZHNbb118PXM8PGgmNjcxMDg4NjMsdGhpcy53b3Jkc1tvKzFdPXM+Pj4yNi1oJjY3MTA4ODYzLChoKz0yNCk+PTI2JiYoaC09MjYsbysrKTtyZXR1cm4gdGhpcy5fc3RyaXAoKX0sby5wcm90b3R5cGUuX3BhcnNlSGV4PWZ1bmN0aW9uKHQsZSxpKXt0aGlzLmxlbmd0aD1NYXRoLmNlaWwoKHQubGVuZ3RoLWUpLzYpLHRoaXMud29yZHM9bmV3IEFycmF5KHRoaXMubGVuZ3RoKTtmb3IodmFyIHI9MDtyPHRoaXMubGVuZ3RoO3IrKyl0aGlzLndvcmRzW3JdPTA7dmFyIG4sbz0wLHM9MDtpZigiYmUiPT09aSlmb3Iocj10Lmxlbmd0aC0xO3I+PWU7ci09MiluPXUodCxlLHIpPDxvLHRoaXMud29yZHNbc118PTY3MTA4ODYzJm4sbz49MTg/KG8tPTE4LHMrPTEsdGhpcy53b3Jkc1tzXXw9bj4+PjI2KTpvKz04O2Vsc2UgZm9yKHI9KHQubGVuZ3RoLWUpJTI9PTA/ZSsxOmU7cjx0Lmxlbmd0aDtyKz0yKW49dSh0LGUscik8PG8sdGhpcy53b3Jkc1tzXXw9NjcxMDg4NjMmbixvPj0xOD8oby09MTgscys9MSx0aGlzLndvcmRzW3NdfD1uPj4+MjYpOm8rPTg7dGhpcy5fc3RyaXAoKX0sby5wcm90b3R5cGUuX3BhcnNlQmFzZT1mdW5jdGlvbih0LGUsaSl7dGhpcy53b3Jkcz1bMF0sdGhpcy5sZW5ndGg9MTtmb3IodmFyIHI9MCxuPTE7bjw9NjcxMDg4NjM7bio9ZSlyKys7ci0tLG49bi9lfDA7Zm9yKHZhciBvPXQubGVuZ3RoLWkscz1vJXIsaD1NYXRoLm1pbihvLG8tcykraSx1PTAsbD1pO2w8aDtsKz1yKXU9YSh0LGwsbCtyLGUpLHRoaXMuaW11bG4obiksdGhpcy53b3Jkc1swXSt1PDY3MTA4ODY0P3RoaXMud29yZHNbMF0rPXU6dGhpcy5faWFkZG4odSk7aWYoMCE9PXMpe3ZhciBmPTE7Zm9yKHU9YSh0LGwsdC5sZW5ndGgsZSksbD0wO2w8cztsKyspZio9ZTt0aGlzLmltdWxuKGYpLHRoaXMud29yZHNbMF0rdTw2NzEwODg2ND90aGlzLndvcmRzWzBdKz11OnRoaXMuX2lhZGRuKHUpfXRoaXMuX3N0cmlwKCl9LG8ucHJvdG90eXBlLmNvcHk9ZnVuY3Rpb24odCl7dC53b3Jkcz1uZXcgQXJyYXkodGhpcy5sZW5ndGgpO2Zvcih2YXIgZT0wO2U8dGhpcy5sZW5ndGg7ZSsrKXQud29yZHNbZV09dGhpcy53b3Jkc1tlXTt0Lmxlbmd0aD10aGlzLmxlbmd0aCx0Lm5lZ2F0aXZlPXRoaXMubmVnYXRpdmUsdC5yZWQ9dGhpcy5yZWR9LG8ucHJvdG90eXBlLl9tb3ZlPWZ1bmN0aW9uKHQpe2wodCx0aGlzKX0sby5wcm90b3R5cGUuY2xvbmU9ZnVuY3Rpb24oKXt2YXIgdD1uZXcgbyhudWxsKTtyZXR1cm4gdGhpcy5jb3B5KHQpLHR9LG8ucHJvdG90eXBlLl9leHBhbmQ9ZnVuY3Rpb24odCl7Zm9yKDt0aGlzLmxlbmd0aDx0Oyl0aGlzLndvcmRzW3RoaXMubGVuZ3RoKytdPTA7cmV0dXJuIHRoaXN9LG8ucHJvdG90eXBlLl9zdHJpcD1mdW5jdGlvbigpe2Zvcig7dGhpcy5sZW5ndGg+MSYmMD09PXRoaXMud29yZHNbdGhpcy5sZW5ndGgtMV07KXRoaXMubGVuZ3RoLS07cmV0dXJuIHRoaXMuX25vcm1TaWduKCl9LG8ucHJvdG90eXBlLl9ub3JtU2lnbj1mdW5jdGlvbigpe3JldHVybiAxPT09dGhpcy5sZW5ndGgmJjA9PT10aGlzLndvcmRzWzBdJiYodGhpcy5uZWdhdGl2ZT0wKSx0aGlzfSwidW5kZWZpbmVkIiE9dHlwZW9mIFN5bWJvbCYmImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbC5mb3IpdHJ5e28ucHJvdG90eXBlW1N5bWJvbC5mb3IoIm5vZGVqcy51dGlsLmluc3BlY3QuY3VzdG9tIildPWZ9Y2F0Y2godCl7by5wcm90b3R5cGUuaW5zcGVjdD1mfWVsc2Ugby5wcm90b3R5cGUuaW5zcGVjdD1mO2Z1bmN0aW9uIGYoKXtyZXR1cm4odGhpcy5yZWQ/IjxCTi1SOiAiOiI8Qk46ICIpK3RoaXMudG9TdHJpbmcoMTYpKyI+In12YXIgYz1bIiIsIjAiLCIwMCIsIjAwMCIsIjAwMDAiLCIwMDAwMCIsIjAwMDAwMCIsIjAwMDAwMDAiLCIwMDAwMDAwMCIsIjAwMDAwMDAwMCIsIjAwMDAwMDAwMDAiLCIwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAiLCIwMDAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAwMDAiLCIwMDAwMDAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAwMDAwMDAiLCIwMDAwMDAwMDAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAiLCIwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCIsIjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAiXSxwPVswLDAsMjUsMTYsMTIsMTEsMTAsOSw4LDgsNyw3LDcsNyw2LDYsNiw2LDYsNiw2LDUsNSw1LDUsNSw1LDUsNSw1LDUsNSw1LDUsNSw1LDVdLG09WzAsMCwzMzU1NDQzMiw0MzA0NjcyMSwxNjc3NzIxNiw0ODgyODEyNSw2MDQ2NjE3Niw0MDM1MzYwNywxNjc3NzIxNiw0MzA0NjcyMSwxZTcsMTk0ODcxNzEsMzU4MzE4MDgsNjI3NDg1MTcsNzUyOTUzNiwxMTM5MDYyNSwxNjc3NzIxNiwyNDEzNzU2OSwzNDAxMjIyNCw0NzA0NTg4MSw2NGU2LDQwODQxMDEsNTE1MzYzMiw2NDM2MzQzLDc5NjI2MjQsOTc2NTYyNSwxMTg4MTM3NiwxNDM0ODkwNywxNzIxMDM2OCwyMDUxMTE0OSwyNDNlNSwyODYyOTE1MSwzMzU1NDQzMiwzOTEzNTM5Myw0NTQzNTQyNCw1MjUyMTg3NSw2MDQ2NjE3Nl07ZnVuY3Rpb24gZCh0LGUsaSl7aS5uZWdhdGl2ZT1lLm5lZ2F0aXZlXnQubmVnYXRpdmU7dmFyIHI9dC5sZW5ndGgrZS5sZW5ndGh8MDtpLmxlbmd0aD1yLHI9ci0xfDA7dmFyIG49MHx0LndvcmRzWzBdLG89MHxlLndvcmRzWzBdLHM9bipvLGg9NjcxMDg4NjMmcyx1PXMvNjcxMDg4NjR8MDtpLndvcmRzWzBdPWg7Zm9yKHZhciBhPTE7YTxyO2ErKyl7Zm9yKHZhciBsPXU+Pj4yNixmPTY3MTA4ODYzJnUsYz1NYXRoLm1pbihhLGUubGVuZ3RoLTEpLHA9TWF0aC5tYXgoMCxhLXQubGVuZ3RoKzEpO3A8PWM7cCsrKXt2YXIgbT1hLXB8MDtsKz0ocz0obj0wfHQud29yZHNbbV0pKihvPTB8ZS53b3Jkc1twXSkrZikvNjcxMDg4NjR8MCxmPTY3MTA4ODYzJnN9aS53b3Jkc1thXT0wfGYsdT0wfGx9cmV0dXJuIDAhPT11P2kud29yZHNbYV09MHx1OmkubGVuZ3RoLS0saS5fc3RyaXAoKX1vLnByb3RvdHlwZS50b1N0cmluZz1mdW5jdGlvbih0LGUpe3ZhciBpO2lmKGU9MHxlfHwxLDE2PT09KHQ9dHx8MTApfHwiaGV4Ij09PXQpe2k9IiI7Zm9yKHZhciBuPTAsbz0wLHM9MDtzPHRoaXMubGVuZ3RoO3MrKyl7dmFyIGg9dGhpcy53b3Jkc1tzXSx1PSgxNjc3NzIxNSYoaDw8bnxvKSkudG9TdHJpbmcoMTYpO289aD4+PjI0LW4mMTY3NzcyMTUsKG4rPTIpPj0yNiYmKG4tPTI2LHMtLSksaT0wIT09b3x8cyE9PXRoaXMubGVuZ3RoLTE/Y1s2LXUubGVuZ3RoXSt1K2k6dStpfWZvcigwIT09byYmKGk9by50b1N0cmluZygxNikraSk7aS5sZW5ndGglZSE9MDspaT0iMCIraTtyZXR1cm4gMCE9PXRoaXMubmVnYXRpdmUmJihpPSItIitpKSxpfWlmKHQ9PT0oMHx0KSYmdD49MiYmdDw9MzYpe3ZhciBhPXBbdF0sbD1tW3RdO2k9IiI7dmFyIGY9dGhpcy5jbG9uZSgpO2ZvcihmLm5lZ2F0aXZlPTA7IWYuaXNaZXJvKCk7KXt2YXIgZD1mLm1vZHJuKGwpLnRvU3RyaW5nKHQpO2k9KGY9Zi5pZGl2bihsKSkuaXNaZXJvKCk/ZCtpOmNbYS1kLmxlbmd0aF0rZCtpfWZvcih0aGlzLmlzWmVybygpJiYoaT0iMCIraSk7aS5sZW5ndGglZSE9MDspaT0iMCIraTtyZXR1cm4gMCE9PXRoaXMubmVnYXRpdmUmJihpPSItIitpKSxpfXIoITEsIkJhc2Ugc2hvdWxkIGJlIGJldHdlZW4gMiBhbmQgMzYiKX0sby5wcm90b3R5cGUudG9OdW1iZXI9ZnVuY3Rpb24oKXt2YXIgdD10aGlzLndvcmRzWzBdO3JldHVybiAyPT09dGhpcy5sZW5ndGg/dCs9NjcxMDg4NjQqdGhpcy53b3Jkc1sxXTozPT09dGhpcy5sZW5ndGgmJjE9PT10aGlzLndvcmRzWzJdP3QrPTQ1MDM1OTk2MjczNzA0OTYrNjcxMDg4NjQqdGhpcy53b3Jkc1sxXTp0aGlzLmxlbmd0aD4yJiZyKCExLCJOdW1iZXIgY2FuIG9ubHkgc2FmZWx5IHN0b3JlIHVwIHRvIDUzIGJpdHMiKSwwIT09dGhpcy5uZWdhdGl2ZT8tdDp0fSxvLnByb3RvdHlwZS50b0pTT049ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy50b1N0cmluZygxNiwyKX0scyYmKG8ucHJvdG90eXBlLnRvQnVmZmVyPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIHRoaXMudG9BcnJheUxpa2Uocyx0LGUpfSksby5wcm90b3R5cGUudG9BcnJheT1mdW5jdGlvbih0LGUpe3JldHVybiB0aGlzLnRvQXJyYXlMaWtlKEFycmF5LHQsZSl9LG8ucHJvdG90eXBlLnRvQXJyYXlMaWtlPWZ1bmN0aW9uKHQsZSxpKXt0aGlzLl9zdHJpcCgpO3ZhciBuPXRoaXMuYnl0ZUxlbmd0aCgpLG89aXx8TWF0aC5tYXgoMSxuKTtyKG48PW8sImJ5dGUgYXJyYXkgbG9uZ2VyIHRoYW4gZGVzaXJlZCBsZW5ndGgiKSxyKG8+MCwiUmVxdWVzdGVkIGFycmF5IGxlbmd0aCA8PSAwIik7dmFyIHM9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdC5hbGxvY1Vuc2FmZT90LmFsbG9jVW5zYWZlKGUpOm5ldyB0KGUpfSh0LG8pO3JldHVybiB0aGlzWyJfdG9BcnJheUxpa2UiKygibGUiPT09ZT8iTEUiOiJCRSIpXShzLG4pLHN9LG8ucHJvdG90eXBlLl90b0FycmF5TGlrZUxFPWZ1bmN0aW9uKHQsZSl7Zm9yKHZhciBpPTAscj0wLG49MCxvPTA7bjx0aGlzLmxlbmd0aDtuKyspe3ZhciBzPXRoaXMud29yZHNbbl08PG98cjt0W2krK109MjU1JnMsaTx0Lmxlbmd0aCYmKHRbaSsrXT1zPj44JjI1NSksaTx0Lmxlbmd0aCYmKHRbaSsrXT1zPj4xNiYyNTUpLDY9PT1vPyhpPHQubGVuZ3RoJiYodFtpKytdPXM+PjI0JjI1NSkscj0wLG89MCk6KHI9cz4+PjI0LG8rPTIpfWlmKGk8dC5sZW5ndGgpZm9yKHRbaSsrXT1yO2k8dC5sZW5ndGg7KXRbaSsrXT0wfSxvLnByb3RvdHlwZS5fdG9BcnJheUxpa2VCRT1mdW5jdGlvbih0LGUpe2Zvcih2YXIgaT10Lmxlbmd0aC0xLHI9MCxuPTAsbz0wO248dGhpcy5sZW5ndGg7bisrKXt2YXIgcz10aGlzLndvcmRzW25dPDxvfHI7dFtpLS1dPTI1NSZzLGk+PTAmJih0W2ktLV09cz4+OCYyNTUpLGk+PTAmJih0W2ktLV09cz4+MTYmMjU1KSw2PT09bz8oaT49MCYmKHRbaS0tXT1zPj4yNCYyNTUpLHI9MCxvPTApOihyPXM+Pj4yNCxvKz0yKX1pZihpPj0wKWZvcih0W2ktLV09cjtpPj0wOyl0W2ktLV09MH0sTWF0aC5jbHozMj9vLnByb3RvdHlwZS5fY291bnRCaXRzPWZ1bmN0aW9uKHQpe3JldHVybiAzMi1NYXRoLmNsejMyKHQpfTpvLnByb3RvdHlwZS5fY291bnRCaXRzPWZ1bmN0aW9uKHQpe3ZhciBlPXQsaT0wO3JldHVybiBlPj00MDk2JiYoaSs9MTMsZT4+Pj0xMyksZT49NjQmJihpKz03LGU+Pj49NyksZT49OCYmKGkrPTQsZT4+Pj00KSxlPj0yJiYoaSs9MixlPj4+PTIpLGkrZX0sby5wcm90b3R5cGUuX3plcm9CaXRzPWZ1bmN0aW9uKHQpe2lmKDA9PT10KXJldHVybiAyNjt2YXIgZT10LGk9MDtyZXR1cm4gODE5MSZlfHwoaSs9MTMsZT4+Pj0xMyksMTI3JmV8fChpKz03LGU+Pj49NyksMTUmZXx8KGkrPTQsZT4+Pj00KSwzJmV8fChpKz0yLGU+Pj49MiksMSZlfHxpKyssaX0sby5wcm90b3R5cGUuYml0TGVuZ3RoPWZ1bmN0aW9uKCl7dmFyIHQ9dGhpcy53b3Jkc1t0aGlzLmxlbmd0aC0xXSxlPXRoaXMuX2NvdW50Qml0cyh0KTtyZXR1cm4gMjYqKHRoaXMubGVuZ3RoLTEpK2V9LG8ucHJvdG90eXBlLnplcm9CaXRzPWZ1bmN0aW9uKCl7aWYodGhpcy5pc1plcm8oKSlyZXR1cm4gMDtmb3IodmFyIHQ9MCxlPTA7ZTx0aGlzLmxlbmd0aDtlKyspe3ZhciBpPXRoaXMuX3plcm9CaXRzKHRoaXMud29yZHNbZV0pO2lmKHQrPWksMjYhPT1pKWJyZWFrfXJldHVybiB0fSxvLnByb3RvdHlwZS5ieXRlTGVuZ3RoPWZ1bmN0aW9uKCl7cmV0dXJuIE1hdGguY2VpbCh0aGlzLmJpdExlbmd0aCgpLzgpfSxvLnByb3RvdHlwZS50b1R3b3M9ZnVuY3Rpb24odCl7cmV0dXJuIDAhPT10aGlzLm5lZ2F0aXZlP3RoaXMuYWJzKCkuaW5vdG4odCkuaWFkZG4oMSk6dGhpcy5jbG9uZSgpfSxvLnByb3RvdHlwZS5mcm9tVHdvcz1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy50ZXN0bih0LTEpP3RoaXMubm90bih0KS5pYWRkbigxKS5pbmVnKCk6dGhpcy5jbG9uZSgpfSxvLnByb3RvdHlwZS5pc05lZz1mdW5jdGlvbigpe3JldHVybiAwIT09dGhpcy5uZWdhdGl2ZX0sby5wcm90b3R5cGUubmVnPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuY2xvbmUoKS5pbmVnKCl9LG8ucHJvdG90eXBlLmluZWc9ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5pc1plcm8oKXx8KHRoaXMubmVnYXRpdmVePTEpLHRoaXN9LG8ucHJvdG90eXBlLml1b3I9ZnVuY3Rpb24odCl7Zm9yKDt0aGlzLmxlbmd0aDx0Lmxlbmd0aDspdGhpcy53b3Jkc1t0aGlzLmxlbmd0aCsrXT0wO2Zvcih2YXIgZT0wO2U8dC5sZW5ndGg7ZSsrKXRoaXMud29yZHNbZV09dGhpcy53b3Jkc1tlXXx0LndvcmRzW2VdO3JldHVybiB0aGlzLl9zdHJpcCgpfSxvLnByb3RvdHlwZS5pb3I9ZnVuY3Rpb24odCl7cmV0dXJuIHIoISh0aGlzLm5lZ2F0aXZlfHQubmVnYXRpdmUpKSx0aGlzLml1b3IodCl9LG8ucHJvdG90eXBlLm9yPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmxlbmd0aD50Lmxlbmd0aD90aGlzLmNsb25lKCkuaW9yKHQpOnQuY2xvbmUoKS5pb3IodGhpcyl9LG8ucHJvdG90eXBlLnVvcj1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5sZW5ndGg+dC5sZW5ndGg/dGhpcy5jbG9uZSgpLml1b3IodCk6dC5jbG9uZSgpLml1b3IodGhpcyl9LG8ucHJvdG90eXBlLml1YW5kPWZ1bmN0aW9uKHQpe3ZhciBlO2U9dGhpcy5sZW5ndGg+dC5sZW5ndGg/dDp0aGlzO2Zvcih2YXIgaT0wO2k8ZS5sZW5ndGg7aSsrKXRoaXMud29yZHNbaV09dGhpcy53b3Jkc1tpXSZ0LndvcmRzW2ldO3JldHVybiB0aGlzLmxlbmd0aD1lLmxlbmd0aCx0aGlzLl9zdHJpcCgpfSxvLnByb3RvdHlwZS5pYW5kPWZ1bmN0aW9uKHQpe3JldHVybiByKCEodGhpcy5uZWdhdGl2ZXx0Lm5lZ2F0aXZlKSksdGhpcy5pdWFuZCh0KX0sby5wcm90b3R5cGUuYW5kPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmxlbmd0aD50Lmxlbmd0aD90aGlzLmNsb25lKCkuaWFuZCh0KTp0LmNsb25lKCkuaWFuZCh0aGlzKX0sby5wcm90b3R5cGUudWFuZD1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5sZW5ndGg+dC5sZW5ndGg/dGhpcy5jbG9uZSgpLml1YW5kKHQpOnQuY2xvbmUoKS5pdWFuZCh0aGlzKX0sby5wcm90b3R5cGUuaXV4b3I9ZnVuY3Rpb24odCl7dmFyIGUsaTt0aGlzLmxlbmd0aD50Lmxlbmd0aD8oZT10aGlzLGk9dCk6KGU9dCxpPXRoaXMpO2Zvcih2YXIgcj0wO3I8aS5sZW5ndGg7cisrKXRoaXMud29yZHNbcl09ZS53b3Jkc1tyXV5pLndvcmRzW3JdO2lmKHRoaXMhPT1lKWZvcig7cjxlLmxlbmd0aDtyKyspdGhpcy53b3Jkc1tyXT1lLndvcmRzW3JdO3JldHVybiB0aGlzLmxlbmd0aD1lLmxlbmd0aCx0aGlzLl9zdHJpcCgpfSxvLnByb3RvdHlwZS5peG9yPWZ1bmN0aW9uKHQpe3JldHVybiByKCEodGhpcy5uZWdhdGl2ZXx0Lm5lZ2F0aXZlKSksdGhpcy5pdXhvcih0KX0sby5wcm90b3R5cGUueG9yPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmxlbmd0aD50Lmxlbmd0aD90aGlzLmNsb25lKCkuaXhvcih0KTp0LmNsb25lKCkuaXhvcih0aGlzKX0sby5wcm90b3R5cGUudXhvcj1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5sZW5ndGg+dC5sZW5ndGg/dGhpcy5jbG9uZSgpLml1eG9yKHQpOnQuY2xvbmUoKS5pdXhvcih0aGlzKX0sby5wcm90b3R5cGUuaW5vdG49ZnVuY3Rpb24odCl7cigibnVtYmVyIj09dHlwZW9mIHQmJnQ+PTApO3ZhciBlPTB8TWF0aC5jZWlsKHQvMjYpLGk9dCUyNjt0aGlzLl9leHBhbmQoZSksaT4wJiZlLS07Zm9yKHZhciBuPTA7bjxlO24rKyl0aGlzLndvcmRzW25dPTY3MTA4ODYzJn50aGlzLndvcmRzW25dO3JldHVybiBpPjAmJih0aGlzLndvcmRzW25dPX50aGlzLndvcmRzW25dJjY3MTA4ODYzPj4yNi1pKSx0aGlzLl9zdHJpcCgpfSxvLnByb3RvdHlwZS5ub3RuPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNsb25lKCkuaW5vdG4odCl9LG8ucHJvdG90eXBlLnNldG49ZnVuY3Rpb24odCxlKXtyKCJudW1iZXIiPT10eXBlb2YgdCYmdD49MCk7dmFyIGk9dC8yNnwwLG49dCUyNjtyZXR1cm4gdGhpcy5fZXhwYW5kKGkrMSksdGhpcy53b3Jkc1tpXT1lP3RoaXMud29yZHNbaV18MTw8bjp0aGlzLndvcmRzW2ldJn4oMTw8biksdGhpcy5fc3RyaXAoKX0sby5wcm90b3R5cGUuaWFkZD1mdW5jdGlvbih0KXt2YXIgZSxpLHI7aWYoMCE9PXRoaXMubmVnYXRpdmUmJjA9PT10Lm5lZ2F0aXZlKXJldHVybiB0aGlzLm5lZ2F0aXZlPTAsZT10aGlzLmlzdWIodCksdGhpcy5uZWdhdGl2ZV49MSx0aGlzLl9ub3JtU2lnbigpO2lmKDA9PT10aGlzLm5lZ2F0aXZlJiYwIT09dC5uZWdhdGl2ZSlyZXR1cm4gdC5uZWdhdGl2ZT0wLGU9dGhpcy5pc3ViKHQpLHQubmVnYXRpdmU9MSxlLl9ub3JtU2lnbigpO3RoaXMubGVuZ3RoPnQubGVuZ3RoPyhpPXRoaXMscj10KTooaT10LHI9dGhpcyk7Zm9yKHZhciBuPTAsbz0wO288ci5sZW5ndGg7bysrKWU9KDB8aS53b3Jkc1tvXSkrKDB8ci53b3Jkc1tvXSkrbix0aGlzLndvcmRzW29dPTY3MTA4ODYzJmUsbj1lPj4+MjY7Zm9yKDswIT09biYmbzxpLmxlbmd0aDtvKyspZT0oMHxpLndvcmRzW29dKStuLHRoaXMud29yZHNbb109NjcxMDg4NjMmZSxuPWU+Pj4yNjtpZih0aGlzLmxlbmd0aD1pLmxlbmd0aCwwIT09bil0aGlzLndvcmRzW3RoaXMubGVuZ3RoXT1uLHRoaXMubGVuZ3RoKys7ZWxzZSBpZihpIT09dGhpcylmb3IoO288aS5sZW5ndGg7bysrKXRoaXMud29yZHNbb109aS53b3Jkc1tvXTtyZXR1cm4gdGhpc30sby5wcm90b3R5cGUuYWRkPWZ1bmN0aW9uKHQpe3ZhciBlO3JldHVybiAwIT09dC5uZWdhdGl2ZSYmMD09PXRoaXMubmVnYXRpdmU/KHQubmVnYXRpdmU9MCxlPXRoaXMuc3ViKHQpLHQubmVnYXRpdmVePTEsZSk6MD09PXQubmVnYXRpdmUmJjAhPT10aGlzLm5lZ2F0aXZlPyh0aGlzLm5lZ2F0aXZlPTAsZT10LnN1Yih0aGlzKSx0aGlzLm5lZ2F0aXZlPTEsZSk6dGhpcy5sZW5ndGg+dC5sZW5ndGg/dGhpcy5jbG9uZSgpLmlhZGQodCk6dC5jbG9uZSgpLmlhZGQodGhpcyl9LG8ucHJvdG90eXBlLmlzdWI9ZnVuY3Rpb24odCl7aWYoMCE9PXQubmVnYXRpdmUpe3QubmVnYXRpdmU9MDt2YXIgZT10aGlzLmlhZGQodCk7cmV0dXJuIHQubmVnYXRpdmU9MSxlLl9ub3JtU2lnbigpfWlmKDAhPT10aGlzLm5lZ2F0aXZlKXJldHVybiB0aGlzLm5lZ2F0aXZlPTAsdGhpcy5pYWRkKHQpLHRoaXMubmVnYXRpdmU9MSx0aGlzLl9ub3JtU2lnbigpO3ZhciBpLHIsbj10aGlzLmNtcCh0KTtpZigwPT09bilyZXR1cm4gdGhpcy5uZWdhdGl2ZT0wLHRoaXMubGVuZ3RoPTEsdGhpcy53b3Jkc1swXT0wLHRoaXM7bj4wPyhpPXRoaXMscj10KTooaT10LHI9dGhpcyk7Zm9yKHZhciBvPTAscz0wO3M8ci5sZW5ndGg7cysrKW89KGU9KDB8aS53b3Jkc1tzXSktKDB8ci53b3Jkc1tzXSkrbyk+PjI2LHRoaXMud29yZHNbc109NjcxMDg4NjMmZTtmb3IoOzAhPT1vJiZzPGkubGVuZ3RoO3MrKylvPShlPSgwfGkud29yZHNbc10pK28pPj4yNix0aGlzLndvcmRzW3NdPTY3MTA4ODYzJmU7aWYoMD09PW8mJnM8aS5sZW5ndGgmJmkhPT10aGlzKWZvcig7czxpLmxlbmd0aDtzKyspdGhpcy53b3Jkc1tzXT1pLndvcmRzW3NdO3JldHVybiB0aGlzLmxlbmd0aD1NYXRoLm1heCh0aGlzLmxlbmd0aCxzKSxpIT09dGhpcyYmKHRoaXMubmVnYXRpdmU9MSksdGhpcy5fc3RyaXAoKX0sby5wcm90b3R5cGUuc3ViPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNsb25lKCkuaXN1Yih0KX07dmFyIGc9ZnVuY3Rpb24odCxlLGkpe3ZhciByLG4sbyxzPXQud29yZHMsaD1lLndvcmRzLHU9aS53b3JkcyxhPTAsbD0wfHNbMF0sZj04MTkxJmwsYz1sPj4+MTMscD0wfHNbMV0sbT04MTkxJnAsZD1wPj4+MTMsZz0wfHNbMl0seT04MTkxJmcsdz1nPj4+MTMsdj0wfHNbM10sTT04MTkxJnYsYj12Pj4+MTMsQT0wfHNbNF0sQj04MTkxJkEsRT1BPj4+MTMsaz0wfHNbNV0sXz04MTkxJmssVD1rPj4+MTMsST0wfHNbNl0sUz04MTkxJkksUj1JPj4+MTMsVT0wfHNbN10seD04MTkxJlUsTD1VPj4+MTMsTz0wfHNbOF0sUD04MTkxJk8sTj1PPj4+MTMsJD0wfHNbOV0sQz04MTkxJiQsaj0kPj4+MTMscT0wfGhbMF0sWj04MTkxJnEsVz1xPj4+MTMsSz0wfGhbMV0sRj04MTkxJkssej1LPj4+MTMsVj0wfGhbMl0sRD04MTkxJlYsRz1WPj4+MTMsSD0wfGhbM10sSj04MTkxJkgsWT1IPj4+MTMsUT0wfGhbNF0sWD04MTkxJlEsdHQ9UT4+PjEzLGV0PTB8aFs1XSxpdD04MTkxJmV0LHJ0PWV0Pj4+MTMsbnQ9MHxoWzZdLG90PTgxOTEmbnQsc3Q9bnQ+Pj4xMyxodD0wfGhbN10sdXQ9ODE5MSZodCxhdD1odD4+PjEzLGx0PTB8aFs4XSxmdD04MTkxJmx0LGN0PWx0Pj4+MTMscHQ9MHxoWzldLG10PTgxOTEmcHQsZHQ9cHQ+Pj4xMztpLm5lZ2F0aXZlPXQubmVnYXRpdmVeZS5uZWdhdGl2ZSxpLmxlbmd0aD0xOTt2YXIgZ3Q9KGErKHI9TWF0aC5pbXVsKGYsWikpfDApKygoODE5MSYobj0obj1NYXRoLmltdWwoZixXKSkrTWF0aC5pbXVsKGMsWil8MCkpPDwxMyl8MDthPSgobz1NYXRoLmltdWwoYyxXKSkrKG4+Pj4xMyl8MCkrKGd0Pj4+MjYpfDAsZ3QmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKG0sWiksbj0obj1NYXRoLmltdWwobSxXKSkrTWF0aC5pbXVsKGQsWil8MCxvPU1hdGguaW11bChkLFcpO3ZhciB5dD0oYSsocj1yK01hdGguaW11bChmLEYpfDApfDApKygoODE5MSYobj0obj1uK01hdGguaW11bChmLHopfDApK01hdGguaW11bChjLEYpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoYyx6KXwwKSsobj4+PjEzKXwwKSsoeXQ+Pj4yNil8MCx5dCY9NjcxMDg4NjMscj1NYXRoLmltdWwoeSxaKSxuPShuPU1hdGguaW11bCh5LFcpKStNYXRoLmltdWwodyxaKXwwLG89TWF0aC5pbXVsKHcsVykscj1yK01hdGguaW11bChtLEYpfDAsbj0obj1uK01hdGguaW11bChtLHopfDApK01hdGguaW11bChkLEYpfDAsbz1vK01hdGguaW11bChkLHopfDA7dmFyIHd0PShhKyhyPXIrTWF0aC5pbXVsKGYsRCl8MCl8MCkrKCg4MTkxJihuPShuPW4rTWF0aC5pbXVsKGYsRyl8MCkrTWF0aC5pbXVsKGMsRCl8MCkpPDwxMyl8MDthPSgobz1vK01hdGguaW11bChjLEcpfDApKyhuPj4+MTMpfDApKyh3dD4+PjI2KXwwLHd0Jj02NzEwODg2MyxyPU1hdGguaW11bChNLFopLG49KG49TWF0aC5pbXVsKE0sVykpK01hdGguaW11bChiLFopfDAsbz1NYXRoLmltdWwoYixXKSxyPXIrTWF0aC5pbXVsKHksRil8MCxuPShuPW4rTWF0aC5pbXVsKHkseil8MCkrTWF0aC5pbXVsKHcsRil8MCxvPW8rTWF0aC5pbXVsKHcseil8MCxyPXIrTWF0aC5pbXVsKG0sRCl8MCxuPShuPW4rTWF0aC5pbXVsKG0sRyl8MCkrTWF0aC5pbXVsKGQsRCl8MCxvPW8rTWF0aC5pbXVsKGQsRyl8MDt2YXIgdnQ9KGErKHI9citNYXRoLmltdWwoZixKKXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoZixZKXwwKStNYXRoLmltdWwoYyxKKXwwKSk8PDEzKXwwO2E9KChvPW8rTWF0aC5pbXVsKGMsWSl8MCkrKG4+Pj4xMyl8MCkrKHZ0Pj4+MjYpfDAsdnQmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKEIsWiksbj0obj1NYXRoLmltdWwoQixXKSkrTWF0aC5pbXVsKEUsWil8MCxvPU1hdGguaW11bChFLFcpLHI9citNYXRoLmltdWwoTSxGKXwwLG49KG49bitNYXRoLmltdWwoTSx6KXwwKStNYXRoLmltdWwoYixGKXwwLG89bytNYXRoLmltdWwoYix6KXwwLHI9citNYXRoLmltdWwoeSxEKXwwLG49KG49bitNYXRoLmltdWwoeSxHKXwwKStNYXRoLmltdWwodyxEKXwwLG89bytNYXRoLmltdWwodyxHKXwwLHI9citNYXRoLmltdWwobSxKKXwwLG49KG49bitNYXRoLmltdWwobSxZKXwwKStNYXRoLmltdWwoZCxKKXwwLG89bytNYXRoLmltdWwoZCxZKXwwO3ZhciBNdD0oYSsocj1yK01hdGguaW11bChmLFgpfDApfDApKygoODE5MSYobj0obj1uK01hdGguaW11bChmLHR0KXwwKStNYXRoLmltdWwoYyxYKXwwKSk8PDEzKXwwO2E9KChvPW8rTWF0aC5pbXVsKGMsdHQpfDApKyhuPj4+MTMpfDApKyhNdD4+PjI2KXwwLE10Jj02NzEwODg2MyxyPU1hdGguaW11bChfLFopLG49KG49TWF0aC5pbXVsKF8sVykpK01hdGguaW11bChULFopfDAsbz1NYXRoLmltdWwoVCxXKSxyPXIrTWF0aC5pbXVsKEIsRil8MCxuPShuPW4rTWF0aC5pbXVsKEIseil8MCkrTWF0aC5pbXVsKEUsRil8MCxvPW8rTWF0aC5pbXVsKEUseil8MCxyPXIrTWF0aC5pbXVsKE0sRCl8MCxuPShuPW4rTWF0aC5pbXVsKE0sRyl8MCkrTWF0aC5pbXVsKGIsRCl8MCxvPW8rTWF0aC5pbXVsKGIsRyl8MCxyPXIrTWF0aC5pbXVsKHksSil8MCxuPShuPW4rTWF0aC5pbXVsKHksWSl8MCkrTWF0aC5pbXVsKHcsSil8MCxvPW8rTWF0aC5pbXVsKHcsWSl8MCxyPXIrTWF0aC5pbXVsKG0sWCl8MCxuPShuPW4rTWF0aC5pbXVsKG0sdHQpfDApK01hdGguaW11bChkLFgpfDAsbz1vK01hdGguaW11bChkLHR0KXwwO3ZhciBidD0oYSsocj1yK01hdGguaW11bChmLGl0KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoZixydCl8MCkrTWF0aC5pbXVsKGMsaXQpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoYyxydCl8MCkrKG4+Pj4xMyl8MCkrKGJ0Pj4+MjYpfDAsYnQmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKFMsWiksbj0obj1NYXRoLmltdWwoUyxXKSkrTWF0aC5pbXVsKFIsWil8MCxvPU1hdGguaW11bChSLFcpLHI9citNYXRoLmltdWwoXyxGKXwwLG49KG49bitNYXRoLmltdWwoXyx6KXwwKStNYXRoLmltdWwoVCxGKXwwLG89bytNYXRoLmltdWwoVCx6KXwwLHI9citNYXRoLmltdWwoQixEKXwwLG49KG49bitNYXRoLmltdWwoQixHKXwwKStNYXRoLmltdWwoRSxEKXwwLG89bytNYXRoLmltdWwoRSxHKXwwLHI9citNYXRoLmltdWwoTSxKKXwwLG49KG49bitNYXRoLmltdWwoTSxZKXwwKStNYXRoLmltdWwoYixKKXwwLG89bytNYXRoLmltdWwoYixZKXwwLHI9citNYXRoLmltdWwoeSxYKXwwLG49KG49bitNYXRoLmltdWwoeSx0dCl8MCkrTWF0aC5pbXVsKHcsWCl8MCxvPW8rTWF0aC5pbXVsKHcsdHQpfDAscj1yK01hdGguaW11bChtLGl0KXwwLG49KG49bitNYXRoLmltdWwobSxydCl8MCkrTWF0aC5pbXVsKGQsaXQpfDAsbz1vK01hdGguaW11bChkLHJ0KXwwO3ZhciBBdD0oYSsocj1yK01hdGguaW11bChmLG90KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoZixzdCl8MCkrTWF0aC5pbXVsKGMsb3QpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoYyxzdCl8MCkrKG4+Pj4xMyl8MCkrKEF0Pj4+MjYpfDAsQXQmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKHgsWiksbj0obj1NYXRoLmltdWwoeCxXKSkrTWF0aC5pbXVsKEwsWil8MCxvPU1hdGguaW11bChMLFcpLHI9citNYXRoLmltdWwoUyxGKXwwLG49KG49bitNYXRoLmltdWwoUyx6KXwwKStNYXRoLmltdWwoUixGKXwwLG89bytNYXRoLmltdWwoUix6KXwwLHI9citNYXRoLmltdWwoXyxEKXwwLG49KG49bitNYXRoLmltdWwoXyxHKXwwKStNYXRoLmltdWwoVCxEKXwwLG89bytNYXRoLmltdWwoVCxHKXwwLHI9citNYXRoLmltdWwoQixKKXwwLG49KG49bitNYXRoLmltdWwoQixZKXwwKStNYXRoLmltdWwoRSxKKXwwLG89bytNYXRoLmltdWwoRSxZKXwwLHI9citNYXRoLmltdWwoTSxYKXwwLG49KG49bitNYXRoLmltdWwoTSx0dCl8MCkrTWF0aC5pbXVsKGIsWCl8MCxvPW8rTWF0aC5pbXVsKGIsdHQpfDAscj1yK01hdGguaW11bCh5LGl0KXwwLG49KG49bitNYXRoLmltdWwoeSxydCl8MCkrTWF0aC5pbXVsKHcsaXQpfDAsbz1vK01hdGguaW11bCh3LHJ0KXwwLHI9citNYXRoLmltdWwobSxvdCl8MCxuPShuPW4rTWF0aC5pbXVsKG0sc3QpfDApK01hdGguaW11bChkLG90KXwwLG89bytNYXRoLmltdWwoZCxzdCl8MDt2YXIgQnQ9KGErKHI9citNYXRoLmltdWwoZix1dCl8MCl8MCkrKCg4MTkxJihuPShuPW4rTWF0aC5pbXVsKGYsYXQpfDApK01hdGguaW11bChjLHV0KXwwKSk8PDEzKXwwO2E9KChvPW8rTWF0aC5pbXVsKGMsYXQpfDApKyhuPj4+MTMpfDApKyhCdD4+PjI2KXwwLEJ0Jj02NzEwODg2MyxyPU1hdGguaW11bChQLFopLG49KG49TWF0aC5pbXVsKFAsVykpK01hdGguaW11bChOLFopfDAsbz1NYXRoLmltdWwoTixXKSxyPXIrTWF0aC5pbXVsKHgsRil8MCxuPShuPW4rTWF0aC5pbXVsKHgseil8MCkrTWF0aC5pbXVsKEwsRil8MCxvPW8rTWF0aC5pbXVsKEwseil8MCxyPXIrTWF0aC5pbXVsKFMsRCl8MCxuPShuPW4rTWF0aC5pbXVsKFMsRyl8MCkrTWF0aC5pbXVsKFIsRCl8MCxvPW8rTWF0aC5pbXVsKFIsRyl8MCxyPXIrTWF0aC5pbXVsKF8sSil8MCxuPShuPW4rTWF0aC5pbXVsKF8sWSl8MCkrTWF0aC5pbXVsKFQsSil8MCxvPW8rTWF0aC5pbXVsKFQsWSl8MCxyPXIrTWF0aC5pbXVsKEIsWCl8MCxuPShuPW4rTWF0aC5pbXVsKEIsdHQpfDApK01hdGguaW11bChFLFgpfDAsbz1vK01hdGguaW11bChFLHR0KXwwLHI9citNYXRoLmltdWwoTSxpdCl8MCxuPShuPW4rTWF0aC5pbXVsKE0scnQpfDApK01hdGguaW11bChiLGl0KXwwLG89bytNYXRoLmltdWwoYixydCl8MCxyPXIrTWF0aC5pbXVsKHksb3QpfDAsbj0obj1uK01hdGguaW11bCh5LHN0KXwwKStNYXRoLmltdWwodyxvdCl8MCxvPW8rTWF0aC5pbXVsKHcsc3QpfDAscj1yK01hdGguaW11bChtLHV0KXwwLG49KG49bitNYXRoLmltdWwobSxhdCl8MCkrTWF0aC5pbXVsKGQsdXQpfDAsbz1vK01hdGguaW11bChkLGF0KXwwO3ZhciBFdD0oYSsocj1yK01hdGguaW11bChmLGZ0KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoZixjdCl8MCkrTWF0aC5pbXVsKGMsZnQpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoYyxjdCl8MCkrKG4+Pj4xMyl8MCkrKEV0Pj4+MjYpfDAsRXQmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKEMsWiksbj0obj1NYXRoLmltdWwoQyxXKSkrTWF0aC5pbXVsKGosWil8MCxvPU1hdGguaW11bChqLFcpLHI9citNYXRoLmltdWwoUCxGKXwwLG49KG49bitNYXRoLmltdWwoUCx6KXwwKStNYXRoLmltdWwoTixGKXwwLG89bytNYXRoLmltdWwoTix6KXwwLHI9citNYXRoLmltdWwoeCxEKXwwLG49KG49bitNYXRoLmltdWwoeCxHKXwwKStNYXRoLmltdWwoTCxEKXwwLG89bytNYXRoLmltdWwoTCxHKXwwLHI9citNYXRoLmltdWwoUyxKKXwwLG49KG49bitNYXRoLmltdWwoUyxZKXwwKStNYXRoLmltdWwoUixKKXwwLG89bytNYXRoLmltdWwoUixZKXwwLHI9citNYXRoLmltdWwoXyxYKXwwLG49KG49bitNYXRoLmltdWwoXyx0dCl8MCkrTWF0aC5pbXVsKFQsWCl8MCxvPW8rTWF0aC5pbXVsKFQsdHQpfDAscj1yK01hdGguaW11bChCLGl0KXwwLG49KG49bitNYXRoLmltdWwoQixydCl8MCkrTWF0aC5pbXVsKEUsaXQpfDAsbz1vK01hdGguaW11bChFLHJ0KXwwLHI9citNYXRoLmltdWwoTSxvdCl8MCxuPShuPW4rTWF0aC5pbXVsKE0sc3QpfDApK01hdGguaW11bChiLG90KXwwLG89bytNYXRoLmltdWwoYixzdCl8MCxyPXIrTWF0aC5pbXVsKHksdXQpfDAsbj0obj1uK01hdGguaW11bCh5LGF0KXwwKStNYXRoLmltdWwodyx1dCl8MCxvPW8rTWF0aC5pbXVsKHcsYXQpfDAscj1yK01hdGguaW11bChtLGZ0KXwwLG49KG49bitNYXRoLmltdWwobSxjdCl8MCkrTWF0aC5pbXVsKGQsZnQpfDAsbz1vK01hdGguaW11bChkLGN0KXwwO3ZhciBrdD0oYSsocj1yK01hdGguaW11bChmLG10KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoZixkdCl8MCkrTWF0aC5pbXVsKGMsbXQpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoYyxkdCl8MCkrKG4+Pj4xMyl8MCkrKGt0Pj4+MjYpfDAsa3QmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKEMsRiksbj0obj1NYXRoLmltdWwoQyx6KSkrTWF0aC5pbXVsKGosRil8MCxvPU1hdGguaW11bChqLHopLHI9citNYXRoLmltdWwoUCxEKXwwLG49KG49bitNYXRoLmltdWwoUCxHKXwwKStNYXRoLmltdWwoTixEKXwwLG89bytNYXRoLmltdWwoTixHKXwwLHI9citNYXRoLmltdWwoeCxKKXwwLG49KG49bitNYXRoLmltdWwoeCxZKXwwKStNYXRoLmltdWwoTCxKKXwwLG89bytNYXRoLmltdWwoTCxZKXwwLHI9citNYXRoLmltdWwoUyxYKXwwLG49KG49bitNYXRoLmltdWwoUyx0dCl8MCkrTWF0aC5pbXVsKFIsWCl8MCxvPW8rTWF0aC5pbXVsKFIsdHQpfDAscj1yK01hdGguaW11bChfLGl0KXwwLG49KG49bitNYXRoLmltdWwoXyxydCl8MCkrTWF0aC5pbXVsKFQsaXQpfDAsbz1vK01hdGguaW11bChULHJ0KXwwLHI9citNYXRoLmltdWwoQixvdCl8MCxuPShuPW4rTWF0aC5pbXVsKEIsc3QpfDApK01hdGguaW11bChFLG90KXwwLG89bytNYXRoLmltdWwoRSxzdCl8MCxyPXIrTWF0aC5pbXVsKE0sdXQpfDAsbj0obj1uK01hdGguaW11bChNLGF0KXwwKStNYXRoLmltdWwoYix1dCl8MCxvPW8rTWF0aC5pbXVsKGIsYXQpfDAscj1yK01hdGguaW11bCh5LGZ0KXwwLG49KG49bitNYXRoLmltdWwoeSxjdCl8MCkrTWF0aC5pbXVsKHcsZnQpfDAsbz1vK01hdGguaW11bCh3LGN0KXwwO3ZhciBfdD0oYSsocj1yK01hdGguaW11bChtLG10KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwobSxkdCl8MCkrTWF0aC5pbXVsKGQsbXQpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoZCxkdCl8MCkrKG4+Pj4xMyl8MCkrKF90Pj4+MjYpfDAsX3QmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKEMsRCksbj0obj1NYXRoLmltdWwoQyxHKSkrTWF0aC5pbXVsKGosRCl8MCxvPU1hdGguaW11bChqLEcpLHI9citNYXRoLmltdWwoUCxKKXwwLG49KG49bitNYXRoLmltdWwoUCxZKXwwKStNYXRoLmltdWwoTixKKXwwLG89bytNYXRoLmltdWwoTixZKXwwLHI9citNYXRoLmltdWwoeCxYKXwwLG49KG49bitNYXRoLmltdWwoeCx0dCl8MCkrTWF0aC5pbXVsKEwsWCl8MCxvPW8rTWF0aC5pbXVsKEwsdHQpfDAscj1yK01hdGguaW11bChTLGl0KXwwLG49KG49bitNYXRoLmltdWwoUyxydCl8MCkrTWF0aC5pbXVsKFIsaXQpfDAsbz1vK01hdGguaW11bChSLHJ0KXwwLHI9citNYXRoLmltdWwoXyxvdCl8MCxuPShuPW4rTWF0aC5pbXVsKF8sc3QpfDApK01hdGguaW11bChULG90KXwwLG89bytNYXRoLmltdWwoVCxzdCl8MCxyPXIrTWF0aC5pbXVsKEIsdXQpfDAsbj0obj1uK01hdGguaW11bChCLGF0KXwwKStNYXRoLmltdWwoRSx1dCl8MCxvPW8rTWF0aC5pbXVsKEUsYXQpfDAscj1yK01hdGguaW11bChNLGZ0KXwwLG49KG49bitNYXRoLmltdWwoTSxjdCl8MCkrTWF0aC5pbXVsKGIsZnQpfDAsbz1vK01hdGguaW11bChiLGN0KXwwO3ZhciBUdD0oYSsocj1yK01hdGguaW11bCh5LG10KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoeSxkdCl8MCkrTWF0aC5pbXVsKHcsbXQpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwodyxkdCl8MCkrKG4+Pj4xMyl8MCkrKFR0Pj4+MjYpfDAsVHQmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKEMsSiksbj0obj1NYXRoLmltdWwoQyxZKSkrTWF0aC5pbXVsKGosSil8MCxvPU1hdGguaW11bChqLFkpLHI9citNYXRoLmltdWwoUCxYKXwwLG49KG49bitNYXRoLmltdWwoUCx0dCl8MCkrTWF0aC5pbXVsKE4sWCl8MCxvPW8rTWF0aC5pbXVsKE4sdHQpfDAscj1yK01hdGguaW11bCh4LGl0KXwwLG49KG49bitNYXRoLmltdWwoeCxydCl8MCkrTWF0aC5pbXVsKEwsaXQpfDAsbz1vK01hdGguaW11bChMLHJ0KXwwLHI9citNYXRoLmltdWwoUyxvdCl8MCxuPShuPW4rTWF0aC5pbXVsKFMsc3QpfDApK01hdGguaW11bChSLG90KXwwLG89bytNYXRoLmltdWwoUixzdCl8MCxyPXIrTWF0aC5pbXVsKF8sdXQpfDAsbj0obj1uK01hdGguaW11bChfLGF0KXwwKStNYXRoLmltdWwoVCx1dCl8MCxvPW8rTWF0aC5pbXVsKFQsYXQpfDAscj1yK01hdGguaW11bChCLGZ0KXwwLG49KG49bitNYXRoLmltdWwoQixjdCl8MCkrTWF0aC5pbXVsKEUsZnQpfDAsbz1vK01hdGguaW11bChFLGN0KXwwO3ZhciBJdD0oYSsocj1yK01hdGguaW11bChNLG10KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoTSxkdCl8MCkrTWF0aC5pbXVsKGIsbXQpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoYixkdCl8MCkrKG4+Pj4xMyl8MCkrKEl0Pj4+MjYpfDAsSXQmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKEMsWCksbj0obj1NYXRoLmltdWwoQyx0dCkpK01hdGguaW11bChqLFgpfDAsbz1NYXRoLmltdWwoaix0dCkscj1yK01hdGguaW11bChQLGl0KXwwLG49KG49bitNYXRoLmltdWwoUCxydCl8MCkrTWF0aC5pbXVsKE4saXQpfDAsbz1vK01hdGguaW11bChOLHJ0KXwwLHI9citNYXRoLmltdWwoeCxvdCl8MCxuPShuPW4rTWF0aC5pbXVsKHgsc3QpfDApK01hdGguaW11bChMLG90KXwwLG89bytNYXRoLmltdWwoTCxzdCl8MCxyPXIrTWF0aC5pbXVsKFMsdXQpfDAsbj0obj1uK01hdGguaW11bChTLGF0KXwwKStNYXRoLmltdWwoUix1dCl8MCxvPW8rTWF0aC5pbXVsKFIsYXQpfDAscj1yK01hdGguaW11bChfLGZ0KXwwLG49KG49bitNYXRoLmltdWwoXyxjdCl8MCkrTWF0aC5pbXVsKFQsZnQpfDAsbz1vK01hdGguaW11bChULGN0KXwwO3ZhciBTdD0oYSsocj1yK01hdGguaW11bChCLG10KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoQixkdCl8MCkrTWF0aC5pbXVsKEUsbXQpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoRSxkdCl8MCkrKG4+Pj4xMyl8MCkrKFN0Pj4+MjYpfDAsU3QmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKEMsaXQpLG49KG49TWF0aC5pbXVsKEMscnQpKStNYXRoLmltdWwoaixpdCl8MCxvPU1hdGguaW11bChqLHJ0KSxyPXIrTWF0aC5pbXVsKFAsb3QpfDAsbj0obj1uK01hdGguaW11bChQLHN0KXwwKStNYXRoLmltdWwoTixvdCl8MCxvPW8rTWF0aC5pbXVsKE4sc3QpfDAscj1yK01hdGguaW11bCh4LHV0KXwwLG49KG49bitNYXRoLmltdWwoeCxhdCl8MCkrTWF0aC5pbXVsKEwsdXQpfDAsbz1vK01hdGguaW11bChMLGF0KXwwLHI9citNYXRoLmltdWwoUyxmdCl8MCxuPShuPW4rTWF0aC5pbXVsKFMsY3QpfDApK01hdGguaW11bChSLGZ0KXwwLG89bytNYXRoLmltdWwoUixjdCl8MDt2YXIgUnQ9KGErKHI9citNYXRoLmltdWwoXyxtdCl8MCl8MCkrKCg4MTkxJihuPShuPW4rTWF0aC5pbXVsKF8sZHQpfDApK01hdGguaW11bChULG10KXwwKSk8PDEzKXwwO2E9KChvPW8rTWF0aC5pbXVsKFQsZHQpfDApKyhuPj4+MTMpfDApKyhSdD4+PjI2KXwwLFJ0Jj02NzEwODg2MyxyPU1hdGguaW11bChDLG90KSxuPShuPU1hdGguaW11bChDLHN0KSkrTWF0aC5pbXVsKGosb3QpfDAsbz1NYXRoLmltdWwoaixzdCkscj1yK01hdGguaW11bChQLHV0KXwwLG49KG49bitNYXRoLmltdWwoUCxhdCl8MCkrTWF0aC5pbXVsKE4sdXQpfDAsbz1vK01hdGguaW11bChOLGF0KXwwLHI9citNYXRoLmltdWwoeCxmdCl8MCxuPShuPW4rTWF0aC5pbXVsKHgsY3QpfDApK01hdGguaW11bChMLGZ0KXwwLG89bytNYXRoLmltdWwoTCxjdCl8MDt2YXIgVXQ9KGErKHI9citNYXRoLmltdWwoUyxtdCl8MCl8MCkrKCg4MTkxJihuPShuPW4rTWF0aC5pbXVsKFMsZHQpfDApK01hdGguaW11bChSLG10KXwwKSk8PDEzKXwwO2E9KChvPW8rTWF0aC5pbXVsKFIsZHQpfDApKyhuPj4+MTMpfDApKyhVdD4+PjI2KXwwLFV0Jj02NzEwODg2MyxyPU1hdGguaW11bChDLHV0KSxuPShuPU1hdGguaW11bChDLGF0KSkrTWF0aC5pbXVsKGosdXQpfDAsbz1NYXRoLmltdWwoaixhdCkscj1yK01hdGguaW11bChQLGZ0KXwwLG49KG49bitNYXRoLmltdWwoUCxjdCl8MCkrTWF0aC5pbXVsKE4sZnQpfDAsbz1vK01hdGguaW11bChOLGN0KXwwO3ZhciB4dD0oYSsocj1yK01hdGguaW11bCh4LG10KXwwKXwwKSsoKDgxOTEmKG49KG49bitNYXRoLmltdWwoeCxkdCl8MCkrTWF0aC5pbXVsKEwsbXQpfDApKTw8MTMpfDA7YT0oKG89bytNYXRoLmltdWwoTCxkdCl8MCkrKG4+Pj4xMyl8MCkrKHh0Pj4+MjYpfDAseHQmPTY3MTA4ODYzLHI9TWF0aC5pbXVsKEMsZnQpLG49KG49TWF0aC5pbXVsKEMsY3QpKStNYXRoLmltdWwoaixmdCl8MCxvPU1hdGguaW11bChqLGN0KTt2YXIgTHQ9KGErKHI9citNYXRoLmltdWwoUCxtdCl8MCl8MCkrKCg4MTkxJihuPShuPW4rTWF0aC5pbXVsKFAsZHQpfDApK01hdGguaW11bChOLG10KXwwKSk8PDEzKXwwO2E9KChvPW8rTWF0aC5pbXVsKE4sZHQpfDApKyhuPj4+MTMpfDApKyhMdD4+PjI2KXwwLEx0Jj02NzEwODg2Mzt2YXIgT3Q9KGErKHI9TWF0aC5pbXVsKEMsbXQpKXwwKSsoKDgxOTEmKG49KG49TWF0aC5pbXVsKEMsZHQpKStNYXRoLmltdWwoaixtdCl8MCkpPDwxMyl8MDtyZXR1cm4gYT0oKG89TWF0aC5pbXVsKGosZHQpKSsobj4+PjEzKXwwKSsoT3Q+Pj4yNil8MCxPdCY9NjcxMDg4NjMsdVswXT1ndCx1WzFdPXl0LHVbMl09d3QsdVszXT12dCx1WzRdPU10LHVbNV09YnQsdVs2XT1BdCx1WzddPUJ0LHVbOF09RXQsdVs5XT1rdCx1WzEwXT1fdCx1WzExXT1UdCx1WzEyXT1JdCx1WzEzXT1TdCx1WzE0XT1SdCx1WzE1XT1VdCx1WzE2XT14dCx1WzE3XT1MdCx1WzE4XT1PdCwwIT09YSYmKHVbMTldPWEsaS5sZW5ndGgrKyksaX07ZnVuY3Rpb24geSh0LGUsaSl7aS5uZWdhdGl2ZT1lLm5lZ2F0aXZlXnQubmVnYXRpdmUsaS5sZW5ndGg9dC5sZW5ndGgrZS5sZW5ndGg7Zm9yKHZhciByPTAsbj0wLG89MDtvPGkubGVuZ3RoLTE7bysrKXt2YXIgcz1uO249MDtmb3IodmFyIGg9NjcxMDg4NjMmcix1PU1hdGgubWluKG8sZS5sZW5ndGgtMSksYT1NYXRoLm1heCgwLG8tdC5sZW5ndGgrMSk7YTw9dTthKyspe3ZhciBsPW8tYSxmPSgwfHQud29yZHNbbF0pKigwfGUud29yZHNbYV0pLGM9NjcxMDg4NjMmZjtoPTY3MTA4ODYzJihjPWMraHwwKSxuKz0ocz0ocz1zKyhmLzY3MTA4ODY0fDApfDApKyhjPj4+MjYpfDApPj4+MjYscyY9NjcxMDg4NjN9aS53b3Jkc1tvXT1oLHI9cyxzPW59cmV0dXJuIDAhPT1yP2kud29yZHNbb109cjppLmxlbmd0aC0tLGkuX3N0cmlwKCl9ZnVuY3Rpb24gdyh0LGUsaSl7cmV0dXJuIHkodCxlLGkpfWZ1bmN0aW9uIHYodCxlKXt0aGlzLng9dCx0aGlzLnk9ZX1NYXRoLmltdWx8fChnPWQpLG8ucHJvdG90eXBlLm11bFRvPWZ1bmN0aW9uKHQsZSl7dmFyIGk9dGhpcy5sZW5ndGgrdC5sZW5ndGg7cmV0dXJuIDEwPT09dGhpcy5sZW5ndGgmJjEwPT09dC5sZW5ndGg/Zyh0aGlzLHQsZSk6aTw2Mz9kKHRoaXMsdCxlKTppPDEwMjQ/eSh0aGlzLHQsZSk6dyh0aGlzLHQsZSl9LHYucHJvdG90eXBlLm1ha2VSQlQ9ZnVuY3Rpb24odCl7Zm9yKHZhciBlPW5ldyBBcnJheSh0KSxpPW8ucHJvdG90eXBlLl9jb3VudEJpdHModCktMSxyPTA7cjx0O3IrKyllW3JdPXRoaXMucmV2QmluKHIsaSx0KTtyZXR1cm4gZX0sdi5wcm90b3R5cGUucmV2QmluPWZ1bmN0aW9uKHQsZSxpKXtpZigwPT09dHx8dD09PWktMSlyZXR1cm4gdDtmb3IodmFyIHI9MCxuPTA7bjxlO24rKylyfD0oMSZ0KTw8ZS1uLTEsdD4+PTE7cmV0dXJuIHJ9LHYucHJvdG90eXBlLnBlcm11dGU9ZnVuY3Rpb24odCxlLGkscixuLG8pe2Zvcih2YXIgcz0wO3M8bztzKyspcltzXT1lW3Rbc11dLG5bc109aVt0W3NdXX0sdi5wcm90b3R5cGUudHJhbnNmb3JtPWZ1bmN0aW9uKHQsZSxpLHIsbixvKXt0aGlzLnBlcm11dGUobyx0LGUsaSxyLG4pO2Zvcih2YXIgcz0xO3M8bjtzPDw9MSlmb3IodmFyIGg9czw8MSx1PU1hdGguY29zKDIqTWF0aC5QSS9oKSxhPU1hdGguc2luKDIqTWF0aC5QSS9oKSxsPTA7bDxuO2wrPWgpZm9yKHZhciBmPXUsYz1hLHA9MDtwPHM7cCsrKXt2YXIgbT1pW2wrcF0sZD1yW2wrcF0sZz1pW2wrcCtzXSx5PXJbbCtwK3NdLHc9ZipnLWMqeTt5PWYqeStjKmcsZz13LGlbbCtwXT1tK2cscltsK3BdPWQreSxpW2wrcCtzXT1tLWcscltsK3Arc109ZC15LHAhPT1oJiYodz11KmYtYSpjLGM9dSpjK2EqZixmPXcpfX0sdi5wcm90b3R5cGUuZ3Vlc3NMZW4xM2I9ZnVuY3Rpb24odCxlKXt2YXIgaT0xfE1hdGgubWF4KGUsdCkscj0xJmksbj0wO2ZvcihpPWkvMnwwO2k7aT4+Pj0xKW4rKztyZXR1cm4gMTw8bisxK3J9LHYucHJvdG90eXBlLmNvbmp1Z2F0ZT1mdW5jdGlvbih0LGUsaSl7aWYoIShpPD0xKSlmb3IodmFyIHI9MDtyPGkvMjtyKyspe3ZhciBuPXRbcl07dFtyXT10W2ktci0xXSx0W2ktci0xXT1uLG49ZVtyXSxlW3JdPS1lW2ktci0xXSxlW2ktci0xXT0tbn19LHYucHJvdG90eXBlLm5vcm1hbGl6ZTEzYj1mdW5jdGlvbih0LGUpe2Zvcih2YXIgaT0wLHI9MDtyPGUvMjtyKyspe3ZhciBuPTgxOTIqTWF0aC5yb3VuZCh0WzIqcisxXS9lKStNYXRoLnJvdW5kKHRbMipyXS9lKStpO3Rbcl09NjcxMDg4NjMmbixpPW48NjcxMDg4NjQ/MDpuLzY3MTA4ODY0fDB9cmV0dXJuIHR9LHYucHJvdG90eXBlLmNvbnZlcnQxM2I9ZnVuY3Rpb24odCxlLGksbil7Zm9yKHZhciBvPTAscz0wO3M8ZTtzKyspbys9MHx0W3NdLGlbMipzXT04MTkxJm8sbz4+Pj0xMyxpWzIqcysxXT04MTkxJm8sbz4+Pj0xMztmb3Iocz0yKmU7czxuOysrcylpW3NdPTA7cigwPT09bykscighKC04MTkyJm8pKX0sdi5wcm90b3R5cGUuc3R1Yj1mdW5jdGlvbih0KXtmb3IodmFyIGU9bmV3IEFycmF5KHQpLGk9MDtpPHQ7aSsrKWVbaV09MDtyZXR1cm4gZX0sdi5wcm90b3R5cGUubXVscD1mdW5jdGlvbih0LGUsaSl7dmFyIHI9Mip0aGlzLmd1ZXNzTGVuMTNiKHQubGVuZ3RoLGUubGVuZ3RoKSxuPXRoaXMubWFrZVJCVChyKSxvPXRoaXMuc3R1YihyKSxzPW5ldyBBcnJheShyKSxoPW5ldyBBcnJheShyKSx1PW5ldyBBcnJheShyKSxhPW5ldyBBcnJheShyKSxsPW5ldyBBcnJheShyKSxmPW5ldyBBcnJheShyKSxjPWkud29yZHM7Yy5sZW5ndGg9cix0aGlzLmNvbnZlcnQxM2IodC53b3Jkcyx0Lmxlbmd0aCxzLHIpLHRoaXMuY29udmVydDEzYihlLndvcmRzLGUubGVuZ3RoLGEsciksdGhpcy50cmFuc2Zvcm0ocyxvLGgsdSxyLG4pLHRoaXMudHJhbnNmb3JtKGEsbyxsLGYscixuKTtmb3IodmFyIHA9MDtwPHI7cCsrKXt2YXIgbT1oW3BdKmxbcF0tdVtwXSpmW3BdO3VbcF09aFtwXSpmW3BdK3VbcF0qbFtwXSxoW3BdPW19cmV0dXJuIHRoaXMuY29uanVnYXRlKGgsdSxyKSx0aGlzLnRyYW5zZm9ybShoLHUsYyxvLHIsbiksdGhpcy5jb25qdWdhdGUoYyxvLHIpLHRoaXMubm9ybWFsaXplMTNiKGMsciksaS5uZWdhdGl2ZT10Lm5lZ2F0aXZlXmUubmVnYXRpdmUsaS5sZW5ndGg9dC5sZW5ndGgrZS5sZW5ndGgsaS5fc3RyaXAoKX0sby5wcm90b3R5cGUubXVsPWZ1bmN0aW9uKHQpe3ZhciBlPW5ldyBvKG51bGwpO3JldHVybiBlLndvcmRzPW5ldyBBcnJheSh0aGlzLmxlbmd0aCt0Lmxlbmd0aCksdGhpcy5tdWxUbyh0LGUpfSxvLnByb3RvdHlwZS5tdWxmPWZ1bmN0aW9uKHQpe3ZhciBlPW5ldyBvKG51bGwpO3JldHVybiBlLndvcmRzPW5ldyBBcnJheSh0aGlzLmxlbmd0aCt0Lmxlbmd0aCksdyh0aGlzLHQsZSl9LG8ucHJvdG90eXBlLmltdWw9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuY2xvbmUoKS5tdWxUbyh0LHRoaXMpfSxvLnByb3RvdHlwZS5pbXVsbj1mdW5jdGlvbih0KXt2YXIgZT10PDA7ZSYmKHQ9LXQpLHIoIm51bWJlciI9PXR5cGVvZiB0KSxyKHQ8NjcxMDg4NjQpO2Zvcih2YXIgaT0wLG49MDtuPHRoaXMubGVuZ3RoO24rKyl7dmFyIG89KDB8dGhpcy53b3Jkc1tuXSkqdCxzPSg2NzEwODg2MyZvKSsoNjcxMDg4NjMmaSk7aT4+PTI2LGkrPW8vNjcxMDg4NjR8MCxpKz1zPj4+MjYsdGhpcy53b3Jkc1tuXT02NzEwODg2MyZzfXJldHVybiAwIT09aSYmKHRoaXMud29yZHNbbl09aSx0aGlzLmxlbmd0aCsrKSx0aGlzLmxlbmd0aD0wPT09dD8xOnRoaXMubGVuZ3RoLGU/dGhpcy5pbmVnKCk6dGhpc30sby5wcm90b3R5cGUubXVsbj1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5jbG9uZSgpLmltdWxuKHQpfSxvLnByb3RvdHlwZS5zcXI9ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5tdWwodGhpcyl9LG8ucHJvdG90eXBlLmlzcXI9ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5pbXVsKHRoaXMuY2xvbmUoKSl9LG8ucHJvdG90eXBlLnBvdz1mdW5jdGlvbih0KXt2YXIgZT1mdW5jdGlvbih0KXtmb3IodmFyIGU9bmV3IEFycmF5KHQuYml0TGVuZ3RoKCkpLGk9MDtpPGUubGVuZ3RoO2krKyl7dmFyIHI9aS8yNnwwLG49aSUyNjtlW2ldPXQud29yZHNbcl0+Pj5uJjF9cmV0dXJuIGV9KHQpO2lmKDA9PT1lLmxlbmd0aClyZXR1cm4gbmV3IG8oMSk7Zm9yKHZhciBpPXRoaXMscj0wO3I8ZS5sZW5ndGgmJjA9PT1lW3JdO3IrKyxpPWkuc3FyKCkpO2lmKCsrcjxlLmxlbmd0aClmb3IodmFyIG49aS5zcXIoKTtyPGUubGVuZ3RoO3IrKyxuPW4uc3FyKCkpMCE9PWVbcl0mJihpPWkubXVsKG4pKTtyZXR1cm4gaX0sby5wcm90b3R5cGUuaXVzaGxuPWZ1bmN0aW9uKHQpe3IoIm51bWJlciI9PXR5cGVvZiB0JiZ0Pj0wKTt2YXIgZSxpPXQlMjYsbj0odC1pKS8yNixvPTY3MTA4ODYzPj4+MjYtaTw8MjYtaTtpZigwIT09aSl7dmFyIHM9MDtmb3IoZT0wO2U8dGhpcy5sZW5ndGg7ZSsrKXt2YXIgaD10aGlzLndvcmRzW2VdJm8sdT0oMHx0aGlzLndvcmRzW2VdKS1oPDxpO3RoaXMud29yZHNbZV09dXxzLHM9aD4+PjI2LWl9cyYmKHRoaXMud29yZHNbZV09cyx0aGlzLmxlbmd0aCsrKX1pZigwIT09bil7Zm9yKGU9dGhpcy5sZW5ndGgtMTtlPj0wO2UtLSl0aGlzLndvcmRzW2Urbl09dGhpcy53b3Jkc1tlXTtmb3IoZT0wO2U8bjtlKyspdGhpcy53b3Jkc1tlXT0wO3RoaXMubGVuZ3RoKz1ufXJldHVybiB0aGlzLl9zdHJpcCgpfSxvLnByb3RvdHlwZS5pc2hsbj1mdW5jdGlvbih0KXtyZXR1cm4gcigwPT09dGhpcy5uZWdhdGl2ZSksdGhpcy5pdXNobG4odCl9LG8ucHJvdG90eXBlLml1c2hybj1mdW5jdGlvbih0LGUsaSl7dmFyIG47cigibnVtYmVyIj09dHlwZW9mIHQmJnQ+PTApLG49ZT8oZS1lJTI2KS8yNjowO3ZhciBvPXQlMjYscz1NYXRoLm1pbigodC1vKS8yNix0aGlzLmxlbmd0aCksaD02NzEwODg2M142NzEwODg2Mz4+Pm88PG8sdT1pO2lmKG4tPXMsbj1NYXRoLm1heCgwLG4pLHUpe2Zvcih2YXIgYT0wO2E8czthKyspdS53b3Jkc1thXT10aGlzLndvcmRzW2FdO3UubGVuZ3RoPXN9aWYoMD09PXMpO2Vsc2UgaWYodGhpcy5sZW5ndGg+cylmb3IodGhpcy5sZW5ndGgtPXMsYT0wO2E8dGhpcy5sZW5ndGg7YSsrKXRoaXMud29yZHNbYV09dGhpcy53b3Jkc1thK3NdO2Vsc2UgdGhpcy53b3Jkc1swXT0wLHRoaXMubGVuZ3RoPTE7dmFyIGw9MDtmb3IoYT10aGlzLmxlbmd0aC0xO2E+PTAmJigwIT09bHx8YT49bik7YS0tKXt2YXIgZj0wfHRoaXMud29yZHNbYV07dGhpcy53b3Jkc1thXT1sPDwyNi1vfGY+Pj5vLGw9ZiZofXJldHVybiB1JiYwIT09bCYmKHUud29yZHNbdS5sZW5ndGgrK109bCksMD09PXRoaXMubGVuZ3RoJiYodGhpcy53b3Jkc1swXT0wLHRoaXMubGVuZ3RoPTEpLHRoaXMuX3N0cmlwKCl9LG8ucHJvdG90eXBlLmlzaHJuPWZ1bmN0aW9uKHQsZSxpKXtyZXR1cm4gcigwPT09dGhpcy5uZWdhdGl2ZSksdGhpcy5pdXNocm4odCxlLGkpfSxvLnByb3RvdHlwZS5zaGxuPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNsb25lKCkuaXNobG4odCl9LG8ucHJvdG90eXBlLnVzaGxuPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNsb25lKCkuaXVzaGxuKHQpfSxvLnByb3RvdHlwZS5zaHJuPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNsb25lKCkuaXNocm4odCl9LG8ucHJvdG90eXBlLnVzaHJuPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNsb25lKCkuaXVzaHJuKHQpfSxvLnByb3RvdHlwZS50ZXN0bj1mdW5jdGlvbih0KXtyKCJudW1iZXIiPT10eXBlb2YgdCYmdD49MCk7dmFyIGU9dCUyNixpPSh0LWUpLzI2LG49MTw8ZTtyZXR1cm4hKHRoaXMubGVuZ3RoPD1pfHwhKHRoaXMud29yZHNbaV0mbikpfSxvLnByb3RvdHlwZS5pbWFza249ZnVuY3Rpb24odCl7cigibnVtYmVyIj09dHlwZW9mIHQmJnQ+PTApO3ZhciBlPXQlMjYsaT0odC1lKS8yNjtpZihyKDA9PT10aGlzLm5lZ2F0aXZlLCJpbWFza24gd29ya3Mgb25seSB3aXRoIHBvc2l0aXZlIG51bWJlcnMiKSx0aGlzLmxlbmd0aDw9aSlyZXR1cm4gdGhpcztpZigwIT09ZSYmaSsrLHRoaXMubGVuZ3RoPU1hdGgubWluKGksdGhpcy5sZW5ndGgpLDAhPT1lKXt2YXIgbj02NzEwODg2M142NzEwODg2Mz4+PmU8PGU7dGhpcy53b3Jkc1t0aGlzLmxlbmd0aC0xXSY9bn1yZXR1cm4gdGhpcy5fc3RyaXAoKX0sby5wcm90b3R5cGUubWFza249ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuY2xvbmUoKS5pbWFza24odCl9LG8ucHJvdG90eXBlLmlhZGRuPWZ1bmN0aW9uKHQpe3JldHVybiByKCJudW1iZXIiPT10eXBlb2YgdCkscih0PDY3MTA4ODY0KSx0PDA/dGhpcy5pc3VibigtdCk6MCE9PXRoaXMubmVnYXRpdmU/MT09PXRoaXMubGVuZ3RoJiYoMHx0aGlzLndvcmRzWzBdKTw9dD8odGhpcy53b3Jkc1swXT10LSgwfHRoaXMud29yZHNbMF0pLHRoaXMubmVnYXRpdmU9MCx0aGlzKToodGhpcy5uZWdhdGl2ZT0wLHRoaXMuaXN1Ym4odCksdGhpcy5uZWdhdGl2ZT0xLHRoaXMpOnRoaXMuX2lhZGRuKHQpfSxvLnByb3RvdHlwZS5faWFkZG49ZnVuY3Rpb24odCl7dGhpcy53b3Jkc1swXSs9dDtmb3IodmFyIGU9MDtlPHRoaXMubGVuZ3RoJiZ0aGlzLndvcmRzW2VdPj02NzEwODg2NDtlKyspdGhpcy53b3Jkc1tlXS09NjcxMDg4NjQsZT09PXRoaXMubGVuZ3RoLTE/dGhpcy53b3Jkc1tlKzFdPTE6dGhpcy53b3Jkc1tlKzFdKys7cmV0dXJuIHRoaXMubGVuZ3RoPU1hdGgubWF4KHRoaXMubGVuZ3RoLGUrMSksdGhpc30sby5wcm90b3R5cGUuaXN1Ym49ZnVuY3Rpb24odCl7aWYocigibnVtYmVyIj09dHlwZW9mIHQpLHIodDw2NzEwODg2NCksdDwwKXJldHVybiB0aGlzLmlhZGRuKC10KTtpZigwIT09dGhpcy5uZWdhdGl2ZSlyZXR1cm4gdGhpcy5uZWdhdGl2ZT0wLHRoaXMuaWFkZG4odCksdGhpcy5uZWdhdGl2ZT0xLHRoaXM7aWYodGhpcy53b3Jkc1swXS09dCwxPT09dGhpcy5sZW5ndGgmJnRoaXMud29yZHNbMF08MCl0aGlzLndvcmRzWzBdPS10aGlzLndvcmRzWzBdLHRoaXMubmVnYXRpdmU9MTtlbHNlIGZvcih2YXIgZT0wO2U8dGhpcy5sZW5ndGgmJnRoaXMud29yZHNbZV08MDtlKyspdGhpcy53b3Jkc1tlXSs9NjcxMDg4NjQsdGhpcy53b3Jkc1tlKzFdLT0xO3JldHVybiB0aGlzLl9zdHJpcCgpfSxvLnByb3RvdHlwZS5hZGRuPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNsb25lKCkuaWFkZG4odCl9LG8ucHJvdG90eXBlLnN1Ym49ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuY2xvbmUoKS5pc3Vibih0KX0sby5wcm90b3R5cGUuaWFicz1mdW5jdGlvbigpe3JldHVybiB0aGlzLm5lZ2F0aXZlPTAsdGhpc30sby5wcm90b3R5cGUuYWJzPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuY2xvbmUoKS5pYWJzKCl9LG8ucHJvdG90eXBlLl9pc2hsbnN1Ym11bD1mdW5jdGlvbih0LGUsaSl7dmFyIG4sbyxzPXQubGVuZ3RoK2k7dGhpcy5fZXhwYW5kKHMpO3ZhciBoPTA7Zm9yKG49MDtuPHQubGVuZ3RoO24rKyl7bz0oMHx0aGlzLndvcmRzW24raV0pK2g7dmFyIHU9KDB8dC53b3Jkc1tuXSkqZTtoPSgoby09NjcxMDg4NjMmdSk+PjI2KS0odS82NzEwODg2NHwwKSx0aGlzLndvcmRzW24raV09NjcxMDg4NjMmb31mb3IoO248dGhpcy5sZW5ndGgtaTtuKyspaD0obz0oMHx0aGlzLndvcmRzW24raV0pK2gpPj4yNix0aGlzLndvcmRzW24raV09NjcxMDg4NjMmbztpZigwPT09aClyZXR1cm4gdGhpcy5fc3RyaXAoKTtmb3IocigtMT09PWgpLGg9MCxuPTA7bjx0aGlzLmxlbmd0aDtuKyspaD0obz0tKDB8dGhpcy53b3Jkc1tuXSkraCk+PjI2LHRoaXMud29yZHNbbl09NjcxMDg4NjMmbztyZXR1cm4gdGhpcy5uZWdhdGl2ZT0xLHRoaXMuX3N0cmlwKCl9LG8ucHJvdG90eXBlLl93b3JkRGl2PWZ1bmN0aW9uKHQsZSl7dmFyIGk9KHRoaXMubGVuZ3RoLHQubGVuZ3RoKSxyPXRoaXMuY2xvbmUoKSxuPXQscz0wfG4ud29yZHNbbi5sZW5ndGgtMV07MCE9KGk9MjYtdGhpcy5fY291bnRCaXRzKHMpKSYmKG49bi51c2hsbihpKSxyLml1c2hsbihpKSxzPTB8bi53b3Jkc1tuLmxlbmd0aC0xXSk7dmFyIGgsdT1yLmxlbmd0aC1uLmxlbmd0aDtpZigibW9kIiE9PWUpeyhoPW5ldyBvKG51bGwpKS5sZW5ndGg9dSsxLGgud29yZHM9bmV3IEFycmF5KGgubGVuZ3RoKTtmb3IodmFyIGE9MDthPGgubGVuZ3RoO2ErKyloLndvcmRzW2FdPTB9dmFyIGw9ci5jbG9uZSgpLl9pc2hsbnN1Ym11bChuLDEsdSk7MD09PWwubmVnYXRpdmUmJihyPWwsaCYmKGgud29yZHNbdV09MSkpO2Zvcih2YXIgZj11LTE7Zj49MDtmLS0pe3ZhciBjPTY3MTA4ODY0KigwfHIud29yZHNbbi5sZW5ndGgrZl0pKygwfHIud29yZHNbbi5sZW5ndGgrZi0xXSk7Zm9yKGM9TWF0aC5taW4oYy9zfDAsNjcxMDg4NjMpLHIuX2lzaGxuc3VibXVsKG4sYyxmKTswIT09ci5uZWdhdGl2ZTspYy0tLHIubmVnYXRpdmU9MCxyLl9pc2hsbnN1Ym11bChuLDEsZiksci5pc1plcm8oKXx8KHIubmVnYXRpdmVePTEpO2gmJihoLndvcmRzW2ZdPWMpfXJldHVybiBoJiZoLl9zdHJpcCgpLHIuX3N0cmlwKCksImRpdiIhPT1lJiYwIT09aSYmci5pdXNocm4oaSkse2RpdjpofHxudWxsLG1vZDpyfX0sby5wcm90b3R5cGUuZGl2bW9kPWZ1bmN0aW9uKHQsZSxpKXtyZXR1cm4gcighdC5pc1plcm8oKSksdGhpcy5pc1plcm8oKT97ZGl2Om5ldyBvKDApLG1vZDpuZXcgbygwKX06MCE9PXRoaXMubmVnYXRpdmUmJjA9PT10Lm5lZ2F0aXZlPyhoPXRoaXMubmVnKCkuZGl2bW9kKHQsZSksIm1vZCIhPT1lJiYobj1oLmRpdi5uZWcoKSksImRpdiIhPT1lJiYocz1oLm1vZC5uZWcoKSxpJiYwIT09cy5uZWdhdGl2ZSYmcy5pYWRkKHQpKSx7ZGl2Om4sbW9kOnN9KTowPT09dGhpcy5uZWdhdGl2ZSYmMCE9PXQubmVnYXRpdmU/KGg9dGhpcy5kaXZtb2QodC5uZWcoKSxlKSwibW9kIiE9PWUmJihuPWguZGl2Lm5lZygpKSx7ZGl2Om4sbW9kOmgubW9kfSk6dGhpcy5uZWdhdGl2ZSZ0Lm5lZ2F0aXZlPyhoPXRoaXMubmVnKCkuZGl2bW9kKHQubmVnKCksZSksImRpdiIhPT1lJiYocz1oLm1vZC5uZWcoKSxpJiYwIT09cy5uZWdhdGl2ZSYmcy5pc3ViKHQpKSx7ZGl2OmguZGl2LG1vZDpzfSk6dC5sZW5ndGg+dGhpcy5sZW5ndGh8fHRoaXMuY21wKHQpPDA/e2RpdjpuZXcgbygwKSxtb2Q6dGhpc306MT09PXQubGVuZ3RoPyJkaXYiPT09ZT97ZGl2OnRoaXMuZGl2bih0LndvcmRzWzBdKSxtb2Q6bnVsbH06Im1vZCI9PT1lP3tkaXY6bnVsbCxtb2Q6bmV3IG8odGhpcy5tb2Rybih0LndvcmRzWzBdKSl9OntkaXY6dGhpcy5kaXZuKHQud29yZHNbMF0pLG1vZDpuZXcgbyh0aGlzLm1vZHJuKHQud29yZHNbMF0pKX06dGhpcy5fd29yZERpdih0LGUpO3ZhciBuLHMsaH0sby5wcm90b3R5cGUuZGl2PWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmRpdm1vZCh0LCJkaXYiLCExKS5kaXZ9LG8ucHJvdG90eXBlLm1vZD1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5kaXZtb2QodCwibW9kIiwhMSkubW9kfSxvLnByb3RvdHlwZS51bW9kPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmRpdm1vZCh0LCJtb2QiLCEwKS5tb2R9LG8ucHJvdG90eXBlLmRpdlJvdW5kPWZ1bmN0aW9uKHQpe3ZhciBlPXRoaXMuZGl2bW9kKHQpO2lmKGUubW9kLmlzWmVybygpKXJldHVybiBlLmRpdjt2YXIgaT0wIT09ZS5kaXYubmVnYXRpdmU/ZS5tb2QuaXN1Yih0KTplLm1vZCxyPXQudXNocm4oMSksbj10LmFuZGxuKDEpLG89aS5jbXAocik7cmV0dXJuIG88MHx8MT09PW4mJjA9PT1vP2UuZGl2OjAhPT1lLmRpdi5uZWdhdGl2ZT9lLmRpdi5pc3VibigxKTplLmRpdi5pYWRkbigxKX0sby5wcm90b3R5cGUubW9kcm49ZnVuY3Rpb24odCl7dmFyIGU9dDwwO2UmJih0PS10KSxyKHQ8PTY3MTA4ODYzKTtmb3IodmFyIGk9KDE8PDI2KSV0LG49MCxvPXRoaXMubGVuZ3RoLTE7bz49MDtvLS0pbj0oaSpuKygwfHRoaXMud29yZHNbb10pKSV0O3JldHVybiBlPy1uOm59LG8ucHJvdG90eXBlLm1vZG49ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMubW9kcm4odCl9LG8ucHJvdG90eXBlLmlkaXZuPWZ1bmN0aW9uKHQpe3ZhciBlPXQ8MDtlJiYodD0tdCkscih0PD02NzEwODg2Myk7Zm9yKHZhciBpPTAsbj10aGlzLmxlbmd0aC0xO24+PTA7bi0tKXt2YXIgbz0oMHx0aGlzLndvcmRzW25dKSs2NzEwODg2NCppO3RoaXMud29yZHNbbl09by90fDAsaT1vJXR9cmV0dXJuIHRoaXMuX3N0cmlwKCksZT90aGlzLmluZWcoKTp0aGlzfSxvLnByb3RvdHlwZS5kaXZuPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNsb25lKCkuaWRpdm4odCl9LG8ucHJvdG90eXBlLmVnY2Q9ZnVuY3Rpb24odCl7cigwPT09dC5uZWdhdGl2ZSkscighdC5pc1plcm8oKSk7dmFyIGU9dGhpcyxpPXQuY2xvbmUoKTtlPTAhPT1lLm5lZ2F0aXZlP2UudW1vZCh0KTplLmNsb25lKCk7Zm9yKHZhciBuPW5ldyBvKDEpLHM9bmV3IG8oMCksaD1uZXcgbygwKSx1PW5ldyBvKDEpLGE9MDtlLmlzRXZlbigpJiZpLmlzRXZlbigpOyllLml1c2hybigxKSxpLml1c2hybigxKSwrK2E7Zm9yKHZhciBsPWkuY2xvbmUoKSxmPWUuY2xvbmUoKTshZS5pc1plcm8oKTspe2Zvcih2YXIgYz0wLHA9MTshKGUud29yZHNbMF0mcCkmJmM8MjY7KytjLHA8PD0xKTtpZihjPjApZm9yKGUuaXVzaHJuKGMpO2MtLSA+MDspKG4uaXNPZGQoKXx8cy5pc09kZCgpKSYmKG4uaWFkZChsKSxzLmlzdWIoZikpLG4uaXVzaHJuKDEpLHMuaXVzaHJuKDEpO2Zvcih2YXIgbT0wLGQ9MTshKGkud29yZHNbMF0mZCkmJm08MjY7KyttLGQ8PD0xKTtpZihtPjApZm9yKGkuaXVzaHJuKG0pO20tLSA+MDspKGguaXNPZGQoKXx8dS5pc09kZCgpKSYmKGguaWFkZChsKSx1LmlzdWIoZikpLGguaXVzaHJuKDEpLHUuaXVzaHJuKDEpO2UuY21wKGkpPj0wPyhlLmlzdWIoaSksbi5pc3ViKGgpLHMuaXN1Yih1KSk6KGkuaXN1YihlKSxoLmlzdWIobiksdS5pc3ViKHMpKX1yZXR1cm57YTpoLGI6dSxnY2Q6aS5pdXNobG4oYSl9fSxvLnByb3RvdHlwZS5faW52bXA9ZnVuY3Rpb24odCl7cigwPT09dC5uZWdhdGl2ZSkscighdC5pc1plcm8oKSk7dmFyIGU9dGhpcyxpPXQuY2xvbmUoKTtlPTAhPT1lLm5lZ2F0aXZlP2UudW1vZCh0KTplLmNsb25lKCk7Zm9yKHZhciBuLHM9bmV3IG8oMSksaD1uZXcgbygwKSx1PWkuY2xvbmUoKTtlLmNtcG4oMSk+MCYmaS5jbXBuKDEpPjA7KXtmb3IodmFyIGE9MCxsPTE7IShlLndvcmRzWzBdJmwpJiZhPDI2OysrYSxsPDw9MSk7aWYoYT4wKWZvcihlLml1c2hybihhKTthLS0gPjA7KXMuaXNPZGQoKSYmcy5pYWRkKHUpLHMuaXVzaHJuKDEpO2Zvcih2YXIgZj0wLGM9MTshKGkud29yZHNbMF0mYykmJmY8MjY7KytmLGM8PD0xKTtpZihmPjApZm9yKGkuaXVzaHJuKGYpO2YtLSA+MDspaC5pc09kZCgpJiZoLmlhZGQodSksaC5pdXNocm4oMSk7ZS5jbXAoaSk+PTA/KGUuaXN1YihpKSxzLmlzdWIoaCkpOihpLmlzdWIoZSksaC5pc3ViKHMpKX1yZXR1cm4obj0wPT09ZS5jbXBuKDEpP3M6aCkuY21wbigwKTwwJiZuLmlhZGQodCksbn0sby5wcm90b3R5cGUuZ2NkPWZ1bmN0aW9uKHQpe2lmKHRoaXMuaXNaZXJvKCkpcmV0dXJuIHQuYWJzKCk7aWYodC5pc1plcm8oKSlyZXR1cm4gdGhpcy5hYnMoKTt2YXIgZT10aGlzLmNsb25lKCksaT10LmNsb25lKCk7ZS5uZWdhdGl2ZT0wLGkubmVnYXRpdmU9MDtmb3IodmFyIHI9MDtlLmlzRXZlbigpJiZpLmlzRXZlbigpO3IrKyllLml1c2hybigxKSxpLml1c2hybigxKTtmb3IoOzspe2Zvcig7ZS5pc0V2ZW4oKTspZS5pdXNocm4oMSk7Zm9yKDtpLmlzRXZlbigpOylpLml1c2hybigxKTt2YXIgbj1lLmNtcChpKTtpZihuPDApe3ZhciBvPWU7ZT1pLGk9b31lbHNlIGlmKDA9PT1ufHwwPT09aS5jbXBuKDEpKWJyZWFrO2UuaXN1YihpKX1yZXR1cm4gaS5pdXNobG4ocil9LG8ucHJvdG90eXBlLmludm09ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuZWdjZCh0KS5hLnVtb2QodCl9LG8ucHJvdG90eXBlLmlzRXZlbj1mdW5jdGlvbigpe3JldHVybiEoMSZ0aGlzLndvcmRzWzBdKX0sby5wcm90b3R5cGUuaXNPZGQ9ZnVuY3Rpb24oKXtyZXR1cm4hKDEmfnRoaXMud29yZHNbMF0pfSxvLnByb3RvdHlwZS5hbmRsbj1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy53b3Jkc1swXSZ0fSxvLnByb3RvdHlwZS5iaW5jbj1mdW5jdGlvbih0KXtyKCJudW1iZXIiPT10eXBlb2YgdCk7dmFyIGU9dCUyNixpPSh0LWUpLzI2LG49MTw8ZTtpZih0aGlzLmxlbmd0aDw9aSlyZXR1cm4gdGhpcy5fZXhwYW5kKGkrMSksdGhpcy53b3Jkc1tpXXw9bix0aGlzO2Zvcih2YXIgbz1uLHM9aTswIT09byYmczx0aGlzLmxlbmd0aDtzKyspe3ZhciBoPTB8dGhpcy53b3Jkc1tzXTtvPShoKz1vKT4+PjI2LGgmPTY3MTA4ODYzLHRoaXMud29yZHNbc109aH1yZXR1cm4gMCE9PW8mJih0aGlzLndvcmRzW3NdPW8sdGhpcy5sZW5ndGgrKyksdGhpc30sby5wcm90b3R5cGUuaXNaZXJvPWZ1bmN0aW9uKCl7cmV0dXJuIDE9PT10aGlzLmxlbmd0aCYmMD09PXRoaXMud29yZHNbMF19LG8ucHJvdG90eXBlLmNtcG49ZnVuY3Rpb24odCl7dmFyIGUsaT10PDA7aWYoMCE9PXRoaXMubmVnYXRpdmUmJiFpKXJldHVybi0xO2lmKDA9PT10aGlzLm5lZ2F0aXZlJiZpKXJldHVybiAxO2lmKHRoaXMuX3N0cmlwKCksdGhpcy5sZW5ndGg+MSllPTE7ZWxzZXtpJiYodD0tdCkscih0PD02NzEwODg2MywiTnVtYmVyIGlzIHRvbyBiaWciKTt2YXIgbj0wfHRoaXMud29yZHNbMF07ZT1uPT09dD8wOm48dD8tMToxfXJldHVybiAwIT09dGhpcy5uZWdhdGl2ZT8wfC1lOmV9LG8ucHJvdG90eXBlLmNtcD1mdW5jdGlvbih0KXtpZigwIT09dGhpcy5uZWdhdGl2ZSYmMD09PXQubmVnYXRpdmUpcmV0dXJuLTE7aWYoMD09PXRoaXMubmVnYXRpdmUmJjAhPT10Lm5lZ2F0aXZlKXJldHVybiAxO3ZhciBlPXRoaXMudWNtcCh0KTtyZXR1cm4gMCE9PXRoaXMubmVnYXRpdmU/MHwtZTplfSxvLnByb3RvdHlwZS51Y21wPWZ1bmN0aW9uKHQpe2lmKHRoaXMubGVuZ3RoPnQubGVuZ3RoKXJldHVybiAxO2lmKHRoaXMubGVuZ3RoPHQubGVuZ3RoKXJldHVybi0xO2Zvcih2YXIgZT0wLGk9dGhpcy5sZW5ndGgtMTtpPj0wO2ktLSl7dmFyIHI9MHx0aGlzLndvcmRzW2ldLG49MHx0LndvcmRzW2ldO2lmKHIhPT1uKXtyPG4/ZT0tMTpyPm4mJihlPTEpO2JyZWFrfX1yZXR1cm4gZX0sby5wcm90b3R5cGUuZ3RuPWZ1bmN0aW9uKHQpe3JldHVybiAxPT09dGhpcy5jbXBuKHQpfSxvLnByb3RvdHlwZS5ndD1mdW5jdGlvbih0KXtyZXR1cm4gMT09PXRoaXMuY21wKHQpfSxvLnByb3RvdHlwZS5ndGVuPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmNtcG4odCk+PTB9LG8ucHJvdG90eXBlLmd0ZT1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5jbXAodCk+PTB9LG8ucHJvdG90eXBlLmx0bj1mdW5jdGlvbih0KXtyZXR1cm4tMT09PXRoaXMuY21wbih0KX0sby5wcm90b3R5cGUubHQ9ZnVuY3Rpb24odCl7cmV0dXJuLTE9PT10aGlzLmNtcCh0KX0sby5wcm90b3R5cGUubHRlbj1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5jbXBuKHQpPD0wfSxvLnByb3RvdHlwZS5sdGU9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuY21wKHQpPD0wfSxvLnByb3RvdHlwZS5lcW49ZnVuY3Rpb24odCl7cmV0dXJuIDA9PT10aGlzLmNtcG4odCl9LG8ucHJvdG90eXBlLmVxPWZ1bmN0aW9uKHQpe3JldHVybiAwPT09dGhpcy5jbXAodCl9LG8ucmVkPWZ1bmN0aW9uKHQpe3JldHVybiBuZXcgXyh0KX0sby5wcm90b3R5cGUudG9SZWQ9ZnVuY3Rpb24odCl7cmV0dXJuIHIoIXRoaXMucmVkLCJBbHJlYWR5IGEgbnVtYmVyIGluIHJlZHVjdGlvbiBjb250ZXh0IikscigwPT09dGhpcy5uZWdhdGl2ZSwicmVkIHdvcmtzIG9ubHkgd2l0aCBwb3NpdGl2ZXMiKSx0LmNvbnZlcnRUbyh0aGlzKS5fZm9yY2VSZWQodCl9LG8ucHJvdG90eXBlLmZyb21SZWQ9ZnVuY3Rpb24oKXtyZXR1cm4gcih0aGlzLnJlZCwiZnJvbVJlZCB3b3JrcyBvbmx5IHdpdGggbnVtYmVycyBpbiByZWR1Y3Rpb24gY29udGV4dCIpLHRoaXMucmVkLmNvbnZlcnRGcm9tKHRoaXMpfSxvLnByb3RvdHlwZS5fZm9yY2VSZWQ9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMucmVkPXQsdGhpc30sby5wcm90b3R5cGUuZm9yY2VSZWQ9ZnVuY3Rpb24odCl7cmV0dXJuIHIoIXRoaXMucmVkLCJBbHJlYWR5IGEgbnVtYmVyIGluIHJlZHVjdGlvbiBjb250ZXh0IiksdGhpcy5fZm9yY2VSZWQodCl9LG8ucHJvdG90eXBlLnJlZEFkZD1mdW5jdGlvbih0KXtyZXR1cm4gcih0aGlzLnJlZCwicmVkQWRkIHdvcmtzIG9ubHkgd2l0aCByZWQgbnVtYmVycyIpLHRoaXMucmVkLmFkZCh0aGlzLHQpfSxvLnByb3RvdHlwZS5yZWRJQWRkPWZ1bmN0aW9uKHQpe3JldHVybiByKHRoaXMucmVkLCJyZWRJQWRkIHdvcmtzIG9ubHkgd2l0aCByZWQgbnVtYmVycyIpLHRoaXMucmVkLmlhZGQodGhpcyx0KX0sby5wcm90b3R5cGUucmVkU3ViPWZ1bmN0aW9uKHQpe3JldHVybiByKHRoaXMucmVkLCJyZWRTdWIgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzIiksdGhpcy5yZWQuc3ViKHRoaXMsdCl9LG8ucHJvdG90eXBlLnJlZElTdWI9ZnVuY3Rpb24odCl7cmV0dXJuIHIodGhpcy5yZWQsInJlZElTdWIgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzIiksdGhpcy5yZWQuaXN1Yih0aGlzLHQpfSxvLnByb3RvdHlwZS5yZWRTaGw9ZnVuY3Rpb24odCl7cmV0dXJuIHIodGhpcy5yZWQsInJlZFNobCB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMiKSx0aGlzLnJlZC5zaGwodGhpcyx0KX0sby5wcm90b3R5cGUucmVkTXVsPWZ1bmN0aW9uKHQpe3JldHVybiByKHRoaXMucmVkLCJyZWRNdWwgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzIiksdGhpcy5yZWQuX3ZlcmlmeTIodGhpcyx0KSx0aGlzLnJlZC5tdWwodGhpcyx0KX0sby5wcm90b3R5cGUucmVkSU11bD1mdW5jdGlvbih0KXtyZXR1cm4gcih0aGlzLnJlZCwicmVkTXVsIHdvcmtzIG9ubHkgd2l0aCByZWQgbnVtYmVycyIpLHRoaXMucmVkLl92ZXJpZnkyKHRoaXMsdCksdGhpcy5yZWQuaW11bCh0aGlzLHQpfSxvLnByb3RvdHlwZS5yZWRTcXI9ZnVuY3Rpb24oKXtyZXR1cm4gcih0aGlzLnJlZCwicmVkU3FyIHdvcmtzIG9ubHkgd2l0aCByZWQgbnVtYmVycyIpLHRoaXMucmVkLl92ZXJpZnkxKHRoaXMpLHRoaXMucmVkLnNxcih0aGlzKX0sby5wcm90b3R5cGUucmVkSVNxcj1mdW5jdGlvbigpe3JldHVybiByKHRoaXMucmVkLCJyZWRJU3FyIHdvcmtzIG9ubHkgd2l0aCByZWQgbnVtYmVycyIpLHRoaXMucmVkLl92ZXJpZnkxKHRoaXMpLHRoaXMucmVkLmlzcXIodGhpcyl9LG8ucHJvdG90eXBlLnJlZFNxcnQ9ZnVuY3Rpb24oKXtyZXR1cm4gcih0aGlzLnJlZCwicmVkU3FydCB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMiKSx0aGlzLnJlZC5fdmVyaWZ5MSh0aGlzKSx0aGlzLnJlZC5zcXJ0KHRoaXMpfSxvLnByb3RvdHlwZS5yZWRJbnZtPWZ1bmN0aW9uKCl7cmV0dXJuIHIodGhpcy5yZWQsInJlZEludm0gd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzIiksdGhpcy5yZWQuX3ZlcmlmeTEodGhpcyksdGhpcy5yZWQuaW52bSh0aGlzKX0sby5wcm90b3R5cGUucmVkTmVnPWZ1bmN0aW9uKCl7cmV0dXJuIHIodGhpcy5yZWQsInJlZE5lZyB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMiKSx0aGlzLnJlZC5fdmVyaWZ5MSh0aGlzKSx0aGlzLnJlZC5uZWcodGhpcyl9LG8ucHJvdG90eXBlLnJlZFBvdz1mdW5jdGlvbih0KXtyZXR1cm4gcih0aGlzLnJlZCYmIXQucmVkLCJyZWRQb3cobm9ybWFsTnVtKSIpLHRoaXMucmVkLl92ZXJpZnkxKHRoaXMpLHRoaXMucmVkLnBvdyh0aGlzLHQpfTt2YXIgTT17azI1NjpudWxsLHAyMjQ6bnVsbCxwMTkyOm51bGwscDI1NTE5Om51bGx9O2Z1bmN0aW9uIGIodCxlKXt0aGlzLm5hbWU9dCx0aGlzLnA9bmV3IG8oZSwxNiksdGhpcy5uPXRoaXMucC5iaXRMZW5ndGgoKSx0aGlzLms9bmV3IG8oMSkuaXVzaGxuKHRoaXMubikuaXN1Yih0aGlzLnApLHRoaXMudG1wPXRoaXMuX3RtcCgpfWZ1bmN0aW9uIEEoKXtiLmNhbGwodGhpcywiazI1NiIsImZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZmIGZmZmZmZmZlIGZmZmZmYzJmIil9ZnVuY3Rpb24gQigpe2IuY2FsbCh0aGlzLCJwMjI0IiwiZmZmZmZmZmYgZmZmZmZmZmYgZmZmZmZmZmYgZmZmZmZmZmYgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDEiKX1mdW5jdGlvbiBFKCl7Yi5jYWxsKHRoaXMsInAxOTIiLCJmZmZmZmZmZiBmZmZmZmZmZiBmZmZmZmZmZiBmZmZmZmZmZSBmZmZmZmZmZiBmZmZmZmZmZiIpfWZ1bmN0aW9uIGsoKXtiLmNhbGwodGhpcywiMjU1MTkiLCI3ZmZmZmZmZmZmZmZmZmZmIGZmZmZmZmZmZmZmZmZmZmYgZmZmZmZmZmZmZmZmZmZmZiBmZmZmZmZmZmZmZmZmZmVkIil9ZnVuY3Rpb24gXyh0KXtpZigic3RyaW5nIj09dHlwZW9mIHQpe3ZhciBlPW8uX3ByaW1lKHQpO3RoaXMubT1lLnAsdGhpcy5wcmltZT1lfWVsc2Ugcih0Lmd0bigxKSwibW9kdWx1cyBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAxIiksdGhpcy5tPXQsdGhpcy5wcmltZT1udWxsfWZ1bmN0aW9uIFQodCl7Xy5jYWxsKHRoaXMsdCksdGhpcy5zaGlmdD10aGlzLm0uYml0TGVuZ3RoKCksdGhpcy5zaGlmdCUyNiE9MCYmKHRoaXMuc2hpZnQrPTI2LXRoaXMuc2hpZnQlMjYpLHRoaXMucj1uZXcgbygxKS5pdXNobG4odGhpcy5zaGlmdCksdGhpcy5yMj10aGlzLmltb2QodGhpcy5yLnNxcigpKSx0aGlzLnJpbnY9dGhpcy5yLl9pbnZtcCh0aGlzLm0pLHRoaXMubWludj10aGlzLnJpbnYubXVsKHRoaXMucikuaXN1Ym4oMSkuZGl2KHRoaXMubSksdGhpcy5taW52PXRoaXMubWludi51bW9kKHRoaXMuciksdGhpcy5taW52PXRoaXMuci5zdWIodGhpcy5taW52KX1iLnByb3RvdHlwZS5fdG1wPWZ1bmN0aW9uKCl7dmFyIHQ9bmV3IG8obnVsbCk7cmV0dXJuIHQud29yZHM9bmV3IEFycmF5KE1hdGguY2VpbCh0aGlzLm4vMTMpKSx0fSxiLnByb3RvdHlwZS5pcmVkdWNlPWZ1bmN0aW9uKHQpe3ZhciBlLGk9dDtkb3t0aGlzLnNwbGl0KGksdGhpcy50bXApLGU9KGk9KGk9dGhpcy5pbXVsSyhpKSkuaWFkZCh0aGlzLnRtcCkpLmJpdExlbmd0aCgpfXdoaWxlKGU+dGhpcy5uKTt2YXIgcj1lPHRoaXMubj8tMTppLnVjbXAodGhpcy5wKTtyZXR1cm4gMD09PXI/KGkud29yZHNbMF09MCxpLmxlbmd0aD0xKTpyPjA/aS5pc3ViKHRoaXMucCk6dm9pZCAwIT09aS5zdHJpcD9pLnN0cmlwKCk6aS5fc3RyaXAoKSxpfSxiLnByb3RvdHlwZS5zcGxpdD1mdW5jdGlvbih0LGUpe3QuaXVzaHJuKHRoaXMubiwwLGUpfSxiLnByb3RvdHlwZS5pbXVsSz1mdW5jdGlvbih0KXtyZXR1cm4gdC5pbXVsKHRoaXMuayl9LG4oQSxiKSxBLnByb3RvdHlwZS5zcGxpdD1mdW5jdGlvbih0LGUpe2Zvcih2YXIgaT00MTk0MzAzLHI9TWF0aC5taW4odC5sZW5ndGgsOSksbj0wO248cjtuKyspZS53b3Jkc1tuXT10LndvcmRzW25dO2lmKGUubGVuZ3RoPXIsdC5sZW5ndGg8PTkpcmV0dXJuIHQud29yZHNbMF09MCx2b2lkKHQubGVuZ3RoPTEpO3ZhciBvPXQud29yZHNbOV07Zm9yKGUud29yZHNbZS5sZW5ndGgrK109byZpLG49MTA7bjx0Lmxlbmd0aDtuKyspe3ZhciBzPTB8dC53b3Jkc1tuXTt0LndvcmRzW24tMTBdPShzJmkpPDw0fG8+Pj4yMixvPXN9bz4+Pj0yMix0LndvcmRzW24tMTBdPW8sMD09PW8mJnQubGVuZ3RoPjEwP3QubGVuZ3RoLT0xMDp0Lmxlbmd0aC09OX0sQS5wcm90b3R5cGUuaW11bEs9ZnVuY3Rpb24odCl7dC53b3Jkc1t0Lmxlbmd0aF09MCx0LndvcmRzW3QubGVuZ3RoKzFdPTAsdC5sZW5ndGgrPTI7Zm9yKHZhciBlPTAsaT0wO2k8dC5sZW5ndGg7aSsrKXt2YXIgcj0wfHQud29yZHNbaV07ZSs9OTc3KnIsdC53b3Jkc1tpXT02NzEwODg2MyZlLGU9NjQqcisoZS82NzEwODg2NHwwKX1yZXR1cm4gMD09PXQud29yZHNbdC5sZW5ndGgtMV0mJih0Lmxlbmd0aC0tLDA9PT10LndvcmRzW3QubGVuZ3RoLTFdJiZ0Lmxlbmd0aC0tKSx0fSxuKEIsYiksbihFLGIpLG4oayxiKSxrLnByb3RvdHlwZS5pbXVsSz1mdW5jdGlvbih0KXtmb3IodmFyIGU9MCxpPTA7aTx0Lmxlbmd0aDtpKyspe3ZhciByPTE5KigwfHQud29yZHNbaV0pK2Usbj02NzEwODg2MyZyO3I+Pj49MjYsdC53b3Jkc1tpXT1uLGU9cn1yZXR1cm4gMCE9PWUmJih0LndvcmRzW3QubGVuZ3RoKytdPWUpLHR9LG8uX3ByaW1lPWZ1bmN0aW9uKHQpe2lmKE1bdF0pcmV0dXJuIE1bdF07dmFyIGU7aWYoImsyNTYiPT09dCllPW5ldyBBO2Vsc2UgaWYoInAyMjQiPT09dCllPW5ldyBCO2Vsc2UgaWYoInAxOTIiPT09dCllPW5ldyBFO2Vsc2V7aWYoInAyNTUxOSIhPT10KXRocm93IG5ldyBFcnJvcigiVW5rbm93biBwcmltZSAiK3QpO2U9bmV3IGt9cmV0dXJuIE1bdF09ZSxlfSxfLnByb3RvdHlwZS5fdmVyaWZ5MT1mdW5jdGlvbih0KXtyKDA9PT10Lm5lZ2F0aXZlLCJyZWQgd29ya3Mgb25seSB3aXRoIHBvc2l0aXZlcyIpLHIodC5yZWQsInJlZCB3b3JrcyBvbmx5IHdpdGggcmVkIG51bWJlcnMiKX0sXy5wcm90b3R5cGUuX3ZlcmlmeTI9ZnVuY3Rpb24odCxlKXtyKCEodC5uZWdhdGl2ZXxlLm5lZ2F0aXZlKSwicmVkIHdvcmtzIG9ubHkgd2l0aCBwb3NpdGl2ZXMiKSxyKHQucmVkJiZ0LnJlZD09PWUucmVkLCJyZWQgd29ya3Mgb25seSB3aXRoIHJlZCBudW1iZXJzIil9LF8ucHJvdG90eXBlLmltb2Q9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMucHJpbWU/dGhpcy5wcmltZS5pcmVkdWNlKHQpLl9mb3JjZVJlZCh0aGlzKToobCh0LHQudW1vZCh0aGlzLm0pLl9mb3JjZVJlZCh0aGlzKSksdCl9LF8ucHJvdG90eXBlLm5lZz1mdW5jdGlvbih0KXtyZXR1cm4gdC5pc1plcm8oKT90LmNsb25lKCk6dGhpcy5tLnN1Yih0KS5fZm9yY2VSZWQodGhpcyl9LF8ucHJvdG90eXBlLmFkZD1mdW5jdGlvbih0LGUpe3RoaXMuX3ZlcmlmeTIodCxlKTt2YXIgaT10LmFkZChlKTtyZXR1cm4gaS5jbXAodGhpcy5tKT49MCYmaS5pc3ViKHRoaXMubSksaS5fZm9yY2VSZWQodGhpcyl9LF8ucHJvdG90eXBlLmlhZGQ9ZnVuY3Rpb24odCxlKXt0aGlzLl92ZXJpZnkyKHQsZSk7dmFyIGk9dC5pYWRkKGUpO3JldHVybiBpLmNtcCh0aGlzLm0pPj0wJiZpLmlzdWIodGhpcy5tKSxpfSxfLnByb3RvdHlwZS5zdWI9ZnVuY3Rpb24odCxlKXt0aGlzLl92ZXJpZnkyKHQsZSk7dmFyIGk9dC5zdWIoZSk7cmV0dXJuIGkuY21wbigwKTwwJiZpLmlhZGQodGhpcy5tKSxpLl9mb3JjZVJlZCh0aGlzKX0sXy5wcm90b3R5cGUuaXN1Yj1mdW5jdGlvbih0LGUpe3RoaXMuX3ZlcmlmeTIodCxlKTt2YXIgaT10LmlzdWIoZSk7cmV0dXJuIGkuY21wbigwKTwwJiZpLmlhZGQodGhpcy5tKSxpfSxfLnByb3RvdHlwZS5zaGw9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdGhpcy5fdmVyaWZ5MSh0KSx0aGlzLmltb2QodC51c2hsbihlKSl9LF8ucHJvdG90eXBlLmltdWw9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdGhpcy5fdmVyaWZ5Mih0LGUpLHRoaXMuaW1vZCh0LmltdWwoZSkpfSxfLnByb3RvdHlwZS5tdWw9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdGhpcy5fdmVyaWZ5Mih0LGUpLHRoaXMuaW1vZCh0Lm11bChlKSl9LF8ucHJvdG90eXBlLmlzcXI9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuaW11bCh0LHQuY2xvbmUoKSl9LF8ucHJvdG90eXBlLnNxcj1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5tdWwodCx0KX0sXy5wcm90b3R5cGUuc3FydD1mdW5jdGlvbih0KXtpZih0LmlzWmVybygpKXJldHVybiB0LmNsb25lKCk7dmFyIGU9dGhpcy5tLmFuZGxuKDMpO2lmKHIoZSUyPT0xKSwzPT09ZSl7dmFyIGk9dGhpcy5tLmFkZChuZXcgbygxKSkuaXVzaHJuKDIpO3JldHVybiB0aGlzLnBvdyh0LGkpfWZvcih2YXIgbj10aGlzLm0uc3VibigxKSxzPTA7IW4uaXNaZXJvKCkmJjA9PT1uLmFuZGxuKDEpOylzKyssbi5pdXNocm4oMSk7cighbi5pc1plcm8oKSk7dmFyIGg9bmV3IG8oMSkudG9SZWQodGhpcyksdT1oLnJlZE5lZygpLGE9dGhpcy5tLnN1Ym4oMSkuaXVzaHJuKDEpLGw9dGhpcy5tLmJpdExlbmd0aCgpO2ZvcihsPW5ldyBvKDIqbCpsKS50b1JlZCh0aGlzKTswIT09dGhpcy5wb3cobCxhKS5jbXAodSk7KWwucmVkSUFkZCh1KTtmb3IodmFyIGY9dGhpcy5wb3cobCxuKSxjPXRoaXMucG93KHQsbi5hZGRuKDEpLml1c2hybigxKSkscD10aGlzLnBvdyh0LG4pLG09czswIT09cC5jbXAoaCk7KXtmb3IodmFyIGQ9cCxnPTA7MCE9PWQuY21wKGgpO2crKylkPWQucmVkU3FyKCk7cihnPG0pO3ZhciB5PXRoaXMucG93KGYsbmV3IG8oMSkuaXVzaGxuKG0tZy0xKSk7Yz1jLnJlZE11bCh5KSxmPXkucmVkU3FyKCkscD1wLnJlZE11bChmKSxtPWd9cmV0dXJuIGN9LF8ucHJvdG90eXBlLmludm09ZnVuY3Rpb24odCl7dmFyIGU9dC5faW52bXAodGhpcy5tKTtyZXR1cm4gMCE9PWUubmVnYXRpdmU/KGUubmVnYXRpdmU9MCx0aGlzLmltb2QoZSkucmVkTmVnKCkpOnRoaXMuaW1vZChlKX0sXy5wcm90b3R5cGUucG93PWZ1bmN0aW9uKHQsZSl7aWYoZS5pc1plcm8oKSlyZXR1cm4gbmV3IG8oMSkudG9SZWQodGhpcyk7aWYoMD09PWUuY21wbigxKSlyZXR1cm4gdC5jbG9uZSgpO3ZhciBpPW5ldyBBcnJheSgxNik7aVswXT1uZXcgbygxKS50b1JlZCh0aGlzKSxpWzFdPXQ7Zm9yKHZhciByPTI7cjxpLmxlbmd0aDtyKyspaVtyXT10aGlzLm11bChpW3ItMV0sdCk7dmFyIG49aVswXSxzPTAsaD0wLHU9ZS5iaXRMZW5ndGgoKSUyNjtmb3IoMD09PXUmJih1PTI2KSxyPWUubGVuZ3RoLTE7cj49MDtyLS0pe2Zvcih2YXIgYT1lLndvcmRzW3JdLGw9dS0xO2w+PTA7bC0tKXt2YXIgZj1hPj5sJjE7biE9PWlbMF0mJihuPXRoaXMuc3FyKG4pKSwwIT09Znx8MCE9PXM/KHM8PD0xLHN8PWYsKDQ9PSsraHx8MD09PXImJjA9PT1sKSYmKG49dGhpcy5tdWwobixpW3NdKSxoPTAscz0wKSk6aD0wfXU9MjZ9cmV0dXJuIG59LF8ucHJvdG90eXBlLmNvbnZlcnRUbz1mdW5jdGlvbih0KXt2YXIgZT10LnVtb2QodGhpcy5tKTtyZXR1cm4gZT09PXQ/ZS5jbG9uZSgpOmV9LF8ucHJvdG90eXBlLmNvbnZlcnRGcm9tPWZ1bmN0aW9uKHQpe3ZhciBlPXQuY2xvbmUoKTtyZXR1cm4gZS5yZWQ9bnVsbCxlfSxvLm1vbnQ9ZnVuY3Rpb24odCl7cmV0dXJuIG5ldyBUKHQpfSxuKFQsXyksVC5wcm90b3R5cGUuY29udmVydFRvPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmltb2QodC51c2hsbih0aGlzLnNoaWZ0KSl9LFQucHJvdG90eXBlLmNvbnZlcnRGcm9tPWZ1bmN0aW9uKHQpe3ZhciBlPXRoaXMuaW1vZCh0Lm11bCh0aGlzLnJpbnYpKTtyZXR1cm4gZS5yZWQ9bnVsbCxlfSxULnByb3RvdHlwZS5pbXVsPWZ1bmN0aW9uKHQsZSl7aWYodC5pc1plcm8oKXx8ZS5pc1plcm8oKSlyZXR1cm4gdC53b3Jkc1swXT0wLHQubGVuZ3RoPTEsdDt2YXIgaT10LmltdWwoZSkscj1pLm1hc2tuKHRoaXMuc2hpZnQpLm11bCh0aGlzLm1pbnYpLmltYXNrbih0aGlzLnNoaWZ0KS5tdWwodGhpcy5tKSxuPWkuaXN1YihyKS5pdXNocm4odGhpcy5zaGlmdCksbz1uO3JldHVybiBuLmNtcCh0aGlzLm0pPj0wP289bi5pc3ViKHRoaXMubSk6bi5jbXBuKDApPDAmJihvPW4uaWFkZCh0aGlzLm0pKSxvLl9mb3JjZVJlZCh0aGlzKX0sVC5wcm90b3R5cGUubXVsPWZ1bmN0aW9uKHQsZSl7aWYodC5pc1plcm8oKXx8ZS5pc1plcm8oKSlyZXR1cm4gbmV3IG8oMCkuX2ZvcmNlUmVkKHRoaXMpO3ZhciBpPXQubXVsKGUpLHI9aS5tYXNrbih0aGlzLnNoaWZ0KS5tdWwodGhpcy5taW52KS5pbWFza24odGhpcy5zaGlmdCkubXVsKHRoaXMubSksbj1pLmlzdWIocikuaXVzaHJuKHRoaXMuc2hpZnQpLHM9bjtyZXR1cm4gbi5jbXAodGhpcy5tKT49MD9zPW4uaXN1Yih0aGlzLm0pOm4uY21wbigwKTwwJiYocz1uLmlhZGQodGhpcy5tKSkscy5fZm9yY2VSZWQodGhpcyl9LFQucHJvdG90eXBlLmludm09ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuaW1vZCh0Ll9pbnZtcCh0aGlzLm0pLm11bCh0aGlzLnIyKSkuX2ZvcmNlUmVkKHRoaXMpfX0odD1pLm5tZCh0KSx0aGlzKX0sNTI2Oih0LGUpPT57InVzZSBzdHJpY3QiO2UuYnl0ZUxlbmd0aD1mdW5jdGlvbih0KXt2YXIgZT1oKHQpLGk9ZVswXSxyPWVbMV07cmV0dXJuIDMqKGkrcikvNC1yfSxlLnRvQnl0ZUFycmF5PWZ1bmN0aW9uKHQpe3ZhciBlLGksbz1oKHQpLHM9b1swXSx1PW9bMV0sYT1uZXcgbihmdW5jdGlvbih0LGUsaSl7cmV0dXJuIDMqKGUraSkvNC1pfSgwLHMsdSkpLGw9MCxmPXU+MD9zLTQ6cztmb3IoaT0wO2k8ZjtpKz00KWU9clt0LmNoYXJDb2RlQXQoaSldPDwxOHxyW3QuY2hhckNvZGVBdChpKzEpXTw8MTJ8clt0LmNoYXJDb2RlQXQoaSsyKV08PDZ8clt0LmNoYXJDb2RlQXQoaSszKV0sYVtsKytdPWU+PjE2JjI1NSxhW2wrK109ZT4+OCYyNTUsYVtsKytdPTI1NSZlO3JldHVybiAyPT09dSYmKGU9clt0LmNoYXJDb2RlQXQoaSldPDwyfHJbdC5jaGFyQ29kZUF0KGkrMSldPj40LGFbbCsrXT0yNTUmZSksMT09PXUmJihlPXJbdC5jaGFyQ29kZUF0KGkpXTw8MTB8clt0LmNoYXJDb2RlQXQoaSsxKV08PDR8clt0LmNoYXJDb2RlQXQoaSsyKV0+PjIsYVtsKytdPWU+PjgmMjU1LGFbbCsrXT0yNTUmZSksYX0sZS5mcm9tQnl0ZUFycmF5PWZ1bmN0aW9uKHQpe2Zvcih2YXIgZSxyPXQubGVuZ3RoLG49ciUzLG89W10scz0xNjM4MyxoPTAsYT1yLW47aDxhO2grPXMpby5wdXNoKHUodCxoLGgrcz5hP2E6aCtzKSk7cmV0dXJuIDE9PT1uPyhlPXRbci0xXSxvLnB1c2goaVtlPj4yXStpW2U8PDQmNjNdKyI9PSIpKToyPT09biYmKGU9KHRbci0yXTw8OCkrdFtyLTFdLG8ucHVzaChpW2U+PjEwXStpW2U+PjQmNjNdK2lbZTw8MiY2M10rIj0iKSksby5qb2luKCIiKX07Zm9yKHZhciBpPVtdLHI9W10sbj0idW5kZWZpbmVkIiE9dHlwZW9mIFVpbnQ4QXJyYXk/VWludDhBcnJheTpBcnJheSxvPSJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvIixzPTA7czw2NDsrK3MpaVtzXT1vW3NdLHJbby5jaGFyQ29kZUF0KHMpXT1zO2Z1bmN0aW9uIGgodCl7dmFyIGU9dC5sZW5ndGg7aWYoZSU0PjApdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0Iik7dmFyIGk9dC5pbmRleE9mKCI9Iik7cmV0dXJuLTE9PT1pJiYoaT1lKSxbaSxpPT09ZT8wOjQtaSU0XX1mdW5jdGlvbiB1KHQsZSxyKXtmb3IodmFyIG4sbyxzPVtdLGg9ZTtoPHI7aCs9MyluPSh0W2hdPDwxNiYxNjcxMTY4MCkrKHRbaCsxXTw8OCY2NTI4MCkrKDI1NSZ0W2grMl0pLHMucHVzaChpWyhvPW4pPj4xOCY2M10raVtvPj4xMiY2M10raVtvPj42JjYzXStpWzYzJm9dKTtyZXR1cm4gcy5qb2luKCIiKX1yWyItIi5jaGFyQ29kZUF0KDApXT02MixyWyJfIi5jaGFyQ29kZUF0KDApXT02M30sNzkwOigpPT57fX0saT17fTtmdW5jdGlvbiByKHQpe3ZhciBuPWlbdF07aWYodm9pZCAwIT09bilyZXR1cm4gbi5leHBvcnRzO3ZhciBvPWlbdF09e2lkOnQsbG9hZGVkOiExLGV4cG9ydHM6e319O3JldHVybiBlW3RdLmNhbGwoby5leHBvcnRzLG8sby5leHBvcnRzLHIpLG8ubG9hZGVkPSEwLG8uZXhwb3J0c31yLm49dD0+e3ZhciBlPXQmJnQuX19lc01vZHVsZT8oKT0+dC5kZWZhdWx0OigpPT50O3JldHVybiByLmQoZSx7YTplfSksZX0sci5kPSh0LGUpPT57Zm9yKHZhciBpIGluIGUpci5vKGUsaSkmJiFyLm8odCxpKSYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHQsaSx7ZW51bWVyYWJsZTohMCxnZXQ6ZVtpXX0pfSxyLm89KHQsZSk9Pk9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0LGUpLHIucj10PT57InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHQsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sci5ubWQ9dD0+KHQucGF0aHM9W10sdC5jaGlsZHJlbnx8KHQuY2hpbGRyZW49W10pLHQpO3ZhciBuPXt9O3JldHVybigoKT0+eyJ1c2Ugc3RyaWN0IjtyLnIobiksci5kKG4se1BheW1lbnRQcm9jZXNzb3I6KCk9PmcsUGhhbnRvbUFkYXB0ZXI6KCk9PnksVG9rZW5SZWdpc3RyeTooKT0+byxUcmFuc2FjdGlvblV0aWxzOigpPT50LFZhbGlkYXRpb25VdGlsczooKT0+ZSxjcmVhdGVTb2xhbmFQYXltZW50U0RLOigpPT52LGRlZmF1bHQ6KCk9Pnd9KTt2YXIgdD17fTtyLnIodCksci5kKHQse2NyZWF0ZUFzc29jaWF0ZWRUb2tlbkFjY291bnRJbnN0cnVjdGlvbjooKT0+YyxjcmVhdGVUcmFuc2Zlckluc3RydWN0aW9uOigpPT5wLGZpbmRBc3NvY2lhdGVkVG9rZW5BY2NvdW50OigpPT5mfSk7dmFyIGU9e307ci5yKGUpLHIuZChlLHtpc1ZhbGlkU29sYW5hQWRkcmVzczooKT0+bSx2YWxpZGF0ZVBheW1lbnRQYXJhbXM6KCk9PmR9KTt2YXIgaT1yKDMpO2NsYXNzIG97Y29uc3RydWN0b3IoKXt0aGlzLnRva2Vucz17U09MOntuYW1lOiJTb2xhbmEiLHN5bWJvbDoiU09MIixpc05hdGl2ZTohMCxtaW50QWRkcmVzczpudWxsLGRlY2ltYWxzOjksbWF4VHJhbnNmZXJBbW91bnQ6MTAwLGxvZ29Vcmw6Imh0dHBzOi8vY3J5cHRvbG9nb3MuY2MvbG9nb3Mvc29sYW5hLXNvbC1sb2dvLnBuZyJ9fX1nZXRUb2tlbih0KXtyZXR1cm4gdGhpcy50b2tlbnNbdF0/dGhpcy50b2tlbnNbdF06T2JqZWN0LnZhbHVlcyh0aGlzLnRva2VucykuZmluZCgoZT0+ZS5taW50QWRkcmVzcyYmZS5taW50QWRkcmVzcz09PXQpKXx8bnVsbH1hZGRUb2tlbih0KXtjb25zdHtzeW1ib2w6ZSxtaW50QWRkcmVzczppLG5hbWU6cixkZWNpbWFsczpuLG1heFRyYW5zZmVyQW1vdW50Om8sbG9nb1VybDpzLGlzTmF0aXZlOmh9PXQ7aWYoIWUpdGhyb3cgbmV3IEVycm9yKCJUb2tlbiBtdXN0IGluY2x1ZGUgYSBzeW1ib2wiKTtpZighaCYmIWkpdGhyb3cgbmV3IEVycm9yKCJTUEwgdG9rZW4gbXVzdCBpbmNsdWRlIGEgbWludCBhZGRyZXNzIik7cmV0dXJuIHRoaXMudG9rZW5zW2VdPXtuYW1lOnJ8fGUsc3ltYm9sOmUsbWludEFkZHJlc3M6aD9udWxsOmksZGVjaW1hbHM6bj8/OSxtYXhUcmFuc2ZlckFtb3VudDpvPz8xZTMsbG9nb1VybDpzfHxudWxsLGlzTmF0aXZlOiEhaH0sdGhpcy50b2tlbnNbZV19Z2V0QWxsVG9rZW5zKCl7cmV0dXJuIHRoaXMudG9rZW5zfXJlbW92ZVRva2VuKHQpe3JldHVybiEhdGhpcy50b2tlbnNbdF0mJihkZWxldGUgdGhpcy50b2tlbnNbdF0sITApfX12YXIgcz1yKDQwNCksaD1yLm4ocyksdT1yKDI4NykuaHA7Y29uc3QgYT1uZXcgaS5QdWJsaWNLZXkoIlRva2Vua2VnUWZlWnlpTndBSmJOYkdLUEZYQ1d1QnZmOVNzNjIzVlE1REEiKSxsPW5ldyBpLlB1YmxpY0tleSgiQVRva2VuR1B2YmRHVnhyMWIyaHZaYnNpcVc1eFdIMjVlZlROc0xKQThrbkwiKTthc3luYyBmdW5jdGlvbiBmKHQsZSl7cmV0dXJuIGkuUHVibGljS2V5LmZpbmRQcm9ncmFtQWRkcmVzc1N5bmMoW3QudG9CdWZmZXIoKSxhLnRvQnVmZmVyKCksZS50b0J1ZmZlcigpXSxsKVswXX1mdW5jdGlvbiBjKHQsZSxyKXtyZXR1cm4gbmV3IGkuVHJhbnNhY3Rpb25JbnN0cnVjdGlvbih7a2V5czpbe3B1YmtleTp0LGlzU2lnbmVyOiEwLGlzV3JpdGFibGU6ITB9LHtwdWJrZXk6ZihlLHIpLGlzU2lnbmVyOiExLGlzV3JpdGFibGU6ITB9LHtwdWJrZXk6ZSxpc1NpZ25lcjohMSxpc1dyaXRhYmxlOiExfSx7cHVia2V5OnIsaXNTaWduZXI6ITEsaXNXcml0YWJsZTohMX0se3B1YmtleTppLlN5c3RlbVByb2dyYW0ucHJvZ3JhbUlkLGlzU2lnbmVyOiExLGlzV3JpdGFibGU6ITF9LHtwdWJrZXk6YSxpc1NpZ25lcjohMSxpc1dyaXRhYmxlOiExfSx7cHVia2V5OmwsaXNTaWduZXI6ITEsaXNXcml0YWJsZTohMX1dLHByb2dyYW1JZDpsLGRhdGE6dS5mcm9tKFtdKX0pfWZ1bmN0aW9uIHAodCxlLHIsbil7cmV0dXJuIG5ldyBpLlRyYW5zYWN0aW9uSW5zdHJ1Y3Rpb24oe2tleXM6W3twdWJrZXk6dCxpc1NpZ25lcjohMSxpc1dyaXRhYmxlOiEwfSx7cHVia2V5OmUsaXNTaWduZXI6ITEsaXNXcml0YWJsZTohMH0se3B1YmtleTpyLGlzU2lnbmVyOiEwLGlzV3JpdGFibGU6ITF9XSxwcm9ncmFtSWQ6YSxkYXRhOnUuZnJvbShbMywuLi5uZXcoaCgpKShuKS50b0FycmF5KCJsZSIsOCldKX0pfWZ1bmN0aW9uIG0odCl7dHJ5e3JldHVybiBuZXcgaS5QdWJsaWNLZXkodCksITB9Y2F0Y2h7cmV0dXJuITF9fWZ1bmN0aW9uIGQodCxlKXtjb25zdHtyZWNpcGllbnQ6aSxhbW91bnQ6cn09dDtyZXR1cm4gaSYmbShpKT9lP2lzTmFOKHIpfHxyPD0wP3tpc1ZhbGlkOiExLGVycm9yOiJBbW91bnQgbXVzdCBiZSBncmVhdGVyIHRoYW4gMCJ9OmUubWF4VHJhbnNmZXJBbW91bnQmJnI+ZS5tYXhUcmFuc2ZlckFtb3VudD97aXNWYWxpZDohMSxlcnJvcjpgQW1vdW50IGV4Y2VlZHMgbWF4aW11bSB0cmFuc2ZlciBhbW91bnQgb2YgJHtlLm1heFRyYW5zZmVyQW1vdW50fSAke2Uuc3ltYm9sfWB9Ontpc1ZhbGlkOiEwLGVycm9yOm51bGx9Ontpc1ZhbGlkOiExLGVycm9yOiJJbnZhbGlkIHRva2VuIn06e2lzVmFsaWQ6ITEsZXJyb3I6IkludmFsaWQgcmVjaXBpZW50IGFkZHJlc3MifX1jbGFzcyBne2NvbnN0cnVjdG9yKCl7bGV0IHQ9YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOnt9O3RoaXMuY29uZmlnPXtuZXR3b3JrOnQubmV0d29ya3x8ImRldm5ldCIscnBjRW5kcG9pbnQ6dC5ycGNFbmRwb2ludHx8KHQ9Pntzd2l0Y2godCl7Y2FzZSJkZXZuZXQiOnJldHVybiJodHRwczovL2FwaS5kZXZuZXQuc29sYW5hLmNvbSI7Y2FzZSJ0ZXN0bmV0IjpyZXR1cm4iaHR0cHM6Ly9hcGkudGVzdG5ldC5zb2xhbmEuY29tIjtkZWZhdWx0OnJldHVybiJodHRwczovL3NvbGFuYS1hcGkucHJvamVjdHNlcnVtLmNvbSJ9fSkodC5uZXR3b3JrfHwiZGV2bmV0IiksY29tbWl0bWVudDp0LmNvbW1pdG1lbnR8fCJjb25maXJtZWQiLGNvbmZpcm1hdGlvbkJsb2Nrczp0LmNvbmZpcm1hdGlvbkJsb2Nrc3x8MTUsdHJhbnNhY3Rpb25UaW1lb3V0OnQudHJhbnNhY3Rpb25UaW1lb3V0fHw2ZTQscmV0cnlBdHRlbXB0czp0LnJldHJ5QXR0ZW1wdHN8fDMsLi4udH0sdGhpcy53YWxsZXQ9bnVsbCx0aGlzLmNvbm5lY3Rpb249bnVsbCx0aGlzLndhbGxldEFkYXB0ZXI9bnVsbCx0aGlzLnRva2VuUmVnaXN0cnk9bmV3IG8sdGhpcy5pbml0aWFsaXplZD0hMX1hc3luYyBpbml0KCl7aWYodGhpcy5pbml0aWFsaXplZClyZXR1cm4hMDtsZXQgdD0wO2Zvcig7dDwzOyl0cnl7cmV0dXJuIHRoaXMuY29ubmVjdGlvbj1uZXcgaS5Db25uZWN0aW9uKHRoaXMuY29uZmlnLnJwY0VuZHBvaW50LHtjb21taXRtZW50OnRoaXMuY29uZmlnLmNvbW1pdG1lbnQsY29uZmlybVRyYW5zYWN0aW9uSW5pdGlhbFRpbWVvdXQ6NmU0LGRpc2FibGVSZXRyeU9uUmF0ZUxpbWl0OiExLGh0dHBIZWFkZXJzOnsiQ29udGVudC1UeXBlIjoiYXBwbGljYXRpb24vanNvbiJ9fSksYXdhaXQgdGhpcy5jb25uZWN0aW9uLmdldExhdGVzdEJsb2NraGFzaCgpLHRoaXMuaW5pdGlhbGl6ZWQ9ITAsITB9Y2F0Y2goZSl7aWYodCsrLGNvbnNvbGUud2FybihgUlBDIGNvbm5lY3Rpb24gYXR0ZW1wdCAke3R9IGZhaWxlZDpgLGUubWVzc2FnZSksdD49Myl0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBjb25uZWN0IHRvIFJQQyBhZnRlciAzIGF0dGVtcHRzLiBMYXN0IGVycm9yOiAke2UubWVzc2FnZX1gKTsyPT09dCYmIm1haW5uZXQtYmV0YSI9PT10aGlzLmNvbmZpZy5uZXR3b3JrJiYodGhpcy5jb25maWcucnBjRW5kcG9pbnQ9Imh0dHBzOi8vcnBjLmFua3IuY29tL3NvbGFuYSIpLDM9PT10JiYibWFpbm5ldC1iZXRhIj09PXRoaXMuY29uZmlnLm5ldHdvcmsmJih0aGlzLmNvbmZpZy5ycGNFbmRwb2ludD0iaHR0cHM6Ly9zb2xhbmEtbWFpbm5ldC5nLmFsY2hlbXkuY29tL3YyL2RlbW8iKSxhd2FpdCBuZXcgUHJvbWlzZSgodD0+c2V0VGltZW91dCh0LDFlMykpKX19c2V0V2FsbGV0QWRhcHRlcih0KXt0aGlzLndhbGxldEFkYXB0ZXI9dH1hc3luYyBjb25uZWN0V2FsbGV0KCl7bGV0IHQ9YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOnt9O2lmKGF3YWl0IHRoaXMuaW5pdCgpLCF0aGlzLndhbGxldEFkYXB0ZXIpdGhyb3cgbmV3IEVycm9yKCJObyB3YWxsZXQgYWRhcHRlciBzZXQuIik7Y29uc3QgZT1hd2FpdCB0aGlzLndhbGxldEFkYXB0ZXIuY29ubmVjdCh0KTtyZXR1cm4gdGhpcy53YWxsZXQ9ZSxlfWFzeW5jIGRpc2Nvbm5lY3RXYWxsZXQoKXtpZighdGhpcy53YWxsZXRBZGFwdGVyKXRocm93IG5ldyBFcnJvcigiTm8gd2FsbGV0IGFkYXB0ZXIgc2V0Iik7cmV0dXJuIGF3YWl0IHRoaXMud2FsbGV0QWRhcHRlci5kaXNjb25uZWN0KCksdGhpcy53YWxsZXQ9bnVsbCwhMH1hc3luYyBnZXRUb2tlbkJhbGFuY2UodCl7aWYoIXRoaXMud2FsbGV0KXRocm93IG5ldyBFcnJvcigiV2FsbGV0IG5vdCBjb25uZWN0ZWQiKTtjb25zdCBlPXRoaXMudG9rZW5SZWdpc3RyeS5nZXRUb2tlbih0KTtpZighZSl0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gdG9rZW46ICR7dH1gKTtyZXR1cm4gYXdhaXQgdGhpcy53YWxsZXRBZGFwdGVyLmdldFRva2VuQmFsYW5jZSh0aGlzLmNvbm5lY3Rpb24sbmV3IGkuUHVibGljS2V5KHRoaXMud2FsbGV0LnB1YmxpY0tleSksZS5taW50QWRkcmVzcyl9YXN5bmMgc2VuZFRva2Vucyh0KXtsZXR7cmVjaXBpZW50OmUsYW1vdW50OnIsdG9rZW5NaW50Om4sbWVtbzpvfT10O2lmKCF0aGlzLndhbGxldCl0aHJvdyBuZXcgRXJyb3IoIldhbGxldCBub3QgY29ubmVjdGVkIik7aWYoIXRoaXMud2FsbGV0QWRhcHRlcil0aHJvdyBuZXcgRXJyb3IoIk5vIHdhbGxldCBhZGFwdGVyIHNldCIpO2lmKCFlfHwhbShlKSl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcmVjaXBpZW50IGFkZHJlc3MiKTtjb25zdCBzPW5ldyBpLlB1YmxpY0tleSh0aGlzLndhbGxldC5wdWJsaWNLZXkpLGg9bmV3IGkuUHVibGljS2V5KGUpO2lmKCJTT0wiPT09bil7Y29uc3QgdD1NYXRoLmZsb29yKDFlOSpyKTtpZih0PjFlMTIpdGhyb3cgbmV3IEVycm9yKCJBbW91bnQgdG9vIGxhcmdlIGZvciBzYWZldHkuIE1heGltdW0gMTAwMCBTT0wgcGVyIHRyYW5zYWN0aW9uLiIpO2NvbnN0IGU9KG5ldyBpLlRyYW5zYWN0aW9uKS5hZGQoaS5TeXN0ZW1Qcm9ncmFtLnRyYW5zZmVyKHtmcm9tUHVia2V5OnMsdG9QdWJrZXk6aCxsYW1wb3J0czp0fSkpLHtibG9ja2hhc2g6bixsYXN0VmFsaWRCbG9ja0hlaWdodDpvfT1hd2FpdCB0aGlzLmNvbm5lY3Rpb24uZ2V0TGF0ZXN0QmxvY2toYXNoKCJjb25maXJtZWQiKTtlLnJlY2VudEJsb2NraGFzaD1uLGUubGFzdFZhbGlkQmxvY2tIZWlnaHQ9byxlLmZlZVBheWVyPXM7Y29uc3QgdT1hd2FpdCB0aGlzLmNvbm5lY3Rpb24uc2ltdWxhdGVUcmFuc2FjdGlvbihlKTtpZih1LnZhbHVlLmVycil0aHJvdyBuZXcgRXJyb3IoYFNPTCB0cmFuc2ZlciBzaW11bGF0aW9uIGZhaWxlZDogJHtKU09OLnN0cmluZ2lmeSh1LnZhbHVlLmVycil9YCk7Y29uc3QgYT1hd2FpdCB0aGlzLndhbGxldEFkYXB0ZXIuc2lnbkFuZFNlbmRUcmFuc2FjdGlvbihlKTtyZXR1cm57c2lnbmF0dXJlOmEsY29uZmlybWF0aW9uOmF3YWl0IHRoaXMud2FpdEZvckNvbmZpcm1hdGlvbihhKSxleHBsb3JlclVybDpgJHt0aGlzLmNvbmZpZy5uZXR3b3JrLCJodHRwczovL3NvbHNjYW4uaW8vdHgifS8ke2F9JHsiZGV2bmV0Ij09PXRoaXMuY29uZmlnLm5ldHdvcms/Ij9jbHVzdGVyPWRldm5ldCI6IiJ9YH19Y29uc3QgdT10aGlzLnRva2VuUmVnaXN0cnkuZ2V0VG9rZW4obik7aWYoIXUpdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIHRva2VuOiAke259YCk7aWYoaXNOYU4ocil8fHI8PTB8fHI+dS5tYXhUcmFuc2ZlckFtb3VudCl0aHJvdyBuZXcgRXJyb3IoYEFtb3VudCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgJHt1Lm1heFRyYW5zZmVyQW1vdW50fSAke3Uuc3ltYm9sfWApO2NvbnN0IGE9YXdhaXQgdGhpcy5jcmVhdGVUb2tlblRyYW5zZmVyVHJhbnNhY3Rpb24oe3JlY2lwaWVudDpoLGFtb3VudDpyLHRva2VuTWludDpuLG1lbW86b30pLGw9YXdhaXQgdGhpcy5jb25uZWN0aW9uLnNpbXVsYXRlVHJhbnNhY3Rpb24oYSk7aWYobC52YWx1ZS5lcnIpdGhyb3cgbmV3IEVycm9yKGBUcmFuc2FjdGlvbiBzaW11bGF0aW9uIGZhaWxlZDogJHtKU09OLnN0cmluZ2lmeShsLnZhbHVlLmVycil9YCk7Y29uc3QgZj1hd2FpdCB0aGlzLndhbGxldEFkYXB0ZXIuc2lnbkFuZFNlbmRUcmFuc2FjdGlvbihhKTtyZXR1cm57c2lnbmF0dXJlOmYsY29uZmlybWF0aW9uOmF3YWl0IHRoaXMud2FpdEZvckNvbmZpcm1hdGlvbihmKSxleHBsb3JlclVybDpgJHt0aGlzLmNvbmZpZy5uZXR3b3JrLCJodHRwczovL3NvbHNjYW4uaW8vdHgifS8ke2Z9JHsiZGV2bmV0Ij09PXRoaXMuY29uZmlnLm5ldHdvcms/Ij9jbHVzdGVyPWRldm5ldCI6IiJ9YH19YXN5bmMgY3JlYXRlVG9rZW5UcmFuc2ZlclRyYW5zYWN0aW9uKHQpe2xldHtyZWNpcGllbnQ6ZSxhbW91bnQ6cix0b2tlbk1pbnQ6bixtZW1vOm99PXQ7Y29uc3Qgcz1uZXcgaS5QdWJsaWNLZXkodGhpcy53YWxsZXQucHVibGljS2V5KSxoPXRoaXMudG9rZW5SZWdpc3RyeS5nZXRUb2tlbihuKSx1PW5ldyBpLlB1YmxpY0tleShoLm1pbnRBZGRyZXNzKSxhPU1hdGguZmxvb3IocipNYXRoLnBvdygxMCxoLmRlY2ltYWxzKSksbD1hd2FpdCBmKHMsdSksbT1hd2FpdCBmKGUsdSk7bGV0IGQ9bmV3IGkuVHJhbnNhY3Rpb247YXdhaXQgdGhpcy5jb25uZWN0aW9uLmdldEFjY291bnRJbmZvKG0pfHxkLmFkZChjKHMsZSx1KSksZC5hZGQocChsLG0scyxhKSk7Y29uc3R7YmxvY2toYXNoOmcsbGFzdFZhbGlkQmxvY2tIZWlnaHQ6eX09YXdhaXQgdGhpcy5jb25uZWN0aW9uLmdldExhdGVzdEJsb2NraGFzaCgiY29uZmlybWVkIik7cmV0dXJuIGQucmVjZW50QmxvY2toYXNoPWcsZC5sYXN0VmFsaWRCbG9ja0hlaWdodD15LGQuZmVlUGF5ZXI9cyxkfWFzeW5jIHdhaXRGb3JDb25maXJtYXRpb24odCl7bGV0IGUsaSxyPTA7cmV0dXJuIG5ldyBQcm9taXNlKCgobixvKT0+e2NvbnN0IHM9YXN5bmMoKT0+e3RyeXtjb25zdCBzPWF3YWl0IHRoaXMuY29ubmVjdGlvbi5nZXRTaWduYXR1cmVTdGF0dXModCk7aWYocz8udmFsdWUpe2lmKHMudmFsdWUuZXJyKXJldHVybiBjbGVhckludGVydmFsKGkpLGNsZWFyVGltZW91dChlKSx2b2lkIG8obmV3IEVycm9yKCJUcmFuc2FjdGlvbiBmYWlsZWQgb24gY2hhaW4iKSk7aWYocy52YWx1ZS5jb25maXJtYXRpb25zPj10aGlzLmNvbmZpZy5jb25maXJtYXRpb25CbG9ja3N8fCJmaW5hbGl6ZWQiPT09cy52YWx1ZS5jb25maXJtYXRpb25TdGF0dXMpcmV0dXJuIGNsZWFySW50ZXJ2YWwoaSksY2xlYXJUaW1lb3V0KGUpLHZvaWQgbihzKX1lbHNlIGlmKHI+PXRoaXMuY29uZmlnLnJldHJ5QXR0ZW1wdHMpcmV0dXJuIGNsZWFySW50ZXJ2YWwoaSksY2xlYXJUaW1lb3V0KGUpLHZvaWQgbih7c3RhdHVzOiJwZW5kaW5nIixzaWduYXR1cmU6dCxleHBsb3JlclVybDpgaHR0cHM6Ly9zb2xzY2FuLmlvL3R4LyR7dH0keyJkZXZuZXQiPT09dGhpcy5jb25maWcubmV0d29yaz8iP2NsdXN0ZXI9ZGV2bmV0IjoiIn1gfSl9Y2F0Y2godCl7Y29uc29sZS53YXJuKCJDb25maXJtYXRpb24gY2hlY2sgZmFpbGVkOiIsdCl9cisrfTtlPXNldFRpbWVvdXQoKCgpPT57Y2xlYXJJbnRlcnZhbChpKSxvKG5ldyBFcnJvcigiVHJhbnNhY3Rpb24gY29uZmlybWF0aW9uIHRpbWVvdXQiKSl9KSx0aGlzLmNvbmZpZy50cmFuc2FjdGlvblRpbWVvdXQpLGk9c2V0SW50ZXJ2YWwocywxNTAwKSxzKCl9KSl9fWNsYXNzIHl7Y29uc3RydWN0b3IoKXt0aGlzLndhbGxldD1udWxsfWFzeW5jIGNoZWNrQXZhaWxhYmlsaXR5KCl7aWYoIXdpbmRvdy5zb2xhbmF8fCF3aW5kb3cuc29sYW5hLmlzUGhhbnRvbSl0aHJvdyBuZXcgRXJyb3IoIlBoYW50b20gV2FsbGV0IG5vdCBkZXRlY3RlZC4gUGxlYXNlIGluc3RhbGwgaXQgZnJvbSBodHRwczovL3BoYW50b20uYXBwLyIpO3JldHVybiEwfWFzeW5jIGNvbm5lY3QoKXtsZXQgdD1hcmd1bWVudHMubGVuZ3RoPjAmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT9hcmd1bWVudHNbMF06e307dHJ5e2F3YWl0IHRoaXMuY2hlY2tBdmFpbGFiaWxpdHkoKTt0cnl7YXdhaXQgd2luZG93LnNvbGFuYS5kaXNjb25uZWN0KCl9Y2F0Y2godCl7Y29uc29sZS5sb2coIk5vIGV4aXN0aW5nIGNvbm5lY3Rpb24gdG8gZGlzY29ubmVjdCIpfWNvbnN0IGU9e29ubHlJZlRydXN0ZWQ6ITEsZm9yY2VSZWFwcHJvdmFsOiEwLC4uLnR9LHI9YXdhaXQgd2luZG93LnNvbGFuYS5jb25uZWN0KGUpO3JldHVybiB0aGlzLndhbGxldD17cHVibGljS2V5Om5ldyBpLlB1YmxpY0tleShyLnB1YmxpY0tleS50b1N0cmluZygpKX0sdGhpcy53YWxsZXR9Y2F0Y2godCl7aWYodC5tZXNzYWdlLmluY2x1ZGVzKCJVc2VyIHJlamVjdGVkIikpdGhyb3cgbmV3IEVycm9yKCJDb25uZWN0aW9uIHJlamVjdGVkIGJ5IHVzZXIiKTt0aHJvdyB0fX1hc3luYyBkaXNjb25uZWN0KCl7dHJ5e3JldHVybiBhd2FpdCB3aW5kb3cuc29sYW5hLmRpc2Nvbm5lY3QoKSx0aGlzLndhbGxldD1udWxsLCEwfWNhdGNoKHQpe3Rocm93IHR9fWFzeW5jIGdldFRva2VuQmFsYW5jZSh0LGUscil7Y29uc3Qgbj1hd2FpdCB0LmdldFBhcnNlZFRva2VuQWNjb3VudHNCeU93bmVyKGUse21pbnQ6bmV3IGkuUHVibGljS2V5KHIpfSk7cmV0dXJuIG4udmFsdWUubGVuZ3RoPjA/bi52YWx1ZVswXS5hY2NvdW50LmRhdGEucGFyc2VkLmluZm8udG9rZW5BbW91bnQudWlBbW91bnQ6MH1hc3luYyBzaWduQW5kU2VuZFRyYW5zYWN0aW9uKHQpe3RyeXtjb25zdCBlPXtza2lwUHJlZmxpZ2h0OiExLHByZWZsaWdodENvbW1pdG1lbnQ6InByb2Nlc3NlZCIsbWF4UmV0cmllczo1fTtyZXR1cm4oYXdhaXQgd2luZG93LnNvbGFuYS5zaWduQW5kU2VuZFRyYW5zYWN0aW9uKHQsZSkpLnNpZ25hdHVyZX1jYXRjaCh0KXtpZih0Lm1lc3NhZ2UuaW5jbHVkZXMoIlVzZXIgcmVqZWN0ZWQiKSl0aHJvdyBuZXcgRXJyb3IoIlRyYW5zYWN0aW9uIHdhcyByZWplY3RlZCBieSB1c2VyIik7dGhyb3cgdH19fWNvbnN0IHc9e1BheW1lbnRQcm9jZXNzb3I6ZyxQaGFudG9tQWRhcHRlcjp5LFRva2VuUmVnaXN0cnk6byxUcmFuc2FjdGlvblV0aWxzOnQsVmFsaWRhdGlvblV0aWxzOmV9O2Z1bmN0aW9uIHYoKXtjb25zdCB0PW5ldyBnKGFyZ3VtZW50cy5sZW5ndGg+MCYmdm9pZCAwIT09YXJndW1lbnRzWzBdP2FyZ3VtZW50c1swXTp7fSksZT1uZXcgeTtyZXR1cm4gdC5zZXRXYWxsZXRBZGFwdGVyKGUpLHtwcm9jZXNzb3I6dCxwaGFudG9tQWRhcHRlcjplLHRva2VuUmVnaXN0cnk6dC50b2tlblJlZ2lzdHJ5LGFzeW5jIGluaXQoKXtyZXR1cm4gYXdhaXQgdC5pbml0KCksdGhpc319fX0pKCksbn0pKCkpKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9bnl4cGF5LXBheS1zZGsudW1kLmpzLm1hcA=="></script><script src="data:text/javascript;base64,KGZ1bmN0aW9uIGFwcFJ1bnRpbWUoY2ZnKXsKICAgIGZ1bmN0aW9uIGZtdChuKXsgcmV0dXJuIChNYXRoLnJvdW5kKE51bWJlcihuKSoxZTkpLzFlOSkudG9GaXhlZCg5KS5yZXBsYWNlKC8wKyQvLCcnKS5yZXBsYWNlKC9cLiQvLCcnKTsgfQogICAgdmFyIHN1YnRpdGxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN1YnRpdGxlIik7CiAgICB2YXIgcmNwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyY3B0Iik7CiAgICB2YXIgYW10ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImFtdCIpOwogICAgdmFyIG5ldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJuZXQiKTsKICAgIHZhciBjb25uZWN0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvbm5lY3QiKTsKICAgIHZhciBwYXlCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGF5Iik7CiAgICB2YXIgc3RhdHVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN0YXR1cyIpOwogICAgdmFyIGV4cGxvcmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImV4cGxvcmVyIik7CgogICAgc3VidGl0bGUudGV4dENvbnRlbnQgPSAoY2ZnLm1lbW8gPyBjZmcubWVtbyArICIg4oCiICIgOiAiIikgKyAiUGF5bWVudCI7CiAgICByY3B0LnRleHRDb250ZW50ID0gY2ZnLnJlY2lwaWVudDsKICAgIGFtdC50ZXh0Q29udGVudCA9IGZtdChjZmcuYW1vdW50U09MKTsKICAgIG5ldC50ZXh0Q29udGVudCA9IGNmZy5uZXR3b3JrOwoKICAgIGlmICghd2luZG93LnNvbGFuYVdlYjMpIHsgc3RhdHVzLnRleHRDb250ZW50ID0gInNvbGFuYVdlYjMgbWlzc2luZyI7IGNvbm5lY3RCdG4uZGlzYWJsZWQgPSBwYXlCdG4uZGlzYWJsZWQgPSB0cnVlOyByZXR1cm47IH0KICAgIHZhciBTREsgPSB3aW5kb3cubnl4cGF5UGF5U0RLIHx8IHdpbmRvdy5OeXhQYXlTREsgfHwgd2luZG93Lm55eHBheSB8fCB3aW5kb3cuTnl4UGF5IHx8IG51bGw7CiAgICBpZiAoIVNESykgeyBzdGF0dXMudGV4dENvbnRlbnQgPSAiTnl4UGF5IFNESyBub3QgZm91bmQiOyBjb25uZWN0QnRuLmRpc2FibGVkID0gcGF5QnRuLmRpc2FibGVkID0gdHJ1ZTsgcmV0dXJuOyB9CgogICAgdmFyIFBheW1lbnRQcm9jZXNzb3IgPSBTREsuUGF5bWVudFByb2Nlc3NvcjsKICAgIHZhciBQaGFudG9tQWRhcHRlciAgPSBTREsuUGhhbnRvbUFkYXB0ZXI7CiAgICB2YXIgc2RrID0gbmV3IFBheW1lbnRQcm9jZXNzb3IoeyBuZXR3b3JrOiBjZmcubmV0d29yaywgY29tbWl0bWVudDogImNvbmZpcm1lZCIgfSk7CiAgICBzZGsuc2V0V2FsbGV0QWRhcHRlcihuZXcgUGhhbnRvbUFkYXB0ZXIoKSk7CgogICAgY29ubmVjdEJ0bi5vbmNsaWNrID0gZnVuY3Rpb24oKXsKICAgICAgc3RhdHVzLnRleHRDb250ZW50ID0gIkNvbm5lY3Rpbmcgd2FsbGV04oCmIjsKICAgICAgc2RrLmluaXQoKS50aGVuKGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHNkay5jb25uZWN0V2FsbGV0KCk7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgICBzdGF0dXMudGV4dENvbnRlbnQgPSAiV2FsbGV0IGNvbm5lY3RlZC4gUmVhZHkgdG8gcGF5LiI7CiAgICAgICAgcGF5QnRuLmRpc2FibGVkID0gZmFsc2U7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGUpewogICAgICAgIHN0YXR1cy50ZXh0Q29udGVudCA9ICJGYWlsZWQgdG8gY29ubmVjdDogIiArIChlICYmIGUubWVzc2FnZSA/IGUubWVzc2FnZSA6IGUpOwogICAgICB9KTsKICAgIH07CgogICAgcGF5QnRuLm9uY2xpY2sgPSBmdW5jdGlvbigpewogICAgICBpZiAocGF5QnRuLmRpc2FibGVkKSByZXR1cm47CiAgICAgIHBheUJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgIHN0YXR1cy50ZXh0Q29udGVudCA9ICJTZW5kaW5nIHBheW1lbnTigKYiOwogICAgICBzZGsuc2VuZFRva2Vucyh7CiAgICAgICAgcmVjaXBpZW50OiBjZmcucmVjaXBpZW50LAogICAgICAgIGFtb3VudDogY2ZnLmFtb3VudFNPTCwgICAvLyBTT0wgdW5pdHMKICAgICAgICB0b2tlbk1pbnQ6ICJTT0wiLAogICAgICAgIG1lbW86IGNmZy5tZW1vIHx8ICIiCiAgICAgIH0pLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICBzdGF0dXMudGV4dENvbnRlbnQgPSAi4pyFIFBheW1lbnQgc2VudCEiOwogICAgICAgIGlmIChyZXMgJiYgcmVzLmV4cGxvcmVyVXJsKSB7CiAgICAgICAgICB2YXIgdXJsID0gcmVzLmV4cGxvcmVyVXJsOwogICAgICAgICAgaWYgKGNmZy5uZXR3b3JrID09PSAiZGV2bmV0IikgewogICAgICAgICAgICB1cmwgPSB1cmwuaW5kZXhPZigiY2x1c3Rlcj0iKSA+PSAwID8gdXJsLnJlcGxhY2UoL2NsdXN0ZXI9W14mXSsvLCJjbHVzdGVyPWRldm5ldCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB1cmwgKyAodXJsLmluZGV4T2YoIj8iKT49MD8iJiI6Ij8iKSArICJjbHVzdGVyPWRldm5ldCI7CiAgICAgICAgICB9CiAgICAgICAgICBleHBsb3Jlci5ocmVmID0gdXJsOyBleHBsb3Jlci5zdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CiAgICAgICAgfQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlKXsKICAgICAgICBzdGF0dXMudGV4dENvbnRlbnQgPSAi4p2MIFBheW1lbnQgZmFpbGVkOiAiICsgKGUgJiYgZS5tZXNzYWdlID8gZS5tZXNzYWdlIDogZSk7CiAgICAgICAgcGF5QnRuLmRpc2FibGVkID0gZmFsc2U7CiAgICAgIH0pOwogICAgfTsKCiAgICBpZiAobG9jYXRpb24ucHJvdG9jb2wgPT09ICJmaWxlOiIpIHsKICAgICAgc3RhdHVzLnRleHRDb250ZW50ID0gIk5vdGU6IHNvbWUgd2FsbGV0cyBibG9jayBmaWxlOi8vIHBhZ2VzLiBJZiBidXR0b25zIGRvIG5vdGhpbmcsIHNlcnZlIHZpYSBodHRwOi8vbG9jYWxob3N0IG9yIGVuYWJsZSAnQWxsb3cgYWNjZXNzIHRvIGZpbGUgVVJMcycgaW4geW91ciB3YWxsZXQgZXh0ZW5zaW9uLiI7CiAgICB9CiAgfSkoeyJuZXR3b3JrIjoiZGV2bmV0IiwicmVjaXBpZW50IjoiMkNYUUxkazY4MXpCTjRjeGl0WW84QUdBZlByaGFtdlZKdHA3U2o3VFlucHYiLCJhbW91bnRTT0wiOjAuMSwibWVtbyI6InRlc3QifSk7"></script></body></html>